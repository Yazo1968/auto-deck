# File Structure

## Directory Tree

```
infonugget-v6.0/
├── App.tsx                        Main orchestrator: all handlers, state, and 6-panel composition (~1700+ lines)
├── index.tsx                      Entry point: mounts StorageProvider → ToastProvider → AppProvider → App
├── index.html                     HTML shell: Tailwind CDN, Google Fonts, CSS custom properties, PDF.js textLayer styles
├── types.ts                       All TypeScript interfaces and union types for the entire application
├── package.json                   npm manifest: scripts (dev/build/preview), dependencies, devDependencies
├── package-lock.json              Lockfile generated by npm
├── tsconfig.json                  TypeScript config: target ES2022, bundler moduleResolution, paths alias @/*
├── vite.config.ts                 Vite config: proxy for /api/anthropic-files, define block for API keys, alias @/
├── README.md                      Project readme
├── .env.local                     Local environment variables (not committed; API keys live here)
│
├── components/                    React UI components
│   ├── AssetsPanel.tsx            Right-side panel: reference image library and annotation workbench entry
│   ├── AutoDeckPanel.tsx          Auto-Deck panel: briefing form, card plan review, production progress
│   ├── CardsPanel.tsx             Main card list: inline content editor, image display, drag-to-reorder
│   ├── ChatPanel.tsx              Insights chat interface with document dropdown and save-as-card action
│   ├── Dialogs.tsx                Reusable confirmation dialogs (unsaved changes, delete confirmations)
│   ├── DocumentEditorModal.tsx    Full-screen document editor using useDocumentEditing + useDocumentFindReplace
│   ├── FileList.tsx               Document list with enable/disable toggle, rename, and delete actions
│   ├── FileUpload.tsx             Drag-and-drop file upload zone for adding documents to a nugget
│   ├── FindReplaceBar.tsx         Find/replace toolbar UI (paired with useDocumentFindReplace)
│   ├── FormatToolbar.tsx          Rich-text formatting toolbar for the document editor
│   ├── Header.tsx                 Logo and tagline header (shown on landing page)
│   ├── InsightsCardList.tsx       Card list rendered inside the Chat/Insights panel sidebar
│   ├── InsightsDocViewer.tsx      Document viewer shown in the chat sidebar
│   ├── LandingPage.tsx            Splash/onboarding screen shown on first load
│   ├── LoadingScreen.tsx          Initial hydration loading state displayed while IndexedDB is read
│   ├── NuggetCreationModal.tsx    Modal for creating a new nugget with initial file upload
│   ├── NuggetSettingsModal.tsx    Modal for renaming or deleting an existing nugget
│   ├── PdfUploadChoiceDialog.tsx  Dialog presenting "Convert to Markdown" vs "Native PDF" upload options
│   ├── PdfViewer.tsx              In-browser PDF rendering using pdfjs-dist with text selection layer
│   ├── ProjectCreationModal.tsx   Modal for creating a new project
│   ├── ProjectsPanel.tsx          Project/nugget tree with drag-and-drop ordering and kebab menus
│   ├── SourcesPanel.tsx           Document list, PDF viewer, and TOC editor with draft mode + hard lock overlay
│   ├── StorageProvider.tsx        Hydrates app state from IndexedDB on startup; exports storage singleton
│   ├── StyleStudioModal.tsx       Custom style creation with AI-generated palette, fonts, and identity
│   ├── SubjectEditModal.tsx       Modal for editing or regenerating the nugget's subject sentence
│   ├── ToastNotification.tsx      Global toast notification system (ToastProvider + useToast hook)
│   ├── UploadView.tsx             Drag-and-drop upload view shown when a nugget has no documents
│   ├── ZoomOverlay.tsx            Full-screen image zoom portal with annotation workbench integration
│   │
│   └── workbench/                 Canvas annotation sub-components
│       ├── AnnotationToolbar.tsx  Tool selection bar for pin, rectangle, arrow, sketch annotation modes
│       ├── AnnotationWorkbench.tsx Canvas surface for drawing annotations overlaid on a card image
│       ├── CanvasRenderer.ts      Canvas drawing utilities (not a React component; pure rendering functions)
│       ├── PinEditor.tsx          Placement and editing UI for pin annotations
│       └── RectangleEditor.tsx    Placement and editing UI for rectangle annotations
│
├── context/
│   └── AppContext.tsx             Single React Context: global state (nuggets, projects, customStyles, darkMode) + CRUD helpers
│
├── hooks/                         Custom React hooks
│   ├── useAnnotations.ts          Annotation state management (add, update, delete annotations per card image)
│   ├── useAutoDeck.ts             Auto-Deck state machine: Planner → Review → Finalizer → Producer pipeline
│   ├── useCardGeneration.ts       3-phase card generation pipeline: Content Synthesis → Layout Planning → Image Gen
│   ├── useCardGeneration.ts.bak   Backup of a prior version of useCardGeneration (not imported)
│   ├── useDocumentEditing.ts      contentEditable editor with undo/redo stack and heading promotion/demotion
│   ├── useDocumentFindReplace.ts  Find/replace in the document editor via DOM mark injection
│   ├── useInsightsLab.ts          Chat with Claude: multi-turn messages, doc change detection, save-as-card
│   ├── usePersistence.ts          Auto-save to IndexedDB with debounce and dirty detection
│   ├── useTokenUsage.ts           Token and cost tracking for Claude + Gemini with debounced persist
│   └── useVersionHistory.ts       Per-card image version history navigation (prev/next within imageHistoryMap)
│
├── utils/                         Utility modules
│   ├── ai.ts                      AI clients: VISUAL_STYLES, callClaude(), withGeminiRetry(), uploadToFilesAPI(), generateStyleWithAI()
│   ├── documentHash.ts            computeDocumentHash(): djb2 hash of active document contents for change detection
│   ├── fileProcessing.ts          All file ingestion: PDF→markdown via Gemini, native PDF, MetaTOC creation
│   ├── formatTime.ts              formatTimestamp() (relative) and formatTimestampFull() (absolute)
│   ├── geometry.ts                Geometric utility functions used by the annotation workbench
│   ├── markdown.ts                parseMarkdownStructure() (headings → Heading[]), htmlToMarkdown() for saving edits
│   ├── metaToc.ts                 generateMetaTocMarkdown(), uploadMetaToc(), replaceMetaToc() for native PDFs
│   ├── modificationEngine.ts      executeModification() (annotation-based image regen), executeContentModification()
│   ├── naming.ts                  getUniqueName() (Windows-style "(2)" dedup), isNameTaken()
│   ├── redline.ts                 Redline/diff utility for document comparison
│   ├── subjectGeneration.ts       generateSubject(), buildSubjectPrompt() (15-30 word expert priming sentence)
│   ├── tokenEstimation.ts         estimateTokens(), computeMessageBudget() (200K window), pruneMessages()
│   │
│   ├── autoDeck/                  Auto-Deck pipeline support
│   │   ├── constants.ts           LOD configs (executive/standard/detailed), limits, estimateCardCount(), countWords()
│   │   └── parsers.ts             JSON response parsers for planner, finalizer, and producer AI responses
│   │
│   ├── prompts/                   AI prompt builders
│   │   ├── autoDeckPlanner.ts     buildPlannerPrompt() and buildFinalizerPrompt() returning {systemBlocks, messages}
│   │   ├── autoDeckProducer.ts    buildProducerPrompt() and batchPlan() for card content production
│   │   ├── contentGeneration.ts   buildContentPrompt() (synthesis), buildPlannerPrompt() (visual brief)
│   │   ├── coverGeneration.ts     Cover card prompts: TitleCard and TakeawayCard builders and tag transformer
│   │   ├── documentConversion.ts  PDF_CONVERSION_PROMPT (Gemini Flash PDF→markdown), HEADING_EXTRACTION_PROMPT
│   │   ├── imageGeneration.ts     buildVisualizerPrompt(), buildModificationPrompt(), buildContentModificationPrompt()
│   │   ├── insightsLab.ts         buildInsightsSystemPrompt(), buildCardContentInstruction()
│   │   ├── promptUtils.ts         transformContentToTags(), sanitizePlannerOutput(), hexToColorName(), assembleRendererPrompt()
│   │   └── pwcGeneration.ts       PwC Corporate dedicated pipeline: JSON design spec builders for planner and visualizer
│   │
│   └── storage/                   Persistence layer
│       ├── IndexedDBBackend.ts    Full IndexedDB implementation: migrations (v1–v5), atomic transactions, orphan cleanup
│       ├── serialize.ts           Card ↔ StoredHeading serialization/deserialization, Blob/base64 image handling
│       └── StorageBackend.ts      Abstract storage interface definition
│
├── docs/                          Project documentation (this folder)
│   ├── _ANALYSIS.md               Complete codebase analysis used to generate the docs suite
│   ├── APP_OVERVIEW.md            High-level application overview
│   ├── CONVENTIONS.md             Code style, patterns, and conventions
│   ├── ENVIRONMENT.md             Environment variables and local development setup
│   └── FILE_STRUCTURE.md          This file
│
├── .claude/                       Claude Code session files
│   ├── commands/                  Custom Claude Code slash commands
│   ├── launch.json                Claude Code launch configuration
│   └── settings.local.json        Local Claude Code settings
│
├── memory/                        Claude Code project memory
├── samples/                       Sample files (not imported by the app)
├── dist/                          Vite production build output (not committed)
└── reference files (unused)/      Archived reference documents (not imported by the app)
```

## Key Files

### `App.tsx`
The main application orchestrator at ~1700+ lines. Owns all top-level handler functions (file upload, card generation, TOC save, nugget CRUD, style selection), all modal visibility state, the `expandedPanel` accordion state for the 6-panel layout, and the `appGatedAction` unsaved-changes gating mechanism. All panels and modals are composed here.

### `types.ts`
Defines every TypeScript interface used across the codebase: `Nugget`, `Project`, `Card`, `UploadedFile`, `StylingOptions`, `Palette`, `FontPair`, `ChatMessage`, `AutoDeckSession`, `AutoDeckBriefing`, `DocChangeEvent`, `CustomStyle`, `ImageVersion`, `Heading`, annotation types, and all union types including `DetailLevel` and `AutoDeckStatus`. This is the single source of truth for data shapes.

### `context/AppContext.tsx`
Provides the single `AppContext` consumed by all components. Holds global state (`nuggets`, `projects`, `customStyles`, `darkMode`, `selectedNuggetId`) and exposes typed CRUD helpers (`addNugget`, `updateNugget`, `deleteNugget`, `addNuggetDocument`, `updateNuggetCard`, etc.). Also maintains the `insightsSession` backward-compatibility shim for pre-nugget architecture code.

### `utils/ai.ts`
Central AI integration module. Defines `VISUAL_STYLES` (15 built-in palettes), `STYLE_FONTS`, `STYLE_IDENTITIES`, `FLASH_TEXT_CONFIG`, `PRO_IMAGE_CONFIG`, key rotation helpers (`rotateGeminiKey`, `resetGeminiKey`), the `withRetry` and `withGeminiRetry` exponential backoff wrappers, `callClaude()` for all Claude API calls, `uploadToFilesAPI()` and `deleteFromFilesAPI()` for the Anthropic Files API, and `generateStyleWithAI()` for AI-generated custom styles.

### `utils/storage/IndexedDBBackend.ts`
Full IndexedDB implementation for `infonugget-db` version 5. Contains schema migration paths from v1 through v5, atomic `saveNuggetDataAtomic()` spanning four object stores simultaneously, orphan cleanup on startup, and all load/save/delete operations for nuggets, projects, documents, images, and app state.

### `hooks/useCardGeneration.ts`
Implements the 3-phase card generation pipeline (~460 lines): Phase 1 calls Claude for content synthesis, Phase 2 calls Claude for layout planning (or Gemini Flash for PwC JSON specs), Phase 3 calls Gemini Pro Image for the final infographic. Also handles batch generation (`manifestCards` queue), version history capping at 10 versions, and abort signal propagation.

### `hooks/useAutoDeck.ts`
State machine for the Auto-Deck pipeline with states: `configuring → planning → conflict → reviewing → revising → finalizing → producing → complete`. Calls the Planner, optional Finalizer, and Producer Claude prompts in sequence. Handles pre-flight token budget checks (180K limit), batching for plans exceeding 15 cards, and creation of `Card` objects populated with `synthesisMap` content.

### `components/StorageProvider.tsx`
Runs on app startup before the `AppProvider` mounts. Reads all nuggets, projects, documents, images, and app state from IndexedDB, deserializes them, and passes the hydrated `InitialPersistedState` object to `AppProvider`. Also exports the `storage` singleton instance of `IndexedDBBackend` used throughout the app.

## Naming Conventions

**Files:**
- React components: `PascalCase.tsx` (e.g., `CardsPanel.tsx`, `NuggetCreationModal.tsx`)
- React hooks: `camelCase.ts` with `use` prefix (e.g., `useCardGeneration.ts`, `usePersistence.ts`)
- Utility modules: `camelCase.ts` (e.g., `fileProcessing.ts`, `documentHash.ts`, `formatTime.ts`)
- Prompt builders: `camelCase.ts` grouped in `utils/prompts/` (e.g., `contentGeneration.ts`, `pwcGeneration.ts`)
- Storage utilities: `PascalCase.ts` for class-based modules (e.g., `IndexedDBBackend.ts`, `StorageBackend.ts`), `camelCase.ts` for function modules (e.g., `serialize.ts`)
- TypeScript-only utility (not a component): `CanvasRenderer.ts` uses `.ts` extension despite being in `components/workbench/`

**Identifiers:**
- React components: `PascalCase` function declarations with default export
- Props interfaces: `ComponentNameProps` (e.g., `CardsPanelProps`, `FileListProps`)
- Custom hooks: `usePrefix` camelCase (e.g., `useInsightsLab`, `useDocumentEditing`)
- Constants and configuration objects: `SCREAMING_SNAKE_CASE` (e.g., `VISUAL_STYLES`, `FLASH_TEXT_CONFIG`, `CLAUDE_MAX_TOKENS`, `CACHE_MIN_CHARS`)
- Regular variables and functions: `camelCase`
- TypeScript interfaces: `PascalCase` (e.g., `Nugget`, `UploadedFile`, `SystemBlock`)
- Union type aliases: `PascalCase` (e.g., `DetailLevel`, `AutoDeckStatus`, `AnnotationTool`)
