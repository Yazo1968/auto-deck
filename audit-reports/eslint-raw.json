[{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\App.tsx","messages":[{"ruleId":"import/no-duplicates","severity":2,"message":"'C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\ai.ts' imported multiple times.","line":6,"column":79,"nodeType":"Literal","endLine":6,"endColumn":91,"fix":{"range":[418,1484],"text":", callClaude, uploadToFilesAPI, deleteFromFilesAPI } from './utils/ai';\r\nimport ProjectsPanel from './components/ProjectsPanel';\r\nimport { LandingPage } from './components/LandingPage';\r\nimport SourcesPanel from './components/SourcesPanel';\r\nimport ChatPanel from './components/ChatPanel';\r\nimport AutoDeckPanel from './components/AutoDeckPanel';\r\nimport CardsPanel, { PanelEditorHandle } from './components/CardsPanel';\r\n\r\nimport { UnsavedChangesDialog } from './components/Dialogs';\r\nimport { NuggetCreationModal, PendingFileUpload } from './components/NuggetCreationModal';\r\nimport { ProjectCreationModal } from './components/ProjectCreationModal';\r\nimport { useAppContext } from './context/AppContext';\r\nimport { useCardGeneration } from './hooks/useCardGeneration';\r\nimport { useInsightsLab } from './hooks/useInsightsLab';\r\nimport { useAutoDeck } from './hooks/useAutoDeck';\r\nimport { useTokenUsage, formatTokens, formatCost, TokenUsageTotals } from './hooks/useTokenUsage';\r\nimport { storage } from './components/StorageProvider';\r\n"}},{"ruleId":"import/order","severity":1,"message":"There should be no empty line between import groups","line":12,"column":1,"nodeType":"ImportDeclaration","endLine":12,"endColumn":73,"fix":{"range":[789,791],"text":""}},{"ruleId":"no-duplicate-imports","severity":2,"message":"'./utils/ai' import is duplicated.","line":23,"column":1,"nodeType":"ImportDeclaration","messageId":"import","endLine":23,"endColumn":79},{"ruleId":"import/no-duplicates","severity":2,"message":"'C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\ai.ts' imported multiple times.","line":23,"column":66,"nodeType":"Literal","endLine":23,"endColumn":78},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 22 to the 15 allowed.","line":36,"column":26,"nodeType":null,"messageId":"refactorFunction","endLine":36,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'addCustomStyle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":53,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'updateCustomStyle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":53,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":52},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'deleteCustomStyle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":53,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":71},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentSynthesisContent' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":82,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'contentDirty' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":82,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":42},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'selectedCount' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":82,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":57},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handleGenerateAll' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":84,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handleImageModified' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":86,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":86,"endColumn":24},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'setBreadcrumbDropdown' was used before it was defined.","line":183,"column":5,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":183,"endColumn":26},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'setBreadcrumbDropdown' was used before it was defined.","line":192,"column":5,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":192,"endColumn":26},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'setBreadcrumbDropdown' was used before it was defined.","line":198,"column":5,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":198,"endColumn":26},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":203,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":203,"endColumn":58,"fix":{"range":[9268,9298],"text":"{cardsPanelRef.current?.save();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":204,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":204,"endColumn":67,"fix":{"range":[9334,9366],"text":"{sourcesPanelRef.current?.save();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":220,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":220,"endColumn":61,"fix":{"range":[9989,10022],"text":"{cardsPanelRef.current?.discard();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":221,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":221,"endColumn":70,"fix":{"range":[10058,10093],"text":"{sourcesPanelRef.current?.discard();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":241,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":241,"endColumn":36,"fix":{"range":[10802,10812],"text":"{return [];}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":247,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":247,"endColumn":41,"fix":{"range":[10993,11005],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":250,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":250,"endColumn":31,"fix":{"range":[11127,11140],"text":"{return found;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":288,"column":29,"nodeType":"Literal","messageId":"defineConstant","endLine":288,"endColumn":41},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 14 times.","line":295,"column":54,"nodeType":"Literal","messageId":"defineConstant","endLine":295,"endColumn":71},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":300,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":300,"endColumn":29,"suggestions":[{"fix":{"range":[13379,13442],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 7 times.","line":311,"column":90,"nodeType":"Literal","messageId":"defineConstant","endLine":311,"endColumn":102},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":314,"column":19,"nodeType":"MemberExpression","messageId":"unexpected","endLine":314,"endColumn":31,"suggestions":[{"fix":{"range":[14014,14093],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":314,"column":32,"nodeType":"Literal","messageId":"defineConstant","endLine":314,"endColumn":91},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":326,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":326,"endColumn":26,"suggestions":[{"fix":{"range":[14459,14526],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":355,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":355,"endColumn":25,"suggestions":[{"fix":{"range":[15764,15838],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'setSelectionLevel'. Either include it or remove the dependency array.","line":366,"column":6,"nodeType":"ArrayExpression","endLine":366,"endColumn":120,"suggestions":[{"desc":"Update the dependencies array to be: [addNugget, setSelectedNuggetId, setSelectionLevel, nuggetCreationProjectId, addNuggetToProject, updateNugget, addToast, recordUsage]","fix":{"range":[16133,16247],"text":"[addNugget, setSelectedNuggetId, setSelectionLevel, nuggetCreationProjectId, addNuggetToProject, updateNugget, addToast, recordUsage]"}}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":371,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":371,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":371,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":371,"endColumn":72},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":387,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":387,"endColumn":25,"fix":{"range":[17001,17008],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":389,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":389,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":389,"column":79,"nodeType":"Literal","messageId":"noMagic","endLine":389,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":399,"column":87,"nodeType":"Literal","messageId":"noMagic","endLine":399,"endColumn":89},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":399,"column":101,"nodeType":"Literal","messageId":"noMagic","endLine":399,"endColumn":102},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":400,"column":80,"nodeType":"Literal","messageId":"noMagic","endLine":400,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":400,"column":94,"nodeType":"Literal","messageId":"noMagic","endLine":400,"endColumn":95},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":412,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":412,"endColumn":26,"fix":{"range":[18275,18282],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":414,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":414,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":414,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":414,"endColumn":82},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":420,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":420,"endColumn":29,"fix":{"range":[18616,18625],"text":"{continue;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":421,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":421,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":421,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":421,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":426,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":426,"endColumn":91},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":426,"column":103,"nodeType":"Literal","messageId":"noMagic","endLine":426,"endColumn":104},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":427,"column":82,"nodeType":"Literal","messageId":"noMagic","endLine":427,"endColumn":84},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":427,"column":96,"nodeType":"Literal","messageId":"noMagic","endLine":427,"endColumn":97},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":470,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":470,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":470,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":470,"endColumn":82},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":495,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":495,"endColumn":27,"fix":{"range":[22081,22088],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":496,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":496,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":496,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":496,"endColumn":82},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":501,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":91},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":501,"column":103,"nodeType":"Literal","messageId":"noMagic","endLine":501,"endColumn":104},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":502,"column":82,"nodeType":"Literal","messageId":"noMagic","endLine":502,"endColumn":84},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":502,"column":96,"nodeType":"Literal","messageId":"noMagic","endLine":502,"endColumn":97},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":521,"column":64,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":521,"endColumn":71,"fix":{"range":[23181,23188],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":533,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":533,"endColumn":53},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":533,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":533,"endColumn":66},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":564,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":564,"endColumn":30,"fix":{"range":[24696,24708],"text":"{return prev;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'menuDraftOptions'. Either exclude it or remove the dependency array.","line":576,"column":6,"nodeType":"ArrayExpression","endLine":576,"endColumn":91,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, updateNugget, setInsightsSession, setActiveCardId]","fix":{"range":[24993,25078],"text":"[selectedNugget, updateNugget, setInsightsSession, setActiveCardId]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":580,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":580,"endColumn":33,"fix":{"range":[25224,25231],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":590,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":590,"endColumn":30,"fix":{"range":[25522,25534],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":602,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":602,"endColumn":33,"fix":{"range":[25889,25896],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":612,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":612,"endColumn":30,"fix":{"range":[26280,26292],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":622,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":622,"endColumn":33,"fix":{"range":[26639,26646],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":629,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":629,"endColumn":30,"fix":{"range":[26873,26885],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":639,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":639,"endColumn":33,"fix":{"range":[27243,27250],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":643,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":643,"endColumn":48,"fix":{"range":[27455,27462],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":652,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":652,"endColumn":30,"fix":{"range":[27797,27809],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":662,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":662,"endColumn":33,"fix":{"range":[28132,28139],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":669,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":669,"endColumn":30,"fix":{"range":[28356,28368],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":679,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":679,"endColumn":58,"fix":{"range":[28733,28740],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":696,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":696,"endColumn":33,"fix":{"range":[29369,29376],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":705,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":705,"endColumn":30,"fix":{"range":[29689,29701],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":714,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":714,"endColumn":33,"fix":{"range":[30150,30157],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":716,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":716,"endColumn":40,"fix":{"range":[30286,30293],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":724,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":724,"endColumn":30,"fix":{"range":[30589,30601],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":740,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":740,"endColumn":34,"fix":{"range":[31449,31458],"text":"{continue;}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":764,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":764,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32376,32379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32376,32379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":765,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":765,"endColumn":33,"fix":{"range":[32414,32421],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":772,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":772,"endColumn":39,"fix":{"range":[32668,32677],"text":"{return c;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":783,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":783,"endColumn":30,"fix":{"range":[33018,33030],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":787,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":787,"endColumn":41,"fix":{"range":[33135,33144],"text":"{return c;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'activeLogicTab'. Either include it or remove the dependency array.","line":796,"column":6,"nodeType":"ArrayExpression","endLine":796,"endColumn":56,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, activeLogicTab, updateNugget, setInsightsSession]","fix":{"range":[33394,33444],"text":"[selectedNugget, activeLogicTab, updateNugget, setInsightsSession]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":800,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":800,"endColumn":50,"fix":{"range":[33605,33612],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":803,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":803,"endColumn":43,"fix":{"range":[33722,33731],"text":"{return c;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":822,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":822,"endColumn":30,"fix":{"range":[34597,34609],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":829,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":829,"endColumn":50,"fix":{"range":[34972,34979],"text":"{return;}"}},{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 802.","line":831,"column":35,"nodeType":null,"messageId":"identicalFunctions","endLine":831,"endColumn":37},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":832,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":832,"endColumn":43,"fix":{"range":[35089,35098],"text":"{return c;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":851,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":851,"endColumn":30,"fix":{"range":[35964,35976],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":858,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":858,"endColumn":33,"fix":{"range":[36292,36299],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":878,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":878,"endColumn":30,"fix":{"range":[37218,37230],"text":"{return prev;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'copied' is assigned a value but never used. Allowed unused elements of array destructuring must match /^_/u.","line":902,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":902,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setCopied' is assigned a value but never used. Allowed unused elements of array destructuring must match /^_/u.","line":902,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":902,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'nuggetCards' logical expression could make the dependencies of useEffect Hook (at line 919) change on every render. Move it inside the useEffect callback. Alternatively, wrap the initialization of 'nuggetCards' in its own useMemo() Hook.","line":914,"column":9,"nodeType":"VariableDeclarator","endLine":914,"endColumn":50},{"ruleId":"unicorn/prefer-array-some","severity":1,"message":"Prefer `.some(…)` over `.find(…)`.","line":916,"column":66,"nodeType":"Identifier","messageId":"some","endLine":916,"endColumn":70,"suggestions":[{"messageId":"some-suggestion","fix":{"range":[38904,38908],"text":"some"},"data":{"method":"find"},"desc":"Replace `.find(…)` with `.some(…)`."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setActiveLogicTab'. Either include it or remove the dependency array.","line":926,"column":6,"nodeType":"ArrayExpression","endLine":926,"endColumn":45,"suggestions":[{"desc":"Update the dependencies array to be: [activeCardId, activeCard.detailLevel, setActiveLogicTab]","fix":{"range":[39245,39284],"text":"[activeCardId, activeCard.detailLevel, setActiveLogicTab]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'nuggets'. Either include it or remove the dependency array.","line":939,"column":6,"nodeType":"ArrayExpression","endLine":939,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [nuggets, selectedNuggetId]","fix":{"range":[39845,39863],"text":"[nuggets, selectedNuggetId]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":947,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":947,"endColumn":35,"fix":{"range":[40129,40136],"text":"{return;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'selectedNuggetId' and 'updateNugget'. Either include them or remove the dependency array.","line":952,"column":6,"nodeType":"ArrayExpression","endLine":952,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [menuDraftOptions, selectedNuggetId, updateNugget]","fix":{"range":[40251,40269],"text":"[menuDraftOptions, selectedNuggetId, updateNugget]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setManifestCards'. Either include it or remove the dependency array.","line":967,"column":6,"nodeType":"ArrayExpression","endLine":967,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [setManifestCards]","fix":{"range":[40712,40714],"text":"[setManifestCards]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":971,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":971,"endColumn":32,"fix":{"range":[40815,40822],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":974,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":974,"endColumn":58,"fix":{"range":[40963,40970],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":975,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":975,"endColumn":56,"fix":{"range":[41020,41027],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":976,"column":57,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":976,"endColumn":64,"fix":{"range":[41085,41092],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":979,"column":59,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":979,"endColumn":66,"fix":{"range":[41290,41297],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":988,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":988,"endColumn":36,"fix":{"range":[41619,41626],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1000,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1000,"endColumn":37,"fix":{"range":[42083,42090],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1003,"column":9,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1003,"endColumn":37,"fix":{"range":[42229,42257],"text":"{setBreadcrumbDropdown(null);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1006,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1006,"endColumn":59,"fix":{"range":[42340,42368],"text":"{setBreadcrumbDropdown(null);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1039,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1039,"endColumn":26,"fix":{"range":[43561,43568],"text":"{return;}"}},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":1060,"column":5,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":1060,"endColumn":7},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":1061,"column":7,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":1069,"endColumn":8,"fix":{"range":[44291,44725],"text":"(referenceImage && useReferenceImage && detectSettingsMismatch(menuDraftOptions, referenceImage.settings)) {\r\n        const decision = await showMismatchDialog();\r\n        if (decision === 'cancel') return;\r\n        if (decision === 'disable') setUseReferenceImage(false);\r\n        if (decision === 'disable' || decision === 'skip') {\r\n          await generateCard(card, true);\r\n          return;\r\n        }\r\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1063,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1063,"endColumn":43,"fix":{"range":[44501,44508],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1064,"column":37,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1064,"endColumn":65,"fix":{"range":[44546,44574],"text":"{setUseReferenceImage(false);}"}},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":1075,"column":5,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":1075,"endColumn":7},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":1076,"column":7,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":1080,"endColumn":8,"fix":{"range":[44920,45219],"text":"(referenceImage && useReferenceImage && detectSettingsMismatch(menuDraftOptions, referenceImage.settings)) {\r\n        const decision = await showMismatchDialog();\r\n        if (decision === 'cancel') return;\r\n        if (decision === 'disable') setUseReferenceImage(false);\r\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1078,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1078,"endColumn":43,"fix":{"range":[45130,45137],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1079,"column":37,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1079,"endColumn":65,"fix":{"range":[45175,45203],"text":"{setUseReferenceImage(false);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1094,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1094,"endColumn":22,"fix":{"range":[45702,45709],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 40.","line":1095,"column":111,"nodeType":"Literal","messageId":"noMagic","endLine":1095,"endColumn":113},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1100,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1100,"endColumn":33,"fix":{"range":[46037,46044],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1103,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1103,"endColumn":26,"fix":{"range":[46164,46173],"text":"{continue;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 40.","line":1104,"column":106,"nodeType":"Literal","messageId":"noMagic","endLine":1104,"endColumn":108},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1112,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1112,"endColumn":33,"fix":{"range":[46586,46593],"text":"{return;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'getUniqueName'. Either exclude it or remove the dependency array. Outer scope values like 'getUniqueName' aren't valid dependencies because mutating them doesn't re-render the component.","line":1131,"column":6,"nodeType":"ArrayExpression","endLine":1131,"endColumn":88,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, updateNugget, setInsightsSession, setActiveCardId]","fix":{"range":[47236,47318],"text":"[selectedNugget, updateNugget, setInsightsSession, setActiveCardId]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 50 to the 15 allowed.","line":1153,"column":148,"nodeType":null,"messageId":"refactorFunction","endLine":1153,"endColumn":150},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1154,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1154,"endColumn":47,"fix":{"range":[48239,48246],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1165,"column":53,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1165,"endColumn":60,"fix":{"range":[49093,49100],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1196,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":1196,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1196,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":1196,"endColumn":71},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1219,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1219,"endColumn":32,"fix":{"range":[51470,51482],"text":"{return prev;}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1249,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1249,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[53042,53045],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[53042,53045],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1260,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1260,"endColumn":80,"fix":{"range":[53573,53625],"text":"{systemBlocks.push({ text: tocPrompt, cache: true });}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1274,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1276,"endColumn":92},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 350.","line":1275,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":1275,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 256.","line":1275,"column":55,"nodeType":"Literal","messageId":"noMagic","endLine":1275,"endColumn":58},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1276,"column":16,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1276,"endColumn":91},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":1276,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":1276,"endColumn":49},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1276,"column":52,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":1276,"endColumn":91},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":1276,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":1276,"endColumn":84},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1200.","line":1276,"column":87,"nodeType":"Literal","messageId":"noMagic","endLine":1276,"endColumn":91},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1297,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":1297,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1297,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":1297,"endColumn":71},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1322,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1322,"endColumn":32,"fix":{"range":[55856,55868],"text":"{return prev;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1329,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1329,"endColumn":20,"suggestions":[{"fix":{"range":[56037,56089],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'menuDraftOptions'. Either exclude it or remove the dependency array.","line":1333,"column":6,"nodeType":"ArrayExpression","endLine":1333,"endColumn":104,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, updateNugget, setInsightsSession, setActiveCardId, recordUsage]","fix":{"range":[56233,56331],"text":"[selectedNugget, updateNugget, setInsightsSession, setActiveCardId, recordUsage]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1337,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1337,"endColumn":33,"fix":{"range":[56498,56505],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1339,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1339,"endColumn":22,"fix":{"range":[56590,56597],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1343,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1343,"endColumn":54,"fix":{"range":[56714,56745],"text":"{deleteFromFilesAPI(doc.fileId);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1346,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1346,"endColumn":19,"suggestions":[{"fix":{"range":[56850,56932],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1353,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1353,"endColumn":33,"fix":{"range":[57278,57285],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1355,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1355,"endColumn":22,"fix":{"range":[57370,57377],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1368,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1368,"endColumn":21,"suggestions":[{"fix":{"range":[57868,57931],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'addToast'. Either exclude it or remove the dependency array.","line":1393,"column":6,"nodeType":"ArrayExpression","endLine":1393,"endColumn":68,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, updateNuggetDocument, updateNugget]","fix":{"range":[58613,58675],"text":"[selectedNugget, updateNuggetDocument, updateNugget]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1396,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1396,"endColumn":33,"fix":{"range":[58826,58833],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1398,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1398,"endColumn":22,"fix":{"range":[58918,58925],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1404,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":1404,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1404,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":1404,"endColumn":67},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1414,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1414,"endColumn":19,"suggestions":[{"fix":{"range":[59816,59886],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1445,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1445,"endColumn":54,"fix":{"range":[60936,60967],"text":"{deleteFromFilesAPI(doc.fileId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1451,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1451,"endColumn":33,"fix":{"range":[61215,61222],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1453,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1453,"endColumn":22,"fix":{"range":[61307,61314],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1460,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":1460,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1460,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":1460,"endColumn":67},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1470,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1470,"endColumn":19,"suggestions":[{"fix":{"range":[62251,62327],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1491,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":1491,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1491,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":1491,"endColumn":59},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":1515,"column":69,"nodeType":null,"messageId":"refactorFunction","endLine":1515,"endColumn":71},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1540,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1540,"endColumn":60,"fix":{"range":[64958,64991],"text":"{batchDocIds.push(placeholder.id);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1555,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1555,"endColumn":29,"suggestions":[{"fix":{"range":[65602,65665],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1563,"column":15,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1563,"endColumn":28,"suggestions":[{"fix":{"range":[65902,65960],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1582,"column":19,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1582,"endColumn":31,"suggestions":[{"fix":{"range":[66792,66871],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1608,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1608,"endColumn":58,"fix":{"range":[67850,67883],"text":"{batchDocIds.push(placeholder.id);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1617,"column":15,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1617,"endColumn":27,"suggestions":[{"fix":{"range":[68208,68287],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1644,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1644,"endColumn":27,"fix":{"range":[69387,69394],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1646,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1646,"endColumn":39,"fix":{"range":[69480,69487],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1656,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1656,"endColumn":26,"fix":{"range":[69911,69918],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1680,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1680,"endColumn":21,"suggestions":[{"fix":{"range":[70888,70947],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1698,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1698,"endColumn":25,"fix":{"range":[71623,71630],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":1710,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":1710,"endColumn":19,"suggestions":[{"fix":{"range":[72261,72317],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1719,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1719,"endColumn":33,"fix":{"range":[72790,72797],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1721,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1721,"endColumn":23,"fix":{"range":[72881,72888],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1726,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":1726,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1726,"column":68,"nodeType":"Literal","messageId":"noMagic","endLine":1726,"endColumn":69},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1758,"column":37,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1758,"endColumn":44,"fix":{"range":[74316,74323],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1760,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1760,"endColumn":23,"fix":{"range":[74407,74414],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1767,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":1767,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1767,"column":68,"nodeType":"Literal","messageId":"noMagic","endLine":1767,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":1776,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":1776,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":1776,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":1776,"endColumn":59},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1857,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1857,"endColumn":34,"fix":{"range":[77722,77734],"text":"{return null;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":1919,"column":134,"nodeType":"Literal","messageId":"defineConstant","endLine":1919,"endColumn":209},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":1919,"column":212,"nodeType":"Literal","messageId":"defineConstant","endLine":1919,"endColumn":332},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1986,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1986,"endColumn":51,"fix":{"range":[86798,86810],"text":"{return null;}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":2160,"column":37,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":2164,"endColumn":34},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":2162,"column":23,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":2164,"endColumn":34,"fix":{"range":[98650,98780],"text":"(doc.content\r\n                      ? await uploadToFilesAPI(doc.content, newName, 'text/plain')\r\n                      : undefined)"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2165,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2165,"endColumn":168,"fix":{"range":[98816,98950],"text":"{updateNuggetDocument(docId, { ...doc, name: newName, fileId: newFileId, lastRenamedAt: Date.now(), version: (doc.version ?? 1) + 1 });}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":2167,"column":19,"nodeType":"MemberExpression","messageId":"unexpected","endLine":2167,"endColumn":31,"suggestions":[{"fix":{"range":[99003,99068],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2174,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2174,"endColumn":63,"fix":{"range":[99330,99361],"text":"{deleteFromFilesAPI(doc.fileId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2212,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2212,"endColumn":93,"fix":{"range":[101351,101416],"text":"{updateNuggetDocument(docId, { ...doc, structure: newStructure });}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2216,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2216,"endColumn":47,"fix":{"range":[101581,101588],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2218,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2218,"endColumn":36,"fix":{"range":[101701,101708],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2230,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2230,"endColumn":47,"fix":{"range":[102264,102271],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":2232,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":2232,"endColumn":54,"fix":{"range":[102402,102409],"text":"{return;}"}},{"ruleId":"no-alert","severity":1,"message":"Unexpected alert.","line":2335,"column":48,"nodeType":"CallExpression","messageId":"unexpected","endLine":2335,"endColumn":83}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":196,"fixableErrorCount":1,"fixableWarningCount":100,"source":"\r\nimport React, { useState, useCallback, useRef, useEffect, useMemo } from 'react';\r\nimport ZoomOverlay from './components/ZoomOverlay';\r\nimport AssetsPanel from './components/AssetsPanel';\r\nimport { Card, StylingOptions, DetailLevel, ZoomState, ReferenceImage, ChatMessage, UploadedFile, Nugget, Project, Heading, isCoverLevel } from './types';\r\nimport { DEFAULT_STYLING, detectSettingsMismatch, registerCustomStyles } from './utils/ai';\r\nimport ProjectsPanel from './components/ProjectsPanel';\r\nimport { LandingPage } from './components/LandingPage';\r\nimport SourcesPanel from './components/SourcesPanel';\r\nimport ChatPanel from './components/ChatPanel';\r\nimport AutoDeckPanel from './components/AutoDeckPanel';\r\nimport CardsPanel, { PanelEditorHandle } from './components/CardsPanel';\r\n\r\nimport { UnsavedChangesDialog } from './components/Dialogs';\r\nimport { NuggetCreationModal, PendingFileUpload } from './components/NuggetCreationModal';\r\nimport { ProjectCreationModal } from './components/ProjectCreationModal';\r\nimport { useAppContext } from './context/AppContext';\r\nimport { useCardGeneration } from './hooks/useCardGeneration';\r\nimport { useInsightsLab } from './hooks/useInsightsLab';\r\nimport { useAutoDeck } from './hooks/useAutoDeck';\r\nimport { useTokenUsage, formatTokens, formatCost, TokenUsageTotals } from './hooks/useTokenUsage';\r\nimport { storage } from './components/StorageProvider';\r\nimport { callClaude, uploadToFilesAPI, deleteFromFilesAPI } from './utils/ai';\r\nimport { buildContentPrompt, buildNativePdfSectionHint } from './utils/prompts/contentGeneration';\r\nimport { buildCoverContentPrompt } from './utils/prompts/coverGeneration';\r\nimport { createPlaceholderDocument, processFileToDocument, processNativePdf, extractHeadingsWithGemini, base64ToBlob } from './utils/fileProcessing';\r\nimport { buildTocSystemPrompt, flattenBookmarks, writeBookmarksToPdf, headingsToBookmarks } from './utils/pdfBookmarks';\r\nimport { useToast } from './components/ToastNotification';\r\nimport { getUniqueName } from './utils/naming';\r\nimport PdfUploadChoiceDialog from './components/PdfUploadChoiceDialog';\r\nimport PanelRequirements from './components/PanelRequirements';\r\nimport StyleStudioModal from './components/StyleStudioModal';\r\nimport { SubjectEditModal } from './components/SubjectEditModal';\r\nimport { generateSubject } from './utils/subjectGeneration';\r\n\r\nconst App: React.FC = () => {\r\n  const {\r\n    activeCardId, setActiveCardId,\r\n    activeCard,\r\n    insightsSession, setInsightsSession,\r\n    nuggets,\r\n    selectedNuggetId, setSelectedNuggetId,\r\n    selectedDocumentId, setSelectedDocumentId,\r\n    selectedProjectId,\r\n    selectionLevel, setSelectionLevel,\r\n    selectEntity,\r\n    selectedNugget,\r\n    addNugget, deleteNugget, updateNugget,\r\n    updateNuggetCard,\r\n    addNuggetDocument, updateNuggetDocument, removeNuggetDocument, renameNuggetDocument, toggleNuggetDocument,\r\n    projects, setProjects, addProject, deleteProject, updateProject, addNuggetToProject, removeNuggetFromProject,\r\n    initialTokenUsageTotals,\r\n    customStyles, addCustomStyle, updateCustomStyle, deleteCustomStyle, replaceCustomStyles,\r\n    darkMode, toggleDarkMode,\r\n  } = useAppContext();\r\n\r\n  // ── Token / cost tracking (persisted to IndexedDB) ──\r\n  const { totals: usageTotals, recordUsage, resetUsage } = useTokenUsage(\r\n    storage,\r\n    initialTokenUsageTotals as unknown as TokenUsageTotals | undefined,\r\n  );\r\n\r\n  const { addToast } = useToast();\r\n\r\n  const [menuDraftOptions, setMenuDraftOptions] = useState<StylingOptions>(\r\n    () => selectedNugget?.stylingOptions || DEFAULT_STYLING\r\n  );\r\n  const skipStylingWritebackRef = useRef(false);\r\n  const [zoomState, setZoomState] = useState<ZoomState>({ imageUrl: null, cardId: null, cardText: null });\r\n\r\n  // ── Reference image style anchoring ──\r\n  const [referenceImage, setReferenceImage] = useState<ReferenceImage | null>(null);\r\n  const [useReferenceImage, setUseReferenceImage] = useState(false);\r\n  const [mismatchDialog, setMismatchDialog] = useState<{\r\n    resolve: (decision: 'disable' | 'skip' | 'cancel') => void;\r\n  } | null>(null);\r\n\r\n  const {\r\n    genStatus,\r\n    activeLogicTab, setActiveLogicTab,\r\n    manifestCards, setManifestCards,\r\n    currentSynthesisContent, contentDirty, selectedCount,\r\n    generateCard,\r\n    handleGenerateAll,\r\n    executeBatchCardGeneration,\r\n    handleImageModified,\r\n  } = useCardGeneration(menuDraftOptions, referenceImage, useReferenceImage, recordUsage);\r\n\r\n  // ── Insights workflow hooks ──\r\n  const {\r\n    messages: insightsMessages,\r\n    isLoading: insightsLabLoading,\r\n    sendMessage: sendInsightsMessage,\r\n    stopResponse: stopInsightsResponse,\r\n    clearMessages: clearInsightsMessages,\r\n    pendingDocChanges,\r\n    hasConversation: insightsHasConversation,\r\n    handleDocChangeContinue,\r\n    handleDocChangeStartFresh,\r\n  } = useInsightsLab(recordUsage);\r\n\r\n  // ── Auto-Deck workflow hook ──\r\n  const {\r\n    session: autoDeckSession,\r\n    startPlanning: autoDeckStartPlanning,\r\n    revisePlan: autoDeckRevisePlan,\r\n    approvePlan: autoDeckApprovePlan,\r\n    abort: autoDeckAbort,\r\n    reset: autoDeckReset,\r\n    retryFromReview: autoDeckRetryFromReview,\r\n    toggleCardIncluded: autoDeckToggleCardIncluded,\r\n    setQuestionAnswer: autoDeckSetQuestionAnswer,\r\n    setAllRecommended: autoDeckSetAllRecommended,\r\n    setGeneralComment: autoDeckSetGeneralComment,\r\n  } = useAutoDeck(recordUsage);\r\n\r\n  // ── Nugget modal state ──\r\n  const [showNuggetCreation, setShowNuggetCreation] = useState(false);\r\n  const [nuggetCreationProjectId, setNuggetCreationProjectId] = useState<string | null>(null);\r\n\r\n  // ── Project modal state ──\r\n  const [showProjectCreation, setShowProjectCreation] = useState(false);\r\n  const [projectCreationChainToNugget, setProjectCreationChainToNugget] = useState(false);\r\n\r\n  // ── PDF upload choice dialog state ──\r\n  const [pdfChoiceDialog, setPdfChoiceDialog] = useState<{ fileName: string; pdfCount?: number } | null>(null);\r\n  const pdfChoiceResolverRef = useRef<((choice: 'markdown' | 'native-pdf' | 'cancel') => void) | null>(null);\r\n\r\n  // ── Style Studio modal state ──\r\n  const [showStyleStudio, setShowStyleStudio] = useState(false);\r\n\r\n  // ── Subject edit modal state ──\r\n  const [subjectEditNuggetId, setSubjectEditNuggetId] = useState<string | null>(null);\r\n  const [isRegeneratingSubject, setIsRegeneratingSubject] = useState(false);\r\n\r\n  // ── Subject auto-generation on first upload ──\r\n  const pendingSubjectGenRef = useRef<string | null>(null);        // nuggetId awaiting subject gen\r\n  const subjectGenDocIdsRef = useRef<Set<string>>(new Set());      // doc IDs to wait for\r\n\r\n  // ── Register custom styles into runtime maps on mount and after changes ──\r\n  useEffect(() => {\r\n    registerCustomStyles(customStyles);\r\n  }, [customStyles]);\r\n\r\n  // ── Panel accordion state (only one of Projects/Sources/Chat/Auto-Deck can be open at a time) ──\r\n  // null = all collapsed\r\n  const [expandedPanel, setExpandedPanel] = useState<'projects' | 'sources' | 'chat' | 'auto-deck' | null>(null);\r\n  // selectedDocumentId is now in AppContext (with guard effect for auto-selection)\r\n\r\n  // ── Source-side generation spinner state (lifted from SourcesPanel/DocumentEditorModal to survive panel collapse) ──\r\n  const [generatingSourceIds, setGeneratingSourceIds] = useState<Set<string>>(new Set());\r\n\r\n  // ── TOC hard lock state (blocks all UI except SourcesPanel while TOC is dirty) ──\r\n  const [tocLockActive, setTocLockActive] = useState(false);\r\n\r\n  // ── Unsaved-changes gating for panel/nugget switching ──\r\n  const cardsPanelRef = useRef<PanelEditorHandle>(null);\r\n  const sourcesPanelRef = useRef<PanelEditorHandle>(null);\r\n  const [appPendingAction, setAppPendingAction] = useState<(() => void) | null>(null);\r\n  const [appPendingDirtyPanel, setAppPendingDirtyPanel] = useState<'cards' | 'sources' | null>(null);\r\n\r\n  const appGatedAction = useCallback((action: () => void) => {\r\n    if (cardsPanelRef.current?.isDirty) {\r\n      setAppPendingDirtyPanel('cards');\r\n      setAppPendingAction(() => action);\r\n      return;\r\n    }\r\n    if (sourcesPanelRef.current?.isDirty) {\r\n      setAppPendingDirtyPanel('sources');\r\n      setAppPendingAction(() => action);\r\n      return;\r\n    }\r\n    action();\r\n  }, []);\r\n\r\n  // ── Breadcrumb navigation handlers ──\r\n  const handleBreadcrumbProjectSelect = useCallback((projectId: string) => {\r\n    appGatedAction(() => {\r\n      setReferenceImage(null);\r\n      setUseReferenceImage(false);\r\n      selectEntity({ projectId });\r\n    });\r\n    setBreadcrumbDropdown(null);\r\n  }, [appGatedAction, selectEntity]);\r\n\r\n  const handleBreadcrumbNuggetSelect = useCallback((nuggetId: string) => {\r\n    appGatedAction(() => {\r\n      setReferenceImage(null);\r\n      setUseReferenceImage(false);\r\n      selectEntity({ nuggetId });\r\n    });\r\n    setBreadcrumbDropdown(null);\r\n  }, [appGatedAction, selectEntity]);\r\n\r\n  const handleBreadcrumbDocSelect = useCallback((docId: string) => {\r\n    selectEntity({ documentId: docId });\r\n    appGatedAction(() => setExpandedPanel('sources'));\r\n    setBreadcrumbDropdown(null);\r\n  }, [appGatedAction, selectEntity]);\r\n\r\n  const handleAppDialogSave = useCallback(() => {\r\n    const panel = appPendingDirtyPanel;\r\n    if (panel === 'cards') cardsPanelRef.current?.save();\r\n    else if (panel === 'sources') sourcesPanelRef.current?.save();\r\n    // After saving, re-check: is the OTHER panel dirty?\r\n    const otherRef = panel === 'cards' ? sourcesPanelRef : cardsPanelRef;\r\n    const otherLabel = panel === 'cards' ? 'sources' : 'cards';\r\n    if (otherRef.current?.isDirty) {\r\n      setAppPendingDirtyPanel(otherLabel as 'cards' | 'sources');\r\n      return;\r\n    }\r\n    const action = appPendingAction;\r\n    setAppPendingAction(null);\r\n    setAppPendingDirtyPanel(null);\r\n    action?.();\r\n  }, [appPendingAction, appPendingDirtyPanel]);\r\n\r\n  const handleAppDialogDiscard = useCallback(() => {\r\n    const panel = appPendingDirtyPanel;\r\n    if (panel === 'cards') cardsPanelRef.current?.discard();\r\n    else if (panel === 'sources') sourcesPanelRef.current?.discard();\r\n    const otherRef = panel === 'cards' ? sourcesPanelRef : cardsPanelRef;\r\n    const otherLabel = panel === 'cards' ? 'sources' : 'cards';\r\n    if (otherRef.current?.isDirty) {\r\n      setAppPendingDirtyPanel(otherLabel as 'cards' | 'sources');\r\n      return;\r\n    }\r\n    const action = appPendingAction;\r\n    setAppPendingAction(null);\r\n    setAppPendingDirtyPanel(null);\r\n    action?.();\r\n  }, [appPendingAction, appPendingDirtyPanel]);\r\n\r\n  const handleAppDialogCancel = useCallback(() => {\r\n    setAppPendingAction(null);\r\n    setAppPendingDirtyPanel(null);\r\n  }, []);\r\n\r\n  // ── Nugget's owned documents (per-nugget, no shared library) ──\r\n  const nuggetDocs = useMemo(() => {\r\n    if (!selectedNugget) return [];\r\n    return selectedNugget.documents;\r\n  }, [selectedNugget]);\r\n\r\n  // ── Breadcrumb derived data ──\r\n  const activeDocForBreadcrumb = useMemo(() => {\r\n    if (!nuggetDocs.length) return null;\r\n    if (selectedDocumentId) {\r\n      const found = nuggetDocs.find(d => d.id === selectedDocumentId);\r\n      if (found) return found;\r\n    }\r\n    return nuggetDocs[0];\r\n  }, [nuggetDocs, selectedDocumentId]);\r\n\r\n  const nuggetDropdownItems = useMemo(() => {\r\n    const parent = selectedNugget ? projects.find(p => p.nuggetIds.includes(selectedNugget.id)) : null;\r\n    const inProject = parent\r\n      ? parent.nuggetIds.map(nid => nuggets.find(n => n.id === nid)).filter((n): n is Nugget => !!n)\r\n      : [];\r\n    const allProjectIds = new Set(projects.flatMap(p => p.nuggetIds));\r\n    const ungrouped = nuggets.filter(n => !allProjectIds.has(n.id));\r\n    return { inProject, ungrouped, parent };\r\n  }, [nuggets, projects, selectedNugget]);\r\n\r\n  // Handle nugget creation (with optional pending files for background processing)\r\n  const handleCreateNugget = useCallback((nugget: Nugget, pendingFiles?: PendingFileUpload[]) => {\r\n    addNugget(nugget);\r\n    setSelectedNuggetId(nugget.id);\r\n    setSelectionLevel('nugget');\r\n    // Add to target project if specified\r\n    if (nuggetCreationProjectId) {\r\n      addNuggetToProject(nuggetCreationProjectId, nugget.id);\r\n      setNuggetCreationProjectId(null);\r\n    }\r\n\r\n    // If pending files are provided, process them in background and update nugget via updateNugget\r\n    // (uses explicit nuggetId — safe for async, no selectedNuggetId dependency)\r\n    if (pendingFiles && pendingFiles.length > 0) {\r\n      // Track for subject auto-generation once all docs are ready\r\n      pendingSubjectGenRef.current = nugget.id;\r\n      subjectGenDocIdsRef.current = new Set(pendingFiles.map(pf => pf.placeholderId));\r\n\r\n      for (const pf of pendingFiles) {\r\n        (async () => {\r\n          try {\r\n            let processed: UploadedFile;\r\n\r\n            if (pf.mode === 'native-pdf') {\r\n              // processNativePdf now handles bookmark-first extraction internally\r\n              const nativePdf = await processNativePdf(pf.file, pf.placeholderId);\r\n              // Upload PDF to Files API\r\n              let pdfFileId: string | undefined;\r\n              try {\r\n                pdfFileId = await uploadToFilesAPI(\r\n                  base64ToBlob(nativePdf.pdfBase64!, 'application/pdf'),\r\n                  pf.file.name,\r\n                  'application/pdf'\r\n                );\r\n              } catch (err) {\r\n                console.warn('[App] Native PDF Files API upload failed:', err);\r\n              }\r\n              processed = {\r\n                ...nativePdf,\r\n                fileId: pdfFileId,\r\n              };\r\n            } else {\r\n              processed = await processFileToDocument(pf.file, pf.placeholderId);\r\n              // Try Files API upload for Claude context\r\n              if (processed.content) {\r\n                try {\r\n                  const fileId = await uploadToFilesAPI(processed.content, pf.file.name, 'text/plain');\r\n                  processed = { ...processed, fileId };\r\n                } catch (err) {\r\n                  console.warn('[App] Files API upload failed (will use inline fallback):', err);\r\n                }\r\n              }\r\n            }\r\n\r\n            // Update the document within the nugget\r\n            updateNugget(nugget.id, n => ({\r\n              ...n,\r\n              documents: n.documents.map(d => d.id === pf.placeholderId ? processed : d),\r\n              lastModifiedAt: Date.now(),\r\n            }));\r\n          } catch (err) {\r\n            console.error(`[App] Processing failed for ${pf.file.name}:`, err);\r\n            updateNugget(nugget.id, n => ({\r\n              ...n,\r\n              documents: n.documents.map(d => d.id === pf.placeholderId ? { ...d, status: 'error' as const } : d),\r\n            }));\r\n            addToast({\r\n              type: 'error',\r\n              message: `Failed to process \"${pf.file.name}\"`,\r\n              detail: err instanceof Error ? err.message : 'An unexpected error occurred.',\r\n              duration: 10000,\r\n            });\r\n          }\r\n        })();\r\n      }\r\n    } else {\r\n      // No pending files — docs are already ready (shouldn't happen with new flow, but defensive)\r\n      const readyDocs = nugget.documents.filter(d => d.status === 'ready' && (d.content || d.fileId || d.pdfBase64));\r\n      if (readyDocs.length > 0 && !nugget.subject) {\r\n        (async () => {\r\n          try {\r\n            const subject = await generateSubject(readyDocs, recordUsage);\r\n            updateNugget(nugget.id, n => ({ ...n, subject, lastModifiedAt: Date.now() }));\r\n            addToast({\r\n              type: 'info',\r\n              message: `Subject: ${subject}`,\r\n              detail: 'Edit via nugget menu > Subject',\r\n              duration: 8000,\r\n            });\r\n          } catch (err) {\r\n            console.warn('[App] Subject auto-generation failed for new nugget:', err);\r\n            addToast({\r\n              type: 'warning',\r\n              message: 'Could not auto-generate subject',\r\n              detail: 'You can set it manually via the nugget menu > Subject.',\r\n              duration: 8000,\r\n            });\r\n          }\r\n        })();\r\n      }\r\n    }\r\n  }, [addNugget, setSelectedNuggetId, nuggetCreationProjectId, addNuggetToProject, updateNugget, recordUsage, addToast]);\r\n\r\n  // Handle project creation — returns the new project's ID\r\n  const handleCreateProject = useCallback((name: string, description: string): string => {\r\n    const now = Date.now();\r\n    const id = `project-${now}-${Math.random().toString(36).substr(2, 9)}`;\r\n    const project: Project = {\r\n      id,\r\n      name,\r\n      description: description || undefined,\r\n      nuggetIds: [],\r\n      createdAt: now,\r\n      lastModifiedAt: now,\r\n    };\r\n    addProject(project);\r\n    return id;\r\n  }, [addProject]);\r\n\r\n  // Handle copying a nugget to another project (duplicate nugget)\r\n  const handleCopyNuggetToProject = useCallback((nuggetId: string, targetProjectId: string) => {\r\n    const nugget = nuggets.find(n => n.id === nuggetId);\r\n    if (!nugget) return;\r\n    const now = Date.now();\r\n    const newNuggetId = `nugget-${now}-${Math.random().toString(36).substr(2, 9)}`;\r\n    // Get existing nugget names in the target project for dedup\r\n    const targetProject = projects.find(p => p.id === targetProjectId);\r\n    const targetNuggetNames = targetProject\r\n      ? targetProject.nuggetIds.map(nid => nuggets.find(n => n.id === nid)?.name || '').filter(Boolean)\r\n      : [];\r\n    const copiedNugget: Nugget = {\r\n      ...nugget,\r\n      id: newNuggetId,\r\n      name: getUniqueName(`${nugget.name} (copy)`, targetNuggetNames),\r\n      documents: nugget.documents.map(d => ({ ...d, id: `doc-${Math.random().toString(36).substr(2, 9)}` })),\r\n      cards: nugget.cards.map(c => ({ ...c, id: `card-${Math.random().toString(36).substr(2, 9)}` })),\r\n      messages: [...(nugget.messages || [])],\r\n      createdAt: now,\r\n      lastModifiedAt: now,\r\n    };\r\n    addNugget(copiedNugget);\r\n    addNuggetToProject(targetProjectId, newNuggetId);\r\n  }, [nuggets, projects, addNugget, addNuggetToProject]);\r\n\r\n  // Handle duplicating an entire project (deep clone project + all its nuggets)\r\n  const handleDuplicateProject = useCallback((projectId: string) => {\r\n    const project = projects.find(p => p.id === projectId);\r\n    if (!project) return;\r\n    const now = Date.now();\r\n    const newProjectId = `project-${now}-${Math.random().toString(36).substr(2, 9)}`;\r\n    const newNuggetIds: string[] = [];\r\n\r\n    // Deep-clone each nugget in the project\r\n    for (const nuggetId of project.nuggetIds) {\r\n      const nugget = nuggets.find(n => n.id === nuggetId);\r\n      if (!nugget) continue;\r\n      const newNuggetId = `nugget-${now}-${Math.random().toString(36).substr(2, 9)}-${newNuggetIds.length}`;\r\n      const copiedNugget: Nugget = {\r\n        ...nugget,\r\n        id: newNuggetId,\r\n        name: nugget.name, // keep same name — it's in a different project\r\n        documents: nugget.documents.map(d => ({ ...d, id: `doc-${Math.random().toString(36).substr(2, 9)}` })),\r\n        cards: nugget.cards.map(c => ({ ...c, id: `card-${Math.random().toString(36).substr(2, 9)}` })),\r\n        messages: [...(nugget.messages || [])],\r\n        createdAt: now,\r\n        lastModifiedAt: now,\r\n      };\r\n      addNugget(copiedNugget);\r\n      newNuggetIds.push(newNuggetId);\r\n    }\r\n\r\n    // Create the new project with cloned nugget IDs\r\n    const newProject: Project = {\r\n      id: newProjectId,\r\n      name: getUniqueName(`${project.name} (copy)`, projects.map(p => p.name)),\r\n      description: project.description,\r\n      nuggetIds: newNuggetIds,\r\n      createdAt: now,\r\n      lastModifiedAt: now,\r\n    };\r\n    addProject(newProject);\r\n  }, [nuggets, projects, addNugget, addProject]);\r\n\r\n  // Handle moving a nugget to another project (re-assign)\r\n  const handleMoveNuggetToProject = useCallback((nuggetId: string, sourceProjectId: string, targetProjectId: string) => {\r\n    // Auto-rename if name collides in target project\r\n    const nugget = nuggets.find(n => n.id === nuggetId);\r\n    if (nugget) {\r\n      const targetProject = projects.find(p => p.id === targetProjectId);\r\n      const targetNuggetNames = targetProject\r\n        ? targetProject.nuggetIds.map(nid => nuggets.find(n => n.id === nid)?.name || '').filter(Boolean)\r\n        : [];\r\n      const uniqueName = getUniqueName(nugget.name, targetNuggetNames);\r\n      if (uniqueName !== nugget.name) {\r\n        updateNugget(nuggetId, n => ({ ...n, name: uniqueName, lastModifiedAt: Date.now() }));\r\n      }\r\n    }\r\n    removeNuggetFromProject(sourceProjectId, nuggetId);\r\n    addNuggetToProject(targetProjectId, nuggetId);\r\n  }, [nuggets, projects, removeNuggetFromProject, addNuggetToProject, updateNugget]);\r\n\r\n  // Handle creating a new project for a nugget (copy or move)\r\n  // Inlined logic to avoid stale closure issues — creates the project with the nugget already assigned\r\n  const handleCreateProjectForNugget = useCallback((nuggetId: string, projectName: string, mode: 'copy' | 'move', sourceProjectId: string) => {\r\n    const now = Date.now();\r\n    const newProjectId = `project-${now}-${Math.random().toString(36).substr(2, 9)}`;\r\n    // Auto-increment project name if it already exists\r\n    const uniqueProjectName = getUniqueName(projectName, projects.map(p => p.name));\r\n\r\n    if (mode === 'move') {\r\n      // Move: create project with the nuggetId already included, remove from source\r\n      const newProject: Project = {\r\n        id: newProjectId,\r\n        name: uniqueProjectName,\r\n        nuggetIds: [nuggetId],\r\n        createdAt: now,\r\n        lastModifiedAt: now,\r\n      };\r\n      // Single setProjects call: add new project + remove nugget from source\r\n      setProjects(prev => [\r\n        ...prev.map(p =>\r\n          p.id === sourceProjectId\r\n            ? { ...p, nuggetIds: p.nuggetIds.filter(id => id !== nuggetId), lastModifiedAt: now }\r\n            : p\r\n        ),\r\n        newProject,\r\n      ]);\r\n    } else {\r\n      // Copy: duplicate the nugget, create project with the copy's ID\r\n      const nugget = nuggets.find(n => n.id === nuggetId);\r\n      if (!nugget) return;\r\n      const newNuggetId = `nugget-${now}-${Math.random().toString(36).substr(2, 9)}`;\r\n      const copiedNugget: Nugget = {\r\n        ...nugget,\r\n        id: newNuggetId,\r\n        name: `${nugget.name} (copy)`,\r\n        documents: nugget.documents.map(d => ({ ...d, id: `doc-${Math.random().toString(36).substr(2, 9)}` })),\r\n        cards: nugget.cards.map(c => ({ ...c, id: `card-${Math.random().toString(36).substr(2, 9)}` })),\r\n        messages: [...(nugget.messages || [])],\r\n        createdAt: now,\r\n        lastModifiedAt: now,\r\n      };\r\n      const newProject: Project = {\r\n        id: newProjectId,\r\n        name: uniqueProjectName,\r\n        nuggetIds: [newNuggetId],\r\n        createdAt: now,\r\n        lastModifiedAt: now,\r\n      };\r\n      addNugget(copiedNugget);\r\n      setProjects(prev => [...prev, newProject]);\r\n    }\r\n  }, [nuggets, projects, addNugget, setProjects]);\r\n\r\n  // Save card content as card in insights nugget\r\n  const handleSaveAsCard = useCallback((message: ChatMessage, editedContent: string) => {\r\n    if (!selectedNugget || selectedNugget.type !== 'insights') return;\r\n    const content = editedContent || message.content;\r\n\r\n    // Extract title from first # heading line, auto-increment if duplicate\r\n    const titleMatch = content.match(/^#\\s+(.+)$/m);\r\n    const rawTitle = titleMatch ? titleMatch[1].trim() : 'Untitled Card';\r\n    const existingCardNames = selectedNugget.cards.map(c => c.text);\r\n    const title = getUniqueName(rawTitle, existingCardNames);\r\n\r\n    // Remove the title line from content body\r\n    const bodyContent = content.replace(/^#\\s+.+\\n*/, '').trim();\r\n\r\n    const cardId = `card-${Math.random().toString(36).substr(2, 9)}`;\r\n    const level = message.detailLevel || 'Standard';\r\n\r\n    const activeDocNames = selectedNugget.documents\r\n      .filter(d => d.enabled !== false && d.content)\r\n      .map(d => d.name);\r\n\r\n    const newCard: Card = {\r\n      id: cardId,\r\n      text: title,\r\n      level: 1,\r\n      selected: false,\r\n      synthesisMap: { [level]: `# ${title}\\n\\n${bodyContent}` },\r\n      isSynthesizingMap: {},\r\n      detailLevel: level,\r\n      createdAt: Date.now(),\r\n      sourceDocuments: activeDocNames,\r\n    };\r\n\r\n    // Add card to nugget + mark message as saved\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: [...n.cards, newCard],\r\n      messages: (n.messages || []).map(m =>\r\n        m.id === message.id ? { ...m, savedAsCardId: cardId } : m\r\n      ),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n\r\n    // Propagate to old state for backward compat\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: [...prev.cards, newCard],\r\n        messages: prev.messages.map(m =>\r\n          m.id === message.id ? { ...m, savedAsCardId: cardId } : m\r\n        ),\r\n      };\r\n    });\r\n\r\n    // Select the new card\r\n    setActiveCardId(cardId);\r\n  }, [selectedNugget, updateNugget, setInsightsSession, setActiveCardId, menuDraftOptions]);\r\n\r\n  // Toggle selection for insights cards\r\n  const toggleInsightsCardSelection = useCallback((cardId: string) => {\r\n    if (!selectedNugget) return;\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(c =>\r\n        c.id === cardId ? { ...c, selected: !c.selected } : c\r\n      ),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    // Propagate to old state\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map(c =>\r\n          c.id === cardId ? { ...c, selected: !c.selected } : c\r\n        ),\r\n      };\r\n    });\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Select/deselect all insights cards\r\n  const toggleSelectAllInsightsCards = useCallback(() => {\r\n    if (!selectedNugget) return;\r\n    const cards = selectedNugget.cards || [];\r\n    const allSelected = cards.length > 0 && cards.every(c => c.selected);\r\n    const newSelected = !allSelected;\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(c => ({ ...c, selected: newSelected })),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map(c => ({ ...c, selected: newSelected })),\r\n      };\r\n    });\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Select a single card exclusively (deselect all others)\r\n  const selectInsightsCardExclusive = useCallback((cardId: string) => {\r\n    if (!selectedNugget) return;\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(c => ({ ...c, selected: c.id === cardId })),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map(c => ({ ...c, selected: c.id === cardId })),\r\n      };\r\n    });\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Select a range of cards between two IDs (inclusive)\r\n  const selectInsightsCardRange = useCallback((fromId: string, toId: string) => {\r\n    if (!selectedNugget) return;\r\n    const cards = selectedNugget.cards || [];\r\n    const fromIdx = cards.findIndex(c => c.id === fromId);\r\n    const toIdx = cards.findIndex(c => c.id === toId);\r\n    if (fromIdx === -1 || toIdx === -1) return;\r\n    const minIdx = Math.min(fromIdx, toIdx);\r\n    const maxIdx = Math.max(fromIdx, toIdx);\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map((c, i) => ({ ...c, selected: i >= minIdx && i <= maxIdx })),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map((c, i) => ({ ...c, selected: i >= minIdx && i <= maxIdx })),\r\n      };\r\n    });\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Deselect all insights cards\r\n  const deselectAllInsightsCards = useCallback(() => {\r\n    if (!selectedNugget) return;\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(c => ({ ...c, selected: false })),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map(c => ({ ...c, selected: false })),\r\n      };\r\n    });\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Reorder insights cards via drag-and-drop\r\n  const reorderInsightsCards = useCallback((fromIndex: number, toIndex: number) => {\r\n    if (!selectedNugget || fromIndex === toIndex) return;\r\n    const reorder = (cards: Card[]) => {\r\n      const next = [...cards];\r\n      const [moved] = next.splice(fromIndex, 1);\r\n      next.splice(toIndex, 0, moved);\r\n      return next;\r\n    };\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: reorder(n.cards),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => prev ? { ...prev, cards: reorder(prev.cards) } : prev);\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Delete insights card — fall back to first remaining card\r\n  const deleteInsightsCard = useCallback((cardId: string) => {\r\n    if (!selectedNugget) return;\r\n    const remaining = selectedNugget.cards.filter(c => c.id !== cardId);\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.filter(c => c.id !== cardId),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    // Propagate to old state\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return { ...prev, cards: prev.cards.filter(c => c.id !== cardId) };\r\n    });\r\n    // Fall back to first remaining card (or null)\r\n    setActiveCardId(remaining.length > 0 ? remaining[0].id : null);\r\n  }, [selectedNugget, updateNugget, setInsightsSession, setActiveCardId]);\r\n\r\n  // Delete selected insights cards (bulk) — fall back to first remaining card\r\n  const deleteSelectedInsightsCards = useCallback(() => {\r\n    if (!selectedNugget) return;\r\n    const selectedIds = new Set(selectedNugget.cards.filter(c => c.selected).map(c => c.id));\r\n    if (selectedIds.size === 0) return;\r\n    const remaining = selectedNugget.cards.filter(c => !selectedIds.has(c.id));\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.filter(c => !selectedIds.has(c.id)),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return { ...prev, cards: prev.cards.filter(c => !selectedIds.has(c.id)) };\r\n    });\r\n    // Fall back to first remaining card (or null)\r\n    setActiveCardId(remaining.length > 0 ? remaining[0].id : null);\r\n  }, [selectedNugget, updateNugget, setInsightsSession, setActiveCardId]);\r\n\r\n  // Rename insights card — also sync H1 heading in all synthesisMap entries\r\n  const renameInsightsCard = useCallback((cardId: string, newName: string) => {\r\n    updateNuggetCard(cardId, c => {\r\n      const updated: Card = { ...c, text: newName, lastEditedAt: Date.now() };\r\n      // Sync H1 heading across all detail levels that have content\r\n      if (c.synthesisMap) {\r\n        const newMap = { ...c.synthesisMap };\r\n        for (const level of Object.keys(newMap) as DetailLevel[]) {\r\n          const content = newMap[level];\r\n          if (!content) continue;\r\n          // Replace existing H1 or prepend one\r\n          const h1Match = content.match(/^(#\\s+)(.+)$/m);\r\n          if (h1Match) {\r\n            newMap[level] = content.replace(/^#\\s+.+$/m, `# ${newName}`);\r\n          }\r\n          // If no H1 exists, don't add one — ensureH1 in CardsPanel handles that\r\n        }\r\n        updated.synthesisMap = newMap;\r\n      }\r\n      return updated;\r\n    });\r\n  }, [updateNuggetCard]);\r\n\r\n  // Save card content from inline editor\r\n  const handleSaveCardContent = useCallback((cardId: string, level: DetailLevel, newContent: string) => {\r\n    updateNuggetCard(cardId, c => ({\r\n      ...c,\r\n      synthesisMap: { ...(c.synthesisMap || {}), [level]: newContent },\r\n      lastEditedAt: Date.now(),\r\n    }));\r\n  }, [updateNuggetCard]);\r\n\r\n  // Handle image modified for insights cards\r\n  const handleInsightsImageModified = useCallback((cardId: string, newImageUrl: string, history: any[]) => {\r\n    if (!selectedNugget) return;\r\n    const card = selectedNugget.cards.find(c => c.id === cardId);\r\n    const level = card?.detailLevel || activeLogicTab;\r\n\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(c => {\r\n        if (c.id !== cardId) return c;\r\n        return {\r\n          ...c,\r\n          cardUrlMap: { ...(c.cardUrlMap || {}), [level]: newImageUrl },\r\n          imageHistoryMap: { ...(c.imageHistoryMap || {}), [level]: history },\r\n        };\r\n      }),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    // Propagate to old state\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map(c => {\r\n          if (c.id !== cardId) return c;\r\n          return {\r\n            ...c,\r\n            cardUrlMap: { ...(c.cardUrlMap || {}), [level]: newImageUrl },\r\n            imageHistoryMap: { ...(c.imageHistoryMap || {}), [level]: history },\r\n          };\r\n        }),\r\n      };\r\n    });\r\n  }, [selectedNugget, updateNugget, setInsightsSession]);\r\n\r\n  // Delete current card image (current detail level only)\r\n  const handleDeleteCardImage = useCallback(() => {\r\n    if (!activeCardId || !selectedNugget) return;\r\n    const level = activeLogicTab;\r\n    const cardUpdater = (c: Card) => {\r\n      if (c.id !== activeCardId) return c;\r\n      const newUrlMap = { ...(c.cardUrlMap || {}) };\r\n      delete newUrlMap[level];\r\n      const newHistoryMap = { ...(c.imageHistoryMap || {}) };\r\n      delete newHistoryMap[level];\r\n      const newPlanMap = { ...(c.visualPlanMap || {}) };\r\n      delete newPlanMap[level];\r\n      const newPromptMap = { ...(c.lastPromptMap || {}) };\r\n      delete newPromptMap[level];\r\n      const newGenContentMap = { ...(c.lastGeneratedContentMap || {}) };\r\n      delete newGenContentMap[level];\r\n      return { ...c, cardUrlMap: newUrlMap, imageHistoryMap: newHistoryMap, visualPlanMap: newPlanMap, lastPromptMap: newPromptMap, lastGeneratedContentMap: newGenContentMap };\r\n    };\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(cardUpdater),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return { ...prev, cards: prev.cards.map(cardUpdater) };\r\n    });\r\n  }, [activeCardId, selectedNugget, activeLogicTab, updateNugget, setInsightsSession]);\r\n\r\n  // Delete all images for the active card (current image + version history, current detail level)\r\n  const handleDeleteCardVersions = useCallback(() => {\r\n    if (!activeCardId || !selectedNugget) return;\r\n    const level = activeLogicTab;\r\n    const cardUpdater = (c: Card) => {\r\n      if (c.id !== activeCardId) return c;\r\n      const newUrlMap = { ...(c.cardUrlMap || {}) };\r\n      delete newUrlMap[level];\r\n      const newHistoryMap = { ...(c.imageHistoryMap || {}) };\r\n      delete newHistoryMap[level];\r\n      const newPlanMap = { ...(c.visualPlanMap || {}) };\r\n      delete newPlanMap[level];\r\n      const newPromptMap = { ...(c.lastPromptMap || {}) };\r\n      delete newPromptMap[level];\r\n      const newGenContentMap = { ...(c.lastGeneratedContentMap || {}) };\r\n      delete newGenContentMap[level];\r\n      return { ...c, cardUrlMap: newUrlMap, imageHistoryMap: newHistoryMap, visualPlanMap: newPlanMap, lastPromptMap: newPromptMap, lastGeneratedContentMap: newGenContentMap };\r\n    };\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(cardUpdater),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return { ...prev, cards: prev.cards.map(cardUpdater) };\r\n    });\r\n  }, [activeCardId, selectedNugget, activeLogicTab, updateNugget, setInsightsSession]);\r\n\r\n  // Delete all card images across all cards (current detail level)\r\n  const handleDeleteAllCardImages = useCallback(() => {\r\n    if (!selectedNugget) return;\r\n    const level = activeLogicTab;\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: n.cards.map(c => {\r\n        const newUrlMap = { ...(c.cardUrlMap || {}) };\r\n        delete newUrlMap[level];\r\n        const newHistoryMap = { ...(c.imageHistoryMap || {}) };\r\n        delete newHistoryMap[level];\r\n        const newPlanMap = { ...(c.visualPlanMap || {}) };\r\n        delete newPlanMap[level];\r\n        const newPromptMap = { ...(c.lastPromptMap || {}) };\r\n        delete newPromptMap[level];\r\n        const newGenContentMap = { ...(c.lastGeneratedContentMap || {}) };\r\n        delete newGenContentMap[level];\r\n        return { ...c, cardUrlMap: newUrlMap, imageHistoryMap: newHistoryMap, visualPlanMap: newPlanMap, lastPromptMap: newPromptMap, lastGeneratedContentMap: newGenContentMap };\r\n      }),\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => {\r\n      if (!prev) return prev;\r\n      return {\r\n        ...prev,\r\n        cards: prev.cards.map(c => {\r\n          const newUrlMap = { ...(c.cardUrlMap || {}) };\r\n          delete newUrlMap[level];\r\n          const newHistoryMap = { ...(c.imageHistoryMap || {}) };\r\n          delete newHistoryMap[level];\r\n          return { ...c, cardUrlMap: newUrlMap, imageHistoryMap: newHistoryMap };\r\n        }),\r\n      };\r\n    });\r\n  }, [selectedNugget, activeLogicTab, updateNugget, setInsightsSession]);\r\n\r\n  // Insights selected count\r\n  const insightsSelectedCount = useMemo(() => {\r\n    if (selectedNugget?.type === 'insights') {\r\n      return selectedNugget.cards.filter(c => c.selected).length;\r\n    }\r\n    return insightsSession?.cards?.filter(c => c.selected).length || 0;\r\n  }, [selectedNugget, insightsSession]);\r\n\r\n  const [showLanding, setShowLanding] = useState(true);\r\n  const handleLaunch = useCallback(() => setShowLanding(false), []);\r\n  const [copied, setCopied] = useState(false);\r\n  const [emptyDragging, setEmptyDragging] = useState(false);\r\n  const [showUsageDropdown, setShowUsageDropdown] = useState(false);\r\n  const usageDropdownRef = useRef<HTMLDivElement>(null);\r\n  const [breadcrumbDropdown, setBreadcrumbDropdown] = useState<'project' | 'nugget' | 'document' | null>(null);\r\n  const breadcrumbRef = useRef<HTMLDivElement>(null);\r\n\r\n  const committedSettings = useMemo(() => {\r\n    return selectedNugget?.stylingOptions || DEFAULT_STYLING;\r\n  }, [selectedNugget?.stylingOptions]);\r\n\r\n  // Auto-select first card when cards exist but none is active\r\n  const nuggetCards = selectedNugget?.cards ?? [];\r\n  useEffect(() => {\r\n    if (nuggetCards.length > 0 && (!activeCardId || !nuggetCards.find(c => c.id === activeCardId))) {\r\n      setActiveCardId(nuggetCards[0].id);\r\n    }\r\n  }, [nuggetCards, activeCardId, setActiveCardId]);\r\n\r\n  // Sync logic tab with card's structural detail level whenever card changes\r\n  useEffect(() => {\r\n    if (activeCard?.detailLevel) {\r\n      setActiveLogicTab(activeCard.detailLevel);\r\n    }\r\n  }, [activeCardId, activeCard?.detailLevel]);\r\n\r\n  // Keep menuDraftOptions.levelOfDetail in sync with activeLogicTab\r\n  useEffect(() => {\r\n    setMenuDraftOptions(prev => prev.levelOfDetail !== activeLogicTab ? { ...prev, levelOfDetail: activeLogicTab } : prev);\r\n  }, [activeLogicTab]);\r\n\r\n  // ── Nugget ↔ toolbar styling sync ──\r\n  // Read: sync toolbar FROM nugget on nugget selection change\r\n  useEffect(() => {\r\n    const nugget = nuggets.find(n => n.id === selectedNuggetId);\r\n    skipStylingWritebackRef.current = true;\r\n    setMenuDraftOptions(nugget?.stylingOptions || DEFAULT_STYLING);\r\n  }, [selectedNuggetId]);\r\n\r\n  // Write: persist toolbar changes TO nugget (no lastModifiedAt bump — styling is a preference)\r\n  useEffect(() => {\r\n    if (skipStylingWritebackRef.current) {\r\n      skipStylingWritebackRef.current = false;\r\n      return;\r\n    }\r\n    if (!selectedNuggetId) return;\r\n    updateNugget(selectedNuggetId, n => ({\r\n      ...n,\r\n      stylingOptions: menuDraftOptions,\r\n    }));\r\n  }, [menuDraftOptions]);\r\n\r\n  // ── Global keyboard shortcuts ──\r\n  useEffect(() => {\r\n    const onKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') {\r\n        setZoomState({ imageUrl: null, cardId: null, cardText: null });\r\n        setManifestCards(null);\r\n        setExpandedPanel(null);\r\n      }\r\n    };\r\n    window.addEventListener('keydown', onKeyDown);\r\n    return () => {\r\n      window.removeEventListener('keydown', onKeyDown);\r\n    };\r\n  }, []);\r\n\r\n  // ── Click-outside to close overlay panels ──\r\n  useEffect(() => {\r\n    if (!expandedPanel) return;\r\n    const handler = (e: MouseEvent) => {\r\n      const target = e.target as HTMLElement;\r\n      if (target.closest('[data-panel-overlay]')) return;\r\n      if (target.closest('[data-panel-strip]')) return;\r\n      if (target.closest('[data-breadcrumb-dropdown]')) return;\r\n      // Don't close when clicking portal-rendered menus, modals, dialogs (z-index ≥ 100)\r\n      const fixed = target.closest('.fixed');\r\n      if (fixed && fixed.parentElement === document.body) return;\r\n      appGatedAction(() => setExpandedPanel(null));\r\n    };\r\n    document.addEventListener('mousedown', handler);\r\n    return () => document.removeEventListener('mousedown', handler);\r\n  }, [expandedPanel, appGatedAction]);\r\n\r\n  // Close usage dropdown on outside click\r\n  useEffect(() => {\r\n    if (!showUsageDropdown) return;\r\n    const handler = (e: MouseEvent) => {\r\n      if (usageDropdownRef.current && !usageDropdownRef.current.contains(e.target as Node)) {\r\n        setShowUsageDropdown(false);\r\n      }\r\n    };\r\n    document.addEventListener('mousedown', handler);\r\n    return () => document.removeEventListener('mousedown', handler);\r\n  }, [showUsageDropdown]);\r\n\r\n  // Close breadcrumb dropdown on outside click or Escape\r\n  useEffect(() => {\r\n    if (!breadcrumbDropdown) return;\r\n    const onClick = (e: MouseEvent) => {\r\n      if (breadcrumbRef.current && !breadcrumbRef.current.contains(e.target as Node))\r\n        setBreadcrumbDropdown(null);\r\n    };\r\n    const onKey = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') setBreadcrumbDropdown(null);\r\n    };\r\n    document.addEventListener('mousedown', onClick);\r\n    document.addEventListener('keydown', onKey);\r\n    return () => {\r\n      document.removeEventListener('mousedown', onClick);\r\n      document.removeEventListener('keydown', onKey);\r\n    };\r\n  }, [breadcrumbDropdown]);\r\n\r\n  // Auto-close breadcrumb dropdown on nugget change\r\n  useEffect(() => { setBreadcrumbDropdown(null); }, [selectedNuggetId]);\r\n\r\n  const openZoom = useCallback((imageUrl: string) => {\r\n    const settings = committedSettings;\r\n    setZoomState({\r\n      imageUrl,\r\n      cardId: activeCard?.id || null,\r\n      cardText: activeCard?.text || null,\r\n      palette: settings.palette || null,\r\n      imageHistory: activeCard?.imageHistoryMap?.[activeLogicTab],\r\n      aspectRatio: settings.aspectRatio,\r\n      resolution: settings.resolution,\r\n    });\r\n  }, [activeCard, committedSettings, activeLogicTab]);\r\n\r\n  const closeZoom = useCallback(() => {\r\n    setZoomState({ imageUrl: null, cardId: null, cardText: null });\r\n  }, []);\r\n\r\n  // ── Reference image stamp & mismatch ──\r\n  const handleStampReference = useCallback(() => {\r\n    const cardUrl = activeCard?.cardUrlMap?.[activeLogicTab];\r\n    if (!cardUrl) return;\r\n    setReferenceImage({ url: cardUrl, settings: { ...menuDraftOptions } });\r\n    setUseReferenceImage(true);\r\n  }, [activeCard, activeLogicTab, menuDraftOptions]);\r\n\r\n  const handleReferenceImageModified = useCallback((newImageUrl: string) => {\r\n    setReferenceImage(prev => prev ? { ...prev, url: newImageUrl } : prev);\r\n  }, []);\r\n\r\n  const handleDeleteReference = useCallback(() => {\r\n    setReferenceImage(null);\r\n    setUseReferenceImage(false);\r\n  }, []);\r\n\r\n  const showMismatchDialog = useCallback(() => {\r\n    return new Promise<'disable' | 'skip' | 'cancel'>((resolve) => {\r\n      setMismatchDialog({ resolve });\r\n    });\r\n  }, []);\r\n\r\n  const wrappedGenerateCard = useCallback(async (card: Card) => {\r\n    if (referenceImage && useReferenceImage) {\r\n      if (detectSettingsMismatch(menuDraftOptions, referenceImage.settings)) {\r\n        const decision = await showMismatchDialog();\r\n        if (decision === 'cancel') return;\r\n        if (decision === 'disable') setUseReferenceImage(false);\r\n        if (decision === 'disable' || decision === 'skip') {\r\n          await generateCard(card, true);\r\n          return;\r\n        }\r\n      }\r\n    }\r\n    await generateCard(card);\r\n  }, [referenceImage, useReferenceImage, menuDraftOptions, generateCard, showMismatchDialog]);\r\n\r\n  const wrappedExecuteBatch = useCallback(async () => {\r\n    if (referenceImage && useReferenceImage) {\r\n      if (detectSettingsMismatch(menuDraftOptions, referenceImage.settings)) {\r\n        const decision = await showMismatchDialog();\r\n        if (decision === 'cancel') return;\r\n        if (decision === 'disable') setUseReferenceImage(false);\r\n      }\r\n    }\r\n    await executeBatchCardGeneration();\r\n  }, [referenceImage, useReferenceImage, menuDraftOptions, executeBatchCardGeneration, showMismatchDialog]);\r\n\r\n  const downloadDataUrl = useCallback((dataUrl: string, filename: string) => {\r\n    const a = document.createElement('a');\r\n    a.href = dataUrl;\r\n    a.download = filename;\r\n    a.click();\r\n  }, []);\r\n\r\n  const handleDownloadImage = useCallback(() => {\r\n    const url = activeCard?.cardUrlMap?.[activeLogicTab];\r\n    if (!url) return;\r\n    const slug = activeCard!.text.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-|-$/g, '').toLowerCase().slice(0, 40);\r\n    downloadDataUrl(url, `${slug}-${activeLogicTab.toLowerCase()}.png`);\r\n  }, [activeCard, activeLogicTab, downloadDataUrl]);\r\n\r\n  const handleDownloadAllImages = useCallback(() => {\r\n    if (!selectedNugget) return;\r\n    for (const card of selectedNugget.cards) {\r\n      const url = card.cardUrlMap?.[activeLogicTab];\r\n      if (!url) continue;\r\n      const slug = card.text.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-|-$/g, '').toLowerCase().slice(0, 40);\r\n      downloadDataUrl(url, `${slug}-${activeLogicTab.toLowerCase()}.png`);\r\n    }\r\n  }, [selectedNugget, activeLogicTab, downloadDataUrl]);\r\n\r\n\r\n  // ── Custom card creation handler (passed to CardsPanel) ──\r\n  const handleCreateCustomCard = useCallback((name: string) => {\r\n    if (!selectedNugget) return;\r\n    const newId = crypto.randomUUID();\r\n    const existingNames = selectedNugget.cards.map(c => c.text);\r\n    const newCard: Card = {\r\n      id: newId,\r\n      level: 1,\r\n      text: getUniqueName(name, existingNames),\r\n      synthesisMap: { Standard: '' },\r\n      createdAt: Date.now(),\r\n      lastEditedAt: Date.now(),\r\n    };\r\n    // Add card to nugget + insightsSession\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      cards: [...n.cards, newCard],\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    setInsightsSession(prev => prev ? { ...prev, cards: [...prev.cards, newCard] } : prev);\r\n    setActiveCardId(newId);\r\n  }, [selectedNugget, updateNugget, setInsightsSession, setActiveCardId, getUniqueName]);\r\n\r\n  // ── Shared nugget list props (used by both SourcesPanel and CardsPanel) ──\r\n  const otherNuggetsList = useMemo(() =>\r\n    nuggets.filter(n => n.id !== selectedNugget?.id).map(n => ({ id: n.id, name: n.name })),\r\n    [nuggets, selectedNugget?.id]\r\n  );\r\n\r\n  const projectNuggetsList = useMemo(() =>\r\n    projects.map(p => ({\r\n      projectId: p.id,\r\n      projectName: p.name,\r\n      nuggets: p.nuggetIds\r\n        .filter(nid => nid !== selectedNugget?.id)\r\n        .map(nid => nuggets.find(n => n.id === nid))\r\n        .filter((n): n is Nugget => !!n)\r\n        .map(n => ({ id: n.id, name: n.name })),\r\n    })),\r\n    [projects, nuggets, selectedNugget?.id]\r\n  );\r\n\r\n  // ── Generate card content from Sources panel ──\r\n  const handleGenerateCardContent = useCallback(async (_editorCardId: string, detailLevel: DetailLevel, cardTitle: string, sourceDocName?: string) => {\r\n    if (!selectedNugget || !cardTitle) return;\r\n    // Track this generation in lifted state so spinners survive panel collapse\r\n    setGeneratingSourceIds(prev => { const next = new Set(prev); next.add(_editorCardId); return next; });\r\n\r\n    // Gather document content from all enabled nugget documents (including native PDFs with fileId only)\r\n    const enabledDocs = selectedNugget.documents.filter(d => d.enabled !== false && (d.content || d.fileId));\r\n    // Split: docs with fileId go via Files API only; docs without fileId go inline\r\n    const fileApiDocs = enabledDocs.filter(d => d.fileId);\r\n    const inlineDocs = enabledDocs.filter(d => !d.fileId && d.content);\r\n    // fullDocument is built from inline-only docs (no fileId) for section extraction\r\n    const inlineContent = inlineDocs.map(d => d.content).join('\\n\\n---\\n\\n');\r\n    if (!inlineContent && fileApiDocs.length === 0) return;\r\n\r\n    // Find the section text for this card title in inline markdown docs\r\n    let sectionText = '';\r\n    if (inlineContent) {\r\n      const escapedText = cardTitle.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n      const headingRegex = new RegExp(`^(#{1,6})\\\\s+${escapedText}\\\\s*$`, 'gm');\r\n      const match = headingRegex.exec(inlineContent);\r\n      const startOffset = match ? match.index : 0;\r\n      const headingLevel = match ? match[1].length : 1;\r\n      const nextHeadingRegex = new RegExp(`^#{1,${headingLevel}}\\\\s+`, 'gm');\r\n      nextHeadingRegex.lastIndex = startOffset + (match ? match[0].length : 0);\r\n      const nextMatch = nextHeadingRegex.exec(inlineContent);\r\n      sectionText = inlineContent.substring(startOffset, nextMatch ? nextMatch.index : inlineContent.length);\r\n    }\r\n\r\n    // For native PDFs (no markdown), build a section hint with page boundaries\r\n    // so Claude can locate the right section within the file_id document\r\n    const nativePdfSectionHint = (!sectionText && fileApiDocs.length > 0)\r\n      ? buildNativePdfSectionHint(cardTitle, enabledDocs)\r\n      : '';\r\n\r\n    // ── Direct Content: use raw section text as-is, no AI synthesis ──\r\n    // (Only works for markdown docs — native PDFs have no raw text to copy)\r\n    if (detailLevel === 'DirectContent' && inlineContent) {\r\n      const isWholeDoc = _editorCardId === '__whole_document__';\r\n      let directText = isWholeDoc ? inlineContent.trim() : sectionText.trim();\r\n      if (!directText.startsWith('#')) {\r\n        directText = `# ${cardTitle}\\n\\n${directText}`;\r\n      }\r\n\r\n      const newCardId = `card-${Math.random().toString(36).substr(2, 9)}`;\r\n      const cardSourceDocs = sourceDocName ? [sourceDocName] : enabledDocs.map(d => d.name);\r\n      const uniqueCardName = getUniqueName(cardTitle, selectedNugget.cards.map(c => c.text));\r\n\r\n      const newCard: Card = {\r\n        id: newCardId,\r\n        text: uniqueCardName,\r\n        level: 1,\r\n        selected: false,\r\n        synthesisMap: { [detailLevel]: directText },\r\n        isSynthesizingMap: {},\r\n        detailLevel,\r\n        createdAt: Date.now(),\r\n        sourceDocuments: cardSourceDocs,\r\n      };\r\n\r\n      updateNugget(selectedNugget.id, n => ({\r\n        ...n,\r\n        cards: [...n.cards, newCard],\r\n        lastModifiedAt: Date.now(),\r\n      }));\r\n\r\n      setInsightsSession(prev => {\r\n        if (!prev) return prev;\r\n        return { ...prev, cards: [...prev.cards, newCard] };\r\n      });\r\n\r\n      setActiveCardId(newCardId);\r\n      return;\r\n    }\r\n\r\n    // Build prompt and call Claude — branch for cover vs content\r\n    const isCover = isCoverLevel(detailLevel);\r\n    const synthesisPrompt = isCover\r\n      ? buildCoverContentPrompt(cardTitle, detailLevel, inlineContent, sectionText, true)\r\n      : buildContentPrompt(cardTitle, detailLevel, inlineContent, sectionText, true);\r\n    // Append native PDF section hint when section extraction wasn't possible via regex\r\n    const finalPrompt = synthesisPrompt + nativePdfSectionHint;\r\n\r\n    const systemRole = isCover\r\n      ? 'You are an expert cover slide content designer. You create bold, concise titles, subtitles, and taglines for presentation cover slides. Follow the format and word count requirements precisely.'\r\n      : 'You are an expert content synthesizer. You extract, restructure, and condense document content into infographic-ready text. Follow the formatting and word count requirements precisely.';\r\n\r\n    try {\r\n      const systemBlocks: Array<{ text: string; cache: boolean }> = [\r\n        { text: systemRole, cache: false },\r\n      ];\r\n      // Only inline docs (no fileId) go into system blocks — avoids double-sending\r\n      if (inlineDocs.length > 0) {\r\n        systemBlocks.push({ text: `FULL DOCUMENT CONTEXT:\\n${inlineContent}`, cache: true });\r\n      }\r\n\r\n      // Build messages array with Files API document blocks prepended\r\n      const messages: Array<{ role: 'user' | 'assistant'; content: any }> = [];\r\n      if (fileApiDocs.length > 0) {\r\n        const docBlocks = fileApiDocs.map(d => ({\r\n          type: 'document' as const,\r\n          source: { type: 'file' as const, file_id: d.fileId! },\r\n          title: d.name,\r\n        }));\r\n        // Inject bookmark-based TOC into system prompt for native PDFs\r\n        for (const d of fileApiDocs) {\r\n          if (d.sourceType === 'native-pdf' && d.bookmarks?.length) {\r\n            const tocPrompt = buildTocSystemPrompt(d.bookmarks, d.name);\r\n            if (tocPrompt) systemBlocks.push({ text: tocPrompt, cache: true });\r\n          }\r\n        }\r\n        messages.push({\r\n          role: 'user' as const,\r\n          content: [...docBlocks, { type: 'text' as const, text: finalPrompt }],\r\n        });\r\n      }\r\n\r\n      const { text: rawSynthesized, usage: claudeUsage } = await callClaude(\r\n        fileApiDocs.length > 0 ? '' : finalPrompt,\r\n        {\r\n          systemBlocks,\r\n          ...(fileApiDocs.length > 0 ? { messages } : {}),\r\n          maxTokens: isCover\r\n            ? (detailLevel === 'TakeawayCard' ? 350 : 256)\r\n            : (detailLevel === 'Executive' ? 300 : detailLevel === 'Standard' ? 600 : 1200),\r\n        },\r\n      );\r\n\r\n      recordUsage({\r\n        provider: 'claude',\r\n        model: 'claude-sonnet-4-6',\r\n        inputTokens: claudeUsage.input_tokens,\r\n        outputTokens: claudeUsage.output_tokens,\r\n        cacheReadTokens: claudeUsage.cache_read_input_tokens,\r\n        cacheWriteTokens: claudeUsage.cache_creation_input_tokens,\r\n      });\r\n\r\n      let synthesizedText = rawSynthesized;\r\n      if (!isCover) {\r\n        // Strip any leading H1 that Claude may have included, then re-add with the correct title\r\n        synthesizedText = synthesizedText.replace(/^\\s*#\\s+[^\\n]*\\n*/, '');\r\n        synthesizedText = `# ${cardTitle}\\n\\n${synthesizedText.trimStart()}`;\r\n      }\r\n\r\n      // Create a new card with the synthesized content\r\n      const newCardId = `card-${Math.random().toString(36).substr(2, 9)}`;\r\n      const cardSourceDocs = sourceDocName ? [sourceDocName] : enabledDocs.map(d => d.name);\r\n      const uniqueCardName = getUniqueName(cardTitle, selectedNugget.cards.map(c => c.text));\r\n\r\n      const newCard: Card = {\r\n        id: newCardId,\r\n        text: uniqueCardName,\r\n        level: 1,\r\n        selected: false,\r\n        synthesisMap: { [detailLevel]: synthesizedText },\r\n        isSynthesizingMap: {},\r\n        detailLevel,\r\n        createdAt: Date.now(),\r\n        sourceDocuments: cardSourceDocs,\r\n      };\r\n\r\n      // Add card to nugget\r\n      updateNugget(selectedNugget.id, n => ({\r\n        ...n,\r\n        cards: [...n.cards, newCard],\r\n        lastModifiedAt: Date.now(),\r\n      }));\r\n\r\n      // Propagate to old state for backward compat\r\n      setInsightsSession(prev => {\r\n        if (!prev) return prev;\r\n        return { ...prev, cards: [...prev.cards, newCard] };\r\n      });\r\n\r\n      // Select the new card\r\n      setActiveCardId(newCardId);\r\n    } catch (err) {\r\n      console.error('Generate card content failed:', err);\r\n    } finally {\r\n      setGeneratingSourceIds(prev => { const next = new Set(prev); next.delete(_editorCardId); return next; });\r\n    }\r\n  }, [selectedNugget, menuDraftOptions, updateNugget, setInsightsSession, setActiveCardId, recordUsage]);\r\n\r\n  // ── Document handlers for SourcesPanel ──\r\n  const handleSaveDocument = useCallback(async (docId: string, newContent: string) => {\r\n    if (!selectedNugget) return;\r\n    const doc = selectedNugget.documents.find(d => d.id === docId);\r\n    if (!doc) return;\r\n    // Re-upload to Files API with updated content\r\n    let fileId = doc.fileId;\r\n    try {\r\n      if (doc.fileId) deleteFromFilesAPI(doc.fileId);\r\n      fileId = await uploadToFilesAPI(newContent, doc.name, 'text/plain');\r\n    } catch (err) {\r\n      console.warn('[App] Files API re-upload failed (will use inline fallback):', err);\r\n    }\r\n    updateNuggetDocument(docId, { ...doc, content: newContent, fileId, lastEditedAt: Date.now(), version: (doc.version ?? 1) + 1 });\r\n  }, [selectedNugget, updateNuggetDocument]);\r\n\r\n  // ── Save TOC / bookmark changes ──\r\n  const handleSaveToc = useCallback(async (docId: string, newStructure: Heading[]) => {\r\n    if (!selectedNugget) return;\r\n    const doc = selectedNugget.documents.find(d => d.id === docId);\r\n    if (!doc) return;\r\n\r\n    // Convert flat headings to bookmark tree if this is a native PDF\r\n    const newBookmarks = doc.sourceType === 'native-pdf'\r\n      ? headingsToBookmarks(newStructure)\r\n      : undefined;\r\n\r\n    // Write bookmarks into the PDF for export if available\r\n    let newPdfBase64 = doc.pdfBase64;\r\n    if (newBookmarks && newBookmarks.length > 0 && doc.pdfBase64) {\r\n      try {\r\n        newPdfBase64 = await writeBookmarksToPdf(doc.pdfBase64, newBookmarks);\r\n      } catch (err) {\r\n        console.warn('[App] Failed to write bookmarks into PDF:', err);\r\n      }\r\n    }\r\n\r\n    // Update document in nugget state\r\n    updateNuggetDocument(docId, {\r\n      ...doc,\r\n      structure: newStructure,\r\n      bookmarks: newBookmarks ?? doc.bookmarks,\r\n      bookmarkSource: newBookmarks ? 'manual' as const : doc.bookmarkSource,\r\n      pdfBase64: newPdfBase64,\r\n      version: (doc.version ?? 1) + 1,\r\n    });\r\n\r\n    // Log TOC update for chat notification\r\n    updateNugget(selectedNugget.id, n => ({\r\n      ...n,\r\n      docChangeLog: [...(n.docChangeLog || []), {\r\n        type: 'toc_updated' as const,\r\n        docId,\r\n        docName: doc.name,\r\n        timestamp: Date.now(),\r\n      }],\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n  }, [selectedNugget, updateNuggetDocument, updateNugget, addToast]);\r\n\r\n  const handleCopyMoveDocument = useCallback(async (docId: string, targetNuggetId: string, mode: 'copy' | 'move') => {\r\n    if (!selectedNugget) return;\r\n    const doc = selectedNugget.documents.find(d => d.id === docId);\r\n    if (!doc) return;\r\n    // Auto-increment name if it collides in target nugget\r\n    const targetNugget = nuggets.find(n => n.id === targetNuggetId);\r\n    const targetDocNames = targetNugget ? targetNugget.documents.map(d => d.name) : [];\r\n    const uniqueDocName = getUniqueName(doc.name, targetDocNames, true);\r\n    // Copy the document to the target nugget with a new ID\r\n    const newDocId = `doc-${Math.random().toString(36).substr(2, 9)}`;\r\n    // Upload the copy to Files API so it has its own file_id\r\n    let copyFileId: string | undefined;\r\n    try {\r\n      if (doc.sourceType === 'native-pdf' && doc.pdfBase64) {\r\n        copyFileId = await uploadToFilesAPI(base64ToBlob(doc.pdfBase64, 'application/pdf'), uniqueDocName, 'application/pdf');\r\n      } else if (doc.content) {\r\n        copyFileId = await uploadToFilesAPI(doc.content, uniqueDocName, 'text/plain');\r\n      }\r\n    } catch (err) {\r\n      console.warn('[App] Files API upload for document copy failed:', err);\r\n    }\r\n    // Derive source project name for origin tracking\r\n    const sourceProject = projects.find(p => p.nuggetIds.includes(selectedNugget.id));\r\n    const docCopy: UploadedFile = {\r\n      ...doc,\r\n      id: newDocId,\r\n      name: uniqueDocName,\r\n      fileId: copyFileId,\r\n      originalName: doc.originalName ?? doc.name,\r\n      sourceOrigin: {\r\n        type: mode === 'copy' ? 'copied' : 'moved',\r\n        sourceProjectName: sourceProject?.name,\r\n        sourceNuggetName: selectedNugget.name,\r\n        timestamp: Date.now(),\r\n      },\r\n      createdAt: Date.now(),\r\n      version: 1,\r\n      lastEditedAt: undefined,\r\n      lastRenamedAt: undefined,\r\n      lastEnabledAt: undefined,\r\n      lastDisabledAt: undefined,\r\n    };\r\n    // Add to target nugget\r\n    updateNugget(targetNuggetId, n => ({\r\n      ...n,\r\n      documents: [...n.documents, docCopy],\r\n      lastModifiedAt: Date.now(),\r\n    }));\r\n    // If move, also remove from source nugget (and delete the original's Files API file)\r\n    if (mode === 'move') {\r\n      if (doc.fileId) deleteFromFilesAPI(doc.fileId);\r\n      removeNuggetDocument(docId);\r\n    }\r\n  }, [selectedNugget, nuggets, projects, updateNugget, removeNuggetDocument]);\r\n\r\n  const handleCreateNuggetWithDoc = useCallback(async (nuggetName: string, docId: string) => {\r\n    if (!selectedNugget) return;\r\n    const doc = selectedNugget.documents.find(d => d.id === docId);\r\n    if (!doc) return;\r\n    // Auto-increment nugget name within the same project\r\n    const sourceProject = projects.find(p => p.nuggetIds.includes(selectedNugget.id));\r\n    const projectNuggetNames = sourceProject\r\n      ? sourceProject.nuggetIds.map(nid => nuggets.find(n => n.id === nid)?.name || '').filter(Boolean)\r\n      : nuggets.map(n => n.name);\r\n    const uniqueNuggetName = getUniqueName(nuggetName, projectNuggetNames);\r\n    const newDocId = `doc-${Math.random().toString(36).substr(2, 9)}`;\r\n    // Upload the copy to Files API so it has its own file_id\r\n    let copyFileId: string | undefined;\r\n    try {\r\n      if (doc.sourceType === 'native-pdf' && doc.pdfBase64) {\r\n        copyFileId = await uploadToFilesAPI(base64ToBlob(doc.pdfBase64, 'application/pdf'), doc.name, 'application/pdf');\r\n      } else if (doc.content) {\r\n        copyFileId = await uploadToFilesAPI(doc.content, doc.name, 'text/plain');\r\n      }\r\n    } catch (err) {\r\n      console.warn('[App] Files API upload for new nugget doc copy failed:', err);\r\n    }\r\n    const docCopy: UploadedFile = {\r\n      ...doc,\r\n      id: newDocId,\r\n      fileId: copyFileId,\r\n      originalName: doc.originalName ?? doc.name,\r\n      sourceOrigin: {\r\n        type: 'copied',\r\n        sourceProjectName: sourceProject?.name,\r\n        sourceNuggetName: selectedNugget.name,\r\n        timestamp: Date.now(),\r\n      },\r\n      createdAt: Date.now(),\r\n      version: 1,\r\n      lastEditedAt: undefined,\r\n      lastRenamedAt: undefined,\r\n      lastEnabledAt: undefined,\r\n      lastDisabledAt: undefined,\r\n    };\r\n    const newNugget: Nugget = {\r\n      id: `nugget-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: uniqueNuggetName,\r\n      type: 'insights',\r\n      documents: [docCopy],\r\n      cards: [],\r\n      messages: [],\r\n      createdAt: Date.now(),\r\n      lastModifiedAt: Date.now(),\r\n    };\r\n    addNugget(newNugget);\r\n    // Add to same project as the source nugget\r\n    if (sourceProject) {\r\n      addNuggetToProject(sourceProject.id, newNugget.id);\r\n    }\r\n  }, [selectedNugget, projects, nuggets, addNugget, addNuggetToProject]);\r\n\r\n  // Helper: show PDF choice dialog and return a Promise that resolves to the user's choice\r\n  const askPdfChoice = useCallback((fileName: string, pdfCount?: number): Promise<'markdown' | 'native-pdf' | 'cancel'> => {\r\n    return new Promise(resolve => {\r\n      pdfChoiceResolverRef.current = resolve;\r\n      setPdfChoiceDialog({ fileName, pdfCount });\r\n    });\r\n  }, []);\r\n\r\n  const handleUploadDocuments = useCallback(async (files: FileList) => {\r\n    const needsSubject = !selectedNugget?.subject;\r\n    const batchDocIds: string[] = [];\r\n    const currentDocNames = [...(selectedNugget?.documents || []).map(d => d.name)];\r\n    const allFiles = Array.from(files);\r\n\r\n    // Separate PDFs and non-PDFs\r\n    const pdfFiles = allFiles.filter(f => f.name.endsWith('.pdf') || f.type === 'application/pdf');\r\n    const mdFiles = allFiles.filter(f => !f.name.endsWith('.pdf') && f.type !== 'application/pdf');\r\n\r\n    // Ask once for all PDFs in the batch\r\n    let pdfChoice: 'markdown' | 'native-pdf' | 'cancel' | null = null;\r\n    if (pdfFiles.length > 0) {\r\n      pdfChoice = await askPdfChoice(pdfFiles[0].name, pdfFiles.length);\r\n    }\r\n\r\n    // Process PDFs (if not cancelled)\r\n    if (pdfChoice && pdfChoice !== 'cancel') {\r\n      for (const file of pdfFiles) {\r\n        const uniqueName = getUniqueName(file.name, currentDocNames, true);\r\n        currentDocNames.push(uniqueName);\r\n\r\n        const placeholder = createPlaceholderDocument(file);\r\n        placeholder.name = uniqueName;\r\n        addNuggetDocument(placeholder);\r\n        if (needsSubject) batchDocIds.push(placeholder.id);\r\n\r\n        if (pdfChoice === 'native-pdf') {\r\n          (async () => {\r\n            try {\r\n              // processNativePdf now handles bookmark-first extraction internally\r\n              const nativePdf = await processNativePdf(file, placeholder.id);\r\n              // Upload PDF to Files API\r\n              let pdfFileId: string | undefined;\r\n              try {\r\n                pdfFileId = await uploadToFilesAPI(\r\n                  base64ToBlob(nativePdf.pdfBase64!, 'application/pdf'),\r\n                  uniqueName, 'application/pdf'\r\n                );\r\n              } catch (err) {\r\n                console.warn('[App] Native PDF Files API upload failed:', err);\r\n              }\r\n              updateNuggetDocument(placeholder.id, {\r\n                ...nativePdf,\r\n                name: uniqueName,\r\n                fileId: pdfFileId,\r\n              });\r\n            } catch (err) {\r\n              console.error('[App] Native PDF processing failed:', err);\r\n              updateNuggetDocument(placeholder.id, { ...placeholder, status: 'error' as const });\r\n              addToast({\r\n                type: 'error',\r\n                message: `Failed to process \"${uniqueName}\"`,\r\n                detail: err instanceof Error ? err.message : 'An unexpected error occurred while processing the PDF.',\r\n                duration: 10000,\r\n              });\r\n            }\r\n          })();\r\n        } else {\r\n          // markdown conversion\r\n          processFileToDocument(file, placeholder.id)\r\n            .then(async processed => {\r\n              let fileId: string | undefined;\r\n              if (processed.content) {\r\n                try {\r\n                  fileId = await uploadToFilesAPI(processed.content, uniqueName, 'text/plain');\r\n                } catch (err) {\r\n                  console.warn('[App] Files API upload failed (will use inline fallback):', err);\r\n                }\r\n              }\r\n              updateNuggetDocument(placeholder.id, { ...processed, name: uniqueName, fileId });\r\n            })\r\n            .catch((err) => {\r\n              updateNuggetDocument(placeholder.id, { ...placeholder, status: 'error' as const });\r\n              addToast({\r\n                type: 'error',\r\n                message: `Failed to convert \"${uniqueName}\" to markdown`,\r\n                detail: err instanceof Error ? err.message : 'The document could not be processed.',\r\n                duration: 10000,\r\n              });\r\n            });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Process markdown files (no dialog needed)\r\n    for (const file of mdFiles) {\r\n      const uniqueName = getUniqueName(file.name, currentDocNames, true);\r\n      currentDocNames.push(uniqueName);\r\n\r\n      const placeholder = createPlaceholderDocument(file);\r\n      placeholder.name = uniqueName;\r\n      addNuggetDocument(placeholder);\r\n      if (needsSubject) batchDocIds.push(placeholder.id);\r\n\r\n      processFileToDocument(file, placeholder.id)\r\n        .then(async processed => {\r\n          let fileId: string | undefined;\r\n          if (processed.content) {\r\n            try {\r\n              fileId = await uploadToFilesAPI(processed.content, uniqueName, 'text/plain');\r\n            } catch (err) {\r\n              console.warn('[App] Files API upload failed (will use inline fallback):', err);\r\n            }\r\n          }\r\n          updateNuggetDocument(placeholder.id, { ...processed, name: uniqueName, fileId });\r\n        })\r\n        .catch((err) => {\r\n          updateNuggetDocument(placeholder.id, { ...placeholder, status: 'error' as const });\r\n          addToast({\r\n            type: 'error',\r\n            message: `Failed to process \"${uniqueName}\"`,\r\n            detail: err instanceof Error ? err.message : 'The document could not be processed.',\r\n            duration: 10000,\r\n          });\r\n        });\r\n    }\r\n\r\n    // Trigger subject auto-generation for first upload batch\r\n    if (needsSubject && batchDocIds.length > 0 && selectedNugget) {\r\n      pendingSubjectGenRef.current = selectedNugget.id;\r\n      subjectGenDocIdsRef.current = new Set(batchDocIds);\r\n    }\r\n  }, [selectedNugget, addNuggetDocument, updateNuggetDocument, askPdfChoice, addToast]);\r\n\r\n  // ── Subject auto-generation watcher ──\r\n  // Watches nuggets state; when all tracked docs reach 'ready', triggers generation\r\n  useEffect(() => {\r\n    const nuggetId = pendingSubjectGenRef.current;\r\n    if (!nuggetId) return;\r\n    const trackedIds = subjectGenDocIdsRef.current;\r\n    if (trackedIds.size === 0) return;\r\n\r\n    const nugget = nuggets.find(n => n.id === nuggetId);\r\n    if (!nugget) { pendingSubjectGenRef.current = null; return; }\r\n\r\n    // Check if all tracked docs have finished processing (ready or error)\r\n    const allDone = [...trackedIds].every(docId => {\r\n      const doc = nugget.documents.find(d => d.id === docId);\r\n      return doc && (doc.status === 'ready' || doc.status === 'error');\r\n    });\r\n    if (!allDone) return;\r\n\r\n    // All done — clear refs and trigger generation\r\n    pendingSubjectGenRef.current = null;\r\n    subjectGenDocIdsRef.current = new Set();\r\n\r\n    // Use ALL ready docs in the nugget (not just the batch) so subject covers the full document set\r\n    const allReadyDocs = nugget.documents.filter(d => d.status === 'ready' && (d.content || d.fileId || d.pdfBase64));\r\n    if (allReadyDocs.length === 0) {\r\n      addToast({ type: 'warning', message: 'Could not generate subject — no documents processed successfully.', duration: 6000 });\r\n      return;\r\n    }\r\n\r\n    (async () => {\r\n      try {\r\n        const subject = await generateSubject(allReadyDocs, recordUsage);\r\n        updateNugget(nuggetId, n => ({ ...n, subject, lastModifiedAt: Date.now() }));\r\n        addToast({\r\n          type: 'info',\r\n          message: `Subject: ${subject}`,\r\n          detail: 'Edit via nugget menu > Subject',\r\n          duration: 8000,\r\n        });\r\n      } catch (err) {\r\n        console.warn('[App] Subject auto-generation failed:', err);\r\n        addToast({\r\n          type: 'warning',\r\n          message: 'Could not auto-generate subject',\r\n          detail: 'You can set it manually via the nugget menu > Subject.',\r\n          duration: 8000,\r\n        });\r\n      }\r\n    })();\r\n  }, [nuggets, updateNugget, recordUsage, addToast]);\r\n\r\n  // ── Subject modal handlers ──\r\n  const handleSaveSubject = useCallback((nuggetId: string, subject: string) => {\r\n    updateNugget(nuggetId, n => ({ ...n, subject, lastModifiedAt: Date.now() }));\r\n  }, [updateNugget]);\r\n\r\n  const handleRegenerateSubject = useCallback(async (nuggetId: string) => {\r\n    const nugget = nuggets.find(n => n.id === nuggetId);\r\n    if (!nugget) return;\r\n    const readyDocs = nugget.documents.filter(d => d.status === 'ready' && (d.content || d.fileId || d.pdfBase64));\r\n    if (readyDocs.length === 0) {\r\n      addToast({ type: 'warning', message: 'No processed documents available to generate subject from.', duration: 6000 });\r\n      return;\r\n    }\r\n    setIsRegeneratingSubject(true);\r\n    try {\r\n      const subject = await generateSubject(readyDocs, recordUsage);\r\n      updateNugget(nuggetId, n => ({ ...n, subject, lastModifiedAt: Date.now() }));\r\n      addToast({ type: 'success', message: 'Subject regenerated successfully.', duration: 4000 });\r\n    } catch (err) {\r\n      console.warn('[App] Subject regeneration failed:', err);\r\n      addToast({ type: 'error', message: 'Failed to regenerate subject.', detail: err instanceof Error ? err.message : 'Unknown error', duration: 8000 });\r\n    } finally {\r\n      setIsRegeneratingSubject(false);\r\n    }\r\n  }, [nuggets, updateNugget, recordUsage, addToast]);\r\n\r\n  // ── Card copy/move handler (passed to CardsPanel) ──\r\n  const handleCopyMoveCard = useCallback((cardId: string, targetNuggetId: string, mode: 'copy' | 'move') => {\r\n    if (!selectedNugget) return;\r\n    const card = selectedNugget.cards.find(c => c.id === cardId);\r\n    if (!card) return;\r\n    const targetNugget = nuggets.find(n => n.id === targetNuggetId);\r\n    const targetCardNames = targetNugget ? targetNugget.cards.map(c => c.text) : [];\r\n    const uniqueName = getUniqueName(card.text, targetCardNames);\r\n    const now = Date.now();\r\n    const newCardId = `card-${Math.random().toString(36).substr(2, 9)}`;\r\n    const copiedCard: Card = {\r\n      ...card,\r\n      id: newCardId,\r\n      text: uniqueName,\r\n      selected: false,\r\n      createdAt: now,\r\n      lastEditedAt: now,\r\n    };\r\n    // Add to target nugget\r\n    updateNugget(targetNuggetId, n => ({\r\n      ...n,\r\n      cards: [...n.cards, copiedCard],\r\n      lastModifiedAt: now,\r\n    }));\r\n    // If move, also remove from source nugget\r\n    if (mode === 'move') {\r\n      const remaining = selectedNugget.cards.filter(c => c.id !== cardId);\r\n      updateNugget(selectedNugget.id, n => ({\r\n        ...n,\r\n        cards: n.cards.filter(c => c.id !== cardId),\r\n        lastModifiedAt: now,\r\n      }));\r\n      // Fall back to first remaining card\r\n      if (activeCardId === cardId) {\r\n        setActiveCardId(remaining.length > 0 ? remaining[0].id : null);\r\n      }\r\n    }\r\n  }, [selectedNugget, nuggets, updateNugget, activeCardId, setActiveCardId]);\r\n\r\n  // ── Create nugget for card handler (passed to CardsPanel) ──\r\n  const handleCreateNuggetForCard = useCallback((nuggetName: string, cardId: string | null) => {\r\n    if (!selectedNugget || !cardId) return;\r\n    const card = selectedNugget.cards.find(c => c.id === cardId);\r\n    if (!card) return;\r\n    const sourceProject = projects.find(p => p.nuggetIds.includes(selectedNugget.id));\r\n    const projectNuggetNames = sourceProject\r\n      ? sourceProject.nuggetIds.map(nid => nuggets.find(n => n.id === nid)?.name || '').filter(Boolean)\r\n      : nuggets.map(n => n.name);\r\n    const uniqueNuggetName = getUniqueName(nuggetName, projectNuggetNames);\r\n    const now = Date.now();\r\n    const newCardId = `card-${Math.random().toString(36).substr(2, 9)}`;\r\n    const copiedCard: Card = {\r\n      ...card,\r\n      id: newCardId,\r\n      selected: false,\r\n      createdAt: now,\r\n      lastEditedAt: now,\r\n    };\r\n    const newNugget: Nugget = {\r\n      id: `nugget-${Math.random().toString(36).substr(2, 9)}`,\r\n      name: uniqueNuggetName,\r\n      type: 'insights',\r\n      documents: [],\r\n      cards: [copiedCard],\r\n      messages: [],\r\n      createdAt: now,\r\n      lastModifiedAt: now,\r\n    };\r\n    addNugget(newNugget);\r\n    if (sourceProject) {\r\n      addNuggetToProject(sourceProject.id, newNugget.id);\r\n    }\r\n  }, [selectedNugget, projects, nuggets, addNugget, addNuggetToProject]);\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-white\">\r\n      {showLanding ? (\r\n        <LandingPage onLaunch={handleLaunch} />\r\n      ) : (\r\n      <>\r\n      {/* Nugget modals */}\r\n      {showNuggetCreation && (\r\n        <NuggetCreationModal\r\n          nuggets={nuggets}\r\n          onCreateNugget={handleCreateNugget}\r\n          onClose={() => setShowNuggetCreation(false)}\r\n        />\r\n      )}\r\n\r\n      {showProjectCreation && (\r\n        <ProjectCreationModal\r\n          projects={projects}\r\n          onCreateProject={(name, desc) => {\r\n            const projectId = handleCreateProject(name, desc);\r\n            if (projectCreationChainToNugget) {\r\n              setNuggetCreationProjectId(projectId);\r\n              setShowProjectCreation(false);\r\n              setShowNuggetCreation(true);\r\n              setProjectCreationChainToNugget(false);\r\n            }\r\n          }}\r\n          onClose={() => { setShowProjectCreation(false); setProjectCreationChainToNugget(false); }}\r\n        />\r\n      )}\r\n\r\n      {/* PDF upload choice dialog */}\r\n      {pdfChoiceDialog && (\r\n        <PdfUploadChoiceDialog\r\n          fileName={pdfChoiceDialog.fileName}\r\n          pdfCount={pdfChoiceDialog.pdfCount}\r\n          onConvertToMarkdown={() => {\r\n            pdfChoiceResolverRef.current?.('markdown');\r\n            pdfChoiceResolverRef.current = null;\r\n            setPdfChoiceDialog(null);\r\n          }}\r\n          onKeepAsPdf={() => {\r\n            pdfChoiceResolverRef.current?.('native-pdf');\r\n            pdfChoiceResolverRef.current = null;\r\n            setPdfChoiceDialog(null);\r\n          }}\r\n          onCancel={() => {\r\n            pdfChoiceResolverRef.current?.('cancel');\r\n            pdfChoiceResolverRef.current = null;\r\n            setPdfChoiceDialog(null);\r\n          }}\r\n        />\r\n      )}\r\n\r\n      {/* Style Studio modal */}\r\n      {showStyleStudio && (\r\n        <StyleStudioModal\r\n          customStyles={customStyles}\r\n          onSave={replaceCustomStyles}\r\n          onClose={() => setShowStyleStudio(false)}\r\n        />\r\n      )}\r\n\r\n      {/* Subject edit modal */}\r\n      {subjectEditNuggetId && (() => {\r\n        const nugget = nuggets.find(n => n.id === subjectEditNuggetId);\r\n        if (!nugget) return null;\r\n        return (\r\n          <SubjectEditModal\r\n            nuggetId={nugget.id}\r\n            nuggetName={nugget.name}\r\n            currentSubject={nugget.subject || ''}\r\n            isRegenerating={isRegeneratingSubject}\r\n            onSave={handleSaveSubject}\r\n            onRegenerate={handleRegenerateSubject}\r\n            onClose={() => setSubjectEditNuggetId(null)}\r\n          />\r\n        );\r\n      })()}\r\n\r\n      {/* App-level unsaved changes dialog (for nugget/panel switching) */}\r\n      {appPendingAction && appPendingDirtyPanel && (\r\n        <UnsavedChangesDialog\r\n          title={`Unsaved changes in ${appPendingDirtyPanel === 'cards' ? 'Cards' : 'Sources'} editor`}\r\n          description=\"You have unsaved edits. Save or discard them to continue.\"\r\n          onSave={handleAppDialogSave}\r\n          onDiscard={handleAppDialogDiscard}\r\n          onCancel={handleAppDialogCancel}\r\n        />\r\n      )}\r\n\r\n      {/* Zoom Overlay */}\r\n      {zoomState.imageUrl && <ZoomOverlay zoomState={zoomState} onClose={closeZoom} />}\r\n\r\n      <div className=\"flex flex-col h-screen overflow-hidden\" style={{ background: darkMode ? '#18181b' : 'linear-gradient(180deg, #f0f4f8 0%, #e8edf2 40%, #f5f7fa 100%)' }}>\r\n\r\n        {/* Header bar — always visible */}\r\n        {(() => {\r\n          const parentProject = selectedNugget ? projects.find(p => p.nuggetIds.includes(selectedNugget.id)) : null;\r\n          return (\r\n            <div className=\"shrink-0 h-9 flex items-center justify-between px-5 border-b border-zinc-100 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-[0_1px_3px_rgba(0,0,0,0.04)] dark:shadow-none relative z-[110]\">\r\n              {/* Left spacer — matches right-side width for centering */}\r\n              <div className=\"w-48 shrink-0\" />\r\n\r\n              {/* Center: interactive breadcrumb navigation */}\r\n              {selectedNugget ? (\r\n                <div ref={breadcrumbRef} data-breadcrumb-dropdown className=\"flex items-center gap-0 min-w-0 text-[15px] text-zinc-900 dark:text-zinc-100\">\r\n                  {/* ── Project segment ── */}\r\n                  {parentProject && (\r\n                    <>\r\n                      <span className=\"font-light italic text-[13px] text-zinc-400 select-none\">project</span>\r\n                      <span className=\"mx-2.5\" />\r\n                      <div className=\"relative\">\r\n                        <button\r\n                          onClick={() => setBreadcrumbDropdown(prev => prev === 'project' ? null : 'project')}\r\n                          className=\"font-semibold not-italic truncate max-w-[200px] px-2.5 py-1 -my-1 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors inline-flex items-center gap-1.5\"\r\n                          title={parentProject.name}\r\n                        >\r\n                          {parentProject.name}\r\n                          <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"ml-0.5 opacity-40 shrink-0\"><polyline points=\"6 9 12 15 18 9\" /></svg>\r\n                        </button>\r\n                        {breadcrumbDropdown === 'project' && (\r\n                          <div className=\"absolute top-full left-0 mt-1 min-w-[180px] max-h-64 overflow-y-auto bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 z-[120] py-1 text-[12px]\">\r\n                            {projects.map(proj => (\r\n                              <button\r\n                                key={proj.id}\r\n                                onClick={() => handleBreadcrumbProjectSelect(proj.id)}\r\n                                disabled={proj.nuggetIds.length === 0}\r\n                                className={`w-full text-left px-3 py-1.5 truncate transition-colors ${proj.id === parentProject.id ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'} ${proj.nuggetIds.length === 0 ? 'opacity-40 cursor-default' : ''}`}\r\n                              >\r\n                                {proj.name}\r\n                                {proj.nuggetIds.length === 0 && <span className=\"text-zinc-400 text-[10px] ml-1\">(empty)</span>}\r\n                              </button>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <span className=\"mx-5 text-zinc-200 dark:text-zinc-600 font-light select-none\">|</span>\r\n                    </>\r\n                  )}\r\n\r\n                  {/* ── Nugget segment ── */}\r\n                  <span className=\"font-light italic text-[13px] text-zinc-400 select-none\">nugget</span>\r\n                  <span className=\"mx-2.5\" />\r\n                  <div className=\"relative\">\r\n                    <button\r\n                      onClick={() => setBreadcrumbDropdown(prev => prev === 'nugget' ? null : 'nugget')}\r\n                      className=\"font-semibold not-italic truncate max-w-[200px] px-2.5 py-1 -my-1 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors inline-flex items-center gap-1.5\"\r\n                      title={selectedNugget.name}\r\n                    >\r\n                      {selectedNugget.name}\r\n                      <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"ml-0.5 opacity-40 shrink-0\"><polyline points=\"6 9 12 15 18 9\" /></svg>\r\n                    </button>\r\n                    {breadcrumbDropdown === 'nugget' && (\r\n                      <div className=\"absolute top-full left-0 mt-1 min-w-[180px] max-h-64 overflow-y-auto bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 z-[120] py-1 text-[12px]\">\r\n                        {/* Nuggets in current project */}\r\n                        {nuggetDropdownItems.parent && nuggetDropdownItems.inProject.length > 0 && (\r\n                          <>\r\n                            <div className=\"px-3 py-1 text-[10px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider font-medium\">{nuggetDropdownItems.parent.name}</div>\r\n                            {nuggetDropdownItems.inProject.map(n => (\r\n                              <button\r\n                                key={n.id}\r\n                                onClick={() => handleBreadcrumbNuggetSelect(n.id)}\r\n                                className={`w-full text-left px-3 py-1.5 truncate transition-colors ${n.id === selectedNuggetId ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\r\n                              >\r\n                                {n.name}\r\n                              </button>\r\n                            ))}\r\n                          </>\r\n                        )}\r\n                        {/* Ungrouped nuggets */}\r\n                        {nuggetDropdownItems.ungrouped.length > 0 && (\r\n                          <>\r\n                            {nuggetDropdownItems.parent && nuggetDropdownItems.inProject.length > 0 && (\r\n                              <div className=\"border-t border-zinc-100 dark:border-zinc-700 my-1\" />\r\n                            )}\r\n                            <div className=\"px-3 py-1 text-[10px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider font-medium\">Ungrouped</div>\r\n                            {nuggetDropdownItems.ungrouped.map(n => (\r\n                              <button\r\n                                key={n.id}\r\n                                onClick={() => handleBreadcrumbNuggetSelect(n.id)}\r\n                                className={`w-full text-left px-3 py-1.5 truncate transition-colors ${n.id === selectedNuggetId ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\r\n                              >\r\n                                {n.name}\r\n                              </button>\r\n                            ))}\r\n                          </>\r\n                        )}\r\n                        {/* Other projects' nuggets */}\r\n                        {projects.filter(p => p.id !== nuggetDropdownItems.parent?.id && p.nuggetIds.length > 0).map(proj => (\r\n                          <React.Fragment key={proj.id}>\r\n                            <div className=\"border-t border-zinc-100 dark:border-zinc-700 my-1\" />\r\n                            <div className=\"px-3 py-1 text-[10px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider font-medium\">{proj.name}</div>\r\n                            {proj.nuggetIds.map(nid => {\r\n                              const n = nuggets.find(ng => ng.id === nid);\r\n                              if (!n) return null;\r\n                              return (\r\n                                <button\r\n                                  key={n.id}\r\n                                  onClick={() => handleBreadcrumbNuggetSelect(n.id)}\r\n                                  className={`w-full text-left px-3 py-1.5 truncate transition-colors ${n.id === selectedNuggetId ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\r\n                                >\r\n                                  {n.name}\r\n                                </button>\r\n                              );\r\n                            })}\r\n                          </React.Fragment>\r\n                        ))}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* ── Document segment ── */}\r\n                  {activeDocForBreadcrumb && (\r\n                    <>\r\n                      <span className=\"mx-5 text-zinc-200 dark:text-zinc-600 font-light select-none\">|</span>\r\n                      <span className=\"font-light italic text-[13px] text-zinc-400 select-none\">doc</span>\r\n                      <span className=\"mx-2.5\" />\r\n                      <div className=\"relative\">\r\n                        <button\r\n                          onClick={() => setBreadcrumbDropdown(prev => prev === 'document' ? null : 'document')}\r\n                          className=\"font-semibold not-italic truncate max-w-[200px] px-2.5 py-1 -my-1 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors inline-flex items-center gap-1.5\"\r\n                          title={activeDocForBreadcrumb.name}\r\n                        >\r\n                          {activeDocForBreadcrumb.name}\r\n                          <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"ml-0.5 opacity-40 shrink-0\"><polyline points=\"6 9 12 15 18 9\" /></svg>\r\n                        </button>\r\n                        {breadcrumbDropdown === 'document' && (\r\n                          <div className=\"absolute top-full left-0 mt-1 min-w-[180px] max-h-64 overflow-y-auto bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 z-[120] py-1 text-[12px]\">\r\n                            {nuggetDocs.map(doc => (\r\n                              <button\r\n                                key={doc.id}\r\n                                onClick={() => handleBreadcrumbDocSelect(doc.id)}\r\n                                className={`w-full text-left px-3 py-1.5 truncate transition-colors flex items-center gap-2 ${doc.id === activeDocForBreadcrumb.id ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\r\n                              >\r\n                                <span className=\"truncate\">{doc.name}</span>\r\n                                <span className=\"text-[10px] text-zinc-400 dark:text-zinc-500 shrink-0 uppercase\">\r\n                                  {doc.sourceType === 'native-pdf' ? 'pdf' : 'md'}\r\n                                </span>\r\n                              </button>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </div>\r\n              ) : (\r\n                <div className=\"text-[15px] tracking-tight text-zinc-900 dark:text-zinc-100\">\r\n                  <span className=\"font-light italic\">info</span><span className=\"font-semibold not-italic\">nugget</span>\r\n                </div>\r\n              )}\r\n\r\n              {/* Right: dark mode toggle + token/cost counter */}\r\n              <div className=\"w-48 shrink-0 flex items-center justify-end gap-1 relative\" ref={usageDropdownRef}>\r\n                <button\r\n                  onClick={toggleDarkMode}\r\n                  className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 hover:text-zinc-600 dark:text-zinc-500 dark:hover:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\r\n                  title={darkMode ? 'Switch to light mode' : 'Switch to dark mode'}\r\n                >\r\n                  {darkMode ? (\r\n                    <svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"5\"/><line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\"/><line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\"/><line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\"/><line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\"/><line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\"/><line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\"/><line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\"/><line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\"/></svg>\r\n                  ) : (\r\n                    <svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\"/></svg>\r\n                  )}\r\n                </button>\r\n                <button\r\n                  onClick={() => setShowUsageDropdown(prev => !prev)}\r\n                  className={`text-[10px] transition-colors font-mono tracking-tight px-2 py-0.5 rounded hover:bg-zinc-50 dark:hover:bg-zinc-700 ${usageTotals.callCount > 0 ? 'text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300' : 'text-zinc-300 dark:text-zinc-600 hover:text-zinc-400 dark:hover:text-zinc-500'}`}\r\n                >\r\n                  {formatCost(usageTotals.totalCost)} · {formatTokens(usageTotals.totalInputTokens + usageTotals.totalOutputTokens)} tokens\r\n                </button>\r\n\r\n                {showUsageDropdown && (\r\n                  <div className=\"absolute top-full right-0 mt-1 w-64 bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 z-50 py-2 px-3 text-[11px] text-zinc-600 dark:text-zinc-300\">\r\n                    {/* Claude row */}\r\n                    <div className=\"flex justify-between items-center py-1 border-b border-zinc-50 dark:border-zinc-700\">\r\n                      <span className=\"font-medium text-zinc-700 dark:text-zinc-300\">Claude</span>\r\n                      <span className=\"font-mono\">{formatCost(usageTotals.claudeCost)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between items-center py-0.5 text-[10px] text-zinc-400 dark:text-zinc-500 pl-2\">\r\n                      <span>In: {formatTokens(usageTotals.claudeInputTokens)} · Out: {formatTokens(usageTotals.claudeOutputTokens)}</span>\r\n                    </div>\r\n\r\n                    {/* Gemini row */}\r\n                    <div className=\"flex justify-between items-center py-1 border-b border-zinc-50 dark:border-zinc-700 mt-1\">\r\n                      <span className=\"font-medium text-zinc-700 dark:text-zinc-300\">Gemini</span>\r\n                      <span className=\"font-mono\">{formatCost(usageTotals.geminiCost)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between items-center py-0.5 text-[10px] text-zinc-400 dark:text-zinc-500 pl-2\">\r\n                      <span>In: {formatTokens(usageTotals.geminiInputTokens)} · Out: {formatTokens(usageTotals.geminiOutputTokens)}</span>\r\n                    </div>\r\n\r\n                    {/* Cache savings */}\r\n                    {usageTotals.totalCacheReadTokens > 0 && (\r\n                      <div className=\"flex justify-between items-center py-0.5 text-[10px] text-zinc-400 dark:text-zinc-500 mt-1 border-t border-zinc-100 dark:border-zinc-700 pt-1\">\r\n                        <span>Cache reads</span>\r\n                        <span className=\"font-mono\">{formatTokens(usageTotals.totalCacheReadTokens)}</span>\r\n                      </div>\r\n                    )}\r\n\r\n                    {/* Total */}\r\n                    <div className=\"flex justify-between items-center py-1 mt-1 border-t border-zinc-100 dark:border-zinc-700 font-medium text-zinc-700 dark:text-zinc-300\">\r\n                      <span>Total ({usageTotals.callCount} calls)</span>\r\n                      <span className=\"font-mono\">{formatCost(usageTotals.totalCost)}</span>\r\n                    </div>\r\n\r\n                    {/* Reset button */}\r\n                    <button\r\n                      onClick={() => { resetUsage(); setShowUsageDropdown(false); }}\r\n                      className=\"w-full mt-1.5 text-[10px] text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300 hover:bg-zinc-50 dark:hover:bg-zinc-700 rounded py-1 transition-colors\"\r\n                    >\r\n                      Reset counters\r\n                    </button>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          );\r\n        })()}\r\n\r\n        {/* 6-panel row: Projects | Sources | Chat | Auto-Deck | Cards | Assets */}\r\n        <div className=\"flex flex-1 overflow-hidden gap-[4px] p-[4px]\">\r\n          {/* Panel 1: Projects */}\r\n          <ProjectsPanel\r\n            isOpen={expandedPanel === 'projects'}\r\n            onToggle={() => appGatedAction(() => setExpandedPanel(prev => prev === 'projects' ? null : 'projects'))}\r\n            nuggets={nuggets}\r\n            projects={projects}\r\n            selectedNuggetId={selectedNuggetId}\r\n            selectedProjectId={selectedProjectId}\r\n            selectionLevel={selectionLevel}\r\n            onSelectProject={(projectId) => appGatedAction(() => {\r\n              setReferenceImage(null);\r\n              setUseReferenceImage(false);\r\n              selectEntity({ projectId });\r\n            })}\r\n            onSelectNugget={(id) => appGatedAction(() => {\r\n              setReferenceImage(null);\r\n              setUseReferenceImage(false);\r\n              selectEntity({ nuggetId: id });\r\n            })}\r\n            onCreateProject={() => { setProjectCreationChainToNugget(true); setShowProjectCreation(true); }}\r\n            onRenameProject={(id, newName) => {\r\n              updateProject(id, p => ({ ...p, name: newName, lastModifiedAt: Date.now() }));\r\n            }}\r\n            onDeleteProject={(id) => deleteProject(id)}\r\n            onToggleProjectCollapse={(id) => {\r\n              updateProject(id, p => ({ ...p, isCollapsed: !p.isCollapsed }));\r\n            }}\r\n            onCreateNuggetInProject={(projectId) => {\r\n              setNuggetCreationProjectId(projectId);\r\n              setShowNuggetCreation(true);\r\n            }}\r\n            onRenameNugget={(id, newName) => {\r\n              updateNugget(id, n => ({ ...n, name: newName, lastModifiedAt: Date.now() }));\r\n            }}\r\n            onDeleteNugget={(id) => deleteNugget(id)}\r\n            onCopyNuggetToProject={handleCopyNuggetToProject}\r\n            onMoveNuggetToProject={handleMoveNuggetToProject}\r\n            onCreateProjectForNugget={handleCreateProjectForNugget}\r\n            onDuplicateProject={handleDuplicateProject}\r\n            onRenameDocument={async (docId, newName) => {\r\n              // Re-upload to Files API with the new filename\r\n              const doc = selectedNugget?.documents.find(d => d.id === docId);\r\n              if (doc?.fileId) {\r\n                try {\r\n                  deleteFromFilesAPI(doc.fileId);\r\n                  // Native PDFs: re-upload binary; Markdown docs: re-upload text content\r\n                  const newFileId = doc.sourceType === 'native-pdf' && doc.pdfBase64\r\n                    ? await uploadToFilesAPI(base64ToBlob(doc.pdfBase64, 'application/pdf'), newName, 'application/pdf')\r\n                    : doc.content\r\n                      ? await uploadToFilesAPI(doc.content, newName, 'text/plain')\r\n                      : undefined;\r\n                  if (newFileId) updateNuggetDocument(docId, { ...doc, name: newName, fileId: newFileId, lastRenamedAt: Date.now(), version: (doc.version ?? 1) + 1 });\r\n                } catch (err) {\r\n                  console.warn('[App] Files API re-upload on rename failed:', err);\r\n                }\r\n              }\r\n              renameNuggetDocument(docId, newName);\r\n            }}\r\n            onRemoveDocument={(docId) => {\r\n              const doc = selectedNugget?.documents.find(d => d.id === docId);\r\n              if (doc?.fileId) deleteFromFilesAPI(doc.fileId);\r\n              removeNuggetDocument(docId);\r\n            }}\r\n            onCopyMoveDocument={handleCopyMoveDocument}\r\n            onCreateNuggetWithDoc={handleCreateNuggetWithDoc}\r\n            onUploadDocuments={handleUploadDocuments}\r\n            onEditSubject={(nuggetId) => setSubjectEditNuggetId(nuggetId)}\r\n            onOpenDocument={(docId) => {\r\n              selectEntity({ documentId: docId });\r\n            }}\r\n            onOpenCardsPanel={() => appGatedAction(() => setExpandedPanel(null))}\r\n            onOpenSourcesPanel={() => appGatedAction(() => setExpandedPanel('sources'))}\r\n            otherNuggets={otherNuggetsList}\r\n            projectNuggets={projectNuggetsList}\r\n            selectedDocId={selectedDocumentId}\r\n            onSelectDoc={(docId) => selectEntity({ documentId: docId })}\r\n          />\r\n\r\n          {selectedNugget && insightsSession ? (\r\n            <>\r\n              {/* Hard lock overlay — blocks all UI while TOC has unsaved changes (SourcesPanel at z-[107] stays above) */}\r\n              {tocLockActive && expandedPanel === 'sources' && (\r\n                <div className=\"fixed inset-0 z-[106] bg-black/20 cursor-not-allowed\" />\r\n              )}\r\n\r\n              {/* Panel 2: Sources */}\r\n              <SourcesPanel\r\n                ref={sourcesPanelRef}\r\n                isOpen={expandedPanel === 'sources'}\r\n                onToggle={() => appGatedAction(() => setExpandedPanel(prev => prev === 'sources' ? null : 'sources'))}\r\n                documents={nuggetDocs}\r\n                onSaveDocument={handleSaveDocument}\r\n                onGenerateCardContent={handleGenerateCardContent}\r\n                generatingSourceIds={generatingSourceIds}\r\n                requestedDocId={selectedDocumentId}\r\n                onDocTabChange={(docId) => setSelectedDocumentId(docId)}\r\n                onUpdateDocumentStructure={(docId, newStructure) => {\r\n                  const doc = nuggetDocs.find(d => d.id === docId);\r\n                  if (doc) updateNuggetDocument(docId, { ...doc, structure: newStructure });\r\n                }}\r\n                onSaveToc={handleSaveToc}\r\n                onSaveBookmarks={(docId, newBookmarks) => {\r\n                  if (!selectedNugget) return;\r\n                  const doc = selectedNugget.documents.find(d => d.id === docId);\r\n                  if (!doc) return;\r\n                  const newStructure = flattenBookmarks(newBookmarks);\r\n                  handleSaveToc(docId, newStructure);\r\n                  // Also update bookmarks directly on the document\r\n                  updateNuggetDocument(docId, {\r\n                    ...doc,\r\n                    bookmarks: newBookmarks,\r\n                    structure: newStructure,\r\n                    bookmarkSource: 'manual',\r\n                  });\r\n                }}\r\n                onRegenerateBookmarks={async (docId) => {\r\n                  if (!selectedNugget) return;\r\n                  const doc = selectedNugget.documents.find(d => d.id === docId);\r\n                  if (!doc || !doc.pdfBase64) return;\r\n                  // Re-extract via Gemini from the PDF file\r\n                  const blob = base64ToBlob(doc.pdfBase64, 'application/pdf');\r\n                  const file = new File([blob], doc.name, { type: 'application/pdf' });\r\n                  const headings = await extractHeadingsWithGemini(file);\r\n                  if (headings.length > 0) {\r\n                    const bookmarks = headingsToBookmarks(headings);\r\n                    updateNuggetDocument(docId, {\r\n                      ...doc,\r\n                      bookmarks,\r\n                      bookmarkSource: 'ai_generated',\r\n                      structure: headings,\r\n                    });\r\n                    addToast({ type: 'info', message: `Regenerated ${headings.length} bookmarks via AI`, duration: 5000 });\r\n                  } else {\r\n                    addToast({ type: 'warning', message: 'AI extraction returned no bookmarks', duration: 5000 });\r\n                  }\r\n                }}\r\n                onDirtyChange={setTocLockActive}\r\n              />\r\n\r\n              {/* Panel 3: Chat */}\r\n              <ChatPanel\r\n                isOpen={expandedPanel === 'chat'}\r\n                onToggle={() => appGatedAction(() => setExpandedPanel(prev => prev === 'chat' ? null : 'chat'))}\r\n                messages={insightsMessages}\r\n                isLoading={insightsLabLoading}\r\n                onSendMessage={sendInsightsMessage}\r\n                onSaveAsCard={handleSaveAsCard}\r\n                onClearChat={() => {\r\n                  clearInsightsMessages();\r\n                  // Also propagate to old state for backward compat\r\n                  setInsightsSession(prev => prev ? { ...prev, messages: [] } : prev);\r\n                }}\r\n                onStop={stopInsightsResponse}\r\n                documents={nuggetDocs}\r\n                onToggleDocument={(docId) => toggleNuggetDocument(docId)}\r\n                pendingDocChanges={pendingDocChanges}\r\n                hasConversation={insightsHasConversation}\r\n                onDocChangeContinue={handleDocChangeContinue}\r\n                onDocChangeStartFresh={handleDocChangeStartFresh}\r\n              />\r\n\r\n              {/* Panel 4: Auto-Deck */}\r\n              <AutoDeckPanel\r\n                isOpen={expandedPanel === 'auto-deck'}\r\n                onToggle={() => appGatedAction(() => setExpandedPanel(prev => prev === 'auto-deck' ? null : 'auto-deck'))}\r\n                documents={nuggetDocs}\r\n                session={autoDeckSession}\r\n                onStartPlanning={autoDeckStartPlanning}\r\n                onRevisePlan={autoDeckRevisePlan}\r\n                onApprovePlan={autoDeckApprovePlan}\r\n                onAbort={autoDeckAbort}\r\n                onReset={autoDeckReset}\r\n                onToggleCardIncluded={autoDeckToggleCardIncluded}\r\n                onSetQuestionAnswer={autoDeckSetQuestionAnswer}\r\n                onSetAllRecommended={autoDeckSetAllRecommended}\r\n                onSetGeneralComment={autoDeckSetGeneralComment}\r\n                onRetryFromReview={autoDeckRetryFromReview}\r\n              />\r\n\r\n              {/* Panel 5: Cards */}\r\n              <CardsPanel\r\n                ref={cardsPanelRef}\r\n                cards={insightsSession?.cards || []}\r\n                activeCardId={activeCardId}\r\n                hasSelectedNugget={!!selectedNugget}\r\n                onCardClick={setActiveCardId}\r\n                onCardDoubleClick={(id) => {\r\n                  setActiveCardId(id);\r\n                }}\r\n                onToggleSelection={toggleInsightsCardSelection}\r\n                onSelectExclusive={selectInsightsCardExclusive}\r\n                onSelectRange={selectInsightsCardRange}\r\n                onSelectAll={toggleSelectAllInsightsCards}\r\n                onDeselectAll={deselectAllInsightsCards}\r\n                onDeleteCard={deleteInsightsCard}\r\n                onDeleteSelectedCards={deleteSelectedInsightsCards}\r\n                onRenameCard={renameInsightsCard}\r\n                onCopyMoveCard={handleCopyMoveCard}\r\n                otherNuggets={otherNuggetsList}\r\n                projectNuggets={projectNuggetsList}\r\n                onCreateNuggetForCard={handleCreateNuggetForCard}\r\n                onCreateCustomCard={handleCreateCustomCard}\r\n                onSaveCardContent={handleSaveCardContent}\r\n                detailLevel={activeLogicTab}\r\n                onGenerateCardImage={wrappedGenerateCard}\r\n                onReorderCards={reorderInsightsCards}\r\n              />\r\n\r\n              {/* Panel 5: Assets */}\r\n              <AssetsPanel\r\n                activeCard={activeCard}\r\n                committedSettings={committedSettings}\r\n                menuDraftOptions={menuDraftOptions}\r\n                setMenuDraftOptions={setMenuDraftOptions}\r\n                activeLogicTab={activeLogicTab}\r\n                setActiveLogicTab={setActiveLogicTab}\r\n                genStatus={genStatus}\r\n                onGenerateCard={wrappedGenerateCard}\r\n                onGenerateAll={() => {\r\n                  const cards = selectedNugget?.cards || [];\r\n                  const selected = cards.filter(c => c.selected);\r\n                  if (selected.length === 0) { alert('Please select cards first.'); return; }\r\n                  setManifestCards(selected);\r\n                }}\r\n                selectedCount={insightsSelectedCount}\r\n                onZoomImage={openZoom}\r\n                onImageModified={handleInsightsImageModified}\r\n                contentDirty={false}\r\n                currentContent={activeCard?.synthesisMap?.[activeCard?.detailLevel || activeLogicTab] || ''}\r\n                onDownloadImage={handleDownloadImage}\r\n                onDownloadAllImages={handleDownloadAllImages}\r\n                referenceImage={referenceImage}\r\n                onStampReference={handleStampReference}\r\n                useReferenceImage={useReferenceImage}\r\n                onToggleUseReference={() => setUseReferenceImage(prev => !prev)}\r\n                onReferenceImageModified={handleReferenceImageModified}\r\n                onDeleteReference={handleDeleteReference}\r\n                mismatchDialog={mismatchDialog}\r\n                onDismissMismatch={() => setMismatchDialog(null)}\r\n                manifestCards={manifestCards}\r\n                onExecuteBatch={wrappedExecuteBatch}\r\n                onCloseManifest={() => setManifestCards(null)}\r\n                onDeleteCardImage={handleDeleteCardImage}\r\n                onDeleteCardVersions={handleDeleteCardVersions}\r\n                onDeleteAllCardImages={handleDeleteAllCardImages}\r\n                onUsage={recordUsage}\r\n                onOpenStyleStudio={() => setShowStyleStudio(true)}\r\n              />\r\n            </>\r\n          ) : (\r\n            <div\r\n              className=\"flex-1 flex flex-col items-center justify-center text-center px-8 transition-colors duration-200\"\r\n              onDragOver={(e) => { e.preventDefault(); setEmptyDragging(true); }}\r\n              onDragLeave={() => setEmptyDragging(false)}\r\n              onDrop={(e) => {\r\n                e.preventDefault();\r\n                setEmptyDragging(false);\r\n              }}\r\n              style={emptyDragging ? { backgroundColor: 'rgba(42, 159, 212, 0.04)' } : undefined}\r\n            >\r\n              <div className={`w-12 h-12 bg-accent-blue rounded-full flex items-center justify-center shadow-lg shadow-[rgba(42,159,212,0.2)] mb-5 transition-transform duration-300 ${emptyDragging ? 'scale-110' : ''}`}>\r\n                <div className=\"w-4 h-4 bg-white rounded-sm rotate-45\" />\r\n              </div>\r\n              <h2 className=\"text-xl tracking-tight mb-1\">\r\n                <span className=\"font-light italic\">info</span><span className=\"font-semibold not-italic\">nugget</span>\r\n              </h2>\r\n              {emptyDragging ? (\r\n                <p className=\"text-zinc-400 text-sm font-light mb-6 max-w-xs\">Drop to upload</p>\r\n              ) : (\r\n                <>\r\n                  <div className=\"mb-4\">\r\n                    <PanelRequirements level=\"sources\" />\r\n                  </div>\r\n                  {nuggets.length === 0 ? (\r\n                    <button\r\n                      onClick={() => { setProjectCreationChainToNugget(true); setShowProjectCreation(true); }}\r\n                      className=\"px-5 py-2.5 rounded-xl bg-black text-white text-sm font-medium hover:shadow-lg hover:scale-105 active:scale-95 transition-all duration-200\"\r\n                    >\r\n                      Create Project\r\n                    </button>\r\n                  ) : (\r\n                    <button\r\n                      onClick={() => setShowNuggetCreation(true)}\r\n                      className=\"px-5 py-2.5 rounded-xl bg-black text-white text-sm font-medium hover:shadow-lg hover:scale-105 active:scale-95 transition-all duration-200\"\r\n                    >\r\n                      Create New Nugget\r\n                    </button>\r\n                  )}\r\n                </>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <footer className=\"shrink-0 flex items-center justify-center py-1.5 border-t border-zinc-100 dark:border-zinc-700 bg-white dark:bg-zinc-900 relative z-[102]\">\r\n          <p className=\"text-[10px] text-zinc-400 dark:text-zinc-500 tracking-wide\">\r\n            <span className=\"font-light italic tracking-tight\">info</span><span className=\"font-semibold not-italic tracking-tight\">nugget</span>\r\n            <span className=\"ml-1\">is AI powered and can make mistakes. Please double-check generated content and cards.</span>\r\n          </p>\r\n        </footer>\r\n      </div>\r\n      </>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default App;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\AssetsPanel.tsx","messages":[{"ruleId":"no-duplicate-imports","severity":2,"message":"'./workbench/AnnotationWorkbench' import is duplicated.","line":6,"column":1,"nodeType":"ImportDeclaration","messageId":"import","endLine":6,"endColumn":79},{"ruleId":"import/order","severity":1,"message":"`../context/AppContext` import should occur before import of `./workbench/AnnotationWorkbench`","line":9,"column":1,"nodeType":"ImportDeclaration","endLine":9,"endColumn":55,"fix":{"range":[273,605],"text":"import { useAppContext } from '../context/AppContext';\nimport AnnotationWorkbench from './workbench/AnnotationWorkbench';\nimport type { AnnotationToolbarState } from './workbench/AnnotationWorkbench';\nimport AnnotationToolbar from './workbench/AnnotationToolbar';\nimport { ReferenceMismatchDialog, ManifestModal } from './Dialogs';\n"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setActiveLogicTab' is defined but never used. Allowed unused args must match /^_/u.","line":53,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'genStatus' is defined but never used. Allowed unused args must match /^_/u.","line":54,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":12},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 80 to the 15 allowed.","line":80,"column":4,"nodeType":null,"messageId":"refactorFunction","endLine":80,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'colorRefs' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":82,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":18},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":96,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":96,"endColumn":33,"fix":{"range":[3802,3809],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":163,"column":45,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":163,"endColumn":52,"fix":{"range":[5989,5996],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":179,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":179,"endColumn":51,"fix":{"range":[6650,6657],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":183,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":183,"endColumn":39,"fix":{"range":[6771,6778],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":201,"column":10,"nodeType":"Literal","messageId":"noMagic","endLine":201,"endColumn":13},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2800.","line":202,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":202,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'funMessages.length'. Either include it or remove the dependency array.","line":204,"column":6,"nodeType":"ArrayExpression","endLine":204,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [funMessages.length, isGenerating]","fix":{"range":[7320,7334],"text":"[funMessages.length, isGenerating]"}}]},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":239,"column":17,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":243,"endColumn":117},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":241,"column":21,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":243,"endColumn":117,"fix":{"range":[9632,9831],"text":"(cardLabMode === 'inpaint'\n                    ? 'text-zinc-800 dark:text-zinc-200'\n                    : 'text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 cursor-pointer')"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 15 times.","line":277,"column":205,"nodeType":"Literal","messageId":"defineConstant","endLine":277,"endColumn":268},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 13 times.","line":277,"column":271,"nodeType":"Literal","messageId":"defineConstant","endLine":277,"endColumn":391},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":294,"column":73,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":294,"endColumn":102,"fix":{"range":[13095,13124],"text":"{setShowUserDefinedSub(false);}"}},{"ruleId":"unicorn/prefer-includes","severity":1,"message":"Use `.includes()` instead of `.some()` when checking value existence.","line":298,"column":206,"nodeType":"Identifier","messageId":"prefer-includes-over-some/error","endLine":298,"endColumn":210,"fix":{"range":[13507,13545],"text":"includes(menuDraftOptions.style"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":410,"column":129,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":410,"endColumn":446},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":410,"column":222,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":410,"endColumn":446,"fix":{"range":[22350,22574],"text":"(referenceImage && useReferenceImage ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200')"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":497,"column":105,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":497,"endColumn":127,"fix":{"range":[29703,29725],"text":"{updatePalette(key, v);}"}},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":525,"column":38,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":525,"endColumn":79},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":662,"column":10,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":734,"endColumn":10},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":686,"column":13,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":734,"endColumn":10},{"ruleId":"react/no-danger","severity":1,"message":"Dangerous property 'dangerouslySetInnerHTML' found","line":688,"column":77,"nodeType":"JSXAttribute","messageId":"dangerousProp","endLine":688,"endColumn":198},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":690,"column":13,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":734,"endColumn":10},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":690,"column":13,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":734,"endColumn":10},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":799,"column":29,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":799,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":799,"column":152,"nodeType":"Literal","messageId":"noMagic","endLine":799,"endColumn":153},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":815,"column":26,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":815,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":817,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":817,"endColumn":63}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":27,"fixableErrorCount":0,"fixableWarningCount":10,"source":"import React, { useRef, useState, useEffect } from 'react';\nimport { marked } from 'marked';\nimport { Card, StylingOptions, Palette, DetailLevel, ImageVersion, ReferenceImage } from '../types';\nimport { VISUAL_STYLES, STYLE_FONTS, BUILTIN_STYLE_NAMES } from '../utils/ai';\nimport AnnotationWorkbench from './workbench/AnnotationWorkbench';\nimport type { AnnotationToolbarState } from './workbench/AnnotationWorkbench';\nimport AnnotationToolbar from './workbench/AnnotationToolbar';\nimport { ReferenceMismatchDialog, ManifestModal } from './Dialogs';\nimport { useAppContext } from '../context/AppContext';\nimport PanelRequirements from './PanelRequirements';\n\ninterface AssetsPanelProps {\n  activeCard: Card | null;\n  committedSettings: StylingOptions;\n  menuDraftOptions: StylingOptions;\n  setMenuDraftOptions: React.Dispatch<React.SetStateAction<StylingOptions>>;\n  activeLogicTab: DetailLevel;\n  setActiveLogicTab: (level: DetailLevel) => void;\n  genStatus: string;\n  onGenerateCard: (card: Card) => void;\n  onGenerateAll: () => void;\n  selectedCount: number;\n  onZoomImage: (url: string) => void;\n  onImageModified?: (cardId: string, newImageUrl: string, history: ImageVersion[]) => void;\n  contentDirty?: boolean;\n  currentContent?: string;\n  onDownloadImage?: () => void;\n  onDownloadAllImages?: () => void;\n  referenceImage?: ReferenceImage | null;\n  onStampReference?: () => void;\n  useReferenceImage?: boolean;\n  onToggleUseReference?: () => void;\n  onReferenceImageModified?: (newImageUrl: string) => void;\n  onDeleteReference?: () => void;\n  mismatchDialog?: { resolve: (decision: 'disable' | 'skip' | 'cancel') => void } | null;\n  onDismissMismatch?: () => void;\n  manifestCards?: Card[] | null;\n  onExecuteBatch?: () => void;\n  onCloseManifest?: () => void;\n  onDeleteCardImage?: () => void;\n  onDeleteCardVersions?: () => void;\n  onDeleteAllCardImages?: () => void;\n  onUsage?: (entry: { provider: 'gemini'; model: string; inputTokens: number; outputTokens: number }) => void;\n  onOpenStyleStudio?: () => void;\n}\n\nconst AssetsPanel: React.FC<AssetsPanelProps> = ({\n  activeCard,\n  committedSettings,\n  menuDraftOptions,\n  setMenuDraftOptions,\n  activeLogicTab,\n  setActiveLogicTab,\n  genStatus,\n  onGenerateCard,\n  onGenerateAll,\n  selectedCount,\n  onZoomImage,\n  onImageModified,\n  contentDirty,\n  currentContent,\n  onDownloadImage,\n  onDownloadAllImages,\n  referenceImage,\n  onStampReference,\n  useReferenceImage,\n  onToggleUseReference,\n  onReferenceImageModified,\n  onDeleteReference,\n  mismatchDialog,\n  onDismissMismatch,\n  manifestCards,\n  onExecuteBatch,\n  onCloseManifest,\n  onDeleteCardImage,\n  onDeleteCardVersions,\n  onDeleteAllCardImages,\n  onUsage,\n  onOpenStyleStudio,\n}) => {\n  const { darkMode } = useAppContext();\n  const colorRefs = useRef<Record<string, HTMLInputElement | null>>({});\n  const [showPrompt, setShowPrompt] = useState(false);\n  const [showReference, setShowReference] = useState(false);\n  const [openMenu, setOpenMenu] = useState<'style' | 'ratio' | 'resolution' | 'reference' | 'download' | 'generate' | 'delete' | 'palette-background' | 'palette-primary' | 'palette-secondary' | 'palette-accent' | 'palette-text' | null>(null);\n  const [menuMode, setMenuMode] = useState<'hover' | 'locked'>('hover');\n  const [toolbarState, setToolbarState] = useState<AnnotationToolbarState | null>(null);\n  const [cardLabMode, setCardLabMode] = useState<'generate' | 'inpaint'>('generate');\n  const [showUserDefinedSub, setShowUserDefinedSub] = useState(false);\n  const [userDefinedLocked, setUserDefinedLocked] = useState(false);\n\n  // Reset sub-menu when style menu closes\n  useEffect(() => { if (openMenu !== 'style') { setShowUserDefinedSub(false); setUserDefinedLocked(false); } }, [openMenu]);\n\n  const handleDownloadReference = () => {\n    if (!referenceImage) return;\n    const link = document.createElement('a');\n    link.href = referenceImage.url;\n    link.download = `reference-${referenceImage.settings.style}-${referenceImage.settings.aspectRatio}.png`;\n    link.click();\n  };\n\n  const handleStyleChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n    const newStyle = e.target.value;\n    setMenuDraftOptions(prev => ({\n      ...prev,\n      style: newStyle,\n      palette: VISUAL_STYLES[newStyle] || prev.palette,\n      fonts: STYLE_FONTS[newStyle] || prev.fonts\n    }));\n  };\n\n  const updatePalette = (key: keyof Palette, value: string) => {\n    setMenuDraftOptions(prev => ({\n      ...prev,\n      palette: { ...prev.palette, [key]: value }\n    }));\n  };\n\n  const hasImage = !!activeCard?.cardUrlMap?.[activeLogicTab];\n\n  // Clear toolbar state and revert to generate mode when no image\n  useEffect(() => {\n    if (!hasImage) {\n      setToolbarState(null);\n      setCardLabMode('generate');\n    }\n  }, [hasImage]);\n  const isGenerating = !!activeCard?.isGeneratingMap?.[activeLogicTab];\n\n  const paletteKeys: Array<keyof Palette> = ['background', 'primary', 'secondary', 'accent', 'text'];\n\n  const imageContainerRef = useRef<HTMLDivElement>(null);\n\n  // ── Rotating fun status messages ──\n  const funMessages = [\n    'Brewing visual magic...',\n    'Pixels falling into place...',\n    'Teaching colors to dance...',\n    'Consulting the design gods...',\n    'Waking up the AI hamsters...',\n    'Sketching at the speed of thought...',\n    'Mixing the perfect pixel potion...',\n    'Crunching creative numbers...',\n    'Painting between the lines...',\n    'Warming up the idea engine...',\n    'Convincing gradients to behave...',\n    'Almost there, probably...',\n    'Aligning all the things...',\n    'Letting the AI cook...',\n    'Sprinkling some visual fairy dust...',\n    'Doing something very clever...',\n    'Polishing every last pixel...',\n    'Channeling inner Picasso...',\n    'Rendering with reckless ambition...',\n    'Making it look effortless...',\n  ];\n\n  const styleToolbarRef = useRef<HTMLDivElement>(null);\n\n  // Close menu on click outside (only when locked)\n  useEffect(() => {\n    if (!openMenu || menuMode !== 'locked') return;\n    const handler = (e: MouseEvent) => {\n      if (styleToolbarRef.current && !styleToolbarRef.current.contains(e.target as Node)) {\n        setOpenMenu(null);\n      }\n    };\n    document.addEventListener('mousedown', handler);\n    return () => document.removeEventListener('mousedown', handler);\n  }, [openMenu, menuMode]);\n\n  // Helpers for hover/locked menu pattern\n  const toggleMenuLocked = (key: typeof openMenu) => {\n    if (openMenu === key && menuMode === 'locked') { setOpenMenu(null); }\n    else { setMenuMode('locked'); setOpenMenu(key); }\n  };\n  const hoverMenuEnter = (key: typeof openMenu) => {\n    if (openMenu && menuMode === 'locked') return;\n    setMenuMode('hover'); setOpenMenu(key);\n  };\n  const hoverMenuLeave = () => {\n    if (menuMode === 'locked') return;\n    setOpenMenu(null);\n  };\n\n  const [funMsgIndex, setFunMsgIndex] = useState(0);\n  const [funMsgFade, setFunMsgFade] = useState(true);\n\n  useEffect(() => {\n    if (!isGenerating) {\n      setFunMsgIndex(0);\n      setFunMsgFade(true);\n      return;\n    }\n    const interval = setInterval(() => {\n      setFunMsgFade(false); // fade out\n      setTimeout(() => {\n        setFunMsgIndex(prev => (prev + 1) % funMessages.length);\n        setFunMsgFade(true); // fade in\n      }, 300);\n    }, 2800);\n    return () => clearInterval(interval);\n  }, [isGenerating]);\n\n  return (\n    <section className=\"flex-1 min-w-0 flex flex-col relative z-[103] overflow-hidden group border border-zinc-200 dark:border-zinc-700 shadow-[0_1px_3px_rgba(0,0,0,0.06),0_4px_12px_rgba(0,0,0,0.04)]\" style={{ background: darkMode ? '#18181b' : '#ffffff' }}>\n      {/* Clean canvas — no texture */}\n\n      {/* ─── Design Toolbar ─── */}\n      <div className=\"relative z-30\">\n        {/* ─── Title row ─── */}\n        <div className=\"shrink-0 flex flex-row items-center pt-2 pb-1\">\n          <div className=\"w-8 shrink-0 flex items-center justify-center\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-zinc-500 dark:text-zinc-400\">\n              <rect width=\"16\" height=\"16\" x=\"3\" y=\"3\" rx=\"2\" ry=\"2\"/><circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/><path d=\"m21 15-5-5L5 21\"/>\n            </svg>\n          </div>\n          <span className=\"text-[13px] font-bold uppercase tracking-wider text-zinc-800 dark:text-zinc-200\">Assets</span>\n        </div>\n        {/* ─── Mode toggle ─── */}\n        <div className=\"shrink-0 border-y border-zinc-200/60 dark:border-zinc-700/60\">\n          <div className=\"flex items-center justify-center gap-1.5 px-3 py-1.5 min-h-[32px]\">\n            <button\n              onClick={() => setCardLabMode('generate')}\n              title=\"Generate mode\"\n              className={`text-[10px] font-semibold uppercase tracking-wider transition-colors ${\n                cardLabMode === 'generate' ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 cursor-pointer'\n              }`}\n            >\n              Generate\n            </button>\n            <span className=\"text-zinc-500 dark:text-zinc-400 text-[10px]\">·</span>\n            <button\n              onClick={() => hasImage && setCardLabMode('inpaint')}\n              disabled={!hasImage}\n              title={hasImage ? 'Inpaint mode' : 'Generate a card first to use inpainting'}\n              className={`text-[10px] font-semibold uppercase tracking-wider transition-colors ${\n                !hasImage\n                  ? 'text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'\n                  : cardLabMode === 'inpaint'\n                    ? 'text-zinc-800 dark:text-zinc-200'\n                    : 'text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 cursor-pointer'\n              }`}\n            >\n              Inpaint\n            </button>\n          </div>\n        </div>\n        {/* ─── Toolbar row ─── */}\n        {cardLabMode === 'generate' ? (\n        <div ref={styleToolbarRef} className=\"px-5 h-[40px] flex items-center justify-center gap-2 border-b border-zinc-200 dark:border-zinc-700\">\n          {/* Style controls toolbar */}\n          <div className=\"flex items-center gap-1 px-1.5 h-9\">\n            {/* Style Studio button */}\n            <button\n              onClick={() => onOpenStyleStudio?.()}\n              title=\"Style Studio\"\n              className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all duration-200 active:scale-95 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200\"\n            >\n              <svg width=\"15\" height=\"15\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z\" />\n                <circle cx=\"13.5\" cy=\"6.5\" r=\".5\" fill=\"currentColor\" />\n                <circle cx=\"17.5\" cy=\"10.5\" r=\".5\" fill=\"currentColor\" />\n                <circle cx=\"6.5\" cy=\"12.5\" r=\".5\" fill=\"currentColor\" />\n                <circle cx=\"8.5\" cy=\"7.5\" r=\".5\" fill=\"currentColor\" />\n              </svg>\n            </button>\n\n            <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n            {/* Style selector */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('style')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('style')}\n                title={`Style: ${menuDraftOptions.style}`}\n                className={`h-7 px-2 rounded-full flex items-center justify-center text-[11px] font-medium uppercase transition-all duration-200 active:scale-95 whitespace-nowrap ${openMenu === 'style' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n              >\n                {menuDraftOptions.style}\n              </button>\n              {openMenu === 'style' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150\">\n                  {(() => {\n                    const allNames = Object.keys(VISUAL_STYLES);\n                    const builtIn = allNames.filter(n => BUILTIN_STYLE_NAMES.has(n));\n                    const custom = allNames.filter(n => !BUILTIN_STYLE_NAMES.has(n));\n                    return (\n                      <>\n                        {/* User Defined parent item with sub-menu — always first */}\n                        <div\n                          className=\"relative\"\n                          onMouseEnter={() => setShowUserDefinedSub(true)}\n                          onMouseLeave={() => { if (!userDefinedLocked) setShowUserDefinedSub(false); }}\n                        >\n                          <button\n                            onClick={() => { setUserDefinedLocked(prev => !prev); setShowUserDefinedSub(true); }}\n                            className={`block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors flex items-center justify-between gap-3 ${custom.some(n => menuDraftOptions.style === n) ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n                          >\n                            User Defined\n                            <svg width=\"8\" height=\"8\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><polyline points=\"9 18 15 12 9 6\" /></svg>\n                          </button>\n                          {showUserDefinedSub && (\n                            <div className=\"absolute left-full top-0 pl-1 z-50\">\n                              <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 max-h-[280px] overflow-y-auto animate-in fade-in duration-100\">\n                                {custom.map(styleName => (\n                                  <button\n                                    key={styleName}\n                                    onClick={() => { handleStyleChange({ target: { value: styleName } } as React.ChangeEvent<HTMLSelectElement>); setOpenMenu(null); setShowUserDefinedSub(false); setUserDefinedLocked(false); }}\n                                    className={`block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors ${menuDraftOptions.style === styleName ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n                                  >\n                                    {styleName}\n                                  </button>\n                                ))}\n                                {custom.length > 0 && <div className=\"my-1 mx-2 border-t border-zinc-200 dark:border-zinc-700\" />}\n                                <button\n                                  onClick={() => { onOpenStyleStudio?.(); setOpenMenu(null); setShowUserDefinedSub(false); setUserDefinedLocked(false); }}\n                                  className=\"block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 flex items-center gap-1.5\"\n                                >\n                                  <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\" /><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\" /></svg>\n                                  Create New Style\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                        <div className=\"my-1 mx-2 border-t border-zinc-200 dark:border-zinc-700\" />\n                        <div className=\"max-h-[240px] overflow-y-auto\">\n                        {builtIn.map(styleName => (\n                          <button\n                            key={styleName}\n                            onClick={() => { handleStyleChange({ target: { value: styleName } } as React.ChangeEvent<HTMLSelectElement>); setOpenMenu(null); }}\n                            className={`block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors ${menuDraftOptions.style === styleName ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n                          >\n                            {styleName}\n                          </button>\n                        ))}\n                        </div>\n                      </>\n                    );\n                  })()}\n                </div>\n                </div>\n              )}\n            </div>\n\n            <span className=\"text-zinc-500 dark:text-zinc-400 text-[11px]\">|</span>\n\n            {/* Aspect ratio selector */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('ratio')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('ratio')}\n                title={`Ratio: ${menuDraftOptions.aspectRatio}`}\n                className={`h-7 px-2 rounded-full flex items-center justify-center text-[11px] font-medium uppercase transition-all duration-200 active:scale-95 whitespace-nowrap ${openMenu === 'ratio' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n              >\n                {menuDraftOptions.aspectRatio}\n              </button>\n              {openMenu === 'ratio' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150\">\n                  {(['16:9', '4:3', '1:1', '9:16', '3:2', '2:3', '3:4', '4:5', '5:4', '21:9'] as const).map(ratio => (\n                    <button\n                      key={ratio}\n                      onClick={() => { setMenuDraftOptions(prev => ({ ...prev, aspectRatio: ratio })); setOpenMenu(null); }}\n                      className={`block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors ${menuDraftOptions.aspectRatio === ratio ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n                    >\n                      {ratio}\n                    </button>\n                  ))}\n                </div>\n                </div>\n              )}\n            </div>\n\n            <span className=\"text-zinc-500 dark:text-zinc-400 text-[11px]\">|</span>\n\n            {/* Resolution selector */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('resolution')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('resolution')}\n                title={`Resolution: ${menuDraftOptions.resolution}`}\n                className={`h-7 px-2 rounded-full flex items-center justify-center text-[11px] font-medium uppercase transition-all duration-200 active:scale-95 whitespace-nowrap ${openMenu === 'resolution' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n              >\n                {menuDraftOptions.resolution}\n              </button>\n              {openMenu === 'resolution' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150\">\n                  {(['1K', '2K', '4K'] as const).map(res => (\n                    <button\n                      key={res}\n                      onClick={() => { setMenuDraftOptions(prev => ({ ...prev, resolution: res as StylingOptions['resolution'] })); setOpenMenu(null); }}\n                      className={`block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors ${menuDraftOptions.resolution === res ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n                    >\n                      {res}\n                    </button>\n                  ))}\n                </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n            {/* Reference image menu */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('reference')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('reference')}\n                title=\"Reference image\"\n                className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-200 active:scale-95 ${openMenu === 'reference' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : referenceImage && useReferenceImage ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'}`}\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z\"/><circle cx=\"12\" cy=\"12\" r=\"3\"/>\n                </svg>\n              </button>\n              {openMenu === 'reference' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150 min-w-[170px]\">\n                  {referenceImage && (\n                    <>\n                      {/* Use Reference toggle */}\n                      <button\n                        onClick={() => { onToggleUseReference?.(); }}\n                        className=\"flex items-center justify-between w-full px-3 py-1.5 rounded-lg transition-colors text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200\"\n                      >\n                        <span className=\"text-[11px] font-medium uppercase\">Use Ref.</span>\n                        <div className={`relative w-6 h-3.5 rounded-full transition-colors duration-200 ${useReferenceImage ? 'bg-zinc-900 dark:bg-zinc-100' : 'bg-zinc-300 dark:bg-zinc-600'}`}>\n                          <div className={`absolute top-[2px] w-2.5 h-2.5 rounded-full bg-white dark:bg-zinc-900 border border-zinc-300 dark:border-zinc-600 transition-all duration-200 ${useReferenceImage ? 'left-[12px]' : 'left-[2px]'}`} />\n                        </div>\n                      </button>\n                      {/* View Reference toggle */}\n                      <button\n                        onClick={() => { setShowReference(prev => !prev); }}\n                        className=\"flex items-center justify-between w-full px-3 py-1.5 rounded-lg transition-colors text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200\"\n                      >\n                        <span className=\"text-[11px] font-medium uppercase\">View Ref.</span>\n                        <div className={`relative w-6 h-3.5 rounded-full transition-colors duration-200 ${showReference ? 'bg-zinc-900 dark:bg-zinc-100' : 'bg-zinc-300 dark:bg-zinc-600'}`}>\n                          <div className={`absolute top-[2px] w-2.5 h-2.5 rounded-full bg-white dark:bg-zinc-900 border border-zinc-300 dark:border-zinc-600 transition-all duration-200 ${showReference ? 'left-[12px]' : 'left-[2px]'}`} />\n                        </div>\n                      </button>\n                      <div className=\"h-px bg-zinc-200/60 dark:bg-zinc-700/60 mx-2 my-1\" />\n                    </>\n                  )}\n                  <button\n                    onClick={() => { onStampReference?.(); setOpenMenu(null); }}\n                    disabled={!hasImage}\n                    className={`block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap transition-colors ${referenceImage && hasImage && activeCard?.cardUrlMap?.[activeLogicTab] === referenceImage.url ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'} disabled:opacity-40 disabled:pointer-events-none`}\n                  >\n                    Set Current as Ref.\n                  </button>\n                  {referenceImage && (\n                    <>\n                      <button\n                        onClick={() => { handleDownloadReference(); setOpenMenu(null); }}\n                        className=\"block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                      >\n                        Download Ref.\n                      </button>\n                      <button\n                        onClick={() => { onDeleteReference?.(); setShowReference(false); setOpenMenu(null); }}\n                        className=\"block w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-red-500 hover:bg-red-50 transition-colors\"\n                      >\n                        Delete Ref.\n                      </button>\n                    </>\n                  )}\n                </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n            {/* Palette dots */}\n            {paletteKeys.map((key) => {\n              const menuKey = `palette-${key}` as typeof openMenu;\n              return (\n                <div key={key} className=\"relative flex items-center justify-center\" onMouseEnter={() => hoverMenuEnter(menuKey)} onMouseLeave={hoverMenuLeave}>\n                  <button\n                    onClick={() => toggleMenuLocked(menuKey)}\n                    className={`w-[18px] h-[18px] rounded-full transition-all duration-200 cursor-pointer ring-[1.5px] hover:scale-125 hover:shadow-lg dark:hover:shadow-black/30 active:scale-95 ${openMenu === menuKey ? 'ring-black/50 dark:ring-white/60 scale-125' : 'ring-black/20 dark:ring-white/40 hover:ring-black/30 dark:hover:ring-white/50'}`}\n                    style={{ backgroundColor: menuDraftOptions.palette[key] }}\n                    title={key.charAt(0).toUpperCase() + key.slice(1)}\n                  />\n                  {openMenu === menuKey && (\n                    <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                    <div className=\"rounded-lg shadow-lg py-2 px-2 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150 flex items-center gap-2\">\n                      <input\n                        type=\"color\"\n                        value={menuDraftOptions.palette[key]}\n                        onChange={(e) => updatePalette(key, e.target.value)}\n                        className=\"w-7 h-7 rounded-lg cursor-pointer border-0 p-0 bg-transparent\"\n                      />\n                      <input\n                        type=\"text\"\n                        value={menuDraftOptions.palette[key]}\n                        onChange={(e) => { const v = e.target.value; if (/^#[0-9A-Fa-f]{0,6}$/.test(v)) updatePalette(key, v); }}\n                        className=\"w-[68px] text-[11px] font-mono font-medium text-zinc-600 dark:text-zinc-400 bg-zinc-50 dark:bg-zinc-800 rounded-lg px-2 py-1.5 border border-zinc-200 dark:border-zinc-700 focus:outline-none focus:border-zinc-400 dark:focus:border-zinc-500 uppercase\"\n                        spellCheck={false}\n                      />\n                    </div>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n            <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n            {/* Generate menu */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('generate')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('generate')}\n                disabled={isGenerating}\n                title=\"Generate\"\n                className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-200 active:scale-95 ${openMenu === 'generate' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'} disabled:opacity-40 disabled:pointer-events-none`}\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z\"/>\n                </svg>\n              </button>\n              {openMenu === 'generate' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150 min-w-[160px]\">\n                  <button\n                    onClick={() => { activeCard && onGenerateCard(activeCard); setOpenMenu(null); }}\n                    disabled={!activeCard}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors disabled:opacity-40 disabled:pointer-events-none\"\n                  >\n                    Generate Card\n                  </button>\n                  <button\n                    onClick={() => { onGenerateAll(); setOpenMenu(null); }}\n                    disabled={selectedCount === 0}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors disabled:opacity-40 disabled:pointer-events-none\"\n                  >\n                    Generate Selected\n                  </button>\n                </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n            {/* Toggle image / prompt view */}\n            <button\n              onClick={() => setShowPrompt(prev => !prev)}\n              disabled={!activeCard?.lastPromptMap?.[activeLogicTab]}\n              title={showPrompt ? 'Show generated image' : 'Show generation prompt'}\n              className={`w-7 h-7 rounded-full flex items-center justify-center active:scale-95 transition-all duration-200 ${showPrompt && activeCard?.lastPromptMap?.[activeLogicTab] ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'} disabled:opacity-40 disabled:pointer-events-none`}\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points=\"16 18 22 12 16 6\" />\n                <polyline points=\"8 6 2 12 8 18\" />\n              </svg>\n            </button>\n\n            <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n            {/* Download menu */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('download')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('download')}\n                disabled={!hasImage}\n                title=\"Download\"\n                className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-200 active:scale-95 ${openMenu === 'download' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'} disabled:opacity-40 disabled:pointer-events-none`}\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"7 10 12 15 17 10\"/><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"/>\n                </svg>\n              </button>\n              {openMenu === 'download' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150 min-w-[140px]\">\n                  <button\n                    onClick={() => { onDownloadImage?.(); setOpenMenu(null); }}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                  >\n                    Download Card\n                  </button>\n                  <button\n                    onClick={() => { onDownloadAllImages?.(); setOpenMenu(null); }}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                  >\n                    Download All\n                  </button>\n                </div>\n                </div>\n              )}\n            </div>\n\n            {/* Delete images menu */}\n            <div className=\"relative\" onMouseEnter={() => hoverMenuEnter('delete')} onMouseLeave={hoverMenuLeave}>\n              <button\n                onClick={() => toggleMenuLocked('delete')}\n                disabled={!hasImage}\n                title=\"Delete images\"\n                className={`w-7 h-7 rounded-full flex items-center justify-center transition-all duration-200 active:scale-95 ${openMenu === 'delete' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-950'} disabled:opacity-40 disabled:pointer-events-none`}\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n                </svg>\n              </button>\n              {openMenu === 'delete' && (\n                <div className=\"absolute left-1/2 -translate-x-1/2 top-full pt-2 z-50\">\n                <div className=\"rounded-lg shadow-lg py-2 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 animate-in fade-in slide-in-from-top-2 duration-150 min-w-[180px]\">\n                  <button\n                    onClick={() => { onDeleteCardImage?.(); setOpenMenu(null); }}\n                    disabled={!hasImage}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors disabled:opacity-40 disabled:pointer-events-none\"\n                  >\n                    Delete Card Active Image\n                  </button>\n                  <button\n                    onClick={() => { onDeleteCardVersions?.(); setOpenMenu(null); }}\n                    disabled={!activeCard?.imageHistoryMap?.[activeLogicTab]?.length}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors disabled:opacity-40 disabled:pointer-events-none\"\n                  >\n                    Delete All Active Card Images\n                  </button>\n                  <button\n                    onClick={() => { onDeleteAllCardImages?.(); setOpenMenu(null); }}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium uppercase rounded-lg whitespace-nowrap text-red-500 hover:bg-red-50 transition-colors\"\n                  >\n                    Delete All Cards Images\n                  </button>\n                </div>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n        ) : (\n        <div className=\"px-5 h-[40px] flex items-center justify-center shrink-0 border-b border-zinc-100 dark:border-zinc-700\">\n          <div className=\"flex justify-center\">\n            {hasImage && toolbarState && (\n              <AnnotationToolbar\n                activeTool={toolbarState.activeTool}\n                onToolChange={toolbarState.onToolChange}\n                annotationCount={toolbarState.annotationCount}\n                onDiscardMarks={toolbarState.onDiscardMarks}\n                onModify={toolbarState.onModify}\n                isModifying={toolbarState.isModifying}\n                activeColor={toolbarState.activeColor}\n                onColorChange={toolbarState.onColorChange}\n                palette={toolbarState.palette}\n                contentDirty={toolbarState.contentDirty}\n                hasSelection={toolbarState.hasSelection}\n                onDeleteSelected={toolbarState.onDeleteSelected}\n                inline\n                globalInstruction={toolbarState.globalInstruction}\n                onGlobalInstructionChange={toolbarState.onGlobalInstructionChange}\n              />\n            )}\n          </div>\n        </div>\n        )}\n\n      </div>\n\n      <div className=\"group/zoom flex-1 flex flex-col items-center justify-center px-4 text-center animate-in fade-in duration-1000 relative border-b border-zinc-100 dark:border-zinc-700\" style={{ background: darkMode ? 'linear-gradient(180deg, #1e1e22 0%, #1a1a1e 40%, #202024 100%)' : 'linear-gradient(180deg, #f0f4f8 0%, #e8edf2 40%, #f5f7fa 100%)' }}>\n        {showReference && referenceImage ? (\n          <div className=\"w-full h-full animate-in fade-in duration-300 relative\">\n            <AnnotationWorkbench\n              imageUrl={referenceImage.url}\n              cardId={null}\n              cardText={null}\n              palette={referenceImage.settings.palette}\n              style={referenceImage.settings.style}\n              aspectRatio={referenceImage.settings.aspectRatio}\n              resolution={referenceImage.settings.resolution}\n              mode=\"inline\"\n              onImageModified={onReferenceImageModified ? (_id: string, newUrl: string) => onReferenceImageModified(newUrl) : undefined}\n              onRequestFullscreen={() => onZoomImage(referenceImage.url)}\n              onToolbarStateChange={setToolbarState}\n              onUsage={onUsage}\n              overlay={\n                <div className=\"absolute top-0 right-0 overflow-hidden w-32 h-32 pointer-events-none z-10\" style={{ borderRadius: '0 20px 0 0' }}>\n                  <div className=\"absolute top-[18px] right-[-36px] w-[180px] text-center rotate-45 text-white text-[11px] font-bold uppercase tracking-[0.2em] py-1 shadow-sm\" style={{ backgroundColor: 'rgba(42, 159, 212, 0.85)' }}>\n                    ref. Image\n                  </div>\n                </div>\n              }\n            />\n          </div>\n        ) : showPrompt && activeCard?.lastPromptMap?.[activeLogicTab] ? (\n          <div className=\"absolute inset-0 overflow-y-auto text-left px-6 py-4 animate-in fade-in duration-300\">\n            <article className=\"document-prose chat-prose pb-20 max-w-none\" dangerouslySetInnerHTML={{ __html: marked.parse(activeCard.lastPromptMap[activeLogicTab]!, { async: false }) as string }} />\n          </div>\n        ) : isGenerating ? (\n          <div className=\"flex flex-col items-center space-y-8 animate-in fade-in duration-500\">\n            <div className=\"relative w-24 h-24\">\n              <div className=\"absolute inset-0 border-4 border-[rgba(42,159,212,0.1)] rounded-full\" />\n              <div className=\"absolute inset-0 border-4 border-t-accent-blue rounded-full animate-spin\" />\n              <div className=\"absolute inset-4 border-2 border-[rgba(42,159,212,0.2)] rounded-full animate-pulse\" />\n            </div>\n            <div className=\"space-y-2\">\n              <p\n                className=\"text-[11px] font-medium text-zinc-500 dark:text-zinc-400 italic transition-all duration-300 ease-in-out\"\n                style={{ opacity: funMsgFade ? 1 : 0, transform: funMsgFade ? 'translateY(0)' : 'translateY(4px)' }}\n              >\n                {funMessages[funMsgIndex]}\n              </p>\n            </div>\n          </div>\n        ) : hasImage ? (\n          <div\n            ref={imageContainerRef}\n            className=\"w-full h-full animate-in fade-in duration-300 relative\"\n          >\n            <AnnotationWorkbench\n              imageUrl={activeCard!.cardUrlMap![activeLogicTab]!}\n              cardId={activeCard!.id}\n              cardText={activeCard!.text}\n              palette={committedSettings.palette}\n              style={committedSettings.style}\n              aspectRatio={committedSettings.aspectRatio}\n              resolution={committedSettings.resolution}\n              imageHistory={activeCard!.imageHistoryMap?.[activeLogicTab]}\n              mode=\"inline\"\n              onImageModified={onImageModified}\n              onRequestFullscreen={() => onZoomImage(activeCard!.cardUrlMap![activeLogicTab] || '')}\n              contentDirty={contentDirty}\n              currentContent={currentContent}\n              onToolbarStateChange={setToolbarState}\n              onUsage={onUsage}\n            />\n\n          </div>\n        ) : (\n          <div className=\"w-full h-full flex flex-col items-center justify-center\">\n            <PanelRequirements level=\"assets\" hasImage={hasImage} />\n          </div>\n        )}\n\n        {/* Floating zoom controls — bottom-left, visible on hover */}\n        {(hasImage || (showReference && referenceImage)) && toolbarState && (\n          <div className=\"absolute bottom-3 left-3 z-20 flex items-center gap-0.5 px-1.5 py-1 rounded-lg bg-white/70 dark:bg-zinc-900/70 backdrop-blur-sm opacity-0 group-hover/zoom:opacity-100 transition-opacity duration-200\">\n            <button\n              onClick={toolbarState.onZoomOut}\n              title=\"Zoom Out\"\n              className=\"w-6 h-6 rounded-full flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-white/80 dark:hover:bg-zinc-800/80\"\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\n              </svg>\n            </button>\n            <span className=\"text-[10px] font-medium text-zinc-500 dark:text-zinc-400 min-w-[28px] text-center select-none\">{Math.round(toolbarState.zoomScale * 100)}%</span>\n            <button\n              onClick={toolbarState.onZoomIn}\n              title=\"Zoom In\"\n              className=\"w-6 h-6 rounded-full flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-white/80 dark:hover:bg-zinc-800/80\"\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\n              </svg>\n            </button>\n            <button\n              onClick={toolbarState.onZoomReset}\n              title=\"Reset Zoom\"\n              className=\"w-6 h-6 rounded-full flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-white/80 dark:hover:bg-zinc-800/80\"\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 7V5a2 2 0 0 1 2-2h2\"/><path d=\"M17 3h2a2 2 0 0 1 2 2v2\"/><path d=\"M21 17v2a2 2 0 0 1-2 2h-2\"/><path d=\"M7 21H5a2 2 0 0 1-2-2v-2\"/><rect width=\"10\" height=\"8\" x=\"7\" y=\"8\" rx=\"1\"/>\n              </svg>\n            </button>\n            {toolbarState.onRequestFullscreen && (\n              <button\n                onClick={toolbarState.onRequestFullscreen}\n                title=\"Open Fullscreen\"\n                className=\"w-6 h-6 rounded-full flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-white/80 dark:hover:bg-zinc-800/80\"\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <polyline points=\"15 3 21 3 21 9\"/><polyline points=\"9 21 3 21 3 15\"/><line x1=\"21\" y1=\"3\" x2=\"14\" y2=\"10\"/><line x1=\"3\" y1=\"21\" x2=\"10\" y2=\"14\"/>\n                </svg>\n              </button>\n            )}\n          </div>\n        )}\n\n      </div>\n\n      {/* ─── Card Properties footer ─── */}\n      {(showReference && referenceImage) || hasImage ? (\n        <div className=\"shrink-0 px-3 py-1.5 flex items-center justify-center\">\n          {showReference && referenceImage ? (\n            <div className=\"flex items-center gap-1\">\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400 tracking-[0.1em]\">Card Properties</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase\" style={{ color: '#2a9fd4' }}>ref</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">{referenceImage.settings.style}</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">{referenceImage.settings.aspectRatio}</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">{referenceImage.settings.resolution}</span>\n              <div className=\"flex -space-x-0.5 ml-0.5\">\n                {Object.values(referenceImage.settings.palette).map((color, i) => (\n                  <div key={i} className=\"w-2 h-2 rounded-full ring-[1.5px] ring-black/20 dark:ring-white/40\" style={{ backgroundColor: color, zIndex: 5 - i }} />\n                ))}\n              </div>\n            </div>\n          ) : hasImage && (\n            <div className=\"flex items-center gap-1\">\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400 tracking-[0.1em]\">Card Properties</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">{menuDraftOptions.style}</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">{menuDraftOptions.aspectRatio}</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">·</span>\n              <span className=\"text-[9px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">{menuDraftOptions.resolution}</span>\n              <div className=\"flex -space-x-0.5 ml-0.5\">\n                {Object.values(menuDraftOptions.palette).map((color, i) => (\n                  <div\n                    key={i}\n                    className=\"w-2 h-2 rounded-full ring-[1.5px] ring-black/20 dark:ring-white/40\"\n                    style={{ backgroundColor: color, zIndex: 5 - i }}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      ) : null}\n\n      {/* Mismatch dialog — positioned within cardlab */}\n      {mismatchDialog && (\n        <ReferenceMismatchDialog\n          onDisableReference={() => { mismatchDialog.resolve('disable'); onDismissMismatch?.(); }}\n          onSkipOnce={() => { mismatchDialog.resolve('skip'); onDismissMismatch?.(); }}\n          onCancel={() => { mismatchDialog.resolve('cancel'); onDismissMismatch?.(); }}\n        />\n      )}\n\n      {/* Manifest batch confirmation — positioned within cardlab */}\n      {manifestCards && onExecuteBatch && onCloseManifest && (\n        <ManifestModal manifestCards={manifestCards} onExecute={onExecuteBatch} onClose={onCloseManifest} />\n      )}\n    </section>\n  );\n};\n\nexport default AssetsPanel;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\AutoDeckPanel.tsx","messages":[{"ruleId":"import/order","severity":1,"message":"`../utils/autoDeck/constants` import should occur before import of `./PanelRequirements`","line":6,"column":1,"nodeType":"ImportDeclaration","endLine":13,"endColumn":38,"fix":{"range":[259,470],"text":"import {\n  AUTO_DECK_LOD_LEVELS,\n  AUTO_DECK_LIMITS,\n  BRIEFING_LIMITS,\n  estimateCardCount,\n  countWords,\n  LodConfig,\n} from '../utils/autoDeck/constants';\nimport PanelRequirements from './PanelRequirements';\n"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":52,"column":4,"nodeType":null,"messageId":"refactorFunction","endLine":52,"endColumn":6},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":63,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":63,"endColumn":63},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'shouldRender'. Either include it or remove the dependency array.","line":66,"column":6,"nodeType":"ArrayExpression","endLine":66,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, shouldRender]","fix":{"range":[1955,1963],"text":"[isOpen, shouldRender]"}}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":69,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":69,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 700.","line":69,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":69,"endColumn":62},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":72,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":72,"endColumn":64,"fix":{"range":[2226,2257],"text":"{setOverlayWidth(DEFAULT_WIDTH);}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DEFAULT_WIDTH'. Either include it or remove the dependency array.","line":72,"column":68,"nodeType":"ArrayExpression","endLine":72,"endColumn":76,"suggestions":[{"desc":"Update the dependencies array to be: [DEFAULT_WIDTH, isOpen]","fix":{"range":[2261,2269],"text":"[DEFAULT_WIDTH, isOpen]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":84,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":84,"endColumn":45,"fix":{"range":[2808,2815],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":85,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":85,"endColumn":35},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":119,"column":19,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":119,"endColumn":26,"fix":{"range":[4205,4270],"text":"for (const d of availableDocs) { map[d.id] = d.enabled !== false; }"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":133,"column":21,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":133,"endColumn":28,"fix":{"range":[4705,4827],"text":"for (const d of availableDocs) {\n        next[d.id] = prev[d.id] !== undefined ? prev[d.id] : (d.enabled !== false);\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":161,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":161,"endColumn":62,"fix":{"range":[5742,5749],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":164,"column":78,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":164,"endColumn":85,"fix":{"range":[5911,5918],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":165,"column":74,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":165,"endColumn":81,"fix":{"range":[5992,5999],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":199,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":199,"endColumn":46,"fix":{"range":[7441,7448],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":200,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":200,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":200,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":200,"endColumn":56},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":201,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":201,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":201,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":201,"endColumn":56},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":221,"column":34,"nodeType":"Literal","messageId":"defineConstant","endLine":221,"endColumn":58},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":221,"column":61,"nodeType":"Literal","messageId":"defineConstant","endLine":221,"endColumn":79},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.85.","line":236,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":236,"endColumn":49},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":240,"column":56,"nodeType":"Literal","messageId":"defineConstant","endLine":240,"endColumn":71},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":246,"column":20,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":246,"endColumn":80},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":267,"column":24,"nodeType":"Literal","messageId":"defineConstant","endLine":267,"endColumn":36},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 17 to the 15 allowed.","line":276,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":276,"endColumn":33},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":307,"column":40,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":307,"endColumn":146},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":308,"column":36,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":310,"endColumn":70},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":310,"column":35,"nodeType":"Literal","messageId":"defineConstant","endLine":310,"endColumn":59},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":378,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":378,"endColumn":51},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":378,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":378,"endColumn":68,"fix":{"range":[15646,15660],"text":"{setCardMin(v);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":406,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":406,"endColumn":51},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":406,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":406,"endColumn":68,"fix":{"range":[16719,16733],"text":"{setCardMax(v);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":424,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":424,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":429,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":429,"endColumn":47},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":464,"column":34,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":466,"endColumn":34},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":494,"column":28,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":496,"endColumn":73},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":496,"column":27,"nodeType":"Literal","messageId":"defineConstant","endLine":496,"endColumn":51},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":496,"column":54,"nodeType":"Literal","messageId":"defineConstant","endLine":496,"endColumn":72},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":497,"column":18,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":497,"endColumn":76},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":500,"column":45,"nodeType":"Literal","messageId":"defineConstant","endLine":500,"endColumn":58},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.2.","line":529,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":529,"endColumn":68},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":556,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":556,"endColumn":42,"fix":{"range":[22087,22099],"text":"{return null;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 25 to the 15 allowed.","line":576,"column":46,"nodeType":null,"messageId":"refactorFunction","endLine":576,"endColumn":48},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":578,"column":18,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":578,"endColumn":19},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":587,"column":89,"nodeType":"Literal","messageId":"defineConstant","endLine":587,"endColumn":101},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":596,"column":34,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":600,"endColumn":83},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":598,"column":21,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":600,"endColumn":83},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":599,"column":24,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":599,"endColumn":82},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":600,"column":24,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":600,"endColumn":82},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":601,"column":24,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":605,"endColumn":57},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":603,"column":21,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":605,"endColumn":57},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":604,"column":24,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":604,"endColumn":56},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":605,"column":24,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":605,"endColumn":56},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 31 to the 15 allowed.","line":641,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":641,"endColumn":33},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":642,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":642,"endColumn":67,"fix":{"range":[25623,25635],"text":"{return null;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":681,"column":41,"nodeType":"Literal","messageId":"defineConstant","endLine":681,"endColumn":64},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":714,"column":38,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":716,"endColumn":83},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.45.","line":718,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":718,"endColumn":51},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":779,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":781,"endColumn":87},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":813,"column":48,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":815,"endColumn":48},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":816,"column":52,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":818,"endColumn":48},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":905,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":907,"endColumn":53},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":922,"column":32,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":924,"endColumn":77},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":925,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":925,"endColumn":86},{"ruleId":"sonarjs/no-duplicated-branches","severity":1,"message":"This case's code block is the same as the block for the case on line 1053.","line":1071,"column":7,"nodeType":"SwitchCase","messageId":"sameConditionalBlock","endLine":1079,"endColumn":35},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1136,"column":68,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1136,"endColumn":75,"fix":{"range":[46234,46241],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1141,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1141,"endColumn":58,"fix":{"range":[46437,46444],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1143,"column":98,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1143,"endColumn":105,"fix":{"range":[46608,46615],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1185,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1185,"endColumn":58,"fix":{"range":[48760,48767],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1187,"column":102,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1187,"endColumn":109,"fix":{"range":[48935,48942],"text":"{return;}"}}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'availableDocs'. Either include it or remove the dependency array.","line":138,"column":6,"nodeType":"ArrayExpression","endLine":138,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [availableDocs, documents.length]","fix":{"range":[4860,4878],"text":"[availableDocs, documents.length]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":72,"fixableErrorCount":0,"fixableWarningCount":18,"source":"import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport { createPortal } from 'react-dom';\nimport { UploadedFile, AutoDeckBriefing, AutoDeckLod, AutoDeckSession } from '../types';\nimport { useAppContext } from '../context/AppContext';\nimport PanelRequirements from './PanelRequirements';\nimport {\n  AUTO_DECK_LOD_LEVELS,\n  AUTO_DECK_LIMITS,\n  BRIEFING_LIMITS,\n  estimateCardCount,\n  countWords,\n  LodConfig,\n} from '../utils/autoDeck/constants';\n\n// ── Props ──\n\ninterface AutoDeckPanelProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  documents: UploadedFile[];\n  // Hook bindings\n  session: AutoDeckSession | null;\n  onStartPlanning: (briefing: AutoDeckBriefing, lod: AutoDeckLod, orderedDocIds: string[]) => Promise<void>;\n  onRevisePlan: () => Promise<void>;\n  onApprovePlan: () => Promise<void>;\n  onAbort: () => void;\n  onReset: () => void;\n  onToggleCardIncluded: (cardNumber: number) => void;\n  onSetQuestionAnswer: (questionId: string, optionKey: string) => void;\n  onSetAllRecommended: () => void;\n  onSetGeneralComment: (comment: string) => void;\n  onRetryFromReview: () => void;\n}\n\n// ── Component ──\n\nconst AutoDeckPanel: React.FC<AutoDeckPanelProps> = ({\n  isOpen,\n  onToggle,\n  documents,\n  session,\n  onStartPlanning,\n  onRevisePlan,\n  onApprovePlan,\n  onAbort,\n  onReset,\n  onToggleCardIncluded,\n  onSetQuestionAnswer,\n  onSetAllRecommended,\n  onSetGeneralComment,\n  onRetryFromReview,\n}) => {\n  const { darkMode } = useAppContext();\n  const stripRef = useRef<HTMLButtonElement>(null);\n\n  // ── Open/close animation (same pattern as ChatPanel) ──\n  const [shouldRender, setShouldRender] = useState(isOpen);\n  const [isClosing, setIsClosing] = useState(false);\n  useEffect(() => {\n    if (isOpen) { setShouldRender(true); setIsClosing(false); }\n    else if (shouldRender) {\n      setIsClosing(true);\n      const t = setTimeout(() => { setIsClosing(false); }, 400);\n      return () => clearTimeout(t);\n    }\n  }, [isOpen]);\n\n  // ── Overlay resize (same pattern as ChatPanel) ──\n  const DEFAULT_WIDTH = Math.min(window.innerWidth * 0.5, 700);\n  const [overlayWidth, setOverlayWidth] = useState(DEFAULT_WIDTH);\n  const isDraggingResize = useRef(false);\n  useEffect(() => { if (isOpen) setOverlayWidth(DEFAULT_WIDTH); }, [isOpen]);\n  const handleResizeStart = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    isDraggingResize.current = true;\n    document.body.style.userSelect = 'none';\n    document.body.style.cursor = 'ew-resize';\n    const overlay = document.createElement('div');\n    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;cursor:ew-resize;';\n    document.body.appendChild(overlay);\n    const startX = e.clientX;\n    const startW = overlayWidth;\n    const onMove = (ev: MouseEvent) => {\n      if (!isDraggingResize.current) return;\n      setOverlayWidth(Math.max(300, startW + ev.clientX - startX));\n    };\n    const onUp = () => {\n      isDraggingResize.current = false;\n      document.body.style.userSelect = '';\n      document.body.style.cursor = '';\n      overlay.remove();\n      document.removeEventListener('mousemove', onMove);\n      document.removeEventListener('mouseup', onUp);\n    };\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onUp);\n  }, [overlayWidth]);\n\n  // ── Configuration state ──\n  const [briefing, setBriefing] = useState<AutoDeckBriefing>({\n    audience: '',\n    type: '',\n    objective: '',\n    tone: '',\n    focus: '',\n  });\n  const [selectedLod, setSelectedLod] = useState<AutoDeckLod | null>(null);\n  const [cardMin, setCardMin] = useState<string>('');\n  const [cardMax, setCardMax] = useState<string>('');\n  const [includeCover, setIncludeCover] = useState(false);\n  const [includeSectionTitles, setIncludeSectionTitles] = useState(false);\n  const [includeClosing, setIncludeClosing] = useState(false);\n\n  // Document selection + ordering\n  const availableDocs = documents.filter(d => d.content || d.fileId || d.pdfBase64);\n  const [docOrder, setDocOrder] = useState<string[]>(() => availableDocs.map(d => d.id));\n  const [docIncluded, setDocIncluded] = useState<Record<string, boolean>>(() => {\n    const map: Record<string, boolean> = {};\n    availableDocs.forEach(d => { map[d.id] = d.enabled !== false; });\n    return map;\n  });\n\n  // Sync when documents change\n  useEffect(() => {\n    setDocOrder(prev => {\n      const currentIds = new Set(availableDocs.map(d => d.id));\n      const kept = prev.filter(id => currentIds.has(id));\n      const newIds = availableDocs.filter(d => !prev.includes(d.id)).map(d => d.id);\n      return [...kept, ...newIds];\n    });\n    setDocIncluded(prev => {\n      const next: Record<string, boolean> = {};\n      availableDocs.forEach(d => {\n        next[d.id] = prev[d.id] !== undefined ? prev[d.id] : (d.enabled !== false);\n      });\n      return next;\n    });\n  }, [documents.length]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // Reset config when session resets\n  useEffect(() => {\n    if (!session) {\n      setBriefing({ audience: '', type: '', objective: '', tone: '', focus: '' });\n      setSelectedLod(null);\n      setCardMin('');\n      setCardMax('');\n      setIncludeCover(false);\n      setIncludeSectionTitles(false);\n      setIncludeClosing(false);\n    }\n  }, [session]);\n\n  // ── Document dropdown state (matches ChatPanel pattern) ──\n  const [adDocListOpen, setAdDocListOpen] = useState(false);\n  const [adDocListMode, setAdDocListMode] = useState<'hover' | 'locked'>('hover');\n  const adDocToggleRef = useRef<HTMLDivElement>(null);\n  const adDocListRef = useRef<HTMLDivElement>(null);\n\n  // Close doc list popup on outside click (only when locked)\n  useEffect(() => {\n    if (!adDocListOpen || adDocListMode !== 'locked') return;\n    const handleClick = (e: MouseEvent) => {\n      const target = e.target as Node;\n      if (adDocToggleRef.current && adDocToggleRef.current.contains(target)) return;\n      if (adDocListRef.current && adDocListRef.current.contains(target)) return;\n      setAdDocListOpen(false);\n    };\n    window.addEventListener('mousedown', handleClick);\n    return () => window.removeEventListener('mousedown', handleClick);\n  }, [adDocListOpen, adDocListMode]);\n\n  const handleDocToggle = useCallback((docId: string) => {\n    setDocIncluded(prev => ({ ...prev, [docId]: !prev[docId] }));\n  }, []);\n\n  // ── Briefing field handler ──\n  const updateBriefing = useCallback((field: keyof AutoDeckBriefing, value: string) => {\n    const limit = BRIEFING_LIMITS[field];\n    setBriefing(prev => ({ ...prev, [field]: value.slice(0, limit) }));\n  }, []);\n\n  // ── Derived values ──\n  const orderedDocs = docOrder.map(id => availableDocs.find(d => d.id === id)).filter(Boolean) as UploadedFile[];\n  const selectedDocs = orderedDocs.filter(d => docIncluded[d.id]);\n  const totalWordCount = selectedDocs.reduce((sum, d) => sum + (d.content ? countWords(d.content) : 0), 0);\n  const estimate = selectedLod\n    ? estimateCardCount(totalWordCount, selectedLod)\n    : null;\n\n  const status = session?.status ?? 'configuring';\n  const canGenerate = briefing.audience.trim() && briefing.type.trim() && briefing.objective.trim() && selectedLod && selectedDocs.length > 0;\n  const includedCount = session?.reviewState\n    ? Object.values(session.reviewState.cardStates).filter(s => s.included).length\n    : 0;\n\n  // ── Handlers ──\n\n  const handleGenerate = useCallback(async () => {\n    if (!canGenerate || !selectedLod) return;\n    const parsedMin = cardMin ? Math.max(5, Math.min(50, parseInt(cardMin, 10))) : undefined;\n    const parsedMax = cardMax ? Math.max(5, Math.min(50, parseInt(cardMax, 10))) : undefined;\n    const cleanBriefing: AutoDeckBriefing = {\n      audience: briefing.audience.trim(),\n      type: briefing.type.trim(),\n      objective: briefing.objective.trim(),\n      ...(briefing.tone?.trim() ? { tone: briefing.tone.trim() } : {}),\n      ...(briefing.focus?.trim() ? { focus: briefing.focus.trim() } : {}),\n      ...(parsedMin ? { minCards: parsedMin } : {}),\n      ...(parsedMax ? { maxCards: parsedMax } : {}),\n      ...(includeCover ? { includeCover: true } : {}),\n      ...(includeSectionTitles ? { includeSectionTitles: true } : {}),\n      ...(includeClosing ? { includeClosing: true } : {}),\n    };\n    await onStartPlanning(cleanBriefing, selectedLod, selectedDocs.map(d => d.id));\n  }, [canGenerate, briefing, selectedLod, cardMin, cardMax, includeCover, includeSectionTitles, includeClosing, selectedDocs, onStartPlanning]);\n\n  // ── Colors ──\n  const stripBg = darkMode ? 'rgb(60,45,75)' : 'rgb(120,80,160)';\n  const borderColor = stripBg;\n  const inputBg = darkMode ? 'rgba(255,255,255,0.05)' : 'white';\n  const inputBorder = darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.15)';\n  const inputColor = darkMode ? '#e2e8f0' : '#1e293b';\n  const hintColor = darkMode ? '#64748b' : '#94a3b8';\n  const labelColor = darkMode ? '#94a3b8' : '#64748b';\n\n  // ── Briefing field renderer ──\n  const renderBriefingField = (\n    field: keyof AutoDeckBriefing,\n    label: string,\n    hint: string,\n    required: boolean,\n  ) => {\n    const value = briefing[field] || '';\n    const limit = BRIEFING_LIMITS[field];\n    const charCount = value.length;\n    const isNearLimit = charCount > limit * 0.85;\n\n    return (\n      <div style={{ marginBottom: '14px' }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: '4px' }}>\n          <label style={{ fontSize: '12px', fontWeight: 600, color: labelColor }}>\n            {label}{required && <span style={{ color: darkMode ? '#f87171' : '#dc2626', marginLeft: '2px' }}>*</span>}\n          </label>\n          <span style={{\n            fontSize: '10px',\n            color: isNearLimit ? (darkMode ? '#fbbf24' : '#d97706') : hintColor,\n            fontVariantNumeric: 'tabular-nums',\n          }}>\n            {charCount}/{limit}\n          </span>\n        </div>\n        <input\n          type=\"text\"\n          value={value}\n          onChange={(e) => updateBriefing(field, e.target.value)}\n          placeholder={hint}\n          maxLength={limit}\n          style={{\n            width: '100%',\n            padding: '8px 10px',\n            borderRadius: '6px',\n            border: `1px solid ${inputBorder}`,\n            backgroundColor: inputBg,\n            color: inputColor,\n            fontSize: '13px',\n            outline: 'none',\n            boxSizing: 'border-box',\n          }}\n        />\n      </div>\n    );\n  };\n\n  // ── Render views ──\n\n  const renderConfigView = () => (\n    <div style={{ padding: '20px', overflowY: 'auto', flex: 1 }}>\n\n      {/* Briefing fields */}\n      <div style={{ marginBottom: '20px' }}>\n        <div style={{ fontSize: '12px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: labelColor, marginBottom: '12px' }}>\n          Briefing\n        </div>\n        {renderBriefingField('audience', 'Audience', 'Who will view this? e.g. Board of directors, New employees, Potential investors', true)}\n        {renderBriefingField('type', 'Type', 'What kind of presentation? e.g. Educational, Pitch, Status update, Training', true)}\n        {renderBriefingField('objective', 'Objective', 'What should they take away? e.g. Approve the budget, Understand the new policy', true)}\n        {renderBriefingField('tone', 'Tone', 'How should it sound? e.g. Formal, Conversational, Urgent', false)}\n        {renderBriefingField('focus', 'Focus', 'What to prioritize? e.g. Cost data, Timeline, Risk factors', false)}\n      </div>\n\n      {/* LOD selector */}\n      <div style={{ marginBottom: '20px' }}>\n        <div style={{ fontSize: '12px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: labelColor, marginBottom: '8px' }}>\n          Level of Detail\n        </div>\n        <div style={{ display: 'flex', gap: '6px' }}>\n          {(Object.values(AUTO_DECK_LOD_LEVELS) as LodConfig[]).map(lod => {\n            const isSelected = selectedLod === lod.name;\n            return (\n              <button\n                key={lod.name}\n                onClick={() => setSelectedLod(lod.name)}\n                style={{\n                  flex: 1,\n                  padding: '10px 8px',\n                  borderRadius: '8px',\n                  border: `2px solid ${isSelected ? (darkMode ? '#a78bfa' : '#7c3aed') : (darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)')}`,\n                  backgroundColor: isSelected\n                    ? (darkMode ? 'rgba(167,139,250,0.15)' : 'rgba(124,58,237,0.08)')\n                    : (darkMode ? 'rgba(255,255,255,0.03)' : 'white'),\n                  cursor: 'pointer',\n                  textAlign: 'center',\n                  transition: 'all 0.15s',\n                }}\n              >\n                <div style={{ fontSize: '13px', fontWeight: 600, color: darkMode ? '#e2e8f0' : '#1e293b' }}>\n                  {lod.label}\n                </div>\n                <div style={{ fontSize: '11px', color: hintColor }}>\n                  {lod.wordCountMin}&ndash;{lod.wordCountMax} words\n                </div>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Estimate badge */}\n      {estimate && (\n        <div style={{\n          padding: '10px 16px',\n          borderRadius: '8px',\n          backgroundColor: darkMode ? 'rgba(167,139,250,0.1)' : 'rgba(124,58,237,0.06)',\n          border: `1px solid ${darkMode ? 'rgba(167,139,250,0.2)' : 'rgba(124,58,237,0.15)'}`,\n          marginBottom: '20px',\n          fontSize: '13px',\n          color: darkMode ? '#c4b5fd' : '#6d28d9',\n          textAlign: 'center',\n        }}>\n          Rough estimate: <strong>~{estimate.min}&ndash;{estimate.max} cards</strong>\n          <div style={{ fontSize: '11px', marginTop: '4px', opacity: 0.7 }}>\n            AI will determine the optimal count based on content\n          </div>\n          {selectedDocs.some(d => d.sourceType === 'native-pdf' && !d.content) && (\n            <div style={{ fontSize: '11px', marginTop: '4px', opacity: 0.75 }}>\n              Estimate excludes PDF documents (word count unavailable)\n            </div>\n          )}\n          {estimate.max > AUTO_DECK_LIMITS.maxCardsWarning && (\n            <div style={{ color: darkMode ? '#fbbf24' : '#d97706', fontSize: '12px', marginTop: '4px' }}>\n              Large deck — consider Executive LOD or reducing source material.\n            </div>\n          )}\n          {estimate.min < AUTO_DECK_LIMITS.minCards && totalWordCount > 0 && (\n            <div style={{ color: darkMode ? '#fbbf24' : '#d97706', fontSize: '12px', marginTop: '4px' }}>\n              Source may be too short for this detail level.\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Card count range (optional) */}\n      <div style={{ marginBottom: '20px' }}>\n        <div style={{ fontSize: '12px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: labelColor, marginBottom: '8px' }}>\n          Card Count Range <span style={{ fontWeight: 400, textTransform: 'none', fontSize: '11px', opacity: 0.7 }}>(optional)</span>\n        </div>\n        <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>\n          <div style={{ flex: 1 }}>\n            <label style={{ fontSize: '11px', color: hintColor, display: 'block', marginBottom: '3px' }}>Min</label>\n            <input\n              type=\"number\"\n              min={5}\n              max={50}\n              value={cardMin}\n              onChange={(e) => {\n                const v = e.target.value.replace(/[^0-9]/g, '');\n                const n = parseInt(v, 10);\n                if (v === '' || (n >= 1 && n <= 50)) setCardMin(v);\n              }}\n              placeholder=\"5\"\n              style={{\n                width: '100%',\n                padding: '7px 10px',\n                borderRadius: '6px',\n                border: `1px solid ${inputBorder}`,\n                backgroundColor: inputBg,\n                color: inputColor,\n                fontSize: '13px',\n                outline: 'none',\n                boxSizing: 'border-box',\n                textAlign: 'center',\n              }}\n            />\n          </div>\n          <div style={{ color: hintColor, fontSize: '13px', paddingTop: '16px' }}>to</div>\n          <div style={{ flex: 1 }}>\n            <label style={{ fontSize: '11px', color: hintColor, display: 'block', marginBottom: '3px' }}>Max</label>\n            <input\n              type=\"number\"\n              min={5}\n              max={50}\n              value={cardMax}\n              onChange={(e) => {\n                const v = e.target.value.replace(/[^0-9]/g, '');\n                const n = parseInt(v, 10);\n                if (v === '' || (n >= 1 && n <= 50)) setCardMax(v);\n              }}\n              placeholder=\"50\"\n              style={{\n                width: '100%',\n                padding: '7px 10px',\n                borderRadius: '6px',\n                border: `1px solid ${inputBorder}`,\n                backgroundColor: inputBg,\n                color: inputColor,\n                fontSize: '13px',\n                outline: 'none',\n                boxSizing: 'border-box',\n                textAlign: 'center',\n              }}\n            />\n          </div>\n        </div>\n        {cardMin && parseInt(cardMin, 10) < 5 && (\n          <div style={{ fontSize: '11px', color: darkMode ? '#f87171' : '#dc2626', marginTop: '4px' }}>\n            Minimum is 5 cards.\n          </div>\n        )}\n        {cardMax && parseInt(cardMax, 10) > 50 && (\n          <div style={{ fontSize: '11px', color: darkMode ? '#f87171' : '#dc2626', marginTop: '4px' }}>\n            Maximum is 50 cards.\n          </div>\n        )}\n        {cardMin && cardMax && parseInt(cardMin, 10) > parseInt(cardMax, 10) && (\n          <div style={{ fontSize: '11px', color: darkMode ? '#f87171' : '#dc2626', marginTop: '4px' }}>\n            Min cannot exceed max.\n          </div>\n        )}\n        <div style={{ fontSize: '10px', color: hintColor, marginTop: '4px', fontStyle: 'italic' }}>\n          Range: 5–50. Leave blank to let the AI decide.\n        </div>\n      </div>\n\n      {/* Deck options (checkboxes) */}\n      <div style={{ marginBottom: '20px' }}>\n        <div style={{ fontSize: '12px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: labelColor, marginBottom: '10px' }}>\n          Deck Options\n        </div>\n        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>\n          {([\n            { checked: includeCover, onChange: setIncludeCover, label: 'Cover card', hint: 'Title slide with deck overview' },\n            { checked: includeSectionTitles, onChange: setIncludeSectionTitles, label: 'Section title cards', hint: 'Divider cards for main sections' },\n            { checked: includeClosing, onChange: setIncludeClosing, label: 'Closing card', hint: 'Takeaway or conclusion slide' },\n          ] as const).map(opt => (\n            <label\n              key={opt.label}\n              style={{\n                display: 'flex',\n                alignItems: 'center',\n                gap: '8px',\n                cursor: 'pointer',\n                padding: '6px 10px',\n                borderRadius: '6px',\n                backgroundColor: opt.checked\n                  ? (darkMode ? 'rgba(167,139,250,0.1)' : 'rgba(124,58,237,0.05)')\n                  : 'transparent',\n                transition: 'background-color 0.15s',\n              }}\n            >\n              <input\n                type=\"checkbox\"\n                checked={opt.checked}\n                onChange={(e) => opt.onChange(e.target.checked)}\n                style={{ accentColor: darkMode ? '#a78bfa' : '#7c3aed', cursor: 'pointer' }}\n              />\n              <div>\n                <div style={{ fontSize: '13px', fontWeight: 500, color: inputColor }}>{opt.label}</div>\n                <div style={{ fontSize: '11px', color: hintColor }}>{opt.hint}</div>\n              </div>\n            </label>\n          ))}\n        </div>\n      </div>\n\n      {/* Generate button */}\n      <button\n        onClick={handleGenerate}\n        disabled={!canGenerate}\n        style={{\n          width: '100%',\n          padding: '12px',\n          borderRadius: '8px',\n          border: 'none',\n          backgroundColor: canGenerate\n            ? (darkMode ? '#7c3aed' : '#6d28d9')\n            : (darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'),\n          color: canGenerate ? 'white' : (darkMode ? '#64748b' : '#94a3b8'),\n          fontWeight: 600,\n          fontSize: '14px',\n          cursor: canGenerate ? 'pointer' : 'not-allowed',\n          transition: 'all 0.15s',\n        }}\n      >\n        Generate Plan\n      </button>\n    </div>\n  );\n\n  const renderLoadingView = (message: string) => (\n    <div style={{\n      flex: 1,\n      display: 'flex',\n      flexDirection: 'column',\n      alignItems: 'center',\n      justifyContent: 'center',\n      gap: '16px',\n      padding: '40px',\n    }}>\n      {/* Pulsing dots animation */}\n      <div style={{ display: 'flex', gap: '6px' }}>\n        {[0, 1, 2].map(i => (\n          <div\n            key={i}\n            style={{\n              width: '10px',\n              height: '10px',\n              borderRadius: '50%',\n              backgroundColor: darkMode ? '#a78bfa' : '#7c3aed',\n              animation: `autodeck-pulse 1.2s ease-in-out ${i * 0.2}s infinite`,\n            }}\n          />\n        ))}\n      </div>\n      <div style={{ fontSize: '14px', color: darkMode ? '#94a3b8' : '#64748b', textAlign: 'center' }}>\n        {message}\n      </div>\n      <button\n        onClick={onAbort}\n        style={{\n          padding: '8px 20px',\n          borderRadius: '6px',\n          border: `1px solid ${darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.15)'}`,\n          backgroundColor: 'transparent',\n          color: darkMode ? '#94a3b8' : '#64748b',\n          fontSize: '13px',\n          cursor: 'pointer',\n          marginTop: '8px',\n        }}\n      >\n        Cancel\n      </button>\n    </div>\n  );\n\n  const renderConflictView = () => {\n    if (!session?.conflicts) return null;\n    return (\n      <div style={{ flex: 1, overflowY: 'auto', padding: '20px' }}>\n        {/* Alert banner */}\n        <div style={{\n          padding: '12px 16px',\n          borderRadius: '8px',\n          backgroundColor: darkMode ? 'rgba(239,68,68,0.15)' : 'rgba(239,68,68,0.08)',\n          border: `1px solid ${darkMode ? 'rgba(239,68,68,0.3)' : 'rgba(239,68,68,0.2)'}`,\n          marginBottom: '16px',\n        }}>\n          <div style={{ fontWeight: 600, fontSize: '14px', color: darkMode ? '#f87171' : '#dc2626', marginBottom: '4px' }}>\n            Conflicts Detected\n          </div>\n          <div style={{ fontSize: '13px', color: darkMode ? '#fca5a5' : '#b91c1c' }}>\n            The documents contain contradictory information. Please resolve these conflicts before proceeding.\n          </div>\n        </div>\n\n        {/* Conflict list */}\n        {session.conflicts.map((conflict, i) => (\n          <div\n            key={i}\n            style={{\n              padding: '12px 16px',\n              borderRadius: '8px',\n              border: `1px solid ${darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'}`,\n              backgroundColor: darkMode ? 'rgba(255,255,255,0.03)' : 'white',\n              marginBottom: '10px',\n            }}\n          >\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>\n              <div style={{ fontSize: '13px', fontWeight: 500, color: darkMode ? '#e2e8f0' : '#1e293b', flex: 1 }}>\n                {conflict.description}\n              </div>\n              <span style={{\n                fontSize: '11px',\n                fontWeight: 600,\n                padding: '2px 8px',\n                borderRadius: '10px',\n                backgroundColor: conflict.severity === 'high'\n                  ? (darkMode ? 'rgba(239,68,68,0.2)' : 'rgba(239,68,68,0.1)')\n                  : conflict.severity === 'medium'\n                    ? (darkMode ? 'rgba(251,191,36,0.2)' : 'rgba(251,191,36,0.1)')\n                    : (darkMode ? 'rgba(96,165,250,0.2)' : 'rgba(96,165,250,0.1)'),\n                color: conflict.severity === 'high'\n                  ? (darkMode ? '#f87171' : '#dc2626')\n                  : conflict.severity === 'medium'\n                    ? (darkMode ? '#fbbf24' : '#d97706')\n                    : (darkMode ? '#60a5fa' : '#2563eb'),\n                marginLeft: '8px',\n                whiteSpace: 'nowrap',\n              }}>\n                {conflict.severity}\n              </span>\n            </div>\n            <div style={{ fontSize: '12px', color: labelColor }}>\n              <div>Source A: {conflict.sourceA.document} &mdash; {conflict.sourceA.section}</div>\n              <div>Source B: {conflict.sourceB.document} &mdash; {conflict.sourceB.section}</div>\n            </div>\n          </div>\n        ))}\n\n        {/* Back button */}\n        <button\n          onClick={onReset}\n          style={{\n            width: '100%',\n            padding: '12px',\n            borderRadius: '8px',\n            border: `1px solid ${darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.15)'}`,\n            backgroundColor: 'transparent',\n            color: darkMode ? '#e2e8f0' : '#1e293b',\n            fontWeight: 600,\n            fontSize: '14px',\n            cursor: 'pointer',\n            marginTop: '8px',\n          }}\n        >\n          Back to Configuration\n        </button>\n      </div>\n    );\n  };\n\n  const renderReviewView = () => {\n    if (!session?.parsedPlan || !session.reviewState) return null;\n    const { parsedPlan, reviewState } = session;\n    const questions = parsedPlan.questions || [];\n    const answeredCount = Object.keys(reviewState.questionAnswers).length;\n    const totalQuestions = questions.length;\n\n    return (\n      <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>\n        {/* Header strip */}\n        <div style={{\n          padding: '12px 20px',\n          borderBottom: `1px solid ${darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'}`,\n          display: 'flex',\n          gap: '8px',\n          flexWrap: 'wrap',\n          alignItems: 'center',\n          fontSize: '12px',\n        }}>\n          <span style={{\n            padding: '3px 10px',\n            borderRadius: '10px',\n            backgroundColor: darkMode ? 'rgba(167,139,250,0.15)' : 'rgba(124,58,237,0.08)',\n            color: darkMode ? '#c4b5fd' : '#6d28d9',\n            fontWeight: 600,\n          }}>\n            {session.briefing.type}\n          </span>\n          <span style={{\n            padding: '3px 10px',\n            borderRadius: '10px',\n            backgroundColor: darkMode ? 'rgba(96,165,250,0.15)' : 'rgba(59,130,246,0.08)',\n            color: darkMode ? '#93c5fd' : '#2563eb',\n            fontWeight: 600,\n          }}>\n            {AUTO_DECK_LOD_LEVELS[parsedPlan.metadata.lod]?.label}\n          </span>\n          <span style={{\n            padding: '3px 10px',\n            borderRadius: '10px',\n            backgroundColor: darkMode ? 'rgba(52,211,153,0.15)' : 'rgba(16,185,129,0.08)',\n            color: darkMode ? '#6ee7b7' : '#059669',\n            fontWeight: 600,\n          }}>\n            {parsedPlan.cards.length} cards\n          </span>\n          <span style={{\n            padding: '3px 10px',\n            borderRadius: '10px',\n            backgroundColor: darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.04)',\n            color: darkMode ? '#94a3b8' : '#64748b',\n          }}>\n            {parsedPlan.metadata.documentStrategy}\n          </span>\n        </div>\n\n        {/* Scrollable content */}\n        <div style={{ flex: 1, overflowY: 'auto', padding: '12px 20px' }}>\n          {/* Card list (read-only with checkboxes) */}\n          <div style={{ marginBottom: '20px' }}>\n            <div style={{ fontSize: '12px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: labelColor, marginBottom: '8px' }}>\n              Card Plan\n            </div>\n            {parsedPlan.cards.map(card => {\n              const cardState = reviewState.cardStates[card.number];\n              const isIncluded = cardState?.included !== false;\n              return (\n                <div\n                  key={card.number}\n                  style={{\n                    padding: '8px 12px',\n                    borderRadius: '6px',\n                    border: `1px solid ${darkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)'}`,\n                    backgroundColor: isIncluded\n                      ? (darkMode ? 'rgba(255,255,255,0.03)' : 'white')\n                      : (darkMode ? 'rgba(255,255,255,0.01)' : 'rgba(0,0,0,0.02)'),\n                    marginBottom: '4px',\n                    opacity: isIncluded ? 1 : 0.45,\n                    transition: 'opacity 0.15s',\n                  }}\n                >\n                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>\n                    <input\n                      type=\"checkbox\"\n                      checked={isIncluded}\n                      onChange={() => onToggleCardIncluded(card.number)}\n                      style={{ marginTop: '2px', accentColor: darkMode ? '#a78bfa' : '#7c3aed', cursor: 'pointer' }}\n                    />\n                    <div style={{ flex: 1, minWidth: 0 }}>\n                      <div style={{ fontSize: '12px', fontWeight: 600, color: darkMode ? '#e2e8f0' : '#1e293b' }}>\n                        <span style={{ color: hintColor, fontWeight: 400, marginRight: '5px' }}>{card.number}.</span>\n                        {card.title}\n                      </div>\n                      <div style={{ fontSize: '11px', color: labelColor, marginTop: '1px' }}>\n                        {card.description}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Decision questions (MCQ) */}\n          {questions.length > 0 && (\n            <div style={{ marginBottom: '20px' }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>\n                <div style={{ fontSize: '12px', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: labelColor }}>\n                  Decision Points\n                  <span style={{ fontWeight: 400, textTransform: 'none', marginLeft: '6px', fontSize: '11px', opacity: 0.7 }}>\n                    {answeredCount}/{totalQuestions} answered\n                  </span>\n                </div>\n                <button\n                  onClick={onSetAllRecommended}\n                  style={{\n                    fontSize: '11px',\n                    color: darkMode ? '#a78bfa' : '#7c3aed',\n                    background: 'none',\n                    border: 'none',\n                    cursor: 'pointer',\n                    textDecoration: 'underline',\n                    padding: 0,\n                  }}\n                >\n                  Use all recommended\n                </button>\n              </div>\n\n              {questions.map((q, qi) => {\n                const selectedKey = reviewState.questionAnswers[q.id];\n                return (\n                  <div\n                    key={q.id}\n                    style={{\n                      padding: '12px 14px',\n                      borderRadius: '8px',\n                      border: `1px solid ${\n                        !selectedKey\n                          ? (darkMode ? 'rgba(251,191,36,0.25)' : 'rgba(217,119,6,0.2)')\n                          : (darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)')\n                      }`,\n                      backgroundColor: darkMode ? 'rgba(255,255,255,0.03)' : 'white',\n                      marginBottom: '10px',\n                    }}\n                  >\n                    {/* Question context */}\n                    {q.context && (\n                      <div style={{ fontSize: '11px', color: hintColor, marginBottom: '4px', fontStyle: 'italic' }}>\n                        {q.context}\n                      </div>\n                    )}\n                    {/* Question text */}\n                    <div style={{ fontSize: '13px', fontWeight: 600, color: darkMode ? '#e2e8f0' : '#1e293b', marginBottom: '8px' }}>\n                      <span style={{ color: hintColor, fontWeight: 400, marginRight: '5px' }}>Q{qi + 1}.</span>\n                      {q.question}\n                    </div>\n                    {/* Options as radio buttons */}\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>\n                      {q.options.map(opt => {\n                        const isSelected = selectedKey === opt.key;\n                        const isRecommended = q.recommendedKey === opt.key;\n                        return (\n                          <label\n                            key={opt.key}\n                            style={{\n                              display: 'flex',\n                              alignItems: 'flex-start',\n                              gap: '8px',\n                              padding: '6px 10px',\n                              borderRadius: '6px',\n                              cursor: 'pointer',\n                              backgroundColor: isSelected\n                                ? (darkMode ? 'rgba(167,139,250,0.12)' : 'rgba(124,58,237,0.06)')\n                                : 'transparent',\n                              border: `1px solid ${isSelected\n                                ? (darkMode ? 'rgba(167,139,250,0.3)' : 'rgba(124,58,237,0.2)')\n                                : 'transparent'}`,\n                              transition: 'all 0.15s',\n                            }}\n                          >\n                            <input\n                              type=\"radio\"\n                              name={q.id}\n                              checked={isSelected}\n                              onChange={() => onSetQuestionAnswer(q.id, opt.key)}\n                              style={{ marginTop: '2px', accentColor: darkMode ? '#a78bfa' : '#7c3aed', cursor: 'pointer' }}\n                            />\n                            <div style={{ flex: 1 }}>\n                              <span style={{ fontSize: '12px', color: darkMode ? '#e2e8f0' : '#1e293b' }}>\n                                {opt.label}\n                              </span>\n                              {isRecommended && (\n                                <span style={{\n                                  fontSize: '10px',\n                                  fontWeight: 600,\n                                  marginLeft: '6px',\n                                  padding: '1px 6px',\n                                  borderRadius: '8px',\n                                  backgroundColor: darkMode ? 'rgba(52,211,153,0.15)' : 'rgba(16,185,129,0.1)',\n                                  color: darkMode ? '#6ee7b7' : '#059669',\n                                }}>\n                                  Recommended\n                                </span>\n                              )}\n                            </div>\n                          </label>\n                        );\n                      })}\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n\n          {/* General comment (escape hatch) */}\n          <div style={{ marginBottom: '16px' }}>\n            <div style={{ fontSize: '12px', fontWeight: 600, color: labelColor, marginBottom: '6px' }}>\n              General feedback (optional)\n            </div>\n            <textarea\n              value={reviewState.generalComment}\n              onChange={(e) => onSetGeneralComment(e.target.value)}\n              placeholder=\"Any overall comments about the plan...\"\n              rows={2}\n              style={{\n                width: '100%',\n                padding: '8px 10px',\n                borderRadius: '8px',\n                border: `1px solid ${inputBorder}`,\n                backgroundColor: inputBg,\n                color: inputColor,\n                fontSize: '12px',\n                resize: 'vertical',\n                outline: 'none',\n              }}\n            />\n          </div>\n        </div>\n\n        {/* Sticky bottom bar */}\n        <div style={{\n          padding: '12px 20px',\n          borderTop: `1px solid ${darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'}`,\n          display: 'flex',\n          gap: '10px',\n          alignItems: 'center',\n          backgroundColor: darkMode ? 'rgb(24,24,27)' : 'white',\n        }}>\n          {session.revisionCount > 0 && (\n            <span style={{ fontSize: '11px', color: hintColor, marginRight: 'auto' }}>\n              Revision {session.revisionCount} of {AUTO_DECK_LIMITS.maxRevisions}\n            </span>\n          )}\n          <div style={{ flex: session.revisionCount > 0 ? undefined : 1 }} />\n          <button\n            onClick={onRevisePlan}\n            disabled={session.revisionCount >= AUTO_DECK_LIMITS.maxRevisions}\n            style={{\n              padding: '10px 20px',\n              borderRadius: '8px',\n              border: `1px solid ${darkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)'}`,\n              backgroundColor: 'transparent',\n              color: session.revisionCount >= AUTO_DECK_LIMITS.maxRevisions\n                ? (darkMode ? '#64748b' : '#94a3b8')\n                : (darkMode ? '#e2e8f0' : '#1e293b'),\n              fontWeight: 600,\n              fontSize: '13px',\n              cursor: session.revisionCount >= AUTO_DECK_LIMITS.maxRevisions ? 'not-allowed' : 'pointer',\n            }}\n          >\n            Revise Plan\n          </button>\n          <button\n            onClick={onApprovePlan}\n            disabled={includedCount === 0}\n            style={{\n              padding: '10px 20px',\n              borderRadius: '8px',\n              border: 'none',\n              backgroundColor: includedCount > 0\n                ? (darkMode ? '#7c3aed' : '#6d28d9')\n                : (darkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'),\n              color: includedCount > 0 ? 'white' : (darkMode ? '#64748b' : '#94a3b8'),\n              fontWeight: 600,\n              fontSize: '13px',\n              cursor: includedCount > 0 ? 'pointer' : 'not-allowed',\n            }}\n          >\n            Submit ({includedCount})\n          </button>\n        </div>\n      </div>\n    );\n  };\n\n  const renderCompleteView = () => (\n    <div style={{\n      flex: 1,\n      display: 'flex',\n      flexDirection: 'column',\n      alignItems: 'center',\n      justifyContent: 'center',\n      gap: '16px',\n      padding: '40px',\n    }}>\n      {/* Success icon */}\n      <div style={{\n        width: '48px',\n        height: '48px',\n        borderRadius: '50%',\n        backgroundColor: darkMode ? 'rgba(52,211,153,0.15)' : 'rgba(16,185,129,0.1)',\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n      }}>\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={darkMode ? '#6ee7b7' : '#059669'} strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n          <polyline points=\"20 6 9 17 4 12\" />\n        </svg>\n      </div>\n      <div style={{ fontSize: '16px', fontWeight: 600, color: darkMode ? '#e2e8f0' : '#1e293b', textAlign: 'center' }}>\n        {session?.producedCards.length || 0} cards generated\n      </div>\n      <div style={{ fontSize: '13px', color: labelColor, textAlign: 'center' }}>\n        Cards have been added to the card list. Select a card and use the Assets Panel to generate images.\n      </div>\n      <button\n        onClick={onReset}\n        style={{\n          padding: '10px 24px',\n          borderRadius: '8px',\n          border: `1px solid ${darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.15)'}`,\n          backgroundColor: 'transparent',\n          color: darkMode ? '#e2e8f0' : '#1e293b',\n          fontWeight: 600,\n          fontSize: '13px',\n          cursor: 'pointer',\n          marginTop: '8px',\n        }}\n      >\n        Start New Deck\n      </button>\n    </div>\n  );\n\n  const renderErrorView = () => (\n    <div style={{\n      flex: 1,\n      display: 'flex',\n      flexDirection: 'column',\n      alignItems: 'center',\n      justifyContent: 'center',\n      gap: '16px',\n      padding: '40px',\n    }}>\n      <div style={{\n        width: '48px',\n        height: '48px',\n        borderRadius: '50%',\n        backgroundColor: darkMode ? 'rgba(239,68,68,0.15)' : 'rgba(239,68,68,0.1)',\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n      }}>\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={darkMode ? '#f87171' : '#dc2626'} strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n          <circle cx=\"12\" cy=\"12\" r=\"10\" />\n          <line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\" />\n          <line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\" />\n        </svg>\n      </div>\n      <div style={{ fontSize: '14px', fontWeight: 500, color: darkMode ? '#f87171' : '#dc2626', textAlign: 'center' }}>\n        {session?.error || 'An error occurred.'}\n      </div>\n      <div style={{ display: 'flex', gap: '10px' }}>\n        <button\n          onClick={onReset}\n          style={{\n            padding: '8px 20px',\n            borderRadius: '6px',\n            border: `1px solid ${darkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.15)'}`,\n            backgroundColor: 'transparent',\n            color: darkMode ? '#e2e8f0' : '#1e293b',\n            fontSize: '13px',\n            cursor: 'pointer',\n          }}\n        >\n          Start Over\n        </button>\n        {session?.parsedPlan && (\n          <button\n            onClick={onRetryFromReview}\n            style={{\n              padding: '8px 20px',\n              borderRadius: '6px',\n              border: 'none',\n              backgroundColor: darkMode ? '#7c3aed' : '#6d28d9',\n              color: 'white',\n              fontSize: '13px',\n              fontWeight: 600,\n              cursor: 'pointer',\n            }}\n          >\n            Back to Review\n          </button>\n        )}\n      </div>\n    </div>\n  );\n\n  const renderContent = () => {\n    switch (status) {\n      case 'configuring':\n        // Show requirements checklist when documents are missing\n        if (availableDocs.length === 0) {\n          return (\n            <div className=\"flex-1 flex flex-col items-center justify-center text-center px-8\">\n              <PanelRequirements level=\"sources\" />\n            </div>\n          );\n        }\n        return renderConfigView();\n      case 'planning': return renderLoadingView('Analyzing documents and building card plan...');\n      case 'revising': return renderLoadingView('Revising plan based on your feedback...');\n      case 'finalizing': return renderLoadingView('Finalizing plan with your decisions...');\n      case 'producing': return renderLoadingView('Writing card content...');\n      case 'conflict': return renderConflictView();\n      case 'reviewing': return renderReviewView();\n      case 'complete': return renderCompleteView();\n      case 'error': return renderErrorView();\n      default:\n        if (availableDocs.length === 0) {\n          return (\n            <div className=\"flex-1 flex flex-col items-center justify-center text-center px-8\">\n              <PanelRequirements level=\"sources\" />\n            </div>\n          );\n        }\n        return renderConfigView();\n    }\n  };\n\n  return (\n    <>\n      {/* Strip button */}\n      <button\n        ref={stripRef}\n        data-panel-strip\n        onClick={onToggle}\n        className=\"flex flex-col items-center pt-2 pb-1 overflow-hidden rounded-l-lg shadow-[5px_0_10px_rgba(0,0,0,0.35)] shrink-0 w-10 cursor-pointer -ml-2.5 z-[1] relative\"\n        style={{ backgroundColor: stripBg }}\n      >\n        <div className=\"w-8 shrink-0 flex items-center justify-center\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-white\">\n            <rect x=\"2\" y=\"3\" width=\"20\" height=\"18\" rx=\"2\" />\n            <line x1=\"8\" y1=\"7\" x2=\"16\" y2=\"7\" />\n            <line x1=\"8\" y1=\"11\" x2=\"16\" y2=\"11\" />\n            <line x1=\"8\" y1=\"15\" x2=\"12\" y2=\"15\" />\n          </svg>\n        </div>\n        <span className=\"text-[13px] font-bold uppercase tracking-wider text-white mt-2\" style={{ writingMode: 'vertical-lr', transform: 'rotate(180deg)' } as React.CSSProperties}>Auto-Deck</span>\n      </button>\n\n      {/* Portal overlay */}\n      {shouldRender && createPortal(\n        <div\n          data-panel-overlay\n          className=\"fixed z-[104] flex flex-col bg-white dark:bg-zinc-900 border-4 rounded-r-lg shadow-[5px_0_6px_rgba(0,0,0,0.35)] overflow-hidden\"\n          style={{\n            borderColor,\n            transformOrigin: 'left',\n            ...(!isOpen && !isClosing\n              ? { display: 'none' }\n              : { animation: `${isClosing ? 'panel-roll-in' : 'panel-roll-out'} 0.4s ease-out forwards` }\n            ),\n            top: stripRef.current?.getBoundingClientRect().top ?? 0,\n            left: stripRef.current?.getBoundingClientRect().right ?? 0,\n            height: stripRef.current?.getBoundingClientRect().height ?? 0,\n            width: overlayWidth,\n          }}\n        >\n          {/* Resize handle */}\n          <div\n            onMouseDown={handleResizeStart}\n            className=\"absolute right-0 top-0 bottom-0 w-1.5 cursor-ew-resize z-10 hover:bg-black/10 transition-colors\"\n          />\n\n          {/* Document list bar — hover opens, click locks (matches ChatPanel) */}\n          {availableDocs.length > 0 && (\n            <>\n            <div className=\"shrink-0 border-y border-zinc-100 dark:border-zinc-700 flex items-center justify-between\">\n              <div\n                ref={adDocToggleRef}\n                className=\"flex items-center gap-1.5 px-3 py-1.5 cursor-pointer\"\n                onMouseEnter={() => {\n                  if (adDocListOpen && adDocListMode === 'locked') return;\n                  setAdDocListMode('hover');\n                  setAdDocListOpen(true);\n                }}\n                onMouseLeave={(e) => {\n                  if (adDocListMode === 'locked') return;\n                  const related = e.relatedTarget as Node | null;\n                  if (adDocListRef.current && related && adDocListRef.current.contains(related)) return;\n                  setAdDocListOpen(false);\n                }}\n                onClick={() => {\n                  if (adDocListOpen && adDocListMode === 'locked') {\n                    setAdDocListOpen(false);\n                  } else {\n                    setAdDocListMode('locked');\n                    setAdDocListOpen(true);\n                  }\n                }}\n              >\n                <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>Select Active Documents</span>\n                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{selectedDocs.length}</span>\n                <div className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200\">\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <polyline points={adDocListOpen ? \"18 15 12 9 6 15\" : \"6 9 12 15 18 9\"} />\n                  </svg>\n                </div>\n              </div>\n              {session && status !== 'configuring' && (\n                <button\n                  onClick={onReset}\n                  className=\"text-[11px] text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200 underline px-3 py-1.5 shrink-0\"\n                >\n                  Reset\n                </button>\n              )}\n            </div>\n\n            {/* Document list popup — portaled to body */}\n            {adDocListOpen && createPortal(\n              <div\n                ref={adDocListRef}\n                className=\"fixed z-[120]\"\n                style={{\n                  ...(adDocToggleRef.current ? (() => {\n                    const r = adDocToggleRef.current.getBoundingClientRect();\n                    return { top: r.bottom, left: r.left };\n                  })() : {}),\n                }}\n                onMouseLeave={(e) => {\n                  if (adDocListMode === 'locked') return;\n                  const related = e.relatedTarget as Node | null;\n                  if (adDocToggleRef.current && related && adDocToggleRef.current.contains(related)) return;\n                  setAdDocListOpen(false);\n                }}\n              >\n                <div\n                  className=\"bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-2 px-1 max-h-[50vh] overflow-y-auto mt-1\"\n                  style={{ scrollbarWidth: 'thin' as const }}\n                >\n                  {orderedDocs.map(doc => {\n                    const isIncluded = docIncluded[doc.id];\n                    return (\n                      <div\n                        key={doc.id}\n                        className={`flex items-center gap-1.5 px-3 py-1.5 cursor-pointer select-none transition-colors rounded-lg ${isIncluded ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400'} hover:bg-zinc-100 dark:hover:bg-zinc-700`}\n                        onClick={(e) => { e.stopPropagation(); handleDocToggle(doc.id); }}\n                      >\n                        <button\n                          className={`shrink-0 w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors ${\n                            isIncluded ? 'border-zinc-300 dark:border-zinc-600 bg-zinc-900' : 'border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 hover:border-zinc-300 dark:hover:border-zinc-600'\n                          }`}\n                        >\n                          {isIncluded && (\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><polyline points=\"20 6 9 17 4 12\" /></svg>\n                          )}\n                        </button>\n                        <span className=\"text-[11px] truncate block flex-1 min-w-0\">{doc.name}</span>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>,\n              document.body\n            )}\n            </>\n          )}\n\n          {/* View content */}\n          {renderContent()}\n        </div>,\n        document.body,\n      )}\n\n      {/* Pulse animation keyframes */}\n      <style>{`\n        @keyframes autodeck-pulse {\n          0%, 100% { transform: scale(0.8); opacity: 0.5; }\n          50% { transform: scale(1.2); opacity: 1; }\n        }\n      `}</style>\n    </>\n  );\n};\n\nexport default AutoDeckPanel;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\CardsPanel.tsx","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":45,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":45,"endColumn":53,"fix":{"range":[2017,2032],"text":"{return content;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":113,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":113,"endColumn":37,"fix":{"range":[3996,4003],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":120,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":120,"endColumn":37,"fix":{"range":[4302,4309],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":129,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":129,"endColumn":32,"fix":{"range":[4604,4614],"text":"{return '';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":144,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":144,"endColumn":37,"fix":{"range":[5110,5117],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":150,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":150,"endColumn":29,"fix":{"range":[5349,5356],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":186,"column":101,"nodeType":"Literal","messageId":"noMagic","endLine":186,"endColumn":103},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":195,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":195,"endColumn":26,"fix":{"range":[7220,7227],"text":"{return;}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":278,"column":8,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":305,"endColumn":8},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":347,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":347,"endColumn":60,"fix":{"range":[14562,14578],"text":"{commitNewCard();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":348,"column":45,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":348,"endColumn":73,"fix":{"range":[14623,14651],"text":"{setShowNewCardDialog(false);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":9,"source":"\nimport React, { useRef, useCallback, useState, useMemo, useEffect, forwardRef, useImperativeHandle } from 'react';\nimport { Card, DetailLevel, UploadedFile } from '../types';\nimport InsightsCardList from './InsightsCardList';\nimport DocumentEditorModal, { DocumentEditorHandle } from './DocumentEditorModal';\nimport { UnsavedChangesDialog } from './Dialogs';\n\nconst DEFAULT_SIDEBAR_WIDTH = 220;\nconst MIN_SIDEBAR_WIDTH = 140;\nconst MAX_SIDEBAR_WIDTH = 480;\n\ninterface CardsPanelProps {\n  cards: Card[];\n  activeCardId: string | null;\n  hasSelectedNugget: boolean;\n  onCardClick: (id: string) => void;\n  onCardDoubleClick?: (id: string) => void;\n  onToggleSelection: (id: string) => void;\n  onSelectExclusive: (id: string) => void;\n  onSelectRange: (fromId: string, toId: string) => void;\n  onSelectAll: () => void;\n  onDeselectAll: () => void;\n  onDeleteCard: (id: string) => void;\n  onDeleteSelectedCards: () => void;\n  onRenameCard: (id: string, newName: string) => void;\n  onCopyMoveCard?: (cardId: string, targetNuggetId: string, mode: 'copy' | 'move') => void;\n  otherNuggets?: { id: string; name: string }[];\n  projectNuggets?: { projectId: string; projectName: string; nuggets: { id: string; name: string }[] }[];\n  onCreateNuggetForCard?: (nuggetName: string, cardId: string | null) => void;\n  onCreateCustomCard: (name: string) => void;\n  onSaveCardContent: (cardId: string, level: DetailLevel, newContent: string) => void;\n  detailLevel: DetailLevel;\n  onGenerateCardImage?: (card: Card) => void;\n  onReorderCards?: (fromIndex: number, toIndex: number) => void;\n}\n\n/** Ensure markdown content starts with an H1 heading matching cardTitle.\n *  - If no H1 exists, prepend one using cardTitle.\n *  - If an H1 exists but differs from cardTitle, replace it. */\nfunction ensureH1(content: string, cardTitle: string): string {\n  const trimmed = content.trimStart();\n  const h1Match = trimmed.match(/^#\\s+(.+)$/m);\n  if (h1Match) {\n    const existingTitle = h1Match[1].trim();\n    if (existingTitle === cardTitle) return content; // already synced\n    // Replace first H1 with current card title\n    return content.replace(/^#\\s+.+$/m, `# ${cardTitle}`);\n  }\n  return `# ${cardTitle}\\n\\n${content}`;\n}\n\n/** Extract the first H1 text from markdown content. */\nfunction extractH1(markdown: string): string | null {\n  const match = markdown.match(/^#\\s+(.+)$/m);\n  return match ? match[1].trim() : null;\n}\n\nexport interface PanelEditorHandle {\n  isDirty: boolean;\n  save: () => void;\n  discard: () => void;\n}\n\nconst CardsPanel = forwardRef<PanelEditorHandle, CardsPanelProps>(({\n  cards,\n  activeCardId,\n  hasSelectedNugget,\n  onCardClick,\n  onCardDoubleClick,\n  onToggleSelection,\n  onSelectExclusive,\n  onSelectRange,\n  onSelectAll,\n  onDeselectAll,\n  onDeleteCard,\n  onDeleteSelectedCards,\n  onRenameCard,\n  onCopyMoveCard,\n  otherNuggets,\n  projectNuggets,\n  onCreateNuggetForCard,\n  onCreateCustomCard,\n  onSaveCardContent,\n  detailLevel,\n  onGenerateCardImage,\n  onReorderCards,\n}, ref) => {\n  const editorHandleRef = useRef<DocumentEditorHandle>(null);\n\n  useImperativeHandle(ref, () => ({\n    get isDirty() { return editorHandleRef.current?.isDirty ?? false; },\n    save: () => editorHandleRef.current?.save(),\n    discard: () => editorHandleRef.current?.discard(),\n  }), []);\n  const [pendingAction, setPendingAction] = useState<(() => void) | null>(null);\n\n  // ── Sidebar resize state ──\n  const [sidebarWidth, setSidebarWidth] = useState(DEFAULT_SIDEBAR_WIDTH);\n  const isDragging = useRef(false);\n  const startX = useRef(0);\n  const startWidth = useRef(0);\n\n  // ── Divider drag handlers ──\n  const handleDividerPointerDown = useCallback((e: React.PointerEvent) => {\n    e.preventDefault();\n    isDragging.current = true;\n    startX.current = e.clientX;\n    startWidth.current = sidebarWidth;\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, [sidebarWidth]);\n\n  const handleDividerPointerMove = useCallback((e: React.PointerEvent) => {\n    if (!isDragging.current) return;\n    const delta = e.clientX - startX.current;\n    const newWidth = Math.min(MAX_SIDEBAR_WIDTH, Math.max(MIN_SIDEBAR_WIDTH, startWidth.current + delta));\n    setSidebarWidth(newWidth);\n  }, []);\n\n  const handleDividerPointerUp = useCallback((e: React.PointerEvent) => {\n    if (!isDragging.current) return;\n    isDragging.current = false;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n  }, []);\n\n  const activeCard = activeCardId ? cards.find(c => c.id === activeCardId) : null;\n\n  // Prepare content with guaranteed H1\n  const editorContent = useMemo(() => {\n    if (!activeCard) return '';\n    const raw = activeCard.synthesisMap?.[detailLevel] || '';\n    return ensureH1(raw, activeCard.text);\n  }, [activeCard, detailLevel]);\n\n  // Unsaved-changes gating: if editor is dirty, show dialog before running action\n  const gatedAction = useCallback((action: () => void) => {\n    if (editorHandleRef.current?.isDirty) {\n      setPendingAction(() => action);\n    } else {\n      action();\n    }\n  }, []);\n\n  const handleCardClick = useCallback((id: string) => {\n    if (id === activeCardId) return;\n    gatedAction(() => onCardClick(id));\n  }, [activeCardId, gatedAction, onCardClick]);\n\n  // On save: extract H1 → sync card title, then save content\n  const handleSave = useCallback((newContent: string) => {\n    if (!activeCard) return;\n    // Extract H1 from saved markdown and sync to card title\n    const h1Text = extractH1(newContent);\n    if (h1Text && h1Text !== activeCard.text) {\n      onRenameCard(activeCard.id, h1Text);\n    }\n    onSaveCardContent(activeCard.id, detailLevel, newContent);\n  }, [activeCard, detailLevel, onSaveCardContent, onRenameCard]);\n\n  // Wrap onRenameCard: when the active card is renamed from the list, also update the live editor H1\n  const handleRenameCard = useCallback((id: string, newName: string) => {\n    onRenameCard(id, newName);\n    // If renaming the currently open card, update the live editor's H1\n    if (id === activeCardId) {\n      editorHandleRef.current?.updateH1(newName);\n    }\n  }, [onRenameCard, activeCardId]);\n\n  // ── Gated wrappers for destructive/unmounting actions ──\n  const handleDeleteCard = useCallback((id: string) => {\n    gatedAction(() => onDeleteCard(id));\n  }, [gatedAction, onDeleteCard]);\n\n  const handleDeleteSelectedCards = useCallback(() => {\n    gatedAction(() => onDeleteSelectedCards());\n  }, [gatedAction, onDeleteSelectedCards]);\n\n  const handleReorderCards = useCallback((fromIndex: number, toIndex: number) => {\n    gatedAction(() => onReorderCards?.(fromIndex, toIndex));\n  }, [gatedAction, onReorderCards]);\n\n  // ── New custom card dialog state ──\n  const [showNewCardDialog, setShowNewCardDialog] = useState(false);\n  const [newCardName, setNewCardName] = useState('');\n  const newCardInputRef = useRef<HTMLInputElement>(null);\n  useEffect(() => {\n    if (showNewCardDialog) { setNewCardName(''); setTimeout(() => newCardInputRef.current?.focus(), 50); }\n  }, [showNewCardDialog]);\n\n  const handleCreateCustomCard = useCallback(() => {\n    gatedAction(() => setShowNewCardDialog(true));\n  }, [gatedAction]);\n\n  const commitNewCard = useCallback(() => {\n    const trimmed = newCardName.trim();\n    if (!trimmed) return;\n    onCreateCustomCard(trimmed);\n    setShowNewCardDialog(false);\n  }, [newCardName, onCreateCustomCard]);\n\n  // Card list rendered inside the editor's sidebar slot\n  const cardListSidebar = (\n    <div className=\"px-2 pb-4\">\n      <InsightsCardList\n        cards={cards}\n        activeCardId={activeCardId}\n        onCardClick={handleCardClick}\n        onCardDoubleClick={onCardDoubleClick}\n        onToggleSelection={onToggleSelection}\n        onSelectExclusive={(id) => {\n          if (id === activeCardId) {\n            onSelectExclusive(id);\n          } else {\n            gatedAction(() => { onSelectExclusive(id); onCardClick(id); });\n          }\n        }}\n        onSelectRange={onSelectRange}\n        onSelectAll={onSelectAll}\n        onDeselectAll={onDeselectAll}\n        onDeleteCard={handleDeleteCard}\n        onDeleteSelectedCards={handleDeleteSelectedCards}\n        onRenameCard={handleRenameCard}\n        onCopyMoveCard={onCopyMoveCard}\n        otherNuggets={otherNuggets}\n        projectNuggets={projectNuggets}\n        onCreateNuggetForCard={onCreateNuggetForCard}\n        activeDetailLevel={detailLevel}\n        onGenerateCardImage={onGenerateCardImage}\n        onReorderCards={handleReorderCards}\n      />\n    </div>\n  );\n\n  // Reusable divider element\n  const divider = (\n    <div\n      className=\"shrink-0 w-1 cursor-col-resize group relative select-none\"\n      onPointerDown={handleDividerPointerDown}\n      onPointerMove={handleDividerPointerMove}\n      onPointerUp={handleDividerPointerUp}\n    >\n      {/* Visible line */}\n      <div className=\"absolute inset-y-0 left-0 w-px bg-zinc-100 dark:bg-zinc-700 group-hover:bg-zinc-300 dark:group-hover:bg-zinc-600 transition-colors\" />\n      {/* Wider hit target */}\n      <div className=\"absolute inset-y-0 -left-1 w-3\" />\n    </div>\n  );\n\n  return (\n    <div className=\"-ml-[4px] border border-zinc-200 dark:border-zinc-700 shadow-[0_1px_3px_rgba(0,0,0,0.06),0_4px_12px_rgba(0,0,0,0.04)] relative z-[103] flex flex-col bg-white dark:bg-zinc-900 overflow-hidden flex-1 min-w-0\">\n      {/* Header */}\n      <div className=\"shrink-0 flex flex-row items-center pt-2 pb-1 select-none\">\n        <div className=\"w-8 shrink-0 flex items-center justify-center\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-zinc-500 dark:text-zinc-400\">\n            <rect width=\"16\" height=\"16\" x=\"3\" y=\"3\" rx=\"2\" ry=\"2\"/>\n            <path d=\"M3 9h18\"/><path d=\"M9 21V9\"/>\n          </svg>\n        </div>\n        <span className=\"text-[13px] font-bold uppercase tracking-wider text-zinc-800 dark:text-zinc-200\">Cards</span>\n      </div>\n\n      {/* Custom Card bar — whole row is clickable */}\n      <div className=\"shrink-0 border-y border-zinc-100 dark:border-zinc-700\">\n        <button\n          onClick={handleCreateCustomCard}\n          className=\"w-full flex items-center gap-1.5 px-3 py-1.5 cursor-pointer transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-800\"\n        >\n          <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 flex-1 min-w-0 text-left\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>+ Add Custom Card</span>\n          <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{cards.length}</span>\n          <span className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center text-zinc-600 dark:text-zinc-400\">\n            <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\n            </svg>\n          </span>\n        </button>\n      </div>\n\n      {/* Content area: always show editor with sidebar */}\n      {hasSelectedNugget ? (\n        activeCard ? (\n          <DocumentEditorModal\n            ref={editorHandleRef}\n            key={`${activeCardId}-${detailLevel}`}\n            document={{ id: activeCard.id, name: activeCard.text, content: editorContent } as UploadedFile}\n            mode=\"inline\"\n            sidebarContent={cardListSidebar}\n            sidebarWidth={sidebarWidth}\n            sidebarDivider={divider}\n            onSave={handleSave}\n            onClose={() => {}}\n          />\n        ) : (\n          <div className=\"flex-1 flex overflow-hidden\">\n            {/* Show card list even when no card is selected */}\n            <aside className=\"shrink-0 border-r border-zinc-100 dark:border-zinc-700 overflow-y-auto bg-white dark:bg-zinc-900\" style={{ width: sidebarWidth }}>\n              {cardListSidebar}\n            </aside>\n            {divider}\n            <div className=\"flex-1 flex items-center justify-center\">\n              <p className=\"text-[11px] text-zinc-500 dark:text-zinc-400 font-light\">Select a card to edit</p>\n            </div>\n          </div>\n        )\n      ) : (\n        <div className=\"flex-1\" />\n      )}\n\n      {/* Unsaved changes dialog */}\n      {pendingAction && (\n        <UnsavedChangesDialog\n          onSave={() => {\n            editorHandleRef.current?.save();\n            const action = pendingAction;\n            setPendingAction(null);\n            action();\n          }}\n          onDiscard={() => {\n            editorHandleRef.current?.discard();\n            const action = pendingAction;\n            setPendingAction(null);\n            action();\n          }}\n          onCancel={() => setPendingAction(null)}\n        />\n      )}\n\n      {/* New custom card name dialog */}\n      {showNewCardDialog && (\n        <div className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60 animate-in fade-in duration-300\" onClick={() => setShowNewCardDialog(false)}>\n          <div className=\"w-full max-w-sm bg-white dark:bg-zinc-900 rounded-[40px] p-10 shadow-2xl dark:shadow-black/30 border border-zinc-100 dark:border-zinc-700 animate-in zoom-in-95 duration-300\" onClick={(e) => e.stopPropagation()}>\n            <div className=\"space-y-6 text-center\">\n              <div className=\"w-16 h-16 flex items-center justify-center mx-auto\">\n                <svg width=\"36\" height=\"36\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-black\">\n                  <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/><line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"16\"/><line x1=\"8\" y1=\"12\" x2=\"16\" y2=\"12\"/>\n                </svg>\n              </div>\n              <div className=\"space-y-2\">\n                <h3 className=\"text-[15px] font-black tracking-tight text-zinc-800 dark:text-zinc-200\">New Custom Card</h3>\n                <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light leading-relaxed\">Enter a name for the new card.</p>\n              </div>\n              <div className=\"text-left space-y-1.5\">\n                <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Card Name</label>\n                <input\n                  ref={newCardInputRef}\n                  value={newCardName}\n                  onChange={(e) => setNewCardName(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter') commitNewCard();\n                    if (e.key === 'Escape') setShowNewCardDialog(false);\n                  }}\n                  placeholder=\"Enter a name for this card\"\n                  className=\"w-full px-4 py-3 rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-500\"\n                />\n              </div>\n              <div className=\"flex flex-col space-y-3 pt-4\">\n                <button\n                  onClick={commitNewCard}\n                  disabled={!newCardName.trim()}\n                  className=\"w-full py-4 rounded-full bg-black text-white text-[10px] font-black uppercase tracking-widest hover:scale-[1.02] transition-all disabled:opacity-40 disabled:cursor-not-allowed\"\n                >\n                  Create Card\n                </button>\n                <button\n                  onClick={() => setShowNewCardDialog(false)}\n                  className=\"w-full py-2 text-zinc-600 dark:text-zinc-400 text-[10px] font-bold uppercase tracking-widest hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n                >\n                  Cancel\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n});\n\nexport default CardsPanel;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\ChatPanel.tsx","messages":[{"ruleId":"import/order","severity":1,"message":"`../context/AppContext` import should occur before import of `./Dialogs`","line":8,"column":1,"nodeType":"ImportDeclaration","endLine":8,"endColumn":55,"fix":{"range":[232,390],"text":"import { useAppContext } from '../context/AppContext';\nimport { DocumentChangeNotice } from './Dialogs';\nimport PanelRequirements from './PanelRequirements';\n"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":51,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":51,"endColumn":63},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'shouldRender'. Either include it or remove the dependency array.","line":54,"column":6,"nodeType":"ArrayExpression","endLine":54,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, shouldRender]","fix":{"range":[1743,1751],"text":"[isOpen, shouldRender]"}}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":55,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":55,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 750.","line":55,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":55,"endColumn":62},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":58,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":58,"endColumn":64,"fix":{"range":[1959,1990],"text":"{setOverlayWidth(DEFAULT_WIDTH);}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DEFAULT_WIDTH'. Either include it or remove the dependency array.","line":58,"column":68,"nodeType":"ArrayExpression","endLine":58,"endColumn":76,"suggestions":[{"desc":"Update the dependencies array to be: [DEFAULT_WIDTH, isOpen]","fix":{"range":[1994,2002],"text":"[DEFAULT_WIDTH, isOpen]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":70,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":70,"endColumn":45,"fix":{"range":[2541,2548],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":71,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":71,"endColumn":35},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":140,"column":42,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":140,"endColumn":96,"fix":{"range":[5709,5763],"text":"`${Math.min(textareaRef.current.scrollHeight, 160)  }px`"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 160.","line":140,"column":85,"nodeType":"Literal","messageId":"noMagic","endLine":140,"endColumn":88},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":146,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":146,"endColumn":48,"fix":{"range":[5906,5913],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":161,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":161,"endColumn":48,"fix":{"range":[6520,6527],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":184,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":184,"endColumn":58,"fix":{"range":[7328,7335],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":187,"column":74,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":187,"endColumn":81,"fix":{"range":[7493,7500],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":188,"column":70,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":188,"endColumn":77,"fix":{"range":[7570,7577],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":197,"column":24,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":197,"endColumn":31,"fix":{"range":[7866,7873],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":218,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":218,"endColumn":61,"fix":{"range":[8703,8734],"text":"{return `**You:** ${m.content}`;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":219,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":219,"endColumn":56,"fix":{"range":[8766,8790],"text":"{return `> ${m.content}`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1500.","line":225,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":225,"endColumn":46},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'startEditing' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":229,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":229,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1500.","line":243,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":243,"endColumn":48},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":249,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":249,"endColumn":59,"fix":{"range":[9725,9767],"text":"{return { body: content, suggestions: [] };}"}},{"ruleId":"react/no-danger","severity":1,"message":"Dangerous property 'dangerouslySetInnerHTML' found","line":260,"column":55,"nodeType":"JSXAttribute","messageId":"dangerousProp","endLine":260,"endColumn":97},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":271,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":271,"endColumn":47,"fix":{"range":[10511,10530],"text":"{next.delete(msgId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":272,"column":12,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":272,"endColumn":28,"fix":{"range":[10542,10558],"text":"{next.add(msgId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":281,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":281,"endColumn":90,"fix":{"range":[10845,10917],"text":"{return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });}"}},{"ruleId":"react/jsx-no-useless-fragment","severity":1,"message":"Passing a fragment to an HTML element is useless.","line":322,"column":7,"nodeType":"JSXFragment","messageId":"ChildOfHtmlElement","endLine":801,"endColumn":8,"fix":{"range":[12952,39072],"text":"{/* Document list bar — hover opens, click locks (same as SourcesPanel) */}\n      {documents.length > 0 && (\n        <>\n        <div className=\"shrink-0 border-y border-zinc-100 dark:border-zinc-700\">\n          <div\n            ref={docToggleRef}\n            className=\"flex items-center gap-1.5 px-3 py-1.5 cursor-pointer\"\n            onMouseEnter={() => {\n              if (docListOpen && docListMode === 'locked') return;\n              setDocListMode('hover');\n              setDocListOpen(true);\n            }}\n            onMouseLeave={(e) => {\n              if (docListMode === 'locked') return;\n              const related = e.relatedTarget as Node | null;\n              if (docListRef.current && related && docListRef.current.contains(related)) return;\n              setDocListOpen(false);\n            }}\n            onClick={() => {\n              if (docListOpen && docListMode === 'locked') {\n                setDocListOpen(false);\n              } else {\n                setDocListMode('locked');\n                setDocListOpen(true);\n              }\n            }}\n          >\n            <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>Select Active Documents</span>\n            <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{documents.length}</span>\n            {/* Chevron icon */}\n            <div className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200\">\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points={docListOpen ? \"18 15 12 9 6 15\" : \"6 9 12 15 18 9\"} />\n              </svg>\n            </div>\n          </div>\n        </div>\n\n        {/* Document list popup — portaled to body */}\n        {docListOpen && createPortal(\n          <div\n            ref={docListRef}\n            className=\"fixed z-[120]\"\n            style={{\n              ...(docToggleRef.current ? (() => {\n                const r = docToggleRef.current.getBoundingClientRect();\n                return { top: r.bottom, left: r.left };\n              })() : {}),\n            }}\n            onMouseLeave={(e) => {\n              if (docListMode === 'locked') return;\n              const related = e.relatedTarget as Node | null;\n              if (docToggleRef.current && related && docToggleRef.current.contains(related)) return;\n              setDocListOpen(false);\n            }}\n          >\n            {/* Invisible bridge padding on top, visible content inside */}\n            <div\n              className=\"bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-2 px-1 max-h-[50vh] overflow-y-auto mt-1\"\n              style={{ scrollbarWidth: 'thin' as const }}\n            >\n            {documents.map(doc => {\n              const isEnabled = doc.enabled !== false;\n              return (\n                <div\n                  key={doc.id}\n                  className={`flex items-center gap-1.5 px-3 py-1.5 cursor-pointer select-none transition-colors rounded-lg ${isEnabled ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400'} hover:bg-zinc-100 dark:hover:bg-zinc-700`}\n                  onClick={(e) => { e.stopPropagation(); onToggleDocument?.(doc.id); }}\n                >\n                  {/* Enabled checkbox */}\n                  <button\n                    className={`shrink-0 w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors ${\n                      isEnabled ? 'border-zinc-300 dark:border-zinc-600 bg-zinc-900' : 'border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 hover:border-zinc-300 dark:hover:border-zinc-600'\n                    }`}\n                  >\n                    {isEnabled && (\n                      <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><polyline points=\"20 6 9 17 4 12\" /></svg>\n                    )}\n                  </button>\n                  <span className=\"text-[11px] truncate block flex-1 min-w-0\">{doc.name}</span>\n                </div>\n              );\n            })}\n            </div>\n          </div>,\n          document.body\n        )}\n        </>\n      )}\n\n    <div className=\"flex-1 overflow-y-auto\">\n      {messages.length === 0 && (\n        <div className=\"flex flex-col items-center justify-center h-full text-center px-8\">\n          <PanelRequirements level=\"sources\" />\n          {/* Show conversation prompt only when all prerequisites are met */}\n          {documents.length > 0 && (\n            <>\n              <div className=\"w-10 h-10 bg-zinc-100 dark:bg-zinc-800/50 rounded-full flex items-center justify-center mb-3\">\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z\" />\n                </svg>\n              </div>\n              <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light max-w-xs\">\n                Ask questions about your documents, explore themes, and generate card content from the conversation.\n              </p>\n            </>\n          )}\n        </div>\n      )}\n\n      {messages.map((msg) => {\n        // System messages\n        if (msg.role === 'system') {\n          const noticeHtml = marked.parse(msg.content, { async: false }) as string;\n          return (\n            <div key={msg.id} className=\"px-5 py-2\">\n              <div className=\"rounded-xl px-4 py-3 system-notice-prose text-[11px] leading-relaxed\" style={{ backgroundColor: 'rgba(42, 159, 212, 0.06)', border: '1px solid rgba(42, 159, 212, 0.2)', color: '#1a7aaa' }} dangerouslySetInnerHTML={{ __html: noticeHtml }} />\n            </div>\n          );\n        }\n\n        // User messages\n        if (msg.role === 'user') {\n          return (\n            <div key={msg.id} className=\"group/msg px-5 py-3 flex justify-end\">\n              <div className=\"max-w-[85%]\">\n                <p className=\"text-[12px] text-zinc-800 dark:text-zinc-200 whitespace-pre-wrap leading-relaxed bg-zinc-100 dark:bg-zinc-800/50 rounded-2xl rounded-br-md px-4 py-2.5\">{msg.content}</p>\n                <div className=\"flex items-center justify-end gap-2 mt-1 opacity-0 group-hover/msg:opacity-100 transition-opacity\">\n                  <span className=\"text-[11px] text-zinc-500 dark:text-zinc-400\">{formatTime(msg.timestamp)}</span>\n                  <button\n                    onClick={() => handleCopyMessage(msg)}\n                    title=\"Copy\"\n                    className=\"p-0.5 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                  >\n                    {copiedMsgId === msg.id ? (\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M20 6L9 17l-5-5\" />\n                      </svg>\n                    ) : (\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <rect x=\"9\" y=\"9\" width=\"12\" height=\"12\" rx=\"2\" ry=\"2\" />\n                        <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\" />\n                      </svg>\n                    )}\n                  </button>\n                </div>\n              </div>\n            </div>\n          );\n        }\n\n        // Assistant messages\n        const { body, suggestions } = parseCardSuggestions(msg.content);\n        return (\n          <div key={msg.id} className=\"group/msg px-5 py-3\">\n            <div className={`max-w-[95%] ${msg.isCardContent ? 'bg-zinc-50 dark:bg-zinc-800 rounded-xl border border-zinc-300 dark:border-zinc-600 overflow-hidden' : ''}`}>\n              {/* Card content — collapsible, default collapsed */}\n              {msg.isCardContent ? (\n                <>\n                  <div className=\"flex items-center gap-2 px-4 py-2.5 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\">\n                    <button\n                      onClick={() => toggleCardExpanded(msg.id)}\n                      className=\"flex items-center gap-2 min-w-0 text-left\"\n                    >\n                      <svg\n                        width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                        className={`shrink-0 text-zinc-500 dark:text-zinc-400 transition-transform duration-150 ${expandedCards.has(msg.id) ? 'rotate-90' : ''}`}\n                      >\n                        <path d=\"m9 18 6-6-6-6\"/>\n                      </svg>\n                      <span className=\"text-[10px] font-semibold uppercase tracking-wider text-white bg-zinc-900 px-2 py-0.5 rounded-full shrink-0\">Card</span>\n                      {msg.detailLevel && (\n                        <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400 shrink-0\">{msg.detailLevel}</span>\n                      )}\n                      <span className=\"text-[11px] font-medium text-zinc-600 dark:text-zinc-400 truncate\">{extractCardTitle(body)}</span>\n                    </button>\n                    {/* Hover actions */}\n                    <div className=\"flex items-center gap-1.5 ml-auto shrink-0 opacity-0 group-hover/msg:opacity-100 transition-opacity\">\n                      <div className=\"flex items-center gap-1 px-0.5\" title=\"Card content (auto-saved)\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M20 6L9 17l-5-5\" />\n                        </svg>\n                        <span className=\"text-[10px] text-green-600/60\">Saved</span>\n                      </div>\n                      <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">{formatTime(msg.timestamp)}</span>\n                      <button\n                        onClick={(e) => { e.stopPropagation(); handleCopyMessage(msg); }}\n                        title=\"Copy\"\n                        className=\"p-0.5 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                      >\n                        {copiedMsgId === msg.id ? (\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                            <path d=\"M20 6L9 17l-5-5\" />\n                          </svg>\n                        ) : (\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                            <rect x=\"9\" y=\"9\" width=\"12\" height=\"12\" rx=\"2\" ry=\"2\" />\n                            <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\" />\n                          </svg>\n                        )}\n                      </button>\n                    </div>\n                  </div>\n                  {expandedCards.has(msg.id) && (\n                    <div className=\"px-4 pb-3\">\n                      {renderMarkdown(body)}\n                    </div>\n                  )}\n                </>\n              ) : (\n                <>\n                  {/* Content */}\n                  {renderMarkdown(body)}\n\n                  {/* Hover actions — timestamp, copy, add as card */}\n                  <div className=\"flex items-center gap-2.5 mt-2 opacity-0 group-hover/msg:opacity-100 transition-opacity\">\n                    <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">{formatTime(msg.timestamp)}</span>\n                    <button\n                      onClick={() => handleCopyMessage(msg)}\n                      title=\"Copy\"\n                      className=\"p-1 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                    >\n                      {copiedMsgId === msg.id ? (\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M20 6L9 17l-5-5\" />\n                        </svg>\n                      ) : (\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <rect x=\"9\" y=\"9\" width=\"12\" height=\"12\" rx=\"2\" ry=\"2\" />\n                          <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\" />\n                        </svg>\n                      )}\n                    </button>\n                    {/* Save as card */}\n                    {!msg.savedAsCardId ? (\n                      <button\n                        onClick={() => handleSaveCard(msg)}\n                        title=\"Add as card\"\n                        className=\"p-1 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                      >\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <rect width=\"16\" height=\"16\" x=\"3\" y=\"3\" rx=\"2\" />\n                          <path d=\"M3 9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2\" />\n                          <path d=\"M3 11h3c.8 0 1.6.3 2.1.9l1.1.9c1.6 1.6 4.1 1.6 5.7 0l1.1-.9c.5-.5 1.3-.9 2.1-.9H21\" />\n                        </svg>\n                      </button>\n                    ) : (\n                      <div className=\"flex items-center gap-1.5 px-0.5\" title=\"Saved as card\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M20 6L9 17l-5-5\" />\n                        </svg>\n                        <span className=\"text-[10px] text-green-600/60\">Saved</span>\n                      </div>\n                    )}\n                  </div>\n\n                  {suggestions.length > 0 && (\n                    <div className=\"mt-3 flex flex-wrap gap-1.5\">\n                      {suggestions.map((s, i) => (\n                        <button\n                          key={i}\n                          onClick={() => {\n                            setInputText(s);\n                            textareaRef.current?.focus();\n                          }}\n                          className=\"text-[11px] text-zinc-600 dark:text-zinc-400 bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-full px-3 py-1 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors text-left\"\n                        >\n                          {s}\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n        );\n      })}\n\n      <div ref={messagesEndRef} />\n    </div>\n\n    {/* Input area */}\n    <div className=\"shrink-0 px-4 py-3\">\n      <div className=\"rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 focus-within:ring-1 focus-within:ring-zinc-300 transition-shadow\">\n        <textarea\n          ref={textareaRef}\n          value={inputText}\n          onChange={(e) => setInputText(e.target.value)}\n          onKeyDown={handleKeyDown}\n          placeholder=\"Ask about your documents...\"\n          disabled={isLoading}\n          rows={2}\n          className=\"w-full resize-none bg-transparent px-4 pt-3 pb-1 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none disabled:opacity-50 placeholder:text-zinc-500\"\n        />\n        <div className=\"flex items-center justify-between px-2 pb-2\">\n          {/* Left actions */}\n          <div className=\"flex items-center gap-1.5\">\n            {/* Copy chat as markdown */}\n            {messages.length > 0 && (\n              <button\n                onClick={handleCopyChatMarkdown}\n                title=\"Copy chat as Markdown\"\n                className=\"w-7 h-7 rounded-lg flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n              >\n                {copied ? (\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <polyline points=\"20 6 9 17 4 12\"/>\n                  </svg>\n                ) : (\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <rect width=\"16\" height=\"16\" x=\"8\" y=\"8\" rx=\"2\" ry=\"2\"/><path d=\"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2\"/>\n                  </svg>\n                )}\n              </button>\n            )}\n            {/* Clear chat */}\n            {messages.length > 0 && (\n              <button\n                onClick={onClearChat}\n                title=\"Clear chat\"\n                className=\"w-7 h-7 rounded-lg flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M3 6h18\" /><path d=\"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\" /><path d=\"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6\" />\n                </svg>\n              </button>\n            )}\n          </div>\n\n          {/* Send / Stop */}\n          {isLoading ? (\n            <button\n              onClick={onStop}\n              title=\"Stop response\"\n              className=\"w-8 h-8 rounded-lg bg-zinc-900 text-white flex items-center justify-center hover:bg-zinc-700 transition-colors animate-pulse\"\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"animate-[spin_3s_linear_infinite]\">\n                <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"2\" strokeDasharray=\"20 43\" />\n                <rect x=\"9\" y=\"9\" width=\"6\" height=\"6\" rx=\"1\" fill=\"currentColor\" />\n              </svg>\n            </button>\n          ) : (\n            <div ref={sendBtnRef}>\n              <button\n                onClick={() => {\n                  if (!showSendMenu && sendBtnRef.current) {\n                    const rect = sendBtnRef.current.getBoundingClientRect();\n                    setSendMenuPos({ x: rect.right, y: rect.top });\n                  }\n                  setShowSendMenu(prev => !prev);\n                  setShowCardSubmenu(false);\n                }}\n                onMouseEnter={() => {\n                  if (!showSendMenu && inputText.trim() && sendBtnRef.current) {\n                    const rect = sendBtnRef.current.getBoundingClientRect();\n                    setSendMenuPos({ x: rect.right, y: rect.top });\n                    setShowSendMenu(true);\n                    setShowCardSubmenu(false);\n                  }\n                }}\n                disabled={!inputText.trim()}\n                title=\"Send options\"\n                className=\"w-8 h-8 rounded-lg bg-zinc-900 text-white flex items-center justify-center hover:bg-zinc-800 disabled:opacity-40 disabled:pointer-events-none transition-colors\"\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M6 12L3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5\" />\n                </svg>\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n\n      {/* Document change notice */}\n      {showDocChangeNotice && pendingDocChanges && pendingDocChanges.length > 0 && (\n        <DocumentChangeNotice\n          changes={pendingDocChanges}\n          onContinue={() => {\n            setShowDocChangeNotice(false);\n            onDocChangeContinue?.(pendingSendText, pendingSendIsCard, pendingSendLevel);\n            setInputText('');\n          }}\n          onStartFresh={() => {\n            setShowDocChangeNotice(false);\n            onDocChangeStartFresh?.();\n          }}\n          onCancel={() => setShowDocChangeNotice(false)}\n        />\n      )}\n\n      {/* Send menu — rendered as portal to escape overflow clipping */}\n    {showSendMenu && createPortal(\n      <div\n        ref={sendMenuRef}\n        className=\"fixed min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 z-[200]\"\n        style={{\n          right: Math.max(8, window.innerWidth - sendMenuPos.x),\n          bottom: Math.max(8, window.innerHeight - sendMenuPos.y + 6),\n        }}\n      >\n        {/* Send Message option */}\n        <button\n          onClick={() => { setShowSendMenu(false); setShowCardSubmenu(false); handleSend(); }}\n          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n        >\n          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n            <path d=\"M6 12L3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5\" />\n          </svg>\n          Send Message\n        </button>\n\n        <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n        {/* Generate Card — with submenu */}\n        <div\n          className=\"relative\"\n          onMouseEnter={() => setShowCardSubmenu(true)}\n          onMouseLeave={() => setShowCardSubmenu(false)}\n        >\n          <button\n            className=\"w-full text-left px-3 py-2 text-[11px] font-semibold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n          >\n            <span className=\"flex items-center gap-2\">\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n              </svg>\n              Generate Card\n            </span>\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n              <polyline points=\"15 18 9 12 15 6\" />\n            </svg>\n          </button>\n\n          {/* Detail level submenu */}\n          {showCardSubmenu && (\n            <div\n              className=\"absolute right-full bottom-0 mr-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 z-[201]\"\n            >\n              {([\n                { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n              ]).map(opt => (\n                <button\n                  key={opt.level}\n                  onClick={() => handleSendAsCard(opt.level)}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                >\n                  <span className=\"font-medium\">{opt.label}</span>\n                  <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                </button>\n              ))}\n\n              {/* Divider */}\n              <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n              {/* Title/Takeaway card options */}\n              {([\n                { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n              ]).map(opt => (\n                <button\n                  key={opt.level}\n                  onClick={() => handleSendAsCard(opt.level)}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                >\n                  <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                  <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>,\n      document.body\n      )}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":331,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":331,"endColumn":67,"fix":{"range":[13378,13385],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":336,"column":45,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":336,"endColumn":52,"fix":{"range":[13555,13562],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":338,"column":90,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":338,"endColumn":97,"fix":{"range":[13714,13721],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":373,"column":45,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":373,"endColumn":52,"fix":{"range":[15388,15395],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":375,"column":94,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":375,"endColumn":101,"fix":{"range":[15551,15558],"text":"{return;}"}},{"ruleId":"react/no-danger","severity":1,"message":"Dangerous property 'dangerouslySetInnerHTML' found","line":439,"column":220,"nodeType":"JSXAttribute","messageId":"dangerousProp","endLine":439,"endColumn":268},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":583,"column":32,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":583,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":721,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":721,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":722,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":722,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":722,"column":68,"nodeType":"Literal","messageId":"noMagic","endLine":722,"endColumn":69}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":37,"fixableErrorCount":0,"fixableWarningCount":22,"source":"\nimport React, { useState, useRef, useEffect, useCallback } from 'react';\nimport { createPortal } from 'react-dom';\nimport { marked } from 'marked';\nimport { ChatMessage, DetailLevel, UploadedFile, DocChangeEvent } from '../types';\nimport { DocumentChangeNotice } from './Dialogs';\nimport PanelRequirements from './PanelRequirements';\nimport { useAppContext } from '../context/AppContext';\n\ninterface ChatPanelProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  messages: ChatMessage[];\n  isLoading: boolean;\n  onSendMessage: (text: string, isCardRequest: boolean, detailLevel?: DetailLevel) => void;\n  onSaveAsCard: (message: ChatMessage, editedContent: string) => void;\n  onClearChat: () => void;\n  onStop: () => void;\n  documents: UploadedFile[];\n  onToggleDocument?: (docId: string) => void;\n  pendingDocChanges?: DocChangeEvent[];\n  hasConversation?: boolean;\n  onDocChangeContinue?: (text: string, isCardRequest: boolean, detailLevel?: DetailLevel) => void;\n  onDocChangeStartFresh?: () => void;\n}\n\nconst ChatPanel: React.FC<ChatPanelProps> = ({\n  isOpen,\n  onToggle,\n  messages,\n  isLoading,\n  onSendMessage,\n  onSaveAsCard,\n  onClearChat,\n  onStop,\n  documents,\n  onToggleDocument,\n  pendingDocChanges,\n  hasConversation,\n  onDocChangeContinue,\n  onDocChangeStartFresh,\n}) => {\n  const { darkMode } = useAppContext();\n  const stripRef = useRef<HTMLButtonElement>(null);\n  const [shouldRender, setShouldRender] = useState(isOpen);\n  const [isClosing, setIsClosing] = useState(false);\n  useEffect(() => {\n    if (isOpen) { setShouldRender(true); setIsClosing(false); }\n    else if (shouldRender) {\n      setIsClosing(true);\n      const t = setTimeout(() => { setIsClosing(false); }, 400);\n      return () => clearTimeout(t);\n    }\n  }, [isOpen]);\n  const DEFAULT_WIDTH = Math.min(window.innerWidth * 0.5, 750);\n  const [overlayWidth, setOverlayWidth] = useState(DEFAULT_WIDTH);\n  const isDraggingResize = useRef(false);\n  useEffect(() => { if (isOpen) setOverlayWidth(DEFAULT_WIDTH); }, [isOpen]);\n  const handleResizeStart = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    isDraggingResize.current = true;\n    document.body.style.userSelect = 'none';\n    document.body.style.cursor = 'ew-resize';\n    const overlay = document.createElement('div');\n    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;cursor:ew-resize;';\n    document.body.appendChild(overlay);\n    const startX = e.clientX;\n    const startW = overlayWidth;\n    const onMove = (ev: MouseEvent) => {\n      if (!isDraggingResize.current) return;\n      setOverlayWidth(Math.max(300, startW + ev.clientX - startX));\n    };\n    const onUp = () => {\n      isDraggingResize.current = false;\n      document.body.style.userSelect = '';\n      document.body.style.cursor = '';\n      overlay.remove();\n      document.removeEventListener('mousemove', onMove);\n      document.removeEventListener('mouseup', onUp);\n    };\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onUp);\n  }, [overlayWidth]);\n  const [inputText, setInputText] = useState('');\n  const [showSendMenu, setShowSendMenu] = useState(false);\n  const [showCardSubmenu, setShowCardSubmenu] = useState(false);\n  const [sendMenuPos, setSendMenuPos] = useState<{ x: number; y: number }>({ x: 0, y: 0 });\n  const sendMenuRef = useRef<HTMLDivElement>(null);\n  const sendBtnRef = useRef<HTMLDivElement>(null);\n  const [editingMessageId, setEditingMessageId] = useState<string | null>(null);\n  const [editContent, setEditContent] = useState('');\n  const [copied, setCopied] = useState(false);\n  const [copiedMsgId, setCopiedMsgId] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const prevMessagesRef = useRef<typeof messages>(messages);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const [expandedCards, setExpandedCards] = useState<Set<string>>(new Set());\n\n  // ── Document list popup state (hover + locked, like SourcesPanel) ──\n  const [docListOpen, setDocListOpen] = useState(false);\n  const [docListMode, setDocListMode] = useState<'hover' | 'locked'>('hover');\n  const docToggleRef = useRef<HTMLDivElement>(null);\n  const docListRef = useRef<HTMLDivElement>(null);\n\n  // ── Document change notice state ──\n  const [showDocChangeNotice, setShowDocChangeNotice] = useState(false);\n  const [pendingSendText, setPendingSendText] = useState('');\n  const [pendingSendIsCard, setPendingSendIsCard] = useState(false);\n  const [pendingSendLevel, setPendingSendLevel] = useState<DetailLevel | undefined>(undefined);\n\n  // Auto-save card content as card when a new card message arrives\n  const autoSavedRef = useRef<Set<string>>(new Set());\n  useEffect(() => {\n    for (const msg of messages) {\n      if (msg.isCardContent && msg.role === 'assistant' && !msg.savedAsCardId && !autoSavedRef.current.has(msg.id)) {\n        autoSavedRef.current.add(msg.id);\n        onSaveAsCard(msg, msg.content);\n      }\n    }\n  }, [messages, onSaveAsCard]);\n\n  // Scroll: instant on load/nugget switch, smooth on new messages\n  useEffect(() => {\n    const prev = prevMessagesRef.current;\n    const isAppend = messages.length > prev.length\n      && prev.length > 0\n      && messages[prev.length - 1] === prev[prev.length - 1];\n    if (isAppend || isLoading) {\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n    } else if (messages.length > 0) {\n      messagesEndRef.current?.scrollIntoView({ behavior: 'instant' });\n    }\n    prevMessagesRef.current = messages;\n  }, [messages, isLoading]);\n\n  // Auto-resize textarea\n  useEffect(() => {\n    if (textareaRef.current) {\n      textareaRef.current.style.height = 'auto';\n      textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 160) + 'px';\n    }\n  }, [inputText]);\n\n  // Send as regular chat message\n  const handleSend = useCallback(() => {\n    if (!inputText.trim() || isLoading) return;\n    const text = inputText.trim();\n    if (pendingDocChanges && pendingDocChanges.length > 0 && hasConversation && onDocChangeContinue) {\n      setPendingSendText(text);\n      setPendingSendIsCard(false);\n      setPendingSendLevel(undefined);\n      setShowDocChangeNotice(true);\n      return;\n    }\n    onSendMessage(text, false);\n    setInputText('');\n  }, [inputText, isLoading, onSendMessage, pendingDocChanges, hasConversation, onDocChangeContinue]);\n\n  // Send as card with specific detail level\n  const handleSendAsCard = useCallback((level: DetailLevel) => {\n    if (!inputText.trim() || isLoading) return;\n    const text = inputText.trim();\n    setShowSendMenu(false);\n    if (pendingDocChanges && pendingDocChanges.length > 0 && hasConversation && onDocChangeContinue) {\n      setPendingSendText(text);\n      setPendingSendIsCard(true);\n      setPendingSendLevel(level);\n      setShowDocChangeNotice(true);\n      return;\n    }\n    onSendMessage(text, true, level);\n    setInputText('');\n  }, [inputText, isLoading, onSendMessage, pendingDocChanges, hasConversation, onDocChangeContinue]);\n\n  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  }, [handleSend]);\n\n  // Close doc list popup on outside click (only when locked)\n  useEffect(() => {\n    if (!docListOpen || docListMode !== 'locked') return;\n    const handleClick = (e: MouseEvent) => {\n      const target = e.target as Node;\n      if (docToggleRef.current && docToggleRef.current.contains(target)) return;\n      if (docListRef.current && docListRef.current.contains(target)) return;\n      setDocListOpen(false);\n    };\n    window.addEventListener('mousedown', handleClick);\n    return () => window.removeEventListener('mousedown', handleClick);\n  }, [docListOpen, docListMode]);\n\n  // Close send menu on outside click or Escape\n  useEffect(() => {\n    if (!showSendMenu) return;\n    const handleClick = (e: MouseEvent) => {\n      if (sendMenuRef.current && !sendMenuRef.current.contains(e.target as Node) &&\n          sendBtnRef.current && !sendBtnRef.current.contains(e.target as Node)) {\n        setShowSendMenu(false);\n        setShowCardSubmenu(false);\n      }\n    };\n    const handleKey = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') { setShowSendMenu(false); setShowCardSubmenu(false); }\n    };\n    document.addEventListener('mousedown', handleClick);\n    document.addEventListener('keydown', handleKey);\n    return () => {\n      document.removeEventListener('mousedown', handleClick);\n      document.removeEventListener('keydown', handleKey);\n    };\n  }, [showSendMenu]);\n\n  const handleCopyChatMarkdown = useCallback(() => {\n    const text = messages.map(m => {\n      if (m.role === 'user') return `**You:** ${m.content}`;\n      if (m.role === 'system') return `> ${m.content}`;\n      return `**Claude:** ${m.content}`;\n    }).join('\\n\\n');\n    if (text) {\n      navigator.clipboard.writeText(text);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 1500);\n    }\n  }, [messages]);\n\n  const startEditing = (msg: ChatMessage) => {\n    setEditingMessageId(msg.id);\n    setEditContent(msg.content);\n  };\n\n  const handleSaveCard = (msg: ChatMessage) => {\n    const content = editingMessageId === msg.id ? editContent : msg.content;\n    onSaveAsCard(msg, content);\n    setEditingMessageId(null);\n  };\n\n  const handleCopyMessage = (msg: ChatMessage) => {\n    navigator.clipboard.writeText(msg.content);\n    setCopiedMsgId(msg.id);\n    setTimeout(() => setCopiedMsgId(null), 1500);\n  };\n\n  const parseCardSuggestions = useCallback((content: string): { body: string; suggestions: string[] } => {\n    const regex = /```card-suggestions\\n([\\s\\S]*?)```/;\n    const match = content.match(regex);\n    if (!match) return { body: content, suggestions: [] };\n    const body = content.replace(regex, '').trimEnd();\n    const suggestions = match[1]\n      .split('\\n')\n      .map(s => s.trim())\n      .filter(s => s.length > 0);\n    return { body, suggestions };\n  }, []);\n\n  const renderMarkdown = (content: string) => {\n    const html = marked.parse(content, { async: false }) as string;\n    return <div className=\"document-prose chat-prose\" dangerouslySetInnerHTML={{ __html: html }} />;\n  };\n\n  const extractCardTitle = (content: string): string => {\n    const match = content.match(/^#+\\s+(.+)$/m);\n    return match ? match[1].trim() : 'Card Content';\n  };\n\n  const toggleCardExpanded = (msgId: string) => {\n    setExpandedCards(prev => {\n      const next = new Set(prev);\n      if (next.has(msgId)) next.delete(msgId);\n      else next.add(msgId);\n      return next;\n    });\n  };\n\n  const formatTime = (timestamp: number) => {\n    const d = new Date(timestamp);\n    const now = new Date();\n    const isToday = d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();\n    if (isToday) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n    return d.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });\n  };\n\n  return (\n    <>\n    <button\n      ref={stripRef}\n      data-panel-strip\n      onClick={onToggle}\n      className=\"flex flex-col items-center pt-2 pb-1 overflow-hidden rounded-l-lg shadow-[5px_0_10px_rgba(0,0,0,0.35)] shrink-0 w-10 cursor-pointer -ml-2.5 z-[2] relative\"\n      style={{ backgroundColor: darkMode ? 'rgb(30,48,68)' : 'rgb(50,90,130)' }}\n    >\n      <div className=\"w-8 shrink-0 flex items-center justify-center\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-white\">\n          <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"/>\n        </svg>\n      </div>\n      <span className=\"text-[13px] font-bold uppercase tracking-wider text-white mt-2\" style={{ writingMode: 'vertical-lr', transform: 'rotate(180deg)' } as React.CSSProperties}>Create Cards by Chat</span>\n    </button>\n\n    {shouldRender && createPortal(\n      <div\n        data-panel-overlay\n        className=\"fixed z-[105] flex flex-col bg-white dark:bg-zinc-900 border-4 rounded-r-lg shadow-[5px_0_6px_rgba(0,0,0,0.35)] overflow-hidden\"\n        style={{ borderColor: darkMode ? 'rgb(30,48,68)' : 'rgb(50,90,130)', transformOrigin: 'left',\n          ...(!isOpen && !isClosing\n            ? { display: 'none' }\n            : { animation: `${isClosing ? 'panel-roll-in' : 'panel-roll-out'} 0.4s ease-out forwards` }\n          ),\n          top: stripRef.current?.getBoundingClientRect().top ?? 0,\n          left: stripRef.current?.getBoundingClientRect().right ?? 0,\n          height: stripRef.current?.getBoundingClientRect().height ?? 0,\n          width: overlayWidth,\n        }}\n      >\n        {/* Resize handle */}\n        <div\n          onMouseDown={handleResizeStart}\n          className=\"absolute right-0 top-0 bottom-0 w-1.5 cursor-ew-resize z-10 hover:bg-black/10 transition-colors\"\n        />\n      <>\n      {/* Document list bar — hover opens, click locks (same as SourcesPanel) */}\n      {documents.length > 0 && (\n        <>\n        <div className=\"shrink-0 border-y border-zinc-100 dark:border-zinc-700\">\n          <div\n            ref={docToggleRef}\n            className=\"flex items-center gap-1.5 px-3 py-1.5 cursor-pointer\"\n            onMouseEnter={() => {\n              if (docListOpen && docListMode === 'locked') return;\n              setDocListMode('hover');\n              setDocListOpen(true);\n            }}\n            onMouseLeave={(e) => {\n              if (docListMode === 'locked') return;\n              const related = e.relatedTarget as Node | null;\n              if (docListRef.current && related && docListRef.current.contains(related)) return;\n              setDocListOpen(false);\n            }}\n            onClick={() => {\n              if (docListOpen && docListMode === 'locked') {\n                setDocListOpen(false);\n              } else {\n                setDocListMode('locked');\n                setDocListOpen(true);\n              }\n            }}\n          >\n            <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>Select Active Documents</span>\n            <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{documents.length}</span>\n            {/* Chevron icon */}\n            <div className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200\">\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points={docListOpen ? \"18 15 12 9 6 15\" : \"6 9 12 15 18 9\"} />\n              </svg>\n            </div>\n          </div>\n        </div>\n\n        {/* Document list popup — portaled to body */}\n        {docListOpen && createPortal(\n          <div\n            ref={docListRef}\n            className=\"fixed z-[120]\"\n            style={{\n              ...(docToggleRef.current ? (() => {\n                const r = docToggleRef.current.getBoundingClientRect();\n                return { top: r.bottom, left: r.left };\n              })() : {}),\n            }}\n            onMouseLeave={(e) => {\n              if (docListMode === 'locked') return;\n              const related = e.relatedTarget as Node | null;\n              if (docToggleRef.current && related && docToggleRef.current.contains(related)) return;\n              setDocListOpen(false);\n            }}\n          >\n            {/* Invisible bridge padding on top, visible content inside */}\n            <div\n              className=\"bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-2 px-1 max-h-[50vh] overflow-y-auto mt-1\"\n              style={{ scrollbarWidth: 'thin' as const }}\n            >\n            {documents.map(doc => {\n              const isEnabled = doc.enabled !== false;\n              return (\n                <div\n                  key={doc.id}\n                  className={`flex items-center gap-1.5 px-3 py-1.5 cursor-pointer select-none transition-colors rounded-lg ${isEnabled ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400'} hover:bg-zinc-100 dark:hover:bg-zinc-700`}\n                  onClick={(e) => { e.stopPropagation(); onToggleDocument?.(doc.id); }}\n                >\n                  {/* Enabled checkbox */}\n                  <button\n                    className={`shrink-0 w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors ${\n                      isEnabled ? 'border-zinc-300 dark:border-zinc-600 bg-zinc-900' : 'border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 hover:border-zinc-300 dark:hover:border-zinc-600'\n                    }`}\n                  >\n                    {isEnabled && (\n                      <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"white\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><polyline points=\"20 6 9 17 4 12\" /></svg>\n                    )}\n                  </button>\n                  <span className=\"text-[11px] truncate block flex-1 min-w-0\">{doc.name}</span>\n                </div>\n              );\n            })}\n            </div>\n          </div>,\n          document.body\n        )}\n        </>\n      )}\n\n    <div className=\"flex-1 overflow-y-auto\">\n      {messages.length === 0 && (\n        <div className=\"flex flex-col items-center justify-center h-full text-center px-8\">\n          <PanelRequirements level=\"sources\" />\n          {/* Show conversation prompt only when all prerequisites are met */}\n          {documents.length > 0 && (\n            <>\n              <div className=\"w-10 h-10 bg-zinc-100 dark:bg-zinc-800/50 rounded-full flex items-center justify-center mb-3\">\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z\" />\n                </svg>\n              </div>\n              <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light max-w-xs\">\n                Ask questions about your documents, explore themes, and generate card content from the conversation.\n              </p>\n            </>\n          )}\n        </div>\n      )}\n\n      {messages.map((msg) => {\n        // System messages\n        if (msg.role === 'system') {\n          const noticeHtml = marked.parse(msg.content, { async: false }) as string;\n          return (\n            <div key={msg.id} className=\"px-5 py-2\">\n              <div className=\"rounded-xl px-4 py-3 system-notice-prose text-[11px] leading-relaxed\" style={{ backgroundColor: 'rgba(42, 159, 212, 0.06)', border: '1px solid rgba(42, 159, 212, 0.2)', color: '#1a7aaa' }} dangerouslySetInnerHTML={{ __html: noticeHtml }} />\n            </div>\n          );\n        }\n\n        // User messages\n        if (msg.role === 'user') {\n          return (\n            <div key={msg.id} className=\"group/msg px-5 py-3 flex justify-end\">\n              <div className=\"max-w-[85%]\">\n                <p className=\"text-[12px] text-zinc-800 dark:text-zinc-200 whitespace-pre-wrap leading-relaxed bg-zinc-100 dark:bg-zinc-800/50 rounded-2xl rounded-br-md px-4 py-2.5\">{msg.content}</p>\n                <div className=\"flex items-center justify-end gap-2 mt-1 opacity-0 group-hover/msg:opacity-100 transition-opacity\">\n                  <span className=\"text-[11px] text-zinc-500 dark:text-zinc-400\">{formatTime(msg.timestamp)}</span>\n                  <button\n                    onClick={() => handleCopyMessage(msg)}\n                    title=\"Copy\"\n                    className=\"p-0.5 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                  >\n                    {copiedMsgId === msg.id ? (\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <path d=\"M20 6L9 17l-5-5\" />\n                      </svg>\n                    ) : (\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <rect x=\"9\" y=\"9\" width=\"12\" height=\"12\" rx=\"2\" ry=\"2\" />\n                        <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\" />\n                      </svg>\n                    )}\n                  </button>\n                </div>\n              </div>\n            </div>\n          );\n        }\n\n        // Assistant messages\n        const { body, suggestions } = parseCardSuggestions(msg.content);\n        return (\n          <div key={msg.id} className=\"group/msg px-5 py-3\">\n            <div className={`max-w-[95%] ${msg.isCardContent ? 'bg-zinc-50 dark:bg-zinc-800 rounded-xl border border-zinc-300 dark:border-zinc-600 overflow-hidden' : ''}`}>\n              {/* Card content — collapsible, default collapsed */}\n              {msg.isCardContent ? (\n                <>\n                  <div className=\"flex items-center gap-2 px-4 py-2.5 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\">\n                    <button\n                      onClick={() => toggleCardExpanded(msg.id)}\n                      className=\"flex items-center gap-2 min-w-0 text-left\"\n                    >\n                      <svg\n                        width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                        className={`shrink-0 text-zinc-500 dark:text-zinc-400 transition-transform duration-150 ${expandedCards.has(msg.id) ? 'rotate-90' : ''}`}\n                      >\n                        <path d=\"m9 18 6-6-6-6\"/>\n                      </svg>\n                      <span className=\"text-[10px] font-semibold uppercase tracking-wider text-white bg-zinc-900 px-2 py-0.5 rounded-full shrink-0\">Card</span>\n                      {msg.detailLevel && (\n                        <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400 shrink-0\">{msg.detailLevel}</span>\n                      )}\n                      <span className=\"text-[11px] font-medium text-zinc-600 dark:text-zinc-400 truncate\">{extractCardTitle(body)}</span>\n                    </button>\n                    {/* Hover actions */}\n                    <div className=\"flex items-center gap-1.5 ml-auto shrink-0 opacity-0 group-hover/msg:opacity-100 transition-opacity\">\n                      <div className=\"flex items-center gap-1 px-0.5\" title=\"Card content (auto-saved)\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M20 6L9 17l-5-5\" />\n                        </svg>\n                        <span className=\"text-[10px] text-green-600/60\">Saved</span>\n                      </div>\n                      <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">{formatTime(msg.timestamp)}</span>\n                      <button\n                        onClick={(e) => { e.stopPropagation(); handleCopyMessage(msg); }}\n                        title=\"Copy\"\n                        className=\"p-0.5 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                      >\n                        {copiedMsgId === msg.id ? (\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                            <path d=\"M20 6L9 17l-5-5\" />\n                          </svg>\n                        ) : (\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                            <rect x=\"9\" y=\"9\" width=\"12\" height=\"12\" rx=\"2\" ry=\"2\" />\n                            <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\" />\n                          </svg>\n                        )}\n                      </button>\n                    </div>\n                  </div>\n                  {expandedCards.has(msg.id) && (\n                    <div className=\"px-4 pb-3\">\n                      {renderMarkdown(body)}\n                    </div>\n                  )}\n                </>\n              ) : (\n                <>\n                  {/* Content */}\n                  {renderMarkdown(body)}\n\n                  {/* Hover actions — timestamp, copy, add as card */}\n                  <div className=\"flex items-center gap-2.5 mt-2 opacity-0 group-hover/msg:opacity-100 transition-opacity\">\n                    <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">{formatTime(msg.timestamp)}</span>\n                    <button\n                      onClick={() => handleCopyMessage(msg)}\n                      title=\"Copy\"\n                      className=\"p-1 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                    >\n                      {copiedMsgId === msg.id ? (\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M20 6L9 17l-5-5\" />\n                        </svg>\n                      ) : (\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <rect x=\"9\" y=\"9\" width=\"12\" height=\"12\" rx=\"2\" ry=\"2\" />\n                          <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\" />\n                        </svg>\n                      )}\n                    </button>\n                    {/* Save as card */}\n                    {!msg.savedAsCardId ? (\n                      <button\n                        onClick={() => handleSaveCard(msg)}\n                        title=\"Add as card\"\n                        className=\"p-1 rounded text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                      >\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <rect width=\"16\" height=\"16\" x=\"3\" y=\"3\" rx=\"2\" />\n                          <path d=\"M3 9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2\" />\n                          <path d=\"M3 11h3c.8 0 1.6.3 2.1.9l1.1.9c1.6 1.6 4.1 1.6 5.7 0l1.1-.9c.5-.5 1.3-.9 2.1-.9H21\" />\n                        </svg>\n                      </button>\n                    ) : (\n                      <div className=\"flex items-center gap-1.5 px-0.5\" title=\"Saved as card\">\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M20 6L9 17l-5-5\" />\n                        </svg>\n                        <span className=\"text-[10px] text-green-600/60\">Saved</span>\n                      </div>\n                    )}\n                  </div>\n\n                  {suggestions.length > 0 && (\n                    <div className=\"mt-3 flex flex-wrap gap-1.5\">\n                      {suggestions.map((s, i) => (\n                        <button\n                          key={i}\n                          onClick={() => {\n                            setInputText(s);\n                            textareaRef.current?.focus();\n                          }}\n                          className=\"text-[11px] text-zinc-600 dark:text-zinc-400 bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-full px-3 py-1 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors text-left\"\n                        >\n                          {s}\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </>\n              )}\n            </div>\n          </div>\n        );\n      })}\n\n      <div ref={messagesEndRef} />\n    </div>\n\n    {/* Input area */}\n    <div className=\"shrink-0 px-4 py-3\">\n      <div className=\"rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 focus-within:ring-1 focus-within:ring-zinc-300 transition-shadow\">\n        <textarea\n          ref={textareaRef}\n          value={inputText}\n          onChange={(e) => setInputText(e.target.value)}\n          onKeyDown={handleKeyDown}\n          placeholder=\"Ask about your documents...\"\n          disabled={isLoading}\n          rows={2}\n          className=\"w-full resize-none bg-transparent px-4 pt-3 pb-1 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none disabled:opacity-50 placeholder:text-zinc-500\"\n        />\n        <div className=\"flex items-center justify-between px-2 pb-2\">\n          {/* Left actions */}\n          <div className=\"flex items-center gap-1.5\">\n            {/* Copy chat as markdown */}\n            {messages.length > 0 && (\n              <button\n                onClick={handleCopyChatMarkdown}\n                title=\"Copy chat as Markdown\"\n                className=\"w-7 h-7 rounded-lg flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n              >\n                {copied ? (\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <polyline points=\"20 6 9 17 4 12\"/>\n                  </svg>\n                ) : (\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <rect width=\"16\" height=\"16\" x=\"8\" y=\"8\" rx=\"2\" ry=\"2\"/><path d=\"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2\"/>\n                  </svg>\n                )}\n              </button>\n            )}\n            {/* Clear chat */}\n            {messages.length > 0 && (\n              <button\n                onClick={onClearChat}\n                title=\"Clear chat\"\n                className=\"w-7 h-7 rounded-lg flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M3 6h18\" /><path d=\"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\" /><path d=\"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6\" />\n                </svg>\n              </button>\n            )}\n          </div>\n\n          {/* Send / Stop */}\n          {isLoading ? (\n            <button\n              onClick={onStop}\n              title=\"Stop response\"\n              className=\"w-8 h-8 rounded-lg bg-zinc-900 text-white flex items-center justify-center hover:bg-zinc-700 transition-colors animate-pulse\"\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"animate-[spin_3s_linear_infinite]\">\n                <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"2\" strokeDasharray=\"20 43\" />\n                <rect x=\"9\" y=\"9\" width=\"6\" height=\"6\" rx=\"1\" fill=\"currentColor\" />\n              </svg>\n            </button>\n          ) : (\n            <div ref={sendBtnRef}>\n              <button\n                onClick={() => {\n                  if (!showSendMenu && sendBtnRef.current) {\n                    const rect = sendBtnRef.current.getBoundingClientRect();\n                    setSendMenuPos({ x: rect.right, y: rect.top });\n                  }\n                  setShowSendMenu(prev => !prev);\n                  setShowCardSubmenu(false);\n                }}\n                onMouseEnter={() => {\n                  if (!showSendMenu && inputText.trim() && sendBtnRef.current) {\n                    const rect = sendBtnRef.current.getBoundingClientRect();\n                    setSendMenuPos({ x: rect.right, y: rect.top });\n                    setShowSendMenu(true);\n                    setShowCardSubmenu(false);\n                  }\n                }}\n                disabled={!inputText.trim()}\n                title=\"Send options\"\n                className=\"w-8 h-8 rounded-lg bg-zinc-900 text-white flex items-center justify-center hover:bg-zinc-800 disabled:opacity-40 disabled:pointer-events-none transition-colors\"\n              >\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M6 12L3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5\" />\n                </svg>\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n\n      {/* Document change notice */}\n      {showDocChangeNotice && pendingDocChanges && pendingDocChanges.length > 0 && (\n        <DocumentChangeNotice\n          changes={pendingDocChanges}\n          onContinue={() => {\n            setShowDocChangeNotice(false);\n            onDocChangeContinue?.(pendingSendText, pendingSendIsCard, pendingSendLevel);\n            setInputText('');\n          }}\n          onStartFresh={() => {\n            setShowDocChangeNotice(false);\n            onDocChangeStartFresh?.();\n          }}\n          onCancel={() => setShowDocChangeNotice(false)}\n        />\n      )}\n\n      {/* Send menu — rendered as portal to escape overflow clipping */}\n    {showSendMenu && createPortal(\n      <div\n        ref={sendMenuRef}\n        className=\"fixed min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 z-[200]\"\n        style={{\n          right: Math.max(8, window.innerWidth - sendMenuPos.x),\n          bottom: Math.max(8, window.innerHeight - sendMenuPos.y + 6),\n        }}\n      >\n        {/* Send Message option */}\n        <button\n          onClick={() => { setShowSendMenu(false); setShowCardSubmenu(false); handleSend(); }}\n          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n        >\n          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n            <path d=\"M6 12L3.269 3.126A59.768 59.768 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.876L5.999 12Zm0 0h7.5\" />\n          </svg>\n          Send Message\n        </button>\n\n        <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n        {/* Generate Card — with submenu */}\n        <div\n          className=\"relative\"\n          onMouseEnter={() => setShowCardSubmenu(true)}\n          onMouseLeave={() => setShowCardSubmenu(false)}\n        >\n          <button\n            className=\"w-full text-left px-3 py-2 text-[11px] font-semibold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n          >\n            <span className=\"flex items-center gap-2\">\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n              </svg>\n              Generate Card\n            </span>\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n              <polyline points=\"15 18 9 12 15 6\" />\n            </svg>\n          </button>\n\n          {/* Detail level submenu */}\n          {showCardSubmenu && (\n            <div\n              className=\"absolute right-full bottom-0 mr-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 z-[201]\"\n            >\n              {([\n                { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n              ]).map(opt => (\n                <button\n                  key={opt.level}\n                  onClick={() => handleSendAsCard(opt.level)}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                >\n                  <span className=\"font-medium\">{opt.label}</span>\n                  <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                </button>\n              ))}\n\n              {/* Divider */}\n              <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n              {/* Title/Takeaway card options */}\n              {([\n                { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n              ]).map(opt => (\n                <button\n                  key={opt.level}\n                  onClick={() => handleSendAsCard(opt.level)}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                >\n                  <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                  <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>,\n      document.body\n      )}\n    </></div>,\n      document.body\n    )}\n    </>\n  );\n};\n\nexport default ChatPanel;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\Dialogs.tsx","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":118,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":118,"endColumn":73,"fix":{"range":[5595,5608],"text":"{handleSave();}"}},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":210,"column":27,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":210,"endColumn":28},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":214,"column":32,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":214,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\nimport React, { useState, useRef, useEffect } from 'react';\nimport { createPortal } from 'react-dom';\nimport { Card, DocChangeEvent } from '../types';\n\n// ── Manifest Batch Confirmation Modal ──\ninterface ManifestModalProps {\n  manifestCards: Card[];\n  onExecute: () => void;\n  onClose: () => void;\n}\n\nexport const ManifestModal: React.FC<ManifestModalProps> = ({ manifestCards, onExecute, onClose }) => {\n  return (\n    <div className=\"absolute inset-0 z-40 flex items-center justify-center animate-in fade-in duration-200 bg-black/20 dark:bg-black/40\">\n      <div className=\"w-full max-w-xs bg-white dark:bg-zinc-900 rounded-3xl p-7 border border-zinc-200 dark:border-zinc-600 animate-in zoom-in-95 duration-300\" style={{ boxShadow: '0 12px 48px rgba(0,0,0,0.25), 0 4px 16px rgba(0,0,0,0.15)' }}>\n        <div className=\"space-y-4 text-center\">\n          <svg width=\"36\" height=\"36\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"mx-auto text-zinc-800 dark:text-zinc-200\">\n            <path d=\"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z\"/>\n          </svg>\n          <div className=\"space-y-2\">\n            <p className=\"text-[11px] text-zinc-500 dark:text-zinc-400 font-light leading-relaxed\">\n              Render <span className=\"font-bold text-zinc-800 dark:text-zinc-200\">{manifestCards.length}</span> card {manifestCards.length === 1 ? 'image' : 'images'} using the current template settings?\n            </p>\n          </div>\n          <div className=\"flex flex-col space-y-2 pt-2\">\n            <button\n              onClick={onExecute}\n              className=\"w-full py-3 rounded-full bg-accent-blue text-white text-[9px] font-black uppercase tracking-widest shadow-lg dark:shadow-black/30 shadow-[rgba(42,159,212,0.2)] hover:scale-[1.02] transition-all\"\n            >\n              Generate\n            </button>\n            <button\n              onClick={onClose}\n              className=\"w-full py-3 rounded-full bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-[9px] font-black uppercase tracking-widest hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// ── Unsaved Changes Dialog ──\ninterface UnsavedChangesDialogProps {\n  onSave: () => void;\n  onDiscard: () => void;\n  onCancel: () => void;\n  title?: string;\n  description?: string;\n  saveLabel?: string;\n  discardLabel?: string;\n  /** When provided, shows a name input field. onSave receives the name via onSaveWithName instead. */\n  nameInput?: {\n    defaultName: string;\n    existingNames: string[];\n    onSaveWithName: (name: string) => void;\n  };\n}\n\nexport const UnsavedChangesDialog: React.FC<UnsavedChangesDialogProps> = ({ onSave, onDiscard, onCancel, title, description, saveLabel, discardLabel, nameInput }) => {\n  const [cardName, setCardName] = useState(nameInput?.defaultName || '');\n  const [nameError, setNameError] = useState('');\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  useEffect(() => {\n    if (nameInput) {\n      setTimeout(() => {\n        inputRef.current?.focus();\n        inputRef.current?.select();\n      }, 100);\n    }\n  }, [nameInput]);\n\n  const handleSave = () => {\n    if (nameInput) {\n      const trimmed = cardName.trim();\n      if (!trimmed) {\n        setNameError('Name cannot be empty');\n        return;\n      }\n      if (nameInput.existingNames.some(n => n.toLowerCase() === trimmed.toLowerCase())) {\n        setNameError('A card with this name already exists');\n        return;\n      }\n      setNameError('');\n      nameInput.onSaveWithName(trimmed);\n    } else {\n      onSave();\n    }\n  };\n\n  return createPortal(\n    <div className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60 animate-in fade-in duration-300\">\n      <div className=\"w-full max-w-sm bg-white dark:bg-zinc-900 rounded-[40px] p-10 shadow-2xl dark:shadow-black/30 border border-zinc-200 dark:border-zinc-600 animate-in zoom-in-95 duration-300\">\n        <div className=\"space-y-6 text-center\">\n          <div className=\"w-16 h-16 flex items-center justify-center mx-auto\">\n            <svg width=\"36\" height=\"36\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-800 dark:text-zinc-200\">\n              <path d=\"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z\"/><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\n            </svg>\n          </div>\n          <div className=\"space-y-2\">\n            <h3 className=\"text-[15px] font-black tracking-tight text-zinc-800 dark:text-zinc-200\">{title || 'Unsaved changes'}</h3>\n            <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light leading-relaxed\">\n              {description || 'You have unsaved edits. Save or discard them to continue.'}\n            </p>\n          </div>\n          {nameInput && (\n            <div className=\"text-left space-y-1.5\">\n              <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Card Name</label>\n              <input\n                ref={inputRef}\n                type=\"text\"\n                value={cardName}\n                onChange={(e) => { setCardName(e.target.value); setNameError(''); }}\n                onKeyDown={(e) => { if (e.key === 'Enter') handleSave(); }}\n                placeholder=\"Enter a name for this card\"\n                className={`w-full px-4 py-3 rounded-2xl border ${nameError ? 'border-red-300' : 'border-zinc-200 dark:border-zinc-600'} bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-500 dark:placeholder:text-zinc-400`}\n              />\n              {nameError && (\n                <p className=\"text-[10px] text-red-500 font-medium\">{nameError}</p>\n              )}\n            </div>\n          )}\n          <div className=\"flex flex-col space-y-3 pt-4\">\n            <button\n              onClick={handleSave}\n              className=\"w-full py-4 rounded-full bg-black text-white text-[10px] font-black uppercase tracking-widest hover:scale-[1.02] transition-all\"\n            >\n              {saveLabel || 'Save Changes'}\n            </button>\n            <button\n              onClick={onDiscard}\n              className=\"w-full py-4 rounded-full bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-[10px] font-black uppercase tracking-widest hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              {discardLabel || 'Discard Changes'}\n            </button>\n            <button\n              onClick={onCancel}\n              className=\"w-full py-2 text-zinc-600 dark:text-zinc-400 text-[10px] font-bold uppercase tracking-widest hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>,\n    document.body\n  );\n};\n\n// ── Reference Image Mismatch Dialog ──\ninterface ReferenceMismatchDialogProps {\n  onDisableReference: () => void;\n  onSkipOnce: () => void;\n  onCancel: () => void;\n}\n\n// ── Document Change Notice Dialog ──\ninterface DocumentChangeNoticeProps {\n  changes: DocChangeEvent[];\n  onContinue: () => void;\n  onStartFresh: () => void;\n  onCancel: () => void;\n}\n\nexport const DocumentChangeNotice: React.FC<DocumentChangeNoticeProps> = ({ changes, onContinue, onStartFresh, onCancel }) => {\n  // Group events by document (using docId), tracking latest name per doc\n  const docMap = new Map<string, { name: string; events: string[] }>();\n  const docOrder: string[] = [];\n  for (const e of changes) {\n    let entry = docMap.get(e.docId);\n    if (!entry) {\n      entry = { name: e.docName, events: [] };\n      docMap.set(e.docId, entry);\n      docOrder.push(e.docId);\n    }\n    switch (e.type) {\n      case 'added':    entry.events.push('Added'); break;\n      case 'removed':  entry.events.push('Removed'); break;\n      case 'renamed':  entry.events.push(`Renamed from \"${e.oldName}\"`); entry.name = e.docName; break;\n      case 'enabled':  entry.events.push('Enabled'); break;\n      case 'disabled': entry.events.push('Disabled'); break;\n      case 'updated':  entry.events.push('Content updated'); break;\n      default:         entry.events.push('Changed'); break;\n    }\n  }\n  const grouped = docOrder.map(id => docMap.get(id)!);\n\n  return createPortal(\n    <div className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60 animate-in fade-in duration-300\">\n      <div className=\"w-full max-w-md mx-4 bg-white dark:bg-zinc-900 rounded-[40px] p-10 shadow-2xl dark:shadow-black/30 border border-zinc-200 dark:border-zinc-600 animate-in zoom-in-95 duration-300\">\n        <div className=\"space-y-6 text-center\">\n          <div className=\"w-16 h-16 bg-blue-50 dark:bg-blue-950 rounded-full flex items-center justify-center mx-auto\">\n            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" className=\"text-blue-500 dark:text-blue-400\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z\" />\n              <polyline points=\"14 2 14 8 20 8\" />\n              <path d=\"M12 18v-6\" /><path d=\"M9 15l3-3 3 3\" />\n            </svg>\n          </div>\n          <div className=\"space-y-2\">\n            <h3 className=\"text-[15px] font-black tracking-tight text-zinc-800 dark:text-zinc-200\">Sources changed</h3>\n            <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light leading-relaxed\">\n              {grouped.length === 1 ? '1 document was' : `${grouped.length} documents were`} changed since the last message:\n            </p>\n            <div className=\"text-left text-[11px] text-zinc-600 dark:text-zinc-400 space-y-2 mt-2 max-h-48 overflow-y-auto px-2\" style={{ scrollbarWidth: 'none' }}>\n              {grouped.map((g, i) => (\n                <div key={i}>\n                  <p className=\"font-semibold text-zinc-800 dark:text-zinc-200 truncate\" title={g.name}>{g.name}</p>\n                  <ul className=\"space-y-0.5 ml-2 mt-0.5\">\n                    {g.events.map((ev, j) => (\n                      <li key={j} className=\"flex items-start gap-1.5\">\n                        <span className=\"text-zinc-400 dark:text-zinc-500 mt-px shrink-0\">•</span>\n                        <span>{ev}</span>\n                      </li>\n                    ))}\n                  </ul>\n                </div>\n              ))}\n            </div>\n          </div>\n          <div className=\"flex flex-col space-y-3 pt-4\">\n            <button\n              onClick={onContinue}\n              className=\"w-full py-4 rounded-full bg-accent-blue text-white text-[10px] font-black uppercase tracking-widest shadow-lg dark:shadow-black/30 shadow-[rgba(42,159,212,0.2)] hover:scale-[1.02] transition-all\"\n            >\n              Continue Chat\n            </button>\n            <button\n              onClick={onStartFresh}\n              className=\"w-full py-4 rounded-full bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-[10px] font-black uppercase tracking-widest hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              Start Fresh\n            </button>\n            <button\n              onClick={onCancel}\n              className=\"w-full py-2 text-zinc-600 dark:text-zinc-400 text-[10px] font-bold uppercase tracking-widest hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>,\n    document.body\n  );\n};\n\nexport const ReferenceMismatchDialog: React.FC<ReferenceMismatchDialogProps> = ({ onDisableReference, onSkipOnce, onCancel }) => {\n  return (\n    <div className=\"absolute inset-0 z-40 flex items-center justify-center animate-in fade-in duration-200 bg-black/20 dark:bg-black/40\">\n      <div className=\"w-full max-w-xs bg-white dark:bg-zinc-900 rounded-3xl p-7 border border-zinc-200 dark:border-zinc-600 animate-in zoom-in-95 duration-300\" style={{ boxShadow: '0 12px 48px rgba(0,0,0,0.25), 0 4px 16px rgba(0,0,0,0.15)' }}>\n        <div className=\"space-y-4 text-center\">\n          <svg width=\"36\" height=\"36\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"mx-auto text-zinc-800 dark:text-zinc-200\">\n            <path d=\"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z\"/><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\n          </svg>\n          <div className=\"space-y-2 mt-4\">\n            <p className=\"text-[11px] text-zinc-500 dark:text-zinc-400 font-light leading-relaxed\">\n              Your image generation style settings do not match the reference image styling.\n            </p>\n          </div>\n          <div className=\"flex flex-col space-y-2 pt-2\">\n            <button\n              onClick={onSkipOnce}\n              className=\"w-full py-3 rounded-full bg-accent-blue text-white text-[9px] font-black uppercase tracking-widest shadow-lg dark:shadow-black/30 shadow-[rgba(42,159,212,0.2)] hover:scale-[1.02] transition-all\"\n            >\n              Skip Reference This Time\n            </button>\n            <button\n              onClick={onDisableReference}\n              className=\"w-full py-3 rounded-full bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-[9px] font-black uppercase tracking-widest hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              Turn Off Reference\n            </button>\n            <button\n              onClick={onCancel}\n              className=\"w-full py-3 rounded-full bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-[9px] font-black uppercase tracking-widest hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\DocumentEditorModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isCoverLevel' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"isCoverLevel"},"fix":{"range":[183,197],"text":""},"desc":"Remove unused variable \"isCoverLevel\"."}]},{"ruleId":"import/order","severity":1,"message":"`../hooks/useDocumentEditing` import should occur before import of `./FormatToolbar`","line":7,"column":1,"nodeType":"ImportDeclaration","endLine":7,"endColumn":81,"fix":{"range":[217,398],"text":"import { useDocumentEditing, EditorHeading } from '../hooks/useDocumentEditing';\nimport { FormatToolbar } from './FormatToolbar';\nimport { FindReplaceBar } from './FindReplaceBar';\n"}},{"ruleId":"import/order","severity":1,"message":"`../hooks/useDocumentFindReplace` import should occur before import of `./FormatToolbar`","line":8,"column":1,"nodeType":"ImportDeclaration","endLine":8,"endColumn":74,"fix":{"range":[217,472],"text":"import { useDocumentFindReplace } from '../hooks/useDocumentFindReplace';\nimport { FormatToolbar } from './FormatToolbar';\nimport { FindReplaceBar } from './FindReplaceBar';\nimport { useDocumentEditing, EditorHeading } from '../hooks/useDocumentEditing';\n"}},{"ruleId":"import/order","severity":1,"message":"`../context/AppContext` import should occur before import of `./FormatToolbar`","line":10,"column":1,"nodeType":"ImportDeclaration","endLine":10,"endColumn":55,"fix":{"range":[217,577],"text":"import { useAppContext } from '../context/AppContext';\nimport { FormatToolbar } from './FormatToolbar';\nimport { FindReplaceBar } from './FindReplaceBar';\nimport { useDocumentEditing, EditorHeading } from '../hooks/useDocumentEditing';\nimport { useDocumentFindReplace } from '../hooks/useDocumentFindReplace';\nimport { UnsavedChangesDialog } from './Dialogs';\n"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 78 to the 15 allowed.","line":56,"column":320,"nodeType":null,"messageId":"refactorFunction","endLine":56,"endColumn":322},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":97,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":97,"endColumn":38,"fix":{"range":[4452,4459],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":103,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":103,"endColumn":38,"fix":{"range":[4726,4733],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":151,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":151,"endColumn":32,"fix":{"range":[6970,6977],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":152,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":152,"endColumn":54,"fix":{"range":[7024,7031],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":159,"column":13,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":159,"endColumn":20,"fix":{"range":[7266,7418],"text":"if (tocEls) for (const cel of tocEls) {\n      const r = (cel as HTMLElement).getBoundingClientRect();\n      cardRects.push({ top: r.top, height: r.height });\n    }"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 19 to the 15 allowed.","line":178,"column":68,"nodeType":null,"messageId":"refactorFunction","endLine":178,"endColumn":70},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":180,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":180,"endColumn":21,"fix":{"range":[7883,7890],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":184,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":184,"endColumn":17},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":184,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":184,"endColumn":26,"fix":{"range":[7980,7987],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":207,"column":13,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":207,"endColumn":20,"fix":{"range":[8604,8717],"text":"if (tocEls) for (const el of tocEls) {\n      visibleIndices.push(parseInt((el as HTMLElement).dataset.tocIdx || '0'));\n    }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":215,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":215,"endColumn":45,"fix":{"range":[8908,8917],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":218,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":218,"endColumn":45,"fix":{"range":[9036,9051],"text":"{targetSlot = i;}"}},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":220,"column":9,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":220,"endColumn":56,"fix":{"range":[9065,9130],"text":"if (e.clientY < mid) { targetSlot = i; break; }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":233,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":233,"endColumn":21,"fix":{"range":[9477,9484],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":247,"column":82,"nodeType":null,"messageId":"refactorFunction","endLine":247,"endColumn":84},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":248,"column":102,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":248,"endColumn":112,"fix":{"range":[10004,10014],"text":"{return {};}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 28.","line":256,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":256,"endColumn":56},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":258,"column":75,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":258,"endColumn":85,"fix":{"range":[10461,10471],"text":"{return {};}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":267,"column":66,"nodeType":"Literal","messageId":"defineConstant","endLine":267,"endColumn":88},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":270,"column":7,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":272,"endColumn":8,"fix":{"range":[10941,11125],"text":"if (headingIndex >= tocDragOverIdx && headingIndex < tocDragSourceIdx) {\n        return { transform: `translateY(${gap}px)`, transition: 'transform 150ms ease' };\n      }"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useImperativeHandle has a missing dependency: 'editing'. Either include it or remove the dependency array.","line":283,"column":7,"nodeType":"ArrayExpression","endLine":283,"endColumn":83,"suggestions":[{"desc":"Update the dependencies array to be: [editing]","fix":{"range":[11539,11615],"text":"[editing]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":287,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":287,"endColumn":30,"fix":{"range":[11718,11725],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":312,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":312,"endColumn":50,"fix":{"range":[12583,12590],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":318,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":318,"endColumn":65,"fix":{"range":[12799,12837],"text":"{y = Math.max(4, vh - rect.height - 4);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":318,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":318,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":318,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":318,"endColumn":63},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":319,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":319,"endColumn":63,"fix":{"range":[12863,12900],"text":"{x = Math.max(4, vw - rect.width - 4);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":319,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":319,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":319,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":319,"endColumn":61},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":331,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":331,"endColumn":25,"fix":{"range":[13261,13270],"text":"{continue;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":344,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":344,"endColumn":46},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":353,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":353,"endColumn":33,"fix":{"range":[13998,14005],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":357,"column":45,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":357,"endColumn":52,"fix":{"range":[14208,14215],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":358,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":358,"endColumn":53,"fix":{"range":[14261,14268],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":375,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":375,"endColumn":41,"fix":{"range":[14779,14795],"text":"{next.delete(id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":375,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":375,"endColumn":60,"fix":{"range":[14801,14814],"text":"{next.add(id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":381,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":381,"endColumn":52,"fix":{"range":[14943,14956],"text":"{return false;}"}},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":388,"column":7,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":388,"endColumn":9},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":389,"column":9,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":389,"endColumn":56,"fix":{"range":[15163,15264],"text":"(headings[i].level < heading.level && collapsed.has(headings[i].id)) return true;"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":389,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":389,"endColumn":56,"fix":{"range":[15244,15256],"text":"{return true;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":398,"column":14,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":398,"endColumn":21,"fix":{"range":[15433,15500],"text":"for (const [i, h] of headings.entries()) { if (hasChildren(i)) all.add(h.id); }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":398,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":398,"endColumn":68,"fix":{"range":[15482,15496],"text":"{all.add(h.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":427,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":427,"endColumn":35,"fix":{"range":[16485,16497],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":463,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":463,"endColumn":52,"fix":{"range":[17983,18002],"text":"{return selectedIds;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":465,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":465,"endColumn":53,"fix":{"range":[18093,18124],"text":"{return [contextMenu.headingId];}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":470,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":470,"endColumn":49,"fix":{"range":[18234,18260],"text":"{return { min: 1, max: 6 };}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":475,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":475,"endColumn":32,"fix":{"range":[18424,18433],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":481,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":481,"endColumn":53,"fix":{"range":[18692,18698],"text":"{break;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":490,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":490,"endColumn":43},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":493,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":493,"endColumn":30,"fix":{"range":[19064,19071],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":498,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":498,"endColumn":32,"fix":{"range":[19255,19264],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":502,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":502,"endColumn":53,"fix":{"range":[19463,19469],"text":"{break;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":513,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":513,"endColumn":30,"fix":{"range":[19775,19782],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":517,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":517,"endColumn":32,"fix":{"range":[19920,19929],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":521,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":521,"endColumn":53,"fix":{"range":[20127,20133],"text":"{break;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handleSaveAndClose' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":533,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":533,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'editing'. Either include it or remove the dependency array.","line":536,"column":6,"nodeType":"ArrayExpression","endLine":536,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [editing, onClose]","fix":{"range":[20585,20613],"text":"[editing, onClose]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'editing'. Either include it or remove the dependency array.","line":556,"column":6,"nodeType":"ArrayExpression","endLine":556,"endColumn":72,"suggestions":[{"desc":"Update the dependencies array to be: [editing, isCustomCard, onDiscardCustomCard, onClose]","fix":{"range":[21193,21259],"text":"[editing, isCustomCard, onDiscardCustomCard, onClose]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'editing'. Either include it or remove the dependency array.","line":562,"column":6,"nodeType":"ArrayExpression","endLine":562,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [editing, onClose]","fix":{"range":[21383,21411],"text":"[editing, onClose]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'editing'. Either include it or remove the dependency array.","line":572,"column":6,"nodeType":"ArrayExpression","endLine":572,"endColumn":48,"suggestions":[{"desc":"Update the dependencies array to be: [editing]","fix":{"range":[21706,21748],"text":"[editing]"}}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":580,"column":5,"nodeType":"Literal","messageId":"defineConstant","endLine":580,"endColumn":63},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":629,"column":10,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":823,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 220.","line":631,"column":113,"nodeType":"Literal","messageId":"noMagic","endLine":631,"endColumn":116},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":642,"column":13,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":823,"endColumn":17,"fix":{"range":[25081,36141],"text":"(!hideSidebar ? (\n        <aside ref={tocRef} className=\"shrink-0 border-r border-zinc-100 dark:border-zinc-600 overflow-y-auto bg-[#fafafa] dark:bg-zinc-800/50 transition-all duration-200\" style={{ width: sidebarOpen ? tocWidth : 40 }}>\n          <div className=\"sticky top-0 z-10\" style={{ backgroundColor: darkMode ? 'rgb(40,52,62)' : 'rgb(217,232,241)' }}>\n            <button\n              onClick={() => setSidebarOpen(prev => !prev)}\n              className=\"flex items-center gap-1.5 px-3 pt-3 pb-1 text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors cursor-pointer\"\n              title={sidebarOpen ? 'Collapse sidebar' : 'Expand sidebar'}\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\">\n                <line x1=\"8\" y1=\"6\" x2=\"21\" y2=\"6\"/><line x1=\"8\" y1=\"12\" x2=\"21\" y2=\"12\"/><line x1=\"8\" y1=\"18\" x2=\"21\" y2=\"18\"/><line x1=\"3\" y1=\"6\" x2=\"3.01\" y2=\"6\"/><line x1=\"3\" y1=\"12\" x2=\"3.01\" y2=\"12\"/><line x1=\"3\" y1=\"18\" x2=\"3.01\" y2=\"18\"/>\n              </svg>\n              {sidebarOpen && <span className=\"text-[10px] font-semibold uppercase tracking-wider whitespace-nowrap\">Table of Content</span>}\n            </button>\n          </div>\n          {sidebarOpen && (\n            <div className=\"px-2 pt-1\">\n              {/* Document root node — parent of all headings */}\n              <div\n                className={`group flex items-center gap-1 px-1 py-1.5 cursor-pointer select-none transition-all duration-150 border border-transparent ${\n                  activeHeadingId === '__document__' ? 'sidebar-node-active' : 'hover:border-blue-300'\n                }`}\n                onClick={() => { editing.deselectAll(); setActiveHeadingId('__document__'); }}\n              >\n                {/* Collapse chevron */}\n                {headings.length > 0 ? (\n                  <button\n                    onClick={(e) => { e.stopPropagation(); setDocTreeCollapsed(prev => !prev); }}\n                    className=\"flex-shrink-0 w-4 h-4 flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all duration-200 cursor-pointer\"\n                  >\n                    <svg\n                      width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                      className={`transition-transform duration-200 ${docTreeCollapsed ? '' : 'rotate-90'}`}\n                    >\n                      <polyline points=\"9 18 15 12 9 6\" />\n                    </svg>\n                  </button>\n                ) : (\n                  <span className=\"flex-shrink-0 w-4 h-4\" />\n                )}\n                {/* Doc icon */}\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\" style={{ color: activeHeadingId === '__document__' ? '#2a9fd4' : darkMode ? 'rgb(140,170,200)' : 'rgb(50,90,130)' }}>\n                  <path d=\"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z\"/><path d=\"M14 2v4a2 2 0 0 0 2 2h4\"/>\n                </svg>\n                {generatingDocCard && (\n                  <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 border-t-blue-600 rounded-full animate-spin\" />\n                )}\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-[13px] font-black truncate\" style={{ color: activeHeadingId === '__document__' ? '#2a9fd4' : darkMode ? 'rgb(140,170,200)' : 'rgb(50,90,130)' }} title={doc.name}>{doc.name}</p>\n                  {doc.originalFormat && (\n                    <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-normal italic block\">\n                      {doc.originalFormat === 'md' ? 'Direct Markdown' : doc.originalFormat === 'pdf' ? 'Converted from PDF' : 'Converted from Word'}\n                    </span>\n                  )}\n                </div>\n                {/* Kebab menu */}\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    closeMenu();\n                    setDocGenerateSubmenuOpen(false);\n                    setDocContextMenu({ x: e.clientX, y: e.clientY });\n                  }}\n                  className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity\"\n                  style={{ color: activeHeadingId === '__document__' ? 'rgba(42,159,212,0.6)' : darkMode ? 'rgba(160,180,200,0.5)' : 'rgba(100,116,139,0.5)' }}\n                >\n                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                  </svg>\n                </button>\n              </div>\n            </div>\n          )}\n          {sidebarOpen && !docTreeCollapsed && <div className=\"px-2 pb-20 relative ml-4 border-l\" style={{ borderColor: darkMode ? 'rgba(42,159,212,0.3)' : 'rgba(42,159,212,0.2)' }} ref={tocListRef}>\n            {headings.map((heading, index) => {\n              if (isHidden(index)) return null;\n              const level = Math.min(heading.level, 6);\n              const isActive = activeHeadingId === heading.id;\n              const isSelected = heading.selected;\n              const isCollapsible = hasChildren(index);\n              const isCollapsed = collapsed.has(heading.id);\n              const indent = indentClasses[level - 1] || 'ml-0';\n              const textStyle = textStyles[level - 1] || textStyles[5];\n\n              // Drag state: check if this heading is part of the dragged source span\n              const isDragSource = (() => {\n                if (tocDragSourceIdx === null) return false;\n                const srcLevel = headings[tocDragSourceIdx]?.level ?? 1;\n                if (index === tocDragSourceIdx) return true;\n                if (index > tocDragSourceIdx && heading.level > srcLevel) {\n                  // Check it's a descendant — no heading of same/lower level between source and here\n                  for (let i = tocDragSourceIdx + 1; i < index; i++) {\n                    if (headings[i].level <= srcLevel) return false;\n                  }\n                  return true;\n                }\n                return false;\n              })();\n\n              return (\n                <div\n                  key={heading.id}\n                  data-toc-idx={index}\n                  onPointerDown={(e) => handleTocPointerDown(e, index, heading.text)}\n                  onPointerMove={handleTocPointerMove}\n                  onPointerUp={handleTocPointerUp}\n                  style={{\n                    ...getTocGapStyle(index),\n                    ...(isDragSource ? { opacity: 0, pointerEvents: 'none' } : {}),\n                  }}\n                >\n                  {level === 1 && index > 0 && !isDragSource && (\n                    <div className=\"h-px bg-zinc-200 dark:bg-zinc-700 mb-1 mt-2 ml-1\" />\n                  )}\n                  <div\n                    onClick={() => {\n                      if (tocDragState.current?.active) return;\n                      handleHeadingClick(heading.id);\n                    }}\n                    className={`\n                      ${indent} group relative flex items-center space-x-1 py-1 px-1 transition-all duration-300 cursor-pointer border border-transparent\n                      ${isActive ? 'sidebar-node-active' : 'hover:border-blue-300'}\n                      ${isSelected ? 'bg-[rgba(160,200,220,0.2)]' : ''}\n                    `}\n                  >\n                    {isCollapsible ? (\n                      <div\n                        onClick={(e) => { e.stopPropagation(); toggleCollapse(heading.id); }}\n                        className=\"flex-shrink-0 w-4 h-4 flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all duration-200 cursor-pointer\"\n                      >\n                        <svg\n                          width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                          className={`transition-transform duration-200 ${isCollapsed ? '' : 'rotate-90'}`}\n                        >\n                          <polyline points=\"9 18 15 12 9 6\" />\n                        </svg>\n                      </div>\n                    ) : (\n                      <div className=\"flex-shrink-0 w-4 h-4\" />\n                    )}\n\n                    {generatingHeadingIds.has(heading.id) ? (\n                      <div className=\"flex-shrink-0 w-3.5 h-3.5 border-2 border-zinc-300 border-t-zinc-600 rounded-full animate-spin\" />\n                    ) : null}\n\n                    <span\n                      className={`${textStyle} transition-all select-none truncate pr-2 ml-0.5 flex-1 min-w-0`}\n                      style={{ opacity: isActive || isSelected || generatingHeadingIds.has(heading.id) ? 1 : 0.7 }}\n                    >\n                      {heading.text}\n                    </span>\n\n                    {/* Kebab menu button */}\n                    <button\n                      onClick={(e) => { e.stopPropagation(); handleContextMenu(e, heading.id); }}\n                      className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity\"\n                      style={{ color: isActive ? 'rgba(42,159,212,0.6)' : darkMode ? 'rgba(160,180,200,0.4)' : 'rgba(100,116,139,0.4)' }}\n                    >\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                      </svg>\n                    </button>\n                  </div>\n                </div>\n              );\n            })}\n\n            {/* TOC drag ghost */}\n            {tocDragGhostStyle && (\n              <div\n                className=\"flex items-center gap-1 px-2 py-1 rounded-lg bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-600 shadow-lg dark:shadow-black/30\"\n                style={tocDragGhostStyle}\n              >\n                <p className=\"text-[11px] font-semibold text-zinc-800 dark:text-zinc-200 truncate\">{tocDragGhostText.current}</p>\n              </div>\n            )}\n\n            {headings.length === 0 && (\n              <p className=\"text-[10px] text-zinc-500 dark:text-zinc-400 px-2 py-4 text-center\">No headings</p>\n            )}\n          </div>}\n        </aside>\n        ) : null)"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 40.","line":643,"column":214,"nodeType":"Literal","messageId":"noMagic","endLine":643,"endColumn":216},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":682,"column":197,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":682,"endColumn":294},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":682,"column":246,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":682,"endColumn":294,"fix":{"range":[28204,28252],"text":"(darkMode ? 'rgb(140,170,200)' : 'rgb(50,90,130)')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":689,"column":82,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":689,"endColumn":179},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":689,"column":131,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":689,"endColumn":179,"fix":{"range":[28772,28820],"text":"(darkMode ? 'rgb(140,170,200)' : 'rgb(50,90,130)')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":692,"column":24,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":692,"endColumn":149},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":692,"column":74,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":692,"endColumn":149,"fix":{"range":[29080,29155],"text":"(doc.originalFormat === 'pdf' ? 'Converted from PDF' : 'Converted from Word')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":705,"column":35,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":705,"endColumn":157},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":705,"column":97,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":705,"endColumn":157,"fix":{"range":[29781,29841],"text":"(darkMode ? 'rgba(160,180,200,0.5)' : 'rgba(100,116,139,0.5)')"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":716,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":716,"endColumn":48,"fix":{"range":[30527,30539],"text":"{return null;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":717,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":717,"endColumn":54},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":727,"column":48,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":727,"endColumn":61,"fix":{"range":[31142,31155],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":729,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":729,"endColumn":61,"fix":{"range":[31277,31289],"text":"{return true;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":733,"column":56,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":733,"endColumn":69,"fix":{"range":[31594,31607],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":757,"column":57,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":757,"endColumn":64,"fix":{"range":[32526,32533],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":788,"column":110,"nodeType":"Literal","messageId":"noMagic","endLine":788,"endColumn":113},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":797,"column":39,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":797,"endColumn":135},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":797,"column":75,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":797,"endColumn":135,"fix":{"range":[34922,34982],"text":"(darkMode ? 'rgba(160,180,200,0.4)' : 'rgba(100,116,139,0.4)')"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 8 times.","line":995,"column":176,"nodeType":"Literal","messageId":"defineConstant","endLine":995,"endColumn":210},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":1012,"column":170,"nodeType":"Literal","messageId":"noMagic","endLine":1012,"endColumn":171},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":1066,"column":61,"nodeType":"Literal","messageId":"noMagic","endLine":1066,"endColumn":62},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":1068,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":1068,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":1069,"column":68,"nodeType":"Literal","messageId":"noMagic","endLine":1069,"endColumn":69},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":1094,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":1094,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 220.","line":1095,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":1095,"endColumn":65},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1182,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1182,"endColumn":33,"fix":{"range":[56870,56877],"text":"{return;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":1183,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":1183,"endColumn":23}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":93,"fixableErrorCount":0,"fixableWarningCount":57,"source":"\nimport React, { useRef, useCallback, useState, useEffect, forwardRef, useImperativeHandle } from 'react';\nimport { createPortal } from 'react-dom';\nimport { UploadedFile, DetailLevel, isCoverLevel } from '../types';\nimport { FormatToolbar } from './FormatToolbar';\nimport { FindReplaceBar } from './FindReplaceBar';\nimport { useDocumentEditing, EditorHeading } from '../hooks/useDocumentEditing';\nimport { useDocumentFindReplace } from '../hooks/useDocumentFindReplace';\nimport { UnsavedChangesDialog } from './Dialogs';\nimport { useAppContext } from '../context/AppContext';\n\ninterface DocumentEditorModalProps {\n  document: UploadedFile;\n  onSave: (newContent: string) => void;\n  onClose: () => void;\n  /** When 'inline', renders without portal/backdrop/header — embeds directly in parent layout */\n  mode?: 'modal' | 'inline';\n  /** Called when user clicks \"Generate Card Content\" with a detail level from the heading context menu */\n  onGenerateCard?: (headingId: string, detailLevel: DetailLevel, headingText: string, sourceDocName?: string) => void;\n  /** When true, closing always shows a confirmation dialog (used for new custom cards) */\n  isCustomCard?: boolean;\n  /** Called when user discards a custom card — removes the heading entirely */\n  onDiscardCustomCard?: () => void;\n  /** Called when user saves a custom card with a chosen name — renames the heading */\n  onSaveCustomCard?: (name: string) => void;\n  /** Existing heading names for duplicate validation */\n  existingCardNames?: string[];\n  /** When true, hides the heading sidebar — used when CardsPanel provides its own list */\n  hideSidebar?: boolean;\n  /** Custom sidebar content that replaces the heading sidebar (rendered inside the main flex area under the toolbar) */\n  sidebarContent?: React.ReactNode;\n  /** Custom sidebar width in px — used when CardsPanel provides a resizable sidebar */\n  sidebarWidth?: number;\n  /** Optional divider element rendered between the sidebar and the editor — used for drag-to-resize */\n  sidebarDivider?: React.ReactNode;\n  /** Lifted spinner state — IDs currently being generated (survives panel collapse) */\n  generatingSourceIds?: Set<string>;\n}\n\n/** Imperative handle exposed to parent for unsaved-changes gating */\nexport interface DocumentEditorHandle {\n  isDirty: boolean;\n  save: () => void;\n  discard: () => void;\n  /** Update the first H1 heading text in the live editor (for external renames) */\n  updateH1: (newTitle: string) => void;\n}\n\n// ── Context Menu State ──\ninterface ContextMenuState {\n  x: number;\n  y: number;\n  headingId: string;\n}\n\nconst DocumentEditorModal = forwardRef<DocumentEditorHandle, DocumentEditorModalProps>(({ document: doc, onSave, onClose, mode = 'modal', onGenerateCard, isCustomCard, onDiscardCustomCard, onSaveCustomCard, existingCardNames, hideSidebar, sidebarContent, sidebarWidth, sidebarDivider, generatingSourceIds }, handleRef) => {\n  const { darkMode } = useAppContext();\n  const isInline = mode === 'inline';\n  const editorRef = useRef<HTMLDivElement>(null);\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\n  const editorObserverRef = useRef<MutationObserver | null>(null);\n  const menuRef = useRef<HTMLDivElement>(null);\n  const levelSubmenuRef = useRef<HTMLDivElement>(null);\n  const generateSubmenuRef = useRef<HTMLDivElement>(null);\n  const tocRef = useRef<HTMLElement>(null);\n\n  // ── Sidebar state ──\n  const [sidebarOpen, setSidebarOpen] = useState(true);\n\n  // ── TOC sidebar resize (default sidebar only) ──\n  const TOC_DEFAULT_WIDTH = 220;\n  const TOC_MIN_WIDTH = 140;\n  const TOC_MAX_WIDTH = 480;\n  const [tocWidth, setTocWidth] = useState(TOC_DEFAULT_WIDTH);\n  const tocDragging = useRef(false);\n  const tocDragStartX = useRef(0);\n  const tocDragStartWidth = useRef(0);\n\n  // Reset width when sidebar opens (collapse → expand resets to default)\n  const prevSidebarOpen = useRef(sidebarOpen);\n  useEffect(() => {\n    if (!prevSidebarOpen.current && sidebarOpen) {\n      setTocWidth(TOC_DEFAULT_WIDTH);\n    }\n    prevSidebarOpen.current = sidebarOpen;\n  }, [sidebarOpen]);\n\n  const handleTocDividerDown = useCallback((e: React.PointerEvent) => {\n    e.preventDefault();\n    tocDragging.current = true;\n    tocDragStartX.current = e.clientX;\n    tocDragStartWidth.current = tocWidth;\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, [tocWidth]);\n\n  const handleTocDividerMove = useCallback((e: React.PointerEvent) => {\n    if (!tocDragging.current) return;\n    const delta = e.clientX - tocDragStartX.current;\n    setTocWidth(Math.min(TOC_MAX_WIDTH, Math.max(TOC_MIN_WIDTH, tocDragStartWidth.current + delta)));\n  }, []);\n\n  const handleTocDividerUp = useCallback((e: React.PointerEvent) => {\n    if (!tocDragging.current) return;\n    tocDragging.current = false;\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n  }, []);\n  const [collapsed, setCollapsed] = useState<Set<string>>(new Set());\n  const [contextMenu, setContextMenu] = useState<ContextMenuState | null>(null);\n  const [levelSubmenuOpen, setLevelSubmenuOpen] = useState(false);\n  const [generateContentSubmenuOpen, setGenerateContentSubmenuOpen] = useState(false);\n  const [activeHeadingId, setActiveHeadingId] = useState<string | null>(null);\n  const generatingHeadingIds = generatingSourceIds ?? new Set<string>();\n  const generatingDocCard = generatingSourceIds?.has('__whole_document__') ?? false;\n  const [docContextMenu, setDocContextMenu] = useState<{ x: number; y: number } | null>(null);\n  const [docGenerateSubmenuOpen, setDocGenerateSubmenuOpen] = useState(false);\n  const [docTreeCollapsed, setDocTreeCollapsed] = useState(false);\n\n  // ── TOC drag-and-drop reordering (pointer-based) ──\n  const tocListRef = useRef<HTMLDivElement>(null);\n  const tocDragState = useRef<{\n    active: boolean;\n    sourceIdx: number;\n    currentIdx: number;\n    startY: number;\n    offsetY: number;\n    cardHeight: number;\n    cardRects: { top: number; height: number }[];\n  } | null>(null);\n  const [tocDragSourceIdx, setTocDragSourceIdx] = useState<number | null>(null);\n  const [tocDragOverIdx, setTocDragOverIdx] = useState<number | null>(null);\n  const [tocDragGhostStyle, setTocDragGhostStyle] = useState<React.CSSProperties | null>(null);\n  const tocDragGhostText = useRef('');\n\n  // Find/replace hook (shares editorObserverRef with editing hook)\n  const findReplace = useDocumentFindReplace(editorRef, scrollContainerRef, editorObserverRef);\n\n  // Editing hook (populates editorObserverRef, uses find/replace callbacks)\n  const editing = useDocumentEditing({\n    editorRef,\n    editorObserverRef,\n    initialContent: doc.content || '',\n    onSave,\n    closeFindBar: findReplace.closeFindBar,\n    clearFindHighlights: findReplace.clearFindHighlights,\n  });\n\n  const { headings } = editing;\n\n  // ── TOC drag handler callbacks (need headings + editing) ──\n  const handleTocPointerDown = useCallback((e: React.PointerEvent, headingIndex: number, text: string) => {\n    if (e.button !== 0) return;\n    if (e.metaKey || e.ctrlKey || e.shiftKey) return;\n\n    const el = e.currentTarget as HTMLElement;\n    const rect = el.getBoundingClientRect();\n\n    const tocEls = tocListRef.current?.querySelectorAll('[data-toc-idx]');\n    const cardRects: { top: number; height: number }[] = [];\n    tocEls?.forEach((cel) => {\n      const r = (cel as HTMLElement).getBoundingClientRect();\n      cardRects.push({ top: r.top, height: r.height });\n    });\n\n    tocDragState.current = {\n      active: false,\n      sourceIdx: headingIndex,\n      currentIdx: headingIndex,\n      startY: e.clientY,\n      offsetY: e.clientY - rect.top,\n      cardHeight: rect.height,\n      cardRects,\n    };\n    tocDragGhostText.current = text;\n\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, []);\n\n  const handleTocPointerMove = useCallback((e: React.PointerEvent) => {\n    const ds = tocDragState.current;\n    if (!ds) return;\n\n    const dy = Math.abs(e.clientY - ds.startY);\n    if (!ds.active) {\n      if (dy < 4) return;\n      ds.active = true;\n      setTocDragSourceIdx(ds.sourceIdx);\n      setTocDragOverIdx(ds.sourceIdx);\n    }\n\n    const listRect = tocListRef.current?.getBoundingClientRect();\n    if (listRect) {\n      setTocDragGhostStyle({\n        position: 'absolute',\n        left: 0,\n        right: 0,\n        top: e.clientY - listRect.top - ds.offsetY,\n        height: ds.cardHeight,\n        zIndex: 50,\n        pointerEvents: 'none',\n        opacity: 0.9,\n      });\n    }\n\n    const rects = ds.cardRects;\n    const tocEls = tocListRef.current?.querySelectorAll('[data-toc-idx]');\n    const visibleIndices: number[] = [];\n    tocEls?.forEach((el) => {\n      visibleIndices.push(parseInt((el as HTMLElement).dataset.tocIdx || '0'));\n    });\n\n    const visibleSourceSlot = visibleIndices.indexOf(ds.sourceIdx);\n    let targetSlot = visibleSourceSlot;\n\n    for (let i = 0; i < rects.length; i++) {\n      if (i === visibleSourceSlot) continue;\n      const mid = rects[i].top + rects[i].height / 2;\n      if (visibleSourceSlot < i) {\n        if (e.clientY > mid) targetSlot = i;\n      } else {\n        if (e.clientY < mid) { targetSlot = i; break; }\n      }\n    }\n\n    const targetHeadingIdx = visibleIndices[targetSlot] ?? ds.sourceIdx;\n    if (targetHeadingIdx !== ds.currentIdx) {\n      ds.currentIdx = targetHeadingIdx;\n      setTocDragOverIdx(targetHeadingIdx);\n    }\n  }, []);\n\n  const handleTocPointerUp = useCallback((e: React.PointerEvent) => {\n    const ds = tocDragState.current;\n    if (!ds) return;\n\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    if (ds.active && ds.sourceIdx !== ds.currentIdx) {\n      editing.reorderHeading(ds.sourceIdx, ds.currentIdx);\n    }\n\n    tocDragState.current = null;\n    setTocDragSourceIdx(null);\n    setTocDragOverIdx(null);\n    setTocDragGhostStyle(null);\n  }, [editing]);\n\n  const getTocGapStyle = useCallback((headingIndex: number): React.CSSProperties => {\n    if (tocDragSourceIdx === null || tocDragOverIdx === null || tocDragSourceIdx === tocDragOverIdx) return {};\n\n    const sourceLevel = headings[tocDragSourceIdx]?.level ?? 1;\n    let sourceSpanEnd = tocDragSourceIdx + 1;\n    while (sourceSpanEnd < headings.length && headings[sourceSpanEnd].level > sourceLevel) {\n      sourceSpanEnd++;\n    }\n    const sourceSpanCount = sourceSpanEnd - tocDragSourceIdx;\n    const gap = (tocDragState.current?.cardHeight || 28) * sourceSpanCount;\n\n    if (headingIndex >= tocDragSourceIdx && headingIndex < sourceSpanEnd) return {};\n\n    if (tocDragSourceIdx < tocDragOverIdx) {\n      const targetLevel = headings[tocDragOverIdx]?.level ?? 1;\n      let targetSpanEnd = tocDragOverIdx + 1;\n      while (targetSpanEnd < headings.length && headings[targetSpanEnd].level > targetLevel) {\n        targetSpanEnd++;\n      }\n      if (headingIndex >= sourceSpanEnd && headingIndex < targetSpanEnd) {\n        return { transform: `translateY(-${gap}px)`, transition: 'transform 150ms ease' };\n      }\n    } else {\n      if (headingIndex >= tocDragOverIdx && headingIndex < tocDragSourceIdx) {\n        return { transform: `translateY(${gap}px)`, transition: 'transform 150ms ease' };\n      }\n    }\n    return { transition: 'transform 150ms ease' };\n  }, [tocDragSourceIdx, tocDragOverIdx, headings]);\n\n  // ── Expose imperative handle for parent unsaved-changes gating ──\n  useImperativeHandle(handleRef, () => ({\n    get isDirty() { return editing.isDirty; },\n    save: () => editing.saveEdits(),\n    discard: () => editing.discardEdits(),\n    updateH1: (newTitle: string) => editing.updateH1(newTitle),\n  }), [editing.isDirty, editing.saveEdits, editing.discardEdits, editing.updateH1]);\n\n  // ── Close context menu on click outside or Escape ──\n  useEffect(() => {\n    if (!contextMenu) return;\n    const handleClick = (e: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {\n        setContextMenu(null);\n        setLevelSubmenuOpen(false);\n        setGenerateContentSubmenuOpen(false);\n      }\n    };\n    const handleKey = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        setContextMenu(null);\n        setLevelSubmenuOpen(false);\n        setGenerateContentSubmenuOpen(false);\n      }\n    };\n    document.addEventListener('mousedown', handleClick);\n    document.addEventListener('keydown', handleKey);\n    return () => {\n      document.removeEventListener('mousedown', handleClick);\n      document.removeEventListener('keydown', handleKey);\n    };\n  }, [contextMenu]);\n\n  // ── Adjust context menu position to stay within viewport ──\n  useEffect(() => {\n    if (!contextMenu || !menuRef.current) return;\n    const menu = menuRef.current;\n    const rect = menu.getBoundingClientRect();\n    const vw = window.innerWidth;\n    const vh = window.innerHeight;\n    let { x, y } = contextMenu;\n    if (rect.bottom > vh) y = Math.max(4, vh - rect.height - 4);\n    if (rect.right > vw) x = Math.max(4, vw - rect.width - 4);\n    if (y !== contextMenu.y || x !== contextMenu.x) {\n      menu.style.top = `${y}px`;\n      menu.style.left = `${x}px`;\n    }\n  }, [contextMenu]);\n\n  // ── Adjust submenu positions to stay within viewport ──\n  useEffect(() => {\n    const refs = [levelSubmenuRef, generateSubmenuRef];\n    for (const ref of refs) {\n      const el = ref.current;\n      if (!el) continue;\n      const rect = el.getBoundingClientRect();\n      const vh = window.innerHeight;\n      const vw = window.innerWidth;\n      // Flip left if overflows right\n      if (rect.right > vw) {\n        el.style.left = 'auto';\n        el.style.right = '100%';\n        el.style.marginLeft = '0';\n        el.style.marginRight = '4px';\n      }\n      // Shift up if overflows bottom\n      if (rect.bottom > vh) {\n        const overflow = rect.bottom - vh + 4;\n        el.style.top = `${-overflow}px`;\n      }\n    }\n  }, [levelSubmenuOpen, generateContentSubmenuOpen]);\n\n  // ── Deselect headings when clicking outside the TOC sidebar ──\n  const hasAnySelected = headings.some(h => h.selected);\n  useEffect(() => {\n    if (!hasAnySelected) return;\n    const handler = (e: MouseEvent) => {\n      const target = e.target as Node;\n      // Don't deselect if clicking inside TOC sidebar or inside context menu\n      if (tocRef.current?.contains(target)) return;\n      if (menuRef.current?.contains(target)) return;\n      editing.deselectAll();\n    };\n    document.addEventListener('mousedown', handler);\n    return () => document.removeEventListener('mousedown', handler);\n  }, [hasAnySelected, editing]);\n\n  // ── Sidebar helpers ──\n  const closeMenu = useCallback(() => {\n    setContextMenu(null);\n    setLevelSubmenuOpen(false);\n    setGenerateContentSubmenuOpen(false);\n  }, []);\n\n  const toggleCollapse = useCallback((id: string) => {\n    setCollapsed(prev => {\n      const next = new Set(prev);\n      if (next.has(id)) next.delete(id); else next.add(id);\n      return next;\n    });\n  }, []);\n\n  const hasChildren = (index: number): boolean => {\n    if (index >= headings.length - 1) return false;\n    return headings[index + 1].level > headings[index].level;\n  };\n\n  const isHidden = (index: number): boolean => {\n    const heading = headings[index];\n    for (let i = index - 1; i >= 0; i--) {\n      if (headings[i].level < heading.level) {\n        if (collapsed.has(headings[i].id)) return true;\n      }\n    }\n    return false;\n  };\n\n  const expandAll = () => { setCollapsed(new Set()); closeMenu(); };\n  const collapseAll = () => {\n    const all = new Set<string>();\n    headings.forEach((h, i) => { if (hasChildren(i)) all.add(h.id); });\n    setCollapsed(all);\n    closeMenu();\n  };\n\n  // Tier 1: left-click — set active heading, scroll, clear tier 2\n  const handleHeadingClick = (id: string) => {\n    editing.deselectAll();\n    setActiveHeadingId(id);\n    editing.scrollToHeading(id);\n  };\n\n  // Tier 2: right-click — select for batch operations, no scroll, no tier 1 change\n  const handleContextMenu = (e: React.MouseEvent, headingId: string) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const heading = headings.find(h => h.id === headingId);\n    // If right-clicked heading isn't already tier 2 selected, clear tier 2 and select just this one\n    if (!heading?.selected) {\n      editing.deselectAll();\n      editing.toggleSelection(headingId);\n    }\n    setLevelSubmenuOpen(false);\n    setGenerateContentSubmenuOpen(false);\n    setContextMenu({ x: e.clientX, y: e.clientY, headingId });\n  };\n\n  // ── Context heading info ──\n  const getContextHeading = (): EditorHeading | null => {\n    if (!contextMenu) return null;\n    return headings.find(h => h.id === contextMenu.headingId) ?? null;\n  };\n  const contextHeading = getContextHeading();\n\n  // ── Select Heading and Content (Tier 1 + Tier 2 + visual highlight) ──\n  const handleSelectHeadingAndContent = () => {\n    if (contextMenu) {\n      editing.deselectAll();\n      setActiveHeadingId(contextMenu.headingId);\n      editing.scrollToHeading(contextMenu.headingId);\n      editing.selectHeadingContent(contextMenu.headingId);\n      editing.selectHeadingAndDescendants(contextMenu.headingId);\n    }\n    closeMenu();\n  };\n\n  // ── Select by Level (replaces existing tier 2 selection, toggles off if same levels re-selected) ──\n  const handleSelectLevel = (levels: number[]) => {\n    const levelSet = new Set(levels);\n    const currentlySelected = headings.filter(h => h.selected);\n    const allAtTheseLevels = currentlySelected.length > 0 && currentlySelected.every(h => levelSet.has(h.level));\n    const targeted = headings.filter(h => levelSet.has(h.level));\n    const allTargetedSelected = targeted.length > 0 && targeted.every(h => h.selected);\n    if (allAtTheseLevels && allTargetedSelected) {\n      editing.deselectAll();\n    } else {\n      editing.deselectAll();\n      editing.selectByLevels(levels);\n    }\n    closeMenu();\n  };\n\n  // ── Tier 2 selection IDs — used by Promote / Demote / Generate ──\n  const getTier2Ids = (): string[] => {\n    const selectedIds = headings.filter(h => h.selected).map(h => h.id);\n    if (selectedIds.length > 0) return selectedIds;\n    // Fallback: if no tier 2 selection, use the context menu target\n    if (contextMenu) return [contextMenu.headingId];\n    return [];\n  };\n\n  const getAffectedLevels = (): { min: number; max: number } => {\n    if (!contextMenu) return { min: 1, max: 6 };\n    const ids = getTier2Ids();\n    let min = 6, max = 1;\n    for (const id of ids) {\n      const idx = headings.findIndex(h => h.id === id);\n      if (idx === -1) continue;\n      const parentLevel = headings[idx].level;\n      min = Math.min(min, parentLevel);\n      max = Math.max(max, parentLevel);\n      // Include descendants\n      for (let i = idx + 1; i < headings.length; i++) {\n        if (headings[i].level <= parentLevel) break;\n        min = Math.min(min, headings[i].level);\n        max = Math.max(max, headings[i].level);\n      }\n    }\n    return { min, max };\n  };\n  const affectedLevels = contextMenu ? getAffectedLevels() : { min: 1, max: 6 };\n  const canPromote = affectedLevels.min > 1;\n  const canDemote = affectedLevels.max < 6;\n\n  const handlePromote = () => {\n    if (!contextMenu) return;\n    const ids = getTier2Ids();\n    // For each id, promote it + its children\n    for (const id of ids) {\n      const idx = headings.findIndex(h => h.id === id);\n      if (idx === -1) continue;\n      editing.changeHeadingLevel(id, 'promote');\n      const parentLevel = headings[idx].level;\n      for (let i = idx + 1; i < headings.length; i++) {\n        if (headings[i].level <= parentLevel) break;\n        // Only promote children if they aren't already in the ids list (avoid double-promote)\n        if (!ids.includes(headings[i].id)) {\n          editing.changeHeadingLevel(headings[i].id, 'promote');\n        }\n      }\n    }\n    closeMenu();\n  };\n\n  const handleDemote = () => {\n    if (!contextMenu) return;\n    const ids = getTier2Ids();\n    for (const id of ids) {\n      const idx = headings.findIndex(h => h.id === id);\n      if (idx === -1) continue;\n      editing.changeHeadingLevel(id, 'demote');\n      const parentLevel = headings[idx].level;\n      for (let i = idx + 1; i < headings.length; i++) {\n        if (headings[i].level <= parentLevel) break;\n        if (!ids.includes(headings[i].id)) {\n          editing.changeHeadingLevel(headings[i].id, 'demote');\n        }\n      }\n    }\n    closeMenu();\n  };\n\n  // ── Save & close / Discard & close ──\n  // The only way to exit the editor is via the toolbar Save or Discard buttons.\n  // No X button or Escape key — forces an explicit save-or-discard decision.\n  const handleSaveAndClose = useCallback(() => {\n    editing.saveEdits();\n    onClose();\n  }, [editing.saveEdits, onClose]);\n\n  // Discard: if dirty, show in-app confirmation dialog; if clean, close immediately\n  const [showUnsavedDialog, setShowUnsavedDialog] = useState(false);\n\n  const handleDiscardAndClose = useCallback(() => {\n    if (isCustomCard || editing.isDirty) {\n      setShowUnsavedDialog(true);\n      return;\n    }\n    onClose();\n  }, [editing.isDirty, onClose, isCustomCard]);\n\n  const confirmDiscard = useCallback(() => {\n    setShowUnsavedDialog(false);\n    editing.discardEdits();\n    if (isCustomCard && onDiscardCustomCard) {\n      onDiscardCustomCard();\n    }\n    onClose();\n  }, [editing.discardEdits, onClose, isCustomCard, onDiscardCustomCard]);\n\n  const confirmSave = useCallback(() => {\n    setShowUnsavedDialog(false);\n    editing.saveEdits();\n    onClose();\n  }, [editing.saveEdits, onClose]);\n\n  // Wrap keydown to intercept Ctrl+S so it triggers save\n  const handleEditorKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if ((e.ctrlKey || e.metaKey) && e.key === 's') {\n      e.preventDefault();\n      editing.saveEdits();\n      return;\n    }\n    editing.handleKeyDown(e);\n  }, [editing.handleKeyDown, editing.saveEdits]);\n\n  // ── Heading styling (matches StructureView) ──\n  const indentClasses = ['ml-0', 'ml-4', 'ml-8', 'ml-12', 'ml-16', 'ml-20'];\n  const textStyles = [\n    'text-[12px] font-bold text-zinc-800 dark:text-zinc-200',\n    'text-[11px] font-semibold text-zinc-600 dark:text-zinc-400',\n    'text-[11px] font-medium text-zinc-500 dark:text-zinc-400',\n    'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n    'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n    'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n  ];\n\n  // ── Shared editor body (used in both modal and inline modes) ──\n  const editorBody = (\n    <>\n      {/* Format Toolbar */}\n      <div className=\"shrink-0 h-[40px] border-b border-zinc-200 dark:border-zinc-600\">\n        <FormatToolbar\n          activeFormats={editing.activeFormats}\n          executeCommand={editing.executeCommand}\n          insertTable={editing.insertTable}\n          showFind={findReplace.showFind}\n          setShowFind={findReplace.setShowFind}\n          findInputRef={findReplace.findInputRef}\n          isDirty={editing.isDirty}\n          onSave={() => editing.saveEdits()}\n          hasContent={true}\n        />\n      </div>\n\n      {/* Find/Replace Bar */}\n      {findReplace.showFind && (\n        <div className=\"shrink-0 border-b border-zinc-100 dark:border-zinc-600\">\n          <FindReplaceBar\n            findInputRef={findReplace.findInputRef}\n            findQuery={findReplace.findQuery}\n            setFindQuery={findReplace.setFindQuery}\n            replaceQuery={findReplace.replaceQuery}\n            setReplaceQuery={findReplace.setReplaceQuery}\n            findMatchCount={findReplace.findMatchCount}\n            findActiveIndex={findReplace.findActiveIndex}\n            setFindActiveIndex={findReplace.setFindActiveIndex}\n            findMatchCase={findReplace.findMatchCase}\n            setFindMatchCase={findReplace.setFindMatchCase}\n            findNext={findReplace.findNext}\n            findPrev={findReplace.findPrev}\n            closeFindBar={findReplace.closeFindBar}\n            handleReplace={findReplace.handleReplace}\n            handleReplaceAll={findReplace.handleReplaceAll}\n          />\n        </div>\n      )}\n\n      {/* Main content: Sidebar + Editor */}\n      <div className=\"flex-1 flex overflow-hidden\">\n        {/* Sidebar: custom content, default headings, or hidden */}\n        {sidebarContent ? (\n          <>\n          <aside className=\"shrink-0 overflow-y-auto bg-white dark:bg-zinc-900\" style={{ width: sidebarWidth ?? 220 }}>\n            <div className=\"flex items-center gap-1.5 px-3 pt-3 pb-1 text-zinc-500 dark:text-zinc-400\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\">\n                <line x1=\"8\" y1=\"6\" x2=\"21\" y2=\"6\"/><line x1=\"8\" y1=\"12\" x2=\"21\" y2=\"12\"/><line x1=\"8\" y1=\"18\" x2=\"21\" y2=\"18\"/><line x1=\"3\" y1=\"6\" x2=\"3.01\" y2=\"6\"/><line x1=\"3\" y1=\"12\" x2=\"3.01\" y2=\"12\"/><line x1=\"3\" y1=\"18\" x2=\"3.01\" y2=\"18\"/>\n              </svg>\n              <span className=\"text-[10px] font-semibold uppercase tracking-wider whitespace-nowrap\">Cards List</span>\n            </div>\n            {sidebarContent}\n          </aside>\n          {sidebarDivider}\n          </>\n        ) : !hideSidebar ? (\n        <aside ref={tocRef} className=\"shrink-0 border-r border-zinc-100 dark:border-zinc-600 overflow-y-auto bg-[#fafafa] dark:bg-zinc-800/50 transition-all duration-200\" style={{ width: sidebarOpen ? tocWidth : 40 }}>\n          <div className=\"sticky top-0 z-10\" style={{ backgroundColor: darkMode ? 'rgb(40,52,62)' : 'rgb(217,232,241)' }}>\n            <button\n              onClick={() => setSidebarOpen(prev => !prev)}\n              className=\"flex items-center gap-1.5 px-3 pt-3 pb-1 text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors cursor-pointer\"\n              title={sidebarOpen ? 'Collapse sidebar' : 'Expand sidebar'}\n            >\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\">\n                <line x1=\"8\" y1=\"6\" x2=\"21\" y2=\"6\"/><line x1=\"8\" y1=\"12\" x2=\"21\" y2=\"12\"/><line x1=\"8\" y1=\"18\" x2=\"21\" y2=\"18\"/><line x1=\"3\" y1=\"6\" x2=\"3.01\" y2=\"6\"/><line x1=\"3\" y1=\"12\" x2=\"3.01\" y2=\"12\"/><line x1=\"3\" y1=\"18\" x2=\"3.01\" y2=\"18\"/>\n              </svg>\n              {sidebarOpen && <span className=\"text-[10px] font-semibold uppercase tracking-wider whitespace-nowrap\">Table of Content</span>}\n            </button>\n          </div>\n          {sidebarOpen && (\n            <div className=\"px-2 pt-1\">\n              {/* Document root node — parent of all headings */}\n              <div\n                className={`group flex items-center gap-1 px-1 py-1.5 cursor-pointer select-none transition-all duration-150 border border-transparent ${\n                  activeHeadingId === '__document__' ? 'sidebar-node-active' : 'hover:border-blue-300'\n                }`}\n                onClick={() => { editing.deselectAll(); setActiveHeadingId('__document__'); }}\n              >\n                {/* Collapse chevron */}\n                {headings.length > 0 ? (\n                  <button\n                    onClick={(e) => { e.stopPropagation(); setDocTreeCollapsed(prev => !prev); }}\n                    className=\"flex-shrink-0 w-4 h-4 flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all duration-200 cursor-pointer\"\n                  >\n                    <svg\n                      width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                      className={`transition-transform duration-200 ${docTreeCollapsed ? '' : 'rotate-90'}`}\n                    >\n                      <polyline points=\"9 18 15 12 9 6\" />\n                    </svg>\n                  </button>\n                ) : (\n                  <span className=\"flex-shrink-0 w-4 h-4\" />\n                )}\n                {/* Doc icon */}\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\" style={{ color: activeHeadingId === '__document__' ? '#2a9fd4' : darkMode ? 'rgb(140,170,200)' : 'rgb(50,90,130)' }}>\n                  <path d=\"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z\"/><path d=\"M14 2v4a2 2 0 0 0 2 2h4\"/>\n                </svg>\n                {generatingDocCard && (\n                  <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 border-t-blue-600 rounded-full animate-spin\" />\n                )}\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-[13px] font-black truncate\" style={{ color: activeHeadingId === '__document__' ? '#2a9fd4' : darkMode ? 'rgb(140,170,200)' : 'rgb(50,90,130)' }} title={doc.name}>{doc.name}</p>\n                  {doc.originalFormat && (\n                    <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-normal italic block\">\n                      {doc.originalFormat === 'md' ? 'Direct Markdown' : doc.originalFormat === 'pdf' ? 'Converted from PDF' : 'Converted from Word'}\n                    </span>\n                  )}\n                </div>\n                {/* Kebab menu */}\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    closeMenu();\n                    setDocGenerateSubmenuOpen(false);\n                    setDocContextMenu({ x: e.clientX, y: e.clientY });\n                  }}\n                  className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity\"\n                  style={{ color: activeHeadingId === '__document__' ? 'rgba(42,159,212,0.6)' : darkMode ? 'rgba(160,180,200,0.5)' : 'rgba(100,116,139,0.5)' }}\n                >\n                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                  </svg>\n                </button>\n              </div>\n            </div>\n          )}\n          {sidebarOpen && !docTreeCollapsed && <div className=\"px-2 pb-20 relative ml-4 border-l\" style={{ borderColor: darkMode ? 'rgba(42,159,212,0.3)' : 'rgba(42,159,212,0.2)' }} ref={tocListRef}>\n            {headings.map((heading, index) => {\n              if (isHidden(index)) return null;\n              const level = Math.min(heading.level, 6);\n              const isActive = activeHeadingId === heading.id;\n              const isSelected = heading.selected;\n              const isCollapsible = hasChildren(index);\n              const isCollapsed = collapsed.has(heading.id);\n              const indent = indentClasses[level - 1] || 'ml-0';\n              const textStyle = textStyles[level - 1] || textStyles[5];\n\n              // Drag state: check if this heading is part of the dragged source span\n              const isDragSource = (() => {\n                if (tocDragSourceIdx === null) return false;\n                const srcLevel = headings[tocDragSourceIdx]?.level ?? 1;\n                if (index === tocDragSourceIdx) return true;\n                if (index > tocDragSourceIdx && heading.level > srcLevel) {\n                  // Check it's a descendant — no heading of same/lower level between source and here\n                  for (let i = tocDragSourceIdx + 1; i < index; i++) {\n                    if (headings[i].level <= srcLevel) return false;\n                  }\n                  return true;\n                }\n                return false;\n              })();\n\n              return (\n                <div\n                  key={heading.id}\n                  data-toc-idx={index}\n                  onPointerDown={(e) => handleTocPointerDown(e, index, heading.text)}\n                  onPointerMove={handleTocPointerMove}\n                  onPointerUp={handleTocPointerUp}\n                  style={{\n                    ...getTocGapStyle(index),\n                    ...(isDragSource ? { opacity: 0, pointerEvents: 'none' } : {}),\n                  }}\n                >\n                  {level === 1 && index > 0 && !isDragSource && (\n                    <div className=\"h-px bg-zinc-200 dark:bg-zinc-700 mb-1 mt-2 ml-1\" />\n                  )}\n                  <div\n                    onClick={() => {\n                      if (tocDragState.current?.active) return;\n                      handleHeadingClick(heading.id);\n                    }}\n                    className={`\n                      ${indent} group relative flex items-center space-x-1 py-1 px-1 transition-all duration-300 cursor-pointer border border-transparent\n                      ${isActive ? 'sidebar-node-active' : 'hover:border-blue-300'}\n                      ${isSelected ? 'bg-[rgba(160,200,220,0.2)]' : ''}\n                    `}\n                  >\n                    {isCollapsible ? (\n                      <div\n                        onClick={(e) => { e.stopPropagation(); toggleCollapse(heading.id); }}\n                        className=\"flex-shrink-0 w-4 h-4 flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all duration-200 cursor-pointer\"\n                      >\n                        <svg\n                          width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                          className={`transition-transform duration-200 ${isCollapsed ? '' : 'rotate-90'}`}\n                        >\n                          <polyline points=\"9 18 15 12 9 6\" />\n                        </svg>\n                      </div>\n                    ) : (\n                      <div className=\"flex-shrink-0 w-4 h-4\" />\n                    )}\n\n                    {generatingHeadingIds.has(heading.id) ? (\n                      <div className=\"flex-shrink-0 w-3.5 h-3.5 border-2 border-zinc-300 border-t-zinc-600 rounded-full animate-spin\" />\n                    ) : null}\n\n                    <span\n                      className={`${textStyle} transition-all select-none truncate pr-2 ml-0.5 flex-1 min-w-0`}\n                      style={{ opacity: isActive || isSelected || generatingHeadingIds.has(heading.id) ? 1 : 0.7 }}\n                    >\n                      {heading.text}\n                    </span>\n\n                    {/* Kebab menu button */}\n                    <button\n                      onClick={(e) => { e.stopPropagation(); handleContextMenu(e, heading.id); }}\n                      className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity\"\n                      style={{ color: isActive ? 'rgba(42,159,212,0.6)' : darkMode ? 'rgba(160,180,200,0.4)' : 'rgba(100,116,139,0.4)' }}\n                    >\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                        <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                      </svg>\n                    </button>\n                  </div>\n                </div>\n              );\n            })}\n\n            {/* TOC drag ghost */}\n            {tocDragGhostStyle && (\n              <div\n                className=\"flex items-center gap-1 px-2 py-1 rounded-lg bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-600 shadow-lg dark:shadow-black/30\"\n                style={tocDragGhostStyle}\n              >\n                <p className=\"text-[11px] font-semibold text-zinc-800 dark:text-zinc-200 truncate\">{tocDragGhostText.current}</p>\n              </div>\n            )}\n\n            {headings.length === 0 && (\n              <p className=\"text-[10px] text-zinc-500 dark:text-zinc-400 px-2 py-4 text-center\">No headings</p>\n            )}\n          </div>}\n        </aside>\n        ) : null}\n\n        {/* TOC sidebar resize divider (only when default TOC sidebar is open) */}\n        {!sidebarContent && !hideSidebar && sidebarOpen && (\n          <div\n            className=\"shrink-0 w-1 cursor-col-resize group relative select-none\"\n            onPointerDown={handleTocDividerDown}\n            onPointerMove={handleTocDividerMove}\n            onPointerUp={handleTocDividerUp}\n          >\n            <div className=\"absolute inset-y-0 left-0 w-px bg-zinc-100 dark:bg-zinc-700 group-hover:bg-zinc-300 dark:group-hover:bg-zinc-600 transition-colors\" />\n          </div>\n        )}\n\n        {/* Scrollable Editor Area */}\n        <div ref={scrollContainerRef} className=\"flex-1 overflow-y-auto\">\n          <div className=\"max-w-4xl mx-auto px-4 py-6\">\n            <div\n              ref={editorRef}\n              contentEditable\n              onKeyDown={handleEditorKeyDown}\n              onInput={editing.updateActiveFormatStates}\n              onClick={(e) => {\n                // Tier 1: clicking in editor content selects the heading section in TOC\n                let node = e.target as HTMLElement | null;\n                // Check if clicked element itself is a heading\n                if (node && /^H[1-6]$/i.test(node.tagName) && node.id) {\n                  editing.deselectAll();\n                  setActiveHeadingId(node.id);\n                  return;\n                }\n                // Otherwise walk previous siblings to find the nearest preceding heading\n                while (node && node !== editorRef.current) {\n                  let prev = node.previousElementSibling as HTMLElement | null;\n                  while (prev) {\n                    if (/^H[1-6]$/i.test(prev.tagName) && prev.id) {\n                      editing.deselectAll();\n                      setActiveHeadingId(prev.id);\n                      return;\n                    }\n                    prev = prev.previousElementSibling as HTMLElement | null;\n                  }\n                  node = node.parentElement;\n                }\n              }}\n              className=\"document-prose chat-prose min-h-[70vh] pb-40 outline-none\"\n            />\n          </div>\n        </div>\n      </div>\n    </>\n  );\n\n  // ── Context Menu (rendered as portal in both modes for correct positioning) ──\n  const contextMenuEl = contextMenu && contextHeading ? createPortal(\n    <div\n      ref={menuRef}\n      className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 animate-in fade-in zoom-in-95 duration-150\"\n      style={{\n        top: contextMenu.y,\n        left: contextMenu.x,\n      }}\n    >\n      {onGenerateCard && (\n        <>\n          <div className=\"relative\">\n            <button\n              onClick={() => setGenerateContentSubmenuOpen(prev => !prev)}\n              onMouseEnter={() => { setGenerateContentSubmenuOpen(true); setLevelSubmenuOpen(false); }}\n              className=\"w-full text-left px-3 py-2 text-[11px] font-bold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n            >\n              <span className=\"flex items-center gap-2\">\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                  <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n                </svg>\n                Generate Card Content{getTier2Ids().length > 1 ? ' for Highlighted Items' : ''}\n              </span>\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                <polyline points=\"9 18 15 12 9 6\" />\n              </svg>\n            </button>\n\n            {generateContentSubmenuOpen && (\n              <div\n                ref={generateSubmenuRef}\n                className=\"absolute left-full top-0 ml-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 animate-in fade-in zoom-in-95 duration-100\"\n              >\n                {([\n                  { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                  { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                  { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n                ]).map(opt => (\n                  <button\n                    key={opt.level}\n                    onClick={async () => {\n                      const ids = getTier2Ids();\n                      const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                      closeMenu();\n                      await Promise.all(targets.map(t => onGenerateCard(t.id, opt.level, t.text, doc.name)));\n                    }}\n                    className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                  >\n                    <span className=\"font-medium\">{opt.label}</span>\n                    <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                  </button>\n                ))}\n\n                {/* Divider */}\n                <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n                {/* Title/Takeaway card options */}\n                {([\n                  { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                  { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n                ]).map(opt => (\n                  <button\n                    key={opt.level}\n                    onClick={async () => {\n                      const ids = getTier2Ids();\n                      const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                      closeMenu();\n                      await Promise.all(targets.map(t => onGenerateCard(t.id, opt.level, t.text, doc.name)));\n                    }}\n                    className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                  >\n                    <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                    <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                  </button>\n                ))}\n\n                {/* Divider */}\n                <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n                {/* Direct Content option — raw content as-is */}\n                <button\n                  onClick={async () => {\n                    const ids = getTier2Ids();\n                    const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                    closeMenu();\n                    await Promise.all(targets.map(t => onGenerateCard(t.id, 'DirectContent' as DetailLevel, t.text, doc.name)));\n                  }}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                >\n                  <span className=\"font-medium text-emerald-600\">Direct Content</span>\n                  <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">Raw as-is</span>\n                </button>\n              </div>\n            )}\n          </div>\n          <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n        </>\n      )}\n\n      <button\n        onClick={handleSelectHeadingAndContent}\n        onMouseEnter={() => { setLevelSubmenuOpen(false); setGenerateContentSubmenuOpen(false); }}\n        className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n      >\n        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n          <path d=\"M5 3a2 2 0 0 0-2 2\"/><path d=\"M19 3a2 2 0 0 1 2 2\"/><path d=\"M21 19a2 2 0 0 1-2 2\"/><path d=\"M5 21a2 2 0 0 1-2-2\"/><path d=\"M9 3h1\"/><path d=\"M9 21h1\"/><path d=\"M14 3h1\"/><path d=\"M14 21h1\"/><path d=\"M3 9v1\"/><path d=\"M21 9v1\"/><path d=\"M3 14v1\"/><path d=\"M21 14v1\"/>\n        </svg>\n        Select Heading and Content\n      </button>\n\n      <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n      <button\n        onClick={handlePromote}\n        disabled={!canPromote}\n        onMouseEnter={() => { setLevelSubmenuOpen(false); setGenerateContentSubmenuOpen(false); }}\n        className={`w-full text-left px-3 py-2 text-[11px] hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors flex items-center gap-2 ${canPromote ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-500 dark:text-zinc-400 pointer-events-none'}`}\n      >\n        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className={canPromote ? 'text-zinc-500 dark:text-zinc-400' : 'text-zinc-500 dark:text-zinc-400'}>\n          <path d=\"m15 18-6-6 6-6\"/>\n        </svg>\n        Promote\n        <span className={`ml-auto text-[9px] ${canPromote ? 'text-zinc-500 dark:text-zinc-400' : 'text-zinc-500 dark:text-zinc-400'}`}>H{contextHeading.level}→H{Math.max(1, contextHeading.level - 1)}</span>\n      </button>\n\n      <button\n        onClick={handleDemote}\n        disabled={!canDemote}\n        onMouseEnter={() => { setLevelSubmenuOpen(false); setGenerateContentSubmenuOpen(false); }}\n        className={`w-full text-left px-3 py-2 text-[11px] hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors flex items-center gap-2 ${canDemote ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-500 dark:text-zinc-400 pointer-events-none'}`}\n      >\n        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className={canDemote ? 'text-zinc-500 dark:text-zinc-400' : 'text-zinc-500 dark:text-zinc-400'}>\n          <path d=\"m9 18 6-6-6-6\"/>\n        </svg>\n        Demote\n        <span className={`ml-auto text-[9px] ${canDemote ? 'text-zinc-500 dark:text-zinc-400' : 'text-zinc-500 dark:text-zinc-400'}`}>H{contextHeading.level}→H{Math.min(6, contextHeading.level + 1)}</span>\n      </button>\n\n      <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n      <button\n        onClick={expandAll}\n        onMouseEnter={() => { setLevelSubmenuOpen(false); setGenerateContentSubmenuOpen(false); }}\n        className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n      >\n        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n          <polyline points=\"6 9 12 15 18 9\" />\n        </svg>\n        Expand All\n      </button>\n\n      <button\n        onClick={collapseAll}\n        onMouseEnter={() => { setLevelSubmenuOpen(false); setGenerateContentSubmenuOpen(false); }}\n        className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n      >\n        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n          <polyline points=\"18 15 12 9 6 15\" />\n        </svg>\n        Collapse All\n      </button>\n\n      <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n      <div className=\"relative\">\n        <button\n          onClick={() => setLevelSubmenuOpen(prev => !prev)}\n          onMouseEnter={() => { setLevelSubmenuOpen(true); setGenerateContentSubmenuOpen(false); }}\n          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n        >\n          <span className=\"flex items-center gap-2\">\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n              <line x1=\"21\" y1=\"10\" x2=\"7\" y2=\"10\" /><line x1=\"21\" y1=\"6\" x2=\"3\" y2=\"6\" /><line x1=\"21\" y1=\"14\" x2=\"3\" y2=\"14\" /><line x1=\"21\" y1=\"18\" x2=\"7\" y2=\"18\" />\n            </svg>\n            Select Heading Levels\n          </span>\n          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n            <polyline points=\"9 18 15 12 9 6\" />\n          </svg>\n        </button>\n\n        {levelSubmenuOpen && (\n          <div\n            ref={levelSubmenuRef}\n            className=\"absolute left-full top-0 ml-1 min-w-[140px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap\"\n          >\n            {([\n              { label: 'H1 Only',     tag: 'H1',   levels: [1] },\n              { label: 'H2 Only',     tag: 'H2',   levels: [2] },\n              { label: 'H3 Only',     tag: 'H3',   levels: [3] },\n              { label: 'H1 + H2',     tag: 'H1–2', levels: [1, 2] },\n              { label: 'H2 + H3',     tag: 'H2–3', levels: [2, 3] },\n              { label: 'All Levels',   tag: 'All',  levels: [1, 2, 3] },\n            ] as { label: string; tag: string; levels: number[] }[]).map(opt => (\n              <button\n                key={opt.label}\n                onClick={() => handleSelectLevel(opt.levels)}\n                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n              >\n                <span className=\"w-7 h-4 rounded bg-zinc-100 dark:bg-zinc-800/50 text-[9px] font-bold text-zinc-500 dark:text-zinc-400 flex items-center justify-center\">\n                  {opt.tag}\n                </span>\n                {opt.label}\n              </button>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>,\n    document.body,\n  ) : null;\n\n  // ── Document-level context menu (right-click on doc name → Generate Card for whole doc) ──\n  const docContextMenuEl = docContextMenu && onGenerateCard ? createPortal(\n    <div\n      className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 animate-in fade-in zoom-in-95 duration-150\"\n      style={{\n        top: Math.min(docContextMenu.y, window.innerHeight - 200),\n        left: Math.min(docContextMenu.x, window.innerWidth - 220),\n      }}\n      onMouseDown={(e) => e.stopPropagation()}\n      onContextMenu={(e) => e.preventDefault()}\n    >\n      <div className=\"relative\">\n        <button\n          onClick={() => setDocGenerateSubmenuOpen(prev => !prev)}\n          onMouseEnter={() => setDocGenerateSubmenuOpen(true)}\n          className=\"w-full text-left px-3 py-2 text-[11px] font-bold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n        >\n          <span className=\"flex items-center gap-2\">\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n              <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n            </svg>\n            Generate Card for Whole Document\n          </span>\n          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n            <polyline points=\"9 18 15 12 9 6\" />\n          </svg>\n        </button>\n\n        {docGenerateSubmenuOpen && (\n          <div className=\"absolute left-full top-0 ml-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 animate-in fade-in zoom-in-95 duration-100\">\n            {([\n              { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n              { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n              { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n            ]).map(opt => (\n              <button\n                key={opt.level}\n                onClick={async () => {\n                  setDocContextMenu(null);\n                  setDocGenerateSubmenuOpen(false);\n                  await onGenerateCard('__whole_document__', opt.level, doc.name, doc.name);\n                }}\n                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n              >\n                <span className=\"font-medium\">{opt.label}</span>\n                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n              </button>\n            ))}\n\n            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n            {([\n              { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n              { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n            ]).map(opt => (\n              <button\n                key={opt.level}\n                onClick={async () => {\n                  setDocContextMenu(null);\n                  setDocGenerateSubmenuOpen(false);\n                  await onGenerateCard('__whole_document__', opt.level, doc.name, doc.name);\n                }}\n                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n              >\n                <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n              </button>\n            ))}\n\n            {/* Divider */}\n            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n            {/* Direct Content option — raw content as-is */}\n            <button\n              onClick={async () => {\n                setDocContextMenu(null);\n                setDocGenerateSubmenuOpen(false);\n                await onGenerateCard('__whole_document__', 'DirectContent' as DetailLevel, doc.name, doc.name);\n              }}\n              className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n            >\n              <span className=\"font-medium text-emerald-600\">Direct Content</span>\n              <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">Raw as-is</span>\n            </button>\n          </div>\n        )}\n      </div>\n    </div>,\n    document.body,\n  ) : null;\n\n  // Close doc context menu on outside click\n  useEffect(() => {\n    if (!docContextMenu) return;\n    const handler = (e: MouseEvent) => {\n      setDocContextMenu(null);\n      setDocGenerateSubmenuOpen(false);\n    };\n    // Delay so the context menu render isn't immediately caught\n    const timer = setTimeout(() => document.addEventListener('mousedown', handler), 0);\n    return () => { clearTimeout(timer); document.removeEventListener('mousedown', handler); };\n  }, [docContextMenu]);\n\n  // ── Inline mode: render directly without portal ──\n  if (isInline) {\n    return (\n      <div className=\"flex flex-col flex-1 overflow-hidden\">\n        {editorBody}\n        {contextMenuEl}\n        {docContextMenuEl}\n        {showUnsavedDialog && (\n          <UnsavedChangesDialog\n            onSave={confirmSave}\n            onDiscard={confirmDiscard}\n            onCancel={() => setShowUnsavedDialog(false)}\n          />\n        )}\n      </div>\n    );\n  }\n\n  // ── Modal mode: render in portal with backdrop ──\n  return createPortal(\n    <div className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/40 dark:bg-black/60 backdrop-blur-sm\">\n      <div className=\"flex flex-col w-full h-full max-w-6xl max-h-[94vh] my-[3vh] mx-4 bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 overflow-hidden\">\n        {/* Header */}\n        <div className=\"shrink-0 h-[44px] flex items-center justify-between px-5 border-b border-zinc-100 dark:border-zinc-600\">\n          <div className=\"flex items-center gap-2.5 min-w-0\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z\" />\n              <polyline points=\"14 2 14 8 20 8\" />\n            </svg>\n            <span className=\"text-xs text-zinc-600 dark:text-zinc-400 truncate font-medium\" title={doc.name}>{doc.name}</span>\n            {editing.isDirty && (\n              <span className=\"text-[9px] text-amber-500 font-medium uppercase tracking-wider\">Unsaved</span>\n            )}\n          </div>\n          <button\n            onClick={handleDiscardAndClose}\n            title=\"Close\"\n            className=\"shrink-0 p-1 rounded-md text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n          >\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M18 6 6 18\" /><path d=\"m6 6 12 12\" />\n            </svg>\n          </button>\n        </div>\n\n        {editorBody}\n      </div>\n\n      {contextMenuEl}\n      {docContextMenuEl}\n\n      {showUnsavedDialog && (\n        <UnsavedChangesDialog\n          onSave={confirmSave}\n          onDiscard={confirmDiscard}\n          onCancel={() => setShowUnsavedDialog(false)}\n          {...(isCustomCard ? {\n            title: 'Custom card',\n            description: 'Name your card and save it to the cards list, or discard it.',\n            saveLabel: 'Save and Add to Cards',\n            discardLabel: 'Discard Changes',\n            nameInput: {\n              defaultName: doc.name,\n              existingNames: existingCardNames || [],\n              onSaveWithName: (name: string) => {\n                setShowUnsavedDialog(false);\n                editing.saveEdits();\n                onSaveCustomCard?.(name);\n                onClose();\n              },\n            },\n          } : {})}\n        />\n      )}\n    </div>,\n    document.body,\n  );\n});\n\nexport default DocumentEditorModal;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\FindReplaceBar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":41,"column":62,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":41,"endColumn":99},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":41,"column":126,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":41,"endColumn":141,"fix":{"range":[1810,1825],"text":"{closeFindBar();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":76,"column":61,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":76,"endColumn":76,"fix":{"range":[5020,5035],"text":"{closeFindBar();}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":2,"source":"\nimport React from 'react';\n\ninterface FindReplaceBarProps {\n  findInputRef: React.RefObject<HTMLInputElement | null>;\n  findQuery: string;\n  setFindQuery: (q: string) => void;\n  replaceQuery: string;\n  setReplaceQuery: (q: string) => void;\n  findMatchCount: number;\n  findActiveIndex: number;\n  setFindActiveIndex: (i: number) => void;\n  findMatchCase: boolean;\n  setFindMatchCase: React.Dispatch<React.SetStateAction<boolean>>;\n  findNext: () => void;\n  findPrev: () => void;\n  closeFindBar: () => void;\n  handleReplace: () => void;\n  handleReplaceAll: () => void;\n}\n\nexport const FindReplaceBar: React.FC<FindReplaceBarProps> = ({\n  findInputRef, findQuery, setFindQuery, replaceQuery, setReplaceQuery,\n  findMatchCount, findActiveIndex, setFindActiveIndex,\n  findMatchCase, setFindMatchCase,\n  findNext, findPrev, closeFindBar,\n  handleReplace, handleReplaceAll,\n}) => {\n  return (\n    <div data-find-bar className=\"z-30 px-6 lg:px-8 pb-3 pt-3 bg-white dark:bg-zinc-900 border-b border-zinc-100/60 dark:border-zinc-600/60 animate-in fade-in slide-in-from-top-2 duration-200\">\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"bg-white/80 dark:bg-zinc-800/80 backdrop-blur-xl border border-zinc-100/80 dark:border-zinc-600/80 rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.06)] dark:shadow-[0_4px_20px_rgba(0,0,0,0.3)] p-3 space-y-2\">\n          {/* Find row */}\n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex-1 relative\">\n              <input\n                ref={findInputRef}\n                type=\"text\"\n                value={findQuery}\n                onChange={(e) => { setFindQuery(e.target.value); setFindActiveIndex(0); }}\n                onKeyDown={(e) => { if (e.key === 'Enter') { e.shiftKey ? findPrev() : findNext(); } if (e.key === 'Escape') closeFindBar(); }}\n                placeholder=\"Find...\"\n                className=\"w-full pl-3 pr-16 py-2 rounded-xl bg-zinc-50 dark:bg-zinc-800 border border-zinc-100 dark:border-zinc-600 text-xs text-zinc-600 dark:text-zinc-300 placeholder:text-zinc-500 dark:placeholder:text-zinc-500 focus:outline-none focus:border-zinc-300 dark:focus:border-zinc-600 transition-colors\"\n              />\n              {findQuery && (\n                <span className=\"absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-medium uppercase text-zinc-500 dark:text-zinc-400\">\n                  {findMatchCount > 0 ? `${findActiveIndex + 1} of ${findMatchCount}` : 'No matches'}\n                </span>\n              )}\n            </div>\n            <button\n              onClick={() => { setFindMatchCase(prev => !prev); setFindActiveIndex(0); }}\n              className={`w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-medium uppercase transition-all ${findMatchCase ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}\n              title=\"Match case\"\n            >\n              Aa\n            </button>\n            <button onClick={findPrev} disabled={findMatchCount === 0} className=\"w-7 h-7 rounded-full flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 disabled:opacity-40 disabled:pointer-events-none transition-all\" title=\"Previous match\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"m18 15-6-6-6 6\"/></svg>\n            </button>\n            <button onClick={findNext} disabled={findMatchCount === 0} className=\"w-7 h-7 rounded-full flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 disabled:opacity-40 disabled:pointer-events-none transition-all\" title=\"Next match\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"m6 9 6 6 6-6\"/></svg>\n            </button>\n            <button onClick={closeFindBar} className=\"w-7 h-7 rounded-full flex items-center justify-center hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400 transition-all\" title=\"Close\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M18 6 6 18\"/><path d=\"m6 6 12 12\"/></svg>\n            </button>\n          </div>\n\n          {/* Replace row */}\n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex-1\">\n              <input\n                type=\"text\"\n                value={replaceQuery}\n                onChange={(e) => setReplaceQuery(e.target.value)}\n                onKeyDown={(e) => { if (e.key === 'Escape') closeFindBar(); }}\n                placeholder=\"Replace...\"\n                className=\"w-full pl-3 pr-3 py-2 rounded-xl bg-zinc-50 dark:bg-zinc-800 border border-zinc-100 dark:border-zinc-600 text-xs text-zinc-600 dark:text-zinc-300 placeholder:text-zinc-500 dark:placeholder:text-zinc-500 focus:outline-none focus:border-zinc-300 dark:focus:border-zinc-600 transition-colors\"\n              />\n            </div>\n            <button onClick={handleReplace} disabled={findMatchCount === 0} className=\"h-7 px-2.5 rounded-full text-[10px] font-medium uppercase tracking-wider text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 disabled:opacity-40 disabled:pointer-events-none transition-all\" title=\"Replace\">\n              Replace\n            </button>\n            <button onClick={handleReplaceAll} disabled={findMatchCount === 0} className=\"h-7 px-2.5 rounded-full text-[10px] font-medium uppercase tracking-wider text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 disabled:opacity-40 disabled:pointer-events-none transition-all\" title=\"Replace all\">\n              All\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\FormatToolbar.tsx","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":34,"column":200,"nodeType":"Literal","messageId":"defineConstant","endLine":34,"endColumn":263},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":34,"column":266,"nodeType":"Literal","messageId":"defineConstant","endLine":34,"endColumn":386},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":66,"column":71,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":66,"endColumn":123,"fix":{"range":[6438,6490],"text":"{setTimeout(() => findInputRef.current?.focus(), 50);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":66,"column":119,"nodeType":"Literal","messageId":"noMagic","endLine":66,"endColumn":121}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\nimport React from 'react';\n\ninterface FormatToolbarProps {\n  activeFormats: Set<string>;\n  executeCommand: (command: string, value?: string) => void;\n  insertTable: () => void;\n  showFind: boolean;\n  setShowFind: React.Dispatch<React.SetStateAction<boolean>>;\n  findInputRef: React.RefObject<HTMLInputElement | null>;\n  isDirty: boolean;\n  onSave: () => void;\n  hasContent: boolean;\n}\n\nexport const FormatToolbar: React.FC<FormatToolbarProps> = ({\n  activeFormats, executeCommand, insertTable,\n  showFind, setShowFind, findInputRef,\n  isDirty, onSave, hasContent,\n}) => {\n  const disabled = !hasContent;\n  const btnBase = \"w-7 h-7 rounded-full flex items-center justify-center transition-all\";\n  const disabledClass = disabled ? \"opacity-40 pointer-events-none\" : \"\";\n\n  return (\n    <div className=\"z-30 flex items-center justify-center px-1.5 h-9 animate-in fade-in slide-in-from-top-2 duration-300\">\n      <div className=\"flex items-center space-x-1\">\n        <button onClick={() => executeCommand('undo')} className={`${btnBase} hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400 ${disabledClass}`} title=\"Undo\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><path d=\"M9 14L4 9l5-5\"/><path d=\"M20 20v-7a4 4 0 0 0-4-4H4\"/></svg></button>\n        <button onClick={() => executeCommand('redo')} className={`${btnBase} hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400 ${disabledClass}`} title=\"Redo\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><path d=\"M15 14l5-5-5-5\"/><path d=\"M4 20v-7a4 4 0 0 1 4-4h12\"/></svg></button>\n\n        <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n        {['H1', 'H2', 'H3'].map(h => (\n          <button key={h} onClick={() => executeCommand('formatBlock', h)} className={`w-7 h-7 rounded-full text-[11px] font-medium uppercase transition-all ${disabledClass} ${activeFormats.has(h) ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}>{h}</button>\n        ))}\n\n        <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n        <button onClick={() => executeCommand('bold')} className={`w-7 h-7 rounded-full text-[11px] font-medium uppercase transition-all ${disabledClass} ${activeFormats.has('bold') ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`} title=\"Bold\"><b>B</b></button>\n        <button onClick={() => executeCommand('italic')} className={`w-7 h-7 rounded-full text-[11px] font-medium uppercase transition-all ${disabledClass} ${activeFormats.has('italic') ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`} title=\"Italic\"><i>I</i></button>\n\n        <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n        <button onClick={() => executeCommand('insertUnorderedList')} className={`${btnBase} ${disabledClass} ${activeFormats.has('unorderedList') ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`} title=\"Bullet list\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><line x1=\"8\" y1=\"6\" x2=\"21\" y2=\"6\"/><line x1=\"8\" y1=\"12\" x2=\"21\" y2=\"12\"/><line x1=\"8\" y1=\"18\" x2=\"21\" y2=\"18\"/><line x1=\"3\" y1=\"6\" x2=\"3.01\" y2=\"6\"/><line x1=\"3\" y1=\"12\" x2=\"3.01\" y2=\"12\"/><line x1=\"3\" y1=\"18\" x2=\"3.01\" y2=\"18\"/></svg>\n        </button>\n        <button onClick={() => executeCommand('insertOrderedList')} className={`${btnBase} ${disabledClass} ${activeFormats.has('orderedList') ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`} title=\"Numbered list\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><line x1=\"10\" y1=\"6\" x2=\"21\" y2=\"6\"/><line x1=\"10\" y1=\"12\" x2=\"21\" y2=\"12\"/><line x1=\"10\" y1=\"18\" x2=\"21\" y2=\"18\"/><path d=\"M4 6h1v4\"/><path d=\"M4 10h2\"/><path d=\"M6 18H4c0-1 2-2 2-3s-1-1.5-2-1\"/></svg>\n        </button>\n\n        <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n        <button onClick={() => insertTable()} className={`${btnBase} hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400 ${disabledClass}`} title=\"Insert table\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\"/><line x1=\"3\" y1=\"9\" x2=\"21\" y2=\"9\"/><line x1=\"3\" y1=\"15\" x2=\"21\" y2=\"15\"/><line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\"/><line x1=\"15\" y1=\"3\" x2=\"15\" y2=\"21\"/></svg>\n        </button>\n        <button onClick={() => executeCommand('insertHorizontalRule')} className={`${btnBase} hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400 ${disabledClass}`} title=\"Horizontal rule\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg>\n        </button>\n        <button onClick={() => executeCommand('removeFormat')} className={`${btnBase} hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400 ${disabledClass}`} title=\"Clear formatting\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\"><path d=\"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21\"/><path d=\"M22 21H7\"/><path d=\"m5 11 9 9\"/></svg>\n        </button>\n\n        <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n        <button\n          onClick={() => { setShowFind(prev => !prev); if (!showFind) setTimeout(() => findInputRef.current?.focus(), 50); }}\n          className={`${btnBase} ${disabledClass} ${showFind ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}\n          title=\"Find & Replace (Ctrl+F)\"\n        >\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n            <circle cx=\"11\" cy=\"11\" r=\"8\"/><path d=\"m21 21-4.3-4.3\"/>\n          </svg>\n        </button>\n\n        {/* Save */}\n        <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n        <button\n          onClick={onSave}\n          disabled={!isDirty}\n          className={`${btnBase} ${isDirty ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200 hover:bg-zinc-300' : 'text-zinc-600 dark:text-zinc-400 opacity-40 pointer-events-none'}`}\n          title=\"Save changes (Ctrl+S)\"\n        >\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n            <polyline points=\"20 6 9 17 4 12\"/>\n          </svg>\n        </button>\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\InsightsCardList.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":41,"column":67,"nodeType":null,"messageId":"refactorFunction","endLine":41,"endColumn":69},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":60,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":63,"endColumn":24},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":61,"column":15,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":63,"endColumn":24},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":62,"column":15,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":63,"endColumn":24},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":66,"column":15,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":66,"endColumn":131},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":66,"column":58,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":66,"endColumn":131,"fix":{"range":[3021,3094],"text":"(isDirect ? 'text-emerald-600 bg-emerald-50' : 'text-zinc-500 bg-zinc-100')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":105,"column":51,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":105,"endColumn":131},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":122,"column":27,"nodeType":"Identifier","messageId":"noArrayIndex","endLine":122,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onSelectExclusive' is defined but never used. Allowed unused args must match /^_/u.","line":151,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":151,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onSelectRange' is defined but never used. Allowed unused args must match /^_/u.","line":152,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":152,"endColumn":16},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":198,"column":67,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":198,"endColumn":74,"fix":{"range":[8544,8551],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":199,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":199,"endColumn":54,"fix":{"range":[8598,8605],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":207,"column":14,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":207,"endColumn":21,"fix":{"range":[8898,9051],"text":"if (cardEls) for (const cel of cardEls) {\n      const r = (cel as HTMLElement).getBoundingClientRect();\n      cardRects.push({ top: r.top, height: r.height });\n    }"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":226,"column":65,"nodeType":null,"messageId":"refactorFunction","endLine":226,"endColumn":67},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":228,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":228,"endColumn":21,"fix":{"range":[9512,9519],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":234,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":234,"endColumn":17},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":234,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":234,"endColumn":26,"fix":{"range":[9650,9657],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":259,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":259,"endColumn":40,"fix":{"range":[10341,10350],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":263,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":263,"endColumn":41,"fix":{"range":[10516,10527],"text":"{target = i;}"}},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":266,"column":9,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":266,"endColumn":52},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":278,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":278,"endColumn":21,"fix":{"range":[10887,10894],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":294,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":294,"endColumn":30,"fix":{"range":[11299,11306],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":308,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":308,"endColumn":50,"fix":{"range":[11815,11822],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":314,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":314,"endColumn":65,"fix":{"range":[12031,12069],"text":"{y = Math.max(4, vh - rect.height - 4);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":314,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":314,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":314,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":314,"endColumn":63},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":315,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":315,"endColumn":63,"fix":{"range":[12095,12132],"text":"{x = Math.max(4, vw - rect.width - 4);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":315,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":315,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":315,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":315,"endColumn":61},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":332,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":332,"endColumn":53,"fix":{"range":[12541,12573],"text":"{renameInputRef.current?.focus();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":341,"column":52,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":341,"endColumn":59,"fix":{"range":[12952,12959],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":377,"column":90,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":377,"endColumn":100,"fix":{"range":[14196,14206],"text":"{return {};}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 28.","line":378,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":378,"endColumn":52},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":382,"column":66,"nodeType":"Literal","messageId":"defineConstant","endLine":382,"endColumn":88},{"ruleId":"no-lonely-if","severity":1,"message":"Unexpected if as the only statement in an else block.","line":386,"column":7,"nodeType":"IfStatement","messageId":"unexpectedLonelyIf","endLine":388,"endColumn":8},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":403,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":403,"endColumn":63,"fix":{"range":[15365,15381],"text":"{onDeselectAll();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":403,"column":69,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":403,"endColumn":83,"fix":{"range":[15387,15401],"text":"{onSelectAll();}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":421,"column":30,"nodeType":null,"messageId":"refactorFunction","endLine":421,"endColumn":32},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":461,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":461,"endColumn":53,"fix":{"range":[18455,18462],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":524,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":524,"endColumn":68,"fix":{"range":[21834,21856],"text":"{commitRename(card.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":558,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":558,"endColumn":32,"fix":{"range":[23522,23534],"text":"{return null;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasCard' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":560,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":560,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasSynthesis' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":561,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":561,"endColumn":27},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":795,"column":34,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":795,"endColumn":41,"fix":{"range":[38100,38146],"text":"for (const c of selected) onGenerateCardImage(c);"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":830,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":830,"endColumn":32,"fix":{"range":[40042,40054],"text":"{return null;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":838,"column":49,"nodeType":"Literal","messageId":"defineConstant","endLine":838,"endColumn":69},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":838,"column":78,"nodeType":"Literal","messageId":"defineConstant","endLine":838,"endColumn":91},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":971,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":971,"endColumn":46,"fix":{"range":[48446,48453],"text":"{return;}"}}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":44,"fixableErrorCount":0,"fixableWarningCount":24,"source":"\nimport React, { useState, useRef, useEffect, useCallback } from 'react';\nimport { createPortal } from 'react-dom';\nimport { Card, DetailLevel, isCoverLevel } from '../types';\nimport { isNameTaken } from '../utils/naming';\nimport { formatTimestampFull } from '../utils/formatTime';\nimport PanelRequirements from './PanelRequirements';\n\ninterface InsightsCardListProps {\n  cards: Card[];\n  activeCardId: string | null;\n  onCardClick: (id: string) => void;\n  onCardDoubleClick?: (id: string) => void;\n  onToggleSelection: (id: string) => void;\n  onSelectExclusive: (id: string) => void;\n  onSelectRange: (fromId: string, toId: string) => void;\n  onSelectAll: () => void;\n  onDeselectAll: () => void;\n  onDeleteCard: (id: string) => void;\n  onDeleteSelectedCards: () => void;\n  onRenameCard: (id: string, newName: string) => void;\n  // Copy/Move\n  onCopyMoveCard?: (cardId: string, targetNuggetId: string, mode: 'copy' | 'move') => void;\n  otherNuggets?: { id: string; name: string }[];\n  projectNuggets?: { projectId: string; projectName: string; nuggets: { id: string; name: string }[] }[];\n  onCreateNuggetForCard?: (nuggetName: string, cardId: string | null) => void;\n  /** The active detail level from the parent — used to look up synthesisMap/cardUrlMap for Card Info */\n  activeDetailLevel?: DetailLevel;\n  onGenerateCardImage?: (card: Card) => void;\n  onReorderCards?: (fromIndex: number, toIndex: number) => void;\n}\n\n\n// -- Inline info content used inside the hover submenu --\n\ninterface InfoContentProps {\n  card: Card;\n  level: DetailLevel;\n}\n\nconst InfoContent: React.FC<InfoContentProps> = ({ card, level }) => {\n  // Image version count and last image timestamp\n  const versions = card.imageHistoryMap?.[level];\n  const versionCount = versions ? versions.length : 0;\n  const lastImageTs = versions && versions.length > 0 ? versions[versions.length - 1].timestamp : undefined;\n\n  // Image staleness: red if content was modified after the last image generation\n  const lastModifiedTs = card.lastEditedAt && card.lastEditedAt !== card.createdAt ? card.lastEditedAt : undefined;\n  const imageStale = !!(lastImageTs && lastModifiedTs && lastModifiedTs > lastImageTs);\n\n  return (\n    <>\n      {/* Header */}\n      <div className=\"px-3 py-2 border-b border-zinc-100 dark:border-zinc-600 flex items-center justify-between\">\n        <p className=\"text-[10px] font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider\">Card Info</p>\n        {(() => {\n          const cardLevel = card.detailLevel || 'Standard';\n          const isCover = isCoverLevel(cardLevel);\n          const isDirect = cardLevel === 'DirectContent';\n          const label = cardLevel === 'TitleCard' ? 'Title Card'\n            : cardLevel === 'TakeawayCard' ? 'Takeaway Card'\n            : cardLevel === 'DirectContent' ? 'Direct'\n            : cardLevel;\n          return (\n            <span className={`text-[8px] font-bold uppercase tracking-wider px-1.5 py-[2px] rounded ${\n              isCover ? 'text-violet-600 bg-violet-50' : isDirect ? 'text-emerald-600 bg-emerald-50' : 'text-zinc-500 bg-zinc-100'\n            }`}>\n              {label}\n            </span>\n          );\n        })()}\n      </div>\n\n      {/* Info rows */}\n      <div className=\"px-3 py-2.5 space-y-2\">\n        {/* Content generated */}\n        <div className=\"flex items-baseline justify-between\">\n          <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">Content generated</span>\n          <span className=\"text-[10px] text-zinc-600 dark:text-zinc-400\">\n            {card.createdAt ? formatTimestampFull(card.createdAt) : '—'}\n          </span>\n        </div>\n\n        {/* Content last modified */}\n        <div className=\"flex items-baseline justify-between\">\n          <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">Content last modified</span>\n          <span className=\"text-[10px] text-zinc-600 dark:text-zinc-400\">\n            {card.lastEditedAt && card.lastEditedAt !== card.createdAt ? formatTimestampFull(card.lastEditedAt) : '—'}\n          </span>\n        </div>\n\n        {/* Divider */}\n        <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n\n        {/* Image versions */}\n        <div className=\"flex items-baseline justify-between\">\n          <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">Image versions</span>\n          <span className=\"text-[10px] text-zinc-600 dark:text-zinc-400\">{versionCount > 0 ? versionCount : '—'}</span>\n        </div>\n\n        {/* Last image generated — red if stale, green if fresh */}\n        <div className=\"flex items-baseline justify-between\">\n          <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">Last image generated</span>\n          <span\n            className={`text-[10px] font-medium ${lastImageTs ? (imageStale ? 'text-red-500' : 'text-green-600') : 'text-zinc-600'}`}\n          >\n            {lastImageTs ? formatTimestampFull(lastImageTs) : '—'}\n          </span>\n        </div>\n\n        {/* Divider */}\n        <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n\n        {/* Source documents */}\n        {card.sourceDocuments && card.sourceDocuments.length > 0 ? (\n          <>\n            <div>\n              <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">Sources</span>\n            </div>\n            <div className=\"space-y-1\">\n              {card.sourceDocuments.map((name, i) => (\n                <div key={i} className=\"flex items-center gap-1.5 text-[10px] text-zinc-600 dark:text-zinc-400\" title={name}>\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-zinc-500 dark:text-zinc-400\">\n                    <path d=\"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z\"/>\n                    <polyline points=\"14 2 14 8 20 8\"/>\n                  </svg>\n                  <span className=\"truncate\">{name}</span>\n                </div>\n              ))}\n            </div>\n          </>\n        ) : (\n          <div className=\"flex items-baseline justify-between\">\n            <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400\">Sources</span>\n            <span className=\"text-[10px] text-zinc-600 dark:text-zinc-400\">—</span>\n          </div>\n        )}\n      </div>\n    </>\n  );\n};\n\n// -- Main component --\n\nconst InsightsCardList: React.FC<InsightsCardListProps> = ({\n  cards,\n  activeCardId,\n  onCardClick,\n  onCardDoubleClick,\n  onToggleSelection,\n  onSelectExclusive,\n  onSelectRange,\n  onSelectAll,\n  onDeselectAll,\n  onDeleteCard,\n  onDeleteSelectedCards,\n  onRenameCard,\n  onCopyMoveCard,\n  otherNuggets,\n  projectNuggets,\n  onCreateNuggetForCard,\n  activeDetailLevel,\n  onGenerateCardImage,\n  onReorderCards,\n}) => {\n  const [contextMenu, setContextMenu] = useState<{ x: number; y: number; cardId: string } | null>(null);\n  const [renamingId, setRenamingId] = useState<string | null>(null);\n  const [renameValue, setRenameValue] = useState('');\n  const [renameError, setRenameError] = useState('');\n  const [showInfoSubmenu, setShowInfoSubmenu] = useState(false);\n  const [showCopyMoveSubmenu, setShowCopyMoveSubmenu] = useState(false);\n  const [confirmDeleteId, setConfirmDeleteId] = useState<string | null>(null);\n  const [confirmDeleteSelected, setConfirmDeleteSelected] = useState(false);\n  const [noNuggetsCardId, setNoNuggetsCardId] = useState<string | null>(null);\n  const [newNuggetName, setNewNuggetName] = useState('');\n  const menuRef = useRef<HTMLDivElement>(null);\n  const renameInputRef = useRef<HTMLInputElement>(null);\n\n  // Pointer-based drag-and-drop reordering\n  const listRef = useRef<HTMLDivElement>(null);\n  const dragState = useRef<{\n    active: boolean;\n    sourceIdx: number;\n    currentIdx: number;\n    startY: number;\n    offsetY: number;\n    cardHeight: number;\n    cardRects: { top: number; height: number }[];\n  } | null>(null);\n  const [dragSourceIdx, setDragSourceIdx] = useState<number | null>(null);\n  const [dragOverIdx, setDragOverIdx] = useState<number | null>(null);\n  const [dragGhostStyle, setDragGhostStyle] = useState<React.CSSProperties | null>(null);\n  const dragGhostRef = useRef<HTMLDivElement>(null);\n  const dragGhostText = useRef('');\n\n  const handlePointerDown = useCallback((e: React.PointerEvent, idx: number, text: string) => {\n    // Only left button, skip if renaming, no reorder handler, or modifier keys\n    if (e.button !== 0 || !onReorderCards || renamingId !== null) return;\n    if (e.metaKey || e.ctrlKey || e.shiftKey) return;\n\n    const el = e.currentTarget as HTMLElement;\n    const rect = el.getBoundingClientRect();\n\n    // Snapshot all card rects for hit-testing during drag\n    const cardEls = listRef.current?.querySelectorAll('[data-card-idx]');\n    const cardRects: { top: number; height: number }[] = [];\n    cardEls?.forEach((cel) => {\n      const r = (cel as HTMLElement).getBoundingClientRect();\n      cardRects.push({ top: r.top, height: r.height });\n    });\n\n    dragState.current = {\n      active: false,\n      sourceIdx: idx,\n      currentIdx: idx,\n      startY: e.clientY,\n      offsetY: e.clientY - rect.top,\n      cardHeight: rect.height,\n      cardRects,\n    };\n    dragGhostText.current = text;\n\n    (e.target as HTMLElement).setPointerCapture(e.pointerId);\n  }, [onReorderCards, renamingId]);\n\n  const handlePointerMove = useCallback((e: React.PointerEvent) => {\n    const ds = dragState.current;\n    if (!ds) return;\n\n    const dy = Math.abs(e.clientY - ds.startY);\n\n    // Activate drag after 4px movement\n    if (!ds.active) {\n      if (dy < 4) return;\n      ds.active = true;\n      setDragSourceIdx(ds.sourceIdx);\n      setDragOverIdx(ds.sourceIdx);\n    }\n\n    // Update ghost position\n    const listRect = listRef.current?.getBoundingClientRect();\n    if (listRect) {\n      setDragGhostStyle({\n        position: 'absolute',\n        left: 0,\n        right: 0,\n        top: e.clientY - listRect.top - ds.offsetY,\n        height: ds.cardHeight,\n        zIndex: 50,\n        pointerEvents: 'none',\n        opacity: 0.9,\n      });\n    }\n\n    // Determine which slot we're over using the card midpoints\n    const rects = ds.cardRects;\n    let target = ds.sourceIdx;\n    for (let i = 0; i < rects.length; i++) {\n      if (i === ds.sourceIdx) continue;\n      const mid = rects[i].top + rects[i].height / 2;\n      if (ds.sourceIdx < i) {\n        // Dragging down: pass midpoint to go below\n        if (e.clientY > mid) target = i;\n      } else {\n        // Dragging up: pass midpoint to go above\n        if (e.clientY < mid) { target = i; break; }\n      }\n    }\n\n    if (target !== ds.currentIdx) {\n      ds.currentIdx = target;\n      setDragOverIdx(target);\n    }\n  }, []);\n\n  const handlePointerUp = useCallback((e: React.PointerEvent) => {\n    const ds = dragState.current;\n    if (!ds) return;\n\n    (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n\n    if (ds.active && ds.sourceIdx !== ds.currentIdx) {\n      onReorderCards?.(ds.sourceIdx, ds.currentIdx);\n    }\n\n    dragState.current = null;\n    setDragSourceIdx(null);\n    setDragOverIdx(null);\n    setDragGhostStyle(null);\n  }, [onReorderCards]);\n\n  // Close context menu on outside click\n  useEffect(() => {\n    if (!contextMenu) return;\n    const handleClick = (e: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {\n        setContextMenu(null);\n        setShowInfoSubmenu(false);\n        setShowCopyMoveSubmenu(false);\n      }\n    };\n    window.addEventListener('mousedown', handleClick);\n    return () => window.removeEventListener('mousedown', handleClick);\n  }, [contextMenu]);\n\n  // Adjust context menu position to stay within viewport\n  useEffect(() => {\n    if (!contextMenu || !menuRef.current) return;\n    const menu = menuRef.current;\n    const rect = menu.getBoundingClientRect();\n    const vw = window.innerWidth;\n    const vh = window.innerHeight;\n    let { x, y } = contextMenu;\n    if (rect.bottom > vh) y = Math.max(4, vh - rect.height - 4);\n    if (rect.right > vw) x = Math.max(4, vw - rect.width - 4);\n    if (y !== contextMenu.y || x !== contextMenu.x) {\n      menu.style.top = `${y}px`;\n      menu.style.left = `${x}px`;\n    }\n  }, [contextMenu]);\n\n  // Reset submenus when menu closes\n  useEffect(() => {\n    if (!contextMenu) {\n      setShowInfoSubmenu(false);\n      setShowCopyMoveSubmenu(false);\n    }\n  }, [contextMenu]);\n\n  // Focus rename input when it appears\n  useEffect(() => {\n    if (renamingId) renameInputRef.current?.focus();\n  }, [renamingId]);\n\n  // Keyboard shortcuts: Cmd/Ctrl+A to select all\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'a' && (e.metaKey || e.ctrlKey) && cards.length > 0) {\n        // Only handle if no input/textarea is focused\n        const tag = (e.target as HTMLElement)?.tagName;\n        if (tag === 'INPUT' || tag === 'TEXTAREA') return;\n        e.preventDefault();\n        onSelectAll();\n      }\n    };\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [cards.length, onSelectAll]);\n\n  const commitRename = (id: string) => {\n    const trimmed = renameValue.trim();\n    if (!trimmed) { setRenamingId(null); setRenameError(''); return; }\n    const currentCard = cards.find(h => h.id === id);\n    if (trimmed !== currentCard?.text) {\n      // Check uniqueness within sibling cards\n      const siblingNames = cards.map(h => h.text);\n      if (isNameTaken(trimmed, siblingNames, currentCard?.text)) {\n        setRenameError('A card with this name already exists');\n        return;\n      }\n      onRenameCard(id, trimmed);\n    }\n    setRenamingId(null);\n    setRenameError('');\n  };\n\n  if (cards.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 px-4 text-center\">\n        <PanelRequirements level=\"cards\" />\n      </div>\n    );\n  }\n\n  // Compute gap style for smooth card displacement during drag\n  const getGapStyle = (idx: number): React.CSSProperties => {\n    if (dragSourceIdx === null || dragOverIdx === null || dragSourceIdx === dragOverIdx) return {};\n    const gap = dragState.current?.cardHeight || 28;\n    if (dragSourceIdx < dragOverIdx) {\n      // Dragging down: cards between source+1..target shift up\n      if (idx > dragSourceIdx && idx <= dragOverIdx) {\n        return { transform: `translateY(-${gap}px)`, transition: 'transform 150ms ease' };\n      }\n    } else {\n      // Dragging up: cards between target..source-1 shift down\n      if (idx >= dragOverIdx && idx < dragSourceIdx) {\n        return { transform: `translateY(${gap}px)`, transition: 'transform 150ms ease' };\n      }\n    }\n    return { transition: 'transform 150ms ease' };\n  };\n\n  return (\n    <div className=\"space-y-0 py-2 relative\" ref={listRef}>\n      {/* Select all / deselect all */}\n      {cards.length > 0 && (() => {\n        const selectedCount = cards.filter(c => c.selected).length;\n        const allSelected = selectedCount === cards.length;\n        const someSelected = selectedCount > 0 && !allSelected;\n        return (\n          <div\n            className=\"flex items-center gap-1 px-1.5 py-1 cursor-pointer select-none border-b border-zinc-100 dark:border-zinc-600 mb-1\"\n            onClick={() => { if (allSelected) onDeselectAll(); else onSelectAll(); }}\n          >\n            <div className=\"shrink-0 w-3.5 h-3.5 rounded-[3px] border border-zinc-300 dark:border-zinc-600 flex items-center justify-center bg-white dark:bg-zinc-900\">\n              {allSelected && (\n                <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"rgb(42,159,212)\" strokeWidth=\"3.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <polyline points=\"20 6 9 17 4 12\" />\n                </svg>\n              )}\n              {someSelected && (\n                <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"rgb(42,159,212)\" strokeWidth=\"3\" strokeLinecap=\"round\">\n                  <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\" />\n                </svg>\n              )}\n            </div>\n            <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400 font-medium\">All cards</span>\n          </div>\n        );\n      })()}\n      {cards.map((card, idx) => {\n        const isActive = card.id === activeCardId;\n        const isSelected = !!card.selected;\n        const isGenerating = !!(activeDetailLevel && card.isGeneratingMap?.[activeDetailLevel]);\n        const isDragging = dragSourceIdx === idx;\n\n        // Auto-Deck group separator — show when entering an auto-deck group\n        const prevCard = idx > 0 ? cards[idx - 1] : null;\n        const isAutoDeck = !!card.autoDeckSessionId;\n        const prevIsAutoDeck = !!prevCard?.autoDeckSessionId;\n        const isNewGroup = isAutoDeck && (!prevIsAutoDeck || prevCard?.autoDeckSessionId !== card.autoDeckSessionId);\n        const isLeavingGroup = !isAutoDeck && prevIsAutoDeck;\n\n        return (\n          <React.Fragment key={card.id}>\n          {/* Auto-Deck separator */}\n          {(isNewGroup || isLeavingGroup) && (\n            <div className=\"flex items-center gap-2 px-2 py-1.5 mt-1 mb-0.5 select-none\" style={{ pointerEvents: 'none' }}>\n              <div className=\"h-px flex-1 bg-zinc-200 dark:bg-zinc-700\" />\n              <span className=\"text-[9px] font-semibold uppercase tracking-wider text-zinc-400 dark:text-zinc-500 whitespace-nowrap\">\n                {isNewGroup ? 'Auto-Deck' : 'Manual Cards'}\n              </span>\n              <div className=\"h-px flex-1 bg-zinc-200 dark:bg-zinc-700\" />\n            </div>\n          )}\n          <div\n            data-card-id={card.id}\n            data-card-idx={idx}\n            onPointerDown={(e) => handlePointerDown(e, idx, card.text)}\n            onPointerMove={handlePointerMove}\n            onPointerUp={handlePointerUp}\n            style={{\n              ...getGapStyle(idx),\n              ...(isDragging ? { opacity: 0, pointerEvents: 'none' } : {}),\n            }}\n            className={`group relative flex items-center gap-1 px-1.5 py-1 cursor-pointer select-none transition-all duration-150 ${\n              isActive ? 'sidebar-node-active' : 'border border-transparent hover:border-blue-300'\n            }`}\n            onClick={(e) => {\n              // Suppress click if we just finished a drag\n              if (dragState.current?.active) return;\n              e.stopPropagation();\n              onCardClick(card.id);\n              setShowInfoSubmenu(false);\n              setShowCopyMoveSubmenu(false);\n              setContextMenu({ x: e.clientX, y: e.clientY, cardId: card.id });\n            }}\n            onDoubleClick={() => onCardDoubleClick?.(card.id)}\n          >\n            {/* Selection checkbox */}\n            <div\n              onClick={(e) => { e.stopPropagation(); onToggleSelection(card.id); }}\n              className=\"shrink-0 w-3.5 h-3.5 rounded-[3px] border border-zinc-300 dark:border-zinc-600 flex items-center justify-center cursor-pointer bg-white dark:bg-zinc-900\"\n            >\n              {isSelected && (\n                <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"rgb(42,159,212)\" strokeWidth=\"3.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <polyline points=\"20 6 9 17 4 12\" />\n                </svg>\n              )}\n            </div>\n\n            {/* Spinning arc indicator when generating */}\n            {isGenerating && (\n              <div\n                className=\"shrink-0 w-3.5 h-3.5 rounded-full border-[1.5px] border-zinc-200 dark:border-zinc-600 border-t-zinc-500 dark:border-t-zinc-400 animate-spin\"\n                title=\"Generating image…\"\n              />\n            )}\n\n            {/* Card type badge — icon + type-specific tag */}\n            {isCoverLevel(card.detailLevel || 'Standard') && (() => {\n              const isTitleCard = card.detailLevel === 'TitleCard';\n              return (\n                <div className=\"flex items-center gap-0.5 shrink-0\" title={isTitleCard ? 'Title Card' : 'Takeaway Card'}>\n                  {isTitleCard ? (\n                    /* Presentation/slide icon for Title Card */\n                    <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-violet-500\">\n                      <rect x=\"2\" y=\"3\" width=\"20\" height=\"14\" rx=\"2\" />\n                      <path d=\"M8 21h8\" /><path d=\"M12 17v4\" />\n                    </svg>\n                  ) : (\n                    /* Lightbulb/insight icon for Takeaway Card */\n                    <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-amber-500\">\n                      <path d=\"M9 18h6\" /><path d=\"M10 22h4\" />\n                      <path d=\"M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z\" />\n                    </svg>\n                  )}\n                  <span className={`text-[7px] font-bold uppercase tracking-wider px-1 py-[1px] rounded ${isTitleCard ? 'text-violet-600 bg-violet-50' : 'text-amber-600 bg-amber-50'}`}>\n                    {isTitleCard ? 'Title' : 'Takeaway'}\n                  </span>\n                </div>\n              );\n            })()}\n\n            {/* Card title or rename input */}\n            <div className=\"flex-1 min-w-0\">\n              {renamingId === card.id ? (\n                <div>\n                  <input\n                    ref={renameInputRef}\n                    value={renameValue}\n                    onChange={(e) => { setRenameValue(e.target.value); setRenameError(''); }}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter') commitRename(card.id);\n                      if (e.key === 'Escape') { setRenamingId(null); setRenameError(''); }\n                    }}\n                    onBlur={() => commitRename(card.id)}\n                    onClick={(e) => e.stopPropagation()}\n                    className={`w-full text-[11px] font-medium text-zinc-800 dark:text-zinc-200 bg-white dark:bg-zinc-900 border rounded px-1.5 py-0.5 outline-none ${renameError ? 'border-red-400 focus:border-red-400' : 'border-zinc-300 dark:border-zinc-600 focus:border-zinc-400'}`}\n                  />\n                  {renameError && <p className=\"text-[9px] text-red-500 mt-0.5\">{renameError}</p>}\n                </div>\n              ) : (\n                <p className={`text-[11px] truncate ${isActive ? 'font-semibold text-zinc-800 dark:text-zinc-200' : 'font-medium text-zinc-600 dark:text-zinc-400'}`} title={card.text}>\n                  {card.text}\n                </p>\n              )}\n            </div>\n          </div>\n          </React.Fragment>\n        );\n      })}\n\n      {/* Floating drag ghost */}\n      {dragGhostStyle && (\n        <div\n          ref={dragGhostRef}\n          className=\"flex items-center gap-1 px-1.5 py-1 rounded bg-white dark:bg-zinc-900 border border-zinc-300 dark:border-zinc-600 shadow-lg dark:shadow-black/30\"\n          style={dragGhostStyle}\n        >\n          <p className=\"text-[11px] font-semibold text-zinc-800 dark:text-zinc-200 truncate\">{dragGhostText.current}</p>\n        </div>\n      )}\n\n      {/* Context menu — rendered as portal at right-click coordinates */}\n      {contextMenu && (() => {\n        const card = cards.find(h => h.id === contextMenu.cardId);\n        if (!card) return null;\n        const level = activeDetailLevel || card.detailLevel || 'Standard';\n        const hasCard = !!card.cardUrlMap?.[level];\n        const hasSynthesis = !!card.synthesisMap?.[level];\n        const selectedCount = cards.filter(h => h.selected).length;\n        return createPortal(\n          <div\n            ref={menuRef}\n            className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 animate-in fade-in zoom-in-95 duration-150\"\n            style={{ top: contextMenu.y, left: contextMenu.x }}\n          >\n            {/* ── Active card actions (always shown) ── */}\n            {/* Info — hover submenu */}\n            <div\n              className=\"relative\"\n              onMouseEnter={() => setShowInfoSubmenu(true)}\n              onMouseLeave={() => setShowInfoSubmenu(false)}\n            >\n              <button\n                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n              >\n                <span className=\"flex items-center gap-2\">\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                    <circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M12 16v-4\"/><path d=\"M12 8h.01\"/>\n                  </svg>\n                  Card Info\n                </span>\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                  <polyline points=\"9 18 15 12 9 6\" />\n                </svg>\n              </button>\n\n              {showInfoSubmenu && (\n                <div\n                  className=\"absolute left-full top-0 ml-1 w-56 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-600 rounded-lg shadow-lg z-[140] animate-in fade-in zoom-in-95 duration-100\"\n                >\n                  <InfoContent\n                    card={card}\n                    level={level}\n                  />\n                </div>\n              )}\n            </div>\n\n            {onGenerateCardImage && (\n              <button\n                onClick={(e) => {\n                  e.stopPropagation();\n                  setContextMenu(null);\n                  onGenerateCardImage(card);\n                }}\n                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                  <rect width=\"18\" height=\"18\" x=\"3\" y=\"3\" rx=\"2\" ry=\"2\"/><circle cx=\"9\" cy=\"9\" r=\"2\"/><path d=\"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\"/>\n                </svg>\n                Generate Card Image\n              </button>\n            )}\n\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                setRenameValue(card.text);\n                setRenamingId(card.id);\n                setContextMenu(null);\n              }}\n              className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/>\n              </svg>\n              Rename Card\n            </button>\n\n            {/* Copy/Move — hover submenu */}\n            {onCopyMoveCard && (\n              <div\n                className=\"relative\"\n                onMouseEnter={() => setShowCopyMoveSubmenu(true)}\n                onMouseLeave={() => setShowCopyMoveSubmenu(false)}\n              >\n                <button\n                  onClick={() => {\n                    if (!otherNuggets || otherNuggets.length === 0) {\n                      setNoNuggetsCardId(contextMenu.cardId);\n                      setContextMenu(null);\n                    }\n                  }}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                >\n                  <span className=\"flex items-center gap-2\">\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                      <path d=\"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4\" /><polyline points=\"10 17 15 12 10 7\" /><line x1=\"15\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                    </svg>\n                    Copy/Move\n                  </span>\n                  {otherNuggets && otherNuggets.length > 0 && (\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                      <polyline points=\"9 18 15 12 9 6\" />\n                    </svg>\n                  )}\n                </button>\n\n                {/* Nugget list submenu */}\n                {showCopyMoveSubmenu && otherNuggets && otherNuggets.length > 0 && (\n                  <div\n                    className=\"absolute left-full top-0 ml-1 w-[220px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 z-[140] animate-in fade-in zoom-in-95 duration-100\"\n                  >\n                    <div className=\"px-3 pb-1 border-b border-zinc-100 dark:border-zinc-600 mb-1\">\n                      <span className=\"text-[10px] font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400\">Copy/Move to nugget</span>\n                    </div>\n                    <div className=\"max-h-[200px] overflow-y-auto\" style={{ scrollbarWidth: 'thin' }}>\n                      {projectNuggets && projectNuggets.length > 0 ? (\n                        projectNuggets.map(pg => (\n                          <div key={pg.projectId}>\n                            <div className=\"px-3 pt-1.5 pb-0.5 flex items-center gap-1.5\">\n                              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 shrink-0\">\n                                <path d=\"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z\" />\n                              </svg>\n                              <span className=\"text-[9px] font-semibold text-zinc-500 dark:text-zinc-400 truncate\">{pg.projectName}</span>\n                            </div>\n                            {pg.nuggets.length === 0 ? (\n                              <p className=\"text-zinc-500 dark:text-zinc-400 text-[9px] font-light pl-6 pr-2 py-0.5 italic\">No other nuggets</p>\n                            ) : (\n                              pg.nuggets.map(n => (\n                                <div key={n.id} className=\"pl-5 pr-2 py-1 flex items-center gap-1.5 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg mx-1 group\">\n                                  <div className=\"w-1.5 h-1.5 rounded-full bg-accent-blue shrink-0\" />\n                                  <span className=\"flex-1 text-[11px] text-black truncate\" title={n.name}>{n.name}</span>\n                                  <div className=\"flex items-center gap-0.5 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\">\n                                    <button\n                                      onClick={() => {\n                                        const hId = contextMenu.cardId;\n                                        setContextMenu(null);\n                                        onCopyMoveCard(hId, n.id, 'copy');\n                                      }}\n                                      className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                                    >\n                                      Copy\n                                    </button>\n                                    <button\n                                      onClick={() => {\n                                        const hId = contextMenu.cardId;\n                                        setContextMenu(null);\n                                        onCopyMoveCard(hId, n.id, 'move');\n                                      }}\n                                      className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                                    >\n                                      Move\n                                    </button>\n                                  </div>\n                                </div>\n                              ))\n                            )}\n                          </div>\n                        ))\n                      ) : (\n                        otherNuggets.map(n => (\n                          <div key={n.id} className=\"px-2 py-1 flex items-center gap-1.5 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg mx-1 group\">\n                            <div className=\"w-1.5 h-1.5 rounded-full bg-accent-blue shrink-0\" />\n                            <span className=\"flex-1 text-[11px] text-black truncate\" title={n.name}>{n.name}</span>\n                            <div className=\"flex items-center gap-0.5 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\">\n                              <button\n                                onClick={() => {\n                                  const hId = contextMenu.cardId;\n                                  setContextMenu(null);\n                                  onCopyMoveCard(hId, n.id, 'copy');\n                                }}\n                                className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                              >\n                                Copy\n                              </button>\n                              <button\n                                onClick={() => {\n                                  const hId = contextMenu.cardId;\n                                  setContextMenu(null);\n                                  onCopyMoveCard(hId, n.id, 'move');\n                                }}\n                                className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                              >\n                                Move\n                              </button>\n                            </div>\n                          </div>\n                        ))\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n\n            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                setContextMenu(null);\n                setConfirmDeleteId(card.id);\n              }}\n              className=\"w-full text-left px-3 py-2 text-[11px] text-red-500 hover:bg-red-50 transition-colors flex items-center gap-2\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n              Remove Card\n            </button>\n\n            {/* ── Selected cards actions (only when 2+ cards checked) ── */}\n            {selectedCount > 1 && (\n              <>\n                <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                <div className=\"px-3 py-1.5 text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">\n                  {selectedCount} Cards Selected\n                </div>\n                <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    setContextMenu(null);\n                    onDeselectAll();\n                  }}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                >\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                    <path d=\"M18 6 6 18\"/><path d=\"m6 6 12 12\"/>\n                  </svg>\n                  Deselect All\n                </button>\n                {onGenerateCardImage && (\n                  <>\n                    <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        setContextMenu(null);\n                        const selected = cards.filter(c => c.selected);\n                        selected.forEach(c => onGenerateCardImage(c));\n                      }}\n                      className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                    >\n                      <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                        <rect width=\"18\" height=\"18\" x=\"3\" y=\"3\" rx=\"2\" ry=\"2\"/><circle cx=\"9\" cy=\"9\" r=\"2\"/><path d=\"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\"/>\n                      </svg>\n                      Generate {selectedCount} Card Images\n                    </button>\n                  </>\n                )}\n                <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    setContextMenu(null);\n                    setConfirmDeleteSelected(true);\n                  }}\n                  className=\"w-full text-left px-3 py-2 text-[11px] text-red-500 hover:bg-red-50 transition-colors flex items-center gap-2\"\n                >\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n                  </svg>\n                  Remove {selectedCount} Cards\n                </button>\n              </>\n            )}\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* Delete confirmation modal */}\n      {confirmDeleteId && (() => {\n        const card = cards.find(h => h.id === confirmDeleteId);\n        if (!card) return null;\n        return createPortal(\n          <div\n            className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n            onClick={() => setConfirmDeleteId(null)}\n          >\n            <div\n              className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\"\n              style={{ minWidth: 260, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }}\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"px-6 pt-6 pb-3 text-center\">\n                <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <path d=\"M3 6h18\" /><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\" /><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">Remove Card</h3>\n                <p className=\"text-xs font-medium text-zinc-600 dark:text-zinc-400 whitespace-nowrap\">{card.text}</p>\n                <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-2\">This cannot be undone.</p>\n              </div>\n              <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n                <button\n                  onClick={() => setConfirmDeleteId(null)}\n                  className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={() => { setConfirmDeleteId(null); onDeleteCard(card.id); }}\n                  className=\"px-4 py-2 bg-zinc-900 text-white text-xs font-medium rounded-lg hover:bg-zinc-800 transition-colors\"\n                >\n                  Remove\n                </button>\n              </div>\n            </div>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* Bulk delete confirmation modal */}\n      {confirmDeleteSelected && (() => {\n        const selectedCount = cards.filter(h => h.selected).length;\n        return createPortal(\n          <div\n            className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n            onClick={() => setConfirmDeleteSelected(false)}\n          >\n            <div\n              className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\"\n              style={{ minWidth: 260, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }}\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"px-6 pt-6 pb-3 text-center\">\n                <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <path d=\"M3 6h18\" /><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\" /><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">Remove {selectedCount} Cards</h3>\n                <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-2\">This cannot be undone.</p>\n              </div>\n              <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n                <button\n                  onClick={() => setConfirmDeleteSelected(false)}\n                  className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={() => { setConfirmDeleteSelected(false); onDeleteSelectedCards(); }}\n                  className=\"px-4 py-2 bg-zinc-900 text-white text-xs font-medium rounded-lg hover:bg-zinc-800 transition-colors\"\n                >\n                  Remove All\n                </button>\n              </div>\n            </div>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* Copy/Move — no other nuggets: create modal */}\n      {noNuggetsCardId && onCreateNuggetForCard && createPortal(\n        <div\n          className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n          onClick={() => { setNoNuggetsCardId(null); setNewNuggetName(''); }}\n        >\n          <div\n            className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\"\n            style={{ minWidth: 300, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }}\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"px-6 pt-6 pb-3 text-center\">\n              <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4\" /><polyline points=\"10 17 15 12 10 7\" /><line x1=\"15\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                </svg>\n              </div>\n              <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">No Other Nuggets</h3>\n              <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-1\">Create a new nugget to copy this card to.</p>\n              {(() => {\n                const allNuggetNames = (otherNuggets || []).map(n => n.name);\n                const nameConflict = isNameTaken(newNuggetName.trim(), allNuggetNames);\n                return (\n                  <>\n                    <input\n                      type=\"text\"\n                      value={newNuggetName}\n                      onChange={(e) => setNewNuggetName(e.target.value)}\n                      onKeyDown={(e) => {\n                        if (e.key === 'Enter' && newNuggetName.trim() && !nameConflict) {\n                          const hId = noNuggetsCardId;\n                          setNoNuggetsCardId(null);\n                          setNewNuggetName('');\n                          onCreateNuggetForCard(newNuggetName.trim(), hId);\n                        }\n                      }}\n                      placeholder=\"Nugget name\"\n                      autoFocus\n                      className={`mt-3 w-full px-3 py-2 text-xs text-zinc-800 dark:text-zinc-200 border rounded-lg focus:outline-none focus:ring-2 focus:ring-zinc-300 transition-all placeholder:text-zinc-500 ${nameConflict ? 'border-red-300 focus:border-red-400' : 'border-zinc-200 dark:border-zinc-600 focus:border-zinc-400'}`}\n                    />\n                    {nameConflict && <p className=\"text-[10px] text-red-500 mt-1\">A nugget with this name already exists</p>}\n                  </>\n                );\n              })()}\n            </div>\n            <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n              <button\n                onClick={() => { setNoNuggetsCardId(null); setNewNuggetName(''); }}\n                className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\"\n              >\n                Cancel\n              </button>\n              {(() => {\n                const nameConflict = isNameTaken(newNuggetName.trim(), (otherNuggets || []).map(n => n.name));\n                const canCreate = !!newNuggetName.trim() && !nameConflict;\n                return (\n                  <button\n                    onClick={() => {\n                      if (!canCreate) return;\n                      const hId = noNuggetsCardId;\n                      setNoNuggetsCardId(null);\n                      setNewNuggetName('');\n                      onCreateNuggetForCard(newNuggetName.trim(), hId);\n                    }}\n                    disabled={!canCreate}\n                    className={`px-4 py-2 text-xs font-medium rounded-lg transition-colors ${\n                      canCreate\n                        ? 'bg-zinc-900 text-white hover:bg-zinc-800'\n                        : 'bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'\n                    }`}\n                  >\n                    New Nugget\n                  </button>\n                );\n              })()}\n            </div>\n          </div>\n        </div>,\n        document.body\n      )}\n    </div>\n  );\n};\n\nexport default InsightsCardList;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\LandingPage.tsx","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":19,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":19,"endColumn":37},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":68,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":68,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":74,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":74,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":79,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":79,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 800.","line":89,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":89,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":115,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":115,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport React, { useState, useEffect, useCallback } from 'react';\n\ninterface LandingPageProps {\n  onLaunch: () => void;\n}\n\nexport const LandingPage: React.FC<LandingPageProps> = ({ onLaunch }) => {\n  const [visible, setVisible] = useState(false);\n  const [exiting, setExiting] = useState(false);\n\n  useEffect(() => {\n    const t = setTimeout(() => setVisible(true), 100);\n    return () => clearTimeout(t);\n  }, []);\n\n  const handleLaunch = useCallback(() => {\n    setExiting(true);\n    setTimeout(() => onLaunch(), 400);\n  }, [onLaunch]);\n\n  const transition = 'all 0.8s cubic-bezier(0.16, 1, 0.3, 1)';\n\n  const stagger = (delay: number): React.CSSProperties => ({\n    opacity: visible && !exiting ? 1 : 0,\n    transform: visible && !exiting ? 'translateY(0) scale(1)' : 'translateY(12px) scale(0.98)',\n    transition,\n    transitionDelay: exiting ? '0ms' : `${delay}ms`,\n  });\n\n  return (\n    <div\n      className=\"relative h-screen w-full flex flex-col items-center justify-center overflow-hidden\"\n      style={{ backgroundColor: '#0a0a0a' }}\n    >\n      {/* Dot grid */}\n      <div\n        className=\"absolute inset-0 pointer-events-none opacity-[0.04]\"\n        style={{\n          backgroundImage: 'radial-gradient(rgba(42,159,212,0.5) 0.5px, transparent 0.5px)',\n          backgroundSize: '32px 32px',\n        }}\n      />\n      {/* Center spotlight */}\n      <div\n        className=\"absolute inset-0 pointer-events-none\"\n        style={{\n          background: 'radial-gradient(ellipse at center, rgba(42,159,212,0.03) 0%, transparent 60%)',\n        }}\n      />\n\n      {/* Hero */}\n      <div className=\"relative z-10 flex flex-col items-center text-center px-6\">\n        {/* Logo */}\n        <div style={stagger(0)} className=\"mb-8\">\n          <div className=\"relative\">\n            <div\n              className=\"absolute inset-0 rounded-full animate-pulse\"\n              style={{ boxShadow: '0 0 60px 20px rgba(42, 159, 212, 0.12)' }}\n            />\n            <div className=\"w-20 h-20 bg-accent-blue rounded-full flex items-center justify-center shadow-2xl relative z-10\">\n              <div className=\"w-7 h-7 bg-white rounded-md rotate-45\" />\n            </div>\n          </div>\n        </div>\n\n        {/* Wordmark */}\n        <h1 style={stagger(200)} className=\"text-6xl tracking-tighter mb-4\">\n          <span className=\"font-light italic text-zinc-500\">info</span>\n          <span className=\"font-semibold not-italic text-white\">nugget</span>\n        </h1>\n\n        {/* Tagline */}\n        <p style={stagger(400)} className=\"text-[15px] font-light text-zinc-500 max-w-sm\">\n          Condense knowledge into digestible insights.\n        </p>\n\n        {/* CTA */}\n        <div style={stagger(600)}>\n          <button\n            onClick={handleLaunch}\n            className=\"mt-12 px-10 py-4 rounded-full bg-accent-blue text-white text-[11px] font-black uppercase tracking-[0.2em] shadow-xl hover:shadow-[0_0_40px_rgba(42,159,212,0.3)] hover:scale-105 active:scale-95 transition-all duration-300\"\n          >\n            Launch Workspace\n          </button>\n        </div>\n\n        {/* Feature pills */}\n        <div style={stagger(800)} className=\"flex items-center gap-8 mt-16\">\n          <div className=\"flex items-center gap-2 text-zinc-600\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z\"/>\n              <polyline points=\"14 2 14 8 20 8\"/>\n            </svg>\n            <span className=\"text-[10px] font-bold uppercase tracking-widest\">MD / PDF</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-zinc-600\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M12 3l1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z\"/>\n            </svg>\n            <span className=\"text-[10px] font-bold uppercase tracking-widest\">AI Synthesis</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-zinc-600\">\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" ry=\"2\"/>\n              <circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/>\n              <polyline points=\"21 15 16 10 5 21\"/>\n            </svg>\n            <span className=\"text-[10px] font-bold uppercase tracking-widest\">Infographic Cards</span>\n          </div>\n        </div>\n      </div>\n\n      {/* Version */}\n      <div style={stagger(1000)} className=\"absolute bottom-6\">\n        <p className=\"text-[10px] text-zinc-600 font-light tracking-wide\">v3.0</p>\n      </div>\n    </div>\n  );\n};\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\LoadingScreen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\NuggetCreationModal.tsx","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":43,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":43,"endColumn":40,"fix":{"range":[1536,1543],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":61,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":61,"endColumn":42,"fix":{"range":[2377,2384],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":82,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":82,"endColumn":43,"fix":{"range":[3043,3050],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":85,"column":63,"nodeType":"Literal","messageId":"noMagic","endLine":85,"endColumn":65},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":85,"column":77,"nodeType":"Literal","messageId":"noMagic","endLine":85,"endColumn":78},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":106,"column":59,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":106,"endColumn":69,"fix":{"range":[3698,3708],"text":"{onClose();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":146,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":146,"endColumn":90,"fix":{"range":[6147,6183],"text":"{handleFilesSelected(e.target.files);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":5,"source":"\nimport React, { useState, useRef } from 'react';\nimport { createPortal } from 'react-dom';\nimport { Nugget } from '../types';\nimport { createPlaceholderDocument } from '../utils/fileProcessing';\nimport { getUniqueName } from '../utils/naming';\nimport PdfUploadChoiceDialog from './PdfUploadChoiceDialog';\n\n/** Describes a file waiting to be processed after the nugget is created. */\nexport interface PendingFileUpload {\n  file: File;\n  placeholderId: string;\n  mode: 'markdown' | 'native-pdf';\n}\n\ninterface NuggetCreationModalProps {\n  nuggets: Nugget[];\n  onCreateNugget: (nugget: Nugget, pendingFiles?: PendingFileUpload[]) => void;\n  onClose: () => void;\n}\n\nexport const NuggetCreationModal: React.FC<NuggetCreationModalProps> = ({\n  nuggets,\n  onCreateNugget,\n  onClose,\n}) => {\n  const [name, setName] = useState('');\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // PDF choice dialog state\n  const [pdfChoiceDialog, setPdfChoiceDialog] = useState<{ fileName: string; pdfCount: number } | null>(null);\n  const pdfChoiceResolverRef = useRef<((choice: 'markdown' | 'native-pdf' | 'cancel') => void) | null>(null);\n\n  const askPdfChoice = (fileName: string, pdfCount: number): Promise<'markdown' | 'native-pdf' | 'cancel'> => {\n    return new Promise(resolve => {\n      pdfChoiceResolverRef.current = resolve;\n      setPdfChoiceDialog({ fileName, pdfCount });\n    });\n  };\n\n  const handleFilesSelected = async (files: FileList) => {\n    const fileArray = Array.from(files).filter(f => f);\n    if (fileArray.length === 0) return;\n\n    const pdfFiles = fileArray.filter(f => f.name.endsWith('.pdf') || f.type === 'application/pdf');\n    const mdFiles = fileArray.filter(f => !f.name.endsWith('.pdf') && f.type !== 'application/pdf');\n\n    // Resolve nugget name: user-entered or auto-fill from first filename\n    let nuggetName = name.trim();\n    if (!nuggetName && fileArray.length > 0) {\n      nuggetName = fileArray[0].name.replace(/\\.\\w+$/, '');\n    }\n    // Ensure unique name among existing nuggets\n    const existingNames = nuggets.map(n => n.name);\n    nuggetName = getUniqueName(nuggetName, existingNames);\n\n    // Ask once for all PDFs (if any)\n    let pdfChoice: 'markdown' | 'native-pdf' | 'cancel' | null = null;\n    if (pdfFiles.length > 0) {\n      pdfChoice = await askPdfChoice(pdfFiles[0].name, pdfFiles.length);\n      if (pdfChoice === 'cancel') return; // User cancelled — stay in modal\n    }\n\n    // Build placeholders and pending files list\n    const placeholders = [];\n    const pendingFiles: PendingFileUpload[] = [];\n\n    if (pdfChoice && pdfChoice !== 'cancel') {\n      for (const file of pdfFiles) {\n        const ph = createPlaceholderDocument(file);\n        placeholders.push(ph);\n        pendingFiles.push({ file, placeholderId: ph.id, mode: pdfChoice });\n      }\n    }\n\n    for (const file of mdFiles) {\n      const ph = createPlaceholderDocument(file);\n      placeholders.push(ph);\n      pendingFiles.push({ file, placeholderId: ph.id, mode: 'markdown' });\n    }\n\n    if (placeholders.length === 0) return;\n\n    // Create nugget with placeholder documents and hand off to App\n    const id = `nugget-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const now = Date.now();\n\n    const nugget: Nugget = {\n      id,\n      name: nuggetName,\n      type: 'insights',\n      documents: placeholders,\n      cards: [],\n      messages: [],\n      createdAt: now,\n      lastModifiedAt: now,\n    };\n\n    onCreateNugget(nugget, pendingFiles);\n    onClose();\n  };\n\n  return createPortal(\n    <div\n      className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n      onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}\n    >\n      <div className=\"bg-white dark:bg-zinc-900 rounded-[24px] shadow-2xl dark:shadow-black/30 w-full max-w-md mx-4 overflow-hidden animate-in zoom-in-95 duration-200\">\n        {/* Header */}\n        <div className=\"px-6 pt-6 pb-4\">\n          <div className=\"flex items-center gap-3 mb-5\">\n            <div className=\"w-9 h-9 rounded-xl bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-600 dark:text-zinc-400\">\n                <path d=\"M12 5v14\" /><path d=\"M5 12h14\" />\n              </svg>\n            </div>\n            <h2 className=\"text-sm font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight\">New Nugget</h2>\n          </div>\n\n          {/* Name input */}\n          <div className=\"mb-5\">\n            <label className=\"block text-[11px] font-medium text-zinc-500 dark:text-zinc-400 mb-1.5\">Name</label>\n            <input\n              type=\"text\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              placeholder=\"Auto-fills from filename…\"\n              className=\"w-full px-3 py-2 text-xs border border-zinc-200 dark:border-zinc-600 rounded-lg focus:outline-none focus:border-zinc-400 transition-colors dark:bg-zinc-800 dark:text-zinc-100\"\n              autoFocus\n            />\n            <p className=\"mt-1.5 text-[10px] text-zinc-400 dark:text-zinc-500\">Leave blank to use the filename</p>\n          </div>\n\n          {/* Upload button — primary action */}\n          <label className=\"flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black text-xs font-semibold cursor-pointer hover:bg-zinc-800 dark:hover:bg-zinc-200 transition-colors\">\n            <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\" /><polyline points=\"17 8 12 3 7 8\" /><line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\" />\n            </svg>\n            Upload Documents\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              multiple\n              accept=\".md,.pdf\"\n              className=\"hidden\"\n              onChange={(e) => { if (e.target.files) handleFilesSelected(e.target.files); e.target.value = ''; }}\n            />\n          </label>\n          <p className=\"mt-2 text-[10px] text-zinc-400 dark:text-zinc-500 text-center\">PDF and Markdown files</p>\n        </div>\n\n        {/* Footer */}\n        <div className=\"px-6 pb-6 pt-1 flex items-center justify-center\">\n          <button\n            onClick={onClose}\n            className=\"text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 text-xs transition-colors\"\n          >\n            Cancel\n          </button>\n        </div>\n      </div>\n\n      {/* PDF upload choice dialog */}\n      {pdfChoiceDialog && (\n        <PdfUploadChoiceDialog\n          fileName={pdfChoiceDialog.fileName}\n          pdfCount={pdfChoiceDialog.pdfCount}\n          onConvertToMarkdown={() => {\n            pdfChoiceResolverRef.current?.('markdown');\n            pdfChoiceResolverRef.current = null;\n            setPdfChoiceDialog(null);\n          }}\n          onKeepAsPdf={() => {\n            pdfChoiceResolverRef.current?.('native-pdf');\n            pdfChoiceResolverRef.current = null;\n            setPdfChoiceDialog(null);\n          }}\n          onCancel={() => {\n            pdfChoiceResolverRef.current?.('cancel');\n            pdfChoiceResolverRef.current = null;\n            setPdfChoiceDialog(null);\n          }}\n        />\n      )}\n    </div>,\n    document.body\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\PanelRequirements.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'activeCard' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":47,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":56},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":61,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":61,"endColumn":34,"fix":{"range":[2323,2335],"text":"{return null;}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\nimport React from 'react';\nimport { useAppContext } from '../context/AppContext';\n\n// ── Requirement levels by panel ──\n// sources / chat / auto-deck → Project, Nugget, Document\n// cards                      → Project, Nugget, Document, Card\n// assets                     → Project, Nugget, Document, Card, Image\n\ntype RequirementLevel = 'sources' | 'cards' | 'assets';\n\ntype Requirement = 'Project' | 'Nugget' | 'Document' | 'Card' | 'Image';\n\ninterface PanelRequirementsProps {\n  level: RequirementLevel;\n  /** For assets level: whether the active card has a generated image. */\n  hasImage?: boolean;\n}\n\nconst LEVEL_ITEMS: Record<RequirementLevel, Requirement[]> = {\n  sources: ['Project', 'Nugget', 'Document'],\n  cards: ['Project', 'Nugget', 'Document', 'Card'],\n  assets: ['Project', 'Nugget', 'Document', 'Card', 'Image'],\n};\n\nconst HINTS: Record<Requirement, string> = {\n  Project: 'Create a project from the Projects panel.',\n  Nugget: 'Add a nugget using the + button in the Projects panel.',\n  Document: 'Upload documents via the \\u22EF menu on the nugget.',\n  Card: 'Generate cards from the Sources panel or Chat.',\n  Image: 'Select a card and click Generate in the toolbar.',\n};\n\nconst CheckIcon: React.FC = () => (\n  <svg className=\"w-3 h-3 text-emerald-500 shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={3}>\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M5 13l4 4L19 7\" />\n  </svg>\n);\n\nconst CrossIcon: React.FC = () => (\n  <svg className=\"w-3 h-3 text-zinc-300 dark:text-zinc-600 shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={3}>\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n  </svg>\n);\n\nconst PanelRequirements: React.FC<PanelRequirementsProps> = ({ level, hasImage = false }) => {\n  const { selectedProjectId, selectedNugget, activeCard } = useAppContext();\n\n  const flags: Record<Requirement, boolean> = {\n    Project: !!selectedProjectId,\n    Nugget: !!selectedNugget,\n    Document: (selectedNugget?.documents.filter(d => d.enabled !== false).length ?? 0) > 0,\n    Card: (selectedNugget?.cards.length ?? 0) > 0,\n    Image: hasImage,\n  };\n\n  const items = LEVEL_ITEMS[level];\n  const firstMissing = items.find(r => !flags[r]);\n\n  // All requirements met — nothing to show\n  if (!firstMissing) return null;\n\n  return (\n    <div className=\"flex flex-col items-center gap-2.5 py-4\">\n      <div className=\"flex items-center gap-3.5\">\n        {items.map(item => {\n          const met = flags[item];\n          return (\n            <div key={item} className=\"flex items-center gap-1\">\n              {met ? <CheckIcon /> : <CrossIcon />}\n              <span className={`text-[11px] leading-none ${\n                met\n                  ? 'text-zinc-500 dark:text-zinc-400'\n                  : 'text-zinc-300 dark:text-zinc-600'\n              }`}>\n                {item}\n              </span>\n            </div>\n          );\n        })}\n      </div>\n      <p className=\"text-[11px] text-zinc-400 dark:text-zinc-500 font-light\">\n        {HINTS[firstMissing]}\n      </p>\n    </div>\n  );\n};\n\nexport default PanelRequirements;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\PdfBookmarkEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'darkMode' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":34,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":19},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":89,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":89,"endColumn":48,"fix":{"range":[2684,2704],"text":"{setSelectedId(null);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":109,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":109,"endColumn":34,"fix":{"range":[3260,3267],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":135,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":135,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":135,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":135,"endColumn":50},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":152,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":152,"endColumn":61,"fix":{"range":[5007,5028],"text":"{handleCommitRename();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":153,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":153,"endColumn":62,"fix":{"range":[5069,5090],"text":"{handleCancelRename();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":325,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":325,"endColumn":50,"fix":{"range":[14273,14285],"text":"{handleAdd();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":326,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":326,"endColumn":61,"fix":{"range":[14324,14346],"text":"{setShowAddForm(false);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":337,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":337,"endColumn":50,"fix":{"range":[14843,14855],"text":"{handleAdd();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":338,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":338,"endColumn":61,"fix":{"range":[14894,14916],"text":"{setShowAddForm(false);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'for-of'.","line":386,"column":26,"nodeType":"ForOfStatement","messageId":"missingCurlyAfter","endLine":386,"endColumn":62,"fix":{"range":[16945,16981],"text":"{count += countBookmarks(n.children);}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":9,"source":"\nimport React, { useState, useCallback, useRef, useEffect } from 'react';\nimport { BookmarkNode } from '../types';\nimport {\n  renameBookmark,\n  deleteBookmark,\n  addBookmark,\n  indentBookmark,\n  outdentBookmark,\n  reorderBookmark,\n} from '../utils/pdfBookmarks';\nimport { useAppContext } from '../context/AppContext';\n\ninterface PdfBookmarkEditorProps {\n  bookmarks: BookmarkNode[];\n  onSave: (bookmarks: BookmarkNode[]) => void;\n  onDiscard: () => void;\n  onRegenerateWithAI?: () => void;\n  isRegenerating?: boolean;\n}\n\n/**\n * Bookmark tree editor for native PDFs.\n * Supports rename, delete, add, indent, outdent, and reorder.\n * Hard-lock: user must save or discard before leaving.\n */\nconst PdfBookmarkEditor: React.FC<PdfBookmarkEditorProps> = ({\n  bookmarks: initialBookmarks,\n  onSave,\n  onDiscard,\n  onRegenerateWithAI,\n  isRegenerating,\n}) => {\n  const { darkMode } = useAppContext();\n  const [draft, setDraft] = useState<BookmarkNode[]>(initialBookmarks);\n  const [selectedId, setSelectedId] = useState<string | null>(null);\n  const [renamingId, setRenamingId] = useState<string | null>(null);\n  const [renameValue, setRenameValue] = useState('');\n  const [showAddForm, setShowAddForm] = useState(false);\n  const [addTitle, setAddTitle] = useState('');\n  const [addPage, setAddPage] = useState('1');\n  const renameInputRef = useRef<HTMLInputElement>(null);\n  const addTitleRef = useRef<HTMLInputElement>(null);\n\n  const isDirty = JSON.stringify(draft) !== JSON.stringify(initialBookmarks);\n\n  // Focus rename input when editing\n  useEffect(() => {\n    if (renamingId && renameInputRef.current) {\n      renameInputRef.current.focus();\n      renameInputRef.current.select();\n    }\n  }, [renamingId]);\n\n  // Focus add-title input when shown\n  useEffect(() => {\n    if (showAddForm && addTitleRef.current) {\n      addTitleRef.current.focus();\n    }\n  }, [showAddForm]);\n\n  // ── Handlers ──\n\n  const handleSelect = useCallback((id: string) => {\n    setSelectedId(prev => prev === id ? null : id);\n    setRenamingId(null);\n  }, []);\n\n  const handleStartRename = useCallback((id: string, currentTitle: string) => {\n    setRenamingId(id);\n    setRenameValue(currentTitle);\n  }, []);\n\n  const handleCommitRename = useCallback(() => {\n    if (renamingId && renameValue.trim()) {\n      setDraft(prev => renameBookmark(prev, renamingId, renameValue.trim()));\n    }\n    setRenamingId(null);\n    setRenameValue('');\n  }, [renamingId, renameValue]);\n\n  const handleCancelRename = useCallback(() => {\n    setRenamingId(null);\n    setRenameValue('');\n  }, []);\n\n  const handleDelete = useCallback((id: string) => {\n    setDraft(prev => deleteBookmark(prev, id));\n    if (selectedId === id) setSelectedId(null);\n  }, [selectedId]);\n\n  const handleIndent = useCallback((id: string) => {\n    setDraft(prev => indentBookmark(prev, id));\n  }, []);\n\n  const handleOutdent = useCallback((id: string) => {\n    setDraft(prev => outdentBookmark(prev, id));\n  }, []);\n\n  const handleMoveUp = useCallback((id: string) => {\n    setDraft(prev => reorderBookmark(prev, id, 'up'));\n  }, []);\n\n  const handleMoveDown = useCallback((id: string) => {\n    setDraft(prev => reorderBookmark(prev, id, 'down'));\n  }, []);\n\n  const handleAdd = useCallback(() => {\n    if (!addTitle.trim()) return;\n    const page = parseInt(addPage, 10) || 1;\n    setDraft(prev => addBookmark(prev, selectedId, addTitle.trim(), page, 1));\n    setAddTitle('');\n    setAddPage('1');\n    setShowAddForm(false);\n  }, [addTitle, addPage, selectedId]);\n\n  const handleSave = useCallback(() => {\n    onSave(draft);\n  }, [onSave, draft]);\n\n  // ── Render tree ──\n\n  const renderNode = (node: BookmarkNode, depth: number = 0): React.ReactNode => {\n    const isSelected = selectedId === node.id;\n    const isRenaming = renamingId === node.id;\n\n    return (\n      <div key={node.id}>\n        <div\n          className={`group flex items-center gap-1 py-1 px-1.5 rounded cursor-pointer transition-colors ${\n            isSelected\n              ? 'bg-blue-50 dark:bg-blue-950 border border-blue-300 dark:border-blue-700'\n              : 'hover:bg-zinc-50 dark:hover:bg-zinc-800 border border-transparent'\n          }`}\n          style={{ paddingLeft: `${depth * 16 + 4}px` }}\n          onClick={() => handleSelect(node.id)}\n          onDoubleClick={() => handleStartRename(node.id, node.title)}\n        >\n          {/* Bookmark icon */}\n          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-zinc-400 dark:text-zinc-500\">\n            <path d=\"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z\" />\n          </svg>\n\n          {/* Title or rename input */}\n          {isRenaming ? (\n            <input\n              ref={renameInputRef}\n              value={renameValue}\n              onChange={e => setRenameValue(e.target.value)}\n              onBlur={handleCommitRename}\n              onKeyDown={e => {\n                if (e.key === 'Enter') handleCommitRename();\n                if (e.key === 'Escape') handleCancelRename();\n              }}\n              className=\"flex-1 min-w-0 text-[11px] px-1 py-0.5 rounded border border-blue-300 dark:border-blue-700 bg-blue-50 dark:bg-blue-950 text-zinc-800 dark:text-zinc-200 outline-none\"\n              onClick={e => e.stopPropagation()}\n            />\n          ) : (\n            <span className=\"flex-1 min-w-0 truncate text-[11px] text-zinc-700 dark:text-zinc-300\">\n              {node.title}\n            </span>\n          )}\n\n          {/* Page badge */}\n          <span className=\"shrink-0 text-[9px] px-1 py-0.5 rounded bg-zinc-100 dark:bg-zinc-800 text-zinc-400 dark:text-zinc-500\">\n            p{node.page}\n          </span>\n\n          {/* Action buttons — visible on hover or when selected */}\n          <div className={`flex items-center gap-0.5 shrink-0 ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity`}>\n            {/* Rename */}\n            <button\n              title=\"Rename\"\n              onClick={e => { e.stopPropagation(); handleStartRename(node.id, node.title); }}\n              className=\"w-4 h-4 flex items-center justify-center rounded text-zinc-400 hover:text-blue-500 dark:text-zinc-500 dark:hover:text-blue-400 transition-colors\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\" />\n              </svg>\n            </button>\n            {/* Indent */}\n            <button\n              title=\"Indent (make child)\"\n              onClick={e => { e.stopPropagation(); handleIndent(node.id); }}\n              className=\"w-4 h-4 flex items-center justify-center rounded text-zinc-400 hover:text-violet-500 dark:text-zinc-500 dark:hover:text-violet-400 transition-colors\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points=\"13 17 18 12 13 7\" />\n                <polyline points=\"6 17 11 12 6 7\" />\n              </svg>\n            </button>\n            {/* Outdent */}\n            <button\n              title=\"Outdent (move to parent level)\"\n              onClick={e => { e.stopPropagation(); handleOutdent(node.id); }}\n              className=\"w-4 h-4 flex items-center justify-center rounded text-zinc-400 hover:text-violet-500 dark:text-zinc-500 dark:hover:text-violet-400 transition-colors\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points=\"11 17 6 12 11 7\" />\n                <polyline points=\"18 17 13 12 18 7\" />\n              </svg>\n            </button>\n            {/* Move up */}\n            <button\n              title=\"Move up\"\n              onClick={e => { e.stopPropagation(); handleMoveUp(node.id); }}\n              className=\"w-4 h-4 flex items-center justify-center rounded text-zinc-400 hover:text-zinc-600 dark:text-zinc-500 dark:hover:text-zinc-300 transition-colors\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"m18 15-6-6-6 6\" />\n              </svg>\n            </button>\n            {/* Move down */}\n            <button\n              title=\"Move down\"\n              onClick={e => { e.stopPropagation(); handleMoveDown(node.id); }}\n              className=\"w-4 h-4 flex items-center justify-center rounded text-zinc-400 hover:text-zinc-600 dark:text-zinc-500 dark:hover:text-zinc-300 transition-colors\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"m6 9 6 6 6-6\" />\n              </svg>\n            </button>\n            {/* Delete */}\n            <button\n              title=\"Delete\"\n              onClick={e => { e.stopPropagation(); handleDelete(node.id); }}\n              className=\"w-4 h-4 flex items-center justify-center rounded text-zinc-400 hover:text-red-500 dark:text-zinc-500 dark:hover:text-red-400 transition-colors\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\" />\n                <path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\" />\n                <path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\" />\n              </svg>\n            </button>\n          </div>\n        </div>\n\n        {/* Children */}\n        {node.children.length > 0 && (\n          <div>\n            {node.children.map(child => renderNode(child, depth + 1))}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"flex flex-col h-full bg-white dark:bg-zinc-900 border-l border-zinc-200 dark:border-zinc-700\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between px-3 py-2 border-b border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800/50\">\n        <div className=\"flex items-center gap-2\">\n          <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-blue-500\">\n            <path d=\"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z\" />\n          </svg>\n          <span className=\"text-xs font-medium text-zinc-700 dark:text-zinc-300\">Edit Bookmarks</span>\n          {isDirty && (\n            <span className=\"text-[9px] px-1.5 py-0.5 rounded-full bg-amber-100 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400 font-medium\">\n              Unsaved\n            </span>\n          )}\n        </div>\n        <div className=\"flex items-center gap-1.5\">\n          {/* Regenerate with AI */}\n          {onRegenerateWithAI && (\n            <button\n              onClick={onRegenerateWithAI}\n              disabled={isRegenerating}\n              className=\"text-[10px] px-2 py-1 rounded bg-violet-50 dark:bg-violet-950 text-violet-600 dark:text-violet-400 hover:bg-violet-100 dark:hover:bg-violet-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1\"\n            >\n              <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8\" />\n                <path d=\"M3 3v5h5\" />\n                <path d=\"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16\" />\n                <path d=\"M16 16h5v5\" />\n              </svg>\n              {isRegenerating ? 'Regenerating…' : 'Regenerate AI'}\n            </button>\n          )}\n          {/* Discard */}\n          <button\n            onClick={onDiscard}\n            className=\"text-[10px] px-2 py-1 rounded bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors\"\n          >\n            Discard\n          </button>\n          {/* Save */}\n          <button\n            onClick={handleSave}\n            disabled={!isDirty}\n            className=\"text-[10px] px-2 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n          >\n            Save\n          </button>\n        </div>\n      </div>\n\n      {/* Toolbar */}\n      <div className=\"flex items-center gap-1 px-3 py-1.5 border-b border-zinc-100 dark:border-zinc-800\">\n        <button\n          onClick={() => setShowAddForm(prev => !prev)}\n          className=\"text-[10px] px-2 py-1 rounded bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors flex items-center gap-1\"\n        >\n          <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n            <path d=\"M5 12h14\" />\n            <path d=\"M12 5v14\" />\n          </svg>\n          Add Bookmark\n        </button>\n        <span className=\"text-[9px] text-zinc-400 dark:text-zinc-500 ml-auto\">\n          {draft.length === 0 ? 'No bookmarks' : `${countBookmarks(draft)} bookmark${countBookmarks(draft) === 1 ? '' : 's'}`}\n        </span>\n      </div>\n\n      {/* Add form */}\n      {showAddForm && (\n        <div className=\"px-3 py-2 border-b border-zinc-100 dark:border-zinc-800 bg-zinc-50/50 dark:bg-zinc-800/30 flex items-center gap-2\">\n          <input\n            ref={addTitleRef}\n            value={addTitle}\n            onChange={e => setAddTitle(e.target.value)}\n            placeholder=\"Bookmark title\"\n            className=\"flex-1 min-w-0 text-[11px] px-2 py-1 rounded border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-zinc-800 dark:text-zinc-200 outline-none focus:border-blue-300 dark:focus:border-blue-700\"\n            onKeyDown={e => {\n              if (e.key === 'Enter') handleAdd();\n              if (e.key === 'Escape') setShowAddForm(false);\n            }}\n          />\n          <input\n            value={addPage}\n            onChange={e => setAddPage(e.target.value)}\n            placeholder=\"Page\"\n            type=\"number\"\n            min=\"1\"\n            className=\"w-14 text-[11px] px-2 py-1 rounded border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-zinc-800 dark:text-zinc-200 outline-none focus:border-blue-300 dark:focus:border-blue-700\"\n            onKeyDown={e => {\n              if (e.key === 'Enter') handleAdd();\n              if (e.key === 'Escape') setShowAddForm(false);\n            }}\n          />\n          <button\n            onClick={handleAdd}\n            disabled={!addTitle.trim()}\n            className=\"text-[10px] px-2 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n          >\n            Add\n          </button>\n          <button\n            onClick={() => setShowAddForm(false)}\n            className=\"text-[10px] px-1 py-1 rounded text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors\"\n          >\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M18 6 6 18\" />\n              <path d=\"m6 6 12 12\" />\n            </svg>\n          </button>\n        </div>\n      )}\n\n      {/* Bookmark tree */}\n      <div className=\"flex-1 overflow-y-auto px-1 py-1\">\n        {draft.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-8 text-zinc-400 dark:text-zinc-500\">\n            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"mb-2 opacity-50\">\n              <path d=\"m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z\" />\n            </svg>\n            <span className=\"text-[11px]\">No bookmarks</span>\n            <span className=\"text-[10px] mt-1\">Click \"Add Bookmark\" or \"Regenerate AI\" to start</span>\n          </div>\n        ) : (\n          draft.map(node => renderNode(node, 0))\n        )}\n      </div>\n\n      {/* Helper text */}\n      <div className=\"px-3 py-1.5 border-t border-zinc-100 dark:border-zinc-800 text-[9px] text-zinc-400 dark:text-zinc-500\">\n        Double-click to rename • Select a bookmark, then \"Add\" to nest under it\n      </div>\n    </div>\n  );\n};\n\n/** Count all bookmarks recursively. */\nfunction countBookmarks(nodes: BookmarkNode[]): number {\n  let count = nodes.length;\n  for (const n of nodes) count += countBookmarks(n.children);\n  return count;\n}\n\nexport default PdfBookmarkEditor;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\PdfUploadChoiceDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\PdfViewer.tsx","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":61,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":61,"endColumn":73,"fix":{"range":[2452,2510],"text":"{el.scrollIntoView({ behavior: 'smooth', block: 'start' });}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":65,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":65,"endColumn":30,"fix":{"range":[2637,2644],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":68,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":68,"endColumn":27,"fix":{"range":[2713,2720],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 36 to the 15 allowed.","line":71,"column":43,"nodeType":null,"messageId":"refactorFunction","endLine":71,"endColumn":45},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":77,"column":33,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":77,"endColumn":40,"fix":{"range":[3018,3083],"text":"for (const [pn, _] of textLayerRefs.current.entries()) pagesToSearch.push(pn);"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":83,"column":53,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":83,"endColumn":62,"fix":{"range":[3293,3302],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":91,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":91,"endColumn":37,"fix":{"range":[3605,3614],"text":"{continue;}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":94,"column":29,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":96,"endColumn":20},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":94,"column":51,"nodeType":"Literal","messageId":"noMagic","endLine":94,"endColumn":52},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":95,"column":19,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":96,"endColumn":20,"fix":{"range":[3760,3809],"text":"(spanText.includes(needle) ? 2\n                : 1)"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":100,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":100,"endColumn":32},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":100,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":100,"endColumn":40,"fix":{"range":[3967,3973],"text":"{break;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":109,"column":74,"nodeType":"Literal","messageId":"noMagic","endLine":109,"endColumn":75},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":118,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":118,"endColumn":37,"fix":{"range":[4604,4611],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":131,"column":14,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":17},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":136,"column":56,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":136,"endColumn":68,"fix":{"range":[5300,5312],"text":"{return null;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":138,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":138,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":138,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":138,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":138,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":138,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 90.","line":139,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":139,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 270.","line":139,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":139,"endColumn":48},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":158,"column":30,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":158,"endColumn":37,"fix":{"range":[5957,6011],"text":"for (const task of renderTasksRef.current) task.cancel();"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":162,"column":37,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":162,"endColumn":44,"fix":{"range":[6098,6155],"text":"for (const tl of textLayerInstancesRef.current) tl.cancel();"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":194,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":194,"endColumn":29,"fix":{"range":[7126,7133],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":197,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":197,"endColumn":55,"fix":{"range":[7186,7216],"text":"{onPageChange(1, pdf.numPages);}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'onPageChange'. Either include it or remove the dependency array. If 'onPageChange' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":202,"column":6,"nodeType":"ArrayExpression","endLine":202,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [onPageChange, pdfBase64]","fix":{"range":[7285,7296],"text":"[onPageChange, pdfBase64]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":207,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":207,"endColumn":22,"fix":{"range":[7459,7466],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":210,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":210,"endColumn":25,"fix":{"range":[7537,7544],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":214,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":214,"endColumn":45,"fix":{"range":[7674,7696],"text":"{existingTask.cancel();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":218,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":218,"endColumn":55,"fix":{"range":[7847,7874],"text":"{existingTextLayer.cancel();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":230,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":230,"endColumn":22,"fix":{"range":[8266,8273],"text":"{return;}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8606,8609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8606,8609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":246,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":246,"endColumn":22,"suggestions":[{"fix":{"range":[8676,8729],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":269,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":269,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9525,9528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9525,9528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":271,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":271,"endColumn":24,"suggestions":[{"fix":{"range":[9599,9667],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":279,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":279,"endColumn":61,"fix":{"range":[9851,9858],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":287,"column":17,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":287,"endColumn":24,"fix":{"range":[10037,10324],"text":"for (const entry of entries) {\n          if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {\n            maxRatio = entry.intersectionRatio;\n            const pn = parseInt(entry.target.getAttribute('data-page-number') || '1');\n            maxPage = pn;\n          }\n        }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":296,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":296,"endColumn":65,"fix":{"range":[10416,10452],"text":"{onPageChange(maxPage, pages.length);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":301,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":301,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.75.","line":301,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":39},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":308,"column":65,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":308,"endColumn":72,"fix":{"range":[10650,10761],"text":"for (const el of containerRef.current.querySelectorAll('[data-page-number]')) {\n      observer.observe(el);\n    }"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'visiblePage'. Either include it or remove the dependency array.","line":313,"column":6,"nodeType":"ArrayExpression","endLine":313,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [pages, onPageChange, visiblePage]","fix":{"range":[10808,10829],"text":"[pages, onPageChange, visiblePage]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":317,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":317,"endColumn":36,"fix":{"range":[10924,10931],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":330,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":330,"endColumn":28,"fix":{"range":[11329,11336],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":360,"column":30,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":360,"endColumn":37,"fix":{"range":[12345,12399],"text":"for (const task of renderTasksRef.current) task.cancel();"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'renderTasksRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'renderTasksRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":361,"column":22,"nodeType":"Identifier","endLine":361,"endColumn":29},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":362,"column":37,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":362,"endColumn":44,"fix":{"range":[12444,12501],"text":"for (const tl of textLayerInstancesRef.current) tl.cancel();"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'textLayerInstancesRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'textLayerInstancesRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":363,"column":29,"nodeType":"Identifier","endLine":363,"endColumn":36},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":372,"column":13,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":372,"endColumn":49,"fix":{"range":[12775,12811],"text":"{canvasRefs.current.set(pageNum, el);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":373,"column":10,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":373,"endColumn":45,"fix":{"range":[12821,12856],"text":"{canvasRefs.current.delete(pageNum);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":377,"column":13,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":377,"endColumn":52,"fix":{"range":[12968,13007],"text":"{textLayerRefs.current.set(pageNum, el);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":378,"column":10,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":378,"endColumn":48,"fix":{"range":[13017,13055],"text":"{textLayerRefs.current.delete(pageNum);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":423,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":423,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":423,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":423,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":423,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":423,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 90.","line":424,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":424,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 270.","line":424,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":424,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":58,"fixableErrorCount":0,"fixableWarningCount":31,"source":"import React, { useEffect, useRef, useState, useCallback, forwardRef, useImperativeHandle } from 'react';\nimport * as pdfjsLib from 'pdfjs-dist';\nimport { TextLayer } from 'pdfjs-dist';\n\npdfjsLib.GlobalWorkerOptions.workerSrc = new URL(\n  'pdfjs-dist/build/pdf.worker.min.mjs',\n  import.meta.url\n).toString();\n\nexport interface PdfViewerHandle {\n  scrollToPage: (pageNum: number) => void;\n  /** Scrolls to a heading by searching for its text in the text layer. If page is given, searches only that page; otherwise searches all rendered pages. */\n  scrollToHeading: (text: string, page?: number) => void;\n  /** Returns { pageWidth, pageHeight } at scale=1 for the current visible page, plus container dims */\n  getFitDims: () => { pageWidth: number; pageHeight: number; containerWidth: number; containerHeight: number } | null;\n  /** Returns currently selected text and the page it's on, or null */\n  getSelectedText: () => { text: string; page: number } | null;\n}\n\ninterface PdfViewerProps {\n  pdfBase64: string;\n  scale: number;\n  rotation: number;\n  onPageChange?: (pageNum: number, totalPages: number) => void;\n  /** Fired when user selects text in the PDF via the text layer */\n  onTextSelected?: (text: string, pageNum: number) => void;\n}\n\ninterface PageInfo {\n  pageNum: number;\n  width: number;\n  height: number;\n  rendered: boolean;\n}\n\nconst RENDER_BUFFER = 2; // render pages within +/- 2 of visible\n\nconst PdfViewer = forwardRef<PdfViewerHandle, PdfViewerProps>(({\n  pdfBase64,\n  scale,\n  rotation,\n  onPageChange,\n  onTextSelected,\n}, ref) => {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const pdfDocRef = useRef<pdfjsLib.PDFDocumentProxy | null>(null);\n  const canvasRefs = useRef<Map<number, HTMLCanvasElement>>(new Map());\n  const textLayerRefs = useRef<Map<number, HTMLDivElement>>(new Map());\n  const renderTasksRef = useRef<Map<number, { cancel: () => void }>>(new Map());\n  const textLayerInstancesRef = useRef<Map<number, TextLayer>>(new Map());\n  const [pages, setPages] = useState<PageInfo[]>([]);\n  const [visiblePage, setVisiblePage] = useState(1);\n  const observerRef = useRef<IntersectionObserver | null>(null);\n\n  // Track selected text for imperative handle\n  const selectedTextRef = useRef<{ text: string; page: number } | null>(null);\n\n  useImperativeHandle(ref, () => ({\n    scrollToPage(pageNum: number) {\n      const el = containerRef.current?.querySelector(`[data-page-number=\"${pageNum}\"]`);\n      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });\n    },\n    scrollToHeading(text: string, page?: number) {\n      const container = containerRef.current;\n      if (!container) return;\n\n      const needle = text.trim().toLowerCase();\n      if (!needle) return;\n\n      /** Search rendered text layer spans and scroll to best match */\n      const searchAndScroll = (): boolean => {\n        // Determine which pages to search\n        const pagesToSearch: number[] = [];\n        if (page != null) {\n          pagesToSearch.push(page);\n        } else {\n          textLayerRefs.current.forEach((_, pn) => pagesToSearch.push(pn));\n          pagesToSearch.sort((a, b) => a - b);\n        }\n\n        for (const pn of pagesToSearch) {\n          const textDiv = textLayerRefs.current.get(pn);\n          if (!textDiv || !textDiv.children.length) continue;\n\n          const spans = textDiv.querySelectorAll('span:not(.markedContent)');\n          let bestMatch: HTMLElement | null = null;\n          let bestScore = 0;\n\n          for (const span of spans) {\n            const spanText = (span.textContent || '').trim().toLowerCase();\n            if (!spanText) continue;\n\n            if (spanText.includes(needle) || needle.includes(spanText)) {\n              const score = spanText === needle ? 3\n                : spanText.includes(needle) ? 2\n                : 1;\n              if (score > bestScore) {\n                bestScore = score;\n                bestMatch = span as HTMLElement;\n                if (score === 3) break;\n              }\n            }\n          }\n\n          if (bestMatch) {\n            const containerRect = container.getBoundingClientRect();\n            const spanRect = bestMatch.getBoundingClientRect();\n            const scrollOffset = spanRect.top - containerRect.top + container.scrollTop;\n            const targetScroll = scrollOffset - container.clientHeight / 3;\n            container.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });\n            return true;\n          }\n        }\n        return false;\n      };\n\n      // Try immediate search (works if page is already rendered)\n      if (searchAndScroll()) return;\n\n      // If page is known but text layer not rendered yet, scroll to page first\n      // then retry after rendering catches up\n      if (page != null) {\n        const pageEl = container.querySelector(`[data-page-number=\"${page}\"]`);\n        if (pageEl) {\n          pageEl.scrollIntoView({ behavior: 'smooth', block: 'start' });\n          // Retry after page renders (rendering triggered by IntersectionObserver)\n          setTimeout(() => {\n            if (!searchAndScroll()) {\n              // Still no match — stay at page top (already scrolled there)\n            }\n          }, 600);\n        }\n      }\n    },\n    getFitDims() {\n      if (pages.length === 0 || !containerRef.current) return null;\n      const page = pages[visiblePage - 1] || pages[0];\n      const rot = ((rotation % 360) + 360) % 360;\n      const swapped = rot === 90 || rot === 270;\n      return {\n        pageWidth: swapped ? page.height : page.width,\n        pageHeight: swapped ? page.width : page.height,\n        containerWidth: containerRef.current.clientWidth,\n        containerHeight: containerRef.current.clientHeight,\n      };\n    },\n    getSelectedText() {\n      return selectedTextRef.current;\n    },\n  }));\n\n  // Load PDF document\n  useEffect(() => {\n    let cancelled = false;\n\n    const loadPdf = async () => {\n      // Cancel any existing render tasks\n      renderTasksRef.current.forEach(task => task.cancel());\n      renderTasksRef.current.clear();\n\n      // Cancel any existing text layers\n      textLayerInstancesRef.current.forEach(tl => tl.cancel());\n      textLayerInstancesRef.current.clear();\n\n      // Destroy previous document\n      if (pdfDocRef.current) {\n        pdfDocRef.current.destroy();\n        pdfDocRef.current = null;\n      }\n\n      const binaryStr = atob(pdfBase64);\n      const bytes = new Uint8Array(binaryStr.length);\n      for (let i = 0; i < binaryStr.length; i++) {\n        bytes[i] = binaryStr.charCodeAt(i);\n      }\n\n      const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;\n      if (cancelled) { pdf.destroy(); return; }\n\n      pdfDocRef.current = pdf;\n\n      // Get page dimensions for all pages\n      const pageInfos: PageInfo[] = [];\n      for (let i = 1; i <= pdf.numPages; i++) {\n        const page = await pdf.getPage(i);\n        const viewport = page.getViewport({ scale: 1, rotation: 0 });\n        pageInfos.push({\n          pageNum: i,\n          width: viewport.width,\n          height: viewport.height,\n          rendered: false,\n        });\n      }\n      if (cancelled) return;\n\n      setPages(pageInfos);\n      if (onPageChange) onPageChange(1, pdf.numPages);\n    };\n\n    loadPdf();\n    return () => { cancelled = true; };\n  }, [pdfBase64]);\n\n  // Render a single page (canvas + text layer)\n  const renderPage = useCallback(async (pageNum: number) => {\n    const pdf = pdfDocRef.current;\n    if (!pdf) return;\n\n    const canvas = canvasRefs.current.get(pageNum);\n    if (!canvas) return;\n\n    // Cancel existing render for this page\n    const existingTask = renderTasksRef.current.get(pageNum);\n    if (existingTask) existingTask.cancel();\n\n    // Cancel existing text layer for this page\n    const existingTextLayer = textLayerInstancesRef.current.get(pageNum);\n    if (existingTextLayer) existingTextLayer.cancel();\n\n    const page = await pdf.getPage(pageNum);\n    const viewport = page.getViewport({ scale, rotation });\n\n    const dpr = window.devicePixelRatio || 1;\n    canvas.width = viewport.width * dpr;\n    canvas.height = viewport.height * dpr;\n    canvas.style.width = `${viewport.width}px`;\n    canvas.style.height = `${viewport.height}px`;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n\n    const renderTask = page.render({\n      canvas,\n      canvasContext: ctx,\n      viewport,\n    });\n\n    renderTasksRef.current.set(pageNum, { cancel: () => renderTask.cancel() });\n\n    try {\n      await renderTask.promise;\n      renderTasksRef.current.delete(pageNum);\n    } catch (e: any) {\n      if (e?.name !== 'RenderingCancelledException') {\n        console.error(`Error rendering page ${pageNum}:`, e);\n      }\n      return; // Don't render text layer if canvas render failed\n    }\n\n    // Render text layer\n    const textDiv = textLayerRefs.current.get(pageNum);\n    if (textDiv) {\n      textDiv.innerHTML = '';\n      // Set CSS custom property for scale factor used by pdfjs textLayer CSS\n      textDiv.style.setProperty('--total-scale-factor', String(scale));\n      textDiv.style.width = `${viewport.width}px`;\n      textDiv.style.height = `${viewport.height}px`;\n\n      try {\n        const textContent = await page.getTextContent();\n        const textLayer = new TextLayer({\n          textContentSource: textContent,\n          container: textDiv,\n          viewport,\n        });\n        textLayerInstancesRef.current.set(pageNum, textLayer);\n        await textLayer.render();\n      } catch (e: any) {\n        if (e?.name !== 'RenderingCancelledException') {\n          console.error(`Error rendering text layer for page ${pageNum}:`, e);\n        }\n      }\n    }\n  }, [scale, rotation]);\n\n  // Set up IntersectionObserver for visible page detection\n  useEffect(() => {\n    if (pages.length === 0 || !containerRef.current) return;\n\n    observerRef.current?.disconnect();\n\n    const observer = new IntersectionObserver(\n      (entries) => {\n        let maxRatio = 0;\n        let maxPage = visiblePage;\n        entries.forEach(entry => {\n          if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {\n            maxRatio = entry.intersectionRatio;\n            const pn = parseInt(entry.target.getAttribute('data-page-number') || '1');\n            maxPage = pn;\n          }\n        });\n        if (maxRatio > 0) {\n          setVisiblePage(maxPage);\n          if (onPageChange) onPageChange(maxPage, pages.length);\n        }\n      },\n      {\n        root: containerRef.current,\n        threshold: [0, 0.25, 0.5, 0.75, 1],\n      }\n    );\n\n    observerRef.current = observer;\n\n    // Observe all page wrappers\n    containerRef.current.querySelectorAll('[data-page-number]').forEach(el => {\n      observer.observe(el);\n    });\n\n    return () => observer.disconnect();\n  }, [pages, onPageChange]);\n\n  // Render visible pages and nearby pages\n  useEffect(() => {\n    if (pages.length === 0) return;\n\n    const start = Math.max(1, visiblePage - RENDER_BUFFER);\n    const end = Math.min(pages.length, visiblePage + RENDER_BUFFER);\n\n    for (let i = start; i <= end; i++) {\n      renderPage(i);\n    }\n  }, [visiblePage, pages, scale, rotation, renderPage]);\n\n  // Handle text selection via mouseup on the container\n  useEffect(() => {\n    const container = containerRef.current;\n    if (!container) return;\n\n    const handleMouseUp = () => {\n      const sel = window.getSelection();\n      const text = sel?.toString().trim();\n      if (text) {\n        // Determine which page the selection is in\n        let pageNum = visiblePage;\n        const anchorNode = sel?.anchorNode;\n        if (anchorNode) {\n          const pageWrapper = (anchorNode instanceof HTMLElement ? anchorNode : anchorNode.parentElement)\n            ?.closest('[data-page-number]');\n          if (pageWrapper) {\n            pageNum = parseInt(pageWrapper.getAttribute('data-page-number') || String(visiblePage));\n          }\n        }\n        selectedTextRef.current = { text, page: pageNum };\n        onTextSelected?.(text, pageNum);\n      } else {\n        selectedTextRef.current = null;\n      }\n    };\n\n    container.addEventListener('mouseup', handleMouseUp);\n    return () => container.removeEventListener('mouseup', handleMouseUp);\n  }, [visiblePage, onTextSelected]);\n\n  // Clean up on unmount\n  useEffect(() => {\n    return () => {\n      renderTasksRef.current.forEach(task => task.cancel());\n      renderTasksRef.current.clear();\n      textLayerInstancesRef.current.forEach(tl => tl.cancel());\n      textLayerInstancesRef.current.clear();\n      if (pdfDocRef.current) {\n        pdfDocRef.current.destroy();\n        pdfDocRef.current = null;\n      }\n    };\n  }, []);\n\n  const setCanvasRef = useCallback((pageNum: number, el: HTMLCanvasElement | null) => {\n    if (el) canvasRefs.current.set(pageNum, el);\n    else canvasRefs.current.delete(pageNum);\n  }, []);\n\n  const setTextLayerRef = useCallback((pageNum: number, el: HTMLDivElement | null) => {\n    if (el) textLayerRefs.current.set(pageNum, el);\n    else textLayerRefs.current.delete(pageNum);\n  }, []);\n\n  return (\n    <div\n      ref={containerRef}\n      className=\"w-full h-full overflow-auto bg-zinc-100 dark:bg-zinc-800/50\"\n    >\n      <div className=\"flex flex-col items-center gap-2 py-2 px-2\">\n        {pages.map((pageInfo) => {\n          const viewport = getViewportDims(pageInfo, scale, rotation);\n          return (\n            <div\n              key={pageInfo.pageNum}\n              data-page-number={pageInfo.pageNum}\n              className=\"bg-white dark:bg-zinc-900 shadow-sm relative\"\n              style={{\n                width: viewport.width,\n                height: viewport.height,\n              }}\n            >\n              <canvas\n                ref={(el) => setCanvasRef(pageInfo.pageNum, el)}\n              />\n              <div\n                ref={(el) => setTextLayerRef(pageInfo.pageNum, el)}\n                className=\"textLayer\"\n                style={{\n                  position: 'absolute',\n                  top: 0,\n                  left: 0,\n                }}\n              />\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n});\n\nPdfViewer.displayName = 'PdfViewer';\n\n/** Calculate viewport dimensions for a page at given scale/rotation */\nfunction getViewportDims(page: PageInfo, scale: number, rotation: number) {\n  const rot = ((rotation % 360) + 360) % 360;\n  const swapped = rot === 90 || rot === 270;\n  return {\n    width: (swapped ? page.height : page.width) * scale,\n    height: (swapped ? page.width : page.height) * scale,\n  };\n}\n\nexport default PdfViewer;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\ProjectCreationModal.tsx","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":22,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":22,"endColumn":32,"fix":{"range":[592,605],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":29,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":29,"endColumn":28,"fix":{"range":[823,830],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":47,"column":59,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":47,"endColumn":69,"fix":{"range":[1322,1332],"text":"{onClose();}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":3,"source":"\nimport React, { useState, useMemo } from 'react';\nimport { createPortal } from 'react-dom';\nimport { Project } from '../types';\n\ninterface ProjectCreationModalProps {\n  projects: Project[];\n  onCreateProject: (name: string, description: string) => void;\n  onClose: () => void;\n}\n\nexport const ProjectCreationModal: React.FC<ProjectCreationModalProps> = ({\n  projects,\n  onCreateProject,\n  onClose,\n}) => {\n  const [name, setName] = useState('');\n  const [description, setDescription] = useState('');\n\n  const nameConflict = useMemo(() => {\n    const trimmed = name.trim();\n    if (!trimmed) return false;\n    return projects.some(p => p.name.toLowerCase() === trimmed.toLowerCase());\n  }, [name, projects]);\n\n  const canCreate = name.trim().length > 0 && !nameConflict;\n\n  const handleCreate = () => {\n    if (!canCreate) return;\n    onCreateProject(name.trim(), description.trim());\n    onClose();\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey && canCreate) {\n      e.preventDefault();\n      handleCreate();\n    }\n    if (e.key === 'Escape') {\n      onClose();\n    }\n  };\n\n  return createPortal(\n    <div\n      className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n      onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}\n    >\n      <div className=\"bg-white dark:bg-zinc-900 rounded-[24px] shadow-2xl dark:shadow-black/30 w-full max-w-md mx-4 overflow-hidden animate-in zoom-in-95 duration-200\">\n        {/* Header */}\n        <div className=\"px-6 pt-6 pb-4\">\n          <div className=\"flex items-center gap-3 mb-5\">\n            <div className=\"w-9 h-9 rounded-xl bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-600 dark:text-zinc-400\">\n                <path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\" />\n              </svg>\n            </div>\n            <h2 className=\"text-sm font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight\">New Project</h2>\n          </div>\n\n          {/* Name input */}\n          <div className=\"mb-4\">\n            <label className=\"block text-[11px] font-medium text-zinc-500 dark:text-zinc-400 mb-1.5\">Name</label>\n            <input\n              type=\"text\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              onKeyDown={handleKeyDown}\n              placeholder=\"Enter project name...\"\n              className=\"w-full px-3 py-2 text-xs border border-zinc-200 dark:border-zinc-600 rounded-lg focus:outline-none focus:border-zinc-400 transition-colors dark:bg-zinc-800 dark:text-zinc-100\"\n              autoFocus\n            />\n            {nameConflict && (\n              <p className=\"mt-1.5 text-[11px] text-red-500\">A project with this name already exists</p>\n            )}\n          </div>\n\n          {/* Description input */}\n          <div>\n            <label className=\"block text-[11px] font-medium text-zinc-500 dark:text-zinc-400 mb-1.5\">Description <span className=\"font-normal text-zinc-400 dark:text-zinc-500\">(optional)</span></label>\n            <textarea\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              onKeyDown={handleKeyDown}\n              placeholder=\"What is this project about...\"\n              rows={3}\n              className=\"w-full px-3 py-2 text-xs border border-zinc-200 dark:border-zinc-600 rounded-lg focus:outline-none focus:border-zinc-400 transition-colors resize-none dark:bg-zinc-800 dark:text-zinc-100\"\n            />\n          </div>\n        </div>\n\n        {/* Footer */}\n        <div className=\"px-6 pb-6 pt-2 flex items-center justify-end gap-3\">\n          <button\n            onClick={onClose}\n            className=\"text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 text-xs transition-colors\"\n          >\n            Cancel\n          </button>\n          <button\n            onClick={handleCreate}\n            disabled={!canCreate}\n            className=\"bg-black text-white rounded-lg px-5 py-2 text-xs font-medium hover:bg-zinc-800 disabled:opacity-40 disabled:pointer-events-none transition-colors\"\n          >\n            Create\n          </button>\n        </div>\n      </div>\n    </div>,\n    document.body\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\ProjectsPanel.tsx","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":48,"column":15,"nodeType":"Literal","messageId":"noMagic","endLine":48,"endColumn":19},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":48,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":48,"endColumn":41,"fix":{"range":[2262,2282],"text":"{return `${bytes} B`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":49,"column":15,"nodeType":"Literal","messageId":"noMagic","endLine":49,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":49,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":49,"endColumn":26},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":49,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":49,"endColumn":69,"fix":{"range":[2310,2351],"text":"{return `${(bytes / 1024).toFixed(1)} KB`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":49,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":49,"endColumn":51},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":50,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":50,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1024.","line":50,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":50,"endColumn":34},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":54,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":54,"endColumn":53,"fix":{"range":[2502,2515],"text":"{return 'PDF';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":63,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":63,"endColumn":27,"fix":{"range":[2709,2720],"text":"{return '—';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":64,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":64,"endColumn":53,"fix":{"range":[2755,2773],"text":"{return 'Uploaded';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":72,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":72,"endColumn":53,"fix":{"range":[3157,3170],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":73,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":73,"endColumn":49,"fix":{"range":[3206,3219],"text":"{return false;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":199,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":199,"endColumn":63},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'shouldRender'. Either include it or remove the dependency array.","line":202,"column":6,"nodeType":"ArrayExpression","endLine":202,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, shouldRender]","fix":{"range":[8525,8533],"text":"[isOpen, shouldRender]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":206,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":206,"endColumn":64,"fix":{"range":[8700,8731],"text":"{setOverlayWidth(DEFAULT_WIDTH);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":218,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":218,"endColumn":39,"fix":{"range":[9270,9277],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":257,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":257,"endColumn":53,"fix":{"range":[11383,11395],"text":"{return prev;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'onToggleProjectCollapse' and 'projects'. Either include them or remove the dependency array. If 'onToggleProjectCollapse' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":265,"column":6,"nodeType":"ArrayExpression","endLine":265,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [onToggleProjectCollapse, projects, selectedNuggetId]","fix":{"range":[11656,11674],"text":"[onToggleProjectCollapse, projects, selectedNuggetId]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":280,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":280,"endColumn":54,"fix":{"range":[12459,12466],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 19 to the 15 allowed.","line":315,"column":27,"nodeType":null,"messageId":"refactorFunction","endLine":315,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'selectedNugget' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":353,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":353,"endColumn":23},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'findDocAcrossNuggets' was used before it was defined.","line":362,"column":26,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":362,"endColumn":46},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":373,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":373,"endColumn":68,"fix":{"range":[15561,15602],"text":"{onRenameDocument(docRenamingId, trimmed);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":383,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":383,"endColumn":42,"fix":{"range":[15917,15943],"text":"{return { doc, nugget: n };}"}},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'ProjectRow' was used before it was defined.","line":466,"column":20,"nodeType":"JSXIdentifier","messageId":"noUseBeforeDefine","endLine":466,"endColumn":30},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":498,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":498,"endColumn":71,"fix":{"range":[22571,22593],"text":"{next.delete(nuggetId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":498,"column":77,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":498,"endColumn":96,"fix":{"range":[22599,22618],"text":"{next.add(nuggetId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":549,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":549,"endColumn":46,"fix":{"range":[25795,25807],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":581,"column":108,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":581,"endColumn":131,"fix":{"range":[27632,27655],"text":"{onDuplicateProject(id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":594,"column":90,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":594,"endColumn":126,"fix":{"range":[28528,28564],"text":"{onCreateNuggetInProject(project.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":662,"column":68,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":662,"endColumn":75,"fix":{"range":[34255,34262],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":735,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":735,"endColumn":33,"fix":{"range":[38160,38172],"text":"{return null;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":941,"column":155,"nodeType":"Literal","messageId":"defineConstant","endLine":941,"endColumn":175},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":941,"column":184,"nodeType":"Literal","messageId":"defineConstant","endLine":941,"endColumn":197},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":964,"column":82,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":964,"endColumn":89,"fix":{"range":[54545,54552],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":965,"column":82,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":965,"endColumn":89,"fix":{"range":[55128,55135],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":982,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":982,"endColumn":32,"fix":{"range":[56067,56079],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1023,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1023,"endColumn":69,"fix":{"range":[58577,58610],"text":"{onDeleteProject(confirmDeleteId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":1024,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":1024,"endColumn":58,"fix":{"range":[58636,58668],"text":"{onDeleteNugget(confirmDeleteId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1040,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1040,"endColumn":33,"fix":{"range":[59172,59184],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1140,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1140,"endColumn":46,"fix":{"range":[65312,65319],"text":"{return;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onRename' is defined but never used. Allowed unused args must match /^_/u.","line":1220,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":1220,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onNewNugget' is defined but never used. Allowed unused args must match /^_/u.","line":1220,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":1220,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onDelete' is defined but never used. Allowed unused args must match /^_/u.","line":1220,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":1220,"endColumn":66},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onNuggetRename' is defined but never used. Allowed unused args must match /^_/u.","line":1224,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":1224,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onNuggetDelete' is defined but never used. Allowed unused args must match /^_/u.","line":1224,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":1224,"endColumn":53},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 23 to the 15 allowed.","line":1228,"column":4,"nodeType":null,"messageId":"refactorFunction","endLine":1228,"endColumn":6},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1243,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1243,"endColumn":32,"fix":{"range":[69459,69466],"text":"{return;}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1251,"column":89,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1251,"endColumn":181},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1251,"column":118,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1251,"endColumn":181,"fix":{"range":[69805,69868],"text":"(isProjectSelected ? 'var(--tree-icon)' : 'var(--tree-icon-dim)')"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 10 times.","line":1251,"column":138,"nodeType":"Literal","messageId":"defineConstant","endLine":1251,"endColumn":156},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 10 times.","line":1251,"column":159,"nodeType":"Literal","messageId":"defineConstant","endLine":1251,"endColumn":181},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1260,"column":187,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1260,"endColumn":279},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1260,"column":216,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1260,"endColumn":279,"fix":{"range":[70271,70334],"text":"(isProjectSelected ? 'var(--tree-text)' : 'var(--tree-text-dim)')"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":1260,"column":236,"nodeType":"Literal","messageId":"defineConstant","endLine":1260,"endColumn":254},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":1260,"column":257,"nodeType":"Literal","messageId":"defineConstant","endLine":1260,"endColumn":279},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1274,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1274,"endColumn":57,"fix":{"range":[70861,70878],"text":"{onRenameCommit();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1275,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1275,"endColumn":58,"fix":{"range":[70919,70936],"text":"{onRenameCancel();}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":1278,"column":177,"nodeType":"Literal","messageId":"defineConstant","endLine":1278,"endColumn":214},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":1278,"column":217,"nodeType":"Literal","messageId":"defineConstant","endLine":1278,"endColumn":277},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1283,"column":77,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1283,"endColumn":169},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1283,"column":106,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1283,"endColumn":169,"fix":{"range":[71529,71592],"text":"(isProjectSelected ? 'var(--tree-text)' : 'var(--tree-text-dim)')"}},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'NuggetRow' was used before it was defined.","line":1308,"column":16,"nodeType":"JSXIdentifier","messageId":"noUseBeforeDefine","endLine":1308,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'selectedDocId' is defined but never used. Allowed unused args must match /^_/u.","line":1388,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":1388,"endColumn":49},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 25 to the 15 allowed.","line":1390,"column":4,"nodeType":null,"messageId":"refactorFunction","endLine":1390,"endColumn":6},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1396,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1396,"endColumn":32,"fix":{"range":[76167,76174],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1400,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1400,"endColumn":32,"fix":{"range":[76257,76264],"text":"{return;}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1412,"column":89,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1412,"endColumn":188},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1412,"column":123,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1412,"endColumn":188,"fix":{"range":[76858,76923],"text":"(isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)')"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1429,"column":40,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1429,"endColumn":57,"fix":{"range":[77467,77484],"text":"{onRenameCommit();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1430,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1430,"endColumn":58,"fix":{"range":[77525,77542],"text":"{onRenameCancel();}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1439,"column":113,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1439,"endColumn":214},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":1439,"column":126,"nodeType":"Literal","messageId":"defineConstant","endLine":1439,"endColumn":146},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1439,"column":149,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1439,"endColumn":214,"fix":{"range":[78189,78254],"text":"(isInSelectedProject ? 'var(--tree-text)' : 'var(--tree-text-dim)')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1442,"column":97,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1442,"endColumn":196},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1442,"column":131,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1442,"endColumn":196,"fix":{"range":[78454,78519],"text":"(isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1452,"column":27,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1452,"endColumn":126},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1452,"column":61,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1452,"endColumn":126,"fix":{"range":[78944,79009],"text":"(isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)')"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1484,"column":48,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1484,"endColumn":68,"fix":{"range":[80536,80556],"text":"{onDocRenameCommit();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1485,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1485,"endColumn":69,"fix":{"range":[80605,80625],"text":"{onDocRenameCancel();}"}},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'DocRow' was used before it was defined.","line":1494,"column":18,"nodeType":"JSXIdentifier","messageId":"noUseBeforeDefine","endLine":1494,"endColumn":24},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1544,"column":189,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1544,"endColumn":290},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1544,"column":225,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1544,"endColumn":290,"fix":{"range":[83095,83160],"text":"(isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1548,"column":69,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1548,"endColumn":170},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1548,"column":105,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1548,"endColumn":170,"fix":{"range":[83409,83474],"text":"(isInSelectedProject ? 'var(--tree-text)' : 'var(--tree-text-dim)')"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1553,"column":25,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1553,"endColumn":124},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1553,"column":59,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1553,"endColumn":124,"fix":{"range":[83844,83909],"text":"(isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)')"}}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":77,"fixableErrorCount":0,"fixableWarningCount":46,"source":"import React, { useRef, useState, useEffect, useCallback } from 'react';\nimport { createPortal } from 'react-dom';\nimport { Nugget, Project, UploadedFile, SourceOrigin } from '../types';\nimport { isNameTaken } from '../utils/naming';\nimport { formatTimestampFull } from '../utils/formatTime';\nimport { useAppContext } from '../context/AppContext';\n\ninterface ProjectsPanelProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  nuggets: Nugget[];\n  projects: Project[];\n  selectedNuggetId: string | null;\n  selectedProjectId: string | null;\n  selectionLevel: 'project' | 'nugget' | 'document' | null;\n  onSelectProject: (projectId: string) => void;\n  onSelectNugget: (id: string) => void;\n  onCreateProject: () => void;\n  onRenameProject: (id: string, newName: string) => void;\n  onDeleteProject: (id: string) => void;\n  onToggleProjectCollapse: (id: string) => void;\n  onCreateNuggetInProject: (projectId: string) => void;\n  onRenameNugget: (id: string, newName: string) => void;\n  onDeleteNugget: (id: string) => void;\n  onCopyNuggetToProject: (nuggetId: string, targetProjectId: string) => void;\n  onMoveNuggetToProject: (nuggetId: string, sourceProjectId: string, targetProjectId: string) => void;\n  onCreateProjectForNugget: (nuggetId: string, projectName: string, mode: 'copy' | 'move', sourceProjectId: string) => void;\n  onDuplicateProject: (id: string) => void;\n  // Document operations (kebab menu on docs under the selected nugget)\n  onRenameDocument?: (docId: string, newName: string) => void;\n  onRemoveDocument?: (docId: string) => void;\n  onCopyMoveDocument?: (docId: string, targetNuggetId: string, mode: 'copy' | 'move') => void;\n  onCreateNuggetWithDoc?: (nuggetName: string, docId: string) => void;\n  onUploadDocuments?: (files: FileList) => void;\n  onOpenDocument?: (docId: string) => void;\n  onEditSubject?: (nuggetId: string) => void;\n  onOpenCardsPanel?: () => void;\n  onOpenSourcesPanel?: () => void;\n  otherNuggets?: { id: string; name: string }[];\n  projectNuggets?: { projectId: string; projectName: string; nuggets: { id: string; name: string }[] }[];\n  selectedDocId?: string | null;\n  onSelectDoc?: (docId: string | null) => void;\n}\n\n// ── Document Info helpers ──\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes < 1024) return `${bytes} B`;\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n}\n\nfunction formatSourceType(doc: UploadedFile): string {\n  if (doc.sourceType === 'native-pdf') return 'PDF';\n  switch (doc.originalFormat) {\n    case 'pdf': return 'PDF';\n    case 'md': return 'MD';\n    default: return 'MD';\n  }\n}\n\nfunction formatOrigin(origin?: SourceOrigin): string {\n  if (!origin) return '—';\n  if (origin.type === 'uploaded') return 'Uploaded';\n  const action = origin.type === 'copied' ? 'Copied' : 'Moved';\n  const from = [origin.sourceProjectName, origin.sourceNuggetName].filter(Boolean).join(' / ');\n  return from ? `${action} from ${from}` : action;\n}\n\nfunction isConvertedToMd(doc: UploadedFile): boolean {\n  // Native PDFs are NOT converted to MD; direct markdown is NOT converted\n  if (doc.sourceType === 'native-pdf') return false;\n  if (doc.originalFormat === 'md') return false;\n  // PDF that went through markdown conversion = yes\n  return doc.originalFormat === 'pdf';\n}\n\n/** A single label → value row in the info card */\nconst InfoRow: React.FC<{ label: string; value: string; valueClass?: string }> = ({ label, value, valueClass }) => (\n  <div className=\"flex items-baseline justify-between gap-2\">\n    <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400 shrink-0\">{label}</span>\n    <span className={`text-[10px] truncate text-right max-w-[180px] ${valueClass ?? 'text-zinc-600 dark:text-zinc-400'}`} title={value}>{value}</span>\n  </div>\n);\n\nconst DocumentInfoContent: React.FC<{ doc: UploadedFile; enabled: boolean }> = ({ doc, enabled }) => {\n  const originalName = doc.originalName ?? doc.name;\n  const isRenamed = originalName !== doc.name;\n  const chatEnabled = enabled;\n  const chatTimestamp = chatEnabled ? doc.lastEnabledAt : doc.lastDisabledAt;\n\n  return (\n    <>\n      {/* ── Header ── */}\n      <div className=\"px-3 py-2 border-b border-zinc-100 dark:border-zinc-600\">\n        <p className=\"text-[10px] font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider\">Document Info</p>\n      </div>\n\n      <div className=\"px-3 py-2.5 space-y-2\">\n        {/* ── Naming ── */}\n        <p className=\"text-[9px] font-semibold text-zinc-400 dark:text-zinc-400 uppercase tracking-widest\">Naming</p>\n        <InfoRow label=\"Current Name\" value={doc.name} valueClass=\"text-zinc-700 dark:text-zinc-300 font-medium\" />\n        {isRenamed && <InfoRow label=\"Original Name\" value={originalName} />}\n        {doc.lastRenamedAt && <InfoRow label=\"Renamed\" value={formatTimestampFull(doc.lastRenamedAt)} />}\n\n        <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n\n        {/* ── Origin & Type ── */}\n        <p className=\"text-[9px] font-semibold text-zinc-400 dark:text-zinc-400 uppercase tracking-widest\">Origin & Type</p>\n        <InfoRow label=\"Origin\" value={formatOrigin(doc.sourceOrigin)} />\n        {doc.sourceOrigin && <InfoRow label=\"Origin Date\" value={formatTimestampFull(doc.sourceOrigin.timestamp)} />}\n        <InfoRow label=\"Source Type\" value={formatSourceType(doc)} />\n        <InfoRow label=\"Converted to MD\" value={isConvertedToMd(doc) ? 'Yes' : 'No'} />\n        <InfoRow label=\"Size\" value={formatFileSize(doc.size)} />\n\n        <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n\n        {/* ── Versions ── */}\n        <p className=\"text-[9px] font-semibold text-zinc-400 dark:text-zinc-400 uppercase tracking-widest\">Versions</p>\n        <InfoRow label=\"Version\" value={`V${doc.version ?? 1}`} />\n        <InfoRow label=\"Updated\" value={doc.lastEditedAt ? formatTimestampFull(doc.lastEditedAt) : '—'} />\n\n        <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n\n        {/* ── Chat ── */}\n        <p className=\"text-[9px] font-semibold text-zinc-400 dark:text-zinc-400 uppercase tracking-widest\">Chat</p>\n        <div className=\"flex items-baseline justify-between gap-2\">\n          <span className=\"text-[10px] text-zinc-500 dark:text-zinc-400 shrink-0\">Status</span>\n          <span className={`text-[10px] font-medium ${chatEnabled ? 'text-green-600' : 'text-red-500'}`}>\n            {chatEnabled ? 'Enabled \\u2713' : 'Disabled \\u2717'}\n          </span>\n        </div>\n        <InfoRow label=\"Changed\" value={chatTimestamp ? formatTimestampFull(chatTimestamp) : '—'} />\n      </div>\n    </>\n  );\n};\n\n/** Ellipsis (three-dot) icon */\nconst EllipsisIcon = () => (\n  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n    <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n  </svg>\n);\n\n/** Chevron icon for collapse/expand */\nconst ChevronIcon = ({ isCollapsed }: { isCollapsed: boolean }) => (\n  <svg\n    width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n    className={`transition-transform duration-150 ${isCollapsed ? '-rotate-90' : ''}`}\n  >\n    <polyline points=\"6 9 12 15 18 9\" />\n  </svg>\n);\n\nconst ProjectsPanel: React.FC<ProjectsPanelProps> = ({\n  isOpen,\n  onToggle,\n  nuggets,\n  projects,\n  selectedNuggetId,\n  selectedProjectId,\n  selectionLevel,\n  onSelectProject,\n  onSelectNugget,\n  onCreateProject,\n  onRenameProject,\n  onDeleteProject,\n  onToggleProjectCollapse,\n  onCreateNuggetInProject,\n  onRenameNugget,\n  onDeleteNugget,\n  onCopyNuggetToProject,\n  onMoveNuggetToProject,\n  onCreateProjectForNugget,\n  onDuplicateProject,\n  onRenameDocument,\n  onRemoveDocument,\n  onCopyMoveDocument,\n  onCreateNuggetWithDoc,\n  onUploadDocuments,\n  onOpenDocument,\n  onEditSubject,\n  onOpenCardsPanel,\n  onOpenSourcesPanel,\n  otherNuggets,\n  projectNuggets,\n  selectedDocId,\n  onSelectDoc,\n}) => {\n  const { darkMode } = useAppContext();\n  const stripRef = useRef<HTMLButtonElement>(null);\n  const [shouldRender, setShouldRender] = useState(isOpen);\n  const [isClosing, setIsClosing] = useState(false);\n  useEffect(() => {\n    if (isOpen) { setShouldRender(true); setIsClosing(false); }\n    else if (shouldRender) {\n      setIsClosing(true);\n      const t = setTimeout(() => { setIsClosing(false); }, 400);\n      return () => clearTimeout(t);\n    }\n  }, [isOpen]);\n  const DEFAULT_WIDTH = 350;\n  const [overlayWidth, setOverlayWidth] = useState(DEFAULT_WIDTH);\n  const isDragging = useRef(false);\n  useEffect(() => { if (isOpen) setOverlayWidth(DEFAULT_WIDTH); }, [isOpen]);\n  const handleResizeStart = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    isDragging.current = true;\n    document.body.style.userSelect = 'none';\n    document.body.style.cursor = 'ew-resize';\n    const overlay = document.createElement('div');\n    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;cursor:ew-resize;';\n    document.body.appendChild(overlay);\n    const startX = e.clientX;\n    const startW = overlayWidth;\n    const onMove = (ev: MouseEvent) => {\n      if (!isDragging.current) return;\n      setOverlayWidth(Math.max(DEFAULT_WIDTH, startW + ev.clientX - startX));\n    };\n    const onUp = () => {\n      isDragging.current = false;\n      document.body.style.userSelect = '';\n      document.body.style.cursor = '';\n      overlay.remove();\n      document.removeEventListener('mousemove', onMove);\n      document.removeEventListener('mouseup', onUp);\n    };\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onUp);\n  }, [overlayWidth]);\n  // Dropdown menu state (shared for project, nugget, and document kebabs)\n  const [menuOpenId, setMenuOpenId] = useState<string | null>(null);\n  const [menuPos, setMenuPos] = useState<{ x: number; y: number }>({ x: 0, y: 0 });\n  const [menuType, setMenuType] = useState<'nugget' | 'project' | 'document'>('nugget');\n  const [menuMode, setMenuMode] = useState<'hover' | 'locked'>('hover');\n  const [confirmDeleteId, setConfirmDeleteId] = useState<string | null>(null);\n  const [confirmDeleteType, setConfirmDeleteType] = useState<'nugget' | 'project'>('nugget');\n  const [renamingId, setRenamingId] = useState<string | null>(null);\n  const [renamingType, setRenamingType] = useState<'nugget' | 'project'>('nugget');\n  const [renameValue, setRenameValue] = useState('');\n  const [renameError, setRenameError] = useState('');\n  // Nugget copy/move hover submenu state\n  const [showCopyMoveSubmenu, setShowCopyMoveSubmenu] = useState(false);\n  const [showDocInfoSubmenu, setShowDocInfoSubmenu] = useState(false);\n  const [noProjectsNuggetId, setNoProjectsNuggetId] = useState<string | null>(null);\n  const [newProjectName, setNewProjectName] = useState('');\n  const menuRef = useRef<HTMLDivElement>(null);\n  const renameInputRef = useRef<HTMLInputElement>(null);\n\n  // ── Nugget expansion state (lifted so it survives panel collapse) ──\n  const [expandedNuggetIds, setExpandedNuggetIds] = useState<Set<string>>(new Set());\n  // Auto-expand the selected nugget and uncollapse its parent project\n  useEffect(() => {\n    if (selectedNuggetId) {\n      setExpandedNuggetIds(prev => {\n        if (prev.has(selectedNuggetId)) return prev;\n        return new Set(prev).add(selectedNuggetId);\n      });\n      const parentProject = projects.find(p => p.nuggetIds.includes(selectedNuggetId));\n      if (parentProject?.isCollapsed) {\n        onToggleProjectCollapse(parentProject.id);\n      }\n    }\n  }, [selectedNuggetId]);\n\n  // ── Document kebab menu state ──\n  const [docRenamingId, setDocRenamingId] = useState<string | null>(null);\n  const [docRenameValue, setDocRenameValue] = useState('');\n  const [docRenameError, setDocRenameError] = useState('');\n  const [confirmRemoveDocId, setConfirmRemoveDocId] = useState<string | null>(null);\n  const [noNuggetsModalDocId, setNoNuggetsModalDocId] = useState<string | null>(null);\n  const [newNuggetName, setNewNuggetName] = useState('');\n  const [docShowCopyMoveSubmenu, setDocShowCopyMoveSubmenu] = useState(false);\n  const docRenameInputRef = useRef<HTMLInputElement>(null);\n  const uploadInputRef = useRef<HTMLInputElement>(null);\n\n  // Close dropdown on outside click (only when locked)\n  useEffect(() => {\n    if (!menuOpenId || menuMode !== 'locked') return;\n    const handleClick = (e: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {\n        setMenuOpenId(null);\n      }\n    };\n    document.addEventListener('mousedown', handleClick);\n    return () => document.removeEventListener('mousedown', handleClick);\n  }, [menuOpenId, menuMode]);\n\n  // Reset copy/move submenus when menu closes\n  useEffect(() => {\n    if (!menuOpenId) {\n      setShowCopyMoveSubmenu(false);\n      setDocShowCopyMoveSubmenu(false);\n      setShowDocInfoSubmenu(false);\n    }\n  }, [menuOpenId]);\n\n  // Focus rename input when entering rename mode\n  useEffect(() => {\n    if (renamingId) {\n      renameInputRef.current?.focus();\n      renameInputRef.current?.select();\n    }\n  }, [renamingId]);\n\n  // Focus document rename input\n  useEffect(() => {\n    if (docRenamingId) {\n      docRenameInputRef.current?.focus();\n      docRenameInputRef.current?.select();\n    }\n  }, [docRenamingId]);\n\n  const commitRename = () => {\n    if (!renamingId || !renameValue.trim()) {\n      setRenamingId(null);\n      setRenameValue('');\n      setRenameError('');\n      return;\n    }\n    const trimmed = renameValue.trim();\n    if (renamingType === 'nugget') {\n      const nugget = nuggets.find(n => n.id === renamingId);\n      if (nugget && trimmed !== nugget.name) {\n        // Check uniqueness within the same project\n        const parentProject = projects.find(p => p.nuggetIds.includes(renamingId));\n        const siblingNames = parentProject\n          ? parentProject.nuggetIds.map(nid => nuggets.find(n => n.id === nid)?.name || '').filter(Boolean)\n          : nuggets.map(n => n.name);\n        if (isNameTaken(trimmed, siblingNames, nugget.name)) {\n          setRenameError('A nugget with this name already exists');\n          return;\n        }\n        onRenameNugget(renamingId, trimmed);\n      }\n    } else {\n      const project = projects.find(p => p.id === renamingId);\n      if (project && trimmed !== project.name) {\n        if (isNameTaken(trimmed, projects.map(p => p.name), project.name)) {\n          setRenameError('A project with this name already exists');\n          return;\n        }\n        onRenameProject(renamingId, trimmed);\n      }\n    }\n    setRenamingId(null);\n    setRenameValue('');\n    setRenameError('');\n  };\n\n  // ── Document rename commit ──\n  const selectedNugget = nuggets.find(n => n.id === selectedNuggetId);\n  const commitDocRename = () => {\n    if (!docRenamingId || !docRenameValue.trim()) {\n      setDocRenamingId(null);\n      setDocRenameValue('');\n      setDocRenameError('');\n      return;\n    }\n    const trimmed = docRenameValue.trim();\n    const renameResult = findDocAcrossNuggets(docRenamingId);\n    if (renameResult) {\n      const currentDoc = renameResult.doc;\n      if (currentDoc && trimmed !== currentDoc.name) {\n        const siblingNames = renameResult.nugget.documents.map(d => d.name);\n        if (isNameTaken(trimmed, siblingNames, currentDoc.name)) {\n          setDocRenameError('A document with this name already exists');\n          return;\n        }\n      }\n    }\n    if (onRenameDocument) onRenameDocument(docRenamingId, trimmed);\n    setDocRenamingId(null);\n    setDocRenameValue('');\n    setDocRenameError('');\n  };\n\n  // Helper: find a document and its parent nugget across all nuggets\n  const findDocAcrossNuggets = (docId: string) => {\n    for (const n of nuggets) {\n      const doc = n.documents?.find(d => d.id === docId);\n      if (doc) return { doc, nugget: n };\n    }\n    return null;\n  };\n\n  // Build a nugget lookup for quick access\n  const nuggetMap = new Map(nuggets.map(n => [n.id, n]));\n\n  return (\n    <>\n    <button\n      ref={stripRef}\n      data-panel-strip\n      onClick={onToggle}\n      className=\"rounded-l-lg shadow-[5px_0_10px_rgba(0,0,0,0.35)] flex flex-col items-center pt-2 pb-1 h-full overflow-hidden shrink-0 w-10 cursor-pointer z-[4] relative\"\n      style={{ backgroundColor: darkMode ? 'rgb(40,52,62)' : 'rgb(217,232,241)' }}\n    >\n      <div className=\"w-8 shrink-0 flex items-center justify-center\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-white\">\n          <path d=\"M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z\"/>\n        </svg>\n      </div>\n      <span className=\"text-[13px] font-bold uppercase tracking-wider text-white mt-2\" style={{ writingMode: 'vertical-lr', transform: 'rotate(180deg)' } as React.CSSProperties}>Projects</span>\n    </button>\n    {/* Hidden file input for document upload */}\n    <input\n      ref={uploadInputRef}\n      type=\"file\"\n      accept=\".md,.pdf\"\n      multiple\n      className=\"hidden\"\n      onChange={(e) => {\n        if (e.target.files?.length) {\n          onUploadDocuments?.(e.target.files);\n          e.target.value = '';\n        }\n      }}\n    />\n\n    {/* Overlay panel — portaled to body */}\n    {shouldRender && createPortal(\n      <div\n        data-panel-overlay\n        className=\"fixed z-[108] flex flex-col bg-white dark:bg-zinc-900 border-4 rounded-r-lg shadow-[5px_0_6px_rgba(0,0,0,0.35)] overflow-hidden\"\n        style={{ borderColor: darkMode ? 'rgb(40,52,62)' : 'rgb(217,232,241)', transformOrigin: 'left',\n          ...(!isOpen && !isClosing\n            ? { display: 'none' }\n            : { animation: `${isClosing ? 'panel-roll-in' : 'panel-roll-out'} 0.4s ease-out forwards` }\n          ),\n          top: stripRef.current?.getBoundingClientRect().top ?? 0,\n          left: stripRef.current?.getBoundingClientRect().right ?? 0,\n          height: stripRef.current?.getBoundingClientRect().height ?? 0,\n          width: overlayWidth,\n        }}\n      >\n        {/* Resize handle */}\n        <div\n          onMouseDown={handleResizeStart}\n          className=\"absolute right-0 top-0 bottom-0 w-1.5 cursor-ew-resize z-10 hover:bg-black/10 transition-colors\"\n        />\n        {/* New Project bar */}\n        <div className=\"shrink-0 border-b border-zinc-100 dark:border-zinc-600\">\n          <button\n            onClick={onCreateProject}\n            className=\"w-full flex items-center gap-1.5 px-3 py-1.5 cursor-pointer transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-800\"\n          >\n            <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 flex-1 min-w-0 text-left\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>New Project</span>\n            <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{projects.length}</span>\n            <span className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center text-zinc-600 dark:text-zinc-400\">\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\n              </svg>\n            </span>\n          </button>\n        </div>\n        <div className=\"flex-1 overflow-y-auto\">\n          <p className=\"text-[9px] text-zinc-400 dark:text-zinc-400 font-light italic px-3 pt-1\">Right-click to view menu</p>\n          <div className=\"px-3 pt-2 pb-3\">\n            {projects.length === 0 ? (\n              <p className=\"text-zinc-500 dark:text-zinc-400 text-[11px] font-light px-2 py-2\">No projects yet</p>\n            ) : (\n              <div className=\"space-y-0\">\n                {projects.map(project => (\n                  <ProjectRow\n                      key={project.id}\n                      project={project}\n                      nuggets={project.nuggetIds.map(id => nuggetMap.get(id)).filter((n): n is Nugget => !!n)}\n                      selectedNuggetId={selectedNuggetId}\n                      isRenaming={renamingId === project.id && renamingType === 'project'}\n                      renameValue={renameValue}\n                      renameError={renamingId === project.id && renamingType === 'project' ? renameError : ''}\n                      renameInputRef={renamingId === project.id && renamingType === 'project' ? renameInputRef : undefined}\n                      onRenameChange={(v) => { setRenameValue(v); setRenameError(''); }}\n                      onRenameCommit={commitRename}\n                      onRenameCancel={() => { setRenamingId(null); setRenameValue(''); setRenameError(''); }}\n                      onToggleCollapse={() => onToggleProjectCollapse(project.id)}\n                      onMenuToggle={(pos: { x: number; y: number }) => {\n                        if (menuOpenId === project.id) { setMenuOpenId(null); }\n                        else { setMenuPos(pos); setMenuType('project'); setMenuMode('locked'); setMenuOpenId(project.id); }\n                      }}\n                      onRename={() => { setMenuOpenId(null); setRenamingId(project.id); setRenamingType('project'); setRenameValue(project.name); }}\n                      onNewNugget={() => { setMenuOpenId(null); onCreateNuggetInProject(project.id); }}\n                      onDelete={() => { setMenuOpenId(null); setConfirmDeleteId(project.id); setConfirmDeleteType('project'); }}\n                      onSelectNugget={(id) => { setExpandedNuggetIds(prev => new Set(prev).add(id)); onSelectNugget(id); }}\n                      isProjectSelected={selectedProjectId === project.id}\n                      selectionLevel={selectionLevel}\n                      onSelectProject={() => onSelectProject(project.id)}\n                      selectedDocId={selectedDocId}\n                      onSelectDoc={(docId: string) => { onSelectDoc?.(docId); }}\n                      onOpenDocument={onOpenDocument}\n                      onOpenCardsPanel={onOpenCardsPanel}\n                      onOpenSourcesPanel={onOpenSourcesPanel}\n                      expandedNuggetIds={expandedNuggetIds}\n                      onToggleNuggetExpand={(nuggetId: string) => setExpandedNuggetIds(prev => {\n                        const next = new Set(prev);\n                        if (next.has(nuggetId)) next.delete(nuggetId); else next.add(nuggetId);\n                        return next;\n                      })}\n                      // Nugget-level actions\n                      nuggetRenamingId={renamingType === 'nugget' ? renamingId : null}\n                      nuggetRenameValue={renameValue}\n                      nuggetRenameError={renamingType === 'nugget' ? renameError : ''}\n                      nuggetRenameInputRef={renamingType === 'nugget' ? renameInputRef : undefined}\n                      onNuggetRenameChange={(v) => { setRenameValue(v); setRenameError(''); }}\n                      onNuggetRenameCommit={commitRename}\n                      onNuggetRenameCancel={() => { setRenamingId(null); setRenameValue(''); setRenameError(''); }}\n                      onNuggetMenuToggle={(nuggetId: string, pos: { x: number; y: number }) => {\n                        if (menuOpenId === nuggetId) { setMenuOpenId(null); }\n                        else { setMenuPos(pos); setMenuType('nugget'); setMenuMode('locked'); setMenuOpenId(nuggetId); }\n                      }}\n                      onNuggetRename={(nuggetId: string) => { setMenuOpenId(null); setRenamingId(nuggetId); setRenamingType('nugget'); setRenameValue(nuggets.find(n => n.id === nuggetId)?.name || ''); }}\n                      onNuggetDelete={(nuggetId: string) => { setMenuOpenId(null); setConfirmDeleteId(nuggetId); setConfirmDeleteType('nugget'); }}\n                      docRenamingId={docRenamingId}\n                      docRenameValue={docRenameValue}\n                      docRenameError={docRenameError}\n                      docRenameInputRef={docRenameInputRef}\n                      onDocRenameChange={(v) => { setDocRenameValue(v); setDocRenameError(''); }}\n                      onDocRenameCommit={commitDocRename}\n                      onDocRenameCancel={() => { setDocRenamingId(null); setDocRenameValue(''); setDocRenameError(''); }}\n                      onDocMenuToggle={(docId: string, pos: { x: number; y: number }) => {\n                        if (menuOpenId === docId) { setMenuOpenId(null); }\n                        else { setMenuPos(pos); setMenuType('document'); setMenuMode('locked'); setMenuOpenId(docId); }\n                      }}\n                    />\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n\n        {/* Footer */}\n        <div className=\"px-3 py-2 shrink-0 flex items-center justify-between\">\n          <p className=\"text-[10px] text-zinc-500 dark:text-zinc-400 font-light\">v4.0</p>\n          <div className=\"w-7 h-7 rounded-full bg-zinc-900 flex items-center justify-center\">\n            <span className=\"text-[9px] font-bold text-white tracking-wide\">YD</span>\n          </div>\n        </div>\n      </div>,\n      document.body\n    )}\n\n      {/* ── Kebab dropdown (project/nugget) — rendered as portal to escape overflow clipping ── */}\n      {menuOpenId && menuType !== 'document' && (() => {\n        const isProjectMenu = menuType === 'project';\n        const nugget = !isProjectMenu ? nuggets.find(n => n.id === menuOpenId) : null;\n        const project = isProjectMenu ? projects.find(p => p.id === menuOpenId) : null;\n        if (!nugget && !project) return null;\n\n        // For nugget copy/move submenu\n        const sourceProject = nugget ? projects.find(p => p.nuggetIds.includes(nugget.id)) : null;\n        const otherProjects = nugget ? projects.filter(p => !p.nuggetIds.includes(nugget.id)) : [];\n\n        return createPortal(\n          <div\n            ref={menuRef}\n            className=\"fixed z-[130] w-36 bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1\"\n            style={{ top: menuPos.y, left: menuPos.x }}\n          >\n            {/* Rename */}\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                const id = menuOpenId;\n                setMenuOpenId(null);\n                if (isProjectMenu && project) { setRenamingId(id); setRenamingType('project'); setRenameValue(project.name); }\n                else if (nugget) { setRenamingId(id); setRenamingType('nugget'); setRenameValue(nugget.name); }\n              }}\n              className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/><path d=\"m15 5 4 4\"/>\n              </svg>\n              {isProjectMenu ? 'Rename Project' : 'Rename Nugget'}\n            </button>\n\n            {/* Project-only: Duplicate Project */}\n            {isProjectMenu && (\n              <button\n                onClick={(e) => { e.stopPropagation(); const id = menuOpenId; setMenuOpenId(null); if (id) onDuplicateProject(id); }}\n                className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                  <rect width=\"14\" height=\"14\" x=\"8\" y=\"8\" rx=\"2\" ry=\"2\"/><path d=\"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2\"/>\n                </svg>\n                Duplicate Project\n              </button>\n            )}\n\n            {/* Project-only: New Nugget */}\n            {isProjectMenu && (\n              <button\n                onClick={(e) => { e.stopPropagation(); setMenuOpenId(null); if (project) onCreateNuggetInProject(project.id); }}\n                className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                  <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\n                </svg>\n                New Nugget\n              </button>\n            )}\n\n            {/* Nugget-only: Move / Copy — hover submenu */}\n            {!isProjectMenu && nugget && (\n              <div\n                className=\"relative\"\n                onMouseEnter={() => setShowCopyMoveSubmenu(true)}\n                onMouseLeave={() => setShowCopyMoveSubmenu(false)}\n              >\n                <button\n                  className=\"w-full flex items-center justify-between px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                >\n                  <span className=\"flex items-center gap-2.5\">\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                      <path d=\"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4\" /><polyline points=\"10 17 15 12 10 7\" /><line x1=\"15\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                    </svg>\n                    Move/Copy\n                  </span>\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                    <polyline points=\"9 18 15 12 9 6\" />\n                  </svg>\n                </button>\n\n                {/* Project list submenu */}\n                {showCopyMoveSubmenu && (\n                  <div\n                    className=\"absolute left-full top-0 mt-4 ml-1 w-[220px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 z-[140]\"\n                  >\n                    <div className=\"px-3 pb-1 border-b border-zinc-100 dark:border-zinc-600 mb-1\">\n                      <span className=\"text-[10px] font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400\">Move/Copy to</span>\n                    </div>\n                    <div className=\"max-h-[200px] overflow-y-auto\" style={{ scrollbarWidth: 'thin' }}>\n                      {/* Same project — Duplicate option */}\n                      {sourceProject && (\n                        <div className=\"px-2 py-1 flex items-center gap-1.5 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg mx-1 group\">\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-amber-500 shrink-0\">\n                            <path d=\"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z\" />\n                          </svg>\n                          <span className=\"flex-1 text-[11px] text-amber-600 font-medium truncate\" title={sourceProject.name}>{sourceProject.name}</span>\n                          <div className=\"flex items-center gap-0.5 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\">\n                            <button\n                              onClick={() => { const nid = menuOpenId!; setMenuOpenId(null); onCopyNuggetToProject(nid, sourceProject.id); }}\n                              className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-amber-600 bg-amber-50 hover:bg-amber-100 hover:text-amber-700 rounded transition-colors\"\n                            >Duplicate</button>\n                          </div>\n                        </div>\n                      )}\n                      {/* Other projects — Copy / Move options */}\n                      {otherProjects.map(p => (\n                        <div key={p.id} className=\"px-2 py-1 flex items-center gap-1.5 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg mx-1 group\">\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400 shrink-0\">\n                            <path d=\"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z\" />\n                          </svg>\n                          <span className=\"flex-1 text-[11px] text-black truncate\" title={p.name}>{p.name}</span>\n                          <div className=\"flex items-center gap-0.5 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\">\n                            <button\n                              onClick={() => { const nid = menuOpenId!; setMenuOpenId(null); onCopyNuggetToProject(nid, p.id); }}\n                              className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                            >Copy</button>\n                            <button\n                              onClick={() => { if (!sourceProject) return; const nid = menuOpenId!; setMenuOpenId(null); onMoveNuggetToProject(nid, sourceProject.id, p.id); }}\n                              className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                            >Move</button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Nugget-only: Upload Document (only for selected nugget) */}\n            {!isProjectMenu && nugget && nugget.id === selectedNuggetId && onUploadDocuments && (\n              <button\n                onClick={(e) => {\n                  e.stopPropagation();\n                  setMenuOpenId(null);\n                  uploadInputRef.current?.click();\n                }}\n                className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                  <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\" /><polyline points=\"17 8 12 3 7 8\" /><line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\" />\n                </svg>\n                Upload Document\n              </button>\n            )}\n\n            {/* Nugget-only: Subject */}\n            {!isProjectMenu && nugget && onEditSubject && (\n              <button\n                onClick={(e) => {\n                  e.stopPropagation();\n                  const nid = menuOpenId!;\n                  setMenuOpenId(null);\n                  onEditSubject(nid);\n                }}\n                className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                  <circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M12 16v-4\"/><path d=\"M12 8h.01\"/>\n                </svg>\n                Subject\n              </button>\n            )}\n\n            <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n            {/* Remove */}\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                const id = menuOpenId;\n                setMenuOpenId(null);\n                setConfirmDeleteId(id);\n                setConfirmDeleteType(isProjectMenu ? 'project' : 'nugget');\n              }}\n              className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-red-600 hover:bg-red-50 transition-colors\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n              {isProjectMenu ? 'Remove Project' : 'Remove Nugget'}\n            </button>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* ── Document kebab dropdown — rendered as portal ── */}\n      {menuOpenId && menuType === 'document' && (() => {\n        // Find the doc across all nuggets\n        const found = findDocAcrossNuggets(menuOpenId);\n        if (!found) return null;\n        const doc = found.doc;\n\n        return createPortal(\n          <div\n            ref={menuRef}\n            className=\"fixed z-[130] w-36 bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1\"\n            style={{ top: menuPos.y, left: menuPos.x }}\n          >\n            {/* Document Info — click submenu */}\n            <div className=\"relative\">\n              <button\n                onClick={() => setShowDocInfoSubmenu(prev => !prev)}\n                className=\"w-full flex items-center justify-between px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n              >\n                <span className=\"flex items-center gap-2.5\">\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                    <circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M12 16v-4\"/><path d=\"M12 8h.01\"/>\n                  </svg>\n                  Document Info\n                </span>\n                <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-400\">\n                  <polyline points=\"9 18 15 12 9 6\" />\n                </svg>\n              </button>\n              {showDocInfoSubmenu && (\n                <div className=\"absolute left-full top-0 ml-1 w-64 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-600 rounded-lg shadow-lg z-[140] dark:shadow-black/30 max-h-[400px] overflow-y-auto\">\n                  <DocumentInfoContent doc={doc} enabled={doc.enabled !== false} />\n                </div>\n              )}\n            </div>\n            <div className=\"border-t border-zinc-200 my-0.5\" />\n\n            {/* Open */}\n            {onOpenDocument && (\n              <button\n                onClick={(e) => {\n                  e.stopPropagation();\n                  setMenuOpenId(null);\n                  onOpenDocument(doc.id);\n                }}\n                className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n              >\n                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                  <path d=\"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z\"/><path d=\"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z\"/>\n                </svg>\n                Open\n              </button>\n            )}\n\n            {/* Rename */}\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                setMenuOpenId(null);\n                setDocRenamingId(doc.id);\n                setDocRenameValue(doc.name);\n              }}\n              className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/>\n              </svg>\n              Rename\n            </button>\n\n            {/* Copy/Move — hover submenu */}\n            {onCopyMoveDocument && (\n              <div\n                className=\"relative\"\n                onMouseEnter={() => setDocShowCopyMoveSubmenu(true)}\n                onMouseLeave={() => setDocShowCopyMoveSubmenu(false)}\n              >\n                <button\n                  onClick={() => {\n                    if (!otherNuggets || otherNuggets.length === 0) {\n                      setNoNuggetsModalDocId(menuOpenId);\n                      setMenuOpenId(null);\n                    }\n                  }}\n                  className=\"w-full flex items-center justify-between px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n                >\n                  <span className=\"flex items-center gap-2.5\">\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                      <path d=\"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4\" /><polyline points=\"10 17 15 12 10 7\" /><line x1=\"15\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                    </svg>\n                    Copy/Move\n                  </span>\n                  {otherNuggets && otherNuggets.length > 0 && (\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                      <polyline points=\"9 18 15 12 9 6\" />\n                    </svg>\n                  )}\n                </button>\n\n                {/* Nugget list submenu */}\n                {docShowCopyMoveSubmenu && otherNuggets && otherNuggets.length > 0 && (\n                  <div className=\"absolute left-full top-0 -ml-1 w-[220px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-600 py-1 z-[140]\">\n                    <div className=\"px-3 pb-1 border-b border-zinc-100 dark:border-zinc-600 mb-1\">\n                      <span className=\"text-[10px] font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400\">Copy/Move to nugget</span>\n                    </div>\n                    <div className=\"max-h-[200px] overflow-y-auto\" style={{ scrollbarWidth: 'thin' }}>\n                      {projectNuggets && projectNuggets.length > 0 ? (\n                        projectNuggets.map(pg => (\n                          <div key={pg.projectId}>\n                            <div className=\"px-3 pt-1.5 pb-0.5 flex items-center gap-1.5\">\n                              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400 shrink-0\">\n                                <path d=\"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z\" />\n                              </svg>\n                              <span className=\"text-[9px] font-semibold text-zinc-500 dark:text-zinc-400 truncate\">{pg.projectName}</span>\n                            </div>\n                            {pg.nuggets.length === 0 ? (\n                              <p className=\"text-zinc-500 dark:text-zinc-400 text-[9px] font-light pl-6 pr-2 py-0.5 italic\">No other nuggets</p>\n                            ) : (\n                              pg.nuggets.map(n => (\n                                <div key={n.id} className=\"pl-5 pr-2 py-1 flex items-center gap-1.5 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg mx-1 group\">\n                                  <div className=\"w-1.5 h-1.5 rounded-full bg-zinc-400 shrink-0\" />\n                                  <span className=\"flex-1 text-[11px] text-black truncate\" title={n.name}>{n.name}</span>\n                                  <div className=\"flex items-center gap-0.5 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\">\n                                    <button\n                                      onClick={() => { const dId = menuOpenId!; setMenuOpenId(null); onCopyMoveDocument(dId, n.id, 'copy'); }}\n                                      className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                                    >Copy</button>\n                                    <button\n                                      onClick={() => { const dId = menuOpenId!; setMenuOpenId(null); onCopyMoveDocument(dId, n.id, 'move'); }}\n                                      className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                                    >Move</button>\n                                  </div>\n                                </div>\n                              ))\n                            )}\n                          </div>\n                        ))\n                      ) : (\n                        otherNuggets.map(n => (\n                          <div key={n.id} className=\"px-2 py-1 flex items-center gap-1.5 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg mx-1 group\">\n                            <div className=\"w-1.5 h-1.5 rounded-full bg-zinc-400 shrink-0\" />\n                            <span className=\"flex-1 text-[11px] text-black truncate\" title={n.name}>{n.name}</span>\n                            <div className=\"flex items-center gap-0.5 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\">\n                              <button\n                                onClick={() => { const dId = menuOpenId!; setMenuOpenId(null); onCopyMoveDocument(dId, n.id, 'copy'); }}\n                                className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                              >Copy</button>\n                              <button\n                                onClick={() => { const dId = menuOpenId!; setMenuOpenId(null); onCopyMoveDocument(dId, n.id, 'move'); }}\n                                className=\"px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50 hover:bg-zinc-200 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 rounded transition-colors\"\n                              >Move</button>\n                            </div>\n                          </div>\n                        ))\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Download */}\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                setMenuOpenId(null);\n                if (doc.content) {\n                  const blob = new Blob([doc.content], { type: 'text/markdown' });\n                  const url = URL.createObjectURL(blob);\n                  const a = Object.assign(document.createElement('a'), { href: url, download: `${doc.name.replace(/\\.[^.]+$/, '')}.md` });\n                  document.body.appendChild(a);\n                  a.click();\n                  document.body.removeChild(a);\n                  URL.revokeObjectURL(url);\n                }\n              }}\n              className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\" /><polyline points=\"7 10 12 15 17 10\" /><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\" />\n              </svg>\n              Download\n            </button>\n\n            <div className=\"border-t border-zinc-100 dark:border-zinc-600\" />\n\n            {/* Remove */}\n            <button\n              onClick={(e) => {\n                e.stopPropagation();\n                setMenuOpenId(null);\n                setConfirmRemoveDocId(doc.id);\n              }}\n              className=\"w-full flex items-center gap-2.5 px-3 py-1.5 text-[11px] text-red-600 hover:bg-red-50 transition-colors\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n              Remove\n            </button>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* ── No other projects — create-project modal ── */}\n      {noProjectsNuggetId && (() => {\n        const sourceProject = projects.find(p => p.nuggetIds.includes(noProjectsNuggetId));\n        return createPortal(\n          <div className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\" onClick={() => { setNoProjectsNuggetId(null); setNewProjectName(''); }}>\n            <div className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\" style={{ minWidth: 300, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }} onClick={(e) => e.stopPropagation()}>\n              <div className=\"px-6 pt-6 pb-3 text-center\">\n                <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <path d=\"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4\" /><polyline points=\"10 17 15 12 10 7\" /><line x1=\"15\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">No Other Projects</h3>\n                <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-1\">Create a new project to move or copy this nugget to.</p>\n                <input type=\"text\" value={newProjectName} onChange={(e) => setNewProjectName(e.target.value)}\n                  onKeyDown={(e) => { if (e.key === 'Enter' && newProjectName.trim() && sourceProject && !isNameTaken(newProjectName.trim(), projects.map(p => p.name))) { const nid = noProjectsNuggetId; setNoProjectsNuggetId(null); setNewProjectName(''); onCreateProjectForNugget(nid, newProjectName.trim(), 'move', sourceProject.id); } }}\n                  placeholder=\"Project name\" autoFocus className={`mt-3 w-full px-3 py-2 text-xs border rounded-lg focus:outline-none focus:ring-2 focus:ring-zinc-300 transition-all text-zinc-800 dark:text-zinc-200 placeholder:text-zinc-500 ${isNameTaken(newProjectName.trim(), projects.map(p => p.name)) ? 'border-red-300 focus:border-red-400' : 'border-zinc-200 dark:border-zinc-600 focus:border-zinc-400'}`} />\n                {isNameTaken(newProjectName.trim(), projects.map(p => p.name)) && (\n                  <p className=\"text-[10px] text-red-500 mt-1\">A project with this name already exists</p>\n                )}\n              </div>\n              <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n                {(() => {\n                  const nameConflict = isNameTaken(newProjectName.trim(), projects.map(p => p.name));\n                  const canSubmit = !!newProjectName.trim() && !nameConflict;\n                  return (\n                    <>\n                      <button onClick={() => { setNoProjectsNuggetId(null); setNewProjectName(''); }} className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\">Cancel</button>\n                      <button onClick={() => { if (!canSubmit || !sourceProject) return; const nid = noProjectsNuggetId; setNoProjectsNuggetId(null); setNewProjectName(''); onCreateProjectForNugget(nid, newProjectName.trim(), 'copy', sourceProject.id); }} disabled={!canSubmit} className={`px-4 py-2 text-xs font-medium rounded-lg transition-colors ${canSubmit ? 'bg-zinc-100 dark:bg-zinc-800/50 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700' : 'bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'}`}>Copy</button>\n                      <button onClick={() => { if (!canSubmit || !sourceProject) return; const nid = noProjectsNuggetId; setNoProjectsNuggetId(null); setNewProjectName(''); onCreateProjectForNugget(nid, newProjectName.trim(), 'move', sourceProject.id); }} disabled={!canSubmit} className={`px-4 py-2 text-xs font-medium rounded-lg transition-colors ${canSubmit ? 'bg-zinc-900 text-white hover:bg-zinc-800' : 'bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'}`}>Move</button>\n                    </>\n                  );\n                })()}\n              </div>\n            </div>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* Delete confirmation modal — centered, dimmed background */}\n      {confirmDeleteId && (() => {\n        const isProject = confirmDeleteType === 'project';\n        const item = isProject\n          ? projects.find(p => p.id === confirmDeleteId)\n          : nuggets.find(n => n.id === confirmDeleteId);\n        if (!item) return null;\n        const projectNuggetCount = isProject\n          ? (item as Project).nuggetIds.length\n          : 0;\n        return createPortal(\n          <div\n            className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n            onClick={() => setConfirmDeleteId(null)}\n          >\n            <div\n              className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\"\n              style={{ minWidth: 260, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }}\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"px-6 pt-6 pb-3 text-center\">\n                <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <path d=\"M3 6h18\" /><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\" /><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">\n                  Delete {isProject ? 'Project' : 'Nugget'}\n                </h3>\n                <p className=\"text-xs font-medium text-zinc-600 dark:text-zinc-400 whitespace-nowrap\">{item.name}</p>\n                {isProject && projectNuggetCount > 0 && (\n                  <p className=\"text-[12px] text-amber-600 mt-2\">\n                    This will also delete {projectNuggetCount} nugget{projectNuggetCount > 1 ? 's' : ''}.\n                  </p>\n                )}\n                <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-2\">This cannot be undone.</p>\n              </div>\n              <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n                <button\n                  onClick={() => setConfirmDeleteId(null)}\n                  className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={() => {\n                    setConfirmDeleteId(null);\n                    if (isProject) onDeleteProject(confirmDeleteId);\n                    else onDeleteNugget(confirmDeleteId);\n                  }}\n                  className=\"px-4 py-2 bg-zinc-900 text-white text-xs font-medium rounded-lg hover:bg-zinc-800 transition-colors\"\n                >\n                  Delete\n                </button>\n              </div>\n            </div>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* ── Document remove confirmation modal ── */}\n      {confirmRemoveDocId && (() => {\n        const found = findDocAcrossNuggets(confirmRemoveDocId);\n        if (!found) return null;\n        const doc = found.doc;\n        return createPortal(\n          <div\n            className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n            onClick={() => setConfirmRemoveDocId(null)}\n          >\n            <div\n              className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\"\n              style={{ minWidth: 260, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }}\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"px-6 pt-6 pb-3 text-center\">\n                <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                    <path d=\"M3 6h18\" /><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\" /><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">Remove Document</h3>\n                <p className=\"text-xs font-medium text-zinc-600 dark:text-zinc-400 whitespace-nowrap\">{doc.name}</p>\n                <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-2\">This cannot be undone.</p>\n              </div>\n              <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n                <button\n                  onClick={() => setConfirmRemoveDocId(null)}\n                  className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={() => { setConfirmRemoveDocId(null); onRemoveDocument?.(doc.id); }}\n                  className=\"px-4 py-2 bg-zinc-900 text-white text-xs font-medium rounded-lg hover:bg-zinc-800 transition-colors\"\n                >\n                  Remove\n                </button>\n              </div>\n            </div>\n          </div>,\n          document.body\n        );\n      })()}\n\n      {/* ── No other nuggets — create-nugget-with-doc modal ── */}\n      {noNuggetsModalDocId && onCreateNuggetWithDoc && createPortal(\n        <div\n          className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n          onClick={() => { setNoNuggetsModalDocId(null); setNewNuggetName(''); }}\n        >\n          <div\n            className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl dark:shadow-black/30 mx-4 overflow-hidden\"\n            style={{ minWidth: 300, maxWidth: 'calc(100vw - 32px)', width: 'fit-content' }}\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"px-6 pt-6 pb-3 text-center\">\n              <div className=\"w-9 h-9 rounded-full bg-zinc-100 dark:bg-zinc-800/50 flex items-center justify-center mx-auto mb-3\">\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" className=\"text-zinc-500 dark:text-zinc-400\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <path d=\"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4\" /><polyline points=\"10 17 15 12 10 7\" /><line x1=\"15\" y1=\"12\" x2=\"3\" y2=\"12\" />\n                </svg>\n              </div>\n              <h3 className=\"text-xs font-semibold text-zinc-800 dark:text-zinc-200 tracking-tight mb-1\">No Other Nuggets</h3>\n              <p className=\"text-[12px] text-zinc-500 dark:text-zinc-400 mt-1\">Create a new nugget to copy this document to.</p>\n              {(() => {\n                const allNuggetNames = (otherNuggets || []).map(n => n.name);\n                const nameConflict = isNameTaken(newNuggetName.trim(), allNuggetNames);\n                return (\n                  <>\n                    <input\n                      type=\"text\"\n                      value={newNuggetName}\n                      onChange={(e) => setNewNuggetName(e.target.value)}\n                      onKeyDown={(e) => {\n                        if (e.key === 'Enter' && newNuggetName.trim() && !nameConflict) {\n                          const docId = noNuggetsModalDocId;\n                          setNoNuggetsModalDocId(null);\n                          setNewNuggetName('');\n                          onCreateNuggetWithDoc(newNuggetName.trim(), docId);\n                        }\n                      }}\n                      placeholder=\"Nugget name\"\n                      autoFocus\n                      className={`mt-3 w-full px-3 py-2 text-xs border rounded-lg focus:outline-none focus:ring-2 focus:ring-zinc-300 transition-all text-zinc-800 dark:text-zinc-200 placeholder:text-zinc-500 ${nameConflict ? 'border-red-300 focus:border-red-400' : 'border-zinc-200 dark:border-zinc-600 focus:border-zinc-400'}`}\n                    />\n                    {nameConflict && <p className=\"text-[10px] text-red-500 mt-1\">A nugget with this name already exists</p>}\n                  </>\n                );\n              })()}\n            </div>\n            <div className=\"px-6 pb-5 pt-1 flex items-center justify-center gap-2\">\n              <button\n                onClick={() => { setNoNuggetsModalDocId(null); setNewNuggetName(''); }}\n                className=\"px-4 py-2 text-xs font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded-lg transition-colors\"\n              >\n                Cancel\n              </button>\n              {(() => {\n                const nameConflict = isNameTaken(newNuggetName.trim(), (otherNuggets || []).map(n => n.name));\n                const canCreate = !!newNuggetName.trim() && !nameConflict;\n                return (\n                  <button\n                    onClick={() => {\n                      if (!canCreate) return;\n                      const docId = noNuggetsModalDocId;\n                      setNoNuggetsModalDocId(null);\n                      setNewNuggetName('');\n                      onCreateNuggetWithDoc(newNuggetName.trim(), docId);\n                    }}\n                    disabled={!canCreate}\n                    className={`px-4 py-2 text-xs font-medium rounded-lg transition-colors ${\n                      canCreate\n                        ? 'bg-zinc-900 text-white hover:bg-zinc-800'\n                        : 'bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'\n                    }`}\n                  >\n                    New Nugget\n                  </button>\n                );\n              })()}\n            </div>\n          </div>\n        </div>,\n        document.body\n      )}\n    </>\n  );\n};\n\n// ── Project row sub-component ──\n\ninterface ProjectRowProps {\n  project: Project;\n  nuggets: Nugget[];\n  selectedNuggetId: string | null;\n  isRenaming: boolean;\n  renameValue: string;\n  renameError: string;\n  renameInputRef?: React.RefObject<HTMLInputElement | null>;\n  onRenameChange: (value: string) => void;\n  onRenameCommit: () => void;\n  onRenameCancel: () => void;\n  onToggleCollapse: () => void;\n  onMenuToggle: (pos: { x: number; y: number }) => void;\n  onRename: () => void;\n  onNewNugget: () => void;\n  onDelete: () => void;\n  onSelectNugget: (id: string) => void;\n  isProjectSelected: boolean;\n  selectionLevel: 'project' | 'nugget' | 'document' | null;\n  onSelectProject: () => void;\n  selectedDocId: string | null;\n  onSelectDoc: (docId: string) => void;\n  onOpenDocument?: (docId: string) => void;\n  onOpenCardsPanel?: () => void;\n  onOpenSourcesPanel?: () => void;\n  expandedNuggetIds: Set<string>;\n  onToggleNuggetExpand: (nuggetId: string) => void;\n  // Nugget-level props (passed through)\n  nuggetRenamingId: string | null;\n  nuggetRenameValue: string;\n  nuggetRenameError: string;\n  nuggetRenameInputRef?: React.RefObject<HTMLInputElement | null>;\n  onNuggetRenameChange: (value: string) => void;\n  onNuggetRenameCommit: () => void;\n  onNuggetRenameCancel: () => void;\n  onNuggetMenuToggle: (nuggetId: string, pos: { x: number; y: number }) => void;\n  onNuggetRename: (nuggetId: string) => void;\n  onNuggetDelete: (nuggetId: string) => void;\n  // Document kebab menu props (passed through to NuggetRow)\n  docRenamingId: string | null;\n  docRenameValue: string;\n  docRenameError: string;\n  docRenameInputRef?: React.RefObject<HTMLInputElement | null>;\n  onDocRenameChange: (value: string) => void;\n  onDocRenameCommit: () => void;\n  onDocRenameCancel: () => void;\n  onDocMenuToggle: (docId: string, pos: { x: number; y: number }) => void;\n}\n\nconst ProjectRow: React.FC<ProjectRowProps> = ({\n  project, nuggets, selectedNuggetId,\n  isRenaming, renameValue, renameError, renameInputRef, onRenameChange, onRenameCommit, onRenameCancel,\n  onToggleCollapse, onMenuToggle, onRename, onNewNugget, onDelete,\n  onSelectNugget, isProjectSelected, selectionLevel, onSelectProject, selectedDocId, onSelectDoc, onOpenDocument, onOpenCardsPanel, onOpenSourcesPanel, expandedNuggetIds, onToggleNuggetExpand,\n  nuggetRenamingId, nuggetRenameValue, nuggetRenameError, nuggetRenameInputRef,\n  onNuggetRenameChange, onNuggetRenameCommit, onNuggetRenameCancel,\n  onNuggetMenuToggle, onNuggetRename, onNuggetDelete,\n  docRenamingId, docRenameValue, docRenameError, docRenameInputRef,\n  onDocRenameChange, onDocRenameCommit, onDocRenameCancel,\n  onDocMenuToggle,\n}) => {\n  const isPrimaryProject = isProjectSelected && selectionLevel === 'project';\n  const clickedDocId = selectionLevel === 'document' ? selectedDocId : null;\n\n  return (\n  <div>\n    {/* Project header row — table-of-contents style */}\n    <div\n      className={`group flex items-center gap-1 px-1.5 py-1 cursor-pointer select-none transition-colors duration-150 border border-transparent ${isPrimaryProject ? '' : 'hover:border-blue-300'}`}\n      style={\n        isPrimaryProject\n          ? { backgroundColor: 'rgb(50,90,130)', borderRadius: 4 }\n          : undefined\n      }\n      onClick={() => {\n        if (isRenaming) return;\n        onSelectProject();\n      }}\n    >\n      {/* Collapse chevron — only if project has nuggets */}\n      {nuggets.length > 0 ? (\n        <button\n          onClick={(e) => { e.stopPropagation(); onToggleCollapse(); }}\n          className=\"w-4 h-4 flex items-center justify-center shrink-0\" style={{ color: isPrimaryProject ? 'white' : isProjectSelected ? 'var(--tree-icon)' : 'var(--tree-icon-dim)' }}\n        >\n          <ChevronIcon isCollapsed={!!project.isCollapsed} />\n        </button>\n      ) : (\n        <span className=\"w-4 h-4 shrink-0\" />\n      )}\n\n      {/* Folder icon */}\n      <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\" style={{ color: isPrimaryProject ? 'white' : isProjectSelected ? 'var(--tree-text)' : 'var(--tree-text-dim)' }}>\n        <path d=\"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z\" />\n      </svg>\n\n      {/* Project name */}\n      <div className=\"flex-1 min-w-0\">\n        {isRenaming ? (\n          <div>\n            <input\n              ref={renameInputRef}\n              value={renameValue}\n              onChange={(e) => onRenameChange(e.target.value)}\n              onBlur={onRenameCommit}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter') onRenameCommit();\n                if (e.key === 'Escape') onRenameCancel();\n              }}\n              onClick={(e) => e.stopPropagation()}\n              className={`w-full text-[11px] font-semibold text-zinc-800 dark:text-zinc-200 bg-white dark:bg-zinc-900 border rounded px-1.5 py-0.5 outline-none ${renameError ? 'border-red-400 focus:border-red-400' : 'border-zinc-300 dark:border-zinc-600 focus:border-zinc-400'}`}\n            />\n            {renameError && <p className=\"text-[9px] text-red-500 mt-0.5\">{renameError}</p>}\n          </div>\n        ) : (\n          <p className=\"text-[11px] font-semibold truncate\" style={{ color: isPrimaryProject ? 'white' : isProjectSelected ? 'var(--tree-text)' : 'var(--tree-text-dim)' }} title={project.name}>{project.name}</p>\n        )}\n      </div>\n\n      {/* Kebab menu button */}\n      {!isRenaming && (\n        <button\n          onClick={(e) => { e.stopPropagation(); onMenuToggle({ x: e.clientX, y: e.clientY }); }}\n          className=\"shrink-0 w-5 h-5 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity hover:text-zinc-600\"\n          style={{ color: isPrimaryProject ? 'rgba(255,255,255,0.7)' : 'rgba(100,116,139,0.5)' }}\n        >\n          <EllipsisIcon />\n        </button>\n      )}\n\n    </div>\n\n    {/* Nuggets list (indented) */}\n    {!project.isCollapsed && (\n      <div className=\"ml-3 pl-2 border-l\" style={{ borderColor: 'var(--tree-icon-dim)' }}>\n        {nuggets.length === 0 ? (\n          <p className=\"text-[10px] font-light px-2 py-1.5 italic\" style={{ color: 'var(--tree-icon-dim)' }}>No nuggets</p>\n        ) : (\n          <div className=\"space-y-0\">\n            {nuggets.map(nugget => (\n              <NuggetRow\n                key={nugget.id}\n                nugget={nugget}\n                isSelected={selectedNuggetId === nugget.id && selectionLevel === 'nugget'}\n                isInSelectedProject={isProjectSelected}\n                clickedDocId={clickedDocId}\n                isRenaming={nuggetRenamingId === nugget.id}\n                renameValue={nuggetRenameValue}\n                renameError={nuggetRenamingId === nugget.id ? nuggetRenameError : ''}\n                renameInputRef={nuggetRenamingId === nugget.id ? nuggetRenameInputRef : undefined}\n                onRenameChange={onNuggetRenameChange}\n                onRenameCommit={onNuggetRenameCommit}\n                onRenameCancel={onNuggetRenameCancel}\n                onSelect={() => onSelectNugget(nugget.id)}\n                onMenuToggle={(pos: { x: number; y: number }) => onNuggetMenuToggle(nugget.id, pos)}\n                docRenamingId={docRenamingId}\n                docRenameValue={docRenameValue}\n                docRenameError={docRenameError}\n                docRenameInputRef={docRenamingId && nugget.documents?.some(d => d.id === docRenamingId) ? docRenameInputRef : undefined}\n                onDocRenameChange={onDocRenameChange}\n                onDocRenameCommit={onDocRenameCommit}\n                onDocRenameCancel={onDocRenameCancel}\n                onDocMenuToggle={onDocMenuToggle}\n                onOpenDocument={onOpenDocument}\n                selectedDocId={selectedDocId}\n                onSelectDoc={onSelectDoc}\n                onOpenCardsPanel={onOpenCardsPanel}\n                onOpenSourcesPanel={onOpenSourcesPanel}\n                isExpanded={expandedNuggetIds.has(nugget.id)}\n                onToggleExpand={() => onToggleNuggetExpand(nugget.id)}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n    )}\n  </div>\n  );\n};\n\n// ── Nugget row sub-component ──\n\ninterface NuggetRowProps {\n  nugget: Nugget;\n  isSelected: boolean;\n  isInSelectedProject: boolean;\n  clickedDocId: string | null;\n  isRenaming: boolean;\n  renameValue: string;\n  renameError: string;\n  renameInputRef?: React.RefObject<HTMLInputElement | null>;\n  onRenameChange: (value: string) => void;\n  onRenameCommit: () => void;\n  onRenameCancel: () => void;\n  onSelect: () => void;\n  onMenuToggle: (pos: { x: number; y: number }) => void;\n  // Document kebab menu props (only active when isSelected)\n  docRenamingId: string | null;\n  docRenameValue: string;\n  docRenameError: string;\n  docRenameInputRef?: React.RefObject<HTMLInputElement | null>;\n  onDocRenameChange: (value: string) => void;\n  onDocRenameCommit: () => void;\n  onDocRenameCancel: () => void;\n  onDocMenuToggle: (docId: string, pos: { x: number; y: number }) => void;\n  onOpenDocument?: (docId: string) => void;\n  selectedDocId: string | null;\n  onSelectDoc: (docId: string) => void;\n  onOpenCardsPanel?: () => void;\n  onOpenSourcesPanel?: () => void;\n  isExpanded: boolean;\n  onToggleExpand: () => void;\n}\n\nconst NuggetRow: React.FC<NuggetRowProps> = ({\n  nugget, isSelected, isInSelectedProject, clickedDocId,\n  isRenaming, renameValue, renameError, renameInputRef, onRenameChange, onRenameCommit, onRenameCancel,\n  onSelect, onMenuToggle,\n  docRenamingId, docRenameValue, docRenameError, docRenameInputRef,\n  onDocRenameChange, onDocRenameCommit, onDocRenameCancel,\n  onDocMenuToggle, onOpenDocument, selectedDocId, onSelectDoc, onOpenCardsPanel, onOpenSourcesPanel,\n  isExpanded, onToggleExpand,\n}) => {\n  const docCount = nugget.documents?.length ?? 0;\n  return (\n  <div>\n    <div\n      onClick={() => {\n        if (isRenaming) return;\n        onSelect();\n      }}\n      onDoubleClick={() => {\n        if (isRenaming) return;\n        onSelect();\n        onOpenCardsPanel?.();\n      }}\n      className={`group relative flex items-center gap-1 px-1.5 py-1 cursor-pointer select-none transition-all duration-150 ${\n        isSelected ? 'sidebar-node-active' : 'border border-transparent hover:border-blue-300'\n      }`}\n    >\n      {/* Expand/collapse chevron — only if nugget has docs */}\n      {docCount > 0 ? (\n        <button\n          onClick={(e) => { e.stopPropagation(); onToggleExpand(); }}\n          className=\"w-4 h-4 flex items-center justify-center shrink-0\" style={{ color: isSelected ? 'var(--tree-icon)' : isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)' }}\n        >\n          <ChevronIcon isCollapsed={!isExpanded} />\n        </button>\n      ) : (\n        <span className=\"w-4 h-4 shrink-0\" />\n      )}\n\n      <div className=\"flex-1 min-w-0 flex items-center gap-1\">\n        {isRenaming ? (\n          <div className=\"flex-1 min-w-0\">\n            <input\n              ref={renameInputRef}\n              value={renameValue}\n              onChange={(e) => onRenameChange(e.target.value)}\n              onBlur={onRenameCommit}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter') onRenameCommit();\n                if (e.key === 'Escape') onRenameCancel();\n              }}\n              onClick={(e) => e.stopPropagation()}\n              className={`w-full text-[11px] font-medium text-zinc-800 dark:text-zinc-200 bg-white dark:bg-zinc-900 border rounded px-1.5 py-0.5 outline-none ${renameError ? 'border-red-400 focus:border-red-400' : 'border-zinc-300 dark:border-zinc-600 focus:border-zinc-400'}`}\n            />\n            {renameError && <p className=\"text-[9px] text-red-500 mt-0.5\">{renameError}</p>}\n          </div>\n        ) : (\n          <>\n            <p className={`text-[11px] truncate ${isSelected ? 'font-medium' : 'font-normal'}`} style={{ color: isSelected ? 'var(--tree-active)' : isInSelectedProject ? 'var(--tree-text)' : 'var(--tree-text-dim)' }} title={nugget.name}>\n              {nugget.name}\n            </p>\n            {docCount > 0 && <span className=\"shrink-0 text-[10px] font-normal\" style={{ color: isSelected ? 'var(--tree-icon)' : isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)' }}>{docCount}</span>}\n          </>\n        )}\n      </div>\n\n      {/* Kebab menu button */}\n      {!isRenaming && (\n        <button\n          onClick={(e) => { e.stopPropagation(); onMenuToggle({ x: e.clientX, y: e.clientY }); }}\n          className=\"shrink-0 w-5 h-5 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity\"\n          style={{ color: isSelected ? 'var(--tree-icon)' : isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)' }}\n        >\n          <EllipsisIcon />\n        </button>\n      )}\n\n    </div>\n\n    {/* Documents list */}\n    {isExpanded && docCount > 0 && (\n      <div className=\"ml-3 pl-2 border-l\" style={{ borderColor: 'var(--tree-icon-dim)' }}>\n        {nugget.documents.map(doc => {\n          const isDocRenaming = docRenamingId === doc.id;\n          const isThisDocSelected = clickedDocId === doc.id;\n          return (\n            <div key={doc.id}\n              className={`group flex items-center gap-1.5 px-1.5 py-0.5 select-none transition-colors duration-150 cursor-pointer ${\n                isThisDocSelected ? 'sidebar-node-active' : 'border border-transparent hover:border-blue-300'\n              }`}\n            >\n              {isDocRenaming ? (\n                <>\n                  <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\" style={{ color: 'var(--tree-icon-dim)' }}>\n                    <path d=\"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z\"/><path d=\"M14 2v4a2 2 0 0 0 2 2h4\"/>\n                  </svg>\n                  <div className=\"flex-1 min-w-0\">\n                    <input\n                      ref={docRenameInputRef}\n                      value={docRenameValue}\n                      onChange={(e) => onDocRenameChange(e.target.value)}\n                      onBlur={onDocRenameCommit}\n                      onKeyDown={(e) => {\n                        if (e.key === 'Enter') onDocRenameCommit();\n                        if (e.key === 'Escape') onDocRenameCancel();\n                      }}\n                      onClick={(e) => e.stopPropagation()}\n                      className={`w-full text-[10px] font-medium text-zinc-800 dark:text-zinc-200 bg-white dark:bg-zinc-900 border rounded px-1 py-0 outline-none ${docRenameError ? 'border-red-400 focus:border-red-400' : 'border-zinc-300 dark:border-zinc-600 focus:border-zinc-400'}`}\n                    />\n                    {docRenameError && <p className=\"text-[8px] text-red-500 mt-0.5\">{docRenameError}</p>}\n                  </div>\n                </>\n              ) : (\n                <DocRow\n                  doc={doc}\n                  isSelected={isThisDocSelected}\n                  isInSelectedProject={isInSelectedProject}\n                  onMenuToggle={(pos) => onDocMenuToggle(doc.id, pos)}\n                  onOpenDocument={onOpenDocument}\n                  onSelectDoc={onSelectDoc}\n                  onOpenSourcesPanel={onOpenSourcesPanel}\n                />\n              )}\n            </div>\n          );\n        })}\n      </div>\n    )}\n  </div>\n  );\n};\n\n// ── Document row sub-component (interactive, for selected nugget) ──\n\ninterface DocRowProps {\n  doc: { id: string; name: string; status?: string };\n  isSelected?: boolean;\n  isInSelectedProject?: boolean;\n  onMenuToggle: (pos: { x: number; y: number }) => void;\n  onOpenDocument?: (docId: string) => void;\n  onSelectDoc?: (docId: string) => void;\n  onOpenSourcesPanel?: () => void;\n}\n\nconst DocRow: React.FC<DocRowProps> = ({ doc, isSelected, isInSelectedProject, onMenuToggle, onOpenDocument, onSelectDoc, onOpenSourcesPanel }) => {\n  return (\n    <div\n      className=\"flex items-center gap-1.5 flex-1 min-w-0 cursor-pointer\"\n      onClick={(e) => {\n        e.stopPropagation();\n        onSelectDoc?.(doc.id);\n        onOpenDocument?.(doc.id);\n      }}\n      onDoubleClick={(e) => {\n        e.stopPropagation();\n        onSelectDoc?.(doc.id);\n        onOpenDocument?.(doc.id);\n        onOpenSourcesPanel?.();\n      }}\n    >\n      {(doc.status === 'processing' || doc.status === 'uploading') ? (\n        <div className=\"shrink-0 w-2.5 h-2.5 border-[1.5px] border-zinc-300 dark:border-zinc-600 border-t-zinc-600 dark:border-t-zinc-400 rounded-full animate-spin\" />\n      ) : (\n        <svg width=\"10\" height=\"10\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0\" style={{ color: isSelected ? 'var(--tree-active)' : isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)' }}>\n          <path d=\"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z\"/><path d=\"M14 2v4a2 2 0 0 0 2 2h4\"/>\n        </svg>\n      )}\n      <span className=\"flex-1 text-[10px] truncate\" style={{ color: isSelected ? 'var(--tree-active)' : isInSelectedProject ? 'var(--tree-text)' : 'var(--tree-text-dim)' }} title={doc.name}>{doc.name}</span>\n      {/* Kebab menu button */}\n      <button\n        onClick={(e) => { e.stopPropagation(); onMenuToggle({ x: e.clientX, y: e.clientY }); }}\n        className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity\"\n        style={{ color: isSelected ? 'var(--tree-icon)' : isInSelectedProject ? 'var(--tree-icon)' : 'var(--tree-icon-dim)' }}\n      >\n        <EllipsisIcon />\n      </button>\n    </div>\n  );\n};\n\nexport default ProjectsPanel;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\SourcesPanel.tsx","messages":[{"ruleId":"import/order","severity":1,"message":"`../context/AppContext` import should occur before import of `./DocumentEditorModal`","line":11,"column":1,"nodeType":"ImportDeclaration","endLine":11,"endColumn":55,"fix":{"range":[226,628],"text":"import { useAppContext } from '../context/AppContext';\nimport DocumentEditorModal, { DocumentEditorHandle } from './DocumentEditorModal';\nimport PdfBookmarkEditor from './PdfBookmarkEditor';\nimport PanelRequirements from './PanelRequirements';\nimport { UnsavedChangesDialog } from './Dialogs';\nimport { PanelEditorHandle } from './CardsPanel';\nimport PdfViewer, { PdfViewerHandle } from './PdfViewer';\n"}},{"ruleId":"import/order","severity":1,"message":"`../utils/pdfBookmarks` import should occur before import of `./DocumentEditorModal`","line":12,"column":1,"nodeType":"ImportDeclaration","endLine":12,"endColumn":79,"fix":{"range":[226,707],"text":"import { flattenBookmarks, headingsToBookmarks } from '../utils/pdfBookmarks';\nimport DocumentEditorModal, { DocumentEditorHandle } from './DocumentEditorModal';\nimport PdfBookmarkEditor from './PdfBookmarkEditor';\nimport PanelRequirements from './PanelRequirements';\nimport { UnsavedChangesDialog } from './Dialogs';\nimport { PanelEditorHandle } from './CardsPanel';\nimport PdfViewer, { PdfViewerHandle } from './PdfViewer';\nimport { useAppContext } from '../context/AppContext';\n"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onUpdateDocumentStructure' is defined but never used. Allowed unused args must match /^_/u.","line":46,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":61,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":61,"endColumn":63},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'shouldRender'. Either include it or remove the dependency array.","line":64,"column":6,"nodeType":"ArrayExpression","endLine":64,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, shouldRender]","fix":{"range":[2848,2856],"text":"[isOpen, shouldRender]"}}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.6.","line":65,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":57},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":65,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":63},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":68,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":68,"endColumn":64,"fix":{"range":[3059,3090],"text":"{setOverlayWidth(DEFAULT_WIDTH);}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DEFAULT_WIDTH'. Either include it or remove the dependency array.","line":68,"column":68,"nodeType":"ArrayExpression","endLine":68,"endColumn":76,"suggestions":[{"desc":"Update the dependencies array to be: [DEFAULT_WIDTH, isOpen]","fix":{"range":[3094,3102],"text":"[DEFAULT_WIDTH, isOpen]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":80,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":80,"endColumn":39,"fix":{"range":[3629,3636],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":81,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":81,"endColumn":35},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 220.","line":117,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":117,"endColumn":47},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":130,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":130,"endColumn":42,"fix":{"range":[5646,5653],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 140.","line":131,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 480.","line":131,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":45},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":182,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":182,"endColumn":48,"fix":{"range":[8582,8589],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":184,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":184,"endColumn":23,"fix":{"range":[8657,8664],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":187,"column":79,"nodeType":"Literal","messageId":"noMagic","endLine":187,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":189,"column":81,"nodeType":"Literal","messageId":"noMagic","endLine":189,"endColumn":82},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":201,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":201,"endColumn":58,"fix":{"range":[9388,9395],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":204,"column":74,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":204,"endColumn":81,"fix":{"range":[9553,9560],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":205,"column":70,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":205,"endColumn":77,"fix":{"range":[9630,9637],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":246,"column":48,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":246,"endColumn":55,"fix":{"range":[11040,11047],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":259,"column":73,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":259,"endColumn":80,"fix":{"range":[11600,11607],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":263,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":263,"endColumn":49},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":263,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":263,"endColumn":92,"fix":{"range":[11797,11838],"text":"{y = window.innerHeight - rect.height - 8;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":263,"column":90,"nodeType":"Literal","messageId":"noMagic","endLine":263,"endColumn":91},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":264,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":264,"endColumn":47},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":264,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":264,"endColumn":88,"fix":{"range":[11887,11926],"text":"{x = window.innerWidth - rect.width - 8;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":264,"column":86,"nodeType":"Literal","messageId":"noMagic","endLine":264,"endColumn":87},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":266,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":266,"endColumn":74,"fix":{"range":[11991,12038],"text":"{setPdfContextMenu({ ...pdfContextMenu, x, y });}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":267,"column":12,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":267,"endColumn":43,"fix":{"range":[12050,12081],"text":"{setPdfDocContextMenu({ x, y });}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":281,"column":37,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":281,"endColumn":44,"fix":{"range":[12469,12476],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":291,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":291,"endColumn":36,"fix":{"range":[12920,12931],"text":"{return ids;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":292,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":292,"endColumn":59,"fix":{"range":[12956,12990],"text":"{return [pdfContextMenu.headingId];}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":297,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":297,"endColumn":52,"fix":{"range":[13172,13198],"text":"{return { min: 1, max: 6 };}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":302,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":302,"endColumn":32,"fix":{"range":[13365,13374],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":307,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":307,"endColumn":53,"fix":{"range":[13604,13610],"text":"{break;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handlePdfPromote' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":315,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":315,"endColumn":25},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":321,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":321,"endColumn":32,"fix":{"range":[14115,14124],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":325,"column":50,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":325,"endColumn":56,"fix":{"range":[14344,14350],"text":"{break;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":332,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":332,"endColumn":56,"fix":{"range":[14549,14580],"text":"{setTocDirtyDocId(activeDoc.id);}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handlePdfDemote' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":336,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":336,"endColumn":24},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":342,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":342,"endColumn":32,"fix":{"range":[14992,15001],"text":"{continue;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":344,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":344,"endColumn":42},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":346,"column":50,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":346,"endColumn":56,"fix":{"range":[15221,15227],"text":"{break;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":348,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":348,"endColumn":44},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":353,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":353,"endColumn":56,"fix":{"range":[15426,15457],"text":"{setTocDirtyDocId(activeDoc.id);}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handlePdfDelete' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":357,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":357,"endColumn":24},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":362,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":362,"endColumn":56,"fix":{"range":[15846,15877],"text":"{setTocDirtyDocId(activeDoc.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":373,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":373,"endColumn":56,"fix":{"range":[16336,16367],"text":"{setTocDirtyDocId(activeDoc.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":392,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":392,"endColumn":34,"fix":{"range":[17244,17251],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":395,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":395,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":395,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":395,"endColumn":68},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":397,"column":47,"nodeType":"Literal","messageId":"noMagic","endLine":397,"endColumn":50},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":404,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":404,"endColumn":56,"fix":{"range":[17749,17780],"text":"{setTocDirtyDocId(activeDoc.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":417,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":417,"endColumn":60,"fix":{"range":[18401,18414],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":419,"column":48,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":419,"endColumn":61,"fix":{"range":[18514,18527],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":421,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":421,"endColumn":60,"fix":{"range":[18640,18646],"text":"{break;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":429,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":429,"endColumn":52,"fix":{"range":[18879,18892],"text":"{return false;}"}},{"ruleId":"react/jsx-no-useless-fragment","severity":1,"message":"Passing a fragment to an HTML element is useless.","line":472,"column":7,"nodeType":"JSXFragment","messageId":"ChildOfHtmlElement","endLine":1234,"endColumn":10,"fix":{"range":[21030,72085],"text":"{/* Document list bar — hover opens, click locks */}\n      <div className=\"shrink-0 border-y border-zinc-100 dark:border-zinc-700\">\n        <div\n          ref={docToggleRef}\n          className=\"flex items-center gap-1.5 px-3 py-1.5 cursor-pointer\"\n          onMouseEnter={() => {\n            if (docListOpen && docListMode === 'locked') return;\n            setDocListMode('hover');\n            setDocListOpen(true);\n          }}\n          onMouseLeave={(e) => {\n            if (docListMode === 'locked') return;\n            const related = e.relatedTarget as Node | null;\n            if (docListRef.current && related && docListRef.current.contains(related)) return;\n            setDocListOpen(false);\n          }}\n          onClick={() => {\n            if (docListOpen && docListMode === 'locked') {\n              setDocListOpen(false);\n            } else {\n              setDocListMode('locked');\n              setDocListOpen(true);\n            }\n          }}\n        >\n          <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>Select Source</span>\n          <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{documents.length}</span>\n          {/* Chevron icon */}\n          <div className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200\">\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <polyline points={docListOpen ? \"18 15 12 9 6 15\" : \"6 9 12 15 18 9\"} />\n            </svg>\n          </div>\n        </div>\n      </div>\n\n      {/* Document list popup — portaled to body */}\n      {docListOpen && createPortal(\n        <div\n          ref={docListRef}\n          className=\"fixed z-[120]\"\n          style={{\n            ...(docToggleRef.current ? (() => {\n              const r = docToggleRef.current.getBoundingClientRect();\n              return { top: r.bottom, left: r.left };\n            })() : {}),\n          }}\n          onMouseLeave={(e) => {\n            if (docListMode === 'locked') return;\n            const related = e.relatedTarget as Node | null;\n            if (docToggleRef.current && related && docToggleRef.current.contains(related)) return;\n            setDocListOpen(false);\n          }}\n        >\n          {/* Invisible bridge padding on top + left/right, visible content inside */}\n          <div\n            className=\"bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-2 px-1 max-h-[50vh] overflow-y-auto mt-1\"\n            style={{ scrollbarWidth: 'thin' as const }}\n          >\n          {documents.length === 0 && (\n            <div className=\"px-3 py-2\">\n              <span className=\"text-[11px] text-zinc-500 dark:text-zinc-400 font-light italic\">No documents yet</span>\n            </div>\n          )}\n\n          {documents.map(doc => {\n            const isActive = activeDocTab === doc.id;\n\n            return (\n              <div\n                key={doc.id}\n                className={`relative flex items-center gap-1.5 px-3 py-1.5 cursor-pointer select-none transition-colors rounded-lg ${\n                  isActive ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'\n                }`}\n                onClick={() => {\n                  gatedAction(() => {\n                    setActiveDocTab(doc.id);\n                    onDocTabChange?.(doc.id);\n                  });\n                }}\n              >\n                {(doc.status === 'processing' || doc.status === 'uploading') && (\n                  <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 dark:border-zinc-600 border-t-zinc-600 dark:border-t-zinc-400 rounded-full animate-spin\" />\n                )}\n                <span className=\"flex-1 min-w-0 text-[11px] truncate\">{doc.name}</span>\n              </div>\n            );\n          })}\n          </div>\n        </div>,\n        document.body\n      )}\n\n      {/* Sources content area */}\n      {documents.length > 0 ? (\n        <>\n          {(() => {\n            const activeDoc = documents.find(d => d.id === activeDocTab);\n\n            // Debug: log document state for native PDF troubleshooting\n            if (activeDoc) {\n              console.debug('[SourcesPanel] activeDoc:', activeDoc.name, 'sourceType:', activeDoc.sourceType, 'hasPdfBase64:', !!activeDoc.pdfBase64, 'hasContent:', !!activeDoc.content, 'status:', activeDoc.status, 'fileId:', activeDoc.fileId);\n            }\n\n            // Native PDF: iframe viewer + TOC sidebar with context menus\n            if (activeDoc?.sourceType === 'native-pdf' && activeDoc.pdfBase64) {\n              const headings = tocDraft ?? activeDoc.structure ?? [];\n              return (\n                <div className=\"flex-1 flex flex-col min-h-0\">\n                  {/* PDF Toolbar — matches FormatToolbar visual style */}\n                  <div className=\"shrink-0 flex justify-center py-[3px] px-6 lg:px-8 bg-white dark:bg-zinc-900 border-b border-zinc-100 dark:border-zinc-700\">\n                    <div className=\"flex items-center gap-0.5 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-xl rounded-full px-2 py-1\">\n                      {/* Zoom out */}\n                      <button\n                        onClick={() => { setPdfFitMode(null); setPdfScale(s => Math.max(0.5, +(s - 0.25).toFixed(2))); }}\n                        className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400\"\n                        title=\"Zoom out\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg>\n                      </button>\n                      {/* Zoom level */}\n                      <span className=\"text-[10px] font-medium text-zinc-500 dark:text-zinc-400 w-10 text-center tabular-nums\">{Math.round(pdfScale * 100)}%</span>\n                      {/* Zoom in */}\n                      <button\n                        onClick={() => { setPdfFitMode(null); setPdfScale(s => Math.min(3, +(s + 0.25).toFixed(2))); }}\n                        className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400\"\n                        title=\"Zoom in\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg>\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Fit to page width */}\n                      <button\n                        onClick={() => { setPdfFitMode('width'); applyFitMode('width'); }}\n                        className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${pdfFitMode === 'width' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}\n                        title=\"Fit to page width\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M21 3H3v18h18V3z\"/><path d=\"M4 12h16\"/><path d=\"M7 9l-3 3 3 3\"/><path d=\"M17 9l3 3-3 3\"/></svg>\n                      </button>\n                      {/* Fit to page height */}\n                      <button\n                        onClick={() => { setPdfFitMode('height'); applyFitMode('height'); }}\n                        className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${pdfFitMode === 'height' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}\n                        title=\"Fit to page height\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M21 3H3v18h18V3z\"/><path d=\"M12 4v16\"/><path d=\"M9 7l3-3 3 3\"/><path d=\"M9 17l3 3 3-3\"/></svg>\n                      </button>\n                      {/* Rotate */}\n                      <button\n                        onClick={() => setPdfRotation(r => (r + 90) % 360)}\n                        className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400\"\n                        title=\"Rotate clockwise\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><polyline points=\"23 4 23 10 17 10\"/><path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\"/></svg>\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Page indicator */}\n                      <span className=\"text-[10px] font-medium text-zinc-500 dark:text-zinc-400 px-1 tabular-nums\">\n                        {pdfPageInfo.total > 0 ? `${pdfPageInfo.current} / ${pdfPageInfo.total}` : '–'}\n                      </span>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Bookmark level picker */}\n                      <div className=\"relative\">\n                        <button\n                          onClick={() => setBookmarkLevelDropdownOpen(prev => !prev)}\n                          className=\"h-7 px-1.5 rounded-full flex items-center gap-0.5 transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400\"\n                          title=\"Bookmark heading level\"\n                        >\n                          <span className=\"text-[10px] font-bold tabular-nums\">H{bookmarkLevel}</span>\n                          <svg width=\"8\" height=\"8\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"3\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                            <polyline points=\"6 9 12 15 18 9\" />\n                          </svg>\n                        </button>\n                        {bookmarkLevelDropdownOpen && (\n                          <div\n                            className=\"absolute top-full mt-1 left-0 z-[140] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100\"\n                            onMouseDown={(e) => e.stopPropagation()}\n                          >\n                            {[1, 2, 3, 4].map(level => (\n                              <button\n                                key={level}\n                                onClick={() => { setBookmarkLevel(level); setBookmarkLevelDropdownOpen(false); }}\n                                className={`w-full text-left px-3 py-1.5 text-[11px] hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors flex items-center gap-2 whitespace-nowrap ${bookmarkLevel === level ? 'text-blue-600 font-bold' : 'text-zinc-600 dark:text-zinc-400'}`}\n                              >\n                                <span className=\"w-5 h-4 rounded bg-zinc-100 dark:bg-zinc-800/50 text-[9px] font-bold flex items-center justify-center\">H{level}</span>\n                                Heading {level}\n                              </button>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                      {/* Create Bookmark button */}\n                      <button\n                        onClick={() => activeDoc && handleCreateBookmark(activeDoc)}\n                        disabled={!selectedPdfText}\n                        className={`h-7 px-2 rounded-full flex items-center gap-1 transition-all text-[10px] font-semibold ${\n                          selectedPdfText\n                            ? 'bg-blue-50 dark:bg-blue-950 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 cursor-pointer'\n                            : 'text-zinc-400 dark:text-zinc-600 cursor-not-allowed'\n                        }`}\n                        title={selectedPdfText ? `Create bookmark from \"${selectedPdfText.text.substring(0, 40)}...\"` : 'Select text in the PDF to create a bookmark'}\n                      >\n                        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\" />\n                        </svg>\n                        Bookmark\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Edit Bookmarks button */}\n                      <button\n                        onClick={() => setBookmarkEditorOpen(prev => !prev)}\n                        className={`h-7 px-2 rounded-full flex items-center gap-1 transition-all text-[10px] font-semibold ${\n                          bookmarkEditorOpen\n                            ? 'bg-blue-100 dark:bg-blue-950 text-blue-600 dark:text-blue-400'\n                            : 'text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-700 dark:hover:text-zinc-300'\n                        }`}\n                        title=\"Edit PDF bookmarks\"\n                      >\n                        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\" />\n                        </svg>\n                        Edit Bookmarks\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* PDF label */}\n                      <span className=\"text-[9px] font-bold uppercase tracking-wider text-zinc-400 dark:text-zinc-500 px-2\">PDF</span>\n                    </div>\n                  </div>\n                  {/* TOC + PDF content */}\n                  <div className=\"flex-1 flex min-h-0\">\n                  {/* TOC Sidebar */}\n                  <aside className=\"shrink-0 overflow-y-auto bg-[#fafafa] dark:bg-zinc-900 relative\" style={{ width: tocWidth }}>\n                    <div className=\"sticky top-0 z-10 bg-[#d9e8f1] dark:bg-zinc-800\">\n                      <div className=\"px-3 pt-3 pb-1\">\n                        <span className=\"text-[10px] font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400\">Table of Contents</span>\n                      </div>\n                      <div className=\"px-2\">\n                        {/* Document name — with kebab for whole-document card generation */}\n                        <div className=\"group px-2 py-1.5 mb-1 border-b border-zinc-300/40 dark:border-zinc-700/40 cursor-default\">\n                          <div className=\"flex items-center gap-1.5\">\n                            <p className=\"flex-1 min-w-0 text-[11px] font-medium truncate text-[rgb(50,90,130)] dark:text-blue-300\" title={activeDoc.name}>{activeDoc.name}</p>\n                            {pdfGeneratingDoc && (\n                              <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 border-t-blue-500 rounded-full animate-spin\" />\n                            )}\n                            {onGenerateCardContent && (\n                              <button\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  setPdfDocContextMenu({ x: e.clientX, y: e.clientY });\n                                  setPdfDocGenerateSubmenuOpen(false);\n                                }}\n                                className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity text-zinc-400 dark:text-zinc-500\"\n                              >\n                                <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                                  <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                                </svg>\n                              </button>\n                            )}\n                          </div>\n                          {activeDoc.tocSource && (\n                            <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-normal italic mt-0.5 block\">\n                              {activeDoc.tocSource === 'toc_page' ? 'from TOC page' : 'AI-detected headings'}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"px-2 pb-4\">\n                      {headings.length > 0 ? (\n                        headings.map((heading, hIdx) => {\n                          if (!isPdfHeadingVisible(headings, hIdx)) return null;\n                          const pdfIndentClasses = ['ml-0', 'ml-4', 'ml-8', 'ml-12', 'ml-16', 'ml-20'];\n                          const pdfTextStyles = [\n                            'text-[12px] font-bold text-zinc-800 dark:text-zinc-200',\n                            'text-[11px] font-semibold text-zinc-600 dark:text-zinc-400',\n                            'text-[11px] font-medium text-zinc-500 dark:text-zinc-400',\n                            'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n                            'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n                            'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n                          ];\n                          const level = Math.min(heading.level, 6);\n                          const indent = pdfIndentClasses[level - 1] || 'ml-0';\n                          const textStyle = pdfTextStyles[level - 1] || pdfTextStyles[5];\n                          const hasChildren = pdfHeadingHasChildren(headings, hIdx);\n                          const isCollapsed = pdfCollapsed.has(heading.id);\n                          const isGenerating = pdfGeneratingIds.has(heading.id);\n                          const isSelected = pdfSelectedIds.has(heading.id);\n                          const isRenaming = renamingHeadingId === heading.id;\n                          return (\n                            <div\n                              key={heading.id}\n                              className={`${indent} group relative flex items-center space-x-1 py-1 px-1 transition-all duration-300 cursor-pointer border border-transparent ${\n                                activePdfHeadingId === heading.id ? 'sidebar-node-active'\n                                : isSelected ? 'bg-[rgba(160,200,220,0.2)]'\n                                : 'hover:border-blue-300'\n                              }`}\n                              onClick={() => {\n                                // Tier 1: left-click — set active heading, scroll, clear tier 2\n                                setPdfSelectedIds(new Set());\n                                if (pdfViewerRef.current) {\n                                  pdfViewerRef.current.scrollToHeading(heading.text, heading.page ?? undefined);\n                                  setActivePdfHeadingId(heading.id);\n                                }\n                              }}\n                              onContextMenu={(e) => {\n                                e.preventDefault();\n                                e.stopPropagation();\n                                // Tier 2: right-click selects for batch operations\n                                // If right-clicked heading isn't already tier 2 selected, clear and select just this one\n                                if (!pdfSelectedIds.has(heading.id)) {\n                                  setPdfSelectedIds(new Set([heading.id]));\n                                }\n                                setPdfLevelSubmenuOpen(false);\n                                setPdfGenerateSubmenuOpen(false);\n                                setPdfContextMenu({ x: e.clientX, y: e.clientY, headingId: heading.id });\n                              }}\n                            >\n                              {level === 1 && hIdx > 0 && (\n                                <div className=\"h-px bg-zinc-200 dark:bg-zinc-700 mb-1 mt-2 ml-1\" />\n                              )}\n                              {/* Collapse/expand toggle */}\n                              {hasChildren ? (\n                                <button\n                                  onClick={(e) => { e.stopPropagation(); setPdfCollapsed(prev => {\n                                    const next = new Set(prev);\n                                    if (next.has(heading.id)) next.delete(heading.id); else next.add(heading.id);\n                                    return next;\n                                  }); }}\n                                  className=\"flex-shrink-0 w-4 h-4 flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all duration-200 cursor-pointer\"\n                                >\n                                  <svg\n                                    width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                                    className={`transition-transform duration-200 ${isCollapsed ? '' : 'rotate-90'}`}\n                                  >\n                                    <polyline points=\"9 18 15 12 9 6\" />\n                                  </svg>\n                                </button>\n                              ) : (\n                                <div className=\"flex-shrink-0 w-4 h-4\" />\n                              )}\n                              {isRenaming ? (\n                                <input\n                                  autoFocus\n                                  defaultValue={heading.text}\n                                  className={`${textStyle} flex-1 min-w-0 bg-white dark:bg-zinc-800 border border-blue-400 rounded px-1 py-0.5 outline-none`}\n                                  onBlur={(e) => activeDoc && handlePdfRename(activeDoc, heading.id, e.target.value)}\n                                  onKeyDown={(e) => {\n                                    if (e.key === 'Enter') activeDoc && handlePdfRename(activeDoc, heading.id, (e.target as HTMLInputElement).value);\n                                    if (e.key === 'Escape') setRenamingHeadingId(null);\n                                  }}\n                                  onClick={(e) => e.stopPropagation()}\n                                />\n                              ) : (\n                                <span className={`${textStyle} transition-all select-none truncate pr-2 ml-0.5 flex-1 min-w-0`} style={{ opacity: activePdfHeadingId === heading.id || isSelected || isGenerating ? 1 : 0.7 }}>\n                                  {heading.text}\n                                </span>\n                              )}\n                              {heading.page != null && (\n                                <span className=\"shrink-0 text-[8px] text-zinc-400 dark:text-zinc-500 font-light tabular-nums\">{heading.page}</span>\n                              )}\n                              {isGenerating ? (\n                                <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 border-t-blue-500 rounded-full animate-spin\" />\n                              ) : (\n                                <button\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    if (!pdfSelectedIds.has(heading.id)) {\n                                      setPdfSelectedIds(new Set([heading.id]));\n                                    }\n                                    setPdfLevelSubmenuOpen(false);\n                                    setPdfGenerateSubmenuOpen(false);\n                                    setPdfContextMenu({ x: e.clientX, y: e.clientY, headingId: heading.id });\n                                  }}\n                                  className={`shrink-0 opacity-0 group-hover:opacity-100 w-4 h-4 rounded flex items-center justify-center transition-opacity ${\n                                    activePdfHeadingId === heading.id ? 'text-sky-400/60 dark:text-sky-400/50' : 'text-zinc-400/40 dark:text-zinc-500/40'\n                                  }`}\n                                  title=\"Heading menu\"\n                                >\n                                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                                    <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                                  </svg>\n                                </button>\n                              )}\n                            </div>\n                          );\n                        })\n                      ) : (\n                        <p className=\"px-2 py-2 text-[10px] text-zinc-400 dark:text-zinc-500 font-light italic\">Select text in the PDF and click Bookmark to add headings</p>\n                      )}\n                    </div>\n                    {/* TOC Save/Discard bar */}\n                    {tocDraft && (\n                      <div className=\"sticky bottom-0 bg-amber-50 dark:bg-amber-950/50 border-t border-amber-200 dark:border-amber-800 px-3 py-2 flex items-center justify-between gap-2\">\n                        <span className=\"text-[10px] font-medium text-amber-700 dark:text-amber-300\">Unsaved TOC changes</span>\n                        <div className=\"flex gap-1.5\">\n                          <button\n                            onClick={() => { setTocDraft(null); setTocDirtyDocId(null); }}\n                            className=\"px-2 py-1 text-[10px] font-medium rounded bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors\"\n                          >\n                            Discard\n                          </button>\n                          <button\n                            onClick={async () => {\n                              if (tocDraft && tocDirtyDocId) {\n                                await onSaveToc?.(tocDirtyDocId, tocDraft);\n                                setTocDraft(null); setTocDirtyDocId(null);\n                              }\n                            }}\n                            className=\"px-2 py-1 text-[10px] font-medium rounded bg-amber-500 text-white hover:bg-amber-600 transition-colors\"\n                          >\n                            Save\n                          </button>\n                        </div>\n                      </div>\n                    )}\n                  </aside>\n\n                  {/* TOC/PDF Divider */}\n                  <div\n                    onMouseDown={handleTocResizeStart}\n                    className=\"shrink-0 w-1.5 cursor-ew-resize hover:bg-black/10 transition-colors bg-zinc-100 dark:bg-zinc-700\"\n                  />\n\n                  {/* PDF Viewer */}\n                  <div className=\"flex-1 min-w-0 flex\">\n                    <div className=\"flex-1 min-w-0\">\n                      <PdfViewer\n                        ref={pdfViewerRef}\n                        pdfBase64={activeDoc.pdfBase64}\n                        scale={pdfScale}\n                        rotation={pdfRotation}\n                        onPageChange={(current, total) => {\n                          const isInitial = pdfPageInfo.total === 0 && total > 0;\n                          setPdfPageInfo({ current, total });\n                          if (isInitial) setTimeout(() => applyFitMode(pdfFitMode), 50);\n                        }}\n                        onTextSelected={(text, page) => setSelectedPdfText({ text, page })}\n                      />\n                    </div>\n                    {/* Bookmark Editor Panel */}\n                    {bookmarkEditorOpen && activeDoc && (\n                      <div className=\"shrink-0 w-[280px] min-h-0\">\n                        <PdfBookmarkEditor\n                          bookmarks={activeDoc.bookmarks ?? (activeDoc.structure ? headingsToBookmarks(activeDoc.structure) : [])}\n                          onSave={(newBookmarks) => {\n                            if (onSaveBookmarks) {\n                              onSaveBookmarks(activeDoc.id, newBookmarks);\n                            } else if (onSaveToc) {\n                              // Fallback: convert bookmarks to flat headings and use existing save path\n                              onSaveToc(activeDoc.id, flattenBookmarks(newBookmarks));\n                            }\n                            setBookmarkEditorOpen(false);\n                          }}\n                          onDiscard={() => setBookmarkEditorOpen(false)}\n                          onRegenerateWithAI={onRegenerateBookmarks ? async () => {\n                            setIsRegeneratingBookmarks(true);\n                            try {\n                              await onRegenerateBookmarks(activeDoc.id);\n                            } finally {\n                              setIsRegeneratingBookmarks(false);\n                            }\n                          } : undefined}\n                          isRegenerating={isRegeneratingBookmarks}\n                        />\n                      </div>\n                    )}\n                  </div>\n\n                  {/* ── Native PDF heading context menu (unified with MD TOC menu) ── */}\n                  {pdfContextMenu && (() => {\n                    const ctxHeading = headings.find(h => h.id === pdfContextMenu.headingId);\n                    if (!ctxHeading) return null;\n                    const affectedIds = getPdfTier2Ids();\n                    const isMultiSelect = affectedIds.length > 1;\n                    const affectedLevels = getPdfAffectedLevels(headings);\n                    const canPromote = affectedLevels.min > 1;\n                    const canDemote = affectedLevels.max < 6;\n                    return createPortal(\n                      <div\n                        ref={pdfMenuRef}\n                        className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-150\"\n                        style={{ top: pdfContextMenu.y, left: pdfContextMenu.x }}\n                        onMouseDown={(e) => e.stopPropagation()}\n                        onContextMenu={(e) => e.preventDefault()}\n                      >\n                        {/* Generate Card Content submenu */}\n                        {onGenerateCardContent && (\n                          <>\n                            <div className=\"relative\">\n                              <button\n                                onClick={() => setPdfGenerateSubmenuOpen(prev => !prev)}\n                                onMouseEnter={() => { setPdfGenerateSubmenuOpen(true); setPdfLevelSubmenuOpen(false); }}\n                                className=\"w-full text-left px-3 py-2 text-[11px] font-bold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                              >\n                                <span className=\"flex items-center gap-2\">\n                                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                                    <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n                                  </svg>\n                                  Generate Card Content{isMultiSelect ? ' for Highlighted Items' : ''}\n                                </span>\n                                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                                  <polyline points=\"9 18 15 12 9 6\" />\n                                </svg>\n                              </button>\n\n                              {pdfGenerateSubmenuOpen && (\n                                <div className=\"absolute left-full top-0 ml-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100\">\n                                  {([\n                                    { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                                    { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                                    { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n                                  ]).map(opt => (\n                                    <button\n                                      key={opt.level}\n                                      onClick={async () => {\n                                        const ids = getPdfTier2Ids();\n                                        const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                                        closePdfMenu();\n                                        await Promise.all(targets.map(t => onGenerateCardContent(t.id, opt.level, t.text, activeDoc.name)));\n                                      }}\n                                      className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                                    >\n                                      <span className=\"font-medium\">{opt.label}</span>\n                                      <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                                    </button>\n                                  ))}\n                                  <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                                  {([\n                                    { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                                    { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n                                  ]).map(opt => (\n                                    <button\n                                      key={opt.level}\n                                      onClick={async () => {\n                                        const ids = getPdfTier2Ids();\n                                        const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                                        closePdfMenu();\n                                        await Promise.all(targets.map(t => onGenerateCardContent(t.id, opt.level, t.text, activeDoc.name)));\n                                      }}\n                                      className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                                    >\n                                      <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                                      <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                                    </button>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                          </>\n                        )}\n\n                        {/* Expand All */}\n                        <button\n                          onClick={() => { setPdfCollapsed(new Set()); closePdfMenu(); }}\n                          onMouseEnter={() => { setPdfGenerateSubmenuOpen(false); setPdfLevelSubmenuOpen(false); }}\n                          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                        >\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                            <polyline points=\"6 9 12 15 18 9\" />\n                          </svg>\n                          Expand All\n                        </button>\n\n                        {/* Collapse All */}\n                        <button\n                          onClick={() => {\n                            const allParents = new Set<string>();\n                            headings.forEach((h, i) => { if (pdfHeadingHasChildren(headings, i)) allParents.add(h.id); });\n                            setPdfCollapsed(allParents);\n                            closePdfMenu();\n                          }}\n                          onMouseEnter={() => { setPdfGenerateSubmenuOpen(false); setPdfLevelSubmenuOpen(false); }}\n                          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                        >\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                            <polyline points=\"18 15 12 9 6 15\" />\n                          </svg>\n                          Collapse All\n                        </button>\n\n                        <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n                        {/* Select Heading Levels submenu */}\n                        <div className=\"relative\">\n                          <button\n                            onClick={() => setPdfLevelSubmenuOpen(prev => !prev)}\n                            onMouseEnter={() => { setPdfLevelSubmenuOpen(true); setPdfGenerateSubmenuOpen(false); }}\n                            className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                          >\n                            <span className=\"flex items-center gap-2\">\n                              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                                <line x1=\"21\" y1=\"10\" x2=\"7\" y2=\"10\" /><line x1=\"21\" y1=\"6\" x2=\"3\" y2=\"6\" /><line x1=\"21\" y1=\"14\" x2=\"3\" y2=\"14\" /><line x1=\"21\" y1=\"18\" x2=\"7\" y2=\"18\" />\n                              </svg>\n                              Select Heading Levels\n                            </span>\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                              <polyline points=\"9 18 15 12 9 6\" />\n                            </svg>\n                          </button>\n\n                          {pdfLevelSubmenuOpen && (\n                            <div className=\"absolute left-full top-0 ml-1 min-w-[140px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap\">\n                              {([\n                                { label: 'H1 Only',     tag: 'H1',   levels: [1] },\n                                { label: 'H2 Only',     tag: 'H2',   levels: [2] },\n                                { label: 'H3 Only',     tag: 'H3',   levels: [3] },\n                                { label: 'H1 + H2',     tag: 'H1–2', levels: [1, 2] },\n                                { label: 'H2 + H3',     tag: 'H2–3', levels: [2, 3] },\n                                { label: 'All Levels',   tag: 'All',  levels: [1, 2, 3, 4] },\n                              ] as { label: string; tag: string; levels: number[] }[]).map(opt => (\n                                <button\n                                  key={opt.label}\n                                  onClick={() => handlePdfSelectLevel(headings, opt.levels)}\n                                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                                >\n                                  <span className=\"w-7 h-4 rounded bg-zinc-100 dark:bg-zinc-800/50 text-[9px] font-bold text-zinc-500 dark:text-zinc-400 flex items-center justify-center\">\n                                    {opt.tag}\n                                  </span>\n                                  {opt.label}\n                                </button>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      </div>,\n                      document.body,\n                    );\n                  })()}\n\n                  {/* ── Native PDF document-title context menu ── */}\n                  {pdfDocContextMenu && onGenerateCardContent && createPortal(\n                    <div\n                      ref={pdfMenuRef}\n                      className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-150\"\n                      style={{ top: pdfDocContextMenu.y, left: pdfDocContextMenu.x }}\n                      onMouseDown={(e) => e.stopPropagation()}\n                      onContextMenu={(e) => e.preventDefault()}\n                    >\n                      <div className=\"relative\">\n                        <button\n                          onClick={() => setPdfDocGenerateSubmenuOpen(prev => !prev)}\n                          onMouseEnter={() => setPdfDocGenerateSubmenuOpen(true)}\n                          className=\"w-full text-left px-3 py-2 text-[11px] font-bold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                        >\n                          <span className=\"flex items-center gap-2\">\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                              <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n                            </svg>\n                            Generate Card for Whole Document\n                          </span>\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                            <polyline points=\"9 18 15 12 9 6\" />\n                          </svg>\n                        </button>\n\n                        {pdfDocGenerateSubmenuOpen && (\n                          <div className=\"absolute left-full top-0 ml-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100\">\n                            {([\n                              { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                              { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                              { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n                            ]).map(opt => (\n                              <button\n                                key={opt.level}\n                                onClick={async () => {\n                                  closePdfMenu();\n                                  await onGenerateCardContent('__whole_document__', opt.level, activeDoc.name, activeDoc.name);\n                                }}\n                                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                              >\n                                <span className=\"font-medium\">{opt.label}</span>\n                                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                              </button>\n                            ))}\n                            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                            {([\n                              { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                              { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n                            ]).map(opt => (\n                              <button\n                                key={opt.level}\n                                onClick={async () => {\n                                  closePdfMenu();\n                                  await onGenerateCardContent('__whole_document__', opt.level, activeDoc.name, activeDoc.name);\n                                }}\n                                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                              >\n                                <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                              </button>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                    </div>,\n                    document.body,\n                  )}\n                </div>\n                </div>\n              );\n            }\n\n            // Markdown: existing editor\n            if (!activeDoc?.content) {\n              const isProcessing = activeDoc?.status === 'processing' || activeDoc?.status === 'uploading';\n              const isLostNativePdf = !isProcessing && activeDoc && !activeDoc.content && !activeDoc.sourceType &&\n                (activeDoc.type === 'application/pdf' || activeDoc.name?.toLowerCase().endsWith('.pdf'));\n              return (\n                <div className=\"flex-1 flex flex-col items-center justify-center text-center px-8\">\n                  {isProcessing && (\n                    <div className=\"w-8 h-8 border-2 border-zinc-200 dark:border-zinc-700 border-t-zinc-500 dark:border-t-zinc-400 rounded-full animate-spin mb-3\" />\n                  )}\n                  <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light max-w-xs\">\n                    {isProcessing\n                      ? 'Processing document…'\n                      : isLostNativePdf\n                        ? 'This PDF needs to be re-uploaded. Remove it and upload again to restore the viewer.'\n                        : 'This document has no editable content.'}\n                  </p>\n                </div>\n              );\n            }\n            return (\n              <DocumentEditorModal\n                ref={editorHandleRef}\n                key={activeDoc.id}\n                document={activeDoc}\n                mode=\"inline\"\n                onSave={(newContent) => onSaveDocument(activeDoc.id, newContent)}\n                onClose={() => {}}\n                onGenerateCard={onGenerateCardContent}\n                generatingSourceIds={generatingSourceIds}\n              />\n            );\n          })()}\n        </>\n      ) : (\n        <div className=\"flex-1 flex flex-col items-center justify-center text-center px-8\">\n          <PanelRequirements level=\"sources\" />\n        </div>\n      )}\n\n      {/* Unsaved changes dialog */}\n      {pendingAction && (\n        <UnsavedChangesDialog\n          onSave={() => {\n            editorHandleRef.current?.save();\n            const action = pendingAction;\n            setPendingAction(null);\n            action();\n          }}\n          onDiscard={() => {\n            editorHandleRef.current?.discard();\n            const action = pendingAction;\n            setPendingAction(null);\n            action();\n          }}\n          onCancel={() => setPendingAction(null)}\n        />\n      )}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":479,"column":58,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":479,"endColumn":65,"fix":{"range":[21377,21384],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":484,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":484,"endColumn":50,"fix":{"range":[21544,21551],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":486,"column":88,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":486,"endColumn":95,"fix":{"range":[21699,21706],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":521,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":521,"endColumn":50,"fix":{"range":[23295,23302],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":523,"column":92,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":523,"endColumn":99,"fix":{"range":[23454,23461],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 37 to the 15 allowed.","line":569,"column":16,"nodeType":null,"messageId":"refactorFunction","endLine":569,"endColumn":18},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":574,"column":15,"nodeType":"MemberExpression","messageId":"unexpected","endLine":574,"endColumn":28,"suggestions":[{"fix":{"range":[25605,25835],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.5.","line":587,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":587,"endColumn":92},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":587,"column":100,"nodeType":"Literal","messageId":"noMagic","endLine":587,"endColumn":104},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":597,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":597,"endColumn":90},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":597,"column":98,"nodeType":"Literal","messageId":"noMagic","endLine":597,"endColumn":102},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 90.","line":622,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":622,"endColumn":67},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 360.","line":622,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":622,"endColumn":74},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":651,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":651,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":651,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":651,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 40.","line":673,"column":109,"nodeType":"Literal","messageId":"noMagic","endLine":673,"endColumn":111},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":743,"column":69,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":743,"endColumn":81,"fix":{"range":[39140,39152],"text":"{return null;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":749,"column":29,"nodeType":"Literal","messageId":"defineConstant","endLine":749,"endColumn":87},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":753,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":753,"endColumn":66},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":765,"column":33,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":767,"endColumn":58},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":766,"column":35,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":767,"endColumn":58,"fix":{"range":[40916,41015],"text":"(isSelected ? 'bg-[rgba(160,200,220,0.2)]'\n                                : 'hover:border-blue-300')"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":798,"column":63,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":798,"endColumn":87,"fix":{"range":[42976,43000],"text":"{next.delete(heading.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":798,"column":93,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":798,"endColumn":114,"fix":{"range":[43006,43027],"text":"{next.add(heading.id);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":820,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":820,"endColumn":150,"fix":{"range":[44622,44712],"text":"{activeDoc && handlePdfRename(activeDoc, heading.id, (e.target as HTMLInputElement).value);}"}},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":820,"column":60,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":820,"endColumn":150},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":821,"column":61,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":821,"endColumn":88,"fix":{"range":[44773,44800],"text":"{setRenamingHeadingId(null);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":826,"column":217,"nodeType":"Literal","messageId":"noMagic","endLine":826,"endColumn":220},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":907,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":907,"endColumn":89,"fix":{"range":[50107,50154],"text":"{setTimeout(() => applyFitMode(pdfFitMode), 50);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":907,"column":85,"nodeType":"Literal","messageId":"noMagic","endLine":907,"endColumn":87},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":944,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":944,"endColumn":50,"fix":{"range":[52158,52170],"text":"{return null;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'canPromote' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":948,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":948,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'canDemote' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":949,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":949,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":949,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":949,"endColumn":61},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":1041,"column":38,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":1041,"endColumn":45,"fix":{"range":[59751,59845],"text":"for (const [i, h] of headings.entries()) { if (pdfHeadingHasChildren(headings, i)) allParents.add(h.id); }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1041,"column":98,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1041,"endColumn":119,"fix":{"range":[59820,59841],"text":"{allParents.add(h.id);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":1079,"column":79,"nodeType":"Literal","messageId":"noMagic","endLine":1079,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":1081,"column":82,"nodeType":"Literal","messageId":"noMagic","endLine":1081,"endColumn":83},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":1082,"column":86,"nodeType":"Literal","messageId":"noMagic","endLine":1082,"endColumn":87},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":1082,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":1082,"endColumn":90},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":1187,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":1191,"endColumn":67},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":1189,"column":25,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":1191,"endColumn":67,"fix":{"range":[70603,70797],"text":"(isLostNativePdf\n                        ? 'This PDF needs to be re-uploaded. Remove it and upload again to restore the viewer.'\n                        : 'This document has no editable content.')"}}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":95,"fixableErrorCount":0,"fixableWarningCount":53,"source":"\nimport React, { useState, useRef, useEffect, useCallback, forwardRef, useImperativeHandle } from 'react';\nimport { createPortal } from 'react-dom';\nimport { BookmarkNode, DetailLevel, Heading, UploadedFile } from '../types';\nimport DocumentEditorModal, { DocumentEditorHandle } from './DocumentEditorModal';\nimport PdfBookmarkEditor from './PdfBookmarkEditor';\nimport PanelRequirements from './PanelRequirements';\nimport { UnsavedChangesDialog } from './Dialogs';\nimport { PanelEditorHandle } from './CardsPanel';\nimport PdfViewer, { PdfViewerHandle } from './PdfViewer';\nimport { useAppContext } from '../context/AppContext';\nimport { flattenBookmarks, headingsToBookmarks } from '../utils/pdfBookmarks';\n\ninterface SourcesPanelProps {\n  isOpen: boolean;\n  onToggle: () => void;\n  documents: UploadedFile[];\n  onSaveDocument: (docId: string, newContent: string) => void;\n  onGenerateCardContent?: (cardId: string, detailLevel: DetailLevel, cardText: string, sourceDocName?: string) => void;\n  /** When set, switches to this document tab (used by \"Open\" from Projects panel). */\n  requestedDocId?: string | null;\n  /** IDs of headings / '__whole_document__' currently generating content (lifted from App.tsx to survive panel collapse). */\n  generatingSourceIds?: Set<string>;\n  /** Update the heading/bookmark structure for a native PDF document. */\n  onUpdateDocumentStructure?: (docId: string, newStructure: Heading[]) => void;\n  /** Save TOC / bookmark changes. */\n  onSaveToc?: (docId: string, newStructure: Heading[]) => Promise<void>;\n  /** Save bookmarks directly (for PdfBookmarkEditor). */\n  onSaveBookmarks?: (docId: string, bookmarks: BookmarkNode[]) => void;\n  /** Regenerate bookmarks with AI (Gemini heading extraction). */\n  onRegenerateBookmarks?: (docId: string) => Promise<void>;\n  /** Notify parent when TOC draft state changes (for hard lock overlay). */\n  onDirtyChange?: (isDirty: boolean) => void;\n  /** Notify parent when user clicks a document tab (sync to context-level selection). */\n  onDocTabChange?: (docId: string | null) => void;\n}\n\nconst SourcesPanel = forwardRef<PanelEditorHandle, SourcesPanelProps>(({\n  isOpen,\n  onToggle,\n  documents,\n  onSaveDocument,\n  onGenerateCardContent,\n  requestedDocId,\n  generatingSourceIds,\n  onUpdateDocumentStructure,\n  onSaveToc,\n  onSaveBookmarks,\n  onRegenerateBookmarks,\n  onDirtyChange,\n  onDocTabChange,\n}, ref) => {\n  const { darkMode } = useAppContext();\n  const stripRef = useRef<HTMLButtonElement>(null);\n  const [shouldRender, setShouldRender] = useState(isOpen);\n  const [isClosing, setIsClosing] = useState(false);\n  useEffect(() => {\n    if (isOpen) { setShouldRender(true); setIsClosing(false); }\n    else if (shouldRender) {\n      setIsClosing(true);\n      const t = setTimeout(() => { setIsClosing(false); }, 400);\n      return () => clearTimeout(t);\n    }\n  }, [isOpen]);\n  const DEFAULT_WIDTH = Math.min(window.innerWidth * 0.6, 1000);\n  const [overlayWidth, setOverlayWidth] = useState(DEFAULT_WIDTH);\n  const isDragging = useRef(false);\n  useEffect(() => { if (isOpen) setOverlayWidth(DEFAULT_WIDTH); }, [isOpen]);\n  const handleResizeStart = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    isDragging.current = true;\n    document.body.style.userSelect = 'none';\n    document.body.style.cursor = 'ew-resize';\n    const overlay = document.createElement('div');\n    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;cursor:ew-resize;';\n    document.body.appendChild(overlay);\n    const startX = e.clientX;\n    const startW = overlayWidth;\n    const onMove = (ev: MouseEvent) => {\n      if (!isDragging.current) return;\n      setOverlayWidth(Math.max(300, startW + ev.clientX - startX));\n    };\n    const onUp = () => {\n      isDragging.current = false;\n      document.body.style.userSelect = '';\n      document.body.style.cursor = '';\n      overlay.remove();\n      document.removeEventListener('mousemove', onMove);\n      document.removeEventListener('mouseup', onUp);\n    };\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onUp);\n  }, [overlayWidth]);\n  const [activeDocTab, setActiveDocTab] = useState<string | null>(null);\n  const editorHandleRef = useRef<DocumentEditorHandle>(null);\n\n  // ── TOC draft mode (transactional save/discard) — declared early for useImperativeHandle ──\n  const [tocDraft, setTocDraft] = useState<Heading[] | null>(null);\n  const [tocDirtyDocId, setTocDirtyDocId] = useState<string | null>(null);\n\n  useImperativeHandle(ref, () => ({\n    get isDirty() { return (editorHandleRef.current?.isDirty ?? false) || tocDraft !== null; },\n    save: () => {\n      editorHandleRef.current?.save();\n      if (tocDraft && tocDirtyDocId) {\n        onSaveToc?.(tocDirtyDocId, tocDraft);\n        setTocDraft(null); setTocDirtyDocId(null);\n      }\n    },\n    discard: () => {\n      editorHandleRef.current?.discard();\n      setTocDraft(null); setTocDirtyDocId(null);\n    },\n  }), [tocDraft, tocDirtyDocId, onSaveToc]);\n\n  // ── Native PDF TOC state ──\n  const [tocWidth, setTocWidth] = useState(220);\n  const isDraggingToc = useRef(false);\n  const handleTocResizeStart = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    isDraggingToc.current = true;\n    document.body.style.userSelect = 'none';\n    document.body.style.cursor = 'ew-resize';\n    const overlay = document.createElement('div');\n    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;cursor:ew-resize;';\n    document.body.appendChild(overlay);\n    const startX = e.clientX;\n    const startW = tocWidth;\n    const onMove = (ev: MouseEvent) => {\n      if (!isDraggingToc.current) return;\n      setTocWidth(Math.max(140, Math.min(480, startW + ev.clientX - startX)));\n    };\n    const onUp = () => {\n      isDraggingToc.current = false;\n      document.body.style.userSelect = '';\n      document.body.style.cursor = '';\n      overlay.remove();\n      document.removeEventListener('mousemove', onMove);\n      document.removeEventListener('mouseup', onUp);\n    };\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onUp);\n  }, [tocWidth]);\n  const [pdfCollapsed, setPdfCollapsed] = useState<Set<string>>(new Set());\n  const [pdfContextMenu, setPdfContextMenu] = useState<{ x: number; y: number; headingId: string } | null>(null);\n  const [pdfDocContextMenu, setPdfDocContextMenu] = useState<{ x: number; y: number } | null>(null);\n  const [pdfGenerateSubmenuOpen, setPdfGenerateSubmenuOpen] = useState(false);\n  const [pdfDocGenerateSubmenuOpen, setPdfDocGenerateSubmenuOpen] = useState(false);\n  // Spinner state derived from lifted App.tsx state (survives panel collapse)\n  const pdfGeneratingIds = generatingSourceIds ?? new Set<string>();\n  const pdfGeneratingDoc = generatingSourceIds?.has('__whole_document__') ?? false;\n  const pdfMenuRef = useRef<HTMLDivElement>(null);\n  // PDF viewer controls\n  const [pdfScale, setPdfScale] = useState(1.0);\n  const [pdfRotation, setPdfRotation] = useState(0);\n  const [pdfPageInfo, setPdfPageInfo] = useState({ current: 1, total: 0 });\n  const [pdfFitMode, setPdfFitMode] = useState<'height' | 'width' | null>('height');\n  const [activePdfHeadingId, setActivePdfHeadingId] = useState<string | null>(null);\n  const pdfViewerRef = useRef<PdfViewerHandle>(null);\n\n  // ── Bookmark creation state ──\n  const [selectedPdfText, setSelectedPdfText] = useState<{ text: string; page: number } | null>(null);\n  const [bookmarkLevel, setBookmarkLevel] = useState(1);\n  const [bookmarkLevelDropdownOpen, setBookmarkLevelDropdownOpen] = useState(false);\n  // ── Multi-selection state (Tier 2) ──\n  const [pdfSelectedIds, setPdfSelectedIds] = useState<Set<string>>(new Set());\n  // ── Inline rename state ──\n  const [renamingHeadingId, setRenamingHeadingId] = useState<string | null>(null);\n  // ── Level selection submenu ──\n  const [pdfLevelSubmenuOpen, setPdfLevelSubmenuOpen] = useState(false);\n  // ── Bookmark editor state ──\n  const [bookmarkEditorOpen, setBookmarkEditorOpen] = useState(false);\n  const [isRegeneratingBookmarks, setIsRegeneratingBookmarks] = useState(false);\n  // Notify parent of TOC dirty state for hard lock overlay\n  useEffect(() => { onDirtyChange?.(tocDraft !== null); }, [tocDraft, onDirtyChange]);\n\n  // Reset draft when switching documents\n  useEffect(() => { setTocDraft(null); setTocDirtyDocId(null); }, [activeDocTab]);\n\n  // Apply fit mode whenever page info changes (initial load / page switch)\n  const applyFitMode = useCallback((mode: 'height' | 'width' | null) => {\n    if (!mode || !pdfViewerRef.current) return;\n    const dims = pdfViewerRef.current.getFitDims();\n    if (!dims) return;\n    const padding = 16; // 8px padding on each side\n    if (mode === 'width') {\n      setPdfScale(+((dims.containerWidth - padding) / dims.pageWidth).toFixed(4));\n    } else {\n      setPdfScale(+((dims.containerHeight - padding) / dims.pageHeight).toFixed(4));\n    }\n  }, []);\n\n  // ── Document list popup state (hover + locked, like kebab menus) ──\n  const [docListOpen, setDocListOpen] = useState(false);\n  const [docListMode, setDocListMode] = useState<'hover' | 'locked'>('hover');\n  const docToggleRef = useRef<HTMLDivElement>(null);\n  const docListRef = useRef<HTMLDivElement>(null);\n\n  // Close doc list popup on outside click (only when locked)\n  useEffect(() => {\n    if (!docListOpen || docListMode !== 'locked') return;\n    const handleClick = (e: MouseEvent) => {\n      const target = e.target as Node;\n      if (docToggleRef.current && docToggleRef.current.contains(target)) return;\n      if (docListRef.current && docListRef.current.contains(target)) return;\n      setDocListOpen(false);\n    };\n    window.addEventListener('mousedown', handleClick);\n    return () => window.removeEventListener('mousedown', handleClick);\n  }, [docListOpen, docListMode]);\n\n  // ── Unsaved-changes gating ──\n  const [pendingAction, setPendingAction] = useState<(() => void) | null>(null);\n\n  const gatedAction = useCallback((action: () => void) => {\n    if (editorHandleRef.current?.isDirty || tocDraft !== null) {\n      setPendingAction(() => action);\n      return;\n    }\n    action();\n  }, [tocDraft]);\n\n  // ── Gated wrapper for panel toggle ──\n  const handleToggle = useCallback(() => {\n    gatedAction(() => onToggle());\n  }, [gatedAction, onToggle]);\n\n  // Auto-select first document tab when documents change\n  useEffect(() => {\n    if (documents.length > 0 && (!activeDocTab || !documents.some(d => d.id === activeDocTab))) {\n      const firstDocId = documents[0].id;\n      setActiveDocTab(firstDocId);\n      onDocTabChange?.(firstDocId);\n    }\n  }, [documents, activeDocTab, onDocTabChange]);\n\n  // Switch to requested document (from Projects panel \"Open\" action)\n  useEffect(() => {\n    if (requestedDocId && documents.some(d => d.id === requestedDocId)) {\n      setActiveDocTab(requestedDocId);\n    }\n  }, [requestedDocId, documents]);\n\n  // ── Native PDF TOC context menu — close on outside click ──\n  useEffect(() => {\n    if (!pdfContextMenu && !pdfDocContextMenu) return;\n    const handler = () => {\n      setPdfContextMenu(null);\n      setPdfDocContextMenu(null);\n      setPdfGenerateSubmenuOpen(false);\n      setPdfDocGenerateSubmenuOpen(false);\n    };\n    const timer = setTimeout(() => document.addEventListener('mousedown', handler), 0);\n    return () => { clearTimeout(timer); document.removeEventListener('mousedown', handler); };\n  }, [pdfContextMenu, pdfDocContextMenu]);\n\n  // Reposition menu if it overflows the viewport\n  useEffect(() => {\n    if ((!pdfContextMenu && !pdfDocContextMenu) || !pdfMenuRef.current) return;\n    const rect = pdfMenuRef.current.getBoundingClientRect();\n    const pos = pdfContextMenu || pdfDocContextMenu!;\n    let { x, y } = pos;\n    if (y + rect.height > window.innerHeight - 8) y = window.innerHeight - rect.height - 8;\n    if (x + rect.width > window.innerWidth - 8) x = window.innerWidth - rect.width - 8;\n    if (y !== pos.y || x !== pos.x) {\n      if (pdfContextMenu) setPdfContextMenu({ ...pdfContextMenu, x, y });\n      else setPdfDocContextMenu({ x, y });\n    }\n  }, [pdfContextMenu, pdfDocContextMenu]);\n\n  const closePdfMenu = useCallback(() => {\n    setPdfContextMenu(null);\n    setPdfDocContextMenu(null);\n    setPdfGenerateSubmenuOpen(false);\n    setPdfDocGenerateSubmenuOpen(false);\n    setPdfLevelSubmenuOpen(false);\n  }, []);\n\n  // Close bookmark level dropdown on outside click\n  useEffect(() => {\n    if (!bookmarkLevelDropdownOpen) return;\n    const handler = () => setBookmarkLevelDropdownOpen(false);\n    const timer = setTimeout(() => document.addEventListener('mousedown', handler), 0);\n    return () => { clearTimeout(timer); document.removeEventListener('mousedown', handler); };\n  }, [bookmarkLevelDropdownOpen]);\n\n  // ── PDF Bookmark CRUD helpers ──\n\n  const getPdfTier2Ids = useCallback((): string[] => {\n    const ids = Array.from(pdfSelectedIds);\n    if (ids.length > 0) return ids;\n    if (pdfContextMenu) return [pdfContextMenu.headingId];\n    return [];\n  }, [pdfSelectedIds, pdfContextMenu]);\n\n  const getPdfAffectedLevels = useCallback((headings: Heading[]): { min: number; max: number } => {\n    if (!pdfContextMenu) return { min: 1, max: 6 };\n    const ids = getPdfTier2Ids();\n    let min = 6, max = 1;\n    for (const id of ids) {\n      const idx = headings.findIndex(h => h.id === id);\n      if (idx === -1) continue;\n      const parentLevel = headings[idx].level;\n      min = Math.min(min, parentLevel);\n      max = Math.max(max, parentLevel);\n      for (let i = idx + 1; i < headings.length; i++) {\n        if (headings[i].level <= parentLevel) break;\n        min = Math.min(min, headings[i].level);\n        max = Math.max(max, headings[i].level);\n      }\n    }\n    return { min, max };\n  }, [pdfContextMenu, getPdfTier2Ids]);\n\n  const handlePdfPromote = useCallback((activeDoc: UploadedFile) => {\n    const headings = tocDraft ?? activeDoc.structure ?? [];\n    const ids = getPdfTier2Ids();\n    const newHeadings = headings.map(h => ({ ...h }));\n    for (const id of ids) {\n      const idx = newHeadings.findIndex(h => h.id === id);\n      if (idx === -1) continue;\n      const parentLevel = newHeadings[idx].level;\n      newHeadings[idx].level = Math.max(1, parentLevel - 1);\n      for (let i = idx + 1; i < newHeadings.length; i++) {\n        if (newHeadings[i].level <= parentLevel) break;\n        if (!ids.includes(newHeadings[i].id)) {\n          newHeadings[i].level = Math.max(1, newHeadings[i].level - 1);\n        }\n      }\n    }\n    setTocDraft(newHeadings);\n    if (!tocDirtyDocId) setTocDirtyDocId(activeDoc.id);\n    closePdfMenu();\n  }, [getPdfTier2Ids, tocDraft, tocDirtyDocId, closePdfMenu]);\n\n  const handlePdfDemote = useCallback((activeDoc: UploadedFile) => {\n    const headings = tocDraft ?? activeDoc.structure ?? [];\n    const ids = getPdfTier2Ids();\n    const newHeadings = headings.map(h => ({ ...h }));\n    for (const id of ids) {\n      const idx = newHeadings.findIndex(h => h.id === id);\n      if (idx === -1) continue;\n      const parentLevel = newHeadings[idx].level;\n      newHeadings[idx].level = Math.min(6, parentLevel + 1);\n      for (let i = idx + 1; i < newHeadings.length; i++) {\n        if (newHeadings[i].level <= parentLevel) break;\n        if (!ids.includes(newHeadings[i].id)) {\n          newHeadings[i].level = Math.min(6, newHeadings[i].level + 1);\n        }\n      }\n    }\n    setTocDraft(newHeadings);\n    if (!tocDirtyDocId) setTocDirtyDocId(activeDoc.id);\n    closePdfMenu();\n  }, [getPdfTier2Ids, tocDraft, tocDirtyDocId, closePdfMenu]);\n\n  const handlePdfDelete = useCallback((activeDoc: UploadedFile) => {\n    const headings = tocDraft ?? activeDoc.structure ?? [];\n    const idsToDelete = new Set(getPdfTier2Ids());\n    const newHeadings = headings.filter(h => !idsToDelete.has(h.id));\n    setTocDraft(newHeadings);\n    if (!tocDirtyDocId) setTocDirtyDocId(activeDoc.id);\n    setPdfSelectedIds(new Set());\n    closePdfMenu();\n  }, [getPdfTier2Ids, tocDraft, tocDirtyDocId, closePdfMenu]);\n\n  const handlePdfRename = useCallback((activeDoc: UploadedFile, headingId: string, newText: string) => {\n    const headings = tocDraft ?? activeDoc.structure ?? [];\n    const newHeadings = headings.map(h =>\n      h.id === headingId ? { ...h, text: newText.trim() || h.text } : h\n    );\n    setTocDraft(newHeadings);\n    if (!tocDirtyDocId) setTocDirtyDocId(activeDoc.id);\n    setRenamingHeadingId(null);\n  }, [tocDraft, tocDirtyDocId]);\n\n  const handlePdfSelectLevel = useCallback((headings: Heading[], levels: number[]) => {\n    const levelSet = new Set(levels);\n    const currentlySelected = headings.filter(h => pdfSelectedIds.has(h.id));\n    const allAtTheseLevels = currentlySelected.length > 0 && currentlySelected.every(h => levelSet.has(h.level));\n    const targeted = headings.filter(h => levelSet.has(h.level));\n    const allTargetedSelected = targeted.length > 0 && targeted.every(h => pdfSelectedIds.has(h.id));\n    if (allAtTheseLevels && allTargetedSelected) {\n      setPdfSelectedIds(new Set());\n    } else {\n      setPdfSelectedIds(new Set(targeted.map(h => h.id)));\n    }\n    closePdfMenu();\n  }, [pdfSelectedIds, closePdfMenu]);\n\n  const handleCreateBookmark = useCallback((activeDoc: UploadedFile) => {\n    if (!selectedPdfText) return;\n    const headings = tocDraft ?? activeDoc.structure ?? [];\n    const newHeading: Heading = {\n      id: `h-${Date.now()}-${Math.random().toString(36).substr(2, 4)}`,\n      level: bookmarkLevel,\n      text: selectedPdfText.text.substring(0, 200),\n      page: selectedPdfText.page,\n      selected: false,\n    };\n    // Insert sorted by page number\n    const newHeadings = [...headings, newHeading].sort((a, b) => (a.page ?? 0) - (b.page ?? 0));\n    setTocDraft(newHeadings);\n    if (!tocDirtyDocId) setTocDirtyDocId(activeDoc.id);\n    setSelectedPdfText(null);\n    // Clear browser selection\n    window.getSelection()?.removeAllRanges();\n  }, [selectedPdfText, bookmarkLevel, tocDraft, tocDirtyDocId]);\n\n  // Helper: check if a heading is visible (not hidden by a collapsed ancestor)\n  const isPdfHeadingVisible = useCallback((headings: Heading[], index: number): boolean => {\n    const heading = headings[index];\n    // Walk backwards to find any ancestor that is collapsed\n    for (let i = index - 1; i >= 0; i--) {\n      if (headings[i].level < heading.level) {\n        // This is a potential ancestor\n        if (pdfCollapsed.has(headings[i].id)) return false;\n        // Check if this ancestor itself is visible\n        if (!isPdfHeadingVisible(headings, i)) return false;\n        // Only the nearest ancestor of each level matters\n        if (headings[i].level === heading.level - 1) break;\n      }\n    }\n    return true;\n  }, [pdfCollapsed]);\n\n  // Helper: check if a heading has children\n  const pdfHeadingHasChildren = useCallback((headings: Heading[], index: number): boolean => {\n    if (index + 1 >= headings.length) return false;\n    return headings[index + 1].level > headings[index].level;\n  }, []);\n\n  return (\n    <>\n    <button\n      ref={stripRef}\n      data-panel-strip\n      onClick={handleToggle}\n      className=\"flex flex-col items-center pt-2 pb-1 overflow-hidden rounded-l-lg shadow-[5px_0_10px_rgba(0,0,0,0.35)] shrink-0 w-10 cursor-pointer -ml-2.5 z-[3] relative\"\n      style={{ backgroundColor: darkMode ? 'rgb(45,65,85)' : 'rgb(140,180,205)' }}\n    >\n      <div className=\"w-8 shrink-0 flex items-center justify-center\">\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"shrink-0 text-white\">\n          <path d=\"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z\"/>\n          <path d=\"M14 2v4a2 2 0 0 0 2 2h4\"/>\n          <path d=\"M10 9H8\"/><path d=\"M16 13H8\"/><path d=\"M16 17H8\"/>\n        </svg>\n      </div>\n      <span className=\"text-[13px] font-bold uppercase tracking-wider text-white mt-2\" style={{ writingMode: 'vertical-lr', transform: 'rotate(180deg)' } as React.CSSProperties}>Create Cards from Sources</span>\n    </button>\n\n    {shouldRender && createPortal(\n      <div\n        data-panel-overlay\n        className=\"fixed z-[107] flex flex-col bg-white dark:bg-zinc-900 border-4 rounded-r-lg shadow-[5px_0_6px_rgba(0,0,0,0.35)] overflow-hidden\"\n        style={{ borderColor: darkMode ? 'rgb(45,65,85)' : 'rgb(140,180,205)', transformOrigin: 'left',\n          ...(!isOpen && !isClosing\n            ? { display: 'none' }\n            : { animation: `${isClosing ? 'panel-roll-in' : 'panel-roll-out'} 0.4s ease-out forwards` }\n          ),\n          top: stripRef.current?.getBoundingClientRect().top ?? 0,\n          left: stripRef.current?.getBoundingClientRect().right ?? 0,\n          height: stripRef.current?.getBoundingClientRect().height ?? 0,\n          width: overlayWidth,\n        }}\n      >\n        {/* Resize handle */}\n        <div\n          onMouseDown={handleResizeStart}\n          className=\"absolute right-0 top-0 bottom-0 w-1.5 cursor-ew-resize z-10 hover:bg-black/10 transition-colors\"\n        />\n      <>\n      {/* Document list bar — hover opens, click locks */}\n      <div className=\"shrink-0 border-y border-zinc-100 dark:border-zinc-700\">\n        <div\n          ref={docToggleRef}\n          className=\"flex items-center gap-1.5 px-3 py-1.5 cursor-pointer\"\n          onMouseEnter={() => {\n            if (docListOpen && docListMode === 'locked') return;\n            setDocListMode('hover');\n            setDocListOpen(true);\n          }}\n          onMouseLeave={(e) => {\n            if (docListMode === 'locked') return;\n            const related = e.relatedTarget as Node | null;\n            if (docListRef.current && related && docListRef.current.contains(related)) return;\n            setDocListOpen(false);\n          }}\n          onClick={() => {\n            if (docListOpen && docListMode === 'locked') {\n              setDocListOpen(false);\n            } else {\n              setDocListMode('locked');\n              setDocListOpen(true);\n            }\n          }}\n        >\n          <span className=\"text-[11px] font-semibold uppercase tracking-wider text-zinc-600 dark:text-zinc-400\" style={{ textShadow: '0 1px 2px rgba(0,0,0,0.15)' }}>Select Source</span>\n          <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-light\">{documents.length}</span>\n          {/* Chevron icon */}\n          <div className=\"shrink-0 w-5 h-5 rounded flex items-center justify-center transition-all text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200\">\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <polyline points={docListOpen ? \"18 15 12 9 6 15\" : \"6 9 12 15 18 9\"} />\n            </svg>\n          </div>\n        </div>\n      </div>\n\n      {/* Document list popup — portaled to body */}\n      {docListOpen && createPortal(\n        <div\n          ref={docListRef}\n          className=\"fixed z-[120]\"\n          style={{\n            ...(docToggleRef.current ? (() => {\n              const r = docToggleRef.current.getBoundingClientRect();\n              return { top: r.bottom, left: r.left };\n            })() : {}),\n          }}\n          onMouseLeave={(e) => {\n            if (docListMode === 'locked') return;\n            const related = e.relatedTarget as Node | null;\n            if (docToggleRef.current && related && docToggleRef.current.contains(related)) return;\n            setDocListOpen(false);\n          }}\n        >\n          {/* Invisible bridge padding on top + left/right, visible content inside */}\n          <div\n            className=\"bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-2 px-1 max-h-[50vh] overflow-y-auto mt-1\"\n            style={{ scrollbarWidth: 'thin' as const }}\n          >\n          {documents.length === 0 && (\n            <div className=\"px-3 py-2\">\n              <span className=\"text-[11px] text-zinc-500 dark:text-zinc-400 font-light italic\">No documents yet</span>\n            </div>\n          )}\n\n          {documents.map(doc => {\n            const isActive = activeDocTab === doc.id;\n\n            return (\n              <div\n                key={doc.id}\n                className={`relative flex items-center gap-1.5 px-3 py-1.5 cursor-pointer select-none transition-colors rounded-lg ${\n                  isActive ? 'bg-zinc-200 dark:bg-zinc-700 font-medium text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'\n                }`}\n                onClick={() => {\n                  gatedAction(() => {\n                    setActiveDocTab(doc.id);\n                    onDocTabChange?.(doc.id);\n                  });\n                }}\n              >\n                {(doc.status === 'processing' || doc.status === 'uploading') && (\n                  <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 dark:border-zinc-600 border-t-zinc-600 dark:border-t-zinc-400 rounded-full animate-spin\" />\n                )}\n                <span className=\"flex-1 min-w-0 text-[11px] truncate\">{doc.name}</span>\n              </div>\n            );\n          })}\n          </div>\n        </div>,\n        document.body\n      )}\n\n      {/* Sources content area */}\n      {documents.length > 0 ? (\n        <>\n          {(() => {\n            const activeDoc = documents.find(d => d.id === activeDocTab);\n\n            // Debug: log document state for native PDF troubleshooting\n            if (activeDoc) {\n              console.debug('[SourcesPanel] activeDoc:', activeDoc.name, 'sourceType:', activeDoc.sourceType, 'hasPdfBase64:', !!activeDoc.pdfBase64, 'hasContent:', !!activeDoc.content, 'status:', activeDoc.status, 'fileId:', activeDoc.fileId);\n            }\n\n            // Native PDF: iframe viewer + TOC sidebar with context menus\n            if (activeDoc?.sourceType === 'native-pdf' && activeDoc.pdfBase64) {\n              const headings = tocDraft ?? activeDoc.structure ?? [];\n              return (\n                <div className=\"flex-1 flex flex-col min-h-0\">\n                  {/* PDF Toolbar — matches FormatToolbar visual style */}\n                  <div className=\"shrink-0 flex justify-center py-[3px] px-6 lg:px-8 bg-white dark:bg-zinc-900 border-b border-zinc-100 dark:border-zinc-700\">\n                    <div className=\"flex items-center gap-0.5 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-xl rounded-full px-2 py-1\">\n                      {/* Zoom out */}\n                      <button\n                        onClick={() => { setPdfFitMode(null); setPdfScale(s => Math.max(0.5, +(s - 0.25).toFixed(2))); }}\n                        className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400\"\n                        title=\"Zoom out\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg>\n                      </button>\n                      {/* Zoom level */}\n                      <span className=\"text-[10px] font-medium text-zinc-500 dark:text-zinc-400 w-10 text-center tabular-nums\">{Math.round(pdfScale * 100)}%</span>\n                      {/* Zoom in */}\n                      <button\n                        onClick={() => { setPdfFitMode(null); setPdfScale(s => Math.min(3, +(s + 0.25).toFixed(2))); }}\n                        className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400\"\n                        title=\"Zoom in\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg>\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Fit to page width */}\n                      <button\n                        onClick={() => { setPdfFitMode('width'); applyFitMode('width'); }}\n                        className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${pdfFitMode === 'width' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}\n                        title=\"Fit to page width\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M21 3H3v18h18V3z\"/><path d=\"M4 12h16\"/><path d=\"M7 9l-3 3 3 3\"/><path d=\"M17 9l3 3-3 3\"/></svg>\n                      </button>\n                      {/* Fit to page height */}\n                      <button\n                        onClick={() => { setPdfFitMode('height'); applyFitMode('height'); }}\n                        className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${pdfFitMode === 'height' ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400'}`}\n                        title=\"Fit to page height\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M21 3H3v18h18V3z\"/><path d=\"M12 4v16\"/><path d=\"M9 7l3-3 3 3\"/><path d=\"M9 17l3 3 3-3\"/></svg>\n                      </button>\n                      {/* Rotate */}\n                      <button\n                        onClick={() => setPdfRotation(r => (r + 90) % 360)}\n                        className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 text-zinc-600 dark:text-zinc-400\"\n                        title=\"Rotate clockwise\"\n                      >\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><polyline points=\"23 4 23 10 17 10\"/><path d=\"M20.49 15a9 9 0 1 1-2.12-9.36L23 10\"/></svg>\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Page indicator */}\n                      <span className=\"text-[10px] font-medium text-zinc-500 dark:text-zinc-400 px-1 tabular-nums\">\n                        {pdfPageInfo.total > 0 ? `${pdfPageInfo.current} / ${pdfPageInfo.total}` : '–'}\n                      </span>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Bookmark level picker */}\n                      <div className=\"relative\">\n                        <button\n                          onClick={() => setBookmarkLevelDropdownOpen(prev => !prev)}\n                          className=\"h-7 px-1.5 rounded-full flex items-center gap-0.5 transition-all hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400\"\n                          title=\"Bookmark heading level\"\n                        >\n                          <span className=\"text-[10px] font-bold tabular-nums\">H{bookmarkLevel}</span>\n                          <svg width=\"8\" height=\"8\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"3\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                            <polyline points=\"6 9 12 15 18 9\" />\n                          </svg>\n                        </button>\n                        {bookmarkLevelDropdownOpen && (\n                          <div\n                            className=\"absolute top-full mt-1 left-0 z-[140] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100\"\n                            onMouseDown={(e) => e.stopPropagation()}\n                          >\n                            {[1, 2, 3, 4].map(level => (\n                              <button\n                                key={level}\n                                onClick={() => { setBookmarkLevel(level); setBookmarkLevelDropdownOpen(false); }}\n                                className={`w-full text-left px-3 py-1.5 text-[11px] hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors flex items-center gap-2 whitespace-nowrap ${bookmarkLevel === level ? 'text-blue-600 font-bold' : 'text-zinc-600 dark:text-zinc-400'}`}\n                              >\n                                <span className=\"w-5 h-4 rounded bg-zinc-100 dark:bg-zinc-800/50 text-[9px] font-bold flex items-center justify-center\">H{level}</span>\n                                Heading {level}\n                              </button>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                      {/* Create Bookmark button */}\n                      <button\n                        onClick={() => activeDoc && handleCreateBookmark(activeDoc)}\n                        disabled={!selectedPdfText}\n                        className={`h-7 px-2 rounded-full flex items-center gap-1 transition-all text-[10px] font-semibold ${\n                          selectedPdfText\n                            ? 'bg-blue-50 dark:bg-blue-950 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 cursor-pointer'\n                            : 'text-zinc-400 dark:text-zinc-600 cursor-not-allowed'\n                        }`}\n                        title={selectedPdfText ? `Create bookmark from \"${selectedPdfText.text.substring(0, 40)}...\"` : 'Select text in the PDF to create a bookmark'}\n                      >\n                        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\" />\n                        </svg>\n                        Bookmark\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* Edit Bookmarks button */}\n                      <button\n                        onClick={() => setBookmarkEditorOpen(prev => !prev)}\n                        className={`h-7 px-2 rounded-full flex items-center gap-1 transition-all text-[10px] font-semibold ${\n                          bookmarkEditorOpen\n                            ? 'bg-blue-100 dark:bg-blue-950 text-blue-600 dark:text-blue-400'\n                            : 'text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-700 dark:hover:text-zinc-300'\n                        }`}\n                        title=\"Edit PDF bookmarks\"\n                      >\n                        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                          <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\" />\n                        </svg>\n                        Edit Bookmarks\n                      </button>\n                      <div className=\"w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1\" />\n                      {/* PDF label */}\n                      <span className=\"text-[9px] font-bold uppercase tracking-wider text-zinc-400 dark:text-zinc-500 px-2\">PDF</span>\n                    </div>\n                  </div>\n                  {/* TOC + PDF content */}\n                  <div className=\"flex-1 flex min-h-0\">\n                  {/* TOC Sidebar */}\n                  <aside className=\"shrink-0 overflow-y-auto bg-[#fafafa] dark:bg-zinc-900 relative\" style={{ width: tocWidth }}>\n                    <div className=\"sticky top-0 z-10 bg-[#d9e8f1] dark:bg-zinc-800\">\n                      <div className=\"px-3 pt-3 pb-1\">\n                        <span className=\"text-[10px] font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400\">Table of Contents</span>\n                      </div>\n                      <div className=\"px-2\">\n                        {/* Document name — with kebab for whole-document card generation */}\n                        <div className=\"group px-2 py-1.5 mb-1 border-b border-zinc-300/40 dark:border-zinc-700/40 cursor-default\">\n                          <div className=\"flex items-center gap-1.5\">\n                            <p className=\"flex-1 min-w-0 text-[11px] font-medium truncate text-[rgb(50,90,130)] dark:text-blue-300\" title={activeDoc.name}>{activeDoc.name}</p>\n                            {pdfGeneratingDoc && (\n                              <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 border-t-blue-500 rounded-full animate-spin\" />\n                            )}\n                            {onGenerateCardContent && (\n                              <button\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  setPdfDocContextMenu({ x: e.clientX, y: e.clientY });\n                                  setPdfDocGenerateSubmenuOpen(false);\n                                }}\n                                className=\"shrink-0 w-4 h-4 flex items-center justify-center rounded opacity-0 group-hover:opacity-100 transition-opacity text-zinc-400 dark:text-zinc-500\"\n                              >\n                                <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                                  <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                                </svg>\n                              </button>\n                            )}\n                          </div>\n                          {activeDoc.tocSource && (\n                            <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 font-normal italic mt-0.5 block\">\n                              {activeDoc.tocSource === 'toc_page' ? 'from TOC page' : 'AI-detected headings'}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"px-2 pb-4\">\n                      {headings.length > 0 ? (\n                        headings.map((heading, hIdx) => {\n                          if (!isPdfHeadingVisible(headings, hIdx)) return null;\n                          const pdfIndentClasses = ['ml-0', 'ml-4', 'ml-8', 'ml-12', 'ml-16', 'ml-20'];\n                          const pdfTextStyles = [\n                            'text-[12px] font-bold text-zinc-800 dark:text-zinc-200',\n                            'text-[11px] font-semibold text-zinc-600 dark:text-zinc-400',\n                            'text-[11px] font-medium text-zinc-500 dark:text-zinc-400',\n                            'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n                            'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n                            'text-[10px] font-normal text-zinc-500 dark:text-zinc-400',\n                          ];\n                          const level = Math.min(heading.level, 6);\n                          const indent = pdfIndentClasses[level - 1] || 'ml-0';\n                          const textStyle = pdfTextStyles[level - 1] || pdfTextStyles[5];\n                          const hasChildren = pdfHeadingHasChildren(headings, hIdx);\n                          const isCollapsed = pdfCollapsed.has(heading.id);\n                          const isGenerating = pdfGeneratingIds.has(heading.id);\n                          const isSelected = pdfSelectedIds.has(heading.id);\n                          const isRenaming = renamingHeadingId === heading.id;\n                          return (\n                            <div\n                              key={heading.id}\n                              className={`${indent} group relative flex items-center space-x-1 py-1 px-1 transition-all duration-300 cursor-pointer border border-transparent ${\n                                activePdfHeadingId === heading.id ? 'sidebar-node-active'\n                                : isSelected ? 'bg-[rgba(160,200,220,0.2)]'\n                                : 'hover:border-blue-300'\n                              }`}\n                              onClick={() => {\n                                // Tier 1: left-click — set active heading, scroll, clear tier 2\n                                setPdfSelectedIds(new Set());\n                                if (pdfViewerRef.current) {\n                                  pdfViewerRef.current.scrollToHeading(heading.text, heading.page ?? undefined);\n                                  setActivePdfHeadingId(heading.id);\n                                }\n                              }}\n                              onContextMenu={(e) => {\n                                e.preventDefault();\n                                e.stopPropagation();\n                                // Tier 2: right-click selects for batch operations\n                                // If right-clicked heading isn't already tier 2 selected, clear and select just this one\n                                if (!pdfSelectedIds.has(heading.id)) {\n                                  setPdfSelectedIds(new Set([heading.id]));\n                                }\n                                setPdfLevelSubmenuOpen(false);\n                                setPdfGenerateSubmenuOpen(false);\n                                setPdfContextMenu({ x: e.clientX, y: e.clientY, headingId: heading.id });\n                              }}\n                            >\n                              {level === 1 && hIdx > 0 && (\n                                <div className=\"h-px bg-zinc-200 dark:bg-zinc-700 mb-1 mt-2 ml-1\" />\n                              )}\n                              {/* Collapse/expand toggle */}\n                              {hasChildren ? (\n                                <button\n                                  onClick={(e) => { e.stopPropagation(); setPdfCollapsed(prev => {\n                                    const next = new Set(prev);\n                                    if (next.has(heading.id)) next.delete(heading.id); else next.add(heading.id);\n                                    return next;\n                                  }); }}\n                                  className=\"flex-shrink-0 w-4 h-4 flex items-center justify-center text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all duration-200 cursor-pointer\"\n                                >\n                                  <svg\n                                    width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"\n                                    className={`transition-transform duration-200 ${isCollapsed ? '' : 'rotate-90'}`}\n                                  >\n                                    <polyline points=\"9 18 15 12 9 6\" />\n                                  </svg>\n                                </button>\n                              ) : (\n                                <div className=\"flex-shrink-0 w-4 h-4\" />\n                              )}\n                              {isRenaming ? (\n                                <input\n                                  autoFocus\n                                  defaultValue={heading.text}\n                                  className={`${textStyle} flex-1 min-w-0 bg-white dark:bg-zinc-800 border border-blue-400 rounded px-1 py-0.5 outline-none`}\n                                  onBlur={(e) => activeDoc && handlePdfRename(activeDoc, heading.id, e.target.value)}\n                                  onKeyDown={(e) => {\n                                    if (e.key === 'Enter') activeDoc && handlePdfRename(activeDoc, heading.id, (e.target as HTMLInputElement).value);\n                                    if (e.key === 'Escape') setRenamingHeadingId(null);\n                                  }}\n                                  onClick={(e) => e.stopPropagation()}\n                                />\n                              ) : (\n                                <span className={`${textStyle} transition-all select-none truncate pr-2 ml-0.5 flex-1 min-w-0`} style={{ opacity: activePdfHeadingId === heading.id || isSelected || isGenerating ? 1 : 0.7 }}>\n                                  {heading.text}\n                                </span>\n                              )}\n                              {heading.page != null && (\n                                <span className=\"shrink-0 text-[8px] text-zinc-400 dark:text-zinc-500 font-light tabular-nums\">{heading.page}</span>\n                              )}\n                              {isGenerating ? (\n                                <div className=\"shrink-0 w-3 h-3 border-[1.5px] border-zinc-300 border-t-blue-500 rounded-full animate-spin\" />\n                              ) : (\n                                <button\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    if (!pdfSelectedIds.has(heading.id)) {\n                                      setPdfSelectedIds(new Set([heading.id]));\n                                    }\n                                    setPdfLevelSubmenuOpen(false);\n                                    setPdfGenerateSubmenuOpen(false);\n                                    setPdfContextMenu({ x: e.clientX, y: e.clientY, headingId: heading.id });\n                                  }}\n                                  className={`shrink-0 opacity-0 group-hover:opacity-100 w-4 h-4 rounded flex items-center justify-center transition-opacity ${\n                                    activePdfHeadingId === heading.id ? 'text-sky-400/60 dark:text-sky-400/50' : 'text-zinc-400/40 dark:text-zinc-500/40'\n                                  }`}\n                                  title=\"Heading menu\"\n                                >\n                                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                                    <circle cx=\"12\" cy=\"5\" r=\"1\"/><circle cx=\"12\" cy=\"12\" r=\"1\"/><circle cx=\"12\" cy=\"19\" r=\"1\"/>\n                                  </svg>\n                                </button>\n                              )}\n                            </div>\n                          );\n                        })\n                      ) : (\n                        <p className=\"px-2 py-2 text-[10px] text-zinc-400 dark:text-zinc-500 font-light italic\">Select text in the PDF and click Bookmark to add headings</p>\n                      )}\n                    </div>\n                    {/* TOC Save/Discard bar */}\n                    {tocDraft && (\n                      <div className=\"sticky bottom-0 bg-amber-50 dark:bg-amber-950/50 border-t border-amber-200 dark:border-amber-800 px-3 py-2 flex items-center justify-between gap-2\">\n                        <span className=\"text-[10px] font-medium text-amber-700 dark:text-amber-300\">Unsaved TOC changes</span>\n                        <div className=\"flex gap-1.5\">\n                          <button\n                            onClick={() => { setTocDraft(null); setTocDirtyDocId(null); }}\n                            className=\"px-2 py-1 text-[10px] font-medium rounded bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors\"\n                          >\n                            Discard\n                          </button>\n                          <button\n                            onClick={async () => {\n                              if (tocDraft && tocDirtyDocId) {\n                                await onSaveToc?.(tocDirtyDocId, tocDraft);\n                                setTocDraft(null); setTocDirtyDocId(null);\n                              }\n                            }}\n                            className=\"px-2 py-1 text-[10px] font-medium rounded bg-amber-500 text-white hover:bg-amber-600 transition-colors\"\n                          >\n                            Save\n                          </button>\n                        </div>\n                      </div>\n                    )}\n                  </aside>\n\n                  {/* TOC/PDF Divider */}\n                  <div\n                    onMouseDown={handleTocResizeStart}\n                    className=\"shrink-0 w-1.5 cursor-ew-resize hover:bg-black/10 transition-colors bg-zinc-100 dark:bg-zinc-700\"\n                  />\n\n                  {/* PDF Viewer */}\n                  <div className=\"flex-1 min-w-0 flex\">\n                    <div className=\"flex-1 min-w-0\">\n                      <PdfViewer\n                        ref={pdfViewerRef}\n                        pdfBase64={activeDoc.pdfBase64}\n                        scale={pdfScale}\n                        rotation={pdfRotation}\n                        onPageChange={(current, total) => {\n                          const isInitial = pdfPageInfo.total === 0 && total > 0;\n                          setPdfPageInfo({ current, total });\n                          if (isInitial) setTimeout(() => applyFitMode(pdfFitMode), 50);\n                        }}\n                        onTextSelected={(text, page) => setSelectedPdfText({ text, page })}\n                      />\n                    </div>\n                    {/* Bookmark Editor Panel */}\n                    {bookmarkEditorOpen && activeDoc && (\n                      <div className=\"shrink-0 w-[280px] min-h-0\">\n                        <PdfBookmarkEditor\n                          bookmarks={activeDoc.bookmarks ?? (activeDoc.structure ? headingsToBookmarks(activeDoc.structure) : [])}\n                          onSave={(newBookmarks) => {\n                            if (onSaveBookmarks) {\n                              onSaveBookmarks(activeDoc.id, newBookmarks);\n                            } else if (onSaveToc) {\n                              // Fallback: convert bookmarks to flat headings and use existing save path\n                              onSaveToc(activeDoc.id, flattenBookmarks(newBookmarks));\n                            }\n                            setBookmarkEditorOpen(false);\n                          }}\n                          onDiscard={() => setBookmarkEditorOpen(false)}\n                          onRegenerateWithAI={onRegenerateBookmarks ? async () => {\n                            setIsRegeneratingBookmarks(true);\n                            try {\n                              await onRegenerateBookmarks(activeDoc.id);\n                            } finally {\n                              setIsRegeneratingBookmarks(false);\n                            }\n                          } : undefined}\n                          isRegenerating={isRegeneratingBookmarks}\n                        />\n                      </div>\n                    )}\n                  </div>\n\n                  {/* ── Native PDF heading context menu (unified with MD TOC menu) ── */}\n                  {pdfContextMenu && (() => {\n                    const ctxHeading = headings.find(h => h.id === pdfContextMenu.headingId);\n                    if (!ctxHeading) return null;\n                    const affectedIds = getPdfTier2Ids();\n                    const isMultiSelect = affectedIds.length > 1;\n                    const affectedLevels = getPdfAffectedLevels(headings);\n                    const canPromote = affectedLevels.min > 1;\n                    const canDemote = affectedLevels.max < 6;\n                    return createPortal(\n                      <div\n                        ref={pdfMenuRef}\n                        className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-150\"\n                        style={{ top: pdfContextMenu.y, left: pdfContextMenu.x }}\n                        onMouseDown={(e) => e.stopPropagation()}\n                        onContextMenu={(e) => e.preventDefault()}\n                      >\n                        {/* Generate Card Content submenu */}\n                        {onGenerateCardContent && (\n                          <>\n                            <div className=\"relative\">\n                              <button\n                                onClick={() => setPdfGenerateSubmenuOpen(prev => !prev)}\n                                onMouseEnter={() => { setPdfGenerateSubmenuOpen(true); setPdfLevelSubmenuOpen(false); }}\n                                className=\"w-full text-left px-3 py-2 text-[11px] font-bold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                              >\n                                <span className=\"flex items-center gap-2\">\n                                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                                    <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n                                  </svg>\n                                  Generate Card Content{isMultiSelect ? ' for Highlighted Items' : ''}\n                                </span>\n                                <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                                  <polyline points=\"9 18 15 12 9 6\" />\n                                </svg>\n                              </button>\n\n                              {pdfGenerateSubmenuOpen && (\n                                <div className=\"absolute left-full top-0 ml-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100\">\n                                  {([\n                                    { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                                    { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                                    { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n                                  ]).map(opt => (\n                                    <button\n                                      key={opt.level}\n                                      onClick={async () => {\n                                        const ids = getPdfTier2Ids();\n                                        const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                                        closePdfMenu();\n                                        await Promise.all(targets.map(t => onGenerateCardContent(t.id, opt.level, t.text, activeDoc.name)));\n                                      }}\n                                      className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                                    >\n                                      <span className=\"font-medium\">{opt.label}</span>\n                                      <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                                    </button>\n                                  ))}\n                                  <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                                  {([\n                                    { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                                    { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n                                  ]).map(opt => (\n                                    <button\n                                      key={opt.level}\n                                      onClick={async () => {\n                                        const ids = getPdfTier2Ids();\n                                        const targets = ids.map(id => ({ id, text: headings.find(hh => hh.id === id)?.text || '' })).filter(t => t.text);\n                                        closePdfMenu();\n                                        await Promise.all(targets.map(t => onGenerateCardContent(t.id, opt.level, t.text, activeDoc.name)));\n                                      }}\n                                      className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                                    >\n                                      <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                                      <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                                    </button>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                          </>\n                        )}\n\n                        {/* Expand All */}\n                        <button\n                          onClick={() => { setPdfCollapsed(new Set()); closePdfMenu(); }}\n                          onMouseEnter={() => { setPdfGenerateSubmenuOpen(false); setPdfLevelSubmenuOpen(false); }}\n                          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                        >\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                            <polyline points=\"6 9 12 15 18 9\" />\n                          </svg>\n                          Expand All\n                        </button>\n\n                        {/* Collapse All */}\n                        <button\n                          onClick={() => {\n                            const allParents = new Set<string>();\n                            headings.forEach((h, i) => { if (pdfHeadingHasChildren(headings, i)) allParents.add(h.id); });\n                            setPdfCollapsed(allParents);\n                            closePdfMenu();\n                          }}\n                          onMouseEnter={() => { setPdfGenerateSubmenuOpen(false); setPdfLevelSubmenuOpen(false); }}\n                          className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                        >\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                            <polyline points=\"18 15 12 9 6 15\" />\n                          </svg>\n                          Collapse All\n                        </button>\n\n                        <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n\n                        {/* Select Heading Levels submenu */}\n                        <div className=\"relative\">\n                          <button\n                            onClick={() => setPdfLevelSubmenuOpen(prev => !prev)}\n                            onMouseEnter={() => { setPdfLevelSubmenuOpen(true); setPdfGenerateSubmenuOpen(false); }}\n                            className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                          >\n                            <span className=\"flex items-center gap-2\">\n                              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                                <line x1=\"21\" y1=\"10\" x2=\"7\" y2=\"10\" /><line x1=\"21\" y1=\"6\" x2=\"3\" y2=\"6\" /><line x1=\"21\" y1=\"14\" x2=\"3\" y2=\"14\" /><line x1=\"21\" y1=\"18\" x2=\"7\" y2=\"18\" />\n                              </svg>\n                              Select Heading Levels\n                            </span>\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                              <polyline points=\"9 18 15 12 9 6\" />\n                            </svg>\n                          </button>\n\n                          {pdfLevelSubmenuOpen && (\n                            <div className=\"absolute left-full top-0 ml-1 min-w-[140px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap\">\n                              {([\n                                { label: 'H1 Only',     tag: 'H1',   levels: [1] },\n                                { label: 'H2 Only',     tag: 'H2',   levels: [2] },\n                                { label: 'H3 Only',     tag: 'H3',   levels: [3] },\n                                { label: 'H1 + H2',     tag: 'H1–2', levels: [1, 2] },\n                                { label: 'H2 + H3',     tag: 'H2–3', levels: [2, 3] },\n                                { label: 'All Levels',   tag: 'All',  levels: [1, 2, 3, 4] },\n                              ] as { label: string; tag: string; levels: number[] }[]).map(opt => (\n                                <button\n                                  key={opt.label}\n                                  onClick={() => handlePdfSelectLevel(headings, opt.levels)}\n                                  className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2\"\n                                >\n                                  <span className=\"w-7 h-4 rounded bg-zinc-100 dark:bg-zinc-800/50 text-[9px] font-bold text-zinc-500 dark:text-zinc-400 flex items-center justify-center\">\n                                    {opt.tag}\n                                  </span>\n                                  {opt.label}\n                                </button>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      </div>,\n                      document.body,\n                    );\n                  })()}\n\n                  {/* ── Native PDF document-title context menu ── */}\n                  {pdfDocContextMenu && onGenerateCardContent && createPortal(\n                    <div\n                      ref={pdfMenuRef}\n                      className=\"fixed z-[130] min-w-[180px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-150\"\n                      style={{ top: pdfDocContextMenu.y, left: pdfDocContextMenu.x }}\n                      onMouseDown={(e) => e.stopPropagation()}\n                      onContextMenu={(e) => e.preventDefault()}\n                    >\n                      <div className=\"relative\">\n                        <button\n                          onClick={() => setPdfDocGenerateSubmenuOpen(prev => !prev)}\n                          onMouseEnter={() => setPdfDocGenerateSubmenuOpen(true)}\n                          className=\"w-full text-left px-3 py-2 text-[11px] font-bold text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between\"\n                        >\n                          <span className=\"flex items-center gap-2\">\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                              <rect x=\"3\" y=\"3\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M12 8v8\" /><path d=\"M8 12h8\" />\n                            </svg>\n                            Generate Card for Whole Document\n                          </span>\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500\">\n                            <polyline points=\"9 18 15 12 9 6\" />\n                          </svg>\n                        </button>\n\n                        {pdfDocGenerateSubmenuOpen && (\n                          <div className=\"absolute left-full top-0 ml-1 min-w-[160px] bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 animate-in fade-in zoom-in-95 duration-100\">\n                            {([\n                              { level: 'Executive' as DetailLevel, label: 'Executive', desc: '70-100 words' },\n                              { level: 'Standard' as DetailLevel, label: 'Standard', desc: '200-250 words' },\n                              { level: 'Detailed' as DetailLevel, label: 'Detailed', desc: '450-500 words' },\n                            ]).map(opt => (\n                              <button\n                                key={opt.level}\n                                onClick={async () => {\n                                  closePdfMenu();\n                                  await onGenerateCardContent('__whole_document__', opt.level, activeDoc.name, activeDoc.name);\n                                }}\n                                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                              >\n                                <span className=\"font-medium\">{opt.label}</span>\n                                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                              </button>\n                            ))}\n                            <div className=\"h-px bg-zinc-100 dark:bg-zinc-700 my-1\" />\n                            {([\n                              { level: 'TitleCard' as DetailLevel, label: 'Title Card', desc: 'Title + Subtitle' },\n                              { level: 'TakeawayCard' as DetailLevel, label: 'Takeaway Card', desc: 'Title + Key Takeaways' },\n                            ]).map(opt => (\n                              <button\n                                key={opt.level}\n                                onClick={async () => {\n                                  closePdfMenu();\n                                  await onGenerateCardContent('__whole_document__', opt.level, activeDoc.name, activeDoc.name);\n                                }}\n                                className=\"w-full text-left px-3 py-2 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center justify-between gap-3\"\n                              >\n                                <span className=\"font-medium text-violet-600\">{opt.label}</span>\n                                <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400\">{opt.desc}</span>\n                              </button>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                    </div>,\n                    document.body,\n                  )}\n                </div>\n                </div>\n              );\n            }\n\n            // Markdown: existing editor\n            if (!activeDoc?.content) {\n              const isProcessing = activeDoc?.status === 'processing' || activeDoc?.status === 'uploading';\n              const isLostNativePdf = !isProcessing && activeDoc && !activeDoc.content && !activeDoc.sourceType &&\n                (activeDoc.type === 'application/pdf' || activeDoc.name?.toLowerCase().endsWith('.pdf'));\n              return (\n                <div className=\"flex-1 flex flex-col items-center justify-center text-center px-8\">\n                  {isProcessing && (\n                    <div className=\"w-8 h-8 border-2 border-zinc-200 dark:border-zinc-700 border-t-zinc-500 dark:border-t-zinc-400 rounded-full animate-spin mb-3\" />\n                  )}\n                  <p className=\"text-xs text-zinc-500 dark:text-zinc-400 font-light max-w-xs\">\n                    {isProcessing\n                      ? 'Processing document…'\n                      : isLostNativePdf\n                        ? 'This PDF needs to be re-uploaded. Remove it and upload again to restore the viewer.'\n                        : 'This document has no editable content.'}\n                  </p>\n                </div>\n              );\n            }\n            return (\n              <DocumentEditorModal\n                ref={editorHandleRef}\n                key={activeDoc.id}\n                document={activeDoc}\n                mode=\"inline\"\n                onSave={(newContent) => onSaveDocument(activeDoc.id, newContent)}\n                onClose={() => {}}\n                onGenerateCard={onGenerateCardContent}\n                generatingSourceIds={generatingSourceIds}\n              />\n            );\n          })()}\n        </>\n      ) : (\n        <div className=\"flex-1 flex flex-col items-center justify-center text-center px-8\">\n          <PanelRequirements level=\"sources\" />\n        </div>\n      )}\n\n      {/* Unsaved changes dialog */}\n      {pendingAction && (\n        <UnsavedChangesDialog\n          onSave={() => {\n            editorHandleRef.current?.save();\n            const action = pendingAction;\n            setPendingAction(null);\n            action();\n          }}\n          onDiscard={() => {\n            editorHandleRef.current?.discard();\n            const action = pendingAction;\n            setPendingAction(null);\n            action();\n          }}\n          onCancel={() => setPendingAction(null)}\n        />\n      )}\n      </></div>,\n      document.body\n    )}\n    </>\n  );\n});\n\nexport default SourcesPanel;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\StorageProvider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Card' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Card"},"fix":{"range":[74,80],"text":""},"desc":"Remove unused variable \"Card\"."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":67,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":67,"endColumn":21,"suggestions":[{"fix":{"range":[1852,1913],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":76,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":76,"endColumn":18,"suggestions":[{"fix":{"range":[2195,2265],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":83,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":83,"endColumn":17,"suggestions":[{"fix":{"range":[2468,2534],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 65 to the 15 allowed.","line":89,"column":16,"nodeType":null,"messageId":"refactorFunction","endLine":89,"endColumn":34},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":117,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":117,"endColumn":14,"suggestions":[{"fix":{"range":[3273,3485],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"prefer-const","severity":1,"message":"'nuggets' is never reassigned. Use 'const' instead.","line":139,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":139,"endColumn":24,"fix":{"range":[3980,4007],"text":"const nuggets: Nugget[] = [];"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":156,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":156,"endColumn":18,"suggestions":[{"fix":{"range":[4806,4901],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5100,5103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5100,5103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":172,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":172,"endColumn":18,"suggestions":[{"fix":{"range":[5581,5631],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":182,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":182,"endColumn":43,"fix":{"range":[5988,5997],"text":"{continue;}"}},{"ruleId":"@typescript-eslint/no-shadow","severity":1,"message":"'insightsDocs' is already declared in the upper scope on line 97 column 5.","line":219,"column":13,"nodeType":"Identifier","messageId":"noShadow","endLine":219,"endColumn":41},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":256,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":256,"endColumn":16,"suggestions":[{"fix":{"range":[8490,8565],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":262,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8752,8755],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8752,8755],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":263,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":263,"endColumn":50,"fix":{"range":[8804,8825],"text":"{nugget.messages = [];}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":275,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":275,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":275,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":275,"endColumn":67},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":283,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":283,"endColumn":16,"suggestions":[{"fix":{"range":[9501,9612],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":291,"column":70,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":291,"endColumn":82,"fix":{"range":[9924,9936],"text":"{return null;}"}},{"ruleId":"promise/catch-or-return","severity":1,"message":"Expected catch() or return","line":316,"column":5,"nodeType":"ExpressionStatement","messageId":"terminationMethod","endLine":326,"endColumn":10},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":318,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":318,"endColumn":20,"suggestions":[{"fix":{"range":[10782,10922],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":319,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":319,"endColumn":48,"fix":{"range":[10947,10970],"text":"{setInitialState(state);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":322,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":322,"endColumn":22,"suggestions":[{"fix":{"range":[11010,11076],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":325,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":325,"endColumn":43,"fix":{"range":[11133,11151],"text":"{setLoading(false);}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":23,"fixableErrorCount":0,"fixableWarningCount":6,"source":"\nimport React, { useState, useEffect } from 'react';\nimport { UploadedFile, Card, InsightsSession, Nugget, Project, InitialPersistedState, CustomStyle } from '../types';\nimport { AppProvider, useAppContext } from '../context/AppContext';\nimport { IndexedDBBackend } from '../utils/storage/IndexedDBBackend';\nimport { StorageBackend } from '../utils/storage/StorageBackend';\nimport {\n  deserializeFile,\n  deserializeCard,\n  deserializeNugget,\n  deserializeNuggetDocument,\n  deserializeProject,\n  serializeCard,\n  serializeNugget,\n  serializeNuggetDocument,\n  serializeProject,\n  extractImages,\n} from '../utils/storage/serialize';\nimport { usePersistence } from '../hooks/usePersistence';\nimport { LoadingScreen } from './LoadingScreen';\n\n// ── Singleton storage instance (exported for direct use by useTokenUsage) ──\n\nexport const storage: StorageBackend = new IndexedDBBackend();\n\n// ── Persistence connector (auto-save, renders nothing) ──\n\nconst PersistenceConnector: React.FC = () => {\n  const {\n    activeCardId,\n    insightsSession,\n    nuggets,\n    projects,\n    selectedNuggetId,\n    selectedDocumentId,\n    selectedProjectId,\n    customStyles,\n  } = useAppContext();\n\n  usePersistence({\n    storage,\n    activeCardId,\n    insightsSession,\n    nuggets,\n    projects,\n    selectedNuggetId,\n    selectedDocumentId,\n    selectedProjectId,\n    customStyles,\n  });\n\n  return null;\n};\n\n// ── Startup integrity check: clean up orphaned data ──\n\nasync function cleanupOrphanedData(\n  storageBackend: StorageBackend,\n  hydratedNuggetIds: Set<string>,\n): Promise<void> {\n  try {\n    // Find nugget IDs in storage that weren't hydrated (orphans from crash/incomplete save)\n    const storedNuggetIds = await storageBackend.loadAllNuggetIds();\n    let orphanCount = 0;\n    for (const id of storedNuggetIds) {\n      if (!hydratedNuggetIds.has(id)) {\n        console.warn(`[Storage] Cleaning up orphaned nugget: ${id}`);\n        await storageBackend.deleteNugget(id);\n        await storageBackend.deleteNuggetDocuments(id);\n        await storageBackend.deleteNuggetHeadings(id);\n        await storageBackend.deleteNuggetImages(id);\n        orphanCount++;\n      }\n    }\n    if (orphanCount > 0) {\n      console.log(`[Storage] Cleaned up ${orphanCount} orphaned nugget(s)`);\n    }\n\n    // Belt and suspenders: clear any remaining legacy store data\n    await storageBackend.clearLegacyStores();\n  } catch (err) {\n    // Non-fatal — log and continue, don't block app startup\n    console.warn('[Storage] Orphan cleanup failed (non-fatal):', err);\n  }\n}\n\n// ── Hydration logic ──\n\nasync function hydrateFromStorage(): Promise<InitialPersistedState | null> {\n  await storage.init();\n\n  // Load from all stores in parallel\n  const [\n    appState,\n    storedFiles,\n    insightsSessionData,\n    insightsDocs,\n    insightsHeadingsStored,\n    insightsImagesStored,\n    storedNuggets,\n    storedProjects,\n    storedTokenUsage,\n    storedCustomStyles,\n  ] = await Promise.all([\n    storage.loadAppState(),\n    storage.loadFiles(),\n    storage.loadInsightsSession(),\n    storage.loadInsightsDocs(),\n    storage.loadInsightsHeadings(),\n    storage.loadInsightsImages(),\n    storage.loadNuggets(),\n    storage.loadProjects(),\n    storage.loadTokenUsage(),\n    storage.loadCustomStyles(),\n  ]);\n\n  console.log('[Storage] Raw stores:', {\n    storedNuggets: storedNuggets.length,\n    storedProjects: storedProjects.length,\n    storedFiles: storedFiles.length,\n    hasInsightsSession: !!insightsSessionData,\n  });\n\n  // Reconstitute insights session (legacy stores)\n  let insightsSession: InsightsSession | null = null;\n  if (insightsSessionData) {\n    const iHeadings = insightsHeadingsStored.map(sh =>\n      deserializeCard(sh, insightsImagesStored)\n    );\n    insightsSession = {\n      id: insightsSessionData.id,\n      documents: insightsDocs,\n      messages: insightsSessionData.messages,\n      cards: iHeadings,\n    };\n  }\n\n  // Reconstitute nuggets — load headings, images, and documents per-nugget\n  let nuggets: Nugget[] = [];\n  for (const sn of storedNuggets) {\n    const [headings, images, nuggetDocs] = await Promise.all([\n      storage.loadNuggetHeadings(sn.id),\n      storage.loadNuggetImages(sn.id),\n      storage.loadNuggetDocuments(sn.id),\n    ]);\n    const hydratedHeadings = headings.map(sh => deserializeCard(sh, images));\n    const hydratedDocs = nuggetDocs.map(sd => deserializeNuggetDocument(sd));\n    nuggets.push(deserializeNugget(sn, hydratedHeadings, hydratedDocs));\n  }\n\n  // ── Runtime migration: v2 data → v3 (documents were in global library, nuggets had documentIds) ──\n  const nuggetsNeedDocMigration = nuggets.length > 0 && nuggets.every(n => n.documents.length === 0);\n  if (nuggetsNeedDocMigration) {\n    const oldDocuments = await storage.loadDocuments();\n    if (oldDocuments.length > 0) {\n      console.log(`[Storage] Migrating v2→v3: ${oldDocuments.length} documents to embed in nuggets`);\n      const docMap = new Map(oldDocuments.map(sd => [sd.id, deserializeFile(sd)]));\n\n      for (const nugget of nuggets) {\n        const rawNugget = storedNuggets.find(sn => sn.id === nugget.id) as any;\n        const oldDocIds: string[] = rawNugget?.documentIds ?? [];\n        if (oldDocIds.length > 0) {\n          nugget.documents = oldDocIds\n            .map(id => docMap.get(id))\n            .filter((d): d is UploadedFile => d !== undefined);\n          for (const doc of nugget.documents) {\n            await storage.saveNuggetDocument(serializeNuggetDocument(nugget.id, doc));\n          }\n          await storage.saveNugget(serializeNugget(nugget));\n        }\n      }\n      console.log(`[Storage] v2→v3 migration complete`);\n    }\n  }\n\n  // ── Runtime migration: v1 data (files + insightsSession but no nuggets) → nuggets ──\n  if (nuggets.length === 0 && (storedFiles.length > 0 || insightsSession)) {\n    const now = Date.now();\n\n    // Migrate old files → insights nuggets (convert synthesis type to insights)\n    for (const sf of storedFiles) {\n      if (sf.status !== 'ready') continue;\n      const [headings, images] = await Promise.all([\n        storage.loadHeadings(sf.id),\n        storage.loadImages(sf.id),\n      ]);\n      if (headings.length > 0) {\n        const hydratedHeadings = headings.map(sh => deserializeCard(sh, images));\n        const file = deserializeFile(sf, hydratedHeadings);\n        const nuggetId = `migrated-${sf.id}`;\n        const nugget: Nugget = {\n          id: nuggetId,\n          name: sf.name.replace(/\\.\\w+$/, ''),\n          type: 'insights',\n          documents: [file],\n          cards: hydratedHeadings,\n          messages: [],\n          createdAt: now,\n          lastModifiedAt: now,\n        };\n        nuggets.push(nugget);\n\n        await storage.saveNugget(serializeNugget(nugget));\n        await storage.saveNuggetDocument(serializeNuggetDocument(nuggetId, file));\n        const storedH = nugget.cards.map(h => serializeCard(h, nuggetId));\n        await storage.saveNuggetHeadings(nuggetId, storedH);\n        for (const h of nugget.cards) {\n          const imgs = extractImages(h, nuggetId);\n          for (const img of imgs) {\n            await storage.saveNuggetImage(img);\n          }\n        }\n      }\n    }\n\n    // Migrate insights session → insights nugget\n    if (insightsSession) {\n      const nuggetId = `migrated-insights-${insightsSession.id}`;\n      const insightsDocs: UploadedFile[] = insightsSession.documents.map(doc => ({\n        id: doc.id,\n        name: doc.name,\n        size: doc.size,\n        type: doc.type === 'pdf' ? 'application/pdf' : 'text/markdown',\n        lastModified: now,\n        content: doc.content,\n        status: 'ready' as const,\n        progress: 100,\n      }));\n\n      const nugget: Nugget = {\n        id: nuggetId,\n        name: 'Migrated Insights',\n        type: 'insights',\n        documents: insightsDocs,\n        cards: insightsSession.cards,\n        messages: insightsSession.messages,\n        createdAt: now,\n        lastModifiedAt: now,\n      };\n      nuggets.push(nugget);\n\n      await storage.saveNugget(serializeNugget(nugget));\n      for (const doc of insightsDocs) {\n        await storage.saveNuggetDocument(serializeNuggetDocument(nuggetId, doc));\n      }\n      const storedH = nugget.cards.map(h => serializeCard(h, nuggetId));\n      await storage.saveNuggetHeadings(nuggetId, storedH);\n      for (const h of nugget.cards) {\n        const imgs = extractImages(h, nuggetId);\n        for (const img of imgs) {\n          await storage.saveNuggetImage(img);\n        }\n      }\n    }\n\n    console.log(`[Storage] Migrated v1→v3: ${nuggets.length} nuggets created`);\n  }\n\n  // ── Migration: convert any remaining synthesis-type nuggets to insights ──\n  for (const nugget of nuggets) {\n    if ((nugget.type as string) === 'synthesis') {\n      (nugget as any).type = 'insights';\n      if (!nugget.messages) nugget.messages = [];\n      await storage.saveNugget(serializeNugget(nugget));\n    }\n  }\n\n  // ── Reconstitute projects ──\n  let projects: Project[] = storedProjects.map(sp => deserializeProject(sp));\n\n  // ── Migration: existing nuggets but no projects → create default project ──\n  if (projects.length === 0 && nuggets.length > 0) {\n    const now = Date.now();\n    const defaultProject: Project = {\n      id: `project-${now}-${Math.random().toString(36).substr(2, 9)}`,\n      name: 'My Project',\n      nuggetIds: nuggets.map(n => n.id),\n      createdAt: now,\n      lastModifiedAt: now,\n    };\n    projects = [defaultProject];\n    await storage.saveProject(serializeProject(defaultProject));\n    console.log(`[Storage] Migrated nuggets→project: created default \"My Project\" with ${nuggets.length} nuggets`);\n  }\n\n  // ── Startup integrity check: clean up orphaned data ──\n  const hydratedNuggetIds = new Set(nuggets.map(n => n.id));\n  await cleanupOrphanedData(storage, hydratedNuggetIds);\n\n  // Only return state if there's actually data to restore\n  if (!insightsSession && nuggets.length === 0 && !storedTokenUsage) return null;\n\n  return {\n    nuggets,\n    projects,\n    selectedNuggetId: appState?.selectedNuggetId ?? null,\n    selectedDocumentId: appState?.selectedDocumentId ?? null,\n    selectedProjectId: appState?.selectedProjectId ?? null,\n    activeCardId: appState?.activeCardId ?? null,\n    workflowMode: 'insights',\n    insightsSession,\n    tokenUsageTotals: storedTokenUsage as Record<string, number> | undefined,\n    customStyles: (storedCustomStyles as CustomStyle[] | null) ?? undefined,\n  };\n}\n\n// ── Provider component ──\n\nexport const StorageProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const [initialState, setInitialState] = useState<InitialPersistedState | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    hydrateFromStorage()\n      .then(state => {\n        console.log('[Storage] Hydration result:', state ? `${state.nuggets.length} nuggets, ${state.projects.length} projects` : 'null (no data)');\n        if (!cancelled) setInitialState(state);\n      })\n      .catch(err => {\n        console.error('[Storage] Hydration failed, starting fresh:', err);\n      })\n      .finally(() => {\n        if (!cancelled) setLoading(false);\n      });\n\n    return () => { cancelled = true; };\n  }, []);\n\n  if (loading) {\n    return <LoadingScreen />;\n  }\n\n  return (\n    <AppProvider initialState={initialState ?? undefined}>\n      <PersistenceConnector />\n      {children}\n    </AppProvider>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\StyleStudioModal.tsx","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":29,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":29,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":29,"column":66,"nodeType":"Literal","messageId":"noMagic","endLine":29,"endColumn":67},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":35,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":35,"endColumn":54,"fix":{"range":[1025,1037],"text":"{return base;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'while' condition.","line":37,"column":54,"nodeType":"WhileStatement","messageId":"missingCurlyAfterCondition","endLine":37,"endColumn":58,"fix":{"range":[1104,1108],"text":"{i++;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":43,"column":82,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":43,"endColumn":97,"fix":{"range":[1358,1373],"text":"{return desired;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'while' condition.","line":45,"column":103,"nodeType":"WhileStatement","messageId":"missingCurlyAfterCondition","endLine":45,"endColumn":107,"fix":{"range":[1489,1493],"text":"{i++;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":51,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":51,"endColumn":43,"fix":{"range":[1684,1697],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":54,"column":80,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":54,"endColumn":93,"fix":{"range":[1848,1861],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":55,"column":93,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":55,"endColumn":106,"fix":{"range":[1954,1967],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":57,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":57,"endColumn":57,"fix":{"range":[2047,2060],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":116,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":116,"endColumn":29,"fix":{"range":[4234,4241],"text":"{return;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedStyle'. Either include it or remove the dependency array.","line":133,"column":6,"nodeType":"ArrayExpression","endLine":133,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [selectedId, selectedStyle]","fix":{"range":[4878,4890],"text":"[selectedId, selectedStyle]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":139,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":139,"endColumn":41,"fix":{"range":[5191,5200],"text":"{return s;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":148,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":148,"endColumn":56},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":155,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":155,"endColumn":30,"fix":{"range":[5803,5810],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":168,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":168,"endColumn":30,"fix":{"range":[6261,6268],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":181,"column":57,"nodeType":"Literal","messageId":"noMagic","endLine":181,"endColumn":59},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":192,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":192,"endColumn":35,"fix":{"range":[7012,7019],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":231,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":231,"endColumn":30,"fix":{"range":[7958,7965],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":255,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":255,"endColumn":56,"fix":{"range":[8719,8726],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":274,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":274,"endColumn":49,"fix":{"range":[9257,9287],"text":"{return 'Name cannot be empty';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":275,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":275,"endColumn":95,"fix":{"range":[9330,9382],"text":"{return 'This name is reserved for a built-in style';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":279,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":279,"endColumn":73,"fix":{"range":[9517,9571],"text":"{return 'A custom style with this name already exists';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":284,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":284,"endColumn":32,"fix":{"range":[9650,9657],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":316,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":316,"endColumn":29,"fix":{"range":[10548,10555],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":344,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":344,"endColumn":41,"fix":{"range":[11309,11318],"text":"{return s;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":439,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":439,"endColumn":49},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":560,"column":66,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":560,"endColumn":93,"fix":{"range":[25212,25239],"text":"{updatePaletteColor(key, v);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":655,"column":80,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":655,"endColumn":97,"fix":{"range":[31346,31363],"text":"{handleCancelAI();}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":687,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":687,"endColumn":40},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":687,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":687,"endColumn":62,"fix":{"range":[33402,33422],"text":"{setAiDescription(v);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 380.","line":697,"column":82,"nodeType":"Literal","messageId":"noMagic","endLine":697,"endColumn":85},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":732,"column":63,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":732,"endColumn":90,"fix":{"range":[36034,36061],"text":"{setShowCloseConfirm(false);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":33,"fixableErrorCount":0,"fixableWarningCount":25,"source":"\nimport React, { useState, useRef, useEffect, useMemo, useCallback } from 'react';\nimport { createPortal } from 'react-dom';\nimport { CustomStyle, Palette, FontPair } from '../types';\nimport { BUILTIN_STYLE_NAMES, generateStyleWithAI } from '../utils/ai';\n\ninterface StyleStudioModalProps {\n  customStyles: CustomStyle[];\n  onSave: (styles: CustomStyle[]) => void;\n  onClose: () => void;\n}\n\nconst DEFAULT_PALETTE: Palette = {\n  background: '#FFFFFF',\n  primary: '#3B82F6',\n  secondary: '#6B7280',\n  accent: '#F59E0B',\n  text: '#1F2937',\n};\n\nconst DEFAULT_FONTS: FontPair = {\n  primary: 'Inter',\n  secondary: 'Open Sans',\n};\n\nconst PALETTE_KEYS: (keyof Palette)[] = ['background', 'primary', 'secondary', 'accent', 'text'];\n\nfunction generateId(): string {\n  return `cs_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n}\n\nfunction getUniqueNewName(styles: CustomStyle[]): string {\n  const base = 'New Style';\n  const existing = new Set(styles.map(s => s.name.toLowerCase()));\n  if (!existing.has(base.toLowerCase())) return base;\n  let i = 2;\n  while (existing.has(`${base} ${i}`.toLowerCase())) i++;\n  return `${base} ${i}`;\n}\n\nfunction getUniqueName(desired: string, styles: CustomStyle[]): string {\n  const existing = new Set(styles.map(s => s.name.toLowerCase()));\n  if (!existing.has(desired.toLowerCase()) && !BUILTIN_STYLE_NAMES.has(desired)) return desired;\n  let i = 2;\n  while (existing.has(`${desired} ${i}`.toLowerCase()) || BUILTIN_STYLE_NAMES.has(`${desired} ${i}`)) i++;\n  return `${desired} ${i}`;\n}\n\n/** Deep-compare two style arrays to detect any difference */\nfunction stylesEqual(a: CustomStyle[], b: CustomStyle[]): boolean {\n  if (a.length !== b.length) return false;\n  for (let i = 0; i < a.length; i++) {\n    const sa = a[i], sb = b[i];\n    if (sa.id !== sb.id || sa.name !== sb.name || sa.identity !== sb.identity) return false;\n    if (sa.fonts.primary !== sb.fonts.primary || sa.fonts.secondary !== sb.fonts.secondary) return false;\n    for (const k of PALETTE_KEYS) {\n      if (sa.palette[k] !== sb.palette[k]) return false;\n    }\n  }\n  return true;\n}\n\nconst StyleStudioModal: React.FC<StyleStudioModalProps> = ({\n  customStyles,\n  onSave,\n  onClose,\n}) => {\n  // ── Local draft of the entire styles array ──\n  const [draft, setDraft] = useState<CustomStyle[]>(() =>\n    customStyles.map(s => ({ ...s, palette: { ...s.palette }, fonts: { ...s.fonts } }))\n  );\n\n  const [selectedId, setSelectedId] = useState<string | null>(\n    draft.length > 0 ? draft[0].id : null\n  );\n\n  // Editor form state (for the selected style)\n  const [editName, setEditName] = useState('');\n  const [editPalette, setEditPalette] = useState<Palette>({ ...DEFAULT_PALETTE });\n  const [editFonts, setEditFonts] = useState<FontPair>({ ...DEFAULT_FONTS });\n  const [editIdentity, setEditIdentity] = useState('');\n  const [kebabMenuId, setKebabMenuId] = useState<string | null>(null);\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n\n  // Inline name editing state\n  const [editingNameId, setEditingNameId] = useState<string | null>(null);\n  const [editingNameValue, setEditingNameValue] = useState('');\n  const [nameError, setNameError] = useState('');\n  const nameEditRef = useRef<HTMLInputElement>(null);\n\n  // New-style dropdown menu\n  const [showNewMenu, setShowNewMenu] = useState(false);\n  const newMenuRef = useRef<HTMLDivElement>(null);\n\n  // Close confirmation dialog\n  const [showCloseConfirm, setShowCloseConfirm] = useState(false);\n\n  // AI generation dialog state\n  const [showAIDialog, setShowAIDialog] = useState(false);\n  const [aiName, setAiName] = useState('');\n  const [aiDescription, setAiDescription] = useState('');\n  const [aiGenerating, setAiGenerating] = useState(false);\n  const [aiError, setAiError] = useState('');\n  const aiAbortRef = useRef<AbortController | null>(null);\n  const aiNameInputRef = useRef<HTMLInputElement>(null);\n\n  // ── Selected style from draft ──\n  const selectedStyle = useMemo(\n    () => draft.find(s => s.id === selectedId) ?? null,\n    [draft, selectedId]\n  );\n\n  // ── Flush editor fields into draft whenever they change ──\n  // This keeps draft always up-to-date with the editor\n  const flushEditorToDraft = useCallback(() => {\n    if (!selectedId) return;\n    setDraft(prev => prev.map(s =>\n      s.id === selectedId\n        ? { ...s, name: editName.trim() || s.name, palette: { ...editPalette }, fonts: { ...editFonts }, identity: editIdentity.trim(), lastModifiedAt: Date.now() }\n        : s\n    ));\n  }, [selectedId, editName, editPalette, editFonts, editIdentity]);\n\n  // Load selected style into editor fields\n  useEffect(() => {\n    if (selectedStyle) {\n      setEditName(selectedStyle.name);\n      setEditPalette({ ...selectedStyle.palette });\n      setEditFonts({ ...selectedStyle.fonts });\n      setEditIdentity(selectedStyle.identity);\n      setShowDeleteConfirm(false);\n    }\n  }, [selectedId]); // Only reload when selection changes, not when draft updates\n\n  // ── Global change detection: compare draft vs original ──\n  const hasChanges = useMemo(() => {\n    // Build a version of draft with current editor fields merged in\n    const merged = draft.map(s => {\n      if (s.id !== selectedId) return s;\n      return { ...s, name: editName.trim() || s.name, palette: { ...editPalette }, fonts: { ...editFonts }, identity: editIdentity.trim() };\n    });\n    return !stylesEqual(merged, customStyles);\n  }, [draft, customStyles, selectedId, editName, editPalette, editFonts, editIdentity]);\n\n  // Focus inline name input when editing begins\n  useEffect(() => {\n    if (editingNameId) {\n      setTimeout(() => nameEditRef.current?.focus(), 30);\n    }\n  }, [editingNameId]);\n\n  // Close kebab menu on click outside\n  const kebabAreaRef = useRef<HTMLDivElement>(null);\n  useEffect(() => {\n    if (!kebabMenuId) return;\n    const handler = (e: MouseEvent) => {\n      if (kebabAreaRef.current && !kebabAreaRef.current.contains(e.target as Node)) {\n        setKebabMenuId(null);\n        setShowDeleteConfirm(false);\n      }\n    };\n    document.addEventListener('mousedown', handler, true);\n    return () => document.removeEventListener('mousedown', handler, true);\n  }, [kebabMenuId]);\n\n  // Close new-style menu on click outside\n  useEffect(() => {\n    if (!showNewMenu) return;\n    const handler = (e: MouseEvent) => {\n      if (newMenuRef.current && !newMenuRef.current.contains(e.target as Node)) {\n        setShowNewMenu(false);\n      }\n    };\n    document.addEventListener('mousedown', handler, true);\n    return () => document.removeEventListener('mousedown', handler, true);\n  }, [showNewMenu]);\n\n  // Focus AI name input when dialog opens\n  useEffect(() => {\n    if (showAIDialog) {\n      setTimeout(() => aiNameInputRef.current?.focus(), 50);\n    }\n  }, [showAIDialog]);\n\n  // Cleanup abort controller on unmount\n  useEffect(() => {\n    return () => { aiAbortRef.current?.abort(); };\n  }, []);\n\n  // ── Flush editor before switching selection ──\n  const selectStyle = (id: string) => {\n    if (id === selectedId) return;\n    flushEditorToDraft();\n    setSelectedId(id);\n    setKebabMenuId(null);\n    setShowDeleteConfirm(false);\n  };\n\n  // ── Actions ──\n\n  const handleNew = () => {\n    setShowNewMenu(false);\n    flushEditorToDraft();\n    const now = Date.now();\n    const newStyle: CustomStyle = {\n      id: generateId(),\n      name: getUniqueNewName(draft),\n      palette: { ...DEFAULT_PALETTE },\n      fonts: { ...DEFAULT_FONTS },\n      identity: '',\n      createdAt: now,\n      lastModifiedAt: now,\n    };\n    setDraft(prev => [...prev, newStyle]);\n    setSelectedId(newStyle.id);\n    setEditingNameId(newStyle.id);\n    setEditingNameValue(newStyle.name);\n    setNameError('');\n  };\n\n  const openAIDialog = () => {\n    setShowNewMenu(false);\n    setShowAIDialog(true);\n    setAiName('');\n    setAiDescription('');\n    setAiError('');\n  };\n\n  const handleAIGenerate = useCallback(async () => {\n    const trimmedName = aiName.trim();\n    if (!trimmedName) return;\n\n    setAiGenerating(true);\n    setAiError('');\n    const controller = new AbortController();\n    aiAbortRef.current = controller;\n\n    try {\n      const result = await generateStyleWithAI(trimmedName, aiDescription, controller.signal);\n      const now = Date.now();\n      const newStyle: CustomStyle = {\n        id: generateId(),\n        name: getUniqueName(trimmedName, draft),\n        palette: result.palette,\n        fonts: result.fonts,\n        identity: result.identity,\n        createdAt: now,\n        lastModifiedAt: now,\n      };\n      flushEditorToDraft();\n      setDraft(prev => [...prev, newStyle]);\n      setSelectedId(newStyle.id);\n      setShowAIDialog(false);\n    } catch (err: unknown) {\n      if ((err as Error).name === 'AbortError') return;\n      setAiError(err instanceof Error ? err.message : 'Generation failed');\n    } finally {\n      setAiGenerating(false);\n      aiAbortRef.current = null;\n    }\n  }, [aiName, aiDescription, draft, flushEditorToDraft]);\n\n  const handleCancelAI = () => {\n    aiAbortRef.current?.abort();\n    setShowAIDialog(false);\n    setAiName('');\n    setAiDescription('');\n    setAiError('');\n    setAiGenerating(false);\n  };\n\n  const validateName = (name: string, forId: string): string => {\n    const trimmed = name.trim();\n    if (!trimmed) return 'Name cannot be empty';\n    if (BUILTIN_STYLE_NAMES.has(trimmed)) return 'This name is reserved for a built-in style';\n    const conflict = draft.find(\n      s => s.name.toLowerCase() === trimmed.toLowerCase() && s.id !== forId\n    );\n    if (conflict) return 'A custom style with this name already exists';\n    return '';\n  };\n\n  const commitNameEdit = () => {\n    if (!editingNameId) return;\n    const error = validateName(editingNameValue, editingNameId);\n    if (error) {\n      setNameError(error);\n      return;\n    }\n    if (editingNameId === selectedId) {\n      setEditName(editingNameValue.trim());\n    } else {\n      // Editing a non-selected style name — update draft directly\n      setDraft(prev => prev.map(s =>\n        s.id === editingNameId ? { ...s, name: editingNameValue.trim(), lastModifiedAt: Date.now() } : s\n      ));\n    }\n    setEditingNameId(null);\n    setEditingNameValue('');\n    setNameError('');\n  };\n\n  const cancelNameEdit = () => {\n    setEditingNameId(null);\n    setEditingNameValue('');\n    setNameError('');\n  };\n\n  const startNameEdit = (style: CustomStyle) => {\n    setEditingNameId(style.id);\n    setEditingNameValue(style.id === selectedId ? editName : style.name);\n    setNameError('');\n  };\n\n  const handleDelete = () => {\n    if (!selectedId) return;\n    const remaining = draft.filter(s => s.id !== selectedId);\n    setDraft(remaining);\n    setShowDeleteConfirm(false);\n    setKebabMenuId(null);\n    setSelectedId(remaining.length > 0 ? remaining[0].id : null);\n  };\n\n  const handleClose = () => {\n    if (hasChanges) {\n      setShowCloseConfirm(true);\n    } else {\n      onClose();\n    }\n  };\n\n  const handleSaveAndClose = () => {\n    // Validate current editor name if a style is selected\n    if (selectedId) {\n      const error = validateName(editName, selectedId);\n      if (error) {\n        setNameError(error);\n        setShowCloseConfirm(false);\n        return;\n      }\n    }\n    // Build final array with editor fields merged in\n    const final = draft.map(s => {\n      if (s.id !== selectedId) return s;\n      return { ...s, name: editName.trim(), palette: { ...editPalette }, fonts: { ...editFonts }, identity: editIdentity.trim(), lastModifiedAt: Date.now() };\n    });\n    onSave(final);\n    onClose();\n  };\n\n  const handleDiscardAndClose = () => {\n    onClose();\n  };\n\n  const updatePaletteColor = (key: keyof Palette, value: string) => {\n    setEditPalette(prev => ({ ...prev, [key]: value }));\n  };\n\n  return createPortal(\n    <div className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60 animate-in fade-in duration-300\">\n      <div\n        className=\"w-full max-w-2xl bg-white dark:bg-zinc-900 rounded-[40px] shadow-2xl dark:shadow-black/30 border border-zinc-100 dark:border-zinc-700 animate-in zoom-in-95 duration-300 flex flex-col\"\n        style={{ maxHeight: 'calc(100vh - 80px)' }}\n      >\n        {/* Header */}\n        <div className=\"flex items-center justify-between px-10 pt-8 pb-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 flex items-center justify-center\">\n              <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-800 dark:text-zinc-200\">\n                <path d=\"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z\" />\n                <circle cx=\"13.5\" cy=\"6.5\" r=\".5\" fill=\"currentColor\" />\n                <circle cx=\"17.5\" cy=\"10.5\" r=\".5\" fill=\"currentColor\" />\n                <circle cx=\"6.5\" cy=\"12.5\" r=\".5\" fill=\"currentColor\" />\n                <circle cx=\"8.5\" cy=\"7.5\" r=\".5\" fill=\"currentColor\" />\n              </svg>\n            </div>\n            <div>\n              <h2 className=\"text-[15px] font-black tracking-tight text-zinc-800 dark:text-zinc-200\">Style Studio</h2>\n              <p className=\"text-[10px] text-zinc-400 dark:text-zinc-500 font-light\">Create custom visual styles for card generation</p>\n            </div>\n          </div>\n          <button\n            onClick={handleClose}\n            className=\"w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300\"\n          >\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" /><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Body */}\n        <div className=\"flex flex-1 min-h-0 px-10 pb-8 gap-6\">\n          {/* Left sidebar: style list */}\n          <div className=\"w-44 shrink-0 flex flex-col gap-2\">\n            {/* + New Style button with dropdown */}\n            <div className=\"relative\" ref={newMenuRef}>\n              <button\n                onClick={() => setShowNewMenu(prev => !prev)}\n                className=\"text-left px-1.5 py-1 text-[11px] text-accent-blue font-medium border border-transparent hover:border-blue-300 transition-all\"\n              >\n                + New Style\n              </button>\n              {showNewMenu && (\n                <div className=\"absolute left-0 top-full mt-1 z-50 rounded-lg py-1 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-lg dark:shadow-black/30 animate-in fade-in slide-in-from-top-2 duration-150 min-w-[160px]\">\n                  <button\n                    onClick={handleNew}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium rounded-lg whitespace-nowrap text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n                  >\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M13 21h8\"/><path d=\"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z\"/></svg>\n                    Create Manually\n                  </button>\n                  <button\n                    onClick={openAIDialog}\n                    className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium rounded-lg whitespace-nowrap text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n                  >\n                    <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z\"/></svg>\n                    Generate with AI\n                  </button>\n                </div>\n              )}\n            </div>\n\n            <div className=\"flex-1 overflow-y-auto pr-1\" style={{ maxHeight: '520px' }}>\n              {draft.map(style => {\n                const isSelected = selectedId === style.id;\n                const isKebabOpen = kebabMenuId === style.id;\n                const isEditingName = editingNameId === style.id;\n                return (\n                  <div key={style.id} className=\"relative\" ref={isKebabOpen ? kebabAreaRef : undefined}>\n                    <div\n                      onClick={() => selectStyle(style.id)}\n                      className={`group relative flex items-center gap-1.5 px-1.5 py-1 cursor-pointer select-none transition-all duration-150 ${\n                        isSelected ? 'sidebar-node-active' : 'border border-transparent hover:border-blue-300'\n                      }`}\n                    >\n                      {/* Mini palette preview */}\n                      <div className=\"flex gap-0.5 shrink-0\">\n                        {PALETTE_KEYS.slice(0, 3).map(k => (\n                          <div\n                            key={k}\n                            className=\"w-2.5 h-2.5 rounded-full ring-[1.5px] ring-black/20 dark:ring-white/40\"\n                            style={{ backgroundColor: isSelected ? editPalette[k] : style.palette[k] }}\n                          />\n                        ))}\n                      </div>\n                      {/* Inline name: editable or static */}\n                      {isEditingName ? (\n                        <input\n                          ref={nameEditRef}\n                          type=\"text\"\n                          value={editingNameValue}\n                          onChange={(e) => { setEditingNameValue(e.target.value); setNameError(''); }}\n                          onKeyDown={(e) => {\n                            if (e.key === 'Enter') { e.preventDefault(); commitNameEdit(); }\n                            if (e.key === 'Escape') { e.preventDefault(); cancelNameEdit(); }\n                          }}\n                          onBlur={commitNameEdit}\n                          onClick={(e) => e.stopPropagation()}\n                          className={`flex-1 min-w-0 text-[11px] text-zinc-700 dark:text-zinc-300 bg-transparent border-b ${nameError ? 'border-red-400' : 'border-zinc-400'} outline-none px-0 py-0`}\n                          spellCheck={false}\n                        />\n                      ) : (\n                        <span\n                          className=\"text-[11px] text-zinc-700 dark:text-zinc-300 truncate flex-1 min-w-0\"\n                          onDoubleClick={(e) => { e.stopPropagation(); startNameEdit(style); }}\n                        >\n                          {isSelected ? editName : style.name}\n                        </span>\n                      )}\n                      {/* Kebab */}\n                      {!isEditingName && (\n                        <button\n                          onClick={(e) => { e.stopPropagation(); setKebabMenuId(isKebabOpen ? null : style.id); setShowDeleteConfirm(false); }}\n                          className={`shrink-0 w-5 h-5 flex items-center justify-center rounded transition-opacity text-zinc-400 dark:text-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300 ${\n                            isKebabOpen ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'\n                          }`}\n                        >\n                          <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><circle cx=\"12\" cy=\"5\" r=\"2\"/><circle cx=\"12\" cy=\"12\" r=\"2\"/><circle cx=\"12\" cy=\"19\" r=\"2\"/></svg>\n                        </button>\n                      )}\n                    </div>\n                    {/* Name validation error tooltip */}\n                    {isEditingName && nameError && (\n                      <p className=\"text-[9px] text-red-500 font-medium px-1.5 mt-0.5\">{nameError}</p>\n                    )}\n                    {isKebabOpen && (\n                      <div className=\"absolute right-0 top-full mt-1 z-50 rounded-lg py-1 px-1 border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-lg dark:shadow-black/30 animate-in fade-in slide-in-from-top-2 duration-150 min-w-[120px]\">\n                        {showDeleteConfirm ? (\n                          <div className=\"px-2 py-1.5 space-y-1.5\">\n                            <p className=\"text-[10px] text-zinc-500 dark:text-zinc-400 font-medium\">Delete this style?</p>\n                            <div className=\"flex gap-1.5\">\n                              <button\n                                onClick={(e) => { e.stopPropagation(); handleDelete(); }}\n                                className=\"flex-1 py-1.5 rounded-lg bg-red-500 text-white text-[9px] font-black uppercase tracking-widest hover:bg-red-600 transition-all\"\n                              >\n                                Delete\n                              </button>\n                              <button\n                                onClick={(e) => { e.stopPropagation(); setShowDeleteConfirm(false); setKebabMenuId(null); }}\n                                className=\"flex-1 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800/50 text-zinc-600 dark:text-zinc-400 text-[9px] font-black uppercase tracking-widest hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-all\"\n                              >\n                                Cancel\n                              </button>\n                            </div>\n                          </div>\n                        ) : (\n                          <>\n                            <button\n                              onClick={(e) => { e.stopPropagation(); setKebabMenuId(null); startNameEdit(style); }}\n                              className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium rounded-lg whitespace-nowrap text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n                            >\n                              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/></svg>\n                              Rename\n                            </button>\n                            <button\n                              onClick={(e) => { e.stopPropagation(); setSelectedId(style.id); setShowDeleteConfirm(true); }}\n                              className=\"flex items-center gap-2 w-full text-left px-3 py-1.5 text-[11px] font-medium rounded-lg whitespace-nowrap text-red-500 hover:bg-red-50 transition-colors\"\n                            >\n                              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/></svg>\n                              Delete\n                            </button>\n                          </>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n              {draft.length === 0 && (\n                <p className=\"text-[10px] text-zinc-400 dark:text-zinc-500 text-center py-6 font-light\">\n                  No custom styles yet\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Right panel: editor */}\n          <div className=\"flex-1 min-w-0 overflow-y-auto\" style={{ maxHeight: '520px' }}>\n            {selectedId ? (\n              <div className=\"space-y-5\">\n                {/* Palette */}\n                <div className=\"space-y-1.5\">\n                  <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Color Palette</label>\n                  <div className=\"grid grid-cols-5 gap-2\">\n                    {PALETTE_KEYS.map(key => (\n                      <div key={key} className=\"space-y-1\">\n                        <div className=\"flex items-center gap-1.5\">\n                          <input\n                            type=\"color\"\n                            value={editPalette[key]}\n                            onChange={(e) => updatePaletteColor(key, e.target.value)}\n                            className=\"w-7 h-7 rounded-lg cursor-pointer border-0 p-0 bg-transparent\"\n                          />\n                          <input\n                            type=\"text\"\n                            value={editPalette[key]}\n                            onChange={(e) => {\n                              const v = e.target.value;\n                              if (/^#[0-9A-Fa-f]{0,6}$/.test(v)) updatePaletteColor(key, v);\n                            }}\n                            className=\"w-full text-[10px] font-mono font-medium text-zinc-600 dark:text-zinc-400 bg-zinc-50 dark:bg-zinc-800 rounded-lg px-1.5 py-1 border border-zinc-200 dark:border-zinc-700 focus:outline-none focus:border-zinc-400 uppercase\"\n                            spellCheck={false}\n                          />\n                        </div>\n                        <p className=\"text-[8px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider text-center\">{key}</p>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Fonts */}\n                <div className=\"space-y-1.5\">\n                  <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Fonts</label>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <div className=\"space-y-1\">\n                      <input\n                        type=\"text\"\n                        value={editFonts.primary}\n                        onChange={(e) => setEditFonts(prev => ({ ...prev, primary: e.target.value }))}\n                        placeholder=\"Title font\"\n                        className=\"w-full px-3 py-2 rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-400\"\n                      />\n                      <p className=\"text-[8px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider text-center\">Title</p>\n                    </div>\n                    <div className=\"space-y-1\">\n                      <input\n                        type=\"text\"\n                        value={editFonts.secondary}\n                        onChange={(e) => setEditFonts(prev => ({ ...prev, secondary: e.target.value }))}\n                        placeholder=\"Body font\"\n                        className=\"w-full px-3 py-2 rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-400\"\n                      />\n                      <p className=\"text-[8px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider text-center\">Body</p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Identity */}\n                <div className=\"space-y-1.5\">\n                  <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Visual Identity</label>\n                  <textarea\n                    value={editIdentity}\n                    onChange={(e) => setEditIdentity(e.target.value)}\n                    placeholder=\"Describe the visual aesthetic — e.g. 'Clean corporate look with bold orange accents, modular card layout, flat charts with minimal gridlines...'\"\n                    rows={4}\n                    className=\"w-full px-4 py-3 rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-400 resize-none leading-relaxed\"\n                  />\n                  <p className=\"text-[9px] text-zinc-400 dark:text-zinc-500 font-light\">This description drives the visual generation. Be specific about shapes, textures, layout, and mood.</p>\n                </div>\n\n                {/* Preview strip */}\n                <div className=\"flex items-center gap-2 px-1\">\n                  <span className=\"text-[8px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider shrink-0\">Preview</span>\n                  <div className=\"flex gap-1.5\">\n                    {PALETTE_KEYS.map(key => (\n                      <div\n                        key={key}\n                        className=\"w-8 h-8 rounded-xl ring-[1.5px] ring-black/20 dark:ring-white/40 transition-colors\"\n                        style={{ backgroundColor: editPalette[key] }}\n                        title={`${key}: ${editPalette[key]}`}\n                      />\n                    ))}\n                  </div>\n                  <div className=\"ml-3 text-[10px] text-zinc-500 dark:text-zinc-400\">\n                    <span style={{ fontFamily: editFonts.primary }}>{editFonts.primary}</span>\n                    <span className=\"text-zinc-300 dark:text-zinc-600 mx-1\">/</span>\n                    <span style={{ fontFamily: editFonts.secondary }}>{editFonts.secondary}</span>\n                  </div>\n                </div>\n\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center h-full text-center py-16\">\n                <svg width=\"40\" height=\"40\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-200 dark:text-zinc-700 mb-4\">\n                  <path d=\"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z\" />\n                  <circle cx=\"13.5\" cy=\"6.5\" r=\".5\" fill=\"currentColor\" />\n                  <circle cx=\"17.5\" cy=\"10.5\" r=\".5\" fill=\"currentColor\" />\n                  <circle cx=\"6.5\" cy=\"12.5\" r=\".5\" fill=\"currentColor\" />\n                  <circle cx=\"8.5\" cy=\"7.5\" r=\".5\" fill=\"currentColor\" />\n                </svg>\n                <p className=\"text-xs text-zinc-400 dark:text-zinc-500 font-light\">\n                  Click <strong className=\"font-bold\">+ New Style</strong> to create your first custom style\n                </p>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* AI Generation Dialog — overlays the Style Studio */}\n      {showAIDialog && (\n        <div\n          className=\"fixed inset-0 z-[130] flex items-center justify-center bg-black/30 dark:bg-black/50 animate-in fade-in duration-200\"\n          onClick={(e) => { if (e.target === e.currentTarget && !aiGenerating) handleCancelAI(); }}\n        >\n          <div className=\"w-full max-w-md bg-white dark:bg-zinc-900 rounded-[32px] shadow-2xl dark:shadow-black/30 border border-zinc-100 dark:border-zinc-700 animate-in zoom-in-95 duration-200 p-8\">\n            <div className=\"flex items-center gap-3 mb-6\">\n              <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-800 dark:text-zinc-200 shrink-0\">\n                <path d=\"M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83\"/>\n              </svg>\n              <h3 className=\"text-[14px] font-black tracking-tight text-zinc-800 dark:text-zinc-200\">Generate Style with AI</h3>\n            </div>\n\n            <div className=\"space-y-4\">\n              {/* Name */}\n              <div className=\"space-y-1.5\">\n                <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Style Name</label>\n                <input\n                  ref={aiNameInputRef}\n                  type=\"text\"\n                  value={aiName}\n                  onChange={(e) => setAiName(e.target.value)}\n                  placeholder=\"e.g. Art Deco\"\n                  disabled={aiGenerating}\n                  className=\"w-full px-4 py-2.5 rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-400 disabled:opacity-50\"\n                />\n              </div>\n\n              {/* Description */}\n              <div className=\"space-y-1.5\">\n                <label className=\"text-[9px] font-black uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Description</label>\n                <textarea\n                  value={aiDescription}\n                  onChange={(e) => {\n                    const v = e.target.value;\n                    if (v.length <= 400) setAiDescription(v);\n                  }}\n                  placeholder=\"Describe anything about the style you want — colors, fonts, mood, era, aesthetic... or leave blank and let the AI decide based on the name.\"\n                  rows={4}\n                  maxLength={400}\n                  disabled={aiGenerating}\n                  className=\"w-full px-4 py-3 rounded-2xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 text-xs text-zinc-800 dark:text-zinc-200 focus:outline-none focus:border-black transition-colors placeholder:text-zinc-400 resize-none leading-relaxed disabled:opacity-50\"\n                />\n                <div className=\"flex items-center justify-between\">\n                  <p className=\"text-[9px] text-zinc-400 dark:text-zinc-500 font-light\">The AI will use whatever you provide and fill in the rest.</p>\n                  <p className={`text-[9px] font-medium ${aiDescription.length > 380 ? 'text-amber-500' : 'text-zinc-300 dark:text-zinc-600'}`}>{aiDescription.length}/400</p>\n                </div>\n              </div>\n\n              {/* Error */}\n              {aiError && (\n                <p className=\"text-[10px] text-red-500 font-medium\">{aiError}</p>\n              )}\n\n              {/* Actions */}\n              <div className=\"flex items-center gap-2 pt-2\">\n                <button\n                  onClick={handleAIGenerate}\n                  disabled={!aiName.trim() || aiGenerating}\n                  className=\"flex-1 py-3 rounded-full bg-black text-white text-[9px] font-black uppercase tracking-widest hover:bg-zinc-800 transition-all active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed\"\n                >\n                  {aiGenerating ? 'Generating...' : 'Generate'}\n                </button>\n                <button\n                  onClick={handleCancelAI}\n                  disabled={aiGenerating}\n                  className=\"py-3 px-6 rounded-full bg-zinc-50 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 text-[9px] font-black uppercase tracking-widest hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-all active:scale-95 disabled:opacity-40\"\n                >\n                  Cancel\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Unsaved changes confirmation dialog */}\n      {showCloseConfirm && (\n        <div\n          className=\"fixed inset-0 z-[130] flex items-center justify-center bg-black/30 dark:bg-black/50 animate-in fade-in duration-200\"\n          onClick={(e) => { if (e.target === e.currentTarget) setShowCloseConfirm(false); }}\n        >\n          <div className=\"w-full max-w-xs bg-white dark:bg-zinc-900 rounded-[24px] shadow-2xl dark:shadow-black/30 border border-zinc-100 dark:border-zinc-700 animate-in zoom-in-95 duration-200 p-6\">\n            <h3 className=\"text-[13px] font-black tracking-tight text-zinc-800 dark:text-zinc-200 mb-1\">Unsaved Changes</h3>\n            <p className=\"text-[11px] text-zinc-500 dark:text-zinc-400 font-light mb-5\">You have unsaved changes to your styles. What would you like to do?</p>\n            <div className=\"flex flex-col gap-2\">\n              <button\n                onClick={handleSaveAndClose}\n                className=\"w-full py-2.5 rounded-full bg-black text-white text-[9px] font-black uppercase tracking-widest hover:bg-zinc-800 transition-all active:scale-95\"\n              >\n                Save\n              </button>\n              <button\n                onClick={handleDiscardAndClose}\n                className=\"w-full py-2.5 rounded-full bg-zinc-100 dark:bg-zinc-800/50 text-zinc-600 dark:text-zinc-400 text-[9px] font-black uppercase tracking-widest hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-all active:scale-95\"\n              >\n                Discard\n              </button>\n              <button\n                onClick={() => setShowCloseConfirm(false)}\n                className=\"w-full py-2.5 rounded-full text-zinc-400 dark:text-zinc-500 text-[9px] font-black uppercase tracking-widest hover:text-zinc-600 dark:hover:text-zinc-300 transition-all active:scale-95\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>,\n    document.body\n  );\n};\n\nexport default StyleStudioModal;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\SubjectEditModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'subject'. Either include it or remove the dependency array.","line":41,"column":6,"nodeType":"ArrayExpression","endLine":41,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [currentSubject, isRegenerating, subject]","fix":{"range":[1158,1190],"text":"[currentSubject, isRegenerating, subject]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport React, { useState, useRef, useEffect } from 'react';\nimport { createPortal } from 'react-dom';\n\ninterface SubjectEditModalProps {\n  nuggetId: string;\n  nuggetName: string;\n  currentSubject: string;\n  isRegenerating?: boolean;\n  onSave: (nuggetId: string, subject: string) => void;\n  onRegenerate: (nuggetId: string) => void;\n  onClose: () => void;\n}\n\nexport const SubjectEditModal: React.FC<SubjectEditModalProps> = ({\n  nuggetId,\n  nuggetName,\n  currentSubject,\n  isRegenerating = false,\n  onSave,\n  onRegenerate,\n  onClose,\n}) => {\n  const [subject, setSubject] = useState(currentSubject);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  useEffect(() => {\n    textareaRef.current?.focus();\n    // Place cursor at end\n    if (textareaRef.current) {\n      textareaRef.current.selectionStart = textareaRef.current.value.length;\n      textareaRef.current.selectionEnd = textareaRef.current.value.length;\n    }\n  }, []);\n\n  // Update local state when regeneration completes (currentSubject changes externally)\n  useEffect(() => {\n    if (currentSubject !== subject && isRegenerating === false) {\n      setSubject(currentSubject);\n    }\n  }, [currentSubject, isRegenerating]);\n\n  const hasChanged = subject.trim() !== currentSubject;\n  const isEmpty = subject.trim() === '';\n\n  const handleSave = () => {\n    if (!isEmpty) {\n      onSave(nuggetId, subject.trim());\n    }\n    onClose();\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSave();\n    }\n    if (e.key === 'Escape') {\n      onClose();\n    }\n  };\n\n  return createPortal(\n    <div\n      className=\"fixed inset-0 z-[120] flex items-center justify-center bg-black/50 dark:bg-black/60\"\n      onClick={onClose}\n    >\n      <div\n        className=\"bg-white dark:bg-zinc-900 rounded-[24px] shadow-2xl dark:shadow-black/30 w-full max-w-lg mx-4 overflow-hidden\"\n        onClick={(e) => e.stopPropagation()}\n      >\n        {/* Header */}\n        <div className=\"px-6 pt-6 pb-3\">\n          <h2 className=\"text-sm font-bold text-zinc-800 dark:text-zinc-200 tracking-tight\">Subject</h2>\n          <p className=\"text-[11px] text-zinc-400 dark:text-zinc-500 mt-1 truncate\">{nuggetName}</p>\n        </div>\n\n        {/* Body */}\n        <div className=\"px-6 pb-5 space-y-3\">\n          <div className=\"space-y-1.5\">\n            <label className=\"text-[11px] font-medium text-zinc-500 dark:text-zinc-400\">\n              Topic sentence used to prime AI as a domain expert\n            </label>\n            <textarea\n              ref={textareaRef}\n              value={subject}\n              onChange={(e) => setSubject(e.target.value)}\n              onKeyDown={handleKeyDown}\n              rows={3}\n              disabled={isRegenerating}\n              className=\"w-full px-3 py-2.5 text-xs border border-zinc-200 dark:border-zinc-600 rounded-lg focus:outline-none focus:border-zinc-400 dark:bg-zinc-800 dark:text-zinc-100 resize-none disabled:opacity-50 disabled:cursor-not-allowed\"\n              placeholder=\"e.g. Quarterly financial performance analysis for a mid-cap technology company covering revenue, margins, and growth projections.\"\n            />\n            <p className=\"text-[10px] text-zinc-400 dark:text-zinc-500\">\n              This sentence helps the AI apply relevant domain expertise across all content generation. Keep it specific and descriptive (15-40 words).\n            </p>\n          </div>\n\n          {isRegenerating && (\n            <div className=\"flex items-center gap-2 text-[11px] text-zinc-500 dark:text-zinc-400\">\n              <svg className=\"animate-spin h-3.5 w-3.5\" viewBox=\"0 0 24 24\" fill=\"none\">\n                <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"3\" />\n                <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z\" />\n              </svg>\n              Regenerating from documents...\n            </div>\n          )}\n        </div>\n\n        {/* Footer */}\n        <div className=\"px-6 pb-6 flex items-center justify-between\">\n          <button\n            onClick={() => onRegenerate(nuggetId)}\n            disabled={isRegenerating}\n            className=\"text-xs font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200 transition-colors disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1.5\"\n          >\n            <svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2\" />\n            </svg>\n            Regenerate\n          </button>\n          <div className=\"flex items-center gap-2\">\n            <button\n              onClick={onClose}\n              className=\"px-4 py-2 text-xs font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors\"\n            >\n              Cancel\n            </button>\n            <button\n              onClick={handleSave}\n              disabled={isEmpty || isRegenerating}\n              className=\"bg-black dark:bg-zinc-100 text-white dark:text-zinc-900 rounded-lg px-5 py-2 text-xs font-medium hover:bg-zinc-800 dark:hover:bg-zinc-200 transition-colors disabled:opacity-40 disabled:cursor-not-allowed\"\n            >\n              {hasChanged ? 'Save' : 'Close'}\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>,\n    document.body\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\ToastNotification.tsx","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 250.","line":40,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":40,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6000.","line":44,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":44,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6000.","line":74,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":74,"endColumn":43},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":75,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":75,"endColumn":66,"fix":{"range":[3282,3326],"text":"{timerRef.current = setTimeout(dismiss, dur);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import React, { useState, useCallback, useRef, useEffect, createContext, useContext } from 'react';\nimport { createPortal } from 'react-dom';\n\n// ── Toast types ──\n\ninterface Toast {\n  id: string;\n  type: 'error' | 'warning' | 'info' | 'success';\n  message: string;\n  /** Optional sub-message (e.g. retry progress) */\n  detail?: string;\n  /** If provided, renders a retry button that calls this */\n  onRetry?: () => void;\n  /** Auto-dismiss after this many ms (0 = manual dismiss only). Default: 6000 */\n  duration?: number;\n}\n\ninterface ToastContextValue {\n  addToast: (toast: Omit<Toast, 'id'>) => string;\n  removeToast: (id: string) => void;\n  updateToast: (id: string, updates: Partial<Omit<Toast, 'id'>>) => void;\n}\n\nconst ToastContext = createContext<ToastContextValue>({\n  addToast: () => '',\n  removeToast: () => {},\n  updateToast: () => {},\n});\n\nexport const useToast = () => useContext(ToastContext);\n\n// ── Single toast item ──\n\nconst ToastItem: React.FC<{ toast: Toast; onDismiss: () => void }> = ({ toast, onDismiss }) => {\n  const [exiting, setExiting] = useState(false);\n  const timerRef = useRef<ReturnType<typeof setTimeout>>(undefined);\n\n  const dismiss = useCallback(() => {\n    setExiting(true);\n    setTimeout(onDismiss, 250);\n  }, [onDismiss]);\n\n  useEffect(() => {\n    const dur = toast.duration ?? 6000;\n    if (dur > 0) {\n      timerRef.current = setTimeout(dismiss, dur);\n      return () => clearTimeout(timerRef.current);\n    }\n  }, [toast.duration, dismiss]);\n\n  const colors = {\n    error:   { bg: 'bg-red-50 dark:bg-red-950', border: 'border-red-200 dark:border-red-800', text: 'text-red-700 dark:text-red-300', icon: '#E63946' },\n    warning: { bg: 'bg-amber-50 dark:bg-amber-950', border: 'border-amber-200 dark:border-amber-800', text: 'text-amber-700 dark:text-amber-300', icon: '#D97706' },\n    info:    { bg: 'bg-blue-50 dark:bg-blue-950', border: 'border-blue-200 dark:border-blue-800', text: 'text-blue-700 dark:text-blue-300', icon: '#2563EB' },\n    success: { bg: 'bg-emerald-50 dark:bg-emerald-950', border: 'border-emerald-200 dark:border-emerald-800', text: 'text-emerald-700 dark:text-emerald-300', icon: '#059669' },\n  }[toast.type];\n\n  const icons = {\n    error: <><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/><line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/></>,\n    warning: <><path d=\"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z\"/><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/></>,\n    info: <><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"/><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"/></>,\n    success: <><path d=\"M22 11.08V12a10 10 0 11-5.93-9.14\"/><polyline points=\"22 4 12 14.01 9 11.01\"/></>,\n  }[toast.type];\n\n  return (\n    <div\n      className={`\n        ${colors.bg} ${colors.border} border rounded-2xl px-4 py-2.5 shadow-lg dark:shadow-black/30\n        flex items-start gap-2.5 max-w-[420px] min-w-[300px]\n        ${exiting ? 'animate-out fade-out slide-out-to-top-2 duration-250' : 'animate-in fade-in slide-in-from-top-2 duration-300'}\n      `}\n      onMouseEnter={() => timerRef.current && clearTimeout(timerRef.current)}\n      onMouseLeave={() => {\n        const dur = toast.duration ?? 6000;\n        if (dur > 0) timerRef.current = setTimeout(dismiss, dur);\n      }}\n    >\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={colors.icon} strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"mt-0.5 shrink-0\">\n        {icons}\n      </svg>\n\n      <div className=\"flex-1 min-w-0\">\n        <p className={`text-[11px] font-medium ${colors.text} leading-snug`}>{toast.message}</p>\n        {toast.detail && (\n          <p className={`text-[10px] ${colors.text} opacity-70 mt-0.5`}>{toast.detail}</p>\n        )}\n        {toast.onRetry && (\n          <button\n            onClick={toast.onRetry}\n            className={`mt-1.5 text-[10px] font-bold ${colors.text} underline underline-offset-2 hover:opacity-80 transition-opacity`}\n          >\n            Retry Now\n          </button>\n        )}\n      </div>\n\n      <button onClick={dismiss} className={`${colors.text} opacity-50 hover:opacity-100 transition-opacity mt-0.5 shrink-0`}>\n        <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n          <path d=\"M18 6L6 18M6 6l12 12\"/>\n        </svg>\n      </button>\n    </div>\n  );\n};\n\n// ── Toast Provider + Container ──\n\nexport const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const [toasts, setToasts] = useState<Toast[]>([]);\n  const counterRef = useRef(0);\n\n  const addToast = useCallback((toast: Omit<Toast, 'id'>): string => {\n    const id = `toast-${++counterRef.current}`;\n    setToasts(prev => [...prev, { ...toast, id }]);\n    return id;\n  }, []);\n\n  const removeToast = useCallback((id: string) => {\n    setToasts(prev => prev.filter(t => t.id !== id));\n  }, []);\n\n  const updateToast = useCallback((id: string, updates: Partial<Omit<Toast, 'id'>>) => {\n    setToasts(prev => prev.map(t => t.id === id ? { ...t, ...updates } : t));\n  }, []);\n\n  return (\n    <ToastContext.Provider value={{ addToast, removeToast, updateToast }}>\n      {children}\n      {createPortal(\n        <div className=\"fixed top-4 left-1/2 -translate-x-1/2 z-[9999] flex flex-col items-center gap-2 pointer-events-none\">\n          {toasts.map(toast => (\n            <div key={toast.id} className=\"pointer-events-auto\">\n              <ToastItem toast={toast} onDismiss={() => removeToast(toast.id)} />\n            </div>\n          ))}\n        </div>,\n        document.body,\n      )}\n    </ToastContext.Provider>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\ZoomOverlay.tsx","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":28,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":28,"endColumn":58,"fix":{"range":[1198,1228],"text":"{return { panX: px, panY: py };}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":38,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":38,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":39,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":39,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":40,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":40,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":41,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":41,"endColumn":31},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":51,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":51,"endColumn":41,"fix":{"range":[2159,2169],"text":"{onClose();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":67,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":67,"endColumn":27,"fix":{"range":[2688,2695],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":90,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":90,"endColumn":38,"fix":{"range":[3621,3628],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":93,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":93,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":93,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":93,"endColumn":45},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":93,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":93,"endColumn":72,"fix":{"range":[3775,3800],"text":"{didPanRef.current = true;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":111,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":111,"endColumn":27,"fix":{"range":[4435,4442],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":127,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":127,"endColumn":49,"fix":{"range":[5080,5090],"text":"{onClose();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":130,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":130,"endColumn":40,"fix":{"range":[5136,5148],"text":"{return null;}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":8,"source":"import React, { useState, useRef, useCallback, useEffect } from 'react';\nimport { createPortal } from 'react-dom';\nimport { ZoomState, ZoomViewState } from '../types';\n\ninterface ZoomOverlayProps {\n  zoomState: ZoomState;\n  onClose: () => void;\n}\n\nconst MIN_SCALE = 0.5;\nconst MAX_SCALE = 4.0;\nconst ZOOM_STEP = 1.5;\nconst SCROLL_ZOOM_STEP = 1.15;\n\nconst ZoomOverlay: React.FC<ZoomOverlayProps> = ({ zoomState, onClose }) => {\n  const [view, setView] = useState<ZoomViewState>({ scale: 1, panX: 0, panY: 0, isPanning: false });\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const imgRef = useRef<HTMLImageElement>(null);\n  const panStartRef = useRef<{ x: number; y: number; panX: number; panY: number } | null>(null);\n  const didPanRef = useRef(false);\n\n  // Clamp pan so the image can't be dragged entirely off-screen.\n  // Allows up to half the viewport past each edge so users can still\n  // inspect corners, but prevents runaway transform values that crash the GPU compositor.\n  const clampPan = useCallback((px: number, py: number, scale: number): { panX: number; panY: number } => {\n    const viewport = viewportRef.current;\n    const img = imgRef.current;\n    if (!viewport || !img) return { panX: px, panY: py };\n    const vw = viewport.clientWidth;\n    const vh = viewport.clientHeight;\n    const iw = img.offsetWidth * scale;\n    const ih = img.offsetHeight * scale;\n    // Image is centered via flexbox; compute offset from transform-origin (0,0) to centered position\n    const originX = (vw - img.offsetWidth) / 2;\n    const originY = (vh - img.offsetHeight) / 2;\n    // Allow panning until only 20% of the scaled image remains visible\n    const margin = 0.2;\n    const minX = -(iw * (1 - margin)) + vw * 0.1 - originX;\n    const maxX = vw * (1 - 0.1) - iw * margin - originX;\n    const minY = -(ih * (1 - margin)) + vh * 0.1 - originY;\n    const maxY = vh * (1 - 0.1) - ih * margin - originY;\n    return {\n      panX: Math.max(minX, Math.min(maxX, px)),\n      panY: Math.max(minY, Math.min(maxY, py)),\n    };\n  }, []);\n\n  // ESC to close\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') onClose();\n    };\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [onClose]);\n\n  // Reset on image change\n  useEffect(() => {\n    setView({ scale: 1, panX: 0, panY: 0, isPanning: false });\n  }, [zoomState.imageUrl]);\n\n  const clampScale = (s: number) => Math.min(MAX_SCALE, Math.max(MIN_SCALE, s));\n\n  const handleWheel = useCallback((e: React.WheelEvent) => {\n    e.preventDefault();\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const rect = viewport.getBoundingClientRect();\n    const vx = e.clientX - rect.left;\n    const vy = e.clientY - rect.top;\n    const factor = e.deltaY < 0 ? SCROLL_ZOOM_STEP : 1 / SCROLL_ZOOM_STEP;\n    setView(prev => {\n      const ns = clampScale(prev.scale * factor);\n      const r = ns / prev.scale;\n      const rawPanX = vx - r * (vx - prev.panX);\n      const rawPanY = vy - r * (vy - prev.panY);\n      const clamped = clampPan(rawPanX, rawPanY, ns);\n      return { ...prev, scale: ns, ...clamped };\n    });\n  }, [clampPan]);\n\n  const handleMouseDown = useCallback((e: React.MouseEvent) => {\n    e.preventDefault();\n    panStartRef.current = { x: e.clientX, y: e.clientY, panX: view.panX, panY: view.panY };\n    didPanRef.current = false;\n    setView(prev => ({ ...prev, isPanning: true }));\n  }, [view.panX, view.panY]);\n\n  const handleMouseMove = useCallback((e: React.MouseEvent) => {\n    if (!panStartRef.current) return;\n    const dx = e.clientX - panStartRef.current.x;\n    const dy = e.clientY - panStartRef.current.y;\n    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) didPanRef.current = true;\n    setView(prev => {\n      const rawPanX = panStartRef.current!.panX + dx;\n      const rawPanY = panStartRef.current!.panY + dy;\n      const clamped = clampPan(rawPanX, rawPanY, prev.scale);\n      return { ...prev, ...clamped };\n    });\n  }, [clampPan]);\n\n  const handleMouseUp = useCallback(() => {\n    panStartRef.current = null;\n    setView(prev => ({ ...prev, isPanning: false }));\n  }, []);\n\n  const handleClick = useCallback((e: React.MouseEvent) => {\n    if (didPanRef.current) { didPanRef.current = false; return; }\n    // Click to zoom in, ctrl+click to zoom out\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const rect = viewport.getBoundingClientRect();\n    const vx = e.clientX - rect.left;\n    const vy = e.clientY - rect.top;\n    const factor = e.ctrlKey || e.metaKey ? 1 / ZOOM_STEP : ZOOM_STEP;\n    setView(prev => {\n      const ns = clampScale(prev.scale * factor);\n      const r = ns / prev.scale;\n      const rawPanX = vx - r * (vx - prev.panX);\n      const rawPanY = vy - r * (vy - prev.panY);\n      const clamped = clampPan(rawPanX, rawPanY, ns);\n      return { ...prev, scale: ns, ...clamped };\n    });\n  }, [clampPan]);\n\n  const handleBackdropClick = useCallback((e: React.MouseEvent) => {\n    if (e.target === e.currentTarget) onClose();\n  }, [onClose]);\n\n  if (!zoomState.imageUrl) return null;\n\n  return createPortal(\n    <div\n      className=\"fixed inset-0 z-[120] bg-black/50 dark:bg-black/60 animate-in fade-in duration-300\"\n      onClick={handleBackdropClick}\n    >\n      {/* Close button */}\n      <button\n        className=\"absolute top-8 right-8 w-12 h-12 flex items-center justify-center rounded-full bg-zinc-50 dark:bg-zinc-800 border border-zinc-100 dark:border-zinc-700 text-zinc-800 dark:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-all z-[130]\"\n        onClick={onClose}\n      >\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\"><path d=\"M18 6L6 18M6 6l12 12\"/></svg>\n      </button>\n\n      {/* Top-left zoom info */}\n      <div className=\"absolute top-8 left-8 z-[130] flex items-center space-x-2\">\n        <span className=\"text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500 dark:text-zinc-400 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm px-4 py-2 rounded-full border border-zinc-100 dark:border-zinc-700 shadow-sm\">\n          {Math.round(view.scale * 100)}%\n        </span>\n        {view.scale !== 1 && (\n          <button\n            onClick={() => setView({ scale: 1, panX: 0, panY: 0, isPanning: false })}\n            className=\"text-[9px] font-bold uppercase tracking-widest text-zinc-500 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm px-3 py-2 rounded-full border border-zinc-100 dark:border-zinc-700 transition-colors\"\n          >\n            Reset\n          </button>\n        )}\n      </div>\n\n      {/* Card info */}\n      {zoomState.cardText && (\n        <div className=\"absolute bottom-8 left-1/2 -translate-x-1/2 z-[130] bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm px-6 py-3 rounded-full border border-zinc-100 dark:border-zinc-700 shadow-sm\">\n          <span className=\"text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 dark:text-zinc-400\">{zoomState.cardText}</span>\n        </div>\n      )}\n\n      {/* Viewport */}\n      <div\n        ref={viewportRef}\n        className={`absolute inset-0 flex items-center justify-center overflow-hidden select-none ${view.isPanning ? 'cursor-grabbing' : 'cursor-zoom-in'}`}\n        onClick={handleClick}\n        onWheel={handleWheel}\n        onMouseDown={handleMouseDown}\n        onMouseMove={handleMouseMove}\n        onMouseUp={handleMouseUp}\n        onMouseLeave={handleMouseUp}\n      >\n        <div\n          style={{\n            transform: `translate(${view.panX}px, ${view.panY}px) scale(${view.scale})`,\n            transformOrigin: '0 0',\n            transition: view.isPanning ? 'none' : 'transform 0.2s ease-out',\n          }}\n        >\n          <img\n            ref={imgRef}\n            src={zoomState.imageUrl}\n            alt=\"Zoom View\"\n            draggable={false}\n            className=\"max-w-[90vw] max-h-[85vh] object-contain shadow-[0_0_0_1px_rgba(0,0,0,0.15),0_50px_100px_rgba(0,0,0,0.1)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.15),0_50px_100px_rgba(0,0,0,0.3)]\"\n          />\n        </div>\n      </div>\n    </div>,\n    document.body\n  );\n};\n\nexport default ZoomOverlay;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\workbench\\AnnotationToolbar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'zoomScale' is defined but never used. Allowed unused args must match /^_/u.","line":96,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":96,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onZoomIn' is defined but never used. Allowed unused args must match /^_/u.","line":97,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onZoomOut' is defined but never used. Allowed unused args must match /^_/u.","line":98,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":98,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onZoomReset' is defined but never used. Allowed unused args must match /^_/u.","line":99,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onRequestFullscreen' is defined but never used. Allowed unused args must match /^_/u.","line":100,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":100,"endColumn":22},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 25 to the 15 allowed.","line":103,"column":4,"nodeType":null,"messageId":"refactorFunction","endLine":103,"endColumn":6},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":118,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":118,"endColumn":34,"fix":{"range":[4077,4084],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":126,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":126,"endColumn":10},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":135,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":135,"endColumn":32,"fix":{"range":[4619,4626],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":143,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":143,"endColumn":10},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":152,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":152,"endColumn":33,"fix":{"range":[5155,5162],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":160,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":160,"endColumn":10},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":170,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":170,"endColumn":56},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":179,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":179,"endColumn":66,"fix":{"range":[6048,6070],"text":"{paletteColors.push(c);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":185,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":185,"endColumn":63},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":202,"column":17,"nodeType":"Literal","messageId":"defineConstant","endLine":202,"endColumn":80},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":219,"column":17,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":223,"endColumn":141},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Nested ternary expression should be parenthesized.","line":221,"column":19,"nodeType":"ConditionalExpression","messageId":"should-parenthesized","endLine":223,"endColumn":141,"fix":{"range":[7796,8037],"text":"(hasGlobalText\n                  ? 'text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50'\n                  : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200')"}}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":5,"source":"import React, { useState, useRef, useEffect } from 'react';\nimport { AnnotationTool, Palette } from '../../types';\n\ninterface AnnotationToolbarProps {\n  activeTool: AnnotationTool;\n  onToolChange: (tool: AnnotationTool) => void;\n  annotationCount: number;\n  onDiscardMarks: () => void;\n  onModify?: () => void;\n  isModifying?: boolean;\n  activeColor?: string;\n  onColorChange?: (color: string) => void;\n  palette?: Palette;\n  disabled?: boolean;\n  contentDirty?: boolean;\n  hasSelection?: boolean;\n  onDeleteSelected?: () => void;\n  inline?: boolean;\n  zoomScale?: number;\n  onZoomIn?: () => void;\n  onZoomOut?: () => void;\n  onZoomReset?: () => void;\n  onRequestFullscreen?: () => void;\n  globalInstruction?: string;\n  onGlobalInstructionChange?: (text: string) => void;\n}\n\nconst tools: { id: AnnotationTool; label: string; icon: React.ReactNode; enabled: boolean }[] = [\n  {\n    id: 'select',\n    label: 'Select',\n    enabled: true,\n    icon: (\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M4.037 4.688a.495.495 0 0 1 .651-.651l16 6.5a.5.5 0 0 1-.063.947l-6.124 1.58a2 2 0 0 0-1.438 1.435l-1.579 6.126a.5.5 0 0 1-.947.063z\"/>\n      </svg>\n    ),\n  },\n  {\n    id: 'pin',\n    label: 'Pin',\n    enabled: true,\n    icon: (\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M12 17v5\"/><path d=\"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z\"/>\n      </svg>\n    ),\n  },\n  {\n    id: 'arrow',\n    label: 'Arrow',\n    enabled: true,\n    icon: (\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M7 17V7h10\"/><path d=\"M17 17 7 7\"/>\n      </svg>\n    ),\n  },\n  {\n    id: 'rectangle',\n    label: 'Rectangle',\n    enabled: true,\n    icon: (\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M5 3a2 2 0 0 0-2 2\"/><path d=\"M19 3a2 2 0 0 1 2 2\"/><path d=\"M21 19a2 2 0 0 1-2 2\"/><path d=\"M5 21a2 2 0 0 1-2-2\"/><path d=\"M9 3h1\"/><path d=\"M9 21h1\"/><path d=\"M14 3h1\"/><path d=\"M14 21h1\"/><path d=\"M3 9v1\"/><path d=\"M21 9v1\"/><path d=\"M3 14v1\"/><path d=\"M21 14v1\"/>\n      </svg>\n    ),\n  },\n  {\n    id: 'sketch',\n    label: 'Sketch',\n    enabled: true,\n    icon: (\n      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M7 3.5c5-2 7 2.5 3 4C1.5 10 2 15 5 16c5 2 9-10 14-7s.5 13.5-4 12c-5-2.5.5-11 6-2\"/>\n      </svg>\n    ),\n  },\n];\n\nconst AnnotationToolbar: React.FC<AnnotationToolbarProps> = ({\n  activeTool,\n  onToolChange,\n  annotationCount,\n  onDiscardMarks,\n  onModify,\n  isModifying,\n  activeColor,\n  onColorChange,\n  palette,\n  disabled,\n  contentDirty,\n  hasSelection,\n  onDeleteSelected,\n  inline,\n  zoomScale,\n  onZoomIn,\n  onZoomOut,\n  onZoomReset,\n  onRequestFullscreen,\n  globalInstruction,\n  onGlobalInstructionChange,\n}) => {\n  const [showColorPicker, setShowColorPicker] = useState(false);\n  const [showTextPanel, setShowTextPanel] = useState(false);\n  const [showDeleteMenu, setShowDeleteMenu] = useState(false);\n  const deleteMenuRef = useRef<HTMLDivElement>(null);\n  const colorPickerRef = useRef<HTMLDivElement>(null);\n  const colorInputRef = useRef<HTMLInputElement>(null);\n  const textPanelRef = useRef<HTMLDivElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const hasGlobalText = !!(globalInstruction && globalInstruction.trim());\n  const canModify = annotationCount > 0 || !!contentDirty || hasGlobalText;\n\n  // Close color picker on click outside\n  useEffect(() => {\n    if (!showColorPicker) return;\n    const handleClickOutside = (e: MouseEvent) => {\n      if (colorPickerRef.current && !colorPickerRef.current.contains(e.target as Node)) {\n        setShowColorPicker(false);\n      }\n    };\n    const timer = setTimeout(() => {\n      window.addEventListener('mousedown', handleClickOutside);\n    }, 50);\n    return () => {\n      clearTimeout(timer);\n      window.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [showColorPicker]);\n\n  // Close text panel on click outside\n  useEffect(() => {\n    if (!showTextPanel) return;\n    const handleClickOutside = (e: MouseEvent) => {\n      if (textPanelRef.current && !textPanelRef.current.contains(e.target as Node)) {\n        setShowTextPanel(false);\n      }\n    };\n    const timer = setTimeout(() => {\n      window.addEventListener('mousedown', handleClickOutside);\n    }, 50);\n    return () => {\n      clearTimeout(timer);\n      window.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [showTextPanel]);\n\n  // Close delete menu on click outside\n  useEffect(() => {\n    if (!showDeleteMenu) return;\n    const handleClickOutside = (e: MouseEvent) => {\n      if (deleteMenuRef.current && !deleteMenuRef.current.contains(e.target as Node)) {\n        setShowDeleteMenu(false);\n      }\n    };\n    const timer = setTimeout(() => {\n      window.addEventListener('mousedown', handleClickOutside);\n    }, 50);\n    return () => {\n      clearTimeout(timer);\n      window.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [showDeleteMenu]);\n\n  // Auto-focus textarea when panel opens\n  useEffect(() => {\n    if (showTextPanel) {\n      setTimeout(() => textareaRef.current?.focus(), 50);\n    }\n  }, [showTextPanel]);\n\n  // Build palette colors array\n  const paletteColors: string[] = [];\n  if (palette) {\n    const vals = [palette.primary, palette.secondary, palette.accent, palette.text, palette.background];\n    for (const c of vals) {\n      if (c && !paletteColors.includes(c)) paletteColors.push(c);\n    }\n  }\n  // Always include some defaults if palette is sparse\n  const defaultColors = ['#E63946', '#457B9D', '#2A9D8F', '#E9C46A', '#264653'];\n  for (const c of defaultColors) {\n    if (!paletteColors.includes(c) && paletteColors.length < 5) {\n      paletteColors.push(c);\n    }\n  }\n\n  return (\n    <div className={`${inline ? '' : 'absolute bottom-6 left-1/2 -translate-x-1/2 z-[115] '} px-1.5 h-9 flex items-center space-x-1 animate-in fade-in slide-in-from-bottom-2 duration-300`}>\n      {/* Tool Buttons */}\n      {tools.map((tool) => (\n        <button\n          key={tool.id}\n          onClick={() => tool.enabled && !disabled && onToolChange(tool.id)}\n          disabled={!tool.enabled || disabled}\n          title={tool.label}\n          className={`\n            w-7 h-7 rounded-full flex items-center justify-center transition-all\n            ${activeTool === tool.id\n              ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200'\n              : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 disabled:opacity-40 disabled:pointer-events-none'\n            }\n          `}\n        >\n          {tool.icon}\n        </button>\n      ))}\n\n      {/* Text Instruction Button */}\n      {onGlobalInstructionChange && (\n        <div className=\"relative\" ref={textPanelRef}>\n          <button\n            onClick={() => setShowTextPanel(!showTextPanel)}\n            title=\"Text Instruction\"\n            className={`\n              w-7 h-7 rounded-full flex items-center justify-center transition-all relative\n              ${showTextPanel\n                ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200'\n                : hasGlobalText\n                  ? 'text-zinc-600 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800/50'\n                  : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'\n              }\n            `}\n          >\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M7.9 20A9 9 0 1 0 4 16.1L2 22z\"/>\n            </svg>\n            {/* Dot indicator when instruction text exists */}\n            {hasGlobalText && !showTextPanel && (\n              <div className=\"absolute -top-0.5 -right-0.5 w-2.5 h-2.5 rounded-full bg-zinc-900 dark:bg-zinc-100 border-2 border-white dark:border-zinc-900\" />\n            )}\n          </button>\n\n          {/* Text instruction popover */}\n          {showTextPanel && (\n            <div className={`absolute left-1/2 -translate-x-1/2 w-[360px] bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-700 shadow-lg dark:shadow-black/30 overflow-hidden animate-in fade-in zoom-in-95 duration-200 ${inline ? 'top-full mt-3' : 'bottom-full mb-3'}`}>\n              <div className=\"px-4 py-2.5 flex items-center justify-between\">\n                <span className=\"text-[11px] font-medium uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Global Instruction</span>\n                <div className=\"flex items-center gap-1\">\n                  <button\n                    onClick={() => { onGlobalInstructionChange(''); setShowTextPanel(false); }}\n                    className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 dark:text-zinc-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-950 transition-colors\"\n                    title=\"Clear & close\"\n                  >\n                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                      <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n                    </svg>\n                  </button>\n                  <button\n                    onClick={() => setShowTextPanel(false)}\n                    className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 dark:text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n                    title=\"Save & close\"\n                  >\n                    <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                      <polyline points=\"20 6 9 17 4 12\"/>\n                    </svg>\n                  </button>\n                </div>\n              </div>\n              <div className=\"px-4 pb-3\">\n                <textarea\n                  ref={textareaRef}\n                  value={globalInstruction || ''}\n                  onChange={(e) => onGlobalInstructionChange(e.target.value)}\n                  placeholder=\"Describe changes to apply globally...\"\n                  rows={6}\n                  className=\"w-full bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg px-3 py-2.5 text-[13px] leading-relaxed text-zinc-700 dark:text-zinc-300 resize-none focus:outline-none focus:border-zinc-400 dark:focus:border-zinc-500 transition-colors placeholder:text-zinc-400 dark:placeholder:text-zinc-500\"\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !e.shiftKey) {\n                      e.preventDefault();\n                      setShowTextPanel(false);\n                    }\n                    if (e.key === 'Escape') {\n                      setShowTextPanel(false);\n                    }\n                    e.stopPropagation();\n                  }}\n                />\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Delete annotations — dropdown */}\n      <div className=\"relative\" ref={deleteMenuRef}>\n        <button\n          onClick={() => setShowDeleteMenu(!showDeleteMenu)}\n          disabled={annotationCount === 0 && !hasSelection}\n          title=\"Delete annotations\"\n          className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${showDeleteMenu ? 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200' : 'text-zinc-600 dark:text-zinc-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-950'} disabled:opacity-40 disabled:pointer-events-none`}\n        >\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n            <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n          </svg>\n        </button>\n        {showDeleteMenu && (\n          <div\n            className={`absolute left-1/2 -translate-x-1/2 bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 min-w-[180px] z-[140] animate-in fade-in zoom-in-95 duration-150 ${inline ? 'top-full mt-2' : 'bottom-full mb-2'}`}\n          >\n            <button\n              onClick={() => { onDeleteSelected?.(); setShowDeleteMenu(false); }}\n              disabled={!hasSelection}\n              className=\"w-full text-left px-3 py-1.5 text-[11px] text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors flex items-center gap-2 disabled:opacity-40 disabled:pointer-events-none\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-zinc-500 dark:text-zinc-400\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n              Delete Selected\n            </button>\n            <button\n              onClick={() => { onDiscardMarks(); setShowDeleteMenu(false); }}\n              disabled={annotationCount === 0}\n              className=\"w-full text-left px-3 py-1.5 text-[11px] text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2 disabled:opacity-40 disabled:pointer-events-none\"\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n              Delete All Annotations\n            </button>\n          </div>\n        )}\n      </div>\n\n      {/* Separator */}\n      <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n      {/* Color Picker */}\n      {onColorChange && (\n        <div className=\"relative\" ref={colorPickerRef}>\n          <button\n            onClick={() => setShowColorPicker(!showColorPicker)}\n            title=\"Annotation Color\"\n            className=\"w-7 h-7 rounded-full flex items-center justify-center transition-all hover:scale-110\"\n          >\n            <div\n              className=\"w-4 h-4 rounded-full border-2 border-white shadow-md transition-transform\"\n              style={{ backgroundColor: activeColor || '#E63946' }}\n            />\n          </button>\n\n          {/* Color picker popover */}\n          {showColorPicker && (\n            <div className={`absolute left-1/2 -translate-x-1/2 bg-white dark:bg-zinc-900 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 p-3 animate-in fade-in zoom-in-95 duration-200 ${inline ? 'top-full mt-3' : 'bottom-full mb-3'}`}>\n              <div className=\"text-[11px] font-medium uppercase tracking-[0.2em] text-black mb-2 px-1\">Color</div>\n              <div className=\"flex items-center space-x-2\">\n                {paletteColors.map((color) => (\n                  <button\n                    key={color}\n                    onClick={() => {\n                      onColorChange(color);\n                      setShowColorPicker(false);\n                    }}\n                    className=\"relative w-7 h-7 rounded-full transition-all hover:scale-110\"\n                    style={{ backgroundColor: color }}\n                    title={color}\n                  >\n                    {activeColor === color && (\n                      <div className=\"absolute inset-0 rounded-full border-[2.5px] border-[#2a9fd4] shadow-[0_0_0_2px_rgba(0,0,0,0.1)]\" />\n                    )}\n                  </button>\n                ))}\n\n                {/* Custom color button */}\n                <button\n                  onClick={() => colorInputRef.current?.click()}\n                  className=\"w-7 h-7 rounded-full border-2 border-dashed border-zinc-200 dark:border-zinc-700 flex items-center justify-center text-zinc-500 dark:text-zinc-400 hover:border-zinc-400 dark:hover:border-zinc-500 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors\"\n                  title=\"Custom color\"\n                >\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\">\n                    <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\n                  </svg>\n                </button>\n                <input\n                  ref={colorInputRef}\n                  type=\"color\"\n                  value={activeColor || '#E63946'}\n                  onChange={(e) => {\n                    onColorChange(e.target.value);\n                    setShowColorPicker(false);\n                  }}\n                  className=\"sr-only\"\n                />\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Separator */}\n      <div className=\"w-px h-3.5 bg-zinc-200 dark:bg-zinc-700 mx-0.5\" />\n\n      {/* Apply Changes */}\n      <button\n        onClick={onModify}\n        disabled={!canModify || isModifying}\n        title={contentDirty && annotationCount === 0 && !hasGlobalText ? 'Re-render with updated content' : 'Apply Changes'}\n        className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${isModifying ? 'animate-spin text-zinc-600 dark:text-zinc-400' : 'text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200'} disabled:opacity-40 disabled:pointer-events-none`}\n      >\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"-rotate-90\">\n          <path d=\"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8\"/><path d=\"M21 3v5h-5\"/>\n        </svg>\n      </button>\n    </div>\n  );\n};\n\nexport default AnnotationToolbar;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\workbench\\AnnotationWorkbench.tsx","messages":[{"ruleId":"import/order","severity":1,"message":"`./AnnotationToolbar` import should occur after import of `../../hooks/useVersionHistory`","line":13,"column":1,"nodeType":"ImportDeclaration","endLine":13,"endColumn":53,"fix":{"range":[264,892],"text":"import { useAnnotations, createAnnotationId } from '../../hooks/useAnnotations';\nimport { renderAnnotations, canvasToNormalized, hitTestAnnotation, hitTestHandle, HandleType, RubberBand } from './CanvasRenderer';\nimport PinEditor from './PinEditor';\nimport RectangleEditor from './RectangleEditor';\nimport { simplifyPath } from '../../utils/geometry';\nimport { generateRedlineMap } from '../../utils/redline';\nimport { executeModification, executeContentModification } from '../../utils/modificationEngine';\nimport { useVersionHistory } from '../../hooks/useVersionHistory';\nimport AnnotationToolbar from './AnnotationToolbar';\n"}},{"ruleId":"import/order","severity":1,"message":"`./CanvasRenderer` import should occur after import of `../../hooks/useVersionHistory`","line":15,"column":1,"nodeType":"ImportDeclaration","endLine":15,"endColumn":132,"fix":{"range":[398,892],"text":"import PinEditor from './PinEditor';\nimport RectangleEditor from './RectangleEditor';\nimport { simplifyPath } from '../../utils/geometry';\nimport { generateRedlineMap } from '../../utils/redline';\nimport { executeModification, executeContentModification } from '../../utils/modificationEngine';\nimport { useVersionHistory } from '../../hooks/useVersionHistory';\nimport { renderAnnotations, canvasToNormalized, hitTestAnnotation, hitTestHandle, HandleType, RubberBand } from './CanvasRenderer';\n"}},{"ruleId":"import/order","severity":1,"message":"`./PinEditor` import should occur after import of `../../hooks/useVersionHistory`","line":16,"column":1,"nodeType":"ImportDeclaration","endLine":16,"endColumn":37,"fix":{"range":[530,892],"text":"import RectangleEditor from './RectangleEditor';\nimport { simplifyPath } from '../../utils/geometry';\nimport { generateRedlineMap } from '../../utils/redline';\nimport { executeModification, executeContentModification } from '../../utils/modificationEngine';\nimport { useVersionHistory } from '../../hooks/useVersionHistory';\nimport PinEditor from './PinEditor';\n"}},{"ruleId":"import/order","severity":1,"message":"`./RectangleEditor` import should occur after import of `../../hooks/useVersionHistory`","line":17,"column":1,"nodeType":"ImportDeclaration","endLine":17,"endColumn":49,"fix":{"range":[567,892],"text":"import { simplifyPath } from '../../utils/geometry';\nimport { generateRedlineMap } from '../../utils/redline';\nimport { executeModification, executeContentModification } from '../../utils/modificationEngine';\nimport { useVersionHistory } from '../../hooks/useVersionHistory';\nimport RectangleEditor from './RectangleEditor';\n"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 24 to the 15 allowed.","line":94,"column":4,"nodeType":null,"messageId":"refactorFunction","endLine":94,"endColumn":6},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'clearAll'. Either include it or remove the dependency array.","line":182,"column":6,"nodeType":"ArrayExpression","endLine":182,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [clearAll, imageUrl]","fix":{"range":[6454,6464],"text":"[clearAll, imageUrl]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":187,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":187,"endColumn":25,"fix":{"range":[6610,6617],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 17 to the 15 allowed.","line":189,"column":38,"nodeType":null,"messageId":"refactorFunction","endLine":189,"endColumn":40},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":199,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":199,"endColumn":27,"fix":{"range":[7179,7186],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":202,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":202,"endColumn":33,"fix":{"range":[7246,7253],"text":"{return;}"}},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":215,"column":7,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":215,"endColumn":9},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":216,"column":9,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":218,"endColumn":10,"fix":{"range":[7550,7707],"text":"((ke.key === 'Delete' || ke.key === 'Backspace') && selectedAnnotationId && !isEditing) {\n          remove(selectedAnnotationId);\n        }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":223,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":223,"endColumn":73,"fix":{"range":[7845,7864],"text":"{setCtrlHeld(false);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":224,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":224,"endColumn":47,"fix":{"range":[7893,7911],"text":"{setAltHeld(false);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":271,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":271,"endColumn":40,"fix":{"range":[9647,9654],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":281,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":281,"endColumn":33,"fix":{"range":[10029,10036],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":306,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":306,"endColumn":35,"fix":{"range":[10951,10958],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":308,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":308,"endColumn":24,"fix":{"range":[11018,11025],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":331,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":331,"endColumn":27,"fix":{"range":[11996,12008],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":340,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":340,"endColumn":27,"fix":{"range":[12327,12339],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":342,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":342,"endColumn":30,"fix":{"range":[12396,12408],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":354,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":354,"endColumn":58,"fix":{"range":[12956,12986],"text":"{return { panX: px, panY: py };}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":366,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":366,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":367,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":367,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":368,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":368,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.1.","line":369,"column":28,"nodeType":"Literal","messageId":"noMagic","endLine":369,"endColumn":31},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":380,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":380,"endColumn":27,"fix":{"range":[14079,14086],"text":"{return;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'clampScale'. Either include it or remove the dependency array.","line":393,"column":6,"nodeType":"ArrayExpression","endLine":393,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [clampScale, clampPan]","fix":{"range":[14603,14635],"text":"[clampScale, clampPan]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":398,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":398,"endColumn":27,"fix":{"range":[14789,14796],"text":"{return;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'clampScale'. Either include it or remove the dependency array.","line":412,"column":6,"nodeType":"ArrayExpression","endLine":412,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [clampScale, clampPan]","fix":{"range":[15350,15382],"text":"[clampScale, clampPan]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":417,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":417,"endColumn":27,"fix":{"range":[15542,15549],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":424,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":424,"endColumn":27,"fix":{"range":[15820,15827],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 27 to the 15 allowed.","line":452,"column":45,"nodeType":null,"messageId":"refactorFunction","endLine":452,"endColumn":47},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":453,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":453,"endColumn":43,"fix":{"range":[16964,16971],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":454,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":454,"endColumn":34,"fix":{"range":[16998,17005],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":461,"column":77,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":461,"endColumn":84,"fix":{"range":[17358,17365],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":496,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":496,"endColumn":60,"fix":{"range":[18573,18604],"text":"{combinedInstructions += '\\n\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":498,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":498,"endColumn":64,"fix":{"range":[18641,18678],"text":"{combinedInstructions += instructions;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":524,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":524,"endColumn":43},{"ruleId":"curly","severity":1,"message":"Expected { after 'while' condition.","line":524,"column":45,"nodeType":"WhileStatement","messageId":"missingCurlyAfterCondition","endLine":524,"endColumn":69,"fix":{"range":[19505,19529],"text":"{updatedVersions.shift();}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":527,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":527,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19626,19629],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19626,19629],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":528,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":528,"endColumn":20,"suggestions":[{"fix":{"range":[19639,19682],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":557,"column":59,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":557,"endColumn":88,"fix":{"range":[20975,21004],"text":"{remove(selectedAnnotationId);}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'handleZoomReset', 'isInline', and 'onRequestFullscreen'. Either include them or remove the dependency array.","line":566,"column":6,"nodeType":"ArrayExpression","endLine":566,"endColumn":162,"suggestions":[{"desc":"Update the dependencies array to be: [activeTool, annotations.length, isModifying, activeColor, palette, contentDirty, selectedAnnotationId, clearAll, remove, zoomView.scale, globalInstruction, handleZoomReset, isInline, onRequestFullscreen]","fix":{"range":[21365,21521],"text":"[activeTool, annotations.length, isModifying, activeColor, palette, contentDirty, selectedAnnotationId, clearAll, remove, zoomView.scale, globalInstruction, handleZoomReset, isInline, onRequestFullscreen]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 39 to the 15 allowed.","line":569,"column":61,"nodeType":null,"messageId":"refactorFunction","endLine":569,"endColumn":63},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":570,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":570,"endColumn":42,"fix":{"range":[21652,21659],"text":"{return;}"}},{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":651,"column":7,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":651,"endColumn":14,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[24535,24549],"text":""},"desc":"Remove this redundant jump"}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'getCanvasCoords' and 'getNormCoords'. Either include them or remove the dependency array.","line":653,"column":6,"nodeType":"ArrayExpression","endLine":653,"endColumn":117,"suggestions":[{"desc":"Update the dependencies array to be: [isEditing, isModifying, getNormCoords, getCanvasCoords, activeTool, altHeld, zoomView.panX, zoomView.panY, zoomView.scale, selectedAnnotationId, annotations, select, activeColor]","fix":{"range":[24561,24672],"text":"[isEditing, isModifying, getNormCoords, getCanvasCoords, activeTool, altHeld, zoomView.panX, zoomView.panY, zoomView.scale, selectedAnnotationId, annotations, select, activeColor]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 41 to the 15 allowed.","line":655,"column":61,"nodeType":null,"messageId":"refactorFunction","endLine":655,"endColumn":63},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":660,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":660,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":660,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":660,"endColumn":47},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":660,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":660,"endColumn":74,"fix":{"range":[24950,24975],"text":"{didPanRef.current = true;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":672,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":672,"endColumn":25,"fix":{"range":[25367,25374],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":685,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":685,"endColumn":25,"fix":{"range":[25784,25791],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":692,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":692,"endColumn":25,"fix":{"range":[26029,26036],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":700,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":700,"endColumn":25,"fix":{"range":[26341,26348],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":710,"column":73,"nodeType":"Literal","messageId":"noMagic","endLine":710,"endColumn":77},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":710,"column":120,"nodeType":"Literal","messageId":"noMagic","endLine":710,"endColumn":124},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":712,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":712,"endColumn":93},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":713,"column":93,"nodeType":"Literal","messageId":"noMagic","endLine":713,"endColumn":97},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":715,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":715,"endColumn":93},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":716,"column":93,"nodeType":"Literal","messageId":"noMagic","endLine":716,"endColumn":97},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":718,"column":73,"nodeType":"Literal","messageId":"noMagic","endLine":718,"endColumn":77},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":718,"column":116,"nodeType":"Literal","messageId":"noMagic","endLine":718,"endColumn":120},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":723,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":723,"endColumn":73,"fix":{"range":[27743,27781],"text":"{update(annotationId, { start: norm });}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":724,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":724,"endColumn":74,"fix":{"range":[27819,27855],"text":"{update(annotationId, { end: norm });}"}},{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":731,"column":7,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":731,"endColumn":14,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[28090,28104],"text":""},"desc":"Remove this redundant jump"}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'getNormCoords'. Either include it or remove the dependency array.","line":733,"column":6,"nodeType":"ArrayExpression","endLine":733,"endColumn":90,"suggestions":[{"desc":"Update the dependencies array to be: [activeTool, isDragging, clampPan, getNormCoords, activeColor, annotations, update, moveAnnotation]","fix":{"range":[28116,28200],"text":"[activeTool, isDragging, clampPan, getNormCoords, activeColor, annotations, update, moveAnnotation]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 21 to the 15 allowed.","line":735,"column":59,"nodeType":null,"messageId":"refactorFunction","endLine":735,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.003.","line":784,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":784,"endColumn":54},{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":801,"column":7,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":801,"endColumn":14,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[30580,30594],"text":""},"desc":"Remove this redundant jump"}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'getNormCoords'. Either include it or remove the dependency array.","line":803,"column":6,"nodeType":"ArrayExpression","endLine":803,"endColumn":48,"suggestions":[{"desc":"Update the dependencies array to be: [activeTool, isDragging, getNormCoords, activeColor, add]","fix":{"range":[30606,30648],"text":"[activeTool, isDragging, getNormCoords, activeColor, add]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 20 to the 15 allowed.","line":805,"column":57,"nodeType":null,"messageId":"refactorFunction","endLine":805,"endColumn":59},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":807,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":807,"endColumn":42,"fix":{"range":[30813,30820],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":811,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":811,"endColumn":29,"fix":{"range":[30932,30939],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":815,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":815,"endColumn":68,"fix":{"range":[31092,31139],"text":"{zoomToward(vx, vy, zoomView.scale - ZOOM_STEP);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":816,"column":12,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":816,"endColumn":59,"fix":{"range":[31151,31198],"text":"{zoomToward(vx, vy, zoomView.scale + ZOOM_STEP);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":822,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":822,"endColumn":25,"fix":{"range":[31306,31313],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":834,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":834,"endColumn":73,"fix":{"range":[31734,31772],"text":"{setEditingPinId(selectedAnnotationId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":835,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":835,"endColumn":85,"fix":{"range":[31818,31857],"text":"{setEditingRectId(selectedAnnotationId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":836,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":836,"endColumn":82,"fix":{"range":[31899,31939],"text":"{setEditingArrowId(selectedAnnotationId);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":837,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":837,"endColumn":84,"fix":{"range":[31982,32023],"text":"{setEditingSketchId(selectedAnnotationId);}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'getNormCoords'. Either include it or remove the dependency array.","line":839,"column":6,"nodeType":"ArrayExpression","endLine":839,"endColumn":142,"suggestions":[{"desc":"Update the dependencies array to be: [isEditing, isModifying, activeTool, altHeld, selectedAnnotationId, ctrlHeld, zoomToward, zoomView.scale, getNormCoords, activeColor, add, annotations]","fix":{"range":[32035,32171],"text":"[isEditing, isModifying, activeTool, altHeld, selectedAnnotationId, ctrlHeld, zoomToward, zoomView.scale, getNormCoords, activeColor, add, annotations]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":842,"column":73,"nodeType":null,"messageId":"refactorFunction","endLine":842,"endColumn":75},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":845,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":845,"endColumn":45,"fix":{"range":[32403,32425],"text":"{return { x: 0, y: 0 };}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":871,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":871,"endColumn":36,"fix":{"range":[33412,33423],"text":"{minX = p.x;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":872,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":872,"endColumn":36,"fix":{"range":[33448,33459],"text":"{maxX = p.x;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":873,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":873,"endColumn":36,"fix":{"range":[33484,33495],"text":"{minY = p.y;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":885,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":885,"endColumn":48,"fix":{"range":[33793,33819],"text":"{return 'zoom-tool-select';}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":885,"column":29,"nodeType":"Literal","messageId":"defineConstant","endLine":885,"endColumn":47},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":887,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":887,"endColumn":72,"fix":{"range":[33883,33924],"text":"{return 'zoom-tool-zoom alt-held panning';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":888,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":888,"endColumn":53,"fix":{"range":[33944,33977],"text":"{return 'zoom-tool-zoom alt-held';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":889,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":889,"endColumn":55,"fix":{"range":[33998,34032],"text":"{return 'zoom-tool-zoom ctrl-held';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":892,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":892,"endColumn":60,"fix":{"range":[34103,34129],"text":"{return 'zoom-tool-select';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":893,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":893,"endColumn":54,"fix":{"range":[34160,34183],"text":"{return 'zoom-tool-pin';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":894,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":894,"endColumn":58,"fix":{"range":[34215,34241],"text":"{return 'zoom-tool-select';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":895,"column":90,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":895,"endColumn":119,"fix":{"range":[34331,34360],"text":"{return 'zoom-tool-crosshair';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.003.","line":908,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":908,"endColumn":54},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":924,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":924,"endColumn":37,"fix":{"range":[35500,35512],"text":"{return null;}"}},{"ruleId":"react/jsx-curly-brace-presence","severity":1,"message":"Curly braces are unnecessary here.","line":938,"column":22,"nodeType":"JSXExpressionContainer","messageId":"unnecessaryCurly","endLine":938,"endColumn":83,"fix":{"range":[36744,36805],"text":"\"absolute top-3 right-3 z-[15] flex items-center space-x-2\""}},{"ruleId":"react/no-array-index-key","severity":1,"message":"Do not use Array index in keys","line":987,"column":22,"nodeType":"TemplateLiteral","messageId":"noArrayIndex","endLine":987,"endColumn":43},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":1133,"column":63,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":1133,"endColumn":92,"fix":{"range":[46781,46810],"text":"{remove(selectedAnnotationId);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":102,"fixableErrorCount":0,"fixableWarningCount":61,"source":"import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport {\n  ZoomViewState,\n  AnnotationTool,\n  NormalizedPoint,\n  PinAnnotation,\n  RectangleAnnotation,\n  ArrowAnnotation,\n  SketchAnnotation,\n  ImageVersion,\n  Palette,\n} from '../../types';\nimport AnnotationToolbar from './AnnotationToolbar';\nimport { useAnnotations, createAnnotationId } from '../../hooks/useAnnotations';\nimport { renderAnnotations, canvasToNormalized, hitTestAnnotation, hitTestHandle, HandleType, RubberBand } from './CanvasRenderer';\nimport PinEditor from './PinEditor';\nimport RectangleEditor from './RectangleEditor';\nimport { simplifyPath } from '../../utils/geometry';\nimport { generateRedlineMap } from '../../utils/redline';\nimport { executeModification, executeContentModification } from '../../utils/modificationEngine';\nimport { useVersionHistory } from '../../hooks/useVersionHistory';\n\nexport interface AnnotationToolbarState {\n  activeTool: AnnotationTool;\n  onToolChange: (tool: AnnotationTool) => void;\n  annotationCount: number;\n  onDiscardMarks: () => void;\n  onModify: () => void;\n  isModifying: boolean;\n  activeColor: string;\n  onColorChange: (color: string) => void;\n  palette?: Palette;\n  contentDirty?: boolean;\n  hasSelection: boolean;\n  onDeleteSelected: () => void;\n  zoomScale: number;\n  onZoomIn: () => void;\n  onZoomOut: () => void;\n  onZoomReset: () => void;\n  onRequestFullscreen?: () => void;\n  globalInstruction: string;\n  onGlobalInstructionChange: (text: string) => void;\n}\n\ninterface AnnotationWorkbenchProps {\n  imageUrl: string;\n  cardId?: string | null;\n  cardText?: string | null;\n  palette?: Palette | null;\n  style?: string;\n  aspectRatio?: string;\n  resolution?: string;\n  imageHistory?: ImageVersion[];\n  mode: 'inline' | 'fullscreen';\n  onImageModified?: (cardId: string, newImageUrl: string, history: ImageVersion[]) => void;\n  onRequestFullscreen?: () => void;\n  contentDirty?: boolean;\n  currentContent?: string;\n  onZoomChange?: (scale: number) => void;\n  onToolbarStateChange?: (state: AnnotationToolbarState) => void;\n  overlay?: React.ReactNode;\n  onUsage?: (entry: { provider: 'gemini'; model: string; inputTokens: number; outputTokens: number }) => void;\n}\n\nconst INLINE_MIN_SCALE = 0.5;\nconst INLINE_MAX_SCALE = 2.0;\nconst FULLSCREEN_MIN_SCALE = 0.5;\nconst FULLSCREEN_MAX_SCALE = 4.0;\nconst ZOOM_STEP = 0.05;\nconst SCROLL_ZOOM_STEP = 0.05;\nconst MIN_RECT_SIZE = 0.01;\nconst MIN_ARROW_LENGTH = 0.02;\nconst DEFAULT_SKETCH_STROKE_WIDTH = 0.025;\nconst DEFAULT_ANNOTATION_COLOR = '#E63946';\n\nconst AnnotationWorkbench: React.FC<AnnotationWorkbenchProps> = ({\n  imageUrl,\n  cardId,\n  cardText,\n  palette,\n  style,\n  aspectRatio,\n  resolution,\n  imageHistory,\n  mode,\n  onImageModified,\n  onRequestFullscreen,\n  contentDirty,\n  currentContent,\n  onZoomChange,\n  onToolbarStateChange,\n  overlay,\n  onUsage,\n}) => {\n  const isInline = mode === 'inline';\n  const MIN_SCALE = isInline ? INLINE_MIN_SCALE : FULLSCREEN_MIN_SCALE;\n  const MAX_SCALE = isInline ? INLINE_MAX_SCALE : FULLSCREEN_MAX_SCALE;\n\n  const [activeTool, setActiveTool] = useState<AnnotationTool>('select');\n  const [zoomView, setZoomView] = useState<ZoomViewState>({ scale: 1, panX: 0, panY: 0, isPanning: false });\n  const [imageNaturals, setImageNaturals] = useState<{ w: number; h: number }>({ w: 0, h: 0 });\n  const [fittedSize, setFittedSize] = useState<{ w: number; h: number } | null>(null);\n  const [ctrlHeld, setCtrlHeld] = useState(false);\n  const [altHeld, setAltHeld] = useState(false);\n  const [activeColor, setActiveColor] = useState(DEFAULT_ANNOTATION_COLOR);\n  const [globalInstruction, setGlobalInstruction] = useState('');\n\n  // Notify parent of zoom changes\n  useEffect(() => {\n    onZoomChange?.(zoomView.scale);\n  }, [zoomView.scale, onZoomChange]);\n\n  // Ref for toolbar state change callback (avoids re-triggering effect on parent re-render)\n  const onToolbarStateChangeRef = useRef(onToolbarStateChange);\n  onToolbarStateChangeRef.current = onToolbarStateChange;\n\n  // Modification state\n  const [isModifying, setIsModifying] = useState(false);\n  const [modifyError, setModifyError] = useState<string | null>(null);\n  const [currentImageUrl, setCurrentImageUrl] = useState<string | null>(null);\n\n  // Version history\n  const {\n    versions,\n    currentIndex,\n    canUndo,\n    canRedo,\n    modificationCount,\n    pushVersion,\n    restorePrevious,\n    restoreNext,\n    restoreByIndex,\n  } = useVersionHistory(imageHistory, imageUrl);\n\n  // Annotation state\n  const { annotations, selectedAnnotationId, add, update, remove, select, clearAll, moveAnnotation } = useAnnotations();\n\n  // Editor popover state\n  const [editingPinId, setEditingPinId] = useState<string | null>(null);\n  const [editingRectId, setEditingRectId] = useState<string | null>(null);\n  const [editingArrowId, setEditingArrowId] = useState<string | null>(null);\n  const [editingSketchId, setEditingSketchId] = useState<string | null>(null);\n\n  // Rubber-band state\n  const [rubberBand, setRubberBand] = useState<RubberBand | null>(null);\n  const rectStartRef = useRef<NormalizedPoint | null>(null);\n  const arrowStartRef = useRef<NormalizedPoint | null>(null);\n  const sketchPointsRef = useRef<NormalizedPoint[]>([]);\n  const isSketchingRef = useRef(false);\n\n  // Select tool: drag state\n  const [isDragging, setIsDragging] = useState(false);\n  const dragStartRef = useRef<{ annotationId: string; startNorm: NormalizedPoint; handle: HandleType } | null>(null);\n\n  // Version strip visibility\n  const [showVersionStrip, setShowVersionStrip] = useState(false);\n\n  const viewportRef = useRef<HTMLDivElement>(null);\n  const imgRef = useRef<HTMLImageElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const panStartRef = useRef<{ x: number; y: number; panX: number; panY: number } | null>(null);\n  const didPanRef = useRef(false);\n  const animFrameRef = useRef<number>(0);\n\n  const isEditing = editingPinId || editingRectId || editingArrowId || editingSketchId;\n  const displayImageUrl = currentImageUrl || imageUrl;\n\n  // Reset when image changes\n  useEffect(() => {\n    setZoomView({ scale: 1, panX: 0, panY: 0, isPanning: false });\n    setActiveTool('select');\n    clearAll();\n    setEditingPinId(null);\n    setEditingRectId(null);\n    setEditingArrowId(null);\n    setEditingSketchId(null);\n    setRubberBand(null);\n    setCurrentImageUrl(null);\n    setModifyError(null);\n    setShowVersionStrip(false);\n    setGlobalInstruction('');\n  }, [imageUrl]);\n\n  // Keyboard: modifier tracking + shortcuts\n  useEffect(() => {\n    const target = isInline ? viewportRef.current : window;\n    if (!target) return;\n\n    const handleKeyDown = (e: Event) => {\n      const ke = e as KeyboardEvent;\n      const tag = (ke.target as HTMLElement)?.tagName;\n      const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || (ke.target as HTMLElement)?.isContentEditable;\n\n      // Always track modifier keys regardless of focus\n      if (ke.key === 'Control' || ke.key === 'Meta') { setCtrlHeld(true); return; }\n      if (ke.key === 'Alt') { ke.preventDefault(); setAltHeld(true); return; }\n\n      // Don't intercept shortcuts when user is typing in an input/textarea\n      if (isInput) return;\n\n      if (ke.key === 'Escape') {\n        if (isModifying) return;\n        if (isEditing) {\n          setEditingPinId(null);\n          setEditingRectId(null);\n          setEditingArrowId(null);\n          setEditingSketchId(null);\n          return;\n        }\n        if (selectedAnnotationId) {\n          select(null);\n          return;\n        }\n      }\n      if (ke.key === 'Delete' || ke.key === 'Backspace') {\n        if (selectedAnnotationId && !isEditing) {\n          remove(selectedAnnotationId);\n        }\n      }\n    };\n    const handleKeyUp = (e: Event) => {\n      const ke = e as KeyboardEvent;\n      if (ke.key === 'Control' || ke.key === 'Meta') setCtrlHeld(false);\n      if (ke.key === 'Alt') setAltHeld(false);\n    };\n\n    target.addEventListener('keydown', handleKeyDown);\n    target.addEventListener('keyup', handleKeyUp);\n    return () => {\n      target.removeEventListener('keydown', handleKeyDown);\n      target.removeEventListener('keyup', handleKeyUp);\n    };\n  }, [selectedAnnotationId, isEditing, isModifying, select, remove, isInline]);\n\n  // Image load\n  const handleImageLoad = useCallback(() => {\n    if (imgRef.current) {\n      setImageNaturals({ w: imgRef.current.naturalWidth, h: imgRef.current.naturalHeight });\n    }\n  }, []);\n\n  // Compute fitted image dimensions for inline mode — ensures both width AND height are constrained\n  const INLINE_PADDING = 32; // p-4 = 16px each side\n  const computeFittedSize = useCallback(() => {\n    if (!isInline || !viewportRef.current || imageNaturals.w === 0 || imageNaturals.h === 0) {\n      setFittedSize(null);\n      return;\n    }\n    const vw = viewportRef.current.clientWidth - INLINE_PADDING;\n    const vh = viewportRef.current.clientHeight - INLINE_PADDING;\n    if (vw <= 0 || vh <= 0) { setFittedSize(null); return; }\n    const imgAR = imageNaturals.w / imageNaturals.h;\n    const containerAR = vw / vh;\n    let w: number, h: number;\n    if (imgAR > containerAR) {\n      // Width-bound — landscape or wide image\n      w = Math.min(vw, imageNaturals.w);\n      h = w / imgAR;\n    } else {\n      // Height-bound — portrait or tall image\n      h = Math.min(vh, imageNaturals.h);\n      w = h * imgAR;\n    }\n    setFittedSize({ w: Math.round(w), h: Math.round(h) });\n  }, [isInline, imageNaturals]);\n\n  // Recompute fitted size when naturals change or viewport resizes\n  useEffect(() => {\n    computeFittedSize();\n    const viewport = viewportRef.current;\n    if (!viewport || !isInline) return;\n    const observer = new ResizeObserver(() => computeFittedSize());\n    observer.observe(viewport);\n    return () => observer.disconnect();\n  }, [computeFittedSize, isInline]);\n\n  // Sync canvas size — upscale buffer for crisp rendering at current zoom level\n  useEffect(() => {\n    const img = imgRef.current;\n    const canvas = canvasRef.current;\n    if (!img || !canvas) return;\n    const sync = () => {\n      const dw = img.offsetWidth;\n      const dh = img.offsetHeight;\n      // Use devicePixelRatio × zoom so annotations stay sharp when the CSS transform scales the canvas up\n      const dpr = window.devicePixelRatio || 1;\n      const ratio = Math.max(1, dpr * zoomView.scale);\n      const bw = Math.round(dw * ratio);\n      const bh = Math.round(dh * ratio);\n      if (canvas.width !== bw || canvas.height !== bh) {\n        canvas.width = bw;\n        canvas.height = bh;\n      }\n    };\n    sync();\n    const observer = new ResizeObserver(sync);\n    observer.observe(img);\n    return () => observer.disconnect();\n  }, [imageNaturals, zoomView.scale]);\n\n  // Canvas render loop — scale context to match hi-DPI buffer, draw in logical coords\n  useEffect(() => {\n    const render = () => {\n      const canvas = canvasRef.current;\n      const img = imgRef.current;\n      if (!canvas || !img) return;\n      const ctx = canvas.getContext('2d');\n      if (!ctx) return;\n\n      const dw = img.offsetWidth;\n      const dh = img.offsetHeight;\n      if (dw === 0 || dh === 0) { animFrameRef.current = requestAnimationFrame(render); return; }\n\n      // The canvas buffer is dw*ratio × dh*ratio, but we draw in logical (dw × dh) space\n      const ratioX = canvas.width / dw;\n      const ratioY = canvas.height / dh;\n\n      ctx.setTransform(ratioX, 0, 0, ratioY, 0, 0);\n      renderAnnotations(ctx, annotations, selectedAnnotationId, dw, dh, rubberBand, zoomView.scale);\n      ctx.setTransform(1, 0, 0, 1, 0, 0); // reset\n\n      animFrameRef.current = requestAnimationFrame(render);\n    };\n    animFrameRef.current = requestAnimationFrame(render);\n    return () => cancelAnimationFrame(animFrameRef.current);\n  }, [annotations, selectedAnnotationId, rubberBand, zoomView.scale]);\n\n  // --- Coordinate helpers ---\n  const getCanvasCoords = (e: React.MouseEvent): { cx: number; cy: number } | null => {\n    const img = imgRef.current;\n    if (!img) return null;\n    const imgRect = img.getBoundingClientRect();\n    const cx = (e.clientX - imgRect.left) / zoomView.scale;\n    const cy = (e.clientY - imgRect.top) / zoomView.scale;\n    return { cx, cy };\n  };\n\n  const getNormCoords = (e: React.MouseEvent): NormalizedPoint | null => {\n    const img = imgRef.current;\n    if (!img) return null;\n    const coords = getCanvasCoords(e);\n    if (!coords) return null;\n    return canvasToNormalized(coords.cx, coords.cy, img.offsetWidth, img.offsetHeight);\n  };\n\n  // --- Zoom helpers ---\n  const clampScale = (s: number) => Math.min(MAX_SCALE, Math.max(MIN_SCALE, s));\n\n  // Clamp pan so the image can't be dragged entirely off-screen.\n  // Prevents runaway transform values that crash the GPU compositor.\n  const clampPan = useCallback((px: number, py: number, scale: number): { panX: number; panY: number } => {\n    const viewport = viewportRef.current;\n    const img = imgRef.current;\n    if (!viewport || !img) return { panX: px, panY: py };\n    const vw = viewport.clientWidth;\n    const vh = viewport.clientHeight;\n    const iw = img.offsetWidth * scale;\n    const ih = img.offsetHeight * scale;\n    // The transform layer uses flex centering; compute offset from transform-origin (0,0)\n    const padX = isInline ? INLINE_PADDING / 2 : 0;\n    const padY = isInline ? INLINE_PADDING / 2 : 0;\n    const originX = (vw - img.offsetWidth) / 2 - padX;\n    const originY = (vh - img.offsetHeight) / 2 - padY;\n    // Allow panning until only 20% of the scaled image remains visible\n    const margin = 0.2;\n    const minX = -(iw * (1 - margin)) + vw * 0.1 - originX;\n    const maxX = vw * (1 - 0.1) - iw * margin - originX;\n    const minY = -(ih * (1 - margin)) + vh * 0.1 - originY;\n    const maxY = vh * (1 - 0.1) - ih * margin - originY;\n    return {\n      panX: Math.max(minX, Math.min(maxX, px)),\n      panY: Math.max(minY, Math.min(maxY, py)),\n    };\n  }, [isInline]);\n\n  const handleWheel = useCallback((e: WheelEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const rect = viewport.getBoundingClientRect();\n    const vx = e.clientX - rect.left;\n    const vy = e.clientY - rect.top;\n    const direction = e.deltaY < 0 ? 1 : -1;\n    setZoomView(prev => {\n      const ns = clampScale(prev.scale + direction * SCROLL_ZOOM_STEP);\n      const r = ns / prev.scale;\n      const rawPanX = vx - r * (vx - prev.panX);\n      const rawPanY = vy - r * (vy - prev.panY);\n      const clamped = clampPan(rawPanX, rawPanY, ns);\n      return { ...prev, scale: ns, ...clamped };\n    });\n  }, [MIN_SCALE, MAX_SCALE, clampPan]);\n\n  // Register wheel handler as non-passive to allow preventDefault()\n  useEffect(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    viewport.addEventListener('wheel', handleWheel, { passive: false });\n    return () => viewport.removeEventListener('wheel', handleWheel);\n  }, [handleWheel]);\n\n  const zoomToward = useCallback((vx: number, vy: number, newScale: number) => {\n    setZoomView(prev => {\n      const c = clampScale(newScale);\n      const r = c / prev.scale;\n      const rawPanX = vx - r * (vx - prev.panX);\n      const rawPanY = vy - r * (vy - prev.panY);\n      const clamped = clampPan(rawPanX, rawPanY, c);\n      return { ...prev, scale: c, ...clamped };\n    });\n  }, [MIN_SCALE, MAX_SCALE, clampPan]);\n\n  // Center-based zoom in/out (for toolbar buttons)\n  const handleZoomIn = useCallback(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const rect = viewport.getBoundingClientRect();\n    zoomToward(rect.width / 2, rect.height / 2, zoomView.scale + ZOOM_STEP);\n  }, [zoomView.scale, zoomToward]);\n\n  const handleZoomOut = useCallback(() => {\n    const viewport = viewportRef.current;\n    if (!viewport) return;\n    const rect = viewport.getBoundingClientRect();\n    zoomToward(rect.width / 2, rect.height / 2, zoomView.scale - ZOOM_STEP);\n  }, [zoomView.scale, zoomToward]);\n\n  const handleZoomReset = useCallback(() => {\n    setZoomView({ scale: 1, panX: 0, panY: 0, isPanning: false });\n  }, []);\n\n  // --- VERSION HISTORY HELPERS ---\n  const handleRestorePrevious = useCallback(() => {\n    const url = restorePrevious();\n    if (url) { setCurrentImageUrl(url); clearAll(); select(null); }\n  }, [restorePrevious, clearAll, select]);\n\n  const handleRestoreNext = useCallback(() => {\n    const url = restoreNext();\n    if (url) { setCurrentImageUrl(url); clearAll(); select(null); }\n  }, [restoreNext, clearAll, select]);\n\n  const handleRestoreByIndex = useCallback((index: number) => {\n    const url = restoreByIndex(index);\n    if (url) { setCurrentImageUrl(url); clearAll(); select(null); }\n  }, [restoreByIndex, clearAll, select]);\n\n  // --- MODIFICATION ENGINE ---\n  const canModify = annotations.length > 0 || !!contentDirty || !!globalInstruction.trim();\n\n  const handleModify = useCallback(async () => {\n    if (!canModify || isModifying) return;\n    if (!displayImageUrl) return;\n\n    const hasAnnotations = annotations.length > 0;\n    const hasGlobalText = !!globalInstruction.trim();\n    const isContentOnly = !hasAnnotations && !hasGlobalText && !!contentDirty && !!currentContent;\n\n    // Annotation-based modification needs image naturals for redline\n    if (hasAnnotations && (imageNaturals.w === 0 || imageNaturals.h === 0)) return;\n\n    setIsModifying(true);\n    setModifyError(null);\n\n    try {\n      let result;\n\n      if (isContentOnly) {\n        // Content-only: send reference image + new content\n        result = await executeContentModification({\n          originalImageUrl: displayImageUrl,\n          content: currentContent,\n          cardText,\n          style,\n          palette: palette ? {\n            background: palette.background,\n            primary: palette.primary,\n            secondary: palette.secondary,\n            accent: palette.accent,\n            text: palette.text,\n          } : undefined,\n          aspectRatio,\n          resolution,\n        }, onUsage);\n      } else {\n        // Annotation-based (or global instruction): send original + redline + instructions\n        const { redlineDataUrl, instructions } = hasAnnotations\n          ? generateRedlineMap(annotations, imageNaturals.w, imageNaturals.h)\n          : { redlineDataUrl: '', instructions: '' };\n\n        // Prepend global instruction before spatial annotations\n        let combinedInstructions = '';\n        if (hasGlobalText) {\n          combinedInstructions += `[GLOBAL INSTRUCTION]: \"${globalInstruction.trim()}\"`;\n          if (instructions) combinedInstructions += '\\n\\n';\n        }\n        if (instructions) combinedInstructions += instructions;\n\n        result = await executeModification({\n          originalImageUrl: displayImageUrl,\n          redlineDataUrl,\n          instructions: combinedInstructions,\n          cardText,\n          aspectRatio,\n          resolution,\n        }, onUsage);\n      }\n\n      setCurrentImageUrl(result.newImageUrl);\n      const label = isContentOnly\n        ? `Content Update ${modificationCount + 1}`\n        : `Modification ${modificationCount + 1}`;\n      pushVersion(result.newImageUrl, label);\n      clearAll();\n      select(null);\n      setGlobalInstruction('');\n\n      if (onImageModified && cardId) {\n        const updatedVersions: ImageVersion[] = [\n          ...versions.slice(0, currentIndex + 1),\n          { imageUrl: result.newImageUrl, timestamp: Date.now(), label },\n        ];\n        while (updatedVersions.length > 10) updatedVersions.shift();\n        onImageModified(cardId, result.newImageUrl, updatedVersions);\n      }\n    } catch (err: any) {\n      console.error('Modification failed:', err);\n      setModifyError(err.message || 'Modification failed. Please try again.');\n    } finally {\n      setIsModifying(false);\n    }\n  }, [canModify, isModifying, annotations, globalInstruction, contentDirty, currentContent, imageNaturals, displayImageUrl, cardText, cardId, style, palette, aspectRatio, resolution, onImageModified, onUsage, clearAll, select, pushVersion, modificationCount, versions, currentIndex]);\n\n  // Refs to avoid stale closures in toolbar state callback\n  const handleModifyRef = useRef(handleModify);\n  handleModifyRef.current = handleModify;\n  const handleZoomInRef = useRef(handleZoomIn);\n  handleZoomInRef.current = handleZoomIn;\n  const handleZoomOutRef = useRef(handleZoomOut);\n  handleZoomOutRef.current = handleZoomOut;\n\n  // Notify parent of toolbar state changes\n  useEffect(() => {\n    onToolbarStateChangeRef.current?.({\n      activeTool,\n      onToolChange: setActiveTool,\n      annotationCount: annotations.length,\n      onDiscardMarks: clearAll,\n      onModify: () => handleModifyRef.current(),\n      isModifying,\n      activeColor,\n      onColorChange: (color: string) => setActiveColor(color),\n      palette: palette || undefined,\n      contentDirty,\n      hasSelection: !!selectedAnnotationId,\n      onDeleteSelected: () => { if (selectedAnnotationId) remove(selectedAnnotationId); },\n      zoomScale: zoomView.scale,\n      onZoomIn: () => handleZoomInRef.current(),\n      onZoomOut: () => handleZoomOutRef.current(),\n      onZoomReset: handleZoomReset,\n      onRequestFullscreen: isInline ? onRequestFullscreen : undefined,\n      globalInstruction,\n      onGlobalInstructionChange: (text: string) => setGlobalInstruction(text),\n    });\n  }, [activeTool, annotations.length, isModifying, activeColor, palette, contentDirty, selectedAnnotationId, clearAll, remove, zoomView.scale, globalInstruction]);\n\n  // --- Mouse handlers ---\n  const handleMouseDown = useCallback((e: React.MouseEvent) => {\n    if (isEditing || isModifying) return;\n\n    const norm = getNormCoords(e);\n    const canvas = canvasRef.current;\n    const coords = getCanvasCoords(e);\n\n    // PAN: zoom tool + alt\n    if (activeTool === 'zoom' && altHeld) {\n      e.preventDefault();\n      e.stopPropagation();\n      panStartRef.current = { x: e.clientX, y: e.clientY, panX: zoomView.panX, panY: zoomView.panY };\n      didPanRef.current = false;\n      setZoomView(prev => ({ ...prev, isPanning: true }));\n      return;\n    }\n\n    // SELECT TOOL\n    if (activeTool === 'select' && coords && canvas) {\n      if (selectedAnnotationId) {\n        const selAnn = annotations.find(a => a.id === selectedAnnotationId);\n        if (selAnn) {\n          const img = imgRef.current;\n          const logW = img ? img.offsetWidth : canvas.width;\n          const logH = img ? img.offsetHeight : canvas.height;\n          const handle = hitTestHandle(selAnn, coords.cx, coords.cy, logW, logH, zoomView.scale);\n          if (handle && norm) {\n            e.preventDefault();\n            e.stopPropagation();\n            dragStartRef.current = { annotationId: selectedAnnotationId, startNorm: norm, handle };\n            setIsDragging(true);\n            return;\n          }\n        }\n      }\n      const hitImg = imgRef.current;\n      const hitLogW = hitImg ? hitImg.offsetWidth : canvas.width;\n      const hitLogH = hitImg ? hitImg.offsetHeight : canvas.height;\n      const hitId = hitTestAnnotation(annotations, coords.cx, coords.cy, hitLogW, hitLogH, zoomView.scale);\n      if (hitId && norm) {\n        e.preventDefault();\n        e.stopPropagation();\n        select(hitId);\n        dragStartRef.current = { annotationId: hitId, startNorm: norm, handle: null };\n        setIsDragging(true);\n        return;\n      }\n      select(null);\n      if (zoomView.scale > 1) {\n        e.preventDefault();\n        panStartRef.current = { x: e.clientX, y: e.clientY, panX: zoomView.panX, panY: zoomView.panY };\n        didPanRef.current = false;\n        setZoomView(prev => ({ ...prev, isPanning: true }));\n      }\n      return;\n    }\n\n    // RECTANGLE TOOL\n    if (activeTool === 'rectangle' && norm) {\n      e.preventDefault();\n      e.stopPropagation();\n      rectStartRef.current = norm;\n      setRubberBand({ type: 'rectangle', topLeft: norm, bottomRight: norm, color: activeColor });\n      return;\n    }\n\n    // ARROW TOOL\n    if (activeTool === 'arrow' && norm) {\n      e.preventDefault();\n      e.stopPropagation();\n      arrowStartRef.current = norm;\n      setRubberBand({ type: 'arrow', start: norm, end: norm, color: activeColor });\n      return;\n    }\n\n    // SKETCH TOOL\n    if (activeTool === 'sketch' && norm) {\n      e.preventDefault();\n      e.stopPropagation();\n      isSketchingRef.current = true;\n      sketchPointsRef.current = [norm];\n      setRubberBand({ type: 'sketch', points: [norm], color: activeColor, strokeWidth: DEFAULT_SKETCH_STROKE_WIDTH });\n      return;\n    }\n  }, [activeTool, altHeld, zoomView, annotations, selectedAnnotationId, activeColor, isEditing, isModifying, select]);\n\n  const handleMouseMove = useCallback((e: React.MouseEvent) => {\n    if (panStartRef.current) {\n      e.preventDefault();\n      const dx = e.clientX - panStartRef.current.x;\n      const dy = e.clientY - panStartRef.current.y;\n      if (Math.abs(dx) > 3 || Math.abs(dy) > 3) didPanRef.current = true;\n      setZoomView(prev => {\n        const rawPanX = panStartRef.current!.panX + dx;\n        const rawPanY = panStartRef.current!.panY + dy;\n        const clamped = clampPan(rawPanX, rawPanY, prev.scale);\n        return { ...prev, ...clamped };\n      });\n      return;\n    }\n\n    if (rectStartRef.current && activeTool === 'rectangle') {\n      const norm = getNormCoords(e);\n      if (!norm) return;\n      const s = rectStartRef.current;\n      setRubberBand({\n        type: 'rectangle',\n        topLeft: { x: Math.min(s.x, norm.x), y: Math.min(s.y, norm.y) },\n        bottomRight: { x: Math.max(s.x, norm.x), y: Math.max(s.y, norm.y) },\n        color: activeColor,\n      });\n      return;\n    }\n\n    if (arrowStartRef.current && activeTool === 'arrow') {\n      const norm = getNormCoords(e);\n      if (!norm) return;\n      setRubberBand({ type: 'arrow', start: arrowStartRef.current, end: norm, color: activeColor });\n      return;\n    }\n\n    if (isSketchingRef.current && activeTool === 'sketch') {\n      const norm = getNormCoords(e);\n      if (!norm) return;\n      sketchPointsRef.current.push(norm);\n      setRubberBand({ type: 'sketch', points: [...sketchPointsRef.current], color: activeColor, strokeWidth: DEFAULT_SKETCH_STROKE_WIDTH });\n      return;\n    }\n\n    if (isDragging && dragStartRef.current) {\n      const norm = getNormCoords(e);\n      if (!norm) return;\n      const { annotationId, startNorm, handle } = dragStartRef.current;\n      const dx = norm.x - startNorm.x;\n      const dy = norm.y - startNorm.y;\n\n      if (handle) {\n        const ann = annotations.find(a => a.id === annotationId);\n        if (ann && ann.type === 'rectangle') {\n          const newRect = { ...ann };\n          if (handle === 'tl') {\n            newRect.topLeft = { x: Math.min(norm.x, ann.bottomRight.x - 0.01), y: Math.min(norm.y, ann.bottomRight.y - 0.01) };\n          } else if (handle === 'tr') {\n            newRect.topLeft = { ...ann.topLeft, y: Math.min(norm.y, ann.bottomRight.y - 0.01) };\n            newRect.bottomRight = { ...ann.bottomRight, x: Math.max(norm.x, ann.topLeft.x + 0.01) };\n          } else if (handle === 'bl') {\n            newRect.topLeft = { ...ann.topLeft, x: Math.min(norm.x, ann.bottomRight.x - 0.01) };\n            newRect.bottomRight = { ...ann.bottomRight, y: Math.max(norm.y, ann.topLeft.y + 0.01) };\n          } else if (handle === 'br') {\n            newRect.bottomRight = { x: Math.max(norm.x, ann.topLeft.x + 0.01), y: Math.max(norm.y, ann.topLeft.y + 0.01) };\n          }\n          update(annotationId, { topLeft: newRect.topLeft, bottomRight: newRect.bottomRight });\n          dragStartRef.current = { ...dragStartRef.current, startNorm: norm };\n        } else if (ann && ann.type === 'arrow') {\n          if (handle === 'start') update(annotationId, { start: norm });\n          else if (handle === 'end') update(annotationId, { end: norm });\n          dragStartRef.current = { ...dragStartRef.current, startNorm: norm };\n        }\n      } else {\n        moveAnnotation(annotationId, dx, dy);\n        dragStartRef.current = { ...dragStartRef.current, startNorm: norm };\n      }\n      return;\n    }\n  }, [activeTool, activeColor, isDragging, annotations, update, moveAnnotation, clampPan]);\n\n  const handleMouseUp = useCallback((e: React.MouseEvent) => {\n    if (panStartRef.current) {\n      panStartRef.current = null;\n      setZoomView(prev => ({ ...prev, isPanning: false }));\n      return;\n    }\n\n    if (rectStartRef.current && activeTool === 'rectangle') {\n      const norm = getNormCoords(e);\n      if (norm) {\n        const s = rectStartRef.current;\n        const tl: NormalizedPoint = { x: Math.min(s.x, norm.x), y: Math.min(s.y, norm.y) };\n        const br: NormalizedPoint = { x: Math.max(s.x, norm.x), y: Math.max(s.y, norm.y) };\n        if (br.x - tl.x >= MIN_RECT_SIZE && br.y - tl.y >= MIN_RECT_SIZE) {\n          const newRect: RectangleAnnotation = {\n            id: createAnnotationId(), type: 'rectangle', color: activeColor, createdAt: Date.now(),\n            topLeft: tl, bottomRight: br, instruction: '',\n          };\n          add(newRect);\n          setEditingRectId(newRect.id);\n        }\n      }\n      rectStartRef.current = null;\n      setRubberBand(null);\n      return;\n    }\n\n    if (arrowStartRef.current && activeTool === 'arrow') {\n      const norm = getNormCoords(e);\n      if (norm) {\n        const s = arrowStartRef.current;\n        const length = Math.sqrt((norm.x - s.x) ** 2 + (norm.y - s.y) ** 2);\n        if (length >= MIN_ARROW_LENGTH) {\n          const newArrow: ArrowAnnotation = {\n            id: createAnnotationId(), type: 'arrow', color: activeColor, createdAt: Date.now(),\n            start: s, end: norm, instruction: '',\n          };\n          add(newArrow);\n          setEditingArrowId(newArrow.id);\n        }\n      }\n      arrowStartRef.current = null;\n      setRubberBand(null);\n      return;\n    }\n\n    if (isSketchingRef.current && activeTool === 'sketch') {\n      const points = sketchPointsRef.current;\n      if (points.length >= 2) {\n        const simplified = simplifyPath(points, 0.003);\n        const newSketch: SketchAnnotation = {\n          id: createAnnotationId(), type: 'sketch', color: activeColor, createdAt: Date.now(),\n          points: simplified, strokeWidth: DEFAULT_SKETCH_STROKE_WIDTH, instruction: '',\n        };\n        add(newSketch);\n        setEditingSketchId(newSketch.id);\n      }\n      isSketchingRef.current = false;\n      sketchPointsRef.current = [];\n      setRubberBand(null);\n      return;\n    }\n\n    if (isDragging) {\n      dragStartRef.current = null;\n      setIsDragging(false);\n      return;\n    }\n  }, [activeTool, activeColor, isDragging, add]);\n\n  const handleClick = useCallback((e: React.MouseEvent) => {\n    if (didPanRef.current) { didPanRef.current = false; return; }\n    if (isEditing || isModifying) return;\n\n    if (activeTool === 'zoom' && !altHeld) {\n      const viewport = viewportRef.current;\n      if (!viewport) return;\n      const rect = viewport.getBoundingClientRect();\n      const vx = e.clientX - rect.left;\n      const vy = e.clientY - rect.top;\n      if (ctrlHeld) zoomToward(vx, vy, zoomView.scale - ZOOM_STEP);\n      else zoomToward(vx, vy, zoomView.scale + ZOOM_STEP);\n      return;\n    }\n\n    if (activeTool === 'pin') {\n      const norm = getNormCoords(e);\n      if (!norm) return;\n      const newPin: PinAnnotation = {\n        id: createAnnotationId(), type: 'pin', color: activeColor, createdAt: Date.now(),\n        position: norm, instruction: '',\n      };\n      add(newPin);\n      setEditingPinId(newPin.id);\n      return;\n    }\n\n    if (activeTool === 'select' && selectedAnnotationId) {\n      const selAnn = annotations.find(a => a.id === selectedAnnotationId);\n      if (selAnn?.type === 'pin') setEditingPinId(selectedAnnotationId);\n      else if (selAnn?.type === 'rectangle') setEditingRectId(selectedAnnotationId);\n      else if (selAnn?.type === 'arrow') setEditingArrowId(selectedAnnotationId);\n      else if (selAnn?.type === 'sketch') setEditingSketchId(selectedAnnotationId);\n    }\n  }, [activeTool, altHeld, ctrlHeld, zoomView.scale, zoomToward, activeColor, add, selectedAnnotationId, annotations, isEditing, isModifying]);\n\n  // --- Editor popover screen positions ---\n  const getAnnotationScreenPos = (id: string): { x: number; y: number } => {\n    const ann = annotations.find(a => a.id === id);\n    const img = imgRef.current;\n    if (!ann || !img) return { x: 0, y: 0 };\n    const imgRect = img.getBoundingClientRect();\n    if (ann.type === 'pin') {\n      return {\n        x: imgRect.left + ann.position.x * img.offsetWidth * zoomView.scale,\n        y: imgRect.top + ann.position.y * img.offsetHeight * zoomView.scale,\n      };\n    }\n    if (ann.type === 'rectangle') {\n      const midX = (ann.topLeft.x + ann.bottomRight.x) / 2;\n      return {\n        x: imgRect.left + midX * img.offsetWidth * zoomView.scale,\n        y: imgRect.top + ann.topLeft.y * img.offsetHeight * zoomView.scale,\n      };\n    }\n    if (ann.type === 'arrow') {\n      const midX = (ann.start.x + ann.end.x) / 2;\n      const midY = (ann.start.y + ann.end.y) / 2;\n      return {\n        x: imgRect.left + midX * img.offsetWidth * zoomView.scale,\n        y: imgRect.top + midY * img.offsetHeight * zoomView.scale,\n      };\n    }\n    if (ann.type === 'sketch' && ann.points.length > 0) {\n      let minX = 1, maxX = 0, minY = 1;\n      for (const p of ann.points) {\n        if (p.x < minX) minX = p.x;\n        if (p.x > maxX) maxX = p.x;\n        if (p.y < minY) minY = p.y;\n      }\n      const midX = (minX + maxX) / 2;\n      return {\n        x: imgRect.left + midX * img.offsetWidth * zoomView.scale,\n        y: imgRect.top + minY * img.offsetHeight * zoomView.scale,\n      };\n    }\n    return { x: 0, y: 0 };\n  };\n\n  const getCursorClass = () => {\n    if (isModifying) return 'zoom-tool-select';\n    if (activeTool === 'zoom') {\n      if (zoomView.isPanning) return 'zoom-tool-zoom alt-held panning';\n      if (altHeld) return 'zoom-tool-zoom alt-held';\n      if (ctrlHeld) return 'zoom-tool-zoom ctrl-held';\n      return 'zoom-tool-zoom';\n    }\n    if (activeTool === 'select') return 'zoom-tool-select';\n    if (activeTool === 'pin') return 'zoom-tool-pin';\n    if (activeTool === 'text') return 'zoom-tool-select';\n    if (activeTool === 'rectangle' || activeTool === 'arrow' || activeTool === 'sketch') return 'zoom-tool-crosshair';\n    return 'zoom-tool-crosshair';\n  };\n\n  const handleColorChange = useCallback((color: string) => setActiveColor(color), []);\n\n  const handleMouseLeave = useCallback(() => {\n    panStartRef.current = null;\n    if (rectStartRef.current) { rectStartRef.current = null; setRubberBand(null); }\n    if (arrowStartRef.current) { arrowStartRef.current = null; setRubberBand(null); }\n    if (isSketchingRef.current) {\n      const points = sketchPointsRef.current;\n      if (points.length >= 2) {\n        const simplified = simplifyPath(points, 0.003);\n        const sketchId = createAnnotationId();\n        add({\n          id: sketchId, type: 'sketch', color: activeColor, createdAt: Date.now(),\n          points: simplified, strokeWidth: DEFAULT_SKETCH_STROKE_WIDTH, instruction: '',\n        });\n        setEditingSketchId(sketchId);\n      }\n      isSketchingRef.current = false;\n      sketchPointsRef.current = [];\n      setRubberBand(null);\n    }\n    if (isDragging) { dragStartRef.current = null; setIsDragging(false); }\n    setZoomView(prev => ({ ...prev, isPanning: false }));\n  }, [activeColor, isDragging, add]);\n\n  if (!displayImageUrl) return null;\n\n  const editingPin = editingPinId ? annotations.find(a => a.id === editingPinId && a.type === 'pin') as PinAnnotation | undefined : undefined;\n  const editingRect = editingRectId ? annotations.find(a => a.id === editingRectId && a.type === 'rectangle') as RectangleAnnotation | undefined : undefined;\n  const editingArrow = editingArrowId ? annotations.find(a => a.id === editingArrowId && a.type === 'arrow') as ArrowAnnotation | undefined : undefined;\n  const editingSketch = editingSketchId ? annotations.find(a => a.id === editingSketchId && a.type === 'sketch') as SketchAnnotation | undefined : undefined;\n\n  const imageClasses = isInline\n    ? 'block max-w-full max-h-full object-contain shadow-[0_0_0_1px_rgba(0,0,0,0.15),0_8px_32px_rgba(0,0,0,0.12)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.15),0_8px_32px_rgba(0,0,0,0.3)]'\n    : 'max-w-[90vw] max-h-[85vh] object-contain shadow-[0_0_0_1px_rgba(0,0,0,0.15),0_50px_100px_rgba(0,0,0,0.1)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.15),0_50px_100px_rgba(0,0,0,0.3)]';\n\n  return (\n    <div className=\"relative w-full h-full\" tabIndex={isInline ? 0 : undefined} style={{ outline: 'none' }}>\n      {/* Top-right controls: version history + fullscreen */}\n      <div className={`absolute top-3 right-3 z-[15] flex items-center space-x-2`}>\n        {versions.length > 1 && (\n          <>\n            <button\n              onClick={handleRestorePrevious}\n              disabled={!canUndo || isModifying}\n              title=\"Undo\"\n              className={`w-7 h-7 flex items-center justify-center rounded-full transition-all ${\n                canUndo && !isModifying\n                  ? 'bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm border border-zinc-100 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200'\n                  : 'bg-white/40 dark:bg-zinc-900/40 border border-zinc-50 dark:border-zinc-800 text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'\n              }`}\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M9 14L4 9l5-5\"/><path d=\"M20 20v-7a4 4 0 0 0-4-4H4\"/>\n              </svg>\n            </button>\n            <button\n              onClick={handleRestoreNext}\n              disabled={!canRedo || isModifying}\n              title=\"Redo\"\n              className={`w-7 h-7 flex items-center justify-center rounded-full transition-all ${\n                canRedo && !isModifying\n                  ? 'bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm border border-zinc-100 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200'\n                  : 'bg-white/40 dark:bg-zinc-900/40 border border-zinc-50 dark:border-zinc-800 text-zinc-600 dark:text-zinc-400 opacity-40 cursor-not-allowed'\n              }`}\n            >\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M15 14l5-5-5-5\"/><path d=\"M4 20v-7a4 4 0 0 1 4-4h12\"/>\n              </svg>\n            </button>\n            <button\n              onClick={() => setShowVersionStrip(!showVersionStrip)}\n              title=\"Version History\"\n              className=\"text-[9px] font-bold text-zinc-600 dark:text-zinc-400 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm px-2 py-1.5 rounded-full border border-zinc-100 dark:border-zinc-700 hover:text-zinc-800 dark:hover:text-zinc-200 transition-colors\"\n            >\n              v{currentIndex + 1}/{versions.length}\n            </button>\n          </>\n        )}\n      </div>\n\n      {/* Version history thumbnail strip */}\n      {showVersionStrip && versions.length > 1 && (\n        <div className={`absolute top-12 right-3 z-[16] bg-white/95 dark:bg-zinc-900/95 backdrop-blur-xl rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 p-3 animate-in fade-in slide-in-from-top-2 duration-200 ${isInline ? 'max-w-[280px]' : 'max-w-[400px]'}`}>\n          <div className=\"text-[9px] font-black uppercase tracking-[0.2em] text-black mb-2 px-1\">Version History</div>\n          <div className=\"flex items-center space-x-2 overflow-x-auto pb-1\">\n            {versions.map((v, i) => (\n              <button\n                key={`${v.timestamp}-${i}`}\n                onClick={() => handleRestoreByIndex(i)}\n                disabled={isModifying}\n                title={`${v.label} — ${new Date(v.timestamp).toLocaleTimeString()}`}\n                className={`relative shrink-0 w-10 h-10 rounded-lg overflow-hidden border-2 transition-all hover:scale-110 ${\n                  i === currentIndex\n                    ? 'border-[#2a9fd4] shadow-[0_0_0_2px_rgba(42,159,212,0.3)]'\n                    : 'border-zinc-200 dark:border-zinc-700 hover:border-zinc-400 dark:hover:border-zinc-500'\n                } ${isModifying ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}\n              >\n                <img src={v.imageUrl} alt={v.label} className=\"w-full h-full object-cover\" />\n                {i === currentIndex && <div className=\"absolute inset-0 bg-[#2a9fd4]/10\" />}\n              </button>\n            ))}\n          </div>\n          <div className=\"flex items-center justify-between mt-1 px-1\">\n            <span className=\"text-[7px] text-zinc-500 dark:text-zinc-400\">{versions[currentIndex]?.label}</span>\n            <span className=\"text-[7px] text-zinc-500 dark:text-zinc-400\">\n              {versions[currentIndex] ? new Date(versions[currentIndex].timestamp).toLocaleTimeString() : ''}\n            </span>\n          </div>\n        </div>\n      )}\n\n      {/* Modification overlay */}\n      {isModifying && (\n        <div className=\"absolute inset-0 z-[18] flex items-center justify-center bg-[#2a9fd4]/10 backdrop-blur-sm pointer-events-none\">\n          <div className=\"flex flex-col items-center space-y-3 animate-pulse\">\n            <div className=\"w-12 h-12 rounded-full border-4 border-[#2a9fd4] border-t-transparent animate-spin\" />\n            <span className=\"text-[11px] font-black uppercase tracking-[0.2em] text-zinc-600 dark:text-zinc-400\">Refining...</span>\n            <span className=\"text-[9px] text-zinc-500 dark:text-zinc-400 max-w-[240px] text-center\">AI is applying your modifications</span>\n          </div>\n        </div>\n      )}\n\n      {/* Error toast */}\n      {modifyError && (\n        <div className=\"absolute top-3 left-1/2 -translate-x-1/2 z-[20] bg-red-50 dark:bg-red-950/50 border border-red-200 dark:border-red-800 rounded-2xl px-4 py-2 flex items-center space-x-2 shadow-lg dark:shadow-black/30 animate-in fade-in slide-in-from-top-2 duration-300\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#E63946\" strokeWidth=\"2.5\">\n            <circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/><line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/>\n          </svg>\n          <span className=\"text-[10px] text-red-700 max-w-[300px]\">{modifyError}</span>\n          <button onClick={() => setModifyError(null)} className=\"text-red-400 hover:text-red-600 transition-colors ml-1\">\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\"><path d=\"M18 6L6 18M6 6l12 12\"/></svg>\n          </button>\n        </div>\n      )}\n\n      {/* Viewport */}\n      <div\n        ref={viewportRef}\n        tabIndex={0}\n        className={`relative w-full h-full overflow-hidden select-none outline-none ${getCursorClass()}`}\n        onClick={handleClick}\n        onMouseDown={handleMouseDown}\n        onMouseMove={handleMouseMove}\n        onMouseUp={handleMouseUp}\n        onMouseLeave={handleMouseLeave}\n      >\n        {/* Transform layer */}\n        <div\n          className={`absolute inset-0 flex items-center justify-center ${isInline ? 'p-4' : ''}`}\n          style={{\n            transform: `translate(${zoomView.panX}px, ${zoomView.panY}px) scale(${zoomView.scale})`,\n            transformOrigin: '0 0',\n            transition: zoomView.isPanning || isDragging || rubberBand ? 'none' : 'transform 0.2s ease-out',\n          }}\n        >\n          <div className={`relative ${isInline ? 'max-w-full max-h-full' : 'inline-block'}`}>\n            <img\n              ref={imgRef}\n              src={displayImageUrl}\n              alt=\"Asset\"\n              draggable={false}\n              onLoad={handleImageLoad}\n              className={imageClasses}\n              style={isInline && fittedSize ? { width: fittedSize.w, height: fittedSize.h } : undefined}\n            />\n            <canvas\n              ref={canvasRef}\n              className=\"absolute top-0 left-0 w-full h-full pointer-events-none\"\n              style={{}}\n            />\n            {overlay}\n          </div>\n        </div>\n      </div>\n\n      {/* Pin Editor Popover */}\n      {editingPin && editingPinId && (\n        <PinEditor\n          instruction={editingPin.instruction}\n          position={getAnnotationScreenPos(editingPinId)}\n          onSave={(instruction) => update(editingPinId, { instruction })}\n          onDelete={() => { remove(editingPinId); setEditingPinId(null); }}\n          onClose={() => setEditingPinId(null)}\n        />\n      )}\n\n      {/* Rectangle Editor Popover */}\n      {editingRect && editingRectId && (\n        <RectangleEditor\n          instruction={editingRect.instruction}\n          position={getAnnotationScreenPos(editingRectId)}\n          onSave={(instruction) => update(editingRectId, { instruction })}\n          onDelete={() => { remove(editingRectId); setEditingRectId(null); }}\n          onClose={() => setEditingRectId(null)}\n        />\n      )}\n\n      {/* Arrow Editor Popover */}\n      {editingArrow && editingArrowId && (\n        <RectangleEditor\n          instruction={editingArrow.instruction}\n          position={getAnnotationScreenPos(editingArrowId)}\n          onSave={(instruction) => update(editingArrowId, { instruction })}\n          onDelete={() => { remove(editingArrowId); setEditingArrowId(null); }}\n          onClose={() => setEditingArrowId(null)}\n        />\n      )}\n\n      {/* Sketch Editor Popover */}\n      {editingSketch && editingSketchId && (\n        <RectangleEditor\n          instruction={editingSketch.instruction}\n          position={getAnnotationScreenPos(editingSketchId)}\n          onSave={(instruction) => update(editingSketchId, { instruction })}\n          onDelete={() => { remove(editingSketchId); setEditingSketchId(null); }}\n          onClose={() => setEditingSketchId(null)}\n        />\n      )}\n\n      {/* Annotation Toolbar: render inline only if parent doesn't handle it */}\n      {!onToolbarStateChange && (\n        <AnnotationToolbar\n          activeTool={activeTool}\n          onToolChange={setActiveTool}\n          annotationCount={annotations.length}\n          onDiscardMarks={clearAll}\n          onModify={handleModify}\n          isModifying={isModifying}\n          activeColor={activeColor}\n          onColorChange={handleColorChange}\n          palette={palette || undefined}\n          contentDirty={contentDirty}\n          hasSelection={!!selectedAnnotationId}\n          onDeleteSelected={() => { if (selectedAnnotationId) remove(selectedAnnotationId); }}\n          globalInstruction={globalInstruction}\n          onGlobalInstructionChange={setGlobalInstruction}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default AnnotationWorkbench;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\workbench\\CanvasRenderer.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 23 to the 15 allowed.","line":38,"column":18,"nodeType":null,"messageId":"refactorFunction","endLine":38,"endColumn":20},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":40,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":40,"endColumn":26},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":52,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":52,"endColumn":51,"fix":{"range":[1748,1760],"text":"{return a.id;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":67,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":67,"endColumn":53,"fix":{"range":[2404,2416],"text":"{return a.id;}"}},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":68,"column":12,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":68,"endColumn":14},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":69,"column":7,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":74,"endColumn":8,"fix":{"range":[2431,2743],"text":"(a.type === 'sketch' && a.points.length > 0) {\n        const normPt = canvasToNormalized(canvasX, canvasY, canvasW, canvasH);\n        const dist = distanceToPolyline(normPt, a.points);\n        const avgDim = (canvasW + canvasH) / 2;\n        if (dist * avgDim <= sketchHitTol) return a.id;\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":73,"column":44,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":73,"endColumn":56,"fix":{"range":[2717,2729],"text":"{return a.id;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":93,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":93,"endColumn":26},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":113,"column":91,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":113,"endColumn":106,"fix":{"range":[4037,4052],"text":"{return 'start';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":114,"column":89,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":114,"endColumn":102,"fix":{"range":[4141,4154],"text":"{return 'end';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":159,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":159,"endColumn":46,"fix":{"range":[5274,5281],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.25.","line":162,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":162,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":172,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":172,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":172,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":172,"endColumn":32},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":174,"column":23,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":174,"endColumn":46,"fix":{"range":[5908,5931],"text":"`${rubberBand.color  }10`"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2.5.","line":182,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":182,"endColumn":26},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":183,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":183,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":183,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":183,"endColumn":32},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawArrowhead' was used before it was defined.","line":188,"column":7,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":188,"endColumn":20},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":188,"column":68,"nodeType":"Literal","messageId":"noMagic","endLine":188,"endColumn":70},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawSketchPath' was used before it was defined.","line":191,"column":7,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":191,"endColumn":21},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawPin' was used before it was defined.","line":202,"column":7,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":202,"endColumn":14},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawRectangle' was used before it was defined.","line":205,"column":7,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":205,"endColumn":20},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawArrow' was used before it was defined.","line":207,"column":7,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":207,"endColumn":16},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawSketch' was used before it was defined.","line":209,"column":7,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":209,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":232,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":232,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":247,"column":23,"nodeType":"Literal","messageId":"noMagic","endLine":247,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2.5.","line":249,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":249,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":255,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":255,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":263,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":263,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":289,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":289,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":289,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":289,"endColumn":28},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":293,"column":19,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":293,"endColumn":36,"fix":{"range":[9035,9052],"text":"`${rect.color  }0D`"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":299,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":299,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":300,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":300,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":301,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":301,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":302,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":302,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":305,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":305,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":305,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":305,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":308,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":308,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":311,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":311,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":328,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":328,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.5.","line":335,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":335,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":336,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":336,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":337,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":337,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":337,"column":53,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":337,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":337,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":358,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":358,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 2.5.","line":363,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":363,"endColumn":22},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawArrowhead' was used before it was defined.","line":373,"column":3,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":373,"endColumn":16},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 14.","line":373,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":373,"endColumn":61},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":381,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":381,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":381,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":381,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":384,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":384,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":387,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":387,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":397,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":397,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.5.","line":404,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":404,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":405,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":405,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":428,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":428,"endColumn":32},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":456,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":456,"endColumn":40,"fix":{"range":[12898,12905],"text":"{return;}"}},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'drawSketchPath' was used before it was defined.","line":458,"column":3,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":458,"endColumn":17},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":464,"column":37,"nodeType":"Literal","messageId":"noMagic","endLine":464,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":465,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":465,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":466,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":466,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":471,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":471,"endColumn":43},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":471,"column":65,"nodeType":"Literal","messageId":"noMagic","endLine":471,"endColumn":66},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":474,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":474,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":477,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":477,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.5.","line":489,"column":21,"nodeType":"Literal","messageId":"noMagic","endLine":489,"endColumn":24},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":490,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":490,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":491,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":491,"endColumn":28},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":491,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":491,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":491,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":491,"endColumn":64},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":491,"column":84,"nodeType":"Literal","messageId":"noMagic","endLine":491,"endColumn":86},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":510,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":510,"endColumn":33,"fix":{"range":[14473,14480],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8.","line":526,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":526,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":526,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":526,"endColumn":28},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":530,"column":19,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":530,"endColumn":31,"fix":{"range":[14968,14980],"text":"`${color  }0D`"}}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":71,"fixableErrorCount":0,"fixableWarningCount":12,"source":"import {\n  Annotation,\n  NormalizedPoint,\n  PinAnnotation,\n  RectangleAnnotation,\n  ArrowAnnotation,\n  SketchAnnotation,\n} from '../../types';\nimport { distanceToSegment, distanceToPolyline, getBoundingBox } from '../../utils/geometry';\n\n// --- Coordinate conversion helpers ---\n// \"logical\" = the base display size (img.offsetWidth/Height), independent of zoom/DPR\n\nconst normalizedToCanvas = (p: NormalizedPoint, w: number, h: number): { x: number; y: number } => ({\n  x: p.x * w,\n  y: p.y * h,\n});\n\nexport const canvasToNormalized = (cx: number, cy: number, w: number, h: number): NormalizedPoint => ({\n  x: Math.max(0, Math.min(1, cx / w)),\n  y: Math.max(0, Math.min(1, cy / h)),\n});\n\n// --- Hit testing (operates in logical/display coordinates) ---\n\nconst PIN_RADIUS_BASE = 10; // px at zoom 1\nconst HIT_TOLERANCE = 8; // px\nconst ARROW_HIT_TOLERANCE = 10; // px\nconst SKETCH_HIT_TOLERANCE = 20; // px — wider to match thick brush stroke\n\nexport const hitTestAnnotation = (\n  annotations: Annotation[],\n  canvasX: number,\n  canvasY: number,\n  canvasW: number,\n  canvasH: number,\n  zoomScale: number = 1\n): string | null => {\n  // Mark sizes shrink with zoom, so hit radii must also shrink\n  const s = Math.max(0.25, 1 / zoomScale);\n  const pinRadius = PIN_RADIUS_BASE * s;\n  const hitTol = HIT_TOLERANCE * s;\n  const arrowHitTol = ARROW_HIT_TOLERANCE * s;\n  const sketchHitTol = SKETCH_HIT_TOLERANCE * s;\n\n  // Test in reverse order (topmost first)\n  for (let i = annotations.length - 1; i >= 0; i--) {\n    const a = annotations[i];\n    if (a.type === 'pin') {\n      const { x, y } = normalizedToCanvas(a.position, canvasW, canvasH);\n      const dist = Math.sqrt((canvasX - x) ** 2 + (canvasY - y) ** 2);\n      if (dist <= pinRadius + hitTol) return a.id;\n    } else if (a.type === 'rectangle') {\n      const tl = normalizedToCanvas(a.topLeft, canvasW, canvasH);\n      const br = normalizedToCanvas(a.bottomRight, canvasW, canvasH);\n      const margin = hitTol;\n      if (\n        canvasX >= tl.x - margin && canvasX <= br.x + margin &&\n        canvasY >= tl.y - margin && canvasY <= br.y + margin\n      ) {\n        return a.id;\n      }\n    } else if (a.type === 'arrow') {\n      const normPt = canvasToNormalized(canvasX, canvasY, canvasW, canvasH);\n      const dist = distanceToSegment(normPt, a.start, a.end);\n      const avgDim = (canvasW + canvasH) / 2;\n      if (dist * avgDim <= arrowHitTol) return a.id;\n    } else if (a.type === 'sketch') {\n      if (a.points.length > 0) {\n        const normPt = canvasToNormalized(canvasX, canvasY, canvasW, canvasH);\n        const dist = distanceToPolyline(normPt, a.points);\n        const avgDim = (canvasW + canvasH) / 2;\n        if (dist * avgDim <= sketchHitTol) return a.id;\n      }\n    }\n  }\n  return null;\n};\n\n// --- Handle hit testing for resize ---\n\nexport type HandleType = 'tl' | 'tr' | 'bl' | 'br' | 'start' | 'end' | null;\nconst HANDLE_SIZE_BASE = 8;\n\nexport const hitTestHandle = (\n  annotation: Annotation,\n  canvasX: number,\n  canvasY: number,\n  canvasW: number,\n  canvasH: number,\n  zoomScale: number = 1\n): HandleType => {\n  const s = Math.max(0.25, 1 / zoomScale);\n  const handleSize = HANDLE_SIZE_BASE * s;\n\n  if (annotation.type === 'rectangle') {\n    const tl = normalizedToCanvas(annotation.topLeft, canvasW, canvasH);\n    const br = normalizedToCanvas(annotation.bottomRight, canvasW, canvasH);\n    const corners: { type: HandleType; x: number; y: number }[] = [\n      { type: 'tl', x: tl.x, y: tl.y },\n      { type: 'tr', x: br.x, y: tl.y },\n      { type: 'bl', x: tl.x, y: br.y },\n      { type: 'br', x: br.x, y: br.y },\n    ];\n    for (const c of corners) {\n      if (Math.abs(canvasX - c.x) <= handleSize && Math.abs(canvasY - c.y) <= handleSize) {\n        return c.type;\n      }\n    }\n  } else if (annotation.type === 'arrow') {\n    const s2 = normalizedToCanvas(annotation.start, canvasW, canvasH);\n    const e = normalizedToCanvas(annotation.end, canvasW, canvasH);\n    if (Math.abs(canvasX - s2.x) <= handleSize && Math.abs(canvasY - s2.y) <= handleSize) return 'start';\n    if (Math.abs(canvasX - e.x) <= handleSize && Math.abs(canvasY - e.y) <= handleSize) return 'end';\n  }\n  return null;\n};\n\n// --- Rubber band types ---\n\ninterface RectangleRubberBand {\n  type: 'rectangle';\n  topLeft: NormalizedPoint;\n  bottomRight: NormalizedPoint;\n  color: string;\n}\n\ninterface ArrowRubberBand {\n  type: 'arrow';\n  start: NormalizedPoint;\n  end: NormalizedPoint;\n  color: string;\n}\n\ninterface SketchRubberBand {\n  type: 'sketch';\n  points: NormalizedPoint[];\n  color: string;\n  strokeWidth: number;\n}\n\nexport type RubberBand = RectangleRubberBand | ArrowRubberBand | SketchRubberBand;\n\n// --- Main render function ---\n// canvasW/canvasH = the actual canvas buffer dimensions (may be upscaled for hi-DPI / zoom)\n// logicalW/logicalH = the CSS display size of the canvas (img.offsetWidth/Height)\n// zoomScale = current zoom level — annotation marks scale inversely to stay the same screen size\n\nexport const renderAnnotations = (\n  ctx: CanvasRenderingContext2D,\n  annotations: Annotation[],\n  selectedId: string | null,\n  canvasW: number,\n  canvasH: number,\n  rubberBand?: RubberBand | null,\n  zoomScale: number = 1\n) => {\n  ctx.clearRect(0, 0, canvasW, canvasH);\n  if (canvasW === 0 || canvasH === 0) return;\n\n  // s = inverse-zoom scaling factor for mark sizes (clamped so marks don't get infinitely large at low zoom)\n  const s = Math.max(0.25, 1 / zoomScale);\n\n  // Draw rubber-band (in-progress drawing)\n  if (rubberBand) {\n    if (rubberBand.type === 'rectangle') {\n      const tl = normalizedToCanvas(rubberBand.topLeft, canvasW, canvasH);\n      const br = normalizedToCanvas(rubberBand.bottomRight, canvasW, canvasH);\n      ctx.save();\n      ctx.strokeStyle = rubberBand.color;\n      ctx.lineWidth = 2 * s;\n      ctx.setLineDash([8 * s, 4 * s]);\n      ctx.strokeRect(tl.x, tl.y, br.x - tl.x, br.y - tl.y);\n      ctx.fillStyle = rubberBand.color + '10';\n      ctx.fillRect(tl.x, tl.y, br.x - tl.x, br.y - tl.y);\n      ctx.restore();\n    } else if (rubberBand.type === 'arrow') {\n      const sp = normalizedToCanvas(rubberBand.start, canvasW, canvasH);\n      const ep = normalizedToCanvas(rubberBand.end, canvasW, canvasH);\n      ctx.save();\n      ctx.strokeStyle = rubberBand.color;\n      ctx.lineWidth = 2.5 * s;\n      ctx.setLineDash([6 * s, 4 * s]);\n      ctx.beginPath();\n      ctx.moveTo(sp.x, sp.y);\n      ctx.lineTo(ep.x, ep.y);\n      ctx.stroke();\n      drawArrowhead(ctx, sp.x, sp.y, ep.x, ep.y, rubberBand.color, 12 * s);\n      ctx.restore();\n    } else if (rubberBand.type === 'sketch') {\n      drawSketchPath(ctx, rubberBand.points, canvasW, canvasH, rubberBand.color, rubberBand.strokeWidth, false, s);\n    }\n  }\n\n  // Number pins sequentially\n  let pinIndex = 1;\n\n  for (const a of annotations) {\n    const isSelected = a.id === selectedId;\n\n    if (a.type === 'pin') {\n      drawPin(ctx, a, canvasW, canvasH, isSelected, pinIndex, s);\n      pinIndex++;\n    } else if (a.type === 'rectangle') {\n      drawRectangle(ctx, a, canvasW, canvasH, isSelected, s);\n    } else if (a.type === 'arrow') {\n      drawArrow(ctx, a, canvasW, canvasH, isSelected, s);\n    } else if (a.type === 'sketch') {\n      drawSketch(ctx, a, canvasW, canvasH, isSelected, s);\n    }\n  }\n};\n\n// --- Individual annotation renderers ---\n\nconst drawPin = (\n  ctx: CanvasRenderingContext2D,\n  pin: PinAnnotation,\n  w: number,\n  h: number,\n  isSelected: boolean,\n  index: number,\n  s: number = 1\n) => {\n  const { x, y } = normalizedToCanvas(pin.position, w, h);\n  const r = PIN_RADIUS_BASE * s;\n\n  ctx.save();\n\n  // Drop shadow\n  ctx.shadowColor = 'rgba(0,0,0,0.2)';\n  ctx.shadowBlur = 6 * s;\n  ctx.shadowOffsetY = 2 * s;\n\n  // Main circle\n  ctx.beginPath();\n  ctx.arc(x, y, r, 0, Math.PI * 2);\n  ctx.fillStyle = pin.color;\n  ctx.fill();\n\n  // Reset shadow for text\n  ctx.shadowColor = 'transparent';\n\n  // Selection ring\n  if (isSelected) {\n    ctx.beginPath();\n    ctx.arc(x, y, r + 4 * s, 0, Math.PI * 2);\n    ctx.strokeStyle = '#2a9fd4';\n    ctx.lineWidth = 2.5 * s;\n    ctx.stroke();\n  }\n\n  // Number label\n  ctx.fillStyle = '#ffffff';\n  ctx.font = `bold ${Math.max(10 * s, r)}px Inter, sans-serif`;\n  ctx.textAlign = 'center';\n  ctx.textBaseline = 'middle';\n  ctx.fillText(String(index), x, y);\n\n  // Instruction indicator (small dot if has instruction)\n  if (pin.instruction) {\n    ctx.beginPath();\n    ctx.arc(x + r - 2 * s, y - r + 2 * s, 3 * s, 0, Math.PI * 2);\n    ctx.fillStyle = '#2a9fd4';\n    ctx.fill();\n  }\n\n  ctx.restore();\n};\n\nconst drawRectangle = (\n  ctx: CanvasRenderingContext2D,\n  rect: RectangleAnnotation,\n  w: number,\n  h: number,\n  isSelected: boolean,\n  s: number = 1\n) => {\n  const tl = normalizedToCanvas(rect.topLeft, w, h);\n  const br = normalizedToCanvas(rect.bottomRight, w, h);\n  const rw = br.x - tl.x;\n  const rh = br.y - tl.y;\n\n  ctx.save();\n\n  // Dashed border\n  ctx.strokeStyle = rect.color;\n  ctx.lineWidth = 2 * s;\n  ctx.setLineDash([8 * s, 4 * s]);\n  ctx.strokeRect(tl.x, tl.y, rw, rh);\n\n  // Semi-transparent fill\n  ctx.fillStyle = rect.color + '0D';\n  ctx.fillRect(tl.x, tl.y, rw, rh);\n\n  // Instruction indicator\n  if (rect.instruction) {\n    ctx.setLineDash([]);\n    const labelX = tl.x + 4 * s;\n    const labelY = tl.y - 6 * s;\n    const labelW = 16 * s;\n    const labelH = 16 * s;\n    ctx.fillStyle = rect.color;\n    ctx.beginPath();\n    ctx.roundRect(labelX, labelY - 12 * s, labelW, labelH, 3 * s);\n    ctx.fill();\n    ctx.fillStyle = '#fff';\n    ctx.font = `bold ${9 * s}px Inter, sans-serif`;\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    ctx.fillText('T', labelX + labelW / 2, labelY - 4 * s);\n  }\n\n  // Selection handles\n  if (isSelected) {\n    ctx.setLineDash([]);\n    const handles = [\n      { x: tl.x, y: tl.y },\n      { x: br.x, y: tl.y },\n      { x: tl.x, y: br.y },\n      { x: br.x, y: br.y },\n    ];\n    for (const handle of handles) {\n      ctx.fillStyle = '#ffffff';\n      ctx.strokeStyle = rect.color;\n      ctx.lineWidth = 2 * s;\n      ctx.beginPath();\n      ctx.arc(handle.x, handle.y, 5 * s, 0, Math.PI * 2);\n      ctx.fill();\n      ctx.stroke();\n    }\n\n    // Selection highlight border\n    ctx.strokeStyle = '#2a9fd4';\n    ctx.lineWidth = 1.5 * s;\n    ctx.setLineDash([4 * s, 2 * s]);\n    ctx.strokeRect(tl.x - 3 * s, tl.y - 3 * s, rw + 6 * s, rh + 6 * s);\n  }\n\n  ctx.restore();\n};\n\nconst drawArrow = (\n  ctx: CanvasRenderingContext2D,\n  arrow: ArrowAnnotation,\n  w: number,\n  h: number,\n  isSelected: boolean,\n  s: number = 1\n) => {\n  const sp = normalizedToCanvas(arrow.start, w, h);\n  const ep = normalizedToCanvas(arrow.end, w, h);\n\n  ctx.save();\n\n  // Shadow\n  ctx.shadowColor = 'rgba(0,0,0,0.15)';\n  ctx.shadowBlur = 4 * s;\n  ctx.shadowOffsetY = 1 * s;\n\n  // Line\n  ctx.strokeStyle = arrow.color;\n  ctx.lineWidth = 2.5 * s;\n  ctx.lineCap = 'round';\n  ctx.beginPath();\n  ctx.moveTo(sp.x, sp.y);\n  ctx.lineTo(ep.x, ep.y);\n  ctx.stroke();\n\n  ctx.shadowColor = 'transparent';\n\n  // Arrowhead\n  drawArrowhead(ctx, sp.x, sp.y, ep.x, ep.y, arrow.color, 14 * s);\n\n  // Instruction indicator at midpoint\n  if (arrow.instruction) {\n    const mx = (sp.x + ep.x) / 2;\n    const my = (sp.y + ep.y) / 2;\n    ctx.fillStyle = arrow.color;\n    ctx.beginPath();\n    ctx.arc(mx, my - 12 * s, 6 * s, 0, Math.PI * 2);\n    ctx.fill();\n    ctx.fillStyle = '#fff';\n    ctx.font = `bold ${8 * s}px Inter, sans-serif`;\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    ctx.fillText('i', mx, my - 12 * s);\n  }\n\n  // Selection: endpoint handles\n  if (isSelected) {\n    for (const pt of [sp, ep]) {\n      ctx.fillStyle = '#ffffff';\n      ctx.strokeStyle = arrow.color;\n      ctx.lineWidth = 2 * s;\n      ctx.beginPath();\n      ctx.arc(pt.x, pt.y, 5 * s, 0, Math.PI * 2);\n      ctx.fill();\n      ctx.stroke();\n    }\n\n    // Selection glow\n    ctx.strokeStyle = '#2a9fd4';\n    ctx.lineWidth = 1.5 * s;\n    ctx.setLineDash([4 * s, 2 * s]);\n    ctx.beginPath();\n    ctx.moveTo(sp.x, sp.y);\n    ctx.lineTo(ep.x, ep.y);\n    ctx.stroke();\n  }\n\n  ctx.restore();\n};\n\n/**\n * Draw a filled arrowhead triangle at the end of a line.\n */\nconst drawArrowhead = (\n  ctx: CanvasRenderingContext2D,\n  fromX: number,\n  fromY: number,\n  toX: number,\n  toY: number,\n  color: string,\n  size: number\n) => {\n  const angle = Math.atan2(toY - fromY, toX - fromX);\n  const halfAngle = Math.PI / 7; // ~25.7 degrees\n\n  ctx.save();\n  ctx.fillStyle = color;\n  ctx.setLineDash([]);\n  ctx.beginPath();\n  ctx.moveTo(toX, toY);\n  ctx.lineTo(\n    toX - size * Math.cos(angle - halfAngle),\n    toY - size * Math.sin(angle - halfAngle)\n  );\n  ctx.lineTo(\n    toX - size * Math.cos(angle + halfAngle),\n    toY - size * Math.sin(angle + halfAngle)\n  );\n  ctx.closePath();\n  ctx.fill();\n  ctx.restore();\n};\n\nconst drawSketch = (\n  ctx: CanvasRenderingContext2D,\n  sketch: SketchAnnotation,\n  w: number,\n  h: number,\n  isSelected: boolean,\n  s: number = 1\n) => {\n  if (sketch.points.length < 2) return;\n\n  drawSketchPath(ctx, sketch.points, w, h, sketch.color, sketch.strokeWidth, false, s);\n\n  // Instruction indicator near the center of the stroke\n  if (sketch.instruction) {\n    const bbox = getBoundingBox(sketch.points);\n    const cx = ((bbox.topLeft.x + bbox.bottomRight.x) / 2) * w;\n    const cy = bbox.topLeft.y * h - 10 * s;\n    const labelW = 16 * s;\n    const labelH = 16 * s;\n\n    ctx.save();\n    ctx.fillStyle = sketch.color;\n    ctx.beginPath();\n    ctx.roundRect(cx - labelW / 2, cy - 12 * s, labelW, labelH, 3 * s);\n    ctx.fill();\n    ctx.fillStyle = '#fff';\n    ctx.font = `bold ${9 * s}px Inter, sans-serif`;\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    ctx.fillText('T', cx, cy - 4 * s);\n    ctx.restore();\n  }\n\n  // Selection: bounding box\n  if (isSelected) {\n    const bbox = getBoundingBox(sketch.points);\n    const tl = normalizedToCanvas(bbox.topLeft, w, h);\n    const br = normalizedToCanvas(bbox.bottomRight, w, h);\n\n    ctx.save();\n    ctx.strokeStyle = '#2a9fd4';\n    ctx.lineWidth = 1.5 * s;\n    ctx.setLineDash([4 * s, 2 * s]);\n    ctx.strokeRect(tl.x - 5 * s, tl.y - 5 * s, br.x - tl.x + 10 * s, br.y - tl.y + 10 * s);\n    ctx.restore();\n  }\n};\n\n/**\n * Draw a thick semi-transparent highlighter brush path from normalized points.\n * Used for both final sketches and rubber-band preview.\n */\nconst drawSketchPath = (\n  ctx: CanvasRenderingContext2D,\n  points: NormalizedPoint[],\n  w: number,\n  h: number,\n  color: string,\n  strokeWidth: number,\n  _isSelected: boolean,\n  s: number = 1\n) => {\n  if (points.length < 2) return;\n\n  ctx.save();\n\n  ctx.beginPath();\n  const first = normalizedToCanvas(points[0], w, h);\n  ctx.moveTo(first.x, first.y);\n  for (let i = 1; i < points.length; i++) {\n    const p = normalizedToCanvas(points[i], w, h);\n    ctx.lineTo(p.x, p.y);\n  }\n  ctx.closePath();\n\n  // Dashed border (matching rectangle style)\n  ctx.strokeStyle = color;\n  ctx.lineWidth = 2 * s;\n  ctx.setLineDash([8 * s, 4 * s]);\n  ctx.stroke();\n\n  // Semi-transparent fill (matching rectangle style)\n  ctx.fillStyle = color + '0D';\n  ctx.fill();\n\n  ctx.restore();\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\workbench\\PinEditor.tsx","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":18,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":18,"endColumn":54},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'handleSave' was used before it was defined.","line":25,"column":9,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":25,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSave'. Either include it or remove the dependency array.","line":36,"column":6,"nodeType":"ArrayExpression","endLine":36,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [handleSave, text]","fix":{"range":[1174,1180],"text":"[handleSave, text]"}}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":62,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":62,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 20.","line":62,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":62,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 400.","line":62,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":62,"endColumn":73},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":63,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":63,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 40.","line":63,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":63,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 180.","line":63,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":63,"endColumn":73}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\n\ninterface PinEditorProps {\n  instruction: string;\n  position: { x: number; y: number }; // screen coordinates of the pin\n  onSave: (instruction: string) => void;\n  onDelete: () => void;\n  onClose: () => void;\n}\n\nconst PinEditor: React.FC<PinEditorProps> = ({ instruction, position, onSave, onDelete, onClose }) => {\n  const [text, setText] = useState(instruction);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const popoverRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    // Focus textarea on mount\n    setTimeout(() => textareaRef.current?.focus(), 50);\n  }, []);\n\n  // Close on click outside\n  useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      if (popoverRef.current && !popoverRef.current.contains(e.target as Node)) {\n        handleSave();\n      }\n    };\n    // Delay to avoid the creating click from triggering close\n    const timer = setTimeout(() => {\n      window.addEventListener('mousedown', handleClickOutside);\n    }, 100);\n    return () => {\n      clearTimeout(timer);\n      window.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [text]);\n\n  const handleSave = () => {\n    if (text.trim() === '') {\n      onDelete();\n    } else {\n      onSave(text);\n      onClose();\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSave();\n    }\n    if (e.key === 'Escape') {\n      onClose();\n    }\n    // Stop propagation so overlay doesn't close\n    e.stopPropagation();\n  };\n\n  // Position the popover near the pin, offset to the right\n  const popoverStyle: React.CSSProperties = {\n    position: 'fixed',\n    left: Math.max(16, Math.min(position.x + 20, window.innerWidth - 400)),\n    top: Math.max(16, Math.min(position.y - 40, window.innerHeight - 180)),\n    zIndex: 120,\n  };\n\n  return (\n    <div ref={popoverRef} style={popoverStyle} className=\"animate-in fade-in zoom-in-95 duration-200\" onClick={e => e.stopPropagation()}>\n      <div className=\"w-[360px] bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-700 shadow-lg dark:shadow-black/30 overflow-hidden\">\n        <div className=\"px-4 py-2.5 flex items-center justify-between\">\n          <span className=\"text-[11px] font-medium uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Pin Instruction</span>\n          <div className=\"flex items-center gap-1\">\n            <button\n              onClick={onDelete}\n              className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 dark:text-zinc-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-950 transition-colors\"\n              title=\"Delete Pin\"\n            >\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n            </button>\n            <button\n              onClick={handleSave}\n              className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 dark:text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n              title=\"Save & close\"\n            >\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points=\"20 6 9 17 4 12\"/>\n              </svg>\n            </button>\n          </div>\n        </div>\n        <div className=\"px-4 pb-3\">\n          <textarea\n            ref={textareaRef}\n            value={text}\n            onChange={e => setText(e.target.value)}\n            onKeyDown={handleKeyDown}\n            placeholder=\"e.g., Change this data point to 22%\"\n            rows={6}\n            className=\"w-full bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg px-3 py-2.5 text-[13px] leading-relaxed text-zinc-700 dark:text-zinc-300 resize-none focus:outline-none focus:border-zinc-400 dark:focus:border-zinc-500 transition-colors placeholder:text-zinc-400 dark:placeholder:text-zinc-500\"\n          />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default PinEditor;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\components\\workbench\\RectangleEditor.tsx","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 50.","line":17,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":17,"endColumn":54},{"ruleId":"@typescript-eslint/no-use-before-define","severity":2,"message":"'handleSave' was used before it was defined.","line":24,"column":9,"nodeType":"Identifier","messageId":"noUseBeforeDefine","endLine":24,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSave'. Either include it or remove the dependency array.","line":34,"column":6,"nodeType":"ArrayExpression","endLine":34,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [handleSave, text]","fix":{"range":[1114,1120],"text":"[handleSave, text]"}}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":59,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":59,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 180.","line":59,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":59,"endColumn":49},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 380.","line":59,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":59,"endColumn":74},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":60,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":60,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 150.","line":60,"column":45,"nodeType":"Literal","messageId":"noMagic","endLine":60,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 180.","line":60,"column":71,"nodeType":"Literal","messageId":"noMagic","endLine":60,"endColumn":74}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\n\ninterface RectangleEditorProps {\n  instruction: string;\n  position: { x: number; y: number }; // screen coordinates near top edge of rectangle\n  onSave: (instruction: string) => void;\n  onDelete: () => void;\n  onClose: () => void;\n}\n\nconst RectangleEditor: React.FC<RectangleEditorProps> = ({ instruction, position, onSave, onDelete, onClose }) => {\n  const [text, setText] = useState(instruction);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const popoverRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    setTimeout(() => textareaRef.current?.focus(), 50);\n  }, []);\n\n  // Close on click outside\n  useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      if (popoverRef.current && !popoverRef.current.contains(e.target as Node)) {\n        handleSave();\n      }\n    };\n    const timer = setTimeout(() => {\n      window.addEventListener('mousedown', handleClickOutside);\n    }, 100);\n    return () => {\n      clearTimeout(timer);\n      window.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, [text]);\n\n  const handleSave = () => {\n    if (text.trim() === '') {\n      onDelete();\n    } else {\n      onSave(text);\n      onClose();\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSave();\n    }\n    if (e.key === 'Escape') {\n      onClose();\n    }\n    e.stopPropagation();\n  };\n\n  // Position the popover above the annotation\n  const popoverStyle: React.CSSProperties = {\n    position: 'fixed',\n    left: Math.max(16, Math.min(position.x - 180, window.innerWidth - 380)),\n    top: Math.max(16, Math.min(position.y - 150, window.innerHeight - 180)),\n    zIndex: 120,\n  };\n\n  return (\n    <div ref={popoverRef} style={popoverStyle} className=\"animate-in fade-in zoom-in-95 duration-200\" onClick={e => e.stopPropagation()}>\n      <div className=\"w-[360px] bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-700 shadow-lg dark:shadow-black/30 overflow-hidden\">\n        <div className=\"px-4 py-2.5 flex items-center justify-between\">\n          <span className=\"text-[11px] font-medium uppercase tracking-[0.15em] text-zinc-500 dark:text-zinc-400\">Area Instruction</span>\n          <div className=\"flex items-center gap-1\">\n            <button\n              onClick={onDelete}\n              className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 dark:text-zinc-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-950 transition-colors\"\n              title=\"Delete Annotation\"\n            >\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M3 6h18\"/><path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/><path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\n              </svg>\n            </button>\n            <button\n              onClick={handleSave}\n              className=\"w-6 h-6 rounded-full flex items-center justify-center text-zinc-400 dark:text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors\"\n              title=\"Save & close\"\n            >\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <polyline points=\"20 6 9 17 4 12\"/>\n              </svg>\n            </button>\n          </div>\n        </div>\n        <div className=\"px-4 pb-3\">\n          <textarea\n            ref={textareaRef}\n            value={text}\n            onChange={e => setText(e.target.value)}\n            onKeyDown={handleKeyDown}\n            placeholder=\"e.g., Redesign this chart area with updated data\"\n            rows={6}\n            className=\"w-full bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg px-3 py-2.5 text-[13px] leading-relaxed text-zinc-700 dark:text-zinc-300 resize-none focus:outline-none focus:border-zinc-400 dark:focus:border-zinc-500 transition-colors placeholder:text-zinc-400 dark:placeholder:text-zinc-500\"\n          />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default RectangleEditor;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\context\\AppContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'WorkflowMode' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"WorkflowMode"},"fix":{"range":[137,151],"text":""},"desc":"Remove unused variable \"WorkflowMode\"."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":92,"column":13,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":92,"endColumn":80,"fix":{"range":[3617,3684],"text":"{throw new Error('useAppContext must be used inside <AppProvider>');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":125,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":125,"endColumn":61,"fix":{"range":[5244,5262],"text":"{return 'document';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":126,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":126,"endColumn":57,"fix":{"range":[5303,5319],"text":"{return 'nugget';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":127,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":127,"endColumn":59,"fix":{"range":[5361,5378],"text":"{return 'project';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":137,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":137,"endColumn":51,"fix":{"range":[5720,5745],"text":"{return stored === 'true';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":171,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":171,"endColumn":32,"fix":{"range":[6897,6904],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":191,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":191,"endColumn":28,"fix":{"range":[7720,7727],"text":"{return;}"}},{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":206,"column":7,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":206,"endColumn":14,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[8342,8356],"text":""},"desc":"Remove this redundant jump"}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":238,"column":88,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":238,"endColumn":95,"fix":{"range":[9561,9568],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":256,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":256,"endColumn":36,"fix":{"range":[10354,10361],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":283,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":283,"endColumn":41,"fix":{"range":[11332,11344],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":313,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":313,"endColumn":35,"fix":{"range":[12428,12435],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":328,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":328,"endColumn":35,"fix":{"range":[12935,12942],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":342,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":342,"endColumn":35,"fix":{"range":[13395,13402],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":352,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":352,"endColumn":35,"fix":{"range":[13736,13743],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":373,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":373,"endColumn":35,"fix":{"range":[14501,14508],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":382,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":382,"endColumn":30,"fix":{"range":[14918,14930],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":388,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":388,"endColumn":35,"fix":{"range":[15173,15180],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":391,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":391,"endColumn":47,"fix":{"range":[15365,15374],"text":"{return n;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":404,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":404,"endColumn":30,"fix":{"range":[15943,15955],"text":"{return prev;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'nuggets'. Either exclude it or remove the dependency array.","line":412,"column":6,"nodeType":"ArrayExpression","endLine":412,"endColumn":48,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNuggetId, toInsightsDoc]","fix":{"range":[16321,16363],"text":"[selectedNuggetId, toInsightsDoc]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":415,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":415,"endColumn":35,"fix":{"range":[16458,16465],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":417,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":417,"endColumn":47,"fix":{"range":[16542,16551],"text":"{return n;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":424,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":424,"endColumn":30,"fix":{"range":[16970,16982],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":430,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":430,"endColumn":35,"fix":{"range":[17207,17214],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":432,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":432,"endColumn":47,"fix":{"range":[17291,17300],"text":"{return n;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":439,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":439,"endColumn":30,"fix":{"range":[17809,17821],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":445,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":445,"endColumn":35,"fix":{"range":[18056,18063],"text":"{return;}"}},{"ruleId":"sonarjs/no-inverted-boolean-check","severity":1,"message":"Use the opposite operator (===) instead.","line":454,"column":85,"nodeType":"UnaryExpression","messageId":"useOppositeOperator","endLine":454,"endColumn":107,"suggestions":[{"messageId":"suggestOperationInversion","fix":{"range":[18578,18600],"text":"d.enabled === false"},"desc":"Invert inner operation (apply if NaN is not expected)"}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":459,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":459,"endColumn":30,"fix":{"range":[18915,18927],"text":"{return prev;}"}},{"ruleId":"no-else-return","severity":1,"message":"Unnecessary 'else' after 'return'.","line":463,"column":14,"nodeType":"BlockStatement","messageId":"unexpected","endLine":467,"endColumn":8,"fix":{"range":[18888,19303],"text":"prev => {\n      if (!prev) return prev;\n      if (wasEnabled) {\n        // Was enabled, now being disabled — remove from session\n        return { ...prev, documents: prev.documents.filter(d => d.id !== docId) };\n      } \n        // Was disabled, now being enabled — add back to session\n        if (doc) return { ...prev, documents: [...prev.documents, toInsightsDoc(doc)] };\n        return prev;\n      \n    }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":465,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":465,"endColumn":89,"fix":{"range":[19197,19268],"text":"{return { ...prev, documents: [...prev.documents, toInsightsDoc(doc)] };}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'initialState?.tokenUsageTotals'. Either include it or remove the dependency array.","line":554,"column":7,"nodeType":"ArrayExpression","endLine":569,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [isProjectsPanelOpen, activeCardId, insightsSession, nuggets, selectedNuggetId, selectedDocumentId, selectedDocument, selectedProjectId, selectionLevel, selectEntity, selectedNugget, activeCard, addNugget, deleteNugget, updateNugget, updateNuggetCard, updateNuggetCards, updateNuggetContentAndCards, appendNuggetMessage, addNuggetDocument, updateNuggetDocument, removeNuggetDocument, renameNuggetDocument, toggleNuggetDocument, projects, addProject, deleteProject, updateProject, addNuggetToProject, removeNuggetFromProject, initialState?.tokenUsageTotals, customStyles, addCustomStyle, updateCustomStyle, deleteCustomStyle, replaceCustomStyles, darkMode, toggleDarkMode]","fix":{"range":[22377,23077],"text":"[isProjectsPanelOpen, activeCardId, insightsSession, nuggets, selectedNuggetId, selectedDocumentId, selectedDocument, selectedProjectId, selectionLevel, selectEntity, selectedNugget, activeCard, addNugget, deleteNugget, updateNugget, updateNuggetCard, updateNuggetCards, updateNuggetContentAndCards, appendNuggetMessage, addNuggetDocument, updateNuggetDocument, removeNuggetDocument, renameNuggetDocument, toggleNuggetDocument, projects, addProject, deleteProject, updateProject, addNuggetToProject, removeNuggetFromProject, initialState?.tokenUsageTotals, customStyles, addCustomStyle, updateCustomStyle, deleteCustomStyle, replaceCustomStyles, darkMode, toggleDarkMode]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedProjectId'. Either include it or remove the dependency array.","line":224,"column":6,"nodeType":"ArrayExpression","endLine":224,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNuggetId, projects, selectedProjectId]","fix":{"range":[9014,9042],"text":"[selectedNuggetId, projects, selectedProjectId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedDocumentId'. Either include it or remove the dependency array.","line":242,"column":6,"nodeType":"ArrayExpression","endLine":242,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNuggetId, nuggets, selectedDocumentId]","fix":{"range":[9730,9757],"text":"[selectedNuggetId, nuggets, selectedDocumentId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'nuggets'. Either include it or remove the dependency array.","line":278,"column":6,"nodeType":"ArrayExpression","endLine":278,"endColumn":73,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNuggetId, selectedNuggetCardCount, selectedNuggetDocCount, nuggets]","fix":{"range":[11007,11074],"text":"[selectedNuggetId, selectedNuggetCardCount, selectedNuggetDocCount, nuggets]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":33,"fixableErrorCount":0,"fixableWarningCount":29,"source":"\nimport React, { createContext, useContext, useState, useRef, useMemo, useCallback, useEffect } from 'react';\nimport { UploadedFile, Card, WorkflowMode, InsightsSession, InsightsDocument, Nugget, Project, InitialPersistedState, ChatMessage, DocChangeEvent, CustomStyle } from '../types';\n\n// ── Context shape ──\ninterface AppContextValue {\n  // Core state\n  isProjectsPanelOpen: boolean;\n  setIsProjectsPanelOpen: React.Dispatch<React.SetStateAction<boolean>>;\n  activeCardId: string | null;\n  setActiveCardId: React.Dispatch<React.SetStateAction<string | null>>;\n\n  // Workflow state\n  insightsSession: InsightsSession | null;\n  setInsightsSession: React.Dispatch<React.SetStateAction<InsightsSession | null>>;\n\n  // Derived values\n  activeCard: Card | null;\n\n  // Nugget state\n  nuggets: Nugget[];\n  setNuggets: React.Dispatch<React.SetStateAction<Nugget[]>>;\n  selectedNuggetId: string | null;\n  setSelectedNuggetId: React.Dispatch<React.SetStateAction<string | null>>;\n\n  // Document selection\n  selectedDocumentId: string | null;\n  setSelectedDocumentId: React.Dispatch<React.SetStateAction<string | null>>;\n  selectedDocument: UploadedFile | undefined;\n\n  // Project selection (explicit state for empty-project support)\n  selectedProjectId: string | null;\n\n  // Selection level — tracks what the user explicitly clicked (primary highlight)\n  selectionLevel: 'project' | 'nugget' | 'document' | null;\n  setSelectionLevel: React.Dispatch<React.SetStateAction<'project' | 'nugget' | 'document' | null>>;\n\n  // Unified selection helper (enforces project→nugget→document triple)\n  selectEntity: (opts: { projectId?: string; nuggetId?: string; documentId?: string }) => void;\n\n  // Derived nugget values\n  selectedNugget: Nugget | undefined;\n\n  // Helpers\n  addNugget: (nugget: Nugget) => void;\n  deleteNugget: (nuggetId: string) => void;\n  updateNugget: (nuggetId: string, updater: (n: Nugget) => Nugget) => void;\n\n  updateNuggetCard: (cardId: string, updater: (c: Card) => Card) => void;\n  updateNuggetCards: (updater: (c: Card) => Card) => void;\n  updateNuggetContentAndCards: (content: string, cards: Card[]) => void;\n  appendNuggetMessage: (message: ChatMessage) => void;\n\n  // Nugget document mutation helpers\n  addNuggetDocument: (doc: UploadedFile) => void;\n  updateNuggetDocument: (docId: string, updated: UploadedFile) => void;\n  removeNuggetDocument: (docId: string) => void;\n  renameNuggetDocument: (docId: string, newName: string) => void;\n  toggleNuggetDocument: (docId: string) => void;\n\n  // Project state\n  projects: Project[];\n  setProjects: React.Dispatch<React.SetStateAction<Project[]>>;\n\n  // Project helpers\n  addProject: (project: Project) => void;\n  deleteProject: (projectId: string) => void;\n  updateProject: (projectId: string, updater: (p: Project) => Project) => void;\n  addNuggetToProject: (projectId: string, nuggetId: string) => void;\n  removeNuggetFromProject: (projectId: string, nuggetId: string) => void;\n\n  // Token usage (initial persisted totals for hydration)\n  initialTokenUsageTotals?: Record<string, number>;\n\n  // Custom styles (global, user-created)\n  customStyles: CustomStyle[];\n  addCustomStyle: (style: CustomStyle) => void;\n  updateCustomStyle: (id: string, updates: Partial<CustomStyle>) => void;\n  deleteCustomStyle: (id: string) => void;\n  replaceCustomStyles: (styles: CustomStyle[]) => void;\n\n  // Dark mode\n  darkMode: boolean;\n  toggleDarkMode: () => void;\n}\n\nconst AppContext = createContext<AppContextValue | null>(null);\n\n// ── Hook to consume context ──\nexport function useAppContext(): AppContextValue {\n  const ctx = useContext(AppContext);\n  if (!ctx) throw new Error('useAppContext must be used inside <AppProvider>');\n  return ctx;\n}\n\n// ── Provider ──\nexport const AppProvider: React.FC<{\n  children: React.ReactNode;\n  initialState?: InitialPersistedState;\n}> = ({ children, initialState }) => {\n  // Core state\n  const [isProjectsPanelOpen, setIsProjectsPanelOpen] = useState(true);\n  const [activeCardId, setActiveCardId] = useState<string | null>(initialState?.activeCardId ?? null);\n\n  // Insights session (backward compat shim for nugget data)\n  const [insightsSession, setInsightsSession] = useState<InsightsSession | null>(initialState?.insightsSession ?? null);\n\n  // Nugget state (documents are now owned per-nugget, no global library)\n  const [nuggets, setNuggets] = useState<Nugget[]>(initialState?.nuggets ?? []);\n  const [selectedNuggetId, setSelectedNuggetId] = useState<string | null>(initialState?.selectedNuggetId ?? null);\n\n  // Document selection (context-level, synced with nugget)\n  const [selectedDocumentId, setSelectedDocumentId] = useState<string | null>(initialState?.selectedDocumentId ?? null);\n\n  // Project state\n  const [projects, setProjects] = useState<Project[]>(initialState?.projects ?? []);\n\n  // Project selection (explicit state so empty projects can be selected)\n  const [selectedProjectId, setSelectedProjectId] = useState<string | null>(\n    initialState?.selectedProjectId ?? null\n  );\n\n  // Selection level — tracks what the user explicitly clicked (for primary vs context highlight)\n  const [selectionLevel, setSelectionLevel] = useState<'project' | 'nugget' | 'document' | null>(() => {\n    if (initialState?.selectedDocumentId) return 'document';\n    if (initialState?.selectedNuggetId) return 'nugget';\n    if (initialState?.selectedProjectId) return 'project';\n    return null;\n  });\n\n  // Custom styles state (global, not per-nugget)\n  const [customStyles, setCustomStyles] = useState<CustomStyle[]>(initialState?.customStyles ?? []);\n\n  // Dark mode\n  const [darkMode, setDarkMode] = useState<boolean>(() => {\n    const stored = localStorage.getItem('infonugget-dark-mode');\n    if (stored !== null) return stored === 'true';\n    return window.matchMedia('(prefers-color-scheme: dark)').matches;\n  });\n\n  useEffect(() => {\n    document.documentElement.classList.toggle('dark', darkMode);\n    localStorage.setItem('infonugget-dark-mode', String(darkMode));\n  }, [darkMode]);\n\n  const toggleDarkMode = useCallback(() => setDarkMode(prev => !prev), []);\n\n  // Derived: selected nugget\n  const selectedNugget = useMemo(\n    () => nuggets.find(n => n.id === selectedNuggetId),\n    [nuggets, selectedNuggetId],\n  );\n\n  // Derived: selected document\n  const selectedDocument = useMemo(\n    () => selectedNugget?.documents.find(d => d.id === selectedDocumentId),\n    [selectedNugget, selectedDocumentId],\n  );\n\n  // ── Unified selection helper: enforces project → nugget → document triple ──\n  const selectEntity = useCallback((opts: {\n    projectId?: string;\n    nuggetId?: string;\n    documentId?: string;\n  }) => {\n    const { projectId, nuggetId, documentId } = opts;\n\n    if (documentId) {\n      // Find the nugget that owns this document, then derive parent project\n      const ownerNugget = nuggets.find(n => n.documents.some(d => d.id === documentId));\n      if (!ownerNugget) return;\n      const parentProject = projects.find(p => p.nuggetIds.includes(ownerNugget.id));\n      setSelectionLevel('document');\n      setSelectedProjectId(parentProject?.id ?? null);\n      setSelectedNuggetId(ownerNugget.id);\n      setSelectedDocumentId(documentId);\n      return;\n    }\n    if (nuggetId) {\n      const parentProject = projects.find(p => p.nuggetIds.includes(nuggetId));\n      setSelectionLevel('nugget');\n      setSelectedProjectId(parentProject?.id ?? null);\n      setSelectedNuggetId(nuggetId);\n      const nugget = nuggets.find(n => n.id === nuggetId);\n      const firstDoc = nugget?.documents.find(d => d.enabled !== false);\n      setSelectedDocumentId(firstDoc?.id ?? null);\n      return;\n    }\n    if (projectId) {\n      const project = projects.find(p => p.id === projectId);\n      if (!project) return;\n      setSelectionLevel('project');\n      setSelectedProjectId(projectId);\n      if (project.nuggetIds.length > 0) {\n        // Cascade to first nugget + first doc\n        const firstNuggetId = project.nuggetIds[0];\n        setSelectedNuggetId(firstNuggetId);\n        const firstNugget = nuggets.find(n => n.id === firstNuggetId);\n        const firstDoc = firstNugget?.documents.find(d => d.enabled !== false);\n        setSelectedDocumentId(firstDoc?.id ?? null);\n      } else {\n        // Empty project — clear nugget & doc selection\n        setSelectedNuggetId(null);\n        setSelectedDocumentId(null);\n      }\n      return;\n    }\n  }, [nuggets, projects]);\n\n  // ── Guard effect: keep selectedProjectId in sync ──\n  useEffect(() => {\n    // If a nugget is selected, ensure selectedProjectId matches its parent\n    if (selectedNuggetId) {\n      const parentProject = projects.find(p => p.nuggetIds.includes(selectedNuggetId));\n      if (parentProject && parentProject.id !== selectedProjectId) {\n        setSelectedProjectId(parentProject.id);\n      }\n      return;\n    }\n    // If no nugget but we have a selectedProjectId, verify the project still exists\n    if (selectedProjectId && !projects.some(p => p.id === selectedProjectId)) {\n      setSelectedProjectId(null);\n    }\n  }, [selectedNuggetId, projects]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // ── Guard effect: keep selectedDocumentId valid when nugget/docs change ──\n  useEffect(() => {\n    if (!selectedNuggetId) {\n      setSelectedDocumentId(null);\n      return;\n    }\n    const nugget = nuggets.find(n => n.id === selectedNuggetId);\n    if (!nugget) {\n      setSelectedDocumentId(null);\n      return;\n    }\n    // If current doc is still in this nugget, keep it\n    if (selectedDocumentId && nugget.documents.some(d => d.id === selectedDocumentId)) return;\n    // Auto-select first enabled doc\n    const firstDoc = nugget.documents.find(d => d.enabled !== false);\n    setSelectedDocumentId(firstDoc?.id ?? null);\n  }, [selectedNuggetId, nuggets]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // ── Compatibility shim: selectedNuggetId → populate insights session ──\n  const shimReady = useRef(false);\n  useEffect(() => {\n    const timer = setTimeout(() => { shimReady.current = true; }, 100);\n    return () => clearTimeout(timer);\n  }, []);\n\n  // Track nugget card count + document count so the shim re-runs when cards/docs are added/removed\n  const selectedNuggetCardCount = selectedNugget?.cards.length ?? 0;\n  const selectedNuggetDocCount = selectedNugget?.documents.length ?? 0;\n\n  useEffect(() => {\n    if (!shimReady.current) return;\n    const nugget = nuggets.find(n => n.id === selectedNuggetId);\n\n    if (!nugget) {\n      setInsightsSession(null);\n      return;\n    }\n\n    // Build synthetic session from nugget's owned documents\n    const syntheticSession: InsightsSession = {\n      id: nugget.id,\n      documents: nugget.documents.map(doc => ({\n        id: doc.id,\n        name: doc.name,\n        type: (doc.type === 'application/pdf' ? 'pdf' : 'md') as 'md' | 'pdf',\n        size: doc.size,\n        content: doc.content,\n      })),\n      messages: nugget.messages ?? [],\n      cards: nugget.cards.map(c => ({ ...c })),\n    };\n    setInsightsSession(syntheticSession);\n  }, [selectedNuggetId, selectedNuggetCardCount, selectedNuggetDocCount]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // Derived: currently active card — from nugget/insights cards\n  const activeCard = useMemo(() => {\n    const cards = selectedNugget?.cards ?? insightsSession?.cards ?? [];\n    if (cards.length === 0) return null;\n    return cards.find(c => c.id === activeCardId) || cards[0];\n  }, [selectedNugget, insightsSession, activeCardId]);\n\n  // Nugget helpers\n  const addNugget = useCallback((nugget: Nugget) => {\n    setNuggets(prev => [...prev, nugget]);\n  }, []);\n\n  const deleteNugget = useCallback((nuggetId: string) => {\n    setNuggets(prev => prev.filter(n => n.id !== nuggetId));\n    // Also remove from whichever project contains it\n    setProjects(prev => prev.map(p =>\n      p.nuggetIds.includes(nuggetId)\n        ? { ...p, nuggetIds: p.nuggetIds.filter(id => id !== nuggetId), lastModifiedAt: Date.now() }\n        : p\n    ));\n    if (selectedNuggetId === nuggetId) {\n      setSelectedNuggetId(null);\n      setSelectionLevel(null);\n    }\n  }, [selectedNuggetId]);\n\n  const updateNugget = useCallback((nuggetId: string, updater: (n: Nugget) => Nugget) => {\n    setNuggets(prev => prev.map(n => n.id === nuggetId ? updater(n) : n));\n  }, []);\n\n  // ── Unified nugget helpers ──\n\n  const updateNuggetCard = useCallback((cardId: string, updater: (c: Card) => Card) => {\n    if (!selectedNuggetId) return;\n    const mapFn = (c: Card) => c.id === cardId ? updater(c) : c;\n\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNuggetId\n        ? { ...n, cards: n.cards.map(mapFn), lastModifiedAt: Date.now() }\n        : n\n    ));\n\n    if (insightsSession) {\n      setInsightsSession(prev => prev ? { ...prev, cards: prev.cards.map(mapFn) } : prev);\n    }\n  }, [selectedNuggetId, insightsSession]);\n\n  const updateNuggetCards = useCallback((updater: (c: Card) => Card) => {\n    if (!selectedNuggetId) return;\n\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNuggetId\n        ? { ...n, cards: n.cards.map(updater), lastModifiedAt: Date.now() }\n        : n\n    ));\n\n    if (insightsSession) {\n      setInsightsSession(prev => prev ? { ...prev, cards: prev.cards.map(updater) } : prev);\n    }\n  }, [selectedNuggetId, insightsSession]);\n\n  const updateNuggetContentAndCards = useCallback((content: string, cards: Card[]) => {\n    if (!selectedNuggetId) return;\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNuggetId\n        ? { ...n, cards, lastModifiedAt: Date.now() }\n        : n\n    ));\n    setInsightsSession(prev => prev ? { ...prev, cards } : prev);\n  }, [selectedNuggetId]);\n\n  const appendNuggetMessage = useCallback((message: ChatMessage) => {\n    if (!selectedNuggetId) return;\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNuggetId\n        ? { ...n, messages: [...(n.messages || []), message], lastModifiedAt: Date.now() }\n        : n\n    ));\n    setInsightsSession(prev => prev ? { ...prev, messages: [...prev.messages, message] } : prev);\n  }, [selectedNuggetId]);\n\n  // ── Nugget document mutation helpers ──\n\n  /** Convert UploadedFile → InsightsDocument for session sync */\n  const toInsightsDoc = useCallback((doc: UploadedFile): InsightsDocument => ({\n    id: doc.id,\n    name: doc.name,\n    type: (doc.type === 'application/pdf' ? 'pdf' : 'md') as 'md' | 'pdf',\n    size: doc.size,\n    content: doc.content,\n  }), []);\n\n  const addNuggetDocument = useCallback((doc: UploadedFile) => {\n    if (!selectedNuggetId) return;\n    const event: DocChangeEvent = { type: 'added', docId: doc.id, docName: doc.name, timestamp: Date.now() };\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNuggetId\n        ? { ...n, documents: [...n.documents, doc], docChangeLog: [...(n.docChangeLog || []), event], lastModifiedAt: Date.now() }\n        : n\n    ));\n    // Sync insights session\n    setInsightsSession(prev => {\n      if (!prev) return prev;\n      return { ...prev, documents: [...prev.documents, toInsightsDoc(doc)] };\n    });\n  }, [selectedNuggetId, toInsightsDoc]);\n\n  const updateNuggetDocument = useCallback((docId: string, updated: UploadedFile) => {\n    if (!selectedNuggetId) return;\n    const event: DocChangeEvent = { type: 'updated', docId, docName: updated.name, timestamp: Date.now() };\n    setNuggets(prev => prev.map(n => {\n      if (n.id !== selectedNuggetId) return n;\n      // Only log if the doc was already fully processed (skip placeholder→ready transitions)\n      const existing = n.documents.find(d => d.id === docId);\n      const shouldLog = existing && existing.status === 'ready' && updated.status === 'ready';\n      return {\n        ...n,\n        documents: n.documents.map(d => d.id === docId ? updated : d),\n        ...(shouldLog ? { docChangeLog: [...(n.docChangeLog || []), event] } : {}),\n        lastModifiedAt: Date.now(),\n      };\n    }));\n    // Sync insights session\n    setInsightsSession(prev => {\n      if (!prev) return prev;\n      const exists = prev.documents.some(d => d.id === docId);\n      if (exists) {\n        return { ...prev, documents: prev.documents.map(d => d.id === docId ? toInsightsDoc(updated) : d) };\n      }\n      // Doc was a placeholder that just finished processing — add it\n      return { ...prev, documents: [...prev.documents, toInsightsDoc(updated)] };\n    });\n  }, [selectedNuggetId, toInsightsDoc, nuggets]);\n\n  const removeNuggetDocument = useCallback((docId: string) => {\n    if (!selectedNuggetId) return;\n    setNuggets(prev => prev.map(n => {\n      if (n.id !== selectedNuggetId) return n;\n      const doc = n.documents.find(d => d.id === docId);\n      const event: DocChangeEvent = { type: 'removed', docId, docName: doc?.name || 'Unknown', timestamp: Date.now() };\n      return { ...n, documents: n.documents.filter(d => d.id !== docId), docChangeLog: [...(n.docChangeLog || []), event], lastModifiedAt: Date.now() };\n    }));\n    // Sync insights session\n    setInsightsSession(prev => {\n      if (!prev) return prev;\n      return { ...prev, documents: prev.documents.filter(d => d.id !== docId) };\n    });\n  }, [selectedNuggetId]);\n\n  const renameNuggetDocument = useCallback((docId: string, newName: string) => {\n    if (!selectedNuggetId) return;\n    setNuggets(prev => prev.map(n => {\n      if (n.id !== selectedNuggetId) return n;\n      const doc = n.documents.find(d => d.id === docId);\n      const event: DocChangeEvent = { type: 'renamed', docId, docName: newName, oldName: doc?.name, timestamp: Date.now() };\n      return { ...n, documents: n.documents.map(d => d.id === docId ? { ...d, name: newName, lastRenamedAt: Date.now(), version: (d.version ?? 1) + 1 } : d), docChangeLog: [...(n.docChangeLog || []), event], lastModifiedAt: Date.now() };\n    }));\n    // Sync insights session\n    setInsightsSession(prev => {\n      if (!prev) return prev;\n      return { ...prev, documents: prev.documents.map(d => d.id === docId ? { ...d, name: newName } : d) };\n    });\n  }, [selectedNuggetId]);\n\n  const toggleNuggetDocument = useCallback((docId: string) => {\n    if (!selectedNuggetId) return;\n    // Capture current state before toggle\n    const nugget = nuggets.find(n => n.id === selectedNuggetId);\n    const doc = nugget?.documents.find(d => d.id === docId);\n    const wasEnabled = doc?.enabled !== false;\n\n    const event: DocChangeEvent = { type: wasEnabled ? 'disabled' : 'enabled', docId, docName: doc?.name || 'Unknown', timestamp: Date.now() };\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNuggetId\n        ? { ...n, documents: n.documents.map(d => d.id === docId ? { ...d, enabled: !(d.enabled !== false), ...(wasEnabled ? { lastDisabledAt: Date.now() } : { lastEnabledAt: Date.now() }) } : d), docChangeLog: [...(n.docChangeLog || []), event], lastModifiedAt: Date.now() }\n        : n\n    ));\n    // Sync insights session — remove disabled docs, add enabled ones back\n    setInsightsSession(prev => {\n      if (!prev) return prev;\n      if (wasEnabled) {\n        // Was enabled, now being disabled — remove from session\n        return { ...prev, documents: prev.documents.filter(d => d.id !== docId) };\n      } else {\n        // Was disabled, now being enabled — add back to session\n        if (doc) return { ...prev, documents: [...prev.documents, toInsightsDoc(doc)] };\n        return prev;\n      }\n    });\n  }, [selectedNuggetId, nuggets, toInsightsDoc]);\n\n  // ── Project helpers ──\n\n  const addProject = useCallback((project: Project) => {\n    setProjects(prev => [...prev, project]);\n  }, []);\n\n  const deleteProject = useCallback((projectId: string) => {\n    const project = projects.find(p => p.id === projectId);\n    if (project) {\n      // Cascade: delete all nuggets in this project\n      for (const nuggetId of project.nuggetIds) {\n        setNuggets(prev => prev.filter(n => n.id !== nuggetId));\n        if (selectedNuggetId === nuggetId) {\n          setSelectedNuggetId(null);\n          setSelectionLevel(null);\n        }\n      }\n    }\n    setProjects(prev => prev.filter(p => p.id !== projectId));\n  }, [projects, selectedNuggetId]);\n\n  const updateProject = useCallback((projectId: string, updater: (p: Project) => Project) => {\n    setProjects(prev => prev.map(p => p.id === projectId ? updater(p) : p));\n  }, []);\n\n  const addNuggetToProject = useCallback((projectId: string, nuggetId: string) => {\n    setProjects(prev => prev.map(p =>\n      p.id === projectId\n        ? { ...p, nuggetIds: [...p.nuggetIds, nuggetId], lastModifiedAt: Date.now() }\n        : p\n    ));\n  }, []);\n\n  const removeNuggetFromProject = useCallback((projectId: string, nuggetId: string) => {\n    setProjects(prev => prev.map(p =>\n      p.id === projectId\n        ? { ...p, nuggetIds: p.nuggetIds.filter(id => id !== nuggetId), lastModifiedAt: Date.now() }\n        : p\n    ));\n  }, []);\n\n  // Custom style helpers\n  const addCustomStyle = useCallback((style: CustomStyle) => {\n    setCustomStyles(prev => [...prev, style]);\n  }, []);\n\n  const updateCustomStyle = useCallback((id: string, updates: Partial<CustomStyle>) => {\n    setCustomStyles(prev => prev.map(s =>\n      s.id === id ? { ...s, ...updates, lastModifiedAt: Date.now() } : s\n    ));\n  }, []);\n\n  const deleteCustomStyle = useCallback((id: string) => {\n    setCustomStyles(prev => prev.filter(s => s.id !== id));\n  }, []);\n\n  const replaceCustomStyles = useCallback((styles: CustomStyle[]) => {\n    setCustomStyles(styles);\n  }, []);\n\n  const value = useMemo<AppContextValue>(() => ({\n    isProjectsPanelOpen, setIsProjectsPanelOpen,\n    activeCardId, setActiveCardId,\n    insightsSession, setInsightsSession,\n    nuggets, setNuggets,\n    selectedNuggetId, setSelectedNuggetId,\n    selectedDocumentId, setSelectedDocumentId,\n    selectedDocument,\n    selectedProjectId,\n    selectionLevel, setSelectionLevel,\n    selectEntity,\n    selectedNugget,\n    activeCard,\n    addNugget, deleteNugget, updateNugget,\n    updateNuggetCard, updateNuggetCards,\n    updateNuggetContentAndCards,\n    appendNuggetMessage,\n    addNuggetDocument, updateNuggetDocument, removeNuggetDocument, renameNuggetDocument, toggleNuggetDocument,\n    projects, setProjects,\n    addProject, deleteProject, updateProject, addNuggetToProject, removeNuggetFromProject,\n    initialTokenUsageTotals: initialState?.tokenUsageTotals,\n    customStyles, addCustomStyle, updateCustomStyle, deleteCustomStyle, replaceCustomStyles,\n    darkMode, toggleDarkMode,\n  }), [\n    isProjectsPanelOpen, activeCardId,\n    insightsSession,\n    nuggets, selectedNuggetId, selectedNugget,\n    selectedDocumentId, selectedDocument, selectedProjectId, selectionLevel, selectEntity,\n    activeCard,\n    addNugget, deleteNugget, updateNugget,\n    updateNuggetCard, updateNuggetCards,\n    updateNuggetContentAndCards,\n    appendNuggetMessage,\n    addNuggetDocument, updateNuggetDocument, removeNuggetDocument, renameNuggetDocument, toggleNuggetDocument,\n    projects,\n    addProject, deleteProject, updateProject, addNuggetToProject, removeNuggetFromProject,\n    customStyles, addCustomStyle, updateCustomStyle, deleteCustomStyle, replaceCustomStyles,\n    darkMode, toggleDarkMode,\n  ]);\n\n  return <AppContext.Provider value={value}>{children}</AppContext.Provider>;\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useAnnotations.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'NormalizedPoint' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"NormalizedPoint"},"fix":{"range":[66,83],"text":""},"desc":"Remove unused variable \"NormalizedPoint\"."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":15,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":15,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":15,"column":84,"nodeType":"Literal","messageId":"noMagic","endLine":15,"endColumn":85},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":51,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":51,"endColumn":35,"fix":{"range":[1721,1730],"text":"{return a;}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { useState, useCallback } from 'react';\nimport { Annotation, NormalizedPoint } from '../types';\n\ninterface UseAnnotationsReturn {\n  annotations: Annotation[];\n  selectedAnnotationId: string | null;\n  add: (annotation: Annotation) => void;\n  update: (id: string, partial: Partial<Annotation>) => void;\n  remove: (id: string) => void;\n  select: (id: string | null) => void;\n  clearAll: () => void;\n  moveAnnotation: (id: string, dx: number, dy: number) => void;\n}\n\nconst generateId = () => `ann-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\n\nexport const createAnnotationId = generateId;\n\nexport function useAnnotations(): UseAnnotationsReturn {\n  const [annotations, setAnnotations] = useState<Annotation[]>([]);\n  const [selectedAnnotationId, setSelectedAnnotationId] = useState<string | null>(null);\n\n  const add = useCallback((annotation: Annotation) => {\n    setAnnotations(prev => [...prev, annotation]);\n    setSelectedAnnotationId(annotation.id);\n  }, []);\n\n  const update = useCallback((id: string, partial: Partial<Annotation>) => {\n    setAnnotations(prev =>\n      prev.map(a => a.id === id ? { ...a, ...partial } as Annotation : a)\n    );\n  }, []);\n\n  const remove = useCallback((id: string) => {\n    setAnnotations(prev => prev.filter(a => a.id !== id));\n    setSelectedAnnotationId(prev => prev === id ? null : prev);\n  }, []);\n\n  const select = useCallback((id: string | null) => {\n    setSelectedAnnotationId(id);\n  }, []);\n\n  const clearAll = useCallback(() => {\n    setAnnotations([]);\n    setSelectedAnnotationId(null);\n  }, []);\n\n  const moveAnnotation = useCallback((id: string, dx: number, dy: number) => {\n    setAnnotations(prev =>\n      prev.map(a => {\n        if (a.id !== id) return a;\n        const clamp = (v: number) => Math.max(0, Math.min(1, v));\n        switch (a.type) {\n          case 'pin':\n            return { ...a, position: { x: clamp(a.position.x + dx), y: clamp(a.position.y + dy) } };\n          case 'rectangle':\n            return {\n              ...a,\n              topLeft: { x: clamp(a.topLeft.x + dx), y: clamp(a.topLeft.y + dy) },\n              bottomRight: { x: clamp(a.bottomRight.x + dx), y: clamp(a.bottomRight.y + dy) },\n            };\n          case 'arrow':\n            return {\n              ...a,\n              start: { x: clamp(a.start.x + dx), y: clamp(a.start.y + dy) },\n              end: { x: clamp(a.end.x + dx), y: clamp(a.end.y + dy) },\n            };\n          case 'sketch':\n            return { ...a, points: a.points.map(p => ({ x: clamp(p.x + dx), y: clamp(p.y + dy) })) };\n          default:\n            return a;\n        }\n      })\n    );\n  }, []);\n\n  return { annotations, selectedAnnotationId, add, update, remove, select, clearAll, moveAnnotation };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useAutoDeck.ts","messages":[{"ruleId":"import/order","severity":1,"message":"`./useTokenUsage` import should occur after import of `../components/ToastNotification`","line":13,"column":1,"nodeType":"ImportDeclaration","endLine":13,"endColumn":49,"fix":{"range":[293,912],"text":"import { buildPlannerPrompt, buildFinalizerPrompt } from '../utils/prompts/autoDeckPlanner';\nimport { buildProducerPrompt, batchPlan } from '../utils/prompts/autoDeckProducer';\nimport { parsePlannerResponse, parseFinalizerResponse, parseProducerResponse, ProducedCard } from '../utils/autoDeck/parsers';\nimport { AUTO_DECK_LOD_LEVELS, AUTO_DECK_LIMITS, countWords } from '../utils/autoDeck/constants';\nimport { getUniqueName } from '../utils/naming';\nimport { estimateTokens } from '../utils/tokenEstimation';\nimport { useToast } from '../components/ToastNotification';\nimport { RecordUsageFn } from './useTokenUsage';\n"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":60,"column":115,"nodeType":null,"messageId":"refactorFunction","endLine":60,"endColumn":117},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":61,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":61,"endColumn":33,"fix":{"range":[2252,2259],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":75,"column":72,"nodeType":"Literal","messageId":"noMagic","endLine":75,"endColumn":74},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":75,"column":86,"nodeType":"Literal","messageId":"noMagic","endLine":75,"endColumn":87},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":113,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":113,"endColumn":39,"fix":{"range":[4138,4155],"text":"{return inlineDoc;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 180000.","line":121,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":38},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5702,5705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5702,5705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":165,"column":16,"nodeType":"Literal","messageId":"defineConstant","endLine":165,"endColumn":35},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":183,"column":27,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":183,"endColumn":34,"fix":{"range":[6651,6748],"text":"for (const c of result.plan.cards) {\n          cardStates[c.number] = { included: true };\n        }"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7223,7226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7223,7226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":206,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":206,"endColumn":45,"fix":{"range":[7267,7274],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":20,"suggestions":[{"fix":{"range":[7281,7333],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":221,"column":43,"nodeType":null,"messageId":"refactorFunction","endLine":221,"endColumn":45},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":222,"column":85,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":222,"endColumn":92,"fix":{"range":[7799,7806],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":254,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":254,"endColumn":39,"fix":{"range":[8997,9014],"text":"{return inlineDoc;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":262,"column":52,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":262,"endColumn":59,"fix":{"range":[9278,9426],"text":"for (const [numStr, state] of Object.entries(session.reviewState.cardStates)) {\n      if (!state.included) excludedCards.push(Number(numStr));\n    }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":263,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":263,"endColumn":63,"fix":{"range":[9383,9418],"text":"{excludedCards.push(Number(numStr));}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":298,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10679,10682],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10679,10682],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":323,"column":27,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":323,"endColumn":34,"fix":{"range":[11377,11474],"text":"for (const c of result.plan.cards) {\n          cardStates[c.number] = { included: true };\n        }"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":353,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":353,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12239,12242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12239,12242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":354,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":354,"endColumn":45,"fix":{"range":[12283,12290],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":355,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":355,"endColumn":20,"suggestions":[{"fix":{"range":[12297,12350],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 35 to the 15 allowed.","line":373,"column":44,"nodeType":null,"messageId":"refactorFunction","endLine":373,"endColumn":46},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":374,"column":85,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":374,"endColumn":92,"fix":{"range":[13100,13107],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":400,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":400,"endColumn":39,"fix":{"range":[14121,14138],"text":"{return inlineDoc;}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'totalWordCount' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":404,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":404,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 15.","line":492,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":492,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":493,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":493,"endColumn":35},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":503,"column":26,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":505,"endColumn":96,"fix":{"range":[18042,18339],"text":"`IMPORTANT: You are writing cards ${batch[0].number}–${batch[batch.length - 1].number} of a ${finalCards.length}-card deck.\\n` +\n            `Other cards in the deck (do NOT repeat their content):\\n${ \n            otherCards.map(c => `  Card ${c.number}: ${c.title} — ${c.description}`).join('\\n')}`"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":530,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":530,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19314,19317],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19314,19317],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.5.","line":536,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":536,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.3.","line":536,"column":74,"nodeType":"Literal","messageId":"noMagic","endLine":536,"endColumn":77},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 64000.","line":537,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":537,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":537,"column":74,"nodeType":"Literal","messageId":"noMagic","endLine":537,"endColumn":77},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":572,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":572,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":572,"column":60,"nodeType":"Literal","messageId":"noMagic","endLine":572,"endColumn":61},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":599,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":599,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21719,21722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21719,21722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":600,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":600,"endColumn":45,"fix":{"range":[21763,21770],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":601,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":601,"endColumn":20,"suggestions":[{"fix":{"range":[21777,21828],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":616,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":616,"endColumn":36,"fix":{"range":[22268,22277],"text":"{return s;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":633,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":633,"endColumn":36,"fix":{"range":[22755,22764],"text":"{return s;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":649,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":649,"endColumn":64,"fix":{"range":[23149,23158],"text":"{return s;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":651,"column":30,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":651,"endColumn":37,"fix":{"range":[23215,23304],"text":"for (const q of s.parsedPlan.questions) {\n        answers[q.id] = q.recommendedKey;\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":663,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":663,"endColumn":36,"fix":{"range":[23558,23567],"text":"{return s;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":680,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":680,"endColumn":30,"fix":{"range":[23899,23911],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":701,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":701,"endColumn":50,"fix":{"range":[24650,24662],"text":"{return prev;}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":46,"fixableErrorCount":0,"fixableWarningCount":22,"source":"import { useState, useCallback, useRef } from 'react';\nimport { useAppContext } from '../context/AppContext';\nimport {\n  AutoDeckBriefing,\n  AutoDeckLod,\n  AutoDeckSession,\n  AutoDeckStatus,\n  Card,\n  ParsedPlan,\n  ReviewCardState,\n} from '../types';\nimport { callClaude } from '../utils/ai';\nimport { RecordUsageFn } from './useTokenUsage';\nimport { buildPlannerPrompt, buildFinalizerPrompt } from '../utils/prompts/autoDeckPlanner';\nimport { buildProducerPrompt, batchPlan } from '../utils/prompts/autoDeckProducer';\nimport { parsePlannerResponse, parseFinalizerResponse, parseProducerResponse, ProducedCard } from '../utils/autoDeck/parsers';\nimport { AUTO_DECK_LOD_LEVELS, AUTO_DECK_LIMITS, countWords } from '../utils/autoDeck/constants';\nimport { getUniqueName } from '../utils/naming';\nimport { estimateTokens } from '../utils/tokenEstimation';\nimport { useToast } from '../components/ToastNotification';\n\n/**\n * Auto-Deck orchestration hook.\n *\n * Manages the full two-agent pipeline:\n *   1. Planner — analyzes documents, produces a card plan\n *   2. User review — approve, revise, or exclude cards\n *   3. Producer — writes content for each approved card\n *   4. Card creation — adds cards to the nugget\n *\n * State machine: CONFIGURING → PLANNING → CONFLICT/REVIEWING → REVISING/PRODUCING → COMPLETE\n */\nexport function useAutoDeck(recordUsage?: RecordUsageFn) {\n  const {\n    selectedNugget,\n    updateNugget,\n  } = useAppContext();\n\n  const { addToast } = useToast();\n\n  const [session, setSession] = useState<AutoDeckSession | null>(null);\n  const abortRef = useRef<AbortController | null>(null);\n\n  // ── Helpers ──\n\n  const updateSession = useCallback((updater: (s: AutoDeckSession) => AutoDeckSession) => {\n    setSession(prev => prev ? updater(prev) : prev);\n  }, []);\n\n  const setStatus = useCallback((status: AutoDeckStatus) => {\n    updateSession(s => ({ ...s, status }));\n  }, [updateSession]);\n\n  // ── Actions ──\n\n  /**\n   * Start the planning phase: send documents to the Planner agent.\n   * @param orderedDocIds — document IDs in the user's chosen order (only these are sent)\n   */\n  const startPlanning = useCallback(async (briefing: AutoDeckBriefing, lod: AutoDeckLod, orderedDocIds: string[]) => {\n    if (!selectedNugget) return;\n\n    // Resolve documents in the user-specified order\n    const allNuggetDocs = selectedNugget.documents.filter(d => d.content || d.fileId || d.pdfBase64);\n    const orderedSelectedDocs = orderedDocIds\n      .map(id => allNuggetDocs.find(d => d.id === id))\n      .filter(Boolean) as typeof allNuggetDocs;\n\n    if (orderedSelectedDocs.length === 0) {\n      addToast({ message: 'No documents selected for Auto-Deck.', type: 'error' });\n      return;\n    }\n\n    // Create new session\n    const sessionId = `autodeck-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\n    const newSession: AutoDeckSession = {\n      id: sessionId,\n      nuggetId: selectedNugget.id,\n      briefing,\n      lod,\n      orderedDocIds,\n      status: 'planning',\n      parsedPlan: null,\n      conflicts: null,\n      reviewState: null,\n      producedCards: [],\n      revisionCount: 0,\n      error: null,\n      createdAt: Date.now(),\n    };\n    setSession(newSession);\n\n    // Split documents: inline (content) vs Files API (fileId only, e.g. native PDFs)\n    const fileApiDocs = orderedSelectedDocs.filter(d => d.fileId && !d.content);\n    const inlineDocs = orderedSelectedDocs.filter(d => d.content);\n\n    // Build inline document context for prompt — preserving user-specified order\n    const docs = inlineDocs.map(d => ({\n      id: d.id,\n      name: d.name,\n      wordCount: d.content ? countWords(d.content) : 0,\n      content: d.content || '',\n    }));\n    // Files API docs included in metadata but content sent via document blocks\n    const fileApiDocsMeta = fileApiDocs.map(d => ({\n      id: d.id,\n      name: d.name,\n      wordCount: 0, // word count unknown for Files API docs\n      content: '', // content sent via Files API document blocks, not inline\n    }));\n    const allDocsMeta = orderedDocIds.map(id => {\n      const inlineDoc = docs.find(d => d.id === id);\n      if (inlineDoc) return inlineDoc;\n      return fileApiDocsMeta.find(d => d.id === id);\n    }).filter(Boolean) as typeof docs;\n\n    const totalWordCount = docs.reduce((sum, d) => sum + d.wordCount, 0);\n\n    // Pre-flight token check (only inline docs — Files API docs don't count toward input tokens)\n    const estimatedInputTokens = estimateTokens(docs.map(d => d.content).join(''));\n    if (estimatedInputTokens > 180000) {\n      setSession(prev => prev ? { ...prev, status: 'error', error: 'Documents are too large for a single API call. Consider splitting into smaller nuggets.' } : prev);\n      return;\n    }\n\n    const abortController = new AbortController();\n    abortRef.current = abortController;\n\n    try {\n      const { systemBlocks, messages } = buildPlannerPrompt({\n        briefing,\n        lod,\n        subject: selectedNugget?.subject,\n        documents: allDocsMeta,\n        totalWordCount,\n      });\n\n      // Inject Files API document blocks into the first user message\n      if (fileApiDocs.length > 0) {\n        const docBlocks = fileApiDocs.map(d => ({\n          type: 'document' as const,\n          source: { type: 'file' as const, file_id: d.fileId! },\n          title: d.name,\n        }));\n\n        if (messages.length > 0 && messages[0].role === 'user') {\n          const firstMsg = messages[0];\n          const existingBlocks = typeof firstMsg.content === 'string'\n            ? [{ type: 'text' as const, text: firstMsg.content }]\n            : [...firstMsg.content];\n          messages[0] = { role: 'user', content: [...docBlocks, ...existingBlocks] as any };\n        }\n      }\n\n      const { text: rawResponse, usage } = await callClaude('', {\n        systemBlocks,\n        messages,\n        maxTokens: 16384,\n        temperature: 0.1,\n        signal: abortController.signal,\n      });\n\n      recordUsage?.({\n        provider: 'claude',\n        model: 'claude-sonnet-4-6',\n        inputTokens: usage.input_tokens,\n        outputTokens: usage.output_tokens,\n        cacheReadTokens: usage.cache_read_input_tokens,\n        cacheWriteTokens: usage.cache_creation_input_tokens,\n      });\n\n      const result = parsePlannerResponse(rawResponse);\n\n      if (result.status === 'conflict') {\n        setSession(prev => prev ? {\n          ...prev,\n          status: 'conflict',\n          conflicts: result.conflicts,\n        } : prev);\n      } else if (result.status === 'ok') {\n        // Initialize review state with all cards included\n        const cardStates: Record<number, ReviewCardState> = {};\n        result.plan.cards.forEach(c => {\n          cardStates[c.number] = { included: true };\n        });\n\n        setSession(prev => prev ? {\n          ...prev,\n          status: 'reviewing',\n          parsedPlan: result.plan,\n          reviewState: {\n            generalComment: '',\n            cardStates,\n            questionAnswers: {},\n            decision: 'pending',\n          },\n        } : prev);\n      } else {\n        setSession(prev => prev ? {\n          ...prev,\n          status: 'error',\n          error: result.error,\n        } : prev);\n      }\n    } catch (err: any) {\n      if (err.name === 'AbortError') return;\n      console.error('[useAutoDeck] Planner failed:', err);\n      setSession(prev => prev ? {\n        ...prev,\n        status: 'error',\n        error: `Planning failed: ${err.message}`,\n      } : prev);\n    } finally {\n      abortRef.current = null;\n    }\n  }, [selectedNugget, recordUsage, addToast]);\n\n  /**\n   * Revise the plan: send previous plan + user feedback back to the Planner.\n   */\n  const revisePlan = useCallback(async () => {\n    if (!session || !session.parsedPlan || !session.reviewState || !selectedNugget) return;\n    if (session.revisionCount >= AUTO_DECK_LIMITS.maxRevisions) {\n      addToast({ message: `Maximum revision limit (${AUTO_DECK_LIMITS.maxRevisions}) reached.`, type: 'error' });\n      return;\n    }\n\n    setStatus('revising');\n\n    // Resolve documents in the same order as the original session\n    const allNuggetDocs = selectedNugget.documents.filter(d => d.content || d.fileId || d.pdfBase64);\n    const orderedSelectedDocs = session.orderedDocIds\n      .map(id => allNuggetDocs.find(d => d.id === id))\n      .filter(Boolean) as typeof allNuggetDocs;\n\n    // Split documents: inline vs Files API\n    const fileApiDocs = orderedSelectedDocs.filter(d => d.fileId && !d.content);\n    const inlineDocs = orderedSelectedDocs.filter(d => d.content);\n\n    const docs = inlineDocs.map(d => ({\n      id: d.id,\n      name: d.name,\n      wordCount: d.content ? countWords(d.content) : 0,\n      content: d.content || '',\n    }));\n    const fileApiDocsMeta = fileApiDocs.map(d => ({\n      id: d.id,\n      name: d.name,\n      wordCount: 0,\n      content: '',\n    }));\n    const allDocsMeta = session.orderedDocIds.map(id => {\n      const inlineDoc = docs.find(d => d.id === id);\n      if (inlineDoc) return inlineDoc;\n      return fileApiDocsMeta.find(d => d.id === id);\n    }).filter(Boolean) as typeof docs;\n\n    const totalWordCount = docs.reduce((sum, d) => sum + d.wordCount, 0);\n\n    // Collect excluded cards and question answers\n    const excludedCards: number[] = [];\n    Object.entries(session.reviewState.cardStates).forEach(([numStr, state]) => {\n      if (!state.included) excludedCards.push(Number(numStr));\n    });\n\n    const abortController = new AbortController();\n    abortRef.current = abortController;\n\n    try {\n      const { systemBlocks, messages } = buildPlannerPrompt({\n        briefing: session.briefing,\n        lod: session.lod,\n        subject: selectedNugget?.subject,\n        documents: allDocsMeta,\n        totalWordCount,\n        revision: {\n          previousPlan: session.parsedPlan,\n          generalComment: session.reviewState.generalComment,\n          cardComments: {},\n          excludedCards,\n          questionAnswers: session.reviewState.questionAnswers,\n        },\n      });\n\n      // Inject Files API document blocks into the first user message\n      if (fileApiDocs.length > 0) {\n        const docBlocks = fileApiDocs.map(d => ({\n          type: 'document' as const,\n          source: { type: 'file' as const, file_id: d.fileId! },\n          title: d.name,\n        }));\n\n        if (messages.length > 0 && messages[0].role === 'user') {\n          const firstMsg = messages[0];\n          const existingBlocks = typeof firstMsg.content === 'string'\n            ? [{ type: 'text' as const, text: firstMsg.content }]\n            : [...firstMsg.content];\n          messages[0] = { role: 'user', content: [...docBlocks, ...existingBlocks] as any };\n        }\n      }\n\n      const { text: rawResponse, usage } = await callClaude('', {\n        systemBlocks,\n        messages,\n        maxTokens: 16384,\n        temperature: 0.1,\n        signal: abortController.signal,\n      });\n\n      recordUsage?.({\n        provider: 'claude',\n        model: 'claude-sonnet-4-6',\n        inputTokens: usage.input_tokens,\n        outputTokens: usage.output_tokens,\n        cacheReadTokens: usage.cache_read_input_tokens,\n        cacheWriteTokens: usage.cache_creation_input_tokens,\n      });\n\n      const result = parsePlannerResponse(rawResponse);\n\n      if (result.status === 'ok') {\n        const cardStates: Record<number, ReviewCardState> = {};\n        result.plan.cards.forEach(c => {\n          cardStates[c.number] = { included: true };\n        });\n\n        setSession(prev => prev ? {\n          ...prev,\n          status: 'reviewing',\n          parsedPlan: result.plan,\n          reviewState: {\n            generalComment: '',\n            cardStates,\n            questionAnswers: {},\n            decision: 'pending',\n          },\n          revisionCount: prev.revisionCount + 1,\n        } : prev);\n      } else if (result.status === 'conflict') {\n        setSession(prev => prev ? {\n          ...prev,\n          status: 'conflict',\n          conflicts: result.conflicts,\n          revisionCount: prev.revisionCount + 1,\n        } : prev);\n      } else {\n        setSession(prev => prev ? {\n          ...prev,\n          status: 'error',\n          error: result.error,\n        } : prev);\n      }\n    } catch (err: any) {\n      if (err.name === 'AbortError') return;\n      console.error('[useAutoDeck] Revision failed:', err);\n      setSession(prev => prev ? {\n        ...prev,\n        status: 'error',\n        error: `Revision failed: ${err.message}`,\n      } : prev);\n    } finally {\n      abortRef.current = null;\n    }\n  }, [session, selectedNugget, recordUsage, setStatus, addToast]);\n\n  /**\n   * Submit the reviewed plan: finalize (AI bakes in decisions) then produce content.\n   *\n   * Phase 1 — Finalize: Send draft plan + MCQ answers + excluded cards + general comment\n   *   to the planner AI, which outputs a clean, self-contained plan.\n   * Phase 2 — Produce: Send the finalized plan to the producer AI to write card content.\n   */\n  const approvePlan = useCallback(async () => {\n    if (!session || !session.parsedPlan || !session.reviewState || !selectedNugget) return;\n\n    // Resolve documents in the same order as the original session\n    const allNuggetDocs = selectedNugget.documents.filter(d => d.content || d.fileId || d.pdfBase64);\n    const orderedSelectedDocs = session.orderedDocIds\n      .map(id => allNuggetDocs.find(d => d.id === id))\n      .filter(Boolean) as typeof allNuggetDocs;\n\n    // Split documents: inline vs Files API\n    const fileApiDocs = orderedSelectedDocs.filter(d => d.fileId && !d.content);\n    const inlineDocs = orderedSelectedDocs.filter(d => d.content);\n\n    const inlineDocsWithWordCount = inlineDocs.map(d => ({\n      id: d.id,\n      name: d.name,\n      wordCount: d.content ? countWords(d.content) : 0,\n      content: d.content || '',\n    }));\n    const fileApiDocsMeta = fileApiDocs.map(d => ({\n      id: d.id,\n      name: d.name,\n      wordCount: 0,\n      content: '',\n    }));\n    const allDocsMetaWithWordCount = session.orderedDocIds.map(id => {\n      const inlineDoc = inlineDocsWithWordCount.find(d => d.id === id);\n      if (inlineDoc) return inlineDoc;\n      return fileApiDocsMeta.find(d => d.id === id);\n    }).filter(Boolean) as typeof inlineDocsWithWordCount;\n\n    const totalWordCount = inlineDocsWithWordCount.reduce((sum, d) => sum + d.wordCount, 0);\n\n    // Filter to only included cards\n    const includedCards = session.parsedPlan.cards.filter(\n      c => session.reviewState!.cardStates[c.number]?.included !== false\n    );\n\n    if (includedCards.length === 0) {\n      addToast({ message: 'No cards selected. Please include at least one card.', type: 'error' });\n      setStatus('reviewing');\n      return;\n    }\n\n    const abortController = new AbortController();\n    abortRef.current = abortController;\n\n    try {\n      // ── Phase 1: Finalize ──\n      // Build a filtered plan with only included cards for the finalizer\n      const filteredPlan: ParsedPlan = {\n        ...session.parsedPlan,\n        cards: includedCards,\n      };\n\n      const hasQuestions = session.parsedPlan.questions && session.parsedPlan.questions.length > 0;\n      const hasAnsweredQuestions = hasQuestions && Object.keys(session.reviewState.questionAnswers).length > 0;\n      const hasGeneralComment = !!session.reviewState.generalComment?.trim();\n\n      // Only run the finalizer if there are actual decisions or feedback to incorporate\n      let finalizedPlan: ParsedPlan;\n\n      if (hasAnsweredQuestions || hasGeneralComment) {\n        setStatus('finalizing');\n\n        // Finalizer only restructures the plan — does NOT need source documents\n        const { systemBlocks: finSystemBlocks, messages: finMessages } = buildFinalizerPrompt({\n          briefing: session.briefing,\n          lod: session.lod,\n          subject: selectedNugget?.subject,\n          plan: filteredPlan,\n          questions: session.parsedPlan.questions || [],\n          questionAnswers: session.reviewState.questionAnswers,\n          generalComment: session.reviewState.generalComment || undefined,\n        });\n\n        const { text: finRawResponse, usage: finUsage } = await callClaude('', {\n          systemBlocks: finSystemBlocks,\n          messages: finMessages,\n          maxTokens: 16384,\n          temperature: 0.1,\n          signal: abortController.signal,\n        });\n\n        recordUsage?.({\n          provider: 'claude',\n          model: 'claude-sonnet-4-6',\n          inputTokens: finUsage.input_tokens,\n          outputTokens: finUsage.output_tokens,\n          cacheReadTokens: finUsage.cache_read_input_tokens,\n          cacheWriteTokens: finUsage.cache_creation_input_tokens,\n        });\n\n        const finResult = parseFinalizerResponse(finRawResponse);\n\n        if (finResult.status !== 'ok') {\n          throw new Error(finResult.status === 'error' ? finResult.error : 'Finalizer returned unexpected status');\n        }\n\n        finalizedPlan = finResult.plan;\n\n        // Update session with finalized plan\n        setSession(prev => prev ? {\n          ...prev,\n          parsedPlan: finalizedPlan,\n        } : prev);\n      } else {\n        // No decisions to incorporate — use the filtered plan as-is\n        finalizedPlan = filteredPlan;\n      }\n\n      // ── Phase 2: Produce ──\n      setStatus('producing');\n\n      // Build producer doc metadata (without wordCount, matching ProducerPromptParams)\n      const producerDocsMeta = allDocsMetaWithWordCount.map(({ id, name, content }) => ({ id, name, content }));\n\n      // Batch if needed (>15 cards)\n      const finalCards = finalizedPlan.cards;\n      const batches = finalCards.length > 15\n        ? batchPlan(finalCards, 12)\n        : [finalCards];\n\n      const allProducedCards: ProducedCard[] = [];\n\n      for (const batch of batches) {\n        // Build batch context: tell the producer about other cards in the deck to avoid repetition\n        let batchContext: string | undefined;\n        if (batches.length > 1) {\n          const otherCards = finalCards.filter(c => !batch.includes(c));\n          batchContext = `IMPORTANT: You are writing cards ${batch[0].number}–${batch[batch.length - 1].number} of a ${finalCards.length}-card deck.\\n` +\n            `Other cards in the deck (do NOT repeat their content):\\n` +\n            otherCards.map(c => `  Card ${c.number}: ${c.title} — ${c.description}`).join('\\n');\n        }\n\n        const { systemBlocks, messages } = buildProducerPrompt({\n          briefing: session.briefing,\n          lod: session.lod,\n          subject: selectedNugget?.subject,\n          plan: batch,\n          documents: producerDocsMeta,\n          batchContext,\n        });\n\n        // Inject Files API document blocks into the first user message\n        if (fileApiDocs.length > 0) {\n          const docBlocks = fileApiDocs.map(d => ({\n            type: 'document' as const,\n            source: { type: 'file' as const, file_id: d.fileId! },\n            title: d.name,\n          }));\n\n          if (messages.length > 0 && messages[0].role === 'user') {\n            const firstMsg = messages[0];\n            const existingBlocks = typeof firstMsg.content === 'string'\n              ? [{ type: 'text' as const, text: firstMsg.content }]\n              : [...firstMsg.content];\n            messages[0] = { role: 'user', content: [...docBlocks, ...existingBlocks] as any };\n          }\n        }\n\n        // Scale maxTokens based on batch size and LOD\n        const lodConfig = AUTO_DECK_LOD_LEVELS[session.lod];\n        const tokensPerCard = Math.ceil((lodConfig.wordCountMax * 1.5) * 1.3); // words→tokens with overhead\n        const maxTokens = Math.min(64000, batch.length * tokensPerCard + 500);\n\n        const { text: rawResponse, usage } = await callClaude('', {\n          systemBlocks,\n          messages,\n          maxTokens,\n          signal: abortController.signal,\n        });\n\n        recordUsage?.({\n          provider: 'claude',\n          model: 'claude-sonnet-4-6',\n          inputTokens: usage.input_tokens,\n          outputTokens: usage.output_tokens,\n          cacheReadTokens: usage.cache_read_input_tokens,\n          cacheWriteTokens: usage.cache_creation_input_tokens,\n        });\n\n        const result = parseProducerResponse(rawResponse);\n        if (result.status === 'ok') {\n          allProducedCards.push(...result.cards);\n        } else {\n          throw new Error(result.error);\n        }\n      }\n\n      // Create Card objects and add to nugget\n      const enabledDocNames = orderedSelectedDocs.map(d => d.name);\n      const existingCardNames = selectedNugget.cards.map(c => c.text);\n      const detailLevel = AUTO_DECK_LOD_LEVELS[session.lod].detailLevel;\n\n      const newCards: Card[] = allProducedCards.map(pc => {\n        const uniqueName = getUniqueName(pc.title, [...existingCardNames, ...allProducedCards.filter(p => p !== pc).map(p => p.title)]);\n        existingCardNames.push(uniqueName);\n        return {\n          id: `card-${Math.random().toString(36).substr(2, 9)}`,\n          level: 1,\n          text: uniqueName,\n          detailLevel,\n          synthesisMap: { [detailLevel]: `# ${pc.title}\\n\\n${pc.content}` },\n          createdAt: Date.now(),\n          lastEditedAt: Date.now(),\n          sourceDocuments: enabledDocNames,\n          autoDeckSessionId: session.id,\n        };\n      });\n\n      // Append to nugget cards\n      updateNugget(selectedNugget.id, n => ({\n        ...n,\n        cards: [...n.cards, ...newCards],\n        lastModifiedAt: Date.now(),\n      }));\n\n      setSession(prev => prev ? {\n        ...prev,\n        status: 'complete',\n        producedCards: allProducedCards,\n      } : prev);\n\n      addToast({ message: `${newCards.length} cards generated successfully.`, type: 'success' });\n\n    } catch (err: any) {\n      if (err.name === 'AbortError') return;\n      console.error('[useAutoDeck] Submit failed:', err);\n      setSession(prev => prev ? {\n        ...prev,\n        status: 'error',\n        error: `Content generation failed: ${err.message}`,\n      } : prev);\n    } finally {\n      abortRef.current = null;\n    }\n  }, [session, selectedNugget, recordUsage, updateNugget, setStatus, addToast]);\n\n  // ── Review state helpers ──\n\n  const toggleCardIncluded = useCallback((cardNumber: number) => {\n    updateSession(s => {\n      if (!s.reviewState) return s;\n      const current = s.reviewState.cardStates[cardNumber];\n      return {\n        ...s,\n        reviewState: {\n          ...s.reviewState,\n          cardStates: {\n            ...s.reviewState.cardStates,\n            [cardNumber]: { ...current, included: !current.included },\n          },\n        },\n      };\n    });\n  }, [updateSession]);\n\n  const setQuestionAnswer = useCallback((questionId: string, optionKey: string) => {\n    updateSession(s => {\n      if (!s.reviewState) return s;\n      return {\n        ...s,\n        reviewState: {\n          ...s.reviewState,\n          questionAnswers: {\n            ...s.reviewState.questionAnswers,\n            [questionId]: optionKey,\n          },\n        },\n      };\n    });\n  }, [updateSession]);\n\n  const setAllRecommended = useCallback(() => {\n    updateSession(s => {\n      if (!s.reviewState || !s.parsedPlan?.questions) return s;\n      const answers: Record<string, string> = {};\n      s.parsedPlan.questions.forEach(q => {\n        answers[q.id] = q.recommendedKey;\n      });\n      return {\n        ...s,\n        reviewState: { ...s.reviewState, questionAnswers: answers },\n      };\n    });\n  }, [updateSession]);\n\n  const setGeneralComment = useCallback((comment: string) => {\n    updateSession(s => {\n      if (!s.reviewState) return s;\n      return {\n        ...s,\n        reviewState: {\n          ...s.reviewState,\n          generalComment: comment,\n        },\n      };\n    });\n  }, [updateSession]);\n\n  // ── Abort / Reset ──\n\n  const abort = useCallback(() => {\n    abortRef.current?.abort();\n    abortRef.current = null;\n    setSession(prev => {\n      if (!prev) return prev;\n      // Go back to reviewing if we were finalizing/producing/revising, otherwise reset\n      if (prev.status === 'finalizing' || prev.status === 'producing' || prev.status === 'revising') {\n        return { ...prev, status: prev.parsedPlan ? 'reviewing' : 'configuring' };\n      }\n      if (prev.status === 'planning') {\n        return { ...prev, status: 'configuring' };\n      }\n      return prev;\n    });\n  }, []);\n\n  const reset = useCallback(() => {\n    abortRef.current?.abort();\n    abortRef.current = null;\n    setSession(null);\n  }, []);\n\n  /** Go back to reviewing state from an error (preserves plan + review state) */\n  const retryFromReview = useCallback(() => {\n    setSession(prev => {\n      if (!prev || !prev.parsedPlan) return prev;\n      return { ...prev, status: 'reviewing', error: null };\n    });\n  }, []);\n\n  return {\n    session,\n    // Actions\n    startPlanning,\n    revisePlan,\n    approvePlan,\n    abort,\n    reset,\n    retryFromReview,\n    // Review helpers\n    toggleCardIncluded,\n    setQuestionAnswer,\n    setAllRecommended,\n    setGeneralComment,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useCardGeneration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Heading' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Heading"},"fix":{"range":[133,142],"text":""},"desc":"Remove unused variable \"Heading\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DEFAULT_STYLING' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DEFAULT_STYLING"},"fix":{"range":[244,260],"text":""},"desc":"Remove unused variable \"DEFAULT_STYLING\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ClaudeUsage' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":85,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ClaudeUsage"},"fix":{"range":[306,319],"text":""},"desc":"Remove unused variable \"ClaudeUsage\"."}]},{"ruleId":"import/order","severity":1,"message":"`./useTokenUsage` import should occur after import of `../components/ToastNotification`","line":6,"column":1,"nodeType":"ImportDeclaration","endLine":6,"endColumn":49,"fix":{"range":[355,1094],"text":"import { extractBase64, extractMime } from '../utils/modificationEngine';\nimport { buildContentPrompt, buildPlannerPrompt, buildNativePdfSectionHint } from '../utils/prompts/contentGeneration';\nimport { buildVisualizerPrompt } from '../utils/prompts/imageGeneration';\nimport { buildCoverContentPrompt, buildCoverPlannerPrompt, buildCoverVisualizerPrompt } from '../utils/prompts/coverGeneration';\nimport { buildExpertPriming } from '../utils/prompts/promptUtils';\nimport {\n  buildPwcPlannerPrompt,\n  buildPwcVisualizerPrompt,\n  buildPwcCoverPlannerPrompt,\n  buildPwcCoverVisualizerPrompt,\n} from '../utils/prompts/pwcGeneration';\nimport { useToast } from '../components/ToastNotification';\nimport { RecordUsageFn } from './useTokenUsage';\n"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":60,"column":24,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":60,"endColumn":34,"fix":{"range":[2509,2519],"text":"{return '';}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'activeCard' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":65,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":19},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":66,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":66,"endColumn":38,"fix":{"range":[2677,2689],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":72,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":72,"endColumn":26,"fix":{"range":[2972,2982],"text":"{return '';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":78,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":78,"endColumn":39,"fix":{"range":[3167,3180],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":80,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":80,"endColumn":59,"fix":{"range":[3268,3281],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":81,"column":58,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":81,"endColumn":71,"fix":{"range":[3339,3352],"text":"{return false;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":95,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":95,"endColumn":42,"fix":{"range":[3909,3924],"text":"{return content;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 31 to the 15 allowed.","line":120,"column":79,"nodeType":null,"messageId":"refactorFunction","endLine":120,"endColumn":81},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":121,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":121,"endColumn":38,"fix":{"range":[4817,4829],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":129,"column":75,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":129,"endColumn":87,"fix":{"range":[5358,5370],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":138,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":138,"endColumn":167,"fix":{"range":[5603,5745],"text":"{setCardStatus(card.id, isCover ? `Generating ${level} content for [${card.text}]...` : `Synthesizing ${level} Mapping for [${card.text}]...`);}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":157,"column":26,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":163,"endColumn":200},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":174,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8066,8069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8066,8069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":192,"column":22,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":194,"endColumn":80},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 350.","line":193,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 256.","line":193,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":193,"endColumn":52},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":194,"column":16,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":194,"endColumn":79},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":194,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":194,"endColumn":43},{"ruleId":"unicorn/no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":194,"column":46,"nodeType":"ConditionalExpression","messageId":"too-deep","endLine":194,"endColumn":79},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":194,"column":69,"nodeType":"Literal","messageId":"noMagic","endLine":194,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1200.","line":194,"column":75,"nodeType":"Literal","messageId":"noMagic","endLine":194,"endColumn":79},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":220,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9692,9695],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9692,9695],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":221,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":221,"endColumn":20,"suggestions":[{"fix":{"range":[9705,9745],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":228,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":228,"endColumn":54,"fix":{"range":[9950,9977],"text":"{setCardStatus(card.id, '');}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'recordUsage'. Either include it or remove the dependency array. If 'recordUsage' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":230,"column":6,"nodeType":"ArrayExpression","endLine":230,"endColumn":70,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, updateNuggetCard, manifestCards, setCardStatus, recordUsage]","fix":{"range":[9989,10053],"text":"[selectedNugget, updateNuggetCard, manifestCards, setCardStatus, recordUsage]"}}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 51 to the 15 allowed.","line":234,"column":84,"nodeType":null,"messageId":"refactorFunction","endLine":234,"endColumn":86},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":235,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10240,10243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10240,10243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":236,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10295,10298],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10295,10298],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":238,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10376,10379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10376,10379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":259,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":259,"endColumn":101,"fix":{"range":[10941,11016],"text":"{throw new Error(`Could not obtain ${currentLevel} synthesis for mapping.`);}"}},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":267,"column":31,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":273,"endColumn":132},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":288,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":288,"endColumn":21,"suggestions":[{"fix":{"range":[12425,12505],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-nested-ternary","severity":1,"message":"Do not nest ternary expressions.","line":294,"column":26,"nodeType":"ConditionalExpression","messageId":"noNestedTernary","endLine":300,"endColumn":111},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":357,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":357,"endColumn":44},{"ruleId":"curly","severity":1,"message":"Expected { after 'while' condition.","line":357,"column":46,"nodeType":"WhileStatement","messageId":"missingCurlyAfterCondition","endLine":357,"endColumn":69,"fix":{"range":[15575,15598],"text":"{updatedHistory.shift();}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":369,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":369,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16229,16232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16229,16232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":370,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":370,"endColumn":20,"suggestions":[{"fix":{"range":[16242,16283],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":371,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":371,"endColumn":20,"suggestions":[{"fix":{"range":[16290,16619],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":377,"column":7,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":377,"endColumn":9},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 404.","line":377,"column":85,"nodeType":"Literal","messageId":"noMagic","endLine":377,"endColumn":88},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":378,"column":9,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":380,"endColumn":10,"fix":{"range":[16629,16859],"text":"((err.message?.includes(\"Requested entity was not found\") || err.status === 404) && typeof window !== 'undefined' && (window as any).aistudio) {\n          await (window as any).aistudio.openSelectKey();\n        }"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":378,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":378,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16767,16770],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16767,16770],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":379,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":379,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16811,16814],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16811,16814],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12000.","line":396,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":396,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 8000.","line":396,"column":42,"nodeType":"Literal","messageId":"noMagic","endLine":396,"endColumn":46},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":399,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":399,"endColumn":54,"fix":{"range":[17679,17706],"text":"{setCardStatus(card.id, '');}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'recordUsage' and 'selectedNugget?.subject'. Either include them or remove the dependency array. If 'recordUsage' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":405,"column":6,"nodeType":"ArrayExpression","endLine":405,"endColumn":135,"suggestions":[{"desc":"Update the dependencies array to be: [menuDraftOptions, selectedNugget?.subject, updateNuggetCard, setCardStatus, referenceImage, useReferenceImage, performSynthesis, recordUsage, addToast, manifestCards]","fix":{"range":[17864,17993],"text":"[menuDraftOptions, selectedNugget?.subject, updateNuggetCard, setCardStatus, referenceImage, useReferenceImage, performSynthesis, recordUsage, addToast, manifestCards]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":414,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":414,"endColumn":24,"fix":{"range":[18250,18257],"text":"{return;}"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'addToast'. Either include it or remove the dependency array.","line":423,"column":6,"nodeType":"ArrayExpression","endLine":423,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [addToast, selectedNugget?.cards]","fix":{"range":[18521,18537],"text":"[addToast, selectedNugget?.cards]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":426,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":426,"endColumn":32,"fix":{"range":[18616,18623],"text":"{return;}"}}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":51,"fixableErrorCount":0,"fixableWarningCount":18,"source":"\nimport { useState, useCallback, useMemo, useRef } from 'react';\nimport { useAppContext } from '../context/AppContext';\nimport { Card, Heading, DetailLevel, StylingOptions, ImageVersion, ReferenceImage, isCoverLevel } from '../types';\nimport { DEFAULT_STYLING, withGeminiRetry, callClaude, PRO_IMAGE_CONFIG, ClaudeUsage, getGeminiAI } from '../utils/ai';\nimport { RecordUsageFn } from './useTokenUsage';\nimport { extractBase64, extractMime } from '../utils/modificationEngine';\nimport { buildContentPrompt, buildPlannerPrompt, buildNativePdfSectionHint } from '../utils/prompts/contentGeneration';\nimport { buildVisualizerPrompt } from '../utils/prompts/imageGeneration';\nimport { buildCoverContentPrompt, buildCoverPlannerPrompt, buildCoverVisualizerPrompt } from '../utils/prompts/coverGeneration';\nimport { buildExpertPriming } from '../utils/prompts/promptUtils';\nimport {\n  buildPwcPlannerPrompt,\n  buildPwcVisualizerPrompt,\n  buildPwcCoverPlannerPrompt,\n  buildPwcCoverVisualizerPrompt,\n} from '../utils/prompts/pwcGeneration';\nimport { useToast } from '../components/ToastNotification';\n\n/**\n * Card generation pipeline — shared by the insights workflow.\n * Handles: content synthesis → layout planning → image generation → batch operations.\n */\nexport function useCardGeneration(\n  menuDraftOptions: StylingOptions,\n  referenceImage: ReferenceImage | null = null,\n  useReferenceImage: boolean = false,\n  recordUsage?: RecordUsageFn,\n) {\n  const {\n    selectedNugget,\n    activeCardId,\n    updateNuggetCard,\n  } = useAppContext();\n\n  const { addToast } = useToast();\n\n  // State — per-card status tracking for concurrent generation\n  const [genStatusMap, setGenStatusMap] = useState<Record<string, string>>({});\n  const [activeLogicTab, setActiveLogicTab] = useState<DetailLevel>('Standard');\n  const [manifestCards, setManifestCards] = useState<Card[] | null>(null);\n\n  // Store a ref to generateCard so the retry closure can call it\n  const generateCardRef = useRef<(card: Card) => Promise<void>>(undefined);\n\n  // Helper: set status for a specific card\n  const setCardStatus = useCallback((cardId: string, status: string) => {\n    setGenStatusMap(prev => {\n      if (!status) {\n        // Remove the entry when clearing\n        const { [cardId]: _, ...rest } = prev;\n        return rest;\n      }\n      return { ...prev, [cardId]: status };\n    });\n  }, []);\n\n  // Derived: status for the currently-viewed card (used by AssetsPanel display)\n  const genStatus = useMemo(() => {\n    if (!activeCardId) return '';\n    return genStatusMap[activeCardId] || '';\n  }, [genStatusMap, activeCardId]);\n\n  // Derived\n  const activeCard = useMemo(() => {\n    if (!selectedNugget) return null;\n    return selectedNugget.cards.find(c => c.id === selectedNugget.cards.find(() => true)?.id) || null;\n  }, [selectedNugget]);\n\n  const currentSynthesisContent = useMemo(() => {\n    const card = selectedNugget?.cards.find(c => c.id === selectedNugget?.cards[0]?.id);\n    if (!card) return '';\n    const level = card.detailLevel || 'Standard';\n    return card.synthesisMap?.[level] || '';\n  }, [selectedNugget]);\n\n  const contentDirty = useMemo(() => {\n    if (!selectedNugget) return false;\n    const card = selectedNugget.cards[0];\n    if (!card?.cardUrlMap?.[activeLogicTab]) return false;\n    if (!card.lastGeneratedContentMap?.[activeLogicTab]) return false;\n    const content = card.synthesisMap?.[card.detailLevel || 'Standard'] || '';\n    return content !== card.lastGeneratedContentMap[activeLogicTab];\n  }, [selectedNugget, activeLogicTab]);\n\n  const selectedCount = useMemo(() => {\n    const cards = selectedNugget?.cards ?? [];\n    return cards.filter(c => c.selected).length;\n  }, [selectedNugget]);\n\n  // ── Helpers ──\n\n  const getSectionContext = (target: Card, structure: Card[], content: string): string => {\n    const targetIdx = structure.findIndex(c => c.id === target.id);\n    if (targetIdx === -1) return content;\n\n    const findOffset = (card: Card) => {\n      const escapedText = card.text.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      const regex = new RegExp(`^(#{1,6})\\\\s+${escapedText}\\\\s*$`, 'g');\n      const matches = [...content.matchAll(regex)];\n      const match = matches.find(m => m[0].includes(card.text));\n      return match ? match.index : null;\n    };\n\n    const targetOffset = findOffset(target) ?? 0;\n\n    let nextHeadingOffset = content.length;\n    for (let i = targetIdx + 1; i < structure.length; i++) {\n      if (structure[i].level <= target.level) {\n        nextHeadingOffset = findOffset(structure[i]) ?? content.length;\n        break;\n      }\n    }\n\n    return content.substring(targetOffset, nextHeadingOffset);\n  };\n\n  // ── Internal: synthesize content for a card ──\n\n  const performSynthesis = useCallback(async (card: Card, level: DetailLevel) => {\n    if (!selectedNugget) return null;\n    const enabledDocs = selectedNugget.documents.filter(d => d.enabled !== false && (d.content || d.fileId));\n    // Split: docs with fileId go via Files API only; docs without fileId go inline\n    const fileApiDocs = enabledDocs.filter(d => d.fileId);\n    const inlineDocs = enabledDocs.filter(d => !d.fileId && d.content);\n    const inlineContent = inlineDocs.map(d => d.content).join('\\n\\n---\\n\\n');\n    const activeStructure = selectedNugget.cards;\n\n    if ((!inlineContent && fileApiDocs.length === 0) || !activeStructure) return null;\n\n    // Set synthesizing status\n    updateNuggetCard(card.id, c => ({\n      ...c,\n      isSynthesizingMap: { ...(c.isSynthesizingMap || {}), [level]: true }\n    }));\n\n    const isCover = isCoverLevel(level);\n    if (!manifestCards) setCardStatus(card.id, isCover ? `Generating ${level} content for [${card.text}]...` : `Synthesizing ${level} Mapping for [${card.text}]...`);\n\n    try {\n      // Section extraction only works on inline markdown content\n      const sectionText = inlineContent ? getSectionContext(card, activeStructure, inlineContent) : '';\n\n      // For native PDFs (no markdown), build a section hint with page boundaries\n      const nativePdfSectionHint = (!sectionText && fileApiDocs.length > 0)\n        ? buildNativePdfSectionHint(card.text, enabledDocs)\n        : '';\n\n      // Branch: cover prompts vs content prompts\n      const nuggetSubject = selectedNugget?.subject;\n      const synthesisPrompt = isCover\n        ? buildCoverContentPrompt(card.text, level, inlineContent, sectionText, true, nuggetSubject)\n        : buildContentPrompt(card.text, level, inlineContent, sectionText, true, nuggetSubject);\n      const finalPrompt = synthesisPrompt + nativePdfSectionHint;\n\n      const expertPriming = buildExpertPriming(nuggetSubject);\n      const systemRole = isCover\n        ? (expertPriming\n          ? `${expertPriming} You also serve as an expert cover slide content designer. You create bold, concise titles, subtitles, and taglines for presentation cover slides. Follow the format and word count requirements precisely.`\n          : 'You are an expert cover slide content designer. You create bold, concise titles, subtitles, and taglines for presentation cover slides. Follow the format and word count requirements precisely.')\n        : (expertPriming\n          ? `${expertPriming} You also serve as an expert content synthesizer. You extract, restructure, and condense document content into infographic-ready text. Follow the formatting and word count requirements precisely.`\n          : 'You are an expert content synthesizer. You extract, restructure, and condense document content into infographic-ready text. Follow the formatting and word count requirements precisely.');\n\n      const systemBlocks: Array<{ text: string; cache: boolean }> = [\n        { text: systemRole, cache: false },\n      ];\n      // Only inline docs (no fileId) go into system blocks — avoids double-sending\n      if (inlineDocs.length > 0) {\n        systemBlocks.push({ text: `FULL DOCUMENT CONTEXT:\\n${inlineContent}`, cache: true });\n      }\n\n      // Build messages array with Files API document blocks prepended\n      const messages: Array<{ role: 'user' | 'assistant'; content: any }> = [];\n      if (fileApiDocs.length > 0) {\n        const docBlocks = fileApiDocs.map(d => ({\n          type: 'document' as const,\n          source: { type: 'file' as const, file_id: d.fileId! },\n          title: d.name,\n        }));\n        messages.push({\n          role: 'user' as const,\n          content: [...docBlocks, { type: 'text' as const, text: finalPrompt }],\n        });\n      }\n\n      const { text: rawSynthesized, usage: claudeUsage } = await callClaude(\n        fileApiDocs.length > 0 ? '' : finalPrompt,\n        {\n          systemBlocks,\n          ...(fileApiDocs.length > 0 ? { messages } : {}),\n          maxTokens: isCover\n            ? (level === 'TakeawayCard' ? 350 : 256)\n            : (level === 'Executive' ? 300 : level === 'Standard' ? 600 : 1200),\n        },\n      );\n\n      recordUsage?.({\n        provider: 'claude',\n        model: 'claude-sonnet-4-6',\n        inputTokens: claudeUsage.input_tokens,\n        outputTokens: claudeUsage.output_tokens,\n        cacheReadTokens: claudeUsage.cache_read_input_tokens,\n        cacheWriteTokens: claudeUsage.cache_creation_input_tokens,\n      });\n\n      let synthesizedText = rawSynthesized;\n      if (!isCover) {\n        synthesizedText = synthesizedText.replace(/^\\s*#\\s+[^\\n]*\\n*/, '');\n        synthesizedText = `# ${card.text}\\n\\n${synthesizedText.trimStart()}`;\n      }\n\n      updateNuggetCard(card.id, c => ({\n        ...c,\n        synthesisMap: { ...(c.synthesisMap || {}), [level]: synthesizedText },\n        isSynthesizingMap: { ...(c.isSynthesizingMap || {}), [level]: false },\n      }));\n\n      return synthesizedText;\n    } catch (err: any) {\n      console.error(\"Synthesis failed:\", err);\n      updateNuggetCard(card.id, c => ({\n        ...c,\n        isSynthesizingMap: { ...(c.isSynthesizingMap || {}), [level]: false }\n      }));\n      return null;\n    } finally {\n      if (!manifestCards) setCardStatus(card.id, '');\n    }\n  }, [selectedNugget, manifestCards, updateNuggetCard, setCardStatus]);\n\n  // ── Generate card image for a card ──\n\n  const generateCard = useCallback(async (card: Card, skipReferenceOnce?: boolean) => {\n    if (typeof window !== 'undefined' && (window as any).aistudio) {\n      const hasKey = await (window as any).aistudio.hasSelectedApiKey();\n      if (!hasKey) {\n        await (window as any).aistudio.openSelectKey();\n      }\n    }\n\n    const settings = { ...menuDraftOptions };\n    const currentLevel = settings.levelOfDetail;\n    const nuggetSubject = selectedNugget?.subject;\n\n    // Set generating status\n    updateNuggetCard(card.id, c => ({\n      ...c,\n      isGeneratingMap: { ...(c.isGeneratingMap || {}), [currentLevel]: true }\n    }));\n\n    try {\n      let contentToMap = card.synthesisMap?.[currentLevel];\n\n      if (!contentToMap) {\n        contentToMap = await performSynthesis(card, currentLevel) || '';\n      }\n\n      if (!contentToMap) throw new Error(`Could not obtain ${currentLevel} synthesis for mapping.`);\n\n      const isCover = isCoverLevel(currentLevel);\n      const isPwc = settings.style === 'PwC Corporate';\n      setCardStatus(card.id, `Planning layout for [${card.text}]...`);\n\n      let visualPlan: string | undefined;\n      try {\n        const plannerPrompt = isCover\n          ? (isPwc\n            ? buildPwcCoverPlannerPrompt(card.text, contentToMap, settings.style, settings.aspectRatio, currentLevel)\n            : buildCoverPlannerPrompt(card.text, contentToMap, settings.style, settings.aspectRatio, currentLevel))\n          : (isPwc\n            ? buildPwcPlannerPrompt(card.text, contentToMap, settings.aspectRatio, card.visualPlanMap?.[currentLevel])\n            : buildPlannerPrompt(card.text, contentToMap, settings.aspectRatio, card.visualPlanMap?.[currentLevel], nuggetSubject));\n\n        const plannerResponse = await callClaude(plannerPrompt, { maxTokens: 4096 });\n        visualPlan = plannerResponse.text || undefined;\n        if (plannerResponse.usage) {\n          recordUsage?.({\n            provider: 'claude',\n            model: 'claude-sonnet-4-6',\n            inputTokens: plannerResponse.usage.input_tokens,\n            outputTokens: plannerResponse.usage.output_tokens,\n            cacheReadTokens: plannerResponse.usage.cache_read_input_tokens,\n            cacheWriteTokens: plannerResponse.usage.cache_creation_input_tokens,\n          });\n        }\n      } catch (err) {\n        console.warn('Planner step failed, falling back to direct visualization:', err);\n      }\n\n      setCardStatus(card.id, `Rendering ${settings.style} ${isCover ? 'Card' : 'Visual'} [${currentLevel}] for [${card.text}]...`);\n\n      const shouldUseRef = !!(referenceImage && useReferenceImage && !skipReferenceOnce);\n      const lastPrompt = isCover\n        ? (isPwc\n          ? buildPwcCoverVisualizerPrompt(card.text, contentToMap, settings, visualPlan, shouldUseRef, currentLevel)\n          : buildCoverVisualizerPrompt(card.text, contentToMap, settings, visualPlan, shouldUseRef, currentLevel))\n        : (isPwc\n          ? buildPwcVisualizerPrompt(card.text, contentToMap, settings, visualPlan, shouldUseRef)\n          : buildVisualizerPrompt(card.text, contentToMap, settings, visualPlan, shouldUseRef, nuggetSubject));\n\n      const parts: Array<{ text?: string; inlineData?: { mimeType: string; data: string } }> = [];\n      if (shouldUseRef) {\n        parts.push({\n          inlineData: {\n            mimeType: extractMime(referenceImage!.url),\n            data: extractBase64(referenceImage!.url),\n          },\n        });\n      }\n      parts.push({ text: lastPrompt });\n\n      const imageResponse = await withGeminiRetry(async () => {\n        return await getGeminiAI().models.generateContent({\n          model: 'gemini-3-pro-image-preview',\n          contents: [{ parts }],\n          config: {\n            ...PRO_IMAGE_CONFIG,\n            imageConfig: {\n              aspectRatio: settings.aspectRatio,\n              imageSize: settings.resolution\n            }\n          }\n        });\n      });\n\n      if (imageResponse.usageMetadata) {\n        recordUsage?.({\n          provider: 'gemini',\n          model: 'gemini-3-pro-image-preview',\n          inputTokens: imageResponse.usageMetadata.promptTokenCount ?? 0,\n          outputTokens: imageResponse.usageMetadata.candidatesTokenCount ?? 0,\n        });\n      }\n\n      let cardUrl = '';\n      for (const part of imageResponse.candidates[0].content.parts) {\n        if (part.inlineData) {\n          cardUrl = `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;\n          break;\n        }\n      }\n\n      if (cardUrl) {\n        updateNuggetCard(card.id, c => {\n          // Preserve version history: keep existing versions and append the new generation\n          const existingHistory = c.imageHistoryMap?.[currentLevel] || [];\n          const prevUrl = c.cardUrlMap?.[currentLevel];\n          const updatedHistory = [...existingHistory];\n          // If there's a previous image that isn't already the last entry, add it\n          if (prevUrl && (updatedHistory.length === 0 || updatedHistory[updatedHistory.length - 1].imageUrl !== prevUrl)) {\n            updatedHistory.push({ imageUrl: prevUrl, timestamp: Date.now(), label: updatedHistory.length === 0 ? 'Original' : `Generation ${updatedHistory.length}` });\n          }\n          // Add the new generation\n          updatedHistory.push({ imageUrl: cardUrl, timestamp: Date.now(), label: `Generation ${updatedHistory.length + 1}` });\n          // Cap at 10 versions\n          while (updatedHistory.length > 10) updatedHistory.shift();\n          return {\n            ...c,\n            cardUrlMap: { ...(c.cardUrlMap || {}), [currentLevel]: cardUrl },\n            isGeneratingMap: { ...(c.isGeneratingMap || {}), [currentLevel]: false },\n            imageHistoryMap: { ...(c.imageHistoryMap || {}), [currentLevel]: updatedHistory },\n            lastGeneratedContentMap: { ...(c.lastGeneratedContentMap || {}), [currentLevel]: contentToMap },\n            visualPlanMap: { ...(c.visualPlanMap || {}), [currentLevel]: visualPlan },\n            lastPromptMap: { ...(c.lastPromptMap || {}), [currentLevel]: lastPrompt },\n          };\n        });\n      }\n    } catch (err: any) {\n      console.error(\"Generation failed:\", err);\n      console.error(\"Generation error details:\", JSON.stringify({\n        message: err.message, status: err.status, code: err.code,\n        details: err.details, errorInfo: err.errorInfo,\n        aspectRatio: settings.aspectRatio, resolution: settings.resolution,\n        style: settings.style, level: currentLevel,\n      }, null, 2));\n      if (err.message?.includes(\"Requested entity was not found\") || err.status === 404) {\n        if (typeof window !== 'undefined' && (window as any).aistudio) {\n          await (window as any).aistudio.openSelectKey();\n        }\n      }\n\n      // Determine if this was a retryable error (503/overloaded/rate-limit)\n      const msg = (err.message || '').toLowerCase();\n      const isOverloaded = msg.includes('503') || msg.includes('unavailable') || msg.includes('high demand') || msg.includes('overloaded');\n\n      addToast({\n        type: isOverloaded ? 'warning' : 'error',\n        message: isOverloaded\n          ? `Model overloaded — generation for \"${card.text}\" failed after retries`\n          : `Generation failed for \"${card.text}\"`,\n        detail: isOverloaded\n          ? 'The AI model is experiencing high demand. Try again in a moment.'\n          : (err.message || 'Unknown error'),\n        onRetry: () => { generateCardRef.current?.(card); },\n        duration: isOverloaded ? 12000 : 8000,\n      });\n    } finally {\n      if (!manifestCards) setCardStatus(card.id, '');\n      updateNuggetCard(card.id, c => ({\n        ...c,\n        isGeneratingMap: { ...(c.isGeneratingMap || {}), [currentLevel]: false }\n      }));\n    }\n  }, [performSynthesis, manifestCards, menuDraftOptions, referenceImage, useReferenceImage, updateNuggetCard, setCardStatus, addToast]);\n\n  // Keep ref in sync so retry closures always call the latest generateCard\n  generateCardRef.current = generateCard;\n\n  // ── Batch operations ──\n\n  const handleGenerateAll = useCallback(() => {\n    const cards = selectedNugget?.cards;\n    if (!cards) return;\n\n    const selectedItems = cards.filter(c => c.selected);\n    if (selectedItems.length === 0) {\n      addToast({ type: 'info', message: 'Please select items in the sidebar first.', duration: 4000 });\n      return;\n    }\n\n    setManifestCards(selectedItems);\n  }, [selectedNugget]);\n\n  const executeBatchCardGeneration = async () => {\n    if (!manifestCards) return;\n    const selectedItems = [...manifestCards];\n    setManifestCards(null);\n\n    // Set initial batch status on each card\n    for (const item of selectedItems) {\n      setCardStatus(item.id, `Queued for batch generation...`);\n    }\n    await Promise.allSettled(selectedItems.map(item => generateCard(item)));\n    // Individual card statuses are cleared in generateCard's finally block\n  };\n\n  // ── Image modification handler ──\n\n  const handleImageModified = useCallback((cardId: string, newImageUrl: string, history: ImageVersion[]) => {\n    const cards = selectedNugget?.cards ?? [];\n    const card = cards.find(c => c.id === cardId);\n    const level = card?.detailLevel || 'Standard';\n    const currentContent = card?.synthesisMap?.[level] || '';\n\n    updateNuggetCard(cardId, c => ({\n      ...c,\n      cardUrlMap: { ...(c.cardUrlMap || {}), [level]: newImageUrl },\n      imageHistoryMap: { ...(c.imageHistoryMap || {}), [level]: history },\n      lastGeneratedContentMap: { ...(c.lastGeneratedContentMap || {}), [level]: currentContent || c.lastGeneratedContentMap?.[level] },\n    }));\n  }, [selectedNugget, updateNuggetCard]);\n\n  return {\n    genStatus,\n    activeLogicTab, setActiveLogicTab,\n    manifestCards, setManifestCards,\n    currentSynthesisContent, contentDirty, selectedCount,\n    generateCard,\n    handleGenerateAll,\n    executeBatchCardGeneration,\n    handleImageModified,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useDocumentEditing.ts","messages":[{"ruleId":"import/order","severity":1,"message":"`marked` import should occur before import of `../utils/markdown`","line":4,"column":1,"nodeType":"ImportDeclaration","endLine":4,"endColumn":33,"fix":{"range":[84,169],"text":"import { marked } from 'marked';\nimport { htmlToMarkdown } from '../utils/markdown';\n"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":45,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":45,"endColumn":61,"fix":{"range":[1496,1503],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":47,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":47,"endColumn":50,"fix":{"range":[1592,1599],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":52,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":52,"endColumn":39},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":52,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":52,"endColumn":67,"fix":{"range":[1820,1846],"text":"{undoStack.current.shift();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":60,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":60,"endColumn":61,"fix":{"range":[2270,2277],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":71,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":71,"endColumn":41},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":71,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":71,"endColumn":69,"fix":{"range":[2820,2846],"text":"{undoStack.current.shift();}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":77,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":77,"endColumn":39},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":77,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":77,"endColumn":67,"fix":{"range":[3088,3114],"text":"{undoStack.current.shift();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":82,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":82,"endColumn":36,"fix":{"range":[3291,3298],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":87,"column":11,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":87,"endColumn":18,"fix":{"range":[3517,3838],"text":"for (const [index, el] of els.entries()) {\n        if (!el.id) el.id = `doc-h-${index}-${Math.random().toString(36).substr(2, 4)}`;\n        parsed.push({\n          id: el.id,\n          text: el.textContent || '',\n          level: parseInt(el.tagName.substring(1)),\n          selected: prevMap.get(el.id) ?? false,\n        });\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":88,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":88,"endColumn":89,"fix":{"range":[3566,3634],"text":"{el.id = `doc-h-${index}-${Math.random().toString(36).substr(2, 4)}`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":88,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":88,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":88,"column":84,"nodeType":"Literal","messageId":"noMagic","endLine":88,"endColumn":85},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":101,"column":63,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":101,"endColumn":70,"fix":{"range":[3985,3992],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":118,"column":63,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":118,"endColumn":70,"fix":{"range":[4653,4660],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":136,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":136,"endColumn":36,"fix":{"range":[5366,5373],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":141,"column":11,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":141,"endColumn":18,"fix":{"range":[5592,5913],"text":"for (const [index, el] of els.entries()) {\n        if (!el.id) el.id = `doc-h-${index}-${Math.random().toString(36).substr(2, 4)}`;\n        parsed.push({\n          id: el.id,\n          text: el.textContent || '',\n          level: parseInt(el.tagName.substring(1)),\n          selected: prevMap.get(el.id) ?? false,\n        });\n      }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":142,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":142,"endColumn":89,"fix":{"range":[5641,5709],"text":"{el.id = `doc-h-${index}-${Math.random().toString(36).substr(2, 4)}`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":142,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":142,"endColumn":72},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":142,"column":84,"nodeType":"Literal","messageId":"noMagic","endLine":142,"endColumn":85},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":157,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":157,"endColumn":62,"fix":{"range":[6181,6188],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":187,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":187,"endColumn":55,"fix":{"range":[7286,7303],"text":"{setIsDirty(true);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":191,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":191,"endColumn":78,"fix":{"range":[7508,7547],"text":"{clearTimeout(snapshotTimerRef.current);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":192,"column":70,"nodeType":"Literal","messageId":"noMagic","endLine":192,"endColumn":73},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":197,"column":107,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":197,"endColumn":146,"fix":{"range":[7874,7913],"text":"{clearTimeout(snapshotTimerRef.current);}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 17 to the 15 allowed.","line":202,"column":51,"nodeType":null,"messageId":"refactorFunction","endLine":202,"endColumn":53},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":205,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":205,"endColumn":67,"fix":{"range":[8203,8223],"text":"{formats.add('bold');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":206,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":206,"endColumn":71,"fix":{"range":[8272,8294],"text":"{formats.add('italic');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":207,"column":62,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":207,"endColumn":91,"fix":{"range":[8356,8385],"text":"{formats.add('unorderedList');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":208,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":208,"endColumn":87,"fix":{"range":[8445,8472],"text":"{formats.add('orderedList');}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_e' is defined but never used.","line":209,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":209,"endColumn":16},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":229,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":229,"endColumn":57,"fix":{"range":[9186,9213],"text":"{updateActiveFormatStates();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":238,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":238,"endColumn":36,"fix":{"range":[9517,9524],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":247,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":247,"endColumn":36,"fix":{"range":[9823,9830],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 35 to the 15 allowed.","line":256,"column":76,"nodeType":null,"messageId":"refactorFunction","endLine":256,"endColumn":78},{"ruleId":"no-alert","severity":1,"message":"Unexpected prompt.","line":265,"column":19,"nodeType":"CallExpression","messageId":"unexpected","endLine":265,"endColumn":48},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":266,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":266,"endColumn":58,"fix":{"range":[10560,10602],"text":"{document.execCommand(command, false, url);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'while' condition.","line":298,"column":33,"nodeType":"WhileStatement","messageId":"missingCurlyAfterCondition","endLine":298,"endColumn":67,"fix":{"range":[12154,12188],"text":"{frag.appendChild(temp.firstChild);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'for' condition.","line":317,"column":36,"nodeType":"ForStatement","messageId":"missingCurlyAfterCondition","endLine":317,"endColumn":67,"fix":{"range":[12905,12936],"text":"{tableHtml += '<th>Header</th>';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'for' condition.","line":321,"column":38,"nodeType":"ForStatement","messageId":"missingCurlyAfterCondition","endLine":321,"endColumn":67,"fix":{"range":[13083,13112],"text":"{tableHtml += '<td>Data</td>';}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":328,"column":62,"nodeType":null,"messageId":"refactorFunction","endLine":328,"endColumn":64},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":354,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":354,"endColumn":76,"fix":{"range":[14526,14566],"text":"{return { ...h, selected: !allSelected };}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":363,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":363,"endColumn":35,"fix":{"range":[14796,14808],"text":"{return prev;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":367,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":367,"endColumn":49,"fix":{"range":[15002,15008],"text":"{break;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":375,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":375,"endColumn":36,"fix":{"range":[15251,15258],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":377,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":377,"endColumn":21,"fix":{"range":[15371,15378],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":411,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":411,"endColumn":36,"fix":{"range":[16496,16503],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":413,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":413,"endColumn":53,"fix":{"range":[16648,16655],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":416,"column":89,"nodeType":"Literal","messageId":"noMagic","endLine":416,"endColumn":90},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":417,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":417,"endColumn":43,"fix":{"range":[16862,16869],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":434,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":434,"endColumn":36,"fix":{"range":[17420,17427],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":436,"column":13,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":436,"endColumn":72,"fix":{"range":[17539,17598],"text":"{el.scrollIntoView({ behavior: 'smooth', block: 'center' });}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":441,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":441,"endColumn":36,"fix":{"range":[17796,17803],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 30 to the 15 allowed.","line":455,"column":75,"nodeType":null,"messageId":"refactorFunction","endLine":455,"endColumn":77},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":456,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":456,"endColumn":61,"fix":{"range":[18558,18565],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":457,"column":56,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":457,"endColumn":63,"fix":{"range":[18621,18628],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":458,"column":52,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":458,"endColumn":59,"fix":{"range":[18680,18687],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":465,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":465,"endColumn":27,"fix":{"range":[18946,18953],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":475,"column":80,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":475,"endColumn":86,"fix":{"range":[19445,19451],"text":"{break;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":487,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":487,"endColumn":27,"fix":{"range":[19881,19888],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":491,"column":17,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":491,"endColumn":24,"fix":{"range":[19998,20048],"text":"for (const n of nodesToMove) fragment.appendChild(n);"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":502,"column":82,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":502,"endColumn":88,"fix":{"range":[20605,20611],"text":"{break;}"}}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useLayoutEffect has a missing dependency: 'populateEditor'. Either include it or remove the dependency array.","line":177,"column":6,"nodeType":"ArrayExpression","endLine":177,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [populateEditor]","fix":{"range":[6945,6947],"text":"[populateEditor]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'editorObserverRef', 'editorRef', 'parseHeadings', and 'pushUndo'. Either include them or remove the dependency array.","line":199,"column":6,"nodeType":"ArrayExpression","endLine":199,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [editorObserverRef, editorRef, parseHeadings, pushUndo]","fix":{"range":[7982,7984],"text":"[editorObserverRef, editorRef, parseHeadings, pushUndo]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":63,"fixableErrorCount":0,"fixableWarningCount":49,"source":"\nimport { useState, useCallback, useEffect, useLayoutEffect, useRef } from 'react';\nimport { htmlToMarkdown } from '../utils/markdown';\nimport { marked } from 'marked';\n\ninterface UseDocumentEditingDeps {\n  editorRef: React.RefObject<HTMLDivElement | null>;\n  editorObserverRef: React.MutableRefObject<MutationObserver | null>;\n  initialContent: string;\n  onSave: (markdown: string) => void;\n  closeFindBar: () => void;\n  clearFindHighlights: () => void;\n}\n\nexport interface EditorHeading {\n  id: string;\n  text: string;\n  level: number;\n  selected: boolean;\n}\n\nexport function useDocumentEditing({\n  editorRef,\n  editorObserverRef,\n  initialContent,\n  onSave,\n  closeFindBar,\n  clearFindHighlights,\n}: UseDocumentEditingDeps) {\n  const [isDirty, setIsDirty] = useState(false);\n  const [activeFormats, setActiveFormats] = useState<Set<string>>(new Set<string>());\n  const [headings, setHeadings] = useState<EditorHeading[]>([]);\n  const suppressDirtyRef = useRef(false);\n  const initialContentRef = useRef(initialContent);\n\n  // ── Custom undo/redo stack (captures ALL changes including promote/demote) ──\n  const undoStack = useRef<string[]>([]);\n  const redoStack = useRef<string[]>([]);\n  const isUndoRedoing = useRef(false);\n  const lastSnapshotRef = useRef<string>('');\n  const snapshotTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // ── Snapshot helpers for custom undo/redo ──\n  const pushUndo = useCallback(() => {\n    if (!editorRef.current || isUndoRedoing.current) return;\n    const html = editorRef.current.innerHTML;\n    if (html === lastSnapshotRef.current) return; // no change\n    undoStack.current.push(lastSnapshotRef.current);\n    redoStack.current = []; // clear redo on new action\n    lastSnapshotRef.current = html;\n    // Cap stack size\n    if (undoStack.current.length > 200) undoStack.current.shift();\n  }, [editorRef]);\n\n  /** Flush any pending debounced snapshot, then unconditionally push the\n   *  current editor state onto the undo stack so it can be restored later.\n   *  Use this BEFORE programmatic DOM mutations (promote/demote/reorder)\n   *  where pushUndo() would skip because innerHTML hasn't changed yet. */\n  const snapshotBeforeChange = useCallback(() => {\n    if (!editorRef.current || isUndoRedoing.current) return;\n    // Flush pending debounced snapshot so it doesn't fire after our change\n    if (snapshotTimerRef.current) {\n      clearTimeout(snapshotTimerRef.current);\n      snapshotTimerRef.current = null;\n    }\n    // First, capture any pending typing changes that haven't been snapshotted\n    const html = editorRef.current.innerHTML;\n    if (html !== lastSnapshotRef.current) {\n      // There were unsaved typing changes — push the old snapshot first\n      undoStack.current.push(lastSnapshotRef.current);\n      if (undoStack.current.length > 200) undoStack.current.shift();\n      lastSnapshotRef.current = html;\n    }\n    // Now push the current state as the undo point for the upcoming change\n    undoStack.current.push(lastSnapshotRef.current);\n    redoStack.current = [];\n    if (undoStack.current.length > 200) undoStack.current.shift();\n  }, [editorRef]);\n\n  // Parse headings helper (used by undo/redo to reparse after innerHTML swap)\n  const parseHeadingsInner = useCallback(() => {\n    if (!editorRef.current) return;\n    const els = editorRef.current.querySelectorAll('h1, h2, h3, h4, h5, h6');\n    setHeadings(prev => {\n      const prevMap = new Map(prev.map(h => [h.id, h.selected]));\n      const parsed: EditorHeading[] = [];\n      els.forEach((el, index) => {\n        if (!el.id) el.id = `doc-h-${index}-${Math.random().toString(36).substr(2, 4)}`;\n        parsed.push({\n          id: el.id,\n          text: el.textContent || '',\n          level: parseInt(el.tagName.substring(1)),\n          selected: prevMap.get(el.id) ?? false,\n        });\n      });\n      return parsed;\n    });\n  }, [editorRef]);\n\n  const undo = useCallback(() => {\n    if (!editorRef.current || undoStack.current.length === 0) return;\n    isUndoRedoing.current = true;\n    suppressDirtyRef.current = true;\n    // Save current state for redo\n    redoStack.current.push(editorRef.current.innerHTML);\n    const prev = undoStack.current.pop()!;\n    editorRef.current.innerHTML = prev;\n    lastSnapshotRef.current = prev;\n    setIsDirty(prev !== (marked.parse(initialContentRef.current, { async: false }) as string));\n    parseHeadingsInner();\n    requestAnimationFrame(() => {\n      isUndoRedoing.current = false;\n      suppressDirtyRef.current = false;\n    });\n  }, [editorRef, parseHeadingsInner]);\n\n  const redo = useCallback(() => {\n    if (!editorRef.current || redoStack.current.length === 0) return;\n    isUndoRedoing.current = true;\n    suppressDirtyRef.current = true;\n    // Save current state for undo\n    undoStack.current.push(editorRef.current.innerHTML);\n    const next = redoStack.current.pop()!;\n    editorRef.current.innerHTML = next;\n    lastSnapshotRef.current = next;\n    setIsDirty(next !== (marked.parse(initialContentRef.current, { async: false }) as string));\n    parseHeadingsInner();\n    requestAnimationFrame(() => {\n      isUndoRedoing.current = false;\n      suppressDirtyRef.current = false;\n    });\n  }, [editorRef, parseHeadingsInner]);\n\n  // ── Parse headings from editor DOM (preserves selection state) ──\n  const parseHeadings = useCallback(() => {\n    if (!editorRef.current) return;\n    const els = editorRef.current.querySelectorAll('h1, h2, h3, h4, h5, h6');\n    setHeadings(prev => {\n      const prevMap = new Map(prev.map(h => [h.id, h.selected]));\n      const parsed: EditorHeading[] = [];\n      els.forEach((el, index) => {\n        if (!el.id) el.id = `doc-h-${index}-${Math.random().toString(36).substr(2, 4)}`;\n        parsed.push({\n          id: el.id,\n          text: el.textContent || '',\n          level: parseInt(el.tagName.substring(1)),\n          selected: prevMap.get(el.id) ?? false,\n        });\n      });\n      return parsed;\n    });\n  }, [editorRef]);\n\n  // ── Populate editor from markdown (useLayoutEffect to run before paint) ──\n  const contentInitRef = useRef(false);\n  const populateEditor = useCallback(() => {\n    if (!editorRef.current || contentInitRef.current) return;\n    contentInitRef.current = true;\n    suppressDirtyRef.current = true;\n    editorRef.current.innerHTML = marked.parse(initialContentRef.current, { async: false }) as string;\n    parseHeadings();\n    setIsDirty(false);\n    // Capture initial snapshot for undo baseline\n    lastSnapshotRef.current = editorRef.current.innerHTML;\n    undoStack.current = [];\n    redoStack.current = [];\n    requestAnimationFrame(() => { suppressDirtyRef.current = false; });\n  }, [editorRef, parseHeadings]);\n\n  useLayoutEffect(() => {\n    populateEditor();\n    // Fallback: if ref wasn't ready, retry on next frame\n    if (!contentInitRef.current) {\n      requestAnimationFrame(() => populateEditor());\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []); // Only on mount\n\n  // ── MutationObserver for dirty tracking + heading re-parse + undo snapshots ──\n  useEffect(() => {\n    if (!editorRef.current) {\n      editorObserverRef.current = null;\n      return;\n    }\n    const editor = editorRef.current;\n    const observer = new MutationObserver(() => {\n      if (!suppressDirtyRef.current) setIsDirty(true);\n      parseHeadings();\n      // Debounced undo snapshot — captures state after typing pauses (500ms)\n      if (!isUndoRedoing.current && !suppressDirtyRef.current) {\n        if (snapshotTimerRef.current) clearTimeout(snapshotTimerRef.current);\n        snapshotTimerRef.current = setTimeout(() => { pushUndo(); }, 500);\n      }\n    });\n    observer.observe(editor, { childList: true, subtree: true, characterData: true });\n    editorObserverRef.current = observer;\n    return () => { observer.disconnect(); editorObserverRef.current = null; if (snapshotTimerRef.current) clearTimeout(snapshotTimerRef.current); };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // ── Selection change listener for active format detection ──\n  const updateActiveFormatStates = useCallback(() => {\n    const formats = new Set<string>();\n    try {\n      if (document.queryCommandState('bold')) formats.add('bold');\n      if (document.queryCommandState('italic')) formats.add('italic');\n      if (document.queryCommandState('insertUnorderedList')) formats.add('unorderedList');\n      if (document.queryCommandState('insertOrderedList')) formats.add('orderedList');\n    } catch (_e) { /* ignore */ }\n\n    const selection = window.getSelection();\n    if (selection && selection.rangeCount > 0) {\n      let node = selection.anchorNode as Node | null;\n      while (node && node !== editorRef.current) {\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          const tagName = (node as HTMLElement).tagName;\n          if (['H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'BLOCKQUOTE', 'CODE', 'PRE', 'A', 'TABLE', 'UL', 'OL'].includes(tagName)) {\n            formats.add(tagName);\n          }\n        }\n        node = node.parentNode;\n      }\n    }\n    setActiveFormats(formats);\n  }, [editorRef]);\n\n  useEffect(() => {\n    const handleSelectionChange = () => {\n      if (editorRef.current) updateActiveFormatStates();\n    };\n    document.addEventListener('selectionchange', handleSelectionChange);\n    return () => document.removeEventListener('selectionchange', handleSelectionChange);\n  }, [updateActiveFormatStates, editorRef]);\n\n  // ── Actions ──\n\n  const saveEdits = useCallback(() => {\n    if (!editorRef.current) return;\n    clearFindHighlights();\n    closeFindBar();\n    const newMarkdown = htmlToMarkdown(editorRef.current.innerHTML);\n    onSave(newMarkdown);\n    setIsDirty(false);\n  }, [editorRef, onSave, closeFindBar, clearFindHighlights]);\n\n  const discardEdits = useCallback(() => {\n    if (!editorRef.current) return;\n    clearFindHighlights();\n    closeFindBar();\n    suppressDirtyRef.current = true;\n    editorRef.current.innerHTML = marked.parse(initialContentRef.current, { async: false }) as string;\n    setIsDirty(false);\n    requestAnimationFrame(() => { suppressDirtyRef.current = false; });\n  }, [editorRef, closeFindBar, clearFindHighlights]);\n\n  const executeCommand = useCallback((command: string, value: string = '') => {\n    // Route undo/redo through our custom stack\n    if (command === 'undo') { undo(); return; }\n    if (command === 'redo') { redo(); return; }\n\n    // Push snapshot before any formatting change\n    pushUndo();\n\n    if (command === 'createLink') {\n      const url = prompt('Enter the link URL:');\n      if (url) document.execCommand(command, false, url);\n    } else if (command === 'removeFormat') {\n      const sel = window.getSelection();\n      if (sel && !sel.isCollapsed && editorRef.current) {\n        const range = sel.getRangeAt(0);\n        const fragment = range.cloneContents();\n        // Walk the fragment, extract only text nodes and <br> elements\n        const walker = document.createTreeWalker(fragment, NodeFilter.SHOW_ALL);\n        const parts: string[] = [];\n        const blockTags = new Set(['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'TR', 'BLOCKQUOTE', 'SECTION', 'ARTICLE', 'HEADER', 'FOOTER']);\n        let lastWasBlock = false;\n        while (walker.nextNode()) {\n          const node = walker.currentNode;\n          if (node.nodeType === Node.TEXT_NODE) {\n            const text = node.textContent || '';\n            if (text) { parts.push(text); lastWasBlock = false; }\n          } else if (node.nodeType === Node.ELEMENT_NODE) {\n            const el = node as Element;\n            if (el.tagName === 'BR') {\n              parts.push('<br>');\n              lastWasBlock = false;\n            } else if (blockTags.has(el.tagName) && parts.length > 0 && !lastWasBlock) {\n              parts.push('<br>');\n              lastWasBlock = true;\n            }\n          }\n        }\n        // Replace selected content with plain text + line breaks wrapped in <p>\n        range.deleteContents();\n        const temp = document.createElement('span');\n        temp.innerHTML = parts.join('');\n        const frag = document.createDocumentFragment();\n        while (temp.firstChild) frag.appendChild(temp.firstChild);\n        range.insertNode(frag);\n        // Collapse to end\n        sel.collapseToEnd();\n      } else {\n        // No selection: just strip inline formatting via browser command\n        document.execCommand('removeFormat', false);\n        document.execCommand('formatBlock', false, 'p');\n      }\n    } else {\n      document.execCommand(command, false, value);\n    }\n    lastSnapshotRef.current = editorRef.current?.innerHTML || '';\n    updateActiveFormatStates();\n    editorRef.current?.focus();\n  }, [updateActiveFormatStates, editorRef, pushUndo, undo, redo]);\n\n  const insertTable = useCallback((rows: number = 3, cols: number = 3) => {\n    let tableHtml = '<table><thead><tr>';\n    for (let c = 0; c < cols; c++) tableHtml += '<th>Header</th>';\n    tableHtml += '</tr></thead><tbody>';\n    for (let r = 0; r < rows - 1; r++) {\n      tableHtml += '<tr>';\n      for (let c = 0; c < cols; c++) tableHtml += '<td>Data</td>';\n      tableHtml += '</tr>';\n    }\n    tableHtml += '</tbody></table><p><br></p>';\n    executeCommand('insertHTML', tableHtml);\n  }, [executeCommand]);\n\n  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\n    if (e.ctrlKey || e.metaKey) {\n      if (e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); return; }\n      if (e.key === 'z' && e.shiftKey) { e.preventDefault(); redo(); return; }\n      if (e.key === 'y') { e.preventDefault(); redo(); return; }\n      if (e.key === 'b') { e.preventDefault(); executeCommand('bold'); }\n      if (e.key === 'i') { e.preventDefault(); executeCommand('italic'); }\n      if (e.key === 's') { e.preventDefault(); saveEdits(); }\n    }\n  }, [executeCommand, saveEdits, undo, redo]);\n\n  // ── Heading selection ──\n  const toggleSelection = useCallback((headingId: string) => {\n    setHeadings(prev => prev.map(h => h.id === headingId ? { ...h, selected: !h.selected } : h));\n  }, []);\n\n  const deselectAll = useCallback(() => {\n    setHeadings(prev => prev.map(h => h.selected ? { ...h, selected: false } : h));\n  }, []);\n\n  const selectByLevels = useCallback((levels: number[]) => {\n    const levelSet = new Set(levels);\n    setHeadings(prev => {\n      const targeted = prev.filter(h => levelSet.has(h.level));\n      const allSelected = targeted.length > 0 && targeted.every(h => h.selected);\n      return prev.map(h => {\n        if (levelSet.has(h.level)) return { ...h, selected: !allSelected };\n        return h;\n      });\n    });\n  }, []);\n\n  const selectHeadingAndDescendants = useCallback((headingId: string) => {\n    setHeadings(prev => {\n      const idx = prev.findIndex(h => h.id === headingId);\n      if (idx === -1) return prev;\n      const parentLevel = prev[idx].level;\n      const idsToSelect = new Set<string>([headingId]);\n      for (let i = idx + 1; i < prev.length; i++) {\n        if (prev[i].level <= parentLevel) break;\n        idsToSelect.add(prev[i].id);\n      }\n      return prev.map(h => idsToSelect.has(h.id) ? { ...h, selected: true } : h);\n    });\n  }, []);\n\n  const selectHeadingContent = useCallback((headingId: string) => {\n    if (!editorRef.current) return;\n    const el = editorRef.current.querySelector(`#${CSS.escape(headingId)}`) as HTMLElement | null;\n    if (!el) return;\n\n    // Find the end of this heading's content (next sibling heading of same or lower level, or end of editor)\n    const headingLevel = parseInt(el.tagName.substring(1));\n    let endNode: Node | null = null;\n    let sibling = el.nextSibling as Node | null;\n    while (sibling) {\n      if (sibling.nodeType === Node.ELEMENT_NODE) {\n        const tag = (sibling as HTMLElement).tagName;\n        if (/^H[1-6]$/.test(tag) && parseInt(tag.substring(1)) <= headingLevel) {\n          endNode = sibling;\n          break;\n        }\n      }\n      sibling = sibling.nextSibling;\n    }\n\n    const range = document.createRange();\n    range.setStartBefore(el);\n    if (endNode) {\n      range.setEndBefore(endNode);\n    } else {\n      range.setEndAfter(editorRef.current.lastChild || el);\n    }\n\n    const selection = window.getSelection();\n    if (selection) {\n      selection.removeAllRanges();\n      selection.addRange(range);\n    }\n  }, [editorRef]);\n\n  // ── Heading level change (promote/demote) ──\n  const changeHeadingLevel = useCallback((headingId: string, direction: 'promote' | 'demote') => {\n    if (!editorRef.current) return;\n    const el = editorRef.current.querySelector(`#${CSS.escape(headingId)}`) as HTMLElement | null;\n    if (!el || !/^H[1-6]$/.test(el.tagName)) return;\n\n    const currentLevel = parseInt(el.tagName.substring(1));\n    const newLevel = direction === 'promote' ? Math.max(1, currentLevel - 1) : Math.min(6, currentLevel + 1);\n    if (newLevel === currentLevel) return;\n\n    // Capture current state as undo point before the DOM change\n    snapshotBeforeChange();\n\n    const newTag = `H${newLevel}`;\n    const newEl = document.createElement(newTag);\n    newEl.id = el.id;\n    newEl.innerHTML = el.innerHTML;\n    el.parentNode?.replaceChild(newEl, el);\n\n    lastSnapshotRef.current = editorRef.current.innerHTML;\n    parseHeadings();\n  }, [editorRef, parseHeadings, snapshotBeforeChange]);\n\n  // ── Scroll to heading in editor ──\n  const scrollToHeading = useCallback((headingId: string) => {\n    if (!editorRef.current) return;\n    const el = editorRef.current.querySelector(`#${CSS.escape(headingId)}`) as HTMLElement | null;\n    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n  }, [editorRef]);\n\n  // ── Update the first H1 text in the live editor (used when card is renamed externally) ──\n  const updateH1 = useCallback((newTitle: string) => {\n    if (!editorRef.current) return;\n    const h1 = editorRef.current.querySelector('h1');\n    if (h1 && h1.textContent !== newTitle) {\n      suppressDirtyRef.current = true;\n      h1.textContent = newTitle;\n      lastSnapshotRef.current = editorRef.current.innerHTML;\n      // Also update initialContentRef so dirty tracking stays correct\n      initialContentRef.current = initialContentRef.current.replace(/^#\\s+.+$/m, `# ${newTitle}`);\n      parseHeadings();\n      requestAnimationFrame(() => { suppressDirtyRef.current = false; });\n    }\n  }, [editorRef, parseHeadings]);\n\n  // ── Reorder heading (with all its content & descendants) in the editor DOM ──\n  const reorderHeading = useCallback((fromIndex: number, toIndex: number) => {\n    if (!editorRef.current || fromIndex === toIndex) return;\n    if (fromIndex < 0 || fromIndex >= headings.length) return;\n    if (toIndex < 0 || toIndex >= headings.length) return;\n\n    const editor = editorRef.current;\n    const sourceHeading = headings[fromIndex];\n\n    // Find the DOM element for the source heading\n    const sourceEl = editor.querySelector(`#${CSS.escape(sourceHeading.id)}`) as HTMLElement | null;\n    if (!sourceEl) return;\n\n    // Collect all DOM nodes belonging to this heading's section:\n    // the heading element + all siblings until the next heading of same or lower level\n    const sourceLevel = sourceHeading.level;\n    const nodesToMove: Node[] = [sourceEl];\n    let sibling = sourceEl.nextSibling;\n    while (sibling) {\n      if (sibling.nodeType === Node.ELEMENT_NODE) {\n        const tag = (sibling as HTMLElement).tagName;\n        if (/^H[1-6]$/.test(tag) && parseInt(tag.substring(1)) <= sourceLevel) break;\n      }\n      nodesToMove.push(sibling);\n      sibling = sibling.nextSibling;\n    }\n\n    // Capture current state as undo point before the DOM change\n    snapshotBeforeChange();\n\n    // Determine the target heading and find its DOM element for insertion reference\n    const targetHeading = headings[toIndex];\n    const targetEl = editor.querySelector(`#${CSS.escape(targetHeading.id)}`) as HTMLElement | null;\n    if (!targetEl) return;\n\n    // Create a fragment with all nodes to move\n    const fragment = document.createDocumentFragment();\n    nodesToMove.forEach(n => fragment.appendChild(n));\n\n    // Insert before the target heading element\n    if (fromIndex < toIndex) {\n      // Moving down: insert after the target's section\n      // Find end of target's section (target heading + its content + descendants)\n      const targetLevel = targetHeading.level;\n      let insertBefore: Node | null = targetEl.nextSibling;\n      while (insertBefore) {\n        if (insertBefore.nodeType === Node.ELEMENT_NODE) {\n          const tag = (insertBefore as HTMLElement).tagName;\n          if (/^H[1-6]$/.test(tag) && parseInt(tag.substring(1)) <= targetLevel) break;\n        }\n        insertBefore = insertBefore.nextSibling;\n      }\n      if (insertBefore) {\n        editor.insertBefore(fragment, insertBefore);\n      } else {\n        editor.appendChild(fragment);\n      }\n    } else {\n      // Moving up: insert before the target heading\n      editor.insertBefore(fragment, targetEl);\n    }\n\n    lastSnapshotRef.current = editor.innerHTML;\n    parseHeadings();\n  }, [editorRef, headings, snapshotBeforeChange, parseHeadings]);\n\n  return {\n    isDirty,\n    activeFormats,\n    headings,\n    saveEdits,\n    discardEdits,\n    executeCommand,\n    insertTable,\n    handleKeyDown,\n    updateActiveFormatStates,\n    changeHeadingLevel,\n    scrollToHeading,\n    updateH1,\n    toggleSelection,\n    deselectAll,\n    selectByLevels,\n    selectHeadingContent,\n    selectHeadingAndDescendants,\n    reorderHeading,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useDocumentFindReplace.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":41,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":41,"endColumn":41,"fix":{"range":[1839,1861],"text":"{observer.disconnect();}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":53,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":53,"endColumn":25,"fix":{"range":[2200,2207],"text":"{return;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":54,"column":43,"nodeType":"Literal","messageId":"defineConstant","endLine":54,"endColumn":60},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":55,"column":11,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":55,"endColumn":18,"fix":{"range":[2274,2483],"text":"for (const mark of marks) {\n      const parent = mark.parentNode;\n      if (parent) {\n        parent.replaceChild(document.createTextNode(mark.textContent || ''), mark);\n        parent.normalize();\n      }\n    }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":66,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":66,"endColumn":40,"fix":{"range":[2649,2656],"text":"{return;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 24 to the 15 allowed.","line":78,"column":98,"nodeType":null,"messageId":"refactorFunction","endLine":78,"endColumn":100},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":80,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":80,"endColumn":37,"fix":{"range":[3252,3261],"text":"{return 0;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":86,"column":69,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":86,"endColumn":78,"fix":{"range":[3515,3524],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":97,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":97,"endColumn":32,"fix":{"range":[3863,3872],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":103,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":103,"endColumn":90,"fix":{"range":[4000,4065],"text":"{frag.appendChild(document.createTextNode(text.slice(last, idx)));}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":109,"column":34,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":109,"endColumn":80,"fix":{"range":[4352,4398],"text":"{mark.setAttribute('data-find-active', 'true');}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":109,"column":52,"nodeType":"Literal","messageId":"defineConstant","endLine":109,"endColumn":70},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":117,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":117,"endColumn":91,"fix":{"range":[4570,4630],"text":"{frag.appendChild(document.createTextNode(text.slice(last)));}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":132,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":132,"endColumn":24,"fix":{"range":[5134,5143],"text":"{return 0;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":148,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":148,"endColumn":77,"fix":{"range":[5562,5616],"text":"{requestAnimationFrame(() => scrollToMark(activeMark));}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":157,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":157,"endColumn":25,"fix":{"range":[5893,5900],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":159,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":159,"endColumn":36,"fix":{"range":[6020,6027],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 80.","line":186,"column":8,"nodeType":"Literal","messageId":"noMagic","endLine":186,"endColumn":10},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":192,"column":56,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":192,"endColumn":63,"fix":{"range":[7035,7042],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":201,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":201,"endColumn":29,"fix":{"range":[7287,7294],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":207,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":207,"endColumn":29,"fix":{"range":[7463,7470],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":221,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":221,"endColumn":36,"fix":{"range":[7866,7873],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":224,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":224,"endColumn":24,"fix":{"range":[7971,7978],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":229,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":229,"endColumn":48,"fix":{"range":[8193,8200],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":232,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":232,"endColumn":40,"fix":{"range":[8269,8276],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":248,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":248,"endColumn":75,"fix":{"range":[8870,8923],"text":"{requestAnimationFrame(() => scrollToMark(newActive));}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":253,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":253,"endColumn":36,"fix":{"range":[9098,9105],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":255,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":255,"endColumn":24,"fix":{"range":[9162,9169],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":259,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":259,"endColumn":36,"fix":{"range":[9328,9335],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":264,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":264,"endColumn":40,"fix":{"range":[9481,9490],"text":"{continue;}"}}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'clearMarks', 'editorRef', 'findActiveIndex', 'rebuild', and 'withObserverPaused'. Either include them or remove the dependency array.","line":189,"column":6,"nodeType":"ArrayExpression","endLine":189,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [findQuery, findMatchCase, showFind, editorRef, withObserverPaused, clearMarks, rebuild, findActiveIndex]","fix":{"range":[6920,6956],"text":"[findQuery, findMatchCase, showFind, editorRef, withObserverPaused, clearMarks, rebuild, findActiveIndex]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'editorRef', 'findQuery', 'showFind', and 'swapActive'. Either include them or remove the dependency array.","line":195,"column":6,"nodeType":"ArrayExpression","endLine":195,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [editorRef, findActiveIndex, findQuery, showFind, swapActive]","fix":{"range":[7141,7158],"text":"[editorRef, findActiveIndex, findQuery, showFind, swapActive]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":30,"fixableErrorCount":0,"fixableWarningCount":26,"source":"\nimport { useState, useCallback, useRef, useEffect } from 'react';\n\n// Inline styles — Tailwind CDN can't do opacity variants on custom colors\nconst MARK_ACTIVE = 'background-color:rgba(42,159,212,0.45);border-radius:2px;padding:1px 0;color:inherit;';\nconst MARK_INACTIVE = 'background-color:rgba(250,204,21,0.35);border-radius:2px;padding:1px 0;color:inherit;';\n\n/**\n * Standalone find/replace hook that accepts refs as parameters\n * instead of reading them from AppContext.\n * (Identical logic to useFindReplace, decoupled from context.)\n */\nexport function useDocumentFindReplace(\n  editorRef: React.RefObject<HTMLDivElement | null>,\n  scrollContainerRef: React.RefObject<HTMLDivElement | null>,\n  editorObserverRef: React.MutableRefObject<MutationObserver | null>,\n) {\n  // ── State ──\n  const [showFind, setShowFind] = useState(false);\n  const [findQuery, setFindQuery] = useState('');\n  const [replaceQuery, setReplaceQuery] = useState('');\n  const [findMatchCount, setFindMatchCount] = useState(0);\n  const [findActiveIndex, setFindActiveIndex] = useState(0);\n  const [findMatchCase, setFindMatchCase] = useState(false);\n  const findInputRef = useRef<HTMLInputElement>(null);\n\n  // ── Refs for latest values (avoids stale closures in imperative calls) ──\n  const findQueryRef = useRef(findQuery);\n  const findMatchCaseRef = useRef(findMatchCase);\n  const findActiveIndexRef = useRef(findActiveIndex);\n  const findMatchCountRef = useRef(findMatchCount);\n  findQueryRef.current = findQuery;\n  findMatchCaseRef.current = findMatchCase;\n  findActiveIndexRef.current = findActiveIndex;\n  findMatchCountRef.current = findMatchCount;\n\n  // ── Observer pause/resume ──\n  const withObserverPaused = useCallback(<T,>(fn: () => T): T => {\n    const observer = editorObserverRef.current;\n    const editor = editorRef.current;\n    if (observer) observer.disconnect();\n    const result = fn();\n    if (observer && editor) {\n      observer.observe(editor, { childList: true, subtree: true, characterData: true });\n    }\n    return result;\n  }, [editorObserverRef, editorRef]);\n\n  // ── Low-level DOM helpers ──\n\n  const clearMarks = useCallback(() => {\n    const editor = editorRef.current;\n    if (!editor) return;\n    const marks = editor.querySelectorAll('mark[data-find]');\n    marks.forEach(mark => {\n      const parent = mark.parentNode;\n      if (parent) {\n        parent.replaceChild(document.createTextNode(mark.textContent || ''), mark);\n        parent.normalize();\n      }\n    });\n  }, [editorRef]);\n\n  const scrollToMark = useCallback((mark: HTMLElement) => {\n    const scrollParent = scrollContainerRef.current;\n    if (!mark || !scrollParent) return;\n    const containerRect = scrollParent.getBoundingClientRect();\n    const markRect = mark.getBoundingClientRect();\n    if (markRect.top < containerRect.top || markRect.bottom > containerRect.bottom) {\n      scrollParent.scrollTo({\n        top: markRect.top - containerRect.top + scrollParent.scrollTop - 100,\n        behavior: 'smooth',\n      });\n    }\n  }, [scrollContainerRef]);\n\n  // ── Core: inject marks into editor DOM ──\n  const injectMarks = useCallback((query: string, activeIdx: number, matchCase: boolean): number => {\n    const editor = editorRef.current;\n    if (!editor || !query) return 0;\n\n    const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null);\n    const textNodes: Text[] = [];\n    let node: Node | null;\n    while ((node = walker.nextNode())) {\n      if ((node as Text).parentElement?.closest('[data-find-bar]')) continue;\n      textNodes.push(node as Text);\n    }\n\n    const cmpQuery = matchCase ? query : query.toLowerCase();\n    let count = 0;\n\n    for (const textNode of textNodes) {\n      const text = textNode.textContent || '';\n      const cmpText = matchCase ? text : text.toLowerCase();\n      let idx = cmpText.indexOf(cmpQuery);\n      if (idx === -1) continue;\n\n      const frag = document.createDocumentFragment();\n      let last = 0;\n\n      while (idx !== -1) {\n        if (idx > last) frag.appendChild(document.createTextNode(text.slice(last, idx)));\n\n        const mark = document.createElement('mark');\n        mark.setAttribute('data-find', 'true');\n        mark.textContent = text.slice(idx, idx + query.length);\n        mark.setAttribute('style', count === activeIdx ? MARK_ACTIVE : MARK_INACTIVE);\n        if (count === activeIdx) mark.setAttribute('data-find-active', 'true');\n        frag.appendChild(mark);\n\n        count++;\n        last = idx + query.length;\n        idx = cmpText.indexOf(cmpQuery, last);\n      }\n\n      if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));\n      textNode.parentNode?.replaceChild(frag, textNode);\n    }\n\n    return count;\n  }, [editorRef]);\n\n  // ── Rebuild: clear + inject + scroll (all inside observer pause) ──\n  const rebuild = useCallback((query?: string, activeIdx?: number, matchCase?: boolean) => {\n    const q = query ?? findQueryRef.current;\n    const idx = activeIdx ?? findActiveIndexRef.current;\n    const mc = matchCase ?? findMatchCaseRef.current;\n\n    const count = withObserverPaused(() => {\n      clearMarks();\n      if (!q) return 0;\n      return injectMarks(q, idx, mc);\n    });\n\n    setFindMatchCount(count);\n    if (idx >= count && count > 0) {\n      setFindActiveIndex(0);\n      withObserverPaused(() => {\n        clearMarks();\n        injectMarks(q, 0, mc);\n      });\n    }\n\n    if (count > 0) {\n      const editor = editorRef.current;\n      const activeMark = editor?.querySelector('mark[data-find-active]') as HTMLElement;\n      if (activeMark) requestAnimationFrame(() => scrollToMark(activeMark));\n    }\n\n    return count;\n  }, [withObserverPaused, clearMarks, injectMarks, scrollToMark, editorRef]);\n\n  // ── Lightweight: just swap styles on existing marks ──\n  const swapActive = useCallback((activeIdx: number) => {\n    const editor = editorRef.current;\n    if (!editor) return;\n    const marks = Array.from(editor.querySelectorAll('mark[data-find]')) as HTMLElement[];\n    if (marks.length === 0) return;\n\n    for (let i = 0; i < marks.length; i++) {\n      if (i === activeIdx) {\n        marks[i].setAttribute('style', MARK_ACTIVE);\n        marks[i].setAttribute('data-find-active', 'true');\n      } else {\n        marks[i].setAttribute('style', MARK_INACTIVE);\n        marks[i].removeAttribute('data-find-active');\n      }\n    }\n\n    if (activeIdx >= 0 && activeIdx < marks.length) {\n      requestAnimationFrame(() => scrollToMark(marks[activeIdx]));\n    }\n  }, [editorRef, scrollToMark]);\n\n  // ── Effects ──\n\n  useEffect(() => {\n    if (!editorRef.current || !showFind || !findQuery) {\n      withObserverPaused(() => clearMarks());\n      setFindMatchCount(0);\n      return;\n    }\n    const timeout = setTimeout(() => {\n      rebuild(findQuery, findActiveIndex, findMatchCase);\n    }, 80);\n    return () => clearTimeout(timeout);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [findQuery, findMatchCase, showFind]);\n\n  useEffect(() => {\n    if (!editorRef.current || !showFind || !findQuery) return;\n    swapActive(findActiveIndex);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [findActiveIndex]);\n\n  // ── Actions ──\n\n  const findNext = useCallback(() => {\n    const count = findMatchCountRef.current;\n    if (count === 0) return;\n    setFindActiveIndex(prev => (prev + 1) % count);\n  }, []);\n\n  const findPrev = useCallback(() => {\n    const count = findMatchCountRef.current;\n    if (count === 0) return;\n    setFindActiveIndex(prev => (prev - 1 + count) % count);\n  }, []);\n\n  const closeFindBar = useCallback(() => {\n    withObserverPaused(() => clearMarks());\n    setShowFind(false);\n    setFindQuery('');\n    setReplaceQuery('');\n    setFindActiveIndex(0);\n    setFindMatchCount(0);\n  }, [withObserverPaused, clearMarks]);\n\n  const handleReplace = useCallback(() => {\n    if (!editorRef.current) return;\n    const query = findQueryRef.current;\n    const mc = findMatchCaseRef.current;\n    if (!query) return;\n\n    const editor = editorRef.current;\n    const marks = Array.from(editor.querySelectorAll('mark[data-find]')) as HTMLElement[];\n    const idx = findActiveIndexRef.current;\n    if (idx < 0 || idx >= marks.length) return;\n\n    const activeMark = marks[idx];\n    if (!activeMark.parentNode) return;\n\n    const newCount = withObserverPaused(() => {\n      activeMark.parentNode!.replaceChild(document.createTextNode(replaceQuery), activeMark);\n      activeMark.parentNode?.normalize();\n      clearMarks();\n      const nextIdx = Math.min(idx, Math.max(0, marks.length - 2));\n      return injectMarks(query, nextIdx, mc);\n    });\n\n    setFindMatchCount(newCount);\n    const newIdx = newCount > 0 ? Math.min(idx, newCount - 1) : 0;\n    setFindActiveIndex(newIdx);\n\n    if (newCount > 0) {\n      const newActive = editor.querySelector('mark[data-find-active]') as HTMLElement;\n      if (newActive) requestAnimationFrame(() => scrollToMark(newActive));\n    }\n  }, [editorRef, replaceQuery, withObserverPaused, clearMarks, injectMarks, scrollToMark]);\n\n  const handleReplaceAll = useCallback(() => {\n    if (!editorRef.current) return;\n    const query = findQueryRef.current;\n    if (!query) return;\n\n    const editor = editorRef.current;\n    const marks = Array.from(editor.querySelectorAll('mark[data-find]')) as HTMLElement[];\n    if (marks.length === 0) return;\n\n    withObserverPaused(() => {\n      for (let i = marks.length - 1; i >= 0; i--) {\n        const mark = marks[i];\n        if (!mark.parentNode) continue;\n        mark.parentNode.replaceChild(document.createTextNode(replaceQuery), mark);\n      }\n      editor.normalize();\n    });\n\n    setFindMatchCount(0);\n    setFindActiveIndex(0);\n  }, [editorRef, replaceQuery, withObserverPaused]);\n\n  const clearFindHighlights = useCallback(() => {\n    withObserverPaused(() => clearMarks());\n  }, [withObserverPaused, clearMarks]);\n\n  return {\n    showFind, setShowFind,\n    findQuery, setFindQuery,\n    replaceQuery, setReplaceQuery,\n    findMatchCount,\n    findActiveIndex, setFindActiveIndex,\n    findMatchCase, setFindMatchCase,\n    findInputRef,\n    findNext, findPrev,\n    closeFindBar,\n    handleReplace, handleReplaceAll,\n    clearFindHighlights,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useInsightsLab.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ClaudeMessage' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ClaudeMessage"},"fix":{"range":[221,236],"text":""},"desc":"Remove unused variable \"ClaudeMessage\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ClaudeUsage' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ClaudeUsage"},"fix":{"range":[236,249],"text":""},"desc":"Remove unused variable \"ClaudeUsage\"."}]},{"ruleId":"import/order","severity":1,"message":"`./useTokenUsage` import should occur after import of `../utils/pdfBookmarks`","line":5,"column":1,"nodeType":"ImportDeclaration","endLine":5,"endColumn":49,"fix":{"range":[272,724],"text":"import { buildInsightsSystemPrompt, buildCardContentInstruction } from '../utils/prompts/insightsLab';\nimport { buildCoverContentInstruction } from '../utils/prompts/coverGeneration';\nimport { computeDocumentHash } from '../utils/documentHash';\nimport { estimateTokens, computeMessageBudget, pruneMessages } from '../utils/tokenEstimation';\nimport { buildTocSystemPrompt } from '../utils/pdfBookmarks';\nimport { RecordUsageFn } from './useTokenUsage';\n"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'estimateTokens' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"estimateTokens"},"fix":{"range":[575,590],"text":""},"desc":"Remove unused variable \"estimateTokens\"."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":35,"column":64,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":35,"endColumn":74,"fix":{"range":[1798,1808],"text":"{return [];}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 42 to the 15 allowed.","line":61,"column":5,"nodeType":null,"messageId":"refactorFunction","endLine":61,"endColumn":7},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":62,"column":80,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":62,"endColumn":87,"fix":{"range":[2880,2887],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":71,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":71,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":71,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":71,"endColumn":49},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":110,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":110,"endColumn":58,"fix":{"range":[4810,4826],"text":"{maxTokens = 150;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 150.","line":110,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":110,"endColumn":57},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":111,"column":50,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":111,"endColumn":66,"fix":{"range":[4876,4892],"text":"{maxTokens = 350;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 350.","line":111,"column":62,"nodeType":"Literal","messageId":"noMagic","endLine":111,"endColumn":65},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":112,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":112,"endColumn":63,"fix":{"range":[4939,4955],"text":"{maxTokens = 300;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 300.","line":112,"column":59,"nodeType":"Literal","messageId":"noMagic","endLine":112,"endColumn":62},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":113,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":113,"endColumn":62,"fix":{"range":[5001,5017],"text":"{maxTokens = 600;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":113,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":113,"endColumn":61},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":114,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":114,"endColumn":31,"fix":{"range":[5031,5048],"text":"{maxTokens = 1200;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1200.","line":114,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":114,"endColumn":30},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":121,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":121,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":121,"endColumn":53},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":134,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":134,"endColumn":22,"suggestions":[{"fix":{"range":[5789,5903],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":141,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":141,"endColumn":78,"fix":{"range":[6190,6242],"text":"{systemBlocks.push({ text: tocPrompt, cache: true });}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":159,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7066,7069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7066,7069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":164,"column":112,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":115,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7347,7350],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7347,7350],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":187,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":187,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":187,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":187,"endColumn":51},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":203,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8614,8617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8614,8617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":205,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":205,"endColumn":45,"fix":{"range":[8700,8707],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":20,"suggestions":[{"fix":{"range":[8715,8757],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":221,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":221,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":221,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":221,"endColumn":51},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'recordUsage' and 'setNuggets'. Either include them or remove the dependency array. If 'recordUsage' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":232,"column":6,"nodeType":"ArrayExpression","endLine":232,"endColumn":67,"suggestions":[{"desc":"Update the dependencies array to be: [selectedNugget, resolveDocumentContext, appendNuggetMessage, recordUsage, setNuggets]","fix":{"range":[9748,9809],"text":"[selectedNugget, resolveDocumentContext, appendNuggetMessage, recordUsage, setNuggets]"}}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":248,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":248,"endColumn":35,"fix":{"range":[10222,10229],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":250,"column":63,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":250,"endColumn":72,"fix":{"range":[10331,10340],"text":"{return n;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":259,"column":64,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":259,"endColumn":74,"fix":{"range":[10735,10745],"text":"{return [];}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":309,"column":64,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":309,"endColumn":71,"fix":{"range":[13095,13102],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":320,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":320,"endColumn":36},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":320,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":320,"endColumn":49}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":36,"fixableErrorCount":0,"fixableWarningCount":14,"source":"import { useState, useCallback, useRef, useMemo } from 'react';\nimport { useAppContext } from '../context/AppContext';\nimport { ChatMessage, DetailLevel, DocChangeEvent, isCoverLevel } from '../types';\nimport { callClaude, ClaudeMessage, ClaudeUsage } from '../utils/ai';\nimport { RecordUsageFn } from './useTokenUsage';\nimport { buildInsightsSystemPrompt, buildCardContentInstruction } from '../utils/prompts/insightsLab';\nimport { buildCoverContentInstruction } from '../utils/prompts/coverGeneration';\nimport { computeDocumentHash } from '../utils/documentHash';\nimport { estimateTokens, computeMessageBudget, pruneMessages } from '../utils/tokenEstimation';\nimport { buildTocSystemPrompt } from '../utils/pdfBookmarks';\n\n/**\n * Chat state management + Claude API integration for the Insights Lab workflow.\n * Handles regular chat messages and structured card content generation.\n *\n * Uses prompt caching to avoid re-processing document context on every message:\n * - System blocks: INSIGHTS_SYSTEM_PROMPT + document context (cached)\n * - Messages: proper multi-turn conversation (incrementally cached)\n */\nexport function useInsightsLab(recordUsage?: RecordUsageFn) {\n  const {\n    selectedNugget,\n    appendNuggetMessage,\n    setNuggets,\n    selectedNuggetId,\n  } = useAppContext();\n  const [isLoading, setIsLoading] = useState(false);\n  const abortRef = useRef<AbortController | null>(null);\n\n  /**\n   * Resolve the document contents for the active insights nugget.\n   * Documents are owned directly by the nugget (no shared library lookup).\n   */\n  const resolveDocumentContext = useCallback((): Array<{ name: string; content: string; fileId?: string; sourceType?: string; bookmarks?: import('../types').BookmarkNode[] }> => {\n    if (!selectedNugget || selectedNugget.type !== 'insights') return [];\n    return selectedNugget.documents\n      .filter(doc => (doc.content || doc.fileId) && doc.enabled !== false)\n      .map(doc => ({ name: doc.name, content: doc.content || '', fileId: doc.fileId, sourceType: doc.sourceType, bookmarks: doc.bookmarks }));\n  }, [selectedNugget]);\n\n  /**\n   * Send a message to Claude. Can be a regular chat message or a card content request.\n   *\n   * Prompt structure with caching:\n   *   System: [\n   *     { text: INSIGHTS_SYSTEM_PROMPT },\n   *     { text: \"Documents:\\n...\", cache: true }     ← CACHED (stable within conversation)\n   *   ]\n   *   Messages: [\n   *     { role: \"user\", content: \"msg 1\" },\n   *     { role: \"assistant\", content: \"resp 1\" },\n   *     ...\n   *     { role: \"user\", content: \"new msg\" }          ← cache breakpoint (auto-added by callClaude)\n   *   ]\n   */\n  const sendMessage = useCallback(async (\n    text: string,\n    isCardRequest: boolean = false,\n    detailLevel?: DetailLevel,\n    messagesOverride?: ChatMessage[]\n  ) => {\n    if (!selectedNugget || selectedNugget.type !== 'insights' || !text.trim()) return;\n\n    const resolvedDocs = resolveDocumentContext();\n    // Use explicit override when caller needs to bypass stale closure\n    // (e.g. handleDocChangeContinue injects system msg before React re-renders)\n    const history = messagesOverride ?? (selectedNugget.messages ?? []);\n\n    // Create user message\n    const userMessage: ChatMessage = {\n      id: Math.random().toString(36).substr(2, 9),\n      role: 'user',\n      content: text.trim(),\n      timestamp: Date.now(),\n    };\n\n    // Add user message to nugget immediately\n    appendNuggetMessage(userMessage);\n\n    setIsLoading(true);\n    const controller = new AbortController();\n    abortRef.current = controller;\n\n    try {\n      // ── Split documents: docs with fileId go via Files API only; the rest go inline ──\n      const fileApiDocs = resolvedDocs.filter(d => d.fileId);\n      const inlineDocs = resolvedDocs.filter(d => !d.fileId && d.content);\n\n      // Build system blocks — only inline docs (no fileId) go here to avoid double-sending\n      const systemBlocks: Array<{ text: string; cache: boolean }> = [\n        { text: buildInsightsSystemPrompt(selectedNugget?.subject), cache: false },\n      ];\n      if (inlineDocs.length > 0) {\n        const docContext = inlineDocs.map(d =>\n          `--- Document: ${d.name} ---\\n${d.content}\\n--- End Document ---`\n        ).join('\\n\\n');\n        systemBlocks.push({ text: `Current documents:\\n\\n${docContext}`, cache: true });\n      }\n      if (isCardRequest && detailLevel) {\n        if (isCoverLevel(detailLevel)) {\n          systemBlocks.push({ text: buildCoverContentInstruction(detailLevel), cache: false });\n        } else {\n          systemBlocks.push({ text: buildCardContentInstruction(detailLevel), cache: false });\n        }\n      }\n\n      // Token budget scaled to detail level to prevent over-generation\n      let maxTokens = 8192;\n      if (isCardRequest) {\n        if (detailLevel === 'TitleCard') maxTokens = 150;\n        else if (detailLevel === 'TakeawayCard') maxTokens = 350;\n        else if (detailLevel === 'Executive') maxTokens = 300;\n        else if (detailLevel === 'Standard') maxTokens = 600;\n        else maxTokens = 1200; // Detailed\n      }\n\n      // ── Pre-flight budget check ──\n      const messageBudget = computeMessageBudget(systemBlocks, maxTokens);\n      if (messageBudget <= 0) {\n        const errorMessage: ChatMessage = {\n          id: Math.random().toString(36).substr(2, 9),\n          role: 'assistant',\n          content: 'Your documents are too large to fit in the context window. Try disabling some documents or removing large ones to free up space.',\n          timestamp: Date.now(),\n        };\n        appendNuggetMessage(errorMessage);\n        return;\n      }\n\n      // ── Build multi-turn messages with pruning ──\n      const { claudeMessages, dropped } = pruneMessages(history, text.trim(), messageBudget);\n\n      if (dropped > 0) {\n        console.debug(`[InsightsLab] Pruned ${dropped} messages to fit context window (budget: ${messageBudget} tokens)`);\n      }\n\n      // ── Inject bookmark-based TOC into system prompt for native PDFs ──\n      for (const d of fileApiDocs) {\n        if (d.sourceType === 'native-pdf' && d.bookmarks?.length) {\n          const tocPrompt = buildTocSystemPrompt(d.bookmarks, d.name);\n          if (tocPrompt) systemBlocks.push({ text: tocPrompt, cache: true });\n        }\n      }\n\n      // ── Prepend Files API document blocks to the first user message ──\n      if (fileApiDocs.length > 0) {\n        const docBlocks: Array<{ type: string; source: { type: string; file_id: string }; title: string }> = fileApiDocs.map(d => ({\n          type: 'document',\n          source: { type: 'file', file_id: d.fileId! },\n          title: d.name,\n        }));\n\n        // Inject doc blocks into the first user message\n        if (claudeMessages.length > 0 && claudeMessages[0].role === 'user') {\n          const firstMsg = claudeMessages[0];\n          const existingBlocks = typeof firstMsg.content === 'string'\n            ? [{ type: 'text', text: firstMsg.content }]\n            : [...firstMsg.content];\n          claudeMessages[0] = { role: 'user', content: [...docBlocks, ...existingBlocks] as any };\n        } else {\n          // Edge case: no user message first — prepend a document reference message\n          claudeMessages.unshift({\n            role: 'user',\n            content: [...docBlocks, { type: 'text', text: 'Please analyze the documents provided above.' }] as any,\n          });\n        }\n      }\n\n      const { text: responseText, usage: claudeUsage } = await callClaude('', {\n        systemBlocks,\n        messages: claudeMessages,\n        maxTokens,\n        signal: controller.signal,\n      });\n\n      recordUsage?.({\n        provider: 'claude',\n        model: 'claude-sonnet-4-6',\n        inputTokens: claudeUsage.input_tokens,\n        outputTokens: claudeUsage.output_tokens,\n        cacheReadTokens: claudeUsage.cache_read_input_tokens,\n        cacheWriteTokens: claudeUsage.cache_creation_input_tokens,\n      });\n\n      // Create assistant message\n      const assistantMessage: ChatMessage = {\n        id: Math.random().toString(36).substr(2, 9),\n        role: 'assistant',\n        content: responseText,\n        timestamp: Date.now(),\n        isCardContent: isCardRequest,\n        detailLevel: isCardRequest ? detailLevel : undefined,\n      };\n\n      // Add assistant message to nugget\n      appendNuggetMessage(assistantMessage);\n\n      // Update lastDocHash so we know the state of docs at this point\n      const currentHash = computeDocumentHash(selectedNugget.documents);\n      setNuggets(prev => prev.map(n =>\n        n.id === selectedNugget.id ? { ...n, lastDocHash: currentHash } : n\n      ));\n    } catch (err: any) {\n      // Silently ignore aborted requests\n      if (err.name === 'AbortError') return;\n\n      console.error('Insights lab error:', err);\n\n      // Detect token overflow for user-friendly message\n      const isOverflow = err.message?.includes('prompt is too long') ||\n        (err.message?.includes('too long') && err.message?.includes('token'));\n\n      const errorContent = isOverflow\n        ? 'The conversation and documents together exceed the maximum context size. Try one of the following:\\n' +\n          '- **Clear the chat** to start a fresh conversation\\n' +\n          '- **Disable** some documents in the document list\\n' +\n          '- **Remove** large documents that are not needed for this question'\n        : `Error: ${err.message || 'Failed to get response from Claude. Please try again.'}`;\n\n      const errorMessage: ChatMessage = {\n        id: Math.random().toString(36).substr(2, 9),\n        role: 'assistant',\n        content: errorContent,\n        timestamp: Date.now(),\n      };\n\n      appendNuggetMessage(errorMessage);\n    } finally {\n      abortRef.current = null;\n      setIsLoading(false);\n    }\n  }, [selectedNugget, resolveDocumentContext, appendNuggetMessage]);\n\n  /**\n   * Abort the in-flight Claude request.\n   */\n  const stopResponse = useCallback(() => {\n    abortRef.current?.abort();\n    abortRef.current = null;\n    setIsLoading(false);\n  }, []);\n\n  /**\n   * Clear all messages from the active insights nugget.\n   * Also advances the doc change sync index so the fresh chat starts clean.\n   */\n  const clearMessages = useCallback(() => {\n    if (!selectedNuggetId) return;\n    setNuggets(prev => prev.map(n => {\n      if (n.id !== selectedNuggetId || n.type !== 'insights') return n;\n      return { ...n, messages: [], lastDocChangeSyncIndex: (n.docChangeLog || []).length, lastModifiedAt: Date.now() };\n    }));\n  }, [selectedNuggetId, setNuggets]);\n\n  // ── Document change detection ──\n\n  /** Unseen document changes since last sync to chat agent */\n  const pendingDocChanges: DocChangeEvent[] = useMemo(() => {\n    if (!selectedNugget || selectedNugget.type !== 'insights') return [];\n    const log = selectedNugget.docChangeLog || [];\n    const syncIdx = selectedNugget.lastDocChangeSyncIndex ?? 0;\n    return log.slice(syncIdx);\n  }, [selectedNugget]);\n\n  /** Whether the chat has any messages (i.e. agent was already informed of some document state) */\n  const hasConversation = (selectedNugget?.messages?.length ?? 0) > 0;\n\n  /**\n   * Build a human-readable summary of document changes for the system message.\n   */\n  const buildChangeSummary = useCallback((changes: DocChangeEvent[]): string => {\n    // Group events by document (using docId), tracking latest name per doc\n    const docMap = new Map<string, { name: string; events: string[] }>();\n    const docOrder: string[] = [];\n    for (const e of changes) {\n      let entry = docMap.get(e.docId);\n      if (!entry) {\n        entry = { name: e.docName, events: [] };\n        docMap.set(e.docId, entry);\n        docOrder.push(e.docId);\n      }\n      switch (e.type) {\n        case 'added':    entry.events.push('Added'); break;\n        case 'removed':  entry.events.push('Removed'); break;\n        case 'renamed':  entry.events.push(`Renamed from \"${e.oldName}\"`); entry.name = e.docName; break;\n        case 'enabled':  entry.events.push('Enabled (included in context)'); break;\n        case 'disabled': entry.events.push('Disabled (excluded from context)'); break;\n        case 'updated':      entry.events.push('Content updated'); break;\n        case 'toc_updated': entry.events.push('Table of Contents updated'); break;\n        default:             entry.events.push('Changed'); break;\n      }\n    }\n    const sections = docOrder.map(id => {\n      const { name, events } = docMap.get(id)!;\n      return `**${name}**\\n${events.map(ev => `  - ${ev}`).join('\\n')}`;\n    });\n    return `[Document Update] The following changes were made to the document set since your last update:\\n\\n${sections.join('\\n\\n')}\\n\\nThe system context now reflects the current document set. Base all subsequent answers on the updated documents.`;\n  }, []);\n\n  /**\n   * Continue with pending changes: inject a system message summarizing changes,\n   * then send the user's message.\n   */\n  const handleDocChangeContinue = useCallback(async (\n    text: string,\n    isCardRequest: boolean = false,\n    detailLevel?: DetailLevel,\n  ) => {\n    if (!selectedNugget || selectedNugget.type !== 'insights') return;\n\n    const changes = pendingDocChanges;\n    if (changes.length === 0) {\n      // No changes — just send normally\n      await sendMessage(text, isCardRequest, detailLevel);\n      return;\n    }\n\n    // Inject a system message into the nugget's message history\n    const systemMsg: ChatMessage = {\n      id: Math.random().toString(36).substr(2, 9),\n      role: 'system',\n      content: buildChangeSummary(changes),\n      timestamp: Date.now(),\n    };\n\n    // Add system message to nugget + advance sync index\n    appendNuggetMessage(systemMsg);\n\n    // Advance the sync index\n    const newSyncIdx = (selectedNugget.docChangeLog || []).length;\n    setNuggets(prev => prev.map(n =>\n      n.id === selectedNugget.id\n        ? { ...n, lastDocChangeSyncIndex: newSyncIdx }\n        : n\n    ));\n\n    // Build the updated messages array including the system message\n    // (because React state won't have updated yet for the sendMessage closure)\n    const updatedMessages = [...(selectedNugget.messages || []), systemMsg];\n\n    // Now send the user message with the updated history\n    await sendMessage(text, isCardRequest, detailLevel, updatedMessages);\n  }, [selectedNugget, pendingDocChanges, sendMessage, buildChangeSummary, appendNuggetMessage, setNuggets]);\n\n  /**\n   * Start fresh: clear all messages and advance sync index, ready for new conversation.\n   */\n  const handleDocChangeStartFresh = useCallback(() => {\n    clearMessages();\n  }, [clearMessages]);\n\n  return {\n    messages: selectedNugget?.messages || [],\n    isLoading,\n    sendMessage,\n    stopResponse,\n    clearMessages,\n    pendingDocChanges,\n    hasConversation,\n    handleDocChangeContinue,\n    handleDocChangeStartFresh,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\usePersistence.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Card' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Card"},"fix":{"range":[66,71],"text":""},"desc":"Remove unused variable \"Card\"."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":50,"column":90,"nodeType":"Literal","messageId":"noMagic","endLine":50,"endColumn":93},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":62,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":62,"endColumn":62,"fix":{"range":[2084,2091],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":63,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":63,"endColumn":68,"fix":{"range":[2123,2159],"text":"{clearTimeout(appStateTimer.current);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":66,"column":23,"nodeType":"MemberExpression","messageId":"unexpected","endLine":66,"endColumn":35},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":68,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":68,"endColumn":83,"fix":{"range":[2471,2507],"text":"{clearTimeout(appStateTimer.current);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":107,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":107,"endColumn":62,"fix":{"range":[3752,3759],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":108,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":108,"endColumn":68,"fix":{"range":[3791,3827],"text":"{clearTimeout(insightsTimer.current);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":110,"column":35,"nodeType":"MemberExpression","messageId":"unexpected","endLine":110,"endColumn":47},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":112,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":112,"endColumn":83,"fix":{"range":[4043,4079],"text":"{clearTimeout(insightsTimer.current);}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":119,"column":47,"nodeType":null,"messageId":"refactorFunction","endLine":119,"endColumn":49},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":128,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":128,"endColumn":55,"fix":{"range":[4729,4738],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":187,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":187,"endColumn":62,"fix":{"range":[7041,7048],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":188,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":188,"endColumn":66,"fix":{"range":[7079,7114],"text":"{clearTimeout(nuggetsTimer.current);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":192,"column":26,"nodeType":"MemberExpression","messageId":"unexpected","endLine":192,"endColumn":37},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":193,"column":23,"nodeType":"MemberExpression","messageId":"unexpected","endLine":193,"endColumn":35},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":195,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":195,"endColumn":81,"fix":{"range":[7486,7521],"text":"{clearTimeout(nuggetsTimer.current);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":217,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":217,"endColumn":62,"fix":{"range":[8212,8219],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":218,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":218,"endColumn":68,"fix":{"range":[8251,8287],"text":"{clearTimeout(projectsTimer.current);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":220,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":220,"endColumn":18,"suggestions":[{"fix":{"range":[8341,8424],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":222,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":222,"endColumn":32},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":223,"column":23,"nodeType":"MemberExpression","messageId":"unexpected","endLine":223,"endColumn":35},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":225,"column":47,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":225,"endColumn":83,"fix":{"range":[8683,8719],"text":"{clearTimeout(projectsTimer.current);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":230,"column":55,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":230,"endColumn":62,"fix":{"range":[8872,8879],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":231,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":231,"endColumn":76,"fix":{"range":[8915,8955],"text":"{clearTimeout(customStylesTimer.current);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":234,"column":21,"nodeType":"MemberExpression","messageId":"unexpected","endLine":234,"endColumn":32},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":235,"column":23,"nodeType":"MemberExpression","messageId":"unexpected","endLine":235,"endColumn":35},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":237,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":237,"endColumn":91,"fix":{"range":[9350,9390],"text":"{clearTimeout(customStylesTimer.current);}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":27,"fixableErrorCount":0,"fixableWarningCount":16,"source":"\nimport { useEffect, useRef, useCallback } from 'react';\nimport { Card, Nugget, Project, InsightsSession, CustomStyle } from '../types';\nimport { StorageBackend, StoredImage } from '../utils/storage/StorageBackend';\nimport {\n  serializeCard,\n  serializeNugget,\n  serializeNuggetDocument,\n  serializeProject,\n  extractImages,\n  serializeInsightsSession,\n} from '../utils/storage/serialize';\n\nconst APP_STATE_DEBOUNCE_MS = 300;\nconst DATA_DEBOUNCE_MS = 1500;\n\ninterface PersistenceOptions {\n  storage: StorageBackend;\n  activeCardId: string | null;\n  insightsSession: InsightsSession | null;\n  nuggets: Nugget[];\n  projects: Project[];\n  selectedNuggetId: string | null;\n  selectedDocumentId: string | null;\n  selectedProjectId: string | null;\n  customStyles: CustomStyle[];\n}\n\nexport function usePersistence({\n  storage,\n  activeCardId,\n  insightsSession,\n  nuggets,\n  projects,\n  selectedNuggetId,\n  selectedDocumentId,\n  selectedProjectId,\n  customStyles,\n}: PersistenceOptions): void {\n  const appStateTimer = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const insightsTimer = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const nuggetsTimer = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const projectsTimer = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const customStylesTimer = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  // Track whether initial hydration is done to avoid saving the hydrated state right back\n  const hydrationDone = useRef(false);\n  useEffect(() => {\n    // Skip the first render (which is the hydrated state)\n    const timer = setTimeout(() => { hydrationDone.current = true; }, DATA_DEBOUNCE_MS + 500);\n    return () => clearTimeout(timer);\n  }, []);\n\n  // Stable reference to latest values for save functions\n  const latestRef = useRef({ insightsSession, nuggets, projects, customStyles });\n  useEffect(() => {\n    latestRef.current = { insightsSession, nuggets, projects, customStyles };\n  });\n\n  // ── App state save (lightweight) ──\n  useEffect(() => {\n    if (!storage.isReady() || !hydrationDone.current) return;\n    if (appStateTimer.current) clearTimeout(appStateTimer.current);\n    appStateTimer.current = setTimeout(() => {\n      storage.saveAppState({ selectedNuggetId, selectedDocumentId, selectedProjectId, activeCardId })\n        .catch(err => console.warn('[Persistence] Failed to save app state:', err));\n    }, APP_STATE_DEBOUNCE_MS);\n    return () => { if (appStateTimer.current) clearTimeout(appStateTimer.current); };\n  }, [selectedNuggetId, selectedDocumentId, selectedProjectId, activeCardId, storage]);\n\n  // ── Insights session save ──\n  const saveInsights = useCallback(async () => {\n    const { insightsSession: session } = latestRef.current;\n\n    if (!session) {\n      await storage.deleteInsightsSession();\n      await storage.deleteInsightsHeadings();\n      await storage.deleteInsightsImages();\n      return;\n    }\n\n    const { session: storedSession, headings, images } = serializeInsightsSession(session);\n    await storage.saveInsightsSession(storedSession);\n\n    // Save documents\n    const storedDocs = await storage.loadInsightsDocs();\n    const currentDocIds = new Set(session.documents.map(d => d.id));\n    for (const sd of storedDocs) {\n      if (!currentDocIds.has(sd.id)) {\n        await storage.deleteInsightsDoc(sd.id);\n      }\n    }\n    for (const doc of session.documents) {\n      await storage.saveInsightsDoc(doc);\n    }\n\n    // Save headings (storage layer still uses \"headings\" naming)\n    await storage.saveInsightsHeadings(headings);\n\n    // Save images\n    for (const img of images) {\n      await storage.saveInsightsImage(img);\n    }\n  }, [storage]);\n\n  useEffect(() => {\n    if (!storage.isReady() || !hydrationDone.current) return;\n    if (insightsTimer.current) clearTimeout(insightsTimer.current);\n    insightsTimer.current = setTimeout(() => {\n      saveInsights().catch(err => console.warn('[Persistence] Failed to save insights:', err));\n    }, DATA_DEBOUNCE_MS);\n    return () => { if (insightsTimer.current) clearTimeout(insightsTimer.current); };\n  }, [insightsSession, saveInsights, storage]);\n\n  // ── Nuggets save (includes per-nugget documents) ──\n  // Track previous nugget references for dirty detection via object identity\n  const prevNuggetsRef = useRef<Map<string, Nugget>>(new Map());\n\n  const saveAllNuggets = useCallback(async () => {\n    const { nuggets: currentNuggets } = latestRef.current;\n    const prevMap = prevNuggetsRef.current;\n    const currentIds = new Set(currentNuggets.map(n => n.id));\n\n    let savedCount = 0;\n\n    for (const nugget of currentNuggets) {\n      // Skip if nugget object reference is unchanged (not dirty)\n      if (prevMap.get(nugget.id) === nugget) continue;\n      savedCount++;\n\n      // Serialize everything for this nugget\n      const storedNugget = serializeNugget(nugget);\n      const storedCards = nugget.cards.map(c => serializeCard(c, nugget.id));\n\n      // Collect ALL images for this nugget\n      const allImages: StoredImage[] = [];\n      for (const card of nugget.cards) {\n        allImages.push(...extractImages(card, nugget.id));\n      }\n\n      // Collect documents (only ready ones)\n      const storedDocs = nugget.documents\n        .filter(d => d.status === 'ready')\n        .map(d => serializeNuggetDocument(nugget.id, d));\n\n      // Atomic save: nugget + headings + images + docs in one transaction\n      await storage.saveNuggetDataAtomic(\n        nugget.id, storedNugget, storedCards, allImages, storedDocs\n      );\n\n      // Clean up orphaned documents (outside atomic tx — acceptable, only removes stale data)\n      const existingDocs = await storage.loadNuggetDocuments(nugget.id);\n      const currentDocIds = new Set(storedDocs.map(d => d.docId));\n      for (const sd of existingDocs) {\n        if (!currentDocIds.has(sd.docId)) {\n          await storage.deleteNuggetDocument(nugget.id, sd.docId);\n        }\n      }\n\n      // Clean up orphaned images (deleted from cardUrlMap but still in IndexedDB)\n      const storedImages = await storage.loadNuggetImages(nugget.id);\n      const currentImageKeys = new Set(allImages.map(img => `${img.headingId}:${img.level}`));\n      for (const img of storedImages) {\n        if (!currentImageKeys.has(`${img.headingId}:${img.level}`)) {\n          await storage.deleteNuggetImage(nugget.id, img.headingId, img.level);\n        }\n      }\n    }\n\n    // Clean up deleted nuggets (lightweight ID enumeration, no full deserialization)\n    const storedNuggetIds = await storage.loadAllNuggetIds();\n    for (const id of storedNuggetIds) {\n      if (!currentIds.has(id)) {\n        await storage.deleteNugget(id);\n        await storage.deleteNuggetDocuments(id);\n        await storage.deleteNuggetHeadings(id);\n        await storage.deleteNuggetImages(id);\n      }\n    }\n\n    // Update snapshot for next dirty comparison\n    prevNuggetsRef.current = new Map(currentNuggets.map(n => [n.id, n]));\n    return savedCount;\n  }, [storage]);\n\n  useEffect(() => {\n    if (!storage.isReady() || !hydrationDone.current) return;\n    if (nuggetsTimer.current) clearTimeout(nuggetsTimer.current);\n    nuggetsTimer.current = setTimeout(() => {\n      const total = latestRef.current.nuggets.length;\n      saveAllNuggets()\n        .then((saved) => console.log(`[Persistence] Nuggets saved: ${saved}/${total} dirty`))\n        .catch(err => console.warn('[Persistence] Failed to save nuggets:', err));\n    }, DATA_DEBOUNCE_MS);\n    return () => { if (nuggetsTimer.current) clearTimeout(nuggetsTimer.current); };\n  }, [nuggets, saveAllNuggets, storage]);\n\n  // ── Projects save ──\n  const saveAllProjects = useCallback(async () => {\n    const { projects: currentProjects } = latestRef.current;\n\n    for (const project of currentProjects) {\n      await storage.saveProject(serializeProject(project));\n    }\n\n    // Clean up deleted projects\n    const storedProjects = await storage.loadProjects();\n    const currentProjectIds = new Set(currentProjects.map(p => p.id));\n    for (const sp of storedProjects) {\n      if (!currentProjectIds.has(sp.id)) {\n        await storage.deleteProject(sp.id);\n      }\n    }\n  }, [storage]);\n\n  useEffect(() => {\n    if (!storage.isReady() || !hydrationDone.current) return;\n    if (projectsTimer.current) clearTimeout(projectsTimer.current);\n    projectsTimer.current = setTimeout(() => {\n      console.log('[Persistence] Saving projects...', latestRef.current.projects.length);\n      saveAllProjects()\n        .then(() => console.log('[Persistence] Projects saved successfully'))\n        .catch(err => console.warn('[Persistence] Failed to save projects:', err));\n    }, DATA_DEBOUNCE_MS);\n    return () => { if (projectsTimer.current) clearTimeout(projectsTimer.current); };\n  }, [projects, saveAllProjects, storage]);\n\n  // ── Custom styles save ──\n  useEffect(() => {\n    if (!storage.isReady() || !hydrationDone.current) return;\n    if (customStylesTimer.current) clearTimeout(customStylesTimer.current);\n    customStylesTimer.current = setTimeout(() => {\n      storage.saveCustomStyles(latestRef.current.customStyles)\n        .then(() => console.log('[Persistence] Custom styles saved:', latestRef.current.customStyles.length))\n        .catch(err => console.warn('[Persistence] Failed to save custom styles:', err));\n    }, APP_STATE_DEBOUNCE_MS);\n    return () => { if (customStylesTimer.current) clearTimeout(customStylesTimer.current); };\n  }, [customStyles, storage]);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useTokenUsage.ts","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000_000.","line":59,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":59,"endColumn":38},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000_000.","line":60,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":60,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000_000.","line":62,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":62,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000_000.","line":65,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":65,"endColumn":42},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000_000.","line":73,"column":12,"nodeType":"Literal","messageId":"noMagic","endLine":73,"endColumn":21},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":73,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":73,"endColumn":63,"fix":{"range":[2153,2193],"text":"{return `${(n / 1_000_000).toFixed(1)}M`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000_000.","line":73,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":73,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000.","line":74,"column":12,"nodeType":"Literal","messageId":"noMagic","endLine":74,"endColumn":17},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":74,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":74,"endColumn":55,"fix":{"range":[2212,2248],"text":"{return `${(n / 1_000).toFixed(1)}K`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1_000.","line":74,"column":34,"nodeType":"Literal","messageId":"noMagic","endLine":74,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 10.","line":79,"column":12,"nodeType":"Literal","messageId":"noMagic","endLine":79,"endColumn":14},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":79,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":79,"endColumn":42,"fix":{"range":[2335,2361],"text":"{return `$${n.toFixed(2)}`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.01.","line":80,"column":12,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":16},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":80,"column":18,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":80,"endColumn":44,"fix":{"range":[2379,2405],"text":"{return `$${n.toFixed(3)}`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":80,"column":39,"nodeType":"Literal","messageId":"noMagic","endLine":80,"endColumn":40},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":81,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":81,"endColumn":40,"fix":{"range":[2419,2445],"text":"{return `$${n.toFixed(4)}`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":81,"column":35,"nodeType":"Literal","messageId":"noMagic","endLine":81,"endColumn":36},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":104,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":104,"endColumn":37,"fix":{"range":[3164,3171],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":105,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":105,"endColumn":66,"fix":{"range":[3202,3237],"text":"{clearTimeout(saveTimerRef.current);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":108,"column":23,"nodeType":"MemberExpression","messageId":"unexpected","endLine":108,"endColumn":35},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":113,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":113,"endColumn":18,"suggestions":[{"fix":{"range":[3558,3683],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":147,"column":23,"nodeType":"MemberExpression","messageId":"unexpected","endLine":147,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":22,"fixableErrorCount":0,"fixableWarningCount":7,"source":"import { useState, useRef, useCallback, useEffect } from 'react';\nimport { StorageBackend } from '../utils/storage/StorageBackend';\n\n// ── Cost rates per 1M tokens (USD) ──\n\nconst COST_RATES: Record<string, { input: number; output: number; cacheRead?: number; cacheWrite?: number }> = {\n  'claude-sonnet-4-6':          { input: 3, output: 15, cacheRead: 0.30, cacheWrite: 3.75 },\n  'gemini-3-pro-image-preview': { input: 1.25, output: 5 },\n};\n\n// Fallback for unknown models\nconst DEFAULT_RATES: { input: number; output: number; cacheRead?: number; cacheWrite?: number } = { input: 1, output: 5 };\n\n// ── Types ──\n\nexport interface TokenUsageEntry {\n  provider: 'claude' | 'gemini';\n  model: string;\n  inputTokens: number;\n  outputTokens: number;\n  cacheReadTokens?: number;\n  cacheWriteTokens?: number;\n  estimatedCost: number;\n  timestamp: number;\n}\n\nexport interface TokenUsageTotals {\n  totalInputTokens: number;\n  totalOutputTokens: number;\n  totalCacheReadTokens: number;\n  totalCost: number;\n  claudeCost: number;\n  geminiCost: number;\n  claudeInputTokens: number;\n  claudeOutputTokens: number;\n  geminiInputTokens: number;\n  geminiOutputTokens: number;\n  callCount: number;\n}\n\nconst EMPTY_TOTALS: TokenUsageTotals = {\n  totalInputTokens: 0,\n  totalOutputTokens: 0,\n  totalCacheReadTokens: 0,\n  totalCost: 0,\n  claudeCost: 0,\n  geminiCost: 0,\n  claudeInputTokens: 0,\n  claudeOutputTokens: 0,\n  geminiInputTokens: 0,\n  geminiOutputTokens: 0,\n  callCount: 0,\n};\n\n// ── Cost calculation ──\n\nfunction calculateCost(model: string, inputTokens: number, outputTokens: number, cacheReadTokens?: number, cacheWriteTokens?: number): number {\n  const rates = COST_RATES[model] ?? DEFAULT_RATES;\n  let cost = (inputTokens / 1_000_000) * rates.input\n           + (outputTokens / 1_000_000) * rates.output;\n  if (cacheReadTokens && rates.cacheRead != null) {\n    cost += (cacheReadTokens / 1_000_000) * rates.cacheRead;\n  }\n  if (cacheWriteTokens && rates.cacheWrite != null) {\n    cost += (cacheWriteTokens / 1_000_000) * rates.cacheWrite;\n  }\n  return cost;\n}\n\n// ── Format helpers ──\n\nexport function formatTokens(n: number): string {\n  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;\n  if (n >= 1_000) return `${(n / 1_000).toFixed(1)}K`;\n  return String(n);\n}\n\nexport function formatCost(n: number): string {\n  if (n >= 10) return `$${n.toFixed(2)}`;\n  if (n >= 0.01) return `$${n.toFixed(3)}`;\n  if (n > 0) return `$${n.toFixed(4)}`;\n  return '$0.00';\n}\n\n// ── Hook ──\n\nexport type RecordUsageFn = (entry: Omit<TokenUsageEntry, 'estimatedCost' | 'timestamp'>) => void;\n\nconst SAVE_DEBOUNCE_MS = 500;\n\nexport function useTokenUsage(storage?: StorageBackend, initialTotals?: TokenUsageTotals) {\n  const entriesRef = useRef<TokenUsageEntry[]>([]);\n  const [totals, setTotals] = useState<TokenUsageTotals>(initialTotals ?? EMPTY_TOTALS);\n  const saveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const latestTotalsRef = useRef(totals);\n\n  // Keep ref in sync\n  useEffect(() => {\n    latestTotalsRef.current = totals;\n  }, [totals]);\n\n  // Debounced save to storage\n  const scheduleSave = useCallback(() => {\n    if (!storage?.isReady()) return;\n    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);\n    saveTimerRef.current = setTimeout(() => {\n      storage.saveTokenUsage(latestTotalsRef.current as unknown as Record<string, unknown>)\n        .catch(err => console.warn('[TokenUsage] Failed to save:', err));\n    }, SAVE_DEBOUNCE_MS);\n  }, [storage]);\n\n  const recordUsage: RecordUsageFn = useCallback((raw) => {\n    console.debug('[TokenUsage] recordUsage called:', raw.provider, raw.model, 'in:', raw.inputTokens, 'out:', raw.outputTokens);\n    const cost = calculateCost(raw.model, raw.inputTokens, raw.outputTokens, raw.cacheReadTokens, raw.cacheWriteTokens);\n    const entry: TokenUsageEntry = {\n      ...raw,\n      estimatedCost: cost,\n      timestamp: Date.now(),\n    };\n    entriesRef.current.push(entry);\n\n    setTotals(prev => {\n      const next = {\n        totalInputTokens: prev.totalInputTokens + entry.inputTokens,\n        totalOutputTokens: prev.totalOutputTokens + entry.outputTokens,\n        totalCacheReadTokens: prev.totalCacheReadTokens + (entry.cacheReadTokens ?? 0),\n        totalCost: prev.totalCost + cost,\n        claudeCost: entry.provider === 'claude' ? prev.claudeCost + cost : prev.claudeCost,\n        geminiCost: entry.provider === 'gemini' ? prev.geminiCost + cost : prev.geminiCost,\n        claudeInputTokens: entry.provider === 'claude' ? prev.claudeInputTokens + entry.inputTokens : prev.claudeInputTokens,\n        claudeOutputTokens: entry.provider === 'claude' ? prev.claudeOutputTokens + entry.outputTokens : prev.claudeOutputTokens,\n        geminiInputTokens: entry.provider === 'gemini' ? prev.geminiInputTokens + entry.inputTokens : prev.geminiInputTokens,\n        geminiOutputTokens: entry.provider === 'gemini' ? prev.geminiOutputTokens + entry.outputTokens : prev.geminiOutputTokens,\n        callCount: prev.callCount + 1,\n      };\n      return next;\n    });\n    scheduleSave();\n  }, [scheduleSave]);\n\n  const resetUsage = useCallback(() => {\n    entriesRef.current = [];\n    setTotals(EMPTY_TOTALS);\n    // Save reset immediately\n    if (storage?.isReady()) {\n      storage.saveTokenUsage(EMPTY_TOTALS as unknown as Record<string, unknown>)\n        .catch(err => console.warn('[TokenUsage] Failed to save reset:', err));\n    }\n  }, [storage]);\n\n  return { totals, recordUsage, resetUsage };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\hooks\\useVersionHistory.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'blobUrlsRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'blobUrlsRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":45,"column":19,"nodeType":"Identifier","endLine":45,"endColumn":26},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":45,"column":27,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":45,"endColumn":34,"fix":{"range":[1338,1453],"text":"for (const url of blobUrlsRef.current) {\n        try { URL.revokeObjectURL(url); } catch (_) { /* ignore */ }\n      }"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":46,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":56,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":49},{"ruleId":"prefer-const","severity":1,"message":"'updated' is never reassigned. Use 'const' instead.","line":84,"column":11,"nodeType":"Identifier","messageId":"useConst","endLine":84,"endColumn":18,"fix":{"range":[2446,2487],"text":"const updated = [...truncated, newVersion];"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'prev' is defined but never used. Allowed unused args must match /^_/u.","line":95,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":95,"endColumn":25},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":107,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":107,"endColumn":40,"fix":{"range":[3150,3162],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":118,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":118,"endColumn":58,"fix":{"range":[3534,3546],"text":"{return null;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":129,"column":48,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":129,"endColumn":60,"fix":{"range":[3930,3942],"text":"{return null;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":140,"column":14,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":140,"endColumn":21,"fix":{"range":[4246,4295],"text":"for (const v of versions) revokeBlobUrl(v.imageUrl);"}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":6,"source":"import { useState, useCallback, useRef, useEffect } from 'react';\nimport { ImageVersion } from '../types';\n\nconst MAX_VERSIONS = 10;\n\n/**\n * Version history hook for image modification tracking.\n * Manages a stack of up to MAX_VERSIONS image versions with proper\n * blob URL cleanup on eviction and unmount.\n *\n * @param initialHistory - Optional pre-existing history (from heading.imageHistory)\n * @param originalImageUrl - The original card image URL (used to create \"Original\" entry if no history)\n */\nexport function useVersionHistory(\n  initialHistory?: ImageVersion[],\n  originalImageUrl?: string | null\n) {\n  const [versions, setVersions] = useState<ImageVersion[]>(() => {\n    if (initialHistory && initialHistory.length > 0) {\n      return initialHistory;\n    }\n    if (originalImageUrl) {\n      return [{\n        imageUrl: originalImageUrl,\n        timestamp: Date.now(),\n        label: 'Original',\n      }];\n    }\n    return [];\n  });\n\n  const [currentIndex, setCurrentIndex] = useState<number>(() => {\n    if (initialHistory && initialHistory.length > 0) {\n      return initialHistory.length - 1;\n    }\n    return 0;\n  });\n\n  // Track blob URLs we've created so we can revoke them on cleanup\n  const blobUrlsRef = useRef<Set<string>>(new Set());\n\n  // Cleanup blob URLs on unmount\n  useEffect(() => {\n    return () => {\n      blobUrlsRef.current.forEach(url => {\n        try { URL.revokeObjectURL(url); } catch (_) { /* ignore */ }\n      });\n    };\n  }, []);\n\n  /**\n   * Revoke a blob URL if we created it\n   */\n  const revokeBlobUrl = useCallback((url: string) => {\n    if (blobUrlsRef.current.has(url)) {\n      try { URL.revokeObjectURL(url); } catch (_) { /* ignore */ }\n      blobUrlsRef.current.delete(url);\n    }\n  }, []);\n\n  /**\n   * Push a new version onto the stack.\n   * If we're not at the end of the stack (user navigated back),\n   * all versions after currentIndex are discarded.\n   * If stack exceeds MAX_VERSIONS, oldest is evicted.\n   */\n  const pushVersion = useCallback((imageUrl: string, label: string) => {\n    // Track blob URLs\n    if (imageUrl.startsWith('blob:')) {\n      blobUrlsRef.current.add(imageUrl);\n    }\n\n    setVersions(prev => {\n      // Discard any \"future\" versions if user navigated back\n      const truncated = prev.slice(0, currentIndex + 1);\n\n      // Prepare new version\n      const newVersion: ImageVersion = {\n        imageUrl,\n        timestamp: Date.now(),\n        label,\n      };\n\n      let updated = [...truncated, newVersion];\n\n      // Evict oldest if over capacity\n      if (updated.length > MAX_VERSIONS) {\n        const evicted = updated.shift()!;\n        revokeBlobUrl(evicted.imageUrl);\n      }\n\n      return updated;\n    });\n\n    setCurrentIndex(prev => {\n      // We're appending after the current position (after truncation)\n      const newIdx = Math.min(currentIndex + 1, MAX_VERSIONS - 1);\n      return newIdx;\n    });\n  }, [currentIndex, revokeBlobUrl]);\n\n  /**\n   * Navigate to the previous version (undo).\n   * Returns the previous version's imageUrl, or null if already at start.\n   */\n  const restorePrevious = useCallback((): string | null => {\n    if (currentIndex <= 0) return null;\n    const newIdx = currentIndex - 1;\n    setCurrentIndex(newIdx);\n    return versions[newIdx]?.imageUrl || null;\n  }, [currentIndex, versions]);\n\n  /**\n   * Navigate to the next version (redo).\n   * Returns the next version's imageUrl, or null if already at end.\n   */\n  const restoreNext = useCallback((): string | null => {\n    if (currentIndex >= versions.length - 1) return null;\n    const newIdx = currentIndex + 1;\n    setCurrentIndex(newIdx);\n    return versions[newIdx]?.imageUrl || null;\n  }, [currentIndex, versions]);\n\n  /**\n   * Jump to a specific version by index.\n   * Returns the version's imageUrl, or null if invalid index.\n   */\n  const restoreByIndex = useCallback((index: number): string | null => {\n    if (index < 0 || index >= versions.length) return null;\n    setCurrentIndex(index);\n    return versions[index]?.imageUrl || null;\n  }, [versions]);\n\n  /**\n   * Reset the history — used when card is regenerated from scratch.\n   * Cleans up all blob URLs.\n   */\n  const resetHistory = useCallback((newOriginalUrl?: string) => {\n    // Cleanup old blob URLs\n    versions.forEach(v => revokeBlobUrl(v.imageUrl));\n\n    if (newOriginalUrl) {\n      setVersions([{\n        imageUrl: newOriginalUrl,\n        timestamp: Date.now(),\n        label: 'Original',\n      }]);\n      setCurrentIndex(0);\n    } else {\n      setVersions([]);\n      setCurrentIndex(0);\n    }\n  }, [versions, revokeBlobUrl]);\n\n  const currentVersion = versions[currentIndex] || null;\n  const canUndo = currentIndex > 0;\n  const canRedo = currentIndex < versions.length - 1;\n  const modificationCount = versions.filter(v => v.label !== 'Original').length;\n\n  return {\n    versions,\n    currentIndex,\n    currentVersion,\n    canUndo,\n    canRedo,\n    modificationCount,\n    pushVersion,\n    restorePrevious,\n    restoreNext,\n    restoreByIndex,\n    resetHistory,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'FileType' is defined but never used. Allowed unused vars must match /^_/u.","line":236,"column":6,"nodeType":"Identifier","messageId":"unusedVar","endLine":236,"endColumn":14}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nexport interface Palette {\n  background: string;\n  primary: string;\n  secondary: string;\n  accent: string;\n  text: string;\n}\n\nexport type DetailLevel = 'Executive' | 'Standard' | 'Detailed' | 'TitleCard' | 'TakeawayCard' | 'DirectContent';\n\nexport const isCoverLevel = (level: DetailLevel): boolean =>\n  level === 'TitleCard' || level === 'TakeawayCard';\n\nexport interface FontPair {\n  primary: string;   // Title font\n  secondary: string; // Body font\n}\n\nexport interface CustomStyle {\n  id: string;\n  name: string;\n  palette: Palette;\n  fonts: FontPair;\n  identity: string;       // visual identity description for generation prompts\n  createdAt: number;\n  lastModifiedAt: number;\n}\n\nexport interface StylingOptions {\n  levelOfDetail: DetailLevel;\n  style: string;\n  palette: Palette;\n  fonts: FontPair;\n  aspectRatio: '1:1' | '2:3' | '3:2' | '3:4' | '4:3' | '4:5' | '5:4' | '9:16' | '16:9' | '21:9';\n  resolution: '1K' | '2K' | '4K';\n}\n\nexport interface ReferenceImage {\n  url: string;\n  settings: StylingOptions;\n}\n\n// ── Document content heading (H1-H6 parsed from markdown) ──\n\nexport interface Heading {\n  level: number;\n  text: string;\n  id: string;\n  selected?: boolean;\n  startIndex?: number;\n  /** Page number where this heading appears (native PDF only). */\n  page?: number;\n}\n\n// ── PDF bookmark tree node (nested TOC structure for native PDFs) ──\n\nexport interface BookmarkNode {\n  id: string;\n  title: string;\n  page: number;\n  level: number;\n  children: BookmarkNode[];\n}\n\n/** How the bookmark tree was obtained. */\nexport type BookmarkSource = 'pdf_bookmarks' | 'ai_generated' | 'manual';\n\n// ── Card (the primary creative unit — synthesized content + generated image) ──\n\nexport interface Card {\n  level: number;\n  text: string;\n  id: string;\n  selected?: boolean;\n  /** The structural detail level of this card (Executive, Standard, TitleCard, etc.). */\n  detailLevel?: DetailLevel;\n  /** @deprecated Retained for backward compat on deserialization. Use detailLevel instead. */\n  settings?: StylingOptions;\n  /** Stores synthesized content for each level of detail */\n  synthesisMap?: Partial<Record<DetailLevel, string>>;\n  /** Tracks synthesis state for each specific level */\n  isSynthesizingMap?: Partial<Record<DetailLevel, boolean>>;\n  startIndex?: number;\n  /** Per-level card image URLs */\n  cardUrlMap?: Partial<Record<DetailLevel, string>>;\n  /** Per-level card generation state */\n  isGeneratingMap?: Partial<Record<DetailLevel, boolean>>;\n  /** Per-level annotation/version history */\n  imageHistoryMap?: Partial<Record<DetailLevel, ImageVersion[]>>;\n  /** Per-level visual layout plan from the planner step */\n  visualPlanMap?: Partial<Record<DetailLevel, string>>;\n  /** Per-level snapshot of synthesis content used for card generation — used to detect content changes */\n  lastGeneratedContentMap?: Partial<Record<DetailLevel, string>>;\n  /** Per-level full visualizer prompt used for card generation */\n  lastPromptMap?: Partial<Record<DetailLevel, string>>;\n  /** Timestamp when this card was created */\n  createdAt?: number;\n  /** Timestamp when this card was last edited */\n  lastEditedAt?: number;\n  /** Names of documents that were active when this card was created */\n  sourceDocuments?: string[];\n  /** Links this card to the Auto-Deck session that created it */\n  autoDeckSessionId?: string;\n}\n\n// ── Document origin tracking ──\n\nexport interface SourceOrigin {\n  type: 'uploaded' | 'copied' | 'moved';\n  /** For copy/move: name of the source project */\n  sourceProjectName?: string;\n  /** For copy/move: name of the source nugget */\n  sourceNuggetName?: string;\n  /** When the origin event occurred (epoch ms) */\n  timestamp: number;\n}\n\nexport interface UploadedFile {\n  id: string;\n  name: string;\n  size: number;\n  type: string;\n  lastModified: number;\n  content?: string;\n  structure?: Heading[];\n  status: 'uploading' | 'processing' | 'ready' | 'error';\n  progress: number;\n  /** Whether the document is included in chat context (defaults to true when undefined). Not persisted. */\n  enabled?: boolean;\n  /** Anthropic Files API file ID — used to reference the document in chat without re-uploading content. */\n  fileId?: string;\n  /** Anthropic Files API file ID for the MetaTOC file (native-pdf only). */\n  metaTocFileId?: string;\n  /** Distinguishes how this document is stored and rendered. undefined = 'markdown' (backward compat). */\n  sourceType?: 'markdown' | 'native-pdf';\n  /** Raw PDF as base64 for iframe viewer (only for native-pdf documents). */\n  pdfBase64?: string;\n  /** How the TOC was extracted: from an explicit TOC page or by visual scanning. */\n  tocSource?: 'toc_page' | 'visual_scan';\n  /** Nested bookmark tree (native-pdf only). Single source of truth for document structure. */\n  bookmarks?: BookmarkNode[];\n  /** How the bookmark tree was obtained (native-pdf only). */\n  bookmarkSource?: BookmarkSource;\n  /** Original file format before conversion to markdown. */\n  originalFormat?: 'md' | 'pdf';\n  /** Timestamp when this document was added to the nugget (epoch ms). */\n  createdAt?: number;\n  /** Timestamp when this document's content was last saved in the editor (epoch ms). */\n  lastEditedAt?: number;\n  /** Timestamp when this document was last renamed (epoch ms). */\n  lastRenamedAt?: number;\n  /** Original file name at upload time (never changes). */\n  originalName?: string;\n  /** How this document arrived in the nugget (uploaded, copied, or moved). */\n  sourceOrigin?: SourceOrigin;\n  /** Version counter — increments on rename or content edit. */\n  version?: number;\n  /** Timestamp when chat was last enabled for this document (epoch ms). */\n  lastEnabledAt?: number;\n  /** Timestamp when chat was last disabled for this document (epoch ms). */\n  lastDisabledAt?: number;\n}\n\nexport interface ZoomState {\n  imageUrl: string | null;\n  cardId: string | null;\n  cardText: string | null;\n  palette?: Palette | null;\n  imageHistory?: ImageVersion[];\n  aspectRatio?: string;   // e.g. '16:9', '4:3', '1:1', '3:4'\n  resolution?: string;    // e.g. '1K', '2K', '4K'\n}\n\n// Phase 1: Annotation & Zoom types\nexport type AnnotationTool = 'select' | 'pin' | 'arrow' | 'rectangle' | 'sketch' | 'text' | 'zoom';\n\nexport interface NormalizedPoint {\n  x: number; // 0.0-1.0\n  y: number; // 0.0-1.0\n}\n\nexport interface ZoomViewState {\n  scale: number;      // 0.5 to 4.0\n  panX: number;       // CSS transform translateX in px\n  panY: number;       // CSS transform translateY in px\n  isPanning: boolean;\n}\n\n// Phase 2: Annotation data types\ntype AnnotationType = 'pin' | 'arrow' | 'rectangle' | 'sketch';\n\ninterface BaseAnnotation {\n  id: string;\n  type: AnnotationType;\n  color: string;\n  createdAt: number;\n}\n\nexport interface PinAnnotation extends BaseAnnotation {\n  type: 'pin';\n  position: NormalizedPoint;\n  instruction: string;\n}\n\nexport interface RectangleAnnotation extends BaseAnnotation {\n  type: 'rectangle';\n  topLeft: NormalizedPoint;\n  bottomRight: NormalizedPoint;\n  instruction: string;\n}\n\nexport interface ArrowAnnotation extends BaseAnnotation {\n  type: 'arrow';\n  start: NormalizedPoint;\n  end: NormalizedPoint;\n  instruction: string;\n}\n\nexport interface SketchAnnotation extends BaseAnnotation {\n  type: 'sketch';\n  points: NormalizedPoint[];\n  strokeWidth: number; // normalized — thick brush for area highlighting\n  instruction: string;\n}\n\nexport type Annotation = PinAnnotation | RectangleAnnotation | ArrowAnnotation | SketchAnnotation;\n\n// Phase 5: Version history\nexport interface ImageVersion {\n  imageUrl: string;    // blob URL or data URL\n  timestamp: number;\n  label: string;       // \"Original\", \"Modification 1\", etc.\n}\n\nenum FileType {\n  MD = 'text/markdown',\n  PDF = 'application/pdf',\n  PLAIN = 'text/plain'\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Insights Workflow Types\n// ─────────────────────────────────────────────────────────────────\n\nexport type WorkflowMode = 'insights';\n\nexport interface ChatMessage {\n  id: string;\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n  timestamp: number;\n  isCardContent?: boolean;       // true if this was a \"Generate Card\" response\n  detailLevel?: DetailLevel;     // which level was requested\n  savedAsCardId?: string;        // if user saved this to card list\n}\n\nexport interface InsightsDocument {\n  id: string;\n  name: string;\n  type: 'md' | 'pdf';\n  size: number;\n  content?: string;              // text content for MD files\n  base64?: string;               // binary content for PDF\n  mediaType?: string;            // MIME type for binary docs\n}\n\nexport interface InsightsSession {\n  id: string;\n  documents: InsightsDocument[];\n  messages: ChatMessage[];\n  cards: Card[];                 // user-curated cards\n}\n\n// ── Document change tracking ──\n\nexport type DocChangeEventType = 'added' | 'removed' | 'renamed' | 'enabled' | 'disabled' | 'updated' | 'toc_updated';\n\nexport interface DocChangeEvent {\n  type: DocChangeEventType;\n  docId: string;\n  docName: string;\n  /** For rename events, the previous name */\n  oldName?: string;\n  timestamp: number;\n}\n\n// ── Nugget types ──\n\nexport type NuggetType = 'insights';\n\nexport interface Nugget {\n  id: string;\n  name: string;\n  type: NuggetType;\n  documents: UploadedFile[];\n  cards: Card[];\n  messages?: ChatMessage[];\n  lastDocHash?: string;           // hash of active documents at time of last API call\n  /** Ordered log of document mutations for change notification */\n  docChangeLog?: DocChangeEvent[];\n  /** Index into docChangeLog marking last sync to chat agent */\n  lastDocChangeSyncIndex?: number;\n  /** AI-generated topic sentence used for expert priming in prompts. User-editable. */\n  subject?: string;\n  /** Per-nugget styling preferences for the generation toolbar. Persisted to IndexedDB. */\n  stylingOptions?: StylingOptions;\n  createdAt: number;\n  lastModifiedAt: number;\n}\n\n// ── Project types ──\n\nexport interface Project {\n  id: string;\n  name: string;\n  description?: string;\n  nuggetIds: string[];\n  isCollapsed?: boolean;\n  createdAt: number;\n  lastModifiedAt: number;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Auto-Deck Types\n// ─────────────────────────────────────────────────────────────────\n\nexport interface AutoDeckBriefing {\n  audience: string;       // max 100 chars — who will view this\n  type: string;           // max 80 chars — presentation type (educational, pitch, etc.)\n  objective: string;      // max 150 chars — what the audience should take away\n  tone?: string;          // max 80 chars — how it should sound (optional)\n  focus?: string;         // max 120 chars — what to prioritize (optional)\n  minCards?: number;      // optional minimum card count constraint\n  maxCards?: number;      // optional maximum card count constraint\n  includeCover?: boolean;          // add a cover/title card\n  includeSectionTitles?: boolean;  // add title cards for main sections\n  includeClosing?: boolean;        // add a closing takeaway/conclusion card\n}\n\nexport type AutoDeckLod = 'executive' | 'standard' | 'detailed';\n\nexport type AutoDeckStatus = 'configuring' | 'planning' | 'conflict' | 'reviewing' | 'revising' | 'finalizing' | 'producing' | 'complete' | 'error';\n\nexport interface PlannedCard {\n  number: number;\n  title: string;\n  description: string;\n  sources: {\n    document: string;\n    section?: string;               // legacy — kept for backward compat\n    heading?: string;               // EXACT heading text from document\n    fallbackDescription?: string;   // when no clear heading, describe location\n  }[];\n  /** Target word count for this card (within the LOD range, assigned by planner). */\n  wordTarget?: number;\n  /** Verbatim quotes/figures from sources that MUST appear in card content. */\n  keyDataPoints?: string[];\n  /** Content writer instructions — either a legacy string or structured object. */\n  guidance: string | {\n    emphasis: string;\n    tone: string;\n    exclude: string;\n  };\n  /** References to other cards this one relates to (e.g., \"Builds on Card 2\"). */\n  crossReferences?: string | null;\n}\n\nexport interface PlanQuestionOption {\n  key: string;                 // e.g. \"a\", \"b\", \"c\"\n  label: string;               // Display text for the option\n  producerInstruction: string;  // Verbatim instruction injected into producer prompt\n}\n\nexport interface PlanQuestion {\n  id: string;                  // e.g. \"q1\", \"q2\"\n  question: string;            // The question text\n  options: PlanQuestionOption[];\n  recommendedKey: string;      // Which option key the planner recommends\n  context?: string;            // Optional brief context for why this question matters\n}\n\nexport interface ConflictItem {\n  description: string;\n  sourceA: { document: string; section: string };\n  sourceB: { document: string; section: string };\n  severity: 'high' | 'medium' | 'low';\n}\n\nexport interface ParsedPlan {\n  metadata: {\n    category: string;\n    lod: AutoDeckLod;\n    sourceWordCount: number;\n    cardCount: number;\n    documentStrategy: 'dissolve' | 'preserve' | 'hybrid';\n    documentRelationships: string;\n  };\n  cards: PlannedCard[];\n  /** Planner-generated decision-point questions for user review. */\n  questions?: PlanQuestion[];\n}\n\nexport interface ReviewCardState {\n  included: boolean;\n}\n\nexport interface ReviewState {\n  generalComment: string;\n  cardStates: Record<number, ReviewCardState>;\n  /** User's MCQ answers — maps questionId to selected option key. */\n  questionAnswers: Record<string, string>;\n  decision: 'pending' | 'approved' | 'revise';\n}\n\nexport interface AutoDeckSession {\n  id: string;\n  nuggetId: string;\n  briefing: AutoDeckBriefing;\n  lod: AutoDeckLod;\n  /** Ordered document IDs selected by user (preserved across revisions) */\n  orderedDocIds: string[];\n  status: AutoDeckStatus;\n  parsedPlan: ParsedPlan | null;\n  conflicts: ConflictItem[] | null;\n  reviewState: ReviewState | null;\n  producedCards: { number: number; title: string; content: string; wordCount: number }[];\n  revisionCount: number;\n  error: string | null;\n  createdAt: number;\n}\n\n// ── Persistence types ──\n\nexport interface InitialPersistedState {\n  nuggets: Nugget[];\n  projects: Project[];\n  selectedNuggetId: string | null;\n  selectedDocumentId?: string | null;\n  selectedProjectId?: string | null;\n  activeCardId: string | null;\n  workflowMode: WorkflowMode;\n  // Legacy compat fields — populated from nugget shim\n  insightsSession: InsightsSession | null;\n  // Token usage totals (persisted across refreshes)\n  tokenUsageTotals?: Record<string, number>;\n  // User-created custom styles (global, not per-nugget)\n  customStyles?: CustomStyle[];\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\ai.ts","messages":[{"ruleId":"import/order","severity":1,"message":"`@google/genai` import should occur before import of `../types`","line":2,"column":1,"nodeType":"ImportDeclaration","endLine":2,"endColumn":70,"fix":{"range":[0,145],"text":"import { ThinkingLevel, Modality, GoogleGenAI } from '@google/genai';\nimport { StylingOptions, Palette, FontPair, CustomStyle } from '../types';\n"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":77,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":77,"endColumn":51,"fix":{"range":[7644,7653],"text":"{continue;}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":86,"column":10,"nodeType":"Literal","messageId":"defineConstant","endLine":86,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'FLASH_TEXT_CONFIG' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":101,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":101,"endColumn":24},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":136,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":136,"endColumn":17,"suggestions":[{"fix":{"range":[9738,9815],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'resetGeminiKey' is defined but never used. Allowed unused vars must match /^_/u.","line":143,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":143,"endColumn":24},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":150,"column":42,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":150,"endColumn":54,"fix":{"range":[10281,10293],"text":"{return true;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":151,"column":54,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":151,"endColumn":66,"fix":{"range":[10347,10359],"text":"{return true;}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10798,10801],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10798,10801],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 429.","line":169,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":169,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":169,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":169,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 503.","line":169,"column":56,"nodeType":"Literal","messageId":"noMagic","endLine":169,"endColumn":59},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":177,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":177,"endColumn":46,"fix":{"range":[11459,11469],"text":"{throw err;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":179,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":179,"endColumn":54},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":180,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":180,"endColumn":44},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 32_000.","line":181,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":181,"endColumn":58},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":183,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":183,"endColumn":21,"suggestions":[{"fix":{"range":[11841,11987],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":183,"column":101,"nodeType":"Literal","messageId":"noMagic","endLine":183,"endColumn":103},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1000.","line":183,"column":131,"nodeType":"Literal","messageId":"noMagic","endLine":183,"endColumn":135},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":204,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12584,12587],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12584,12587],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 429.","line":208,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":208,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":208,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":208,"endColumn":39},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 503.","line":208,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":208,"endColumn":57},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":216,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":216,"endColumn":19,"suggestions":[{"fix":{"range":[13200,13287],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 23 to the 15 allowed.","line":296,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":296,"endColumn":33},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":301,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":301,"endColumn":71,"fix":{"range":[16023,16078],"text":"{throw new Error('ANTHROPIC_API_KEY is not configured');}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":390,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":390,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19307,19310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19307,19310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":410,"column":30,"nodeType":"Literal","messageId":"defineConstant","endLine":410,"endColumn":42},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 3 times.","line":411,"column":27,"nodeType":"Literal","messageId":"defineConstant","endLine":411,"endColumn":49},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":429,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":429,"endColumn":18,"suggestions":[{"fix":{"range":[20373,20532],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":465,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":465,"endColumn":71,"fix":{"range":[21437,21492],"text":"{throw new Error('ANTHROPIC_API_KEY is not configured');}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":488,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":488,"endColumn":16,"suggestions":[{"fix":{"range":[22153,22244],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":593,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":593,"endColumn":23,"fix":{"range":[26715,26722],"text":"{return;}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":606,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":606,"endColumn":20,"suggestions":[{"fix":{"range":[27087,27138],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":608,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":608,"endColumn":19,"suggestions":[{"fix":{"range":[27158,27232],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":611,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":611,"endColumn":17,"suggestions":[{"fix":{"range":[27261,27322],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":34,"fixableErrorCount":0,"fixableWarningCount":8,"source":"import { StylingOptions, Palette, FontPair, CustomStyle } from '../types';\nimport { ThinkingLevel, Modality, GoogleGenAI } from '@google/genai';\n\nexport const VISUAL_STYLES: Record<string, Palette> = {\n  \"Flat Design\": { background: \"#F5F7FA\", primary: \"#2D5BFF\", secondary: \"#6B7B8D\", accent: \"#FF6B35\", text: \"#1A1A2E\" },\n  \"Data-Centric Minimalist\": { background: \"#F4F7F9\", primary: \"#28435A\", secondary: \"#5F9EA0\", accent: \"#9BC4CB\", text: \"#212529\" },\n  \"Isometric\": { background: \"#FFFFFF\", primary: \"#4A90D9\", secondary: \"#50C878\", accent: \"#FF6F61\", text: \"#2C3E50\" },\n  \"Line Art\": { background: \"#FFFFFF\", primary: \"#1A1A1A\", secondary: \"#888888\", accent: \"#E63946\", text: \"#1A1A1A\" },\n  \"Retro / Mid-Century\": { background: \"#F4ECD8\", primary: \"#C75B12\", secondary: \"#5B8C5A\", accent: \"#D4A03C\", text: \"#3B2F2F\" },\n  \"Risograph / Duotone\": { background: \"#FAF3E8\", primary: \"#E63946\", secondary: \"#1D3557\", accent: \"#E63946\", text: \"#1D3557\" },\n  \"Neon / Dark Mode\": { background: \"#0D0D0D\", primary: \"#00F0FF\", secondary: \"#BF00FF\", accent: \"#39FF14\", text: \"#FFFFFF\" },\n  \"Paper Cutout\": { background: \"#FFF8F0\", primary: \"#E07A5F\", secondary: \"#81B29A\", accent: \"#F2CC8F\", text: \"#3D405B\" },\n  \"Pop Art\": { background: \"#FFFFFF\", primary: \"#FF0040\", secondary: \"#0066FF\", accent: \"#FFDE00\", text: \"#1A1A1A\" },\n  \"Watercolour\": { background: \"#FFFFFF\", primary: \"#7FB3D8\", secondary: \"#D4A0C0\", accent: \"#A8D5A2\", text: \"#4A4A4A\" },\n  \"Blueprint\": { background: \"#0B3D91\", primary: \"#FFFFFF\", secondary: \"#87CEEB\", accent: \"#FFD700\", text: \"#FFFFFF\" },\n  \"Doodle Art\": { background: \"#FFFFFF\", primary: \"#222222\", secondary: \"#555555\", accent: \"#FF6B35\", text: \"#222222\" },\n  \"Geometric Gradient\": { background: \"#F0F0F5\", primary: \"#6C5CE7\", secondary: \"#00CEC9\", accent: \"#FD79A8\", text: \"#2D3436\" },\n  \"Corporate Memphis\": { background: \"#FAF0E6\", primary: \"#1877F2\", secondary: \"#F4845F\", accent: \"#FFC947\", text: \"#14213D\" },\n  \"PwC Corporate\": { background: \"#FFFFFF\", primary: \"#D04A02\", secondary: \"#2D2D2D\", accent: \"#EB8C00\", text: \"#2D2D2D\" }\n};\n\nexport const STYLE_FONTS: Record<string, FontPair> = {\n  \"Flat Design\":          { primary: \"Montserrat\",       secondary: \"Open Sans\" },\n  \"Data-Centric Minimalist\": { primary: \"Inter\",          secondary: \"IBM Plex Sans\" },\n  \"Isometric\":            { primary: \"Bebas Neue\",       secondary: \"Roboto\" },\n  \"Line Art\":             { primary: \"Raleway\",          secondary: \"Lato\" },\n  \"Retro / Mid-Century\":  { primary: \"Futura\",           secondary: \"Helvetica\" },\n  \"Risograph / Duotone\":  { primary: \"Oswald\",           secondary: \"Source Sans Pro\" },\n  \"Neon / Dark Mode\":     { primary: \"Orbitron\",         secondary: \"Rajdhani\" },\n  \"Paper Cutout\":         { primary: \"Quicksand\",        secondary: \"Nunito\" },\n  \"Pop Art\":              { primary: \"Impact\",           secondary: \"Arial Black\" },\n  \"Watercolour\":          { primary: \"Playfair Display\", secondary: \"Lora\" },\n  \"Blueprint\":            { primary: \"DIN Condensed\",    secondary: \"Courier New\" },\n  \"Doodle Art\":           { primary: \"Pacifico\",         secondary: \"Comic Sans MS\" },\n  \"Geometric Gradient\":   { primary: \"Poppins\",          secondary: \"Inter\" },\n  \"Corporate Memphis\":    { primary: \"Work Sans\",        secondary: \"Rubik\" },\n  \"PwC Corporate\":        { primary: \"Georgia\",          secondary: \"Arial\" },\n};\n\nexport const STYLE_IDENTITIES: Record<string, string> = {\n  \"Flat Design\":          \"Solid color fills with no gradients, shadows, or textures. Crisp geometric shapes, simple flat icons, and strict grid layout with generous whitespace.\",\n  \"Data-Centric Minimalist\": \"Precision-engineered, cold professional, hyper-legible. Strict 12-column grid with 15% edge breathing room. Line-art or monotone-fill icons only — no photography or 3D. Hard geometric edges, analytical SaaS-blue atmosphere prioritizing data logic over personality.\",\n  \"Isometric\":            \"3D objects at a 30° isometric angle with three visible faces and no perspective distortion. Solid fills with subtle shading for volume, structured spatial arrangement.\",\n  \"Line Art\":             \"Built entirely from strokes and outlines — no filled shapes. Varying line weights for hierarchy, hatching for shading. Editorial and whitespace-heavy.\",\n  \"Retro / Mid-Century\":  \"1950s–60s graphic design with muted earthy tones and textured grain. Atomic-era shapes, starbursts, and bold vintage typography like a classic print poster.\",\n  \"Risograph / Duotone\":  \"Mimics risograph printing — two or three overlapping ink colors with visible halftone dots and slight mis-registration. Grainy, textured, analog zine feel.\",\n  \"Neon / Dark Mode\":     \"Dark background with vivid glowing neon elements and light bloom halos. Sleek futuristic geometry, thin glowing outlines, and circuit-like patterns. Cyberpunk dashboard feel.\",\n  \"Paper Cutout\":         \"Layered cut-paper look with visible paper texture and subtle shadows between layers. Soft rounded forms with slightly irregular hand-cut edges. Warm and tactile like a collage.\",\n  \"Pop Art\":              \"Bold Warhol/Lichtenstein-inspired with thick black outlines, flat saturated primary colors, and Ben-Day halftone dots. Big punchy typography like a comic panel.\",\n  \"Watercolour\":          \"Soft fluid paint washes that bleed and blend with no hard edges. Translucent color layers on visible paper grain. Light, airy, and painterly.\",\n  \"Blueprint\":            \"Technical drawing on deep blue background with white/light blue linework. Grid lines, dimension annotations, construction lines, and monospaced type like an engineer's drawing.\",\n  \"Doodle Art\":           \"Hand-drawn pen sketches with slightly wobbly freehand lines and quick hatching. Playful embellishments — arrows, stars, underlines. Informal whiteboard/notebook feel.\",\n  \"Geometric Gradient\":   \"Overlapping translucent geometric shapes with smooth multi-color gradient fills. Glassmorphism, soft blurs, and a polished tech-forward digital-native aesthetic.\",\n  \"Corporate Memphis\":    \"Friendly flat illustrations with disproportionate human figures — oversized limbs, tiny heads. Blobby organic shapes, no outlines, warm optimistic tech-company tone.\",\n  \"PwC Corporate\":        \"Clean, authoritative corporate consulting aesthetic with disciplined restraint. White background with orange as the singular hero accent for callout borders, key statistics, and focal chart elements. Grey data visualizations with only the focal metric highlighted in orange. Modular card-based layout with generous whitespace, clear section dividers, and a strict visual hierarchy. No decorative flourishes — every element serves the argument. Flat charts with minimal gridlines, direct value labeling, and orange left-border callout boxes for key figures.\",\n};\n\n// Snapshot of built-in style names — used to guard against overwriting and for UI dividers\nexport const BUILTIN_STYLE_NAMES: ReadonlySet<string> = new Set(Object.keys(VISUAL_STYLES));\n\n/**\n * Injects user-created custom styles into the runtime maps so they work\n * seamlessly with the existing prompt pipeline (buildNarrativeStyleBlock, etc.).\n * Call on app startup and after any custom style CRUD operation.\n */\nexport function registerCustomStyles(styles: CustomStyle[]): void {\n  // 1. Clear any previously-registered custom entries\n  for (const name of Object.keys(VISUAL_STYLES)) {\n    if (!BUILTIN_STYLE_NAMES.has(name)) {\n      delete VISUAL_STYLES[name];\n      delete STYLE_FONTS[name];\n      delete STYLE_IDENTITIES[name];\n    }\n  }\n  // 2. Inject each custom style\n  for (const s of styles) {\n    if (BUILTIN_STYLE_NAMES.has(s.name)) continue; // never overwrite built-in\n    VISUAL_STYLES[s.name] = { ...s.palette };\n    STYLE_FONTS[s.name] = { ...s.fonts };\n    STYLE_IDENTITIES[s.name] = s.identity;\n  }\n}\n\nexport const DEFAULT_STYLING: StylingOptions = {\n  levelOfDetail: 'Standard',\n  style: 'Flat Design',\n  palette: VISUAL_STYLES['Flat Design'],\n  fonts: STYLE_FONTS['Flat Design'],\n  aspectRatio: '16:9',\n  resolution: '1K'\n};\n\n// ─────────────────────────────────────────────────────────────────\n// Gemini 3 API Config Constants\n// IMPORTANT: Gemini 3 docs mandate temperature=1.0 (the default).\n// Setting <1.0 causes looping/degraded performance on reasoning tasks.\n// DO NOT add temperature overrides without reading the Gemini 3 migration guide.\n// ─────────────────────────────────────────────────────────────────\n\n/** Config for Gemini Flash text-only calls: low thinking + text-only output */\nconst FLASH_TEXT_CONFIG = {\n  thinkingConfig: { thinkingLevel: ThinkingLevel.LOW },\n  responseModalities: [Modality.TEXT],\n};\n\n/** Config for Gemini Pro Image calls: must include responseModalities to ensure image output */\nexport const PRO_IMAGE_CONFIG = {\n  responseModalities: [Modality.TEXT, Modality.IMAGE],\n};\n\n// ─────────────────────────────────────────────────────────────────\n// Gemini key rotation — primary + fallback key with auto-failover\n// ─────────────────────────────────────────────────────────────────\n\nconst GEMINI_KEYS = [\n  process.env.API_KEY,\n  process.env.GEMINI_API_KEY_FALLBACK,\n].filter(Boolean) as string[];\n\nlet _currentKeyIndex = 0;\nlet _aiInstance: GoogleGenAI | null = null;\n\n/** Get the current Gemini AI instance (lazy singleton). */\nexport function getGeminiAI(): GoogleGenAI {\n  if (!_aiInstance) {\n    _aiInstance = new GoogleGenAI({ apiKey: GEMINI_KEYS[_currentKeyIndex] || '' });\n  }\n  return _aiInstance;\n}\n\n/** Switch to the next available Gemini API key. Returns true if a fallback was available. */\nfunction rotateGeminiKey(): boolean {\n  if (_currentKeyIndex + 1 < GEMINI_KEYS.length) {\n    _currentKeyIndex++;\n    _aiInstance = null; // force re-creation with new key\n    console.warn(`[Gemini] Rotated to fallback key (index ${_currentKeyIndex})`);\n    return true;\n  }\n  return false;\n}\n\n/** Reset back to the primary key (call on app init or after a cooldown). */\nfunction resetGeminiKey(): void {\n  _currentKeyIndex = 0;\n  _aiInstance = null;\n}\n\n/** Compare two StylingOptions for style-anchoring mismatch (style, aspectRatio, palette — NOT resolution/fonts/level) */\nexport function detectSettingsMismatch(current: StylingOptions, reference: StylingOptions): boolean {\n  if (current.style !== reference.style) return true;\n  if (current.aspectRatio !== reference.aspectRatio) return true;\n  const keys: (keyof Palette)[] = ['background', 'primary', 'secondary', 'accent', 'text'];\n  return keys.some(k => current.palette[k] !== reference.palette[k]);\n}\n\nconst withRetry = async <T,>(\n  fn: () => Promise<T>,\n  maxRetries = 5,\n  onRetry?: (attempt: number, maxAttempts: number, delayMs: number) => void,\n): Promise<T> => {\n  let retries = 0;\n  while (retries < maxRetries) {\n    try {\n      return await fn();\n    } catch (err: any) {\n      const msg = err.message?.toLowerCase() || '';\n      const status = err.status || err.httpStatusCode || 0;\n      const isRetryable =\n        status === 429 || status === 500 || status === 503 ||\n        msg.includes('429') || msg.includes('500') || msg.includes('503') ||\n        msg.includes('overloaded') || msg.includes('unavailable') ||\n        msg.includes('resource_exhausted') || msg.includes('rate limit') ||\n        msg.includes('rate_limit') || msg.includes('too many requests') ||\n        msg.includes('internal server error') || msg.includes('high demand');\n      if (isRetryable) {\n        retries++;\n        if (retries >= maxRetries) throw err;\n        // Exponential backoff with jitter: base * 2^retry + random jitter (0–1s)\n        const baseDelay = Math.pow(2, retries) * 1000;         // 2s, 4s, 8s, 16s\n        const jitter = Math.random() * 1000;                   // 0–1000ms\n        const delay = Math.min(baseDelay + jitter, 32_000);    // cap at 32s\n        onRetry?.(retries, maxRetries, delay);\n        console.warn(`[withRetry] Attempt ${retries}/${maxRetries} failed (${status || msg.slice(0, 60)}). Retrying in ${(delay / 1000).toFixed(1)}s...`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        continue;\n      }\n      throw err;\n    }\n  }\n  throw new Error(\"Maximum retries reached\");\n};\n\n/**\n * Gemini-aware retry wrapper: runs `withRetry` first, and if all retries fail\n * with a retryable error, rotates to the fallback API key and retries once more.\n */\nexport const withGeminiRetry = async <T,>(\n  fn: () => Promise<T>,\n  maxRetries = 5,\n  onRetry?: (attempt: number, maxAttempts: number, delayMs: number) => void,\n): Promise<T> => {\n  try {\n    return await withRetry(fn, maxRetries, onRetry);\n  } catch (err: any) {\n    const msg = (err.message || '').toLowerCase();\n    const status = err.status || err.httpStatusCode || 0;\n    const isRetryable =\n      status === 429 || status === 500 || status === 503 ||\n      msg.includes('429') || msg.includes('500') || msg.includes('503') ||\n      msg.includes('overloaded') || msg.includes('unavailable') ||\n      msg.includes('resource_exhausted') || msg.includes('rate limit') ||\n      msg.includes('rate_limit') || msg.includes('too many requests') ||\n      msg.includes('internal server error') || msg.includes('high demand');\n\n    if (isRetryable && rotateGeminiKey()) {\n      console.warn('[withGeminiRetry] Primary key exhausted, retrying with fallback key...');\n      return await withRetry(fn, maxRetries, onRetry);\n    }\n    throw err;\n  }\n};\n\n// ─────────────────────────────────────────────────────────────────\n// Claude API (Anthropic) — used for all text intelligence\n// Supports prompt caching via cache_control on system + message blocks.\n// ─────────────────────────────────────────────────────────────────\n\nconst CLAUDE_MODEL = 'claude-sonnet-4-6';\nconst CLAUDE_MAX_TOKENS = 64000;\n\n// Minimum tokens for Sonnet caching (1,024 tokens ≈ ~4,000 chars)\nconst CACHE_MIN_CHARS = 4000;\n\ninterface ClaudeContentBlock {\n  type: string;\n  text?: string;\n  source?: { type: string; media_type?: string; data?: string; file_id?: string };\n  title?: string;\n  cache_control?: { type: 'ephemeral' };\n}\n\ninterface ClaudeSystemBlock {\n  type: 'text';\n  text: string;\n  cache_control?: { type: 'ephemeral' };\n}\n\nexport interface ClaudeUsage {\n  input_tokens: number;\n  output_tokens: number;\n  cache_creation_input_tokens?: number;\n  cache_read_input_tokens?: number;\n}\n\ninterface ClaudeResponse {\n  content: Array<{ type: string; text: string }>;\n  usage: ClaudeUsage;\n}\n\n/** A message in a multi-turn conversation for the Claude messages API */\nexport interface ClaudeMessage {\n  role: 'user' | 'assistant';\n  content: string | ClaudeContentBlock[];\n}\n\n/** System block with optional caching */\nexport interface SystemBlock {\n  text: string;\n  cache?: boolean;\n}\n\ninterface CallClaudeOptions {\n  document?: { base64: string; mediaType: string };\n  system?: string;\n  maxTokens?: number;\n  /** Sampling temperature (0–1). Default: 1 (API default). Use lower values for deterministic/analytical tasks. */\n  temperature?: number;\n  /** Structured system blocks with per-block cache control (overrides `system` string) */\n  systemBlocks?: SystemBlock[];\n  /** Multi-turn messages array (overrides single-prompt `prompt` arg). Last user message auto-gets cache_control. */\n  messages?: ClaudeMessage[];\n  /** AbortSignal for cancelling the request */\n  signal?: AbortSignal;\n}\n\n/**\n * Call Claude API directly via fetch (browser-compatible, no Node.js SDK needed).\n * Supports text-only, document analysis (PDF), general-purpose prompting,\n * and prompt caching via `systemBlocks` and `messages` options.\n *\n * @param prompt  - The text prompt to send (ignored when `options.messages` is provided)\n * @param options - Optional: document, system prompt, max tokens, caching controls\n *\n * Backward compatible: `callClaude(prompt, { base64, mediaType })` still works.\n */\nexport async function callClaude(\n  prompt: string,\n  options?: CallClaudeOptions | { base64: string; mediaType: string }\n): Promise<{ text: string; usage: ClaudeUsage }> {\n  const apiKey = process.env.ANTHROPIC_API_KEY;\n  if (!apiKey) throw new Error('ANTHROPIC_API_KEY is not configured');\n\n  // Normalize legacy 2-arg calls: callClaude(prompt, { base64, mediaType })\n  let document: { base64: string; mediaType: string } | undefined;\n  let system: string | undefined;\n  let maxTokens = CLAUDE_MAX_TOKENS;\n  let temperature: number | undefined;\n  let systemBlocks: SystemBlock[] | undefined;\n  let messages: ClaudeMessage[] | undefined;\n  let signal: AbortSignal | undefined;\n\n  if (options && 'base64' in options && 'mediaType' in options) {\n    // Legacy format: direct document object\n    document = options as { base64: string; mediaType: string };\n  } else if (options) {\n    const opts = options as CallClaudeOptions;\n    document = opts.document;\n    system = opts.system;\n    maxTokens = opts.maxTokens ?? CLAUDE_MAX_TOKENS;\n    temperature = opts.temperature;\n    systemBlocks = opts.systemBlocks;\n    messages = opts.messages;\n    signal = opts.signal;\n  }\n\n  // ── Build system prompt ──\n  let systemPayload: string | ClaudeSystemBlock[] | undefined;\n\n  if (systemBlocks && systemBlocks.length > 0) {\n    // Structured system blocks with per-block cache control\n    systemPayload = systemBlocks.map(block => {\n      const b: ClaudeSystemBlock = { type: 'text', text: block.text };\n      if (block.cache && block.text.length >= CACHE_MIN_CHARS) {\n        b.cache_control = { type: 'ephemeral' };\n      }\n      return b;\n    });\n  } else if (system) {\n    // Plain string system prompt — auto-cache if large enough\n    if (system.length >= CACHE_MIN_CHARS) {\n      systemPayload = [{ type: 'text' as const, text: system, cache_control: { type: 'ephemeral' as const } }];\n    } else {\n      systemPayload = system;\n    }\n  }\n\n  // ── Build messages ──\n  let messagesPayload: Array<{ role: string; content: string | ClaudeContentBlock[] }>;\n\n  if (messages && messages.length > 0) {\n    // Multi-turn messages — add cache_control to last user message\n    messagesPayload = messages.map((msg, i) => {\n      // Find if this is the last user message\n      const isLastUser = msg.role === 'user' &&\n        !messages!.slice(i + 1).some(m => m.role === 'user');\n\n      if (isLastUser && typeof msg.content === 'string') {\n        // Wrap string content to add cache_control\n        return {\n          role: msg.role,\n          content: [{\n            type: 'text',\n            text: msg.content,\n            cache_control: { type: 'ephemeral' as const },\n          }],\n        };\n      } else if (isLastUser && Array.isArray(msg.content)) {\n        // Add cache_control to the last block in the content array\n        const blocks = [...msg.content];\n        const lastBlock = { ...blocks[blocks.length - 1] };\n        lastBlock.cache_control = { type: 'ephemeral' };\n        blocks[blocks.length - 1] = lastBlock;\n        return { role: msg.role, content: blocks };\n      }\n      return msg;\n    });\n  } else {\n    // Single-prompt fallback (original behavior)\n    const content: ClaudeContentBlock[] = [];\n    if (document) {\n      content.push({\n        type: 'document',\n        source: { type: 'base64', media_type: document.mediaType, data: document.base64 },\n      });\n    }\n    content.push({ type: 'text', text: prompt });\n    messagesPayload = [{ role: 'user', content }];\n  }\n\n  const body: Record<string, any> = {\n    model: CLAUDE_MODEL,\n    max_tokens: maxTokens,\n    messages: messagesPayload,\n  };\n\n  if (temperature != null) {\n    body.temperature = temperature;\n  }\n\n  if (systemPayload) {\n    body.system = systemPayload;\n  }\n\n  const response = await withRetry(async () => {\n    const res = await fetch('https://api.anthropic.com/v1/messages', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-api-key': apiKey,\n        'anthropic-version': '2023-06-01',\n        'anthropic-beta': 'files-api-2025-04-14',\n        'anthropic-dangerous-direct-browser-access': 'true',\n      },\n      body: JSON.stringify(body),\n      signal,\n    });\n\n    if (!res.ok) {\n      const errorBody = await res.text();\n      throw new Error(`Claude API error ${res.status}: ${errorBody}`);\n    }\n\n    return await res.json() as ClaudeResponse;\n  });\n\n  // Log cache performance\n  const { cache_creation_input_tokens, cache_read_input_tokens, input_tokens } = response.usage;\n  if (cache_creation_input_tokens || cache_read_input_tokens) {\n    console.debug(\n      `[Claude] cache_read: ${cache_read_input_tokens ?? 0}, cache_write: ${cache_creation_input_tokens ?? 0}, uncached: ${input_tokens}`\n    );\n  }\n\n  // Extract text from response\n  const textBlocks = response.content.filter(b => b.type === 'text');\n  return {\n    text: textBlocks.map(b => b.text).join('\\n') || '',\n    usage: response.usage,\n  };\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Anthropic Files API (beta) — upload once, reference by file_id\n// ─────────────────────────────────────────────────────────────────\n\ninterface FilesAPIResponse {\n  id: string;\n  type: 'file';\n  filename: string;\n  mime_type: string;\n  size_bytes: number;\n  created_at: string;\n}\n\n/**\n * Upload text content to the Anthropic Files API.\n * Returns the file_id for referencing in subsequent Messages requests.\n */\nexport async function uploadToFilesAPI(\n  content: string | Blob | File,\n  filename: string,\n  mimeType: string = 'text/plain',\n): Promise<string> {\n  const apiKey = process.env.ANTHROPIC_API_KEY;\n  if (!apiKey) throw new Error('ANTHROPIC_API_KEY is not configured');\n\n  const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });\n  const formData = new FormData();\n  formData.append('file', blob, filename);\n\n  const res = await fetch('/api/anthropic-files', {\n    method: 'POST',\n    headers: {\n      'x-api-key': apiKey,\n      'anthropic-version': '2023-06-01',\n      'anthropic-beta': 'files-api-2025-04-14',\n      'anthropic-dangerous-direct-browser-access': 'true',\n    },\n    body: formData,\n  });\n\n  if (!res.ok) {\n    const errorBody = await res.text();\n    throw new Error(`Files API upload error ${res.status}: ${errorBody}`);\n  }\n\n  const data = await res.json() as FilesAPIResponse;\n  console.debug(`[FilesAPI] Uploaded \"${filename}\" → ${data.id} (${data.size_bytes} bytes)`);\n  return data.id;\n}\n\n/**\n * Generate a complete custom style (palette, fonts, identity) from a user-provided name and\n * free-form description using Claude. The description can be anything — specific color/font\n * requests, a vague mood, a reference to an era, or even gibberish. The AI extracts whatever\n * is usable and fills in the rest with sensible design choices.\n *\n * Returns the generated fields or throws on failure.\n */\nexport async function generateStyleWithAI(\n  name: string,\n  description: string,\n  signal?: AbortSignal\n): Promise<{ palette: Palette; fonts: FontPair; identity: string }> {\n  const system = `You are a visual design expert specializing in presentation and infographic styles. A user wants to create a custom visual style. They have provided a style name and a free-form description.\n\nThe description may contain ANY combination of:\n- Specific color requests (e.g. hex codes, color names, \"blue and gold\")\n- Font preferences (e.g. \"use Helvetica\", \"something modern\")\n- Mood/era references (e.g. \"Art Deco\", \"minimalist Japanese\", \"90s retro\")\n- Detailed identity descriptions\n- Vague wishes (e.g. \"make it look professional\")\n- Partial information (e.g. only colors, only fonts, etc.)\n- Gibberish or irrelevant text\n\nYour job:\n1. Extract any usable design intent from the description\n2. Research the design references mentioned — recall relevant color theory, typography pairings, historical design movements, brand aesthetics, or cultural associations that apply to the user's description\n3. Use your research to make informed, intentional design choices rather than generic defaults\n4. For anything not specified or not usable, make excellent design choices that are coherent with whatever WAS specified\n5. If the entire description is gibberish or empty, create a clean, professional style inspired by the style name alone\n6. Always produce a complete, cohesive style — never leave fields empty or default\n\nReturn ONLY valid JSON with no markdown fencing, no explanation, in this exact structure:\n{\n  \"palette\": {\n    \"background\": \"<hex>\",\n    \"primary\": \"<hex>\",\n    \"secondary\": \"<hex>\",\n    \"accent\": \"<hex>\",\n    \"text\": \"<hex>\"\n  },\n  \"fonts\": {\n    \"primary\": \"<Google Font name for titles>\",\n    \"secondary\": \"<Google Font name for body text>\"\n  },\n  \"identity\": \"<40-80 word visual identity description that describes shapes, textures, layout style, mood, and specific design rules>\"\n}\n\nRules:\n- All palette colors must be valid 6-digit hex codes with # prefix\n- Choose fonts available on Google Fonts\n- Ensure sufficient contrast between background and text colors\n- The identity must be specific and actionable — describe shapes, space usage, textures, mood, and layout rules\n- If the user mentioned specific colors or fonts, honor them; fill in the rest to complement\n- If the user provided an identity-like description, refine and expand it into a proper identity`;\n\n  const prompt = `Style name: ${name}\\n\\nUser description:\\n${description}`;\n  const { text } = await callClaude(prompt, { system, maxTokens: 500, signal });\n\n  // Parse the JSON response (handle possible markdown fencing)\n  let cleaned = text.trim();\n  if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/^```(?:json)?\\s*/, '').replace(/\\s*```$/, '');\n  }\n\n  const parsed = JSON.parse(cleaned);\n\n  // Validate structure\n  if (!parsed.palette || !parsed.fonts || !parsed.identity) {\n    throw new Error('AI response missing required fields');\n  }\n  for (const key of ['background', 'primary', 'secondary', 'accent', 'text']) {\n    if (typeof parsed.palette[key] !== 'string' || !/^#[0-9A-Fa-f]{6}$/.test(parsed.palette[key])) {\n      throw new Error(`Invalid palette color for ${key}: ${parsed.palette[key]}`);\n    }\n  }\n  if (!parsed.fonts.primary || !parsed.fonts.secondary) {\n    throw new Error('AI response missing font names');\n  }\n\n  return {\n    palette: {\n      background: parsed.palette.background,\n      primary: parsed.palette.primary,\n      secondary: parsed.palette.secondary,\n      accent: parsed.palette.accent,\n      text: parsed.palette.text,\n    },\n    fonts: {\n      primary: String(parsed.fonts.primary).trim(),\n      secondary: String(parsed.fonts.secondary).trim(),\n    },\n    identity: String(parsed.identity).trim(),\n  };\n}\n\n/**\n * Delete a file from the Anthropic Files API.\n */\nexport async function deleteFromFilesAPI(fileId: string): Promise<void> {\n  const apiKey = process.env.ANTHROPIC_API_KEY;\n  if (!apiKey) return; // silent no-op if no key\n\n  try {\n    const res = await fetch(`/api/anthropic-files/${fileId}`, {\n      method: 'DELETE',\n      headers: {\n        'x-api-key': apiKey,\n        'anthropic-version': '2023-06-01',\n        'anthropic-beta': 'files-api-2025-04-14',\n        'anthropic-dangerous-direct-browser-access': 'true',\n      },\n    });\n    if (res.ok) {\n      console.debug(`[FilesAPI] Deleted file ${fileId}`);\n    } else {\n      console.warn(`[FilesAPI] Failed to delete file ${fileId}: ${res.status}`);\n    }\n  } catch (err) {\n    console.warn(`[FilesAPI] Delete failed for ${fileId}:`, err);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\autoDeck\\constants.ts","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.7.","line":76,"column":67,"nodeType":"Literal","messageId":"noMagic","endLine":76,"endColumn":70},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 1.3.","line":77,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":77,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AutoDeckLod, DetailLevel } from '../../types';\n\n// ── Level of Detail configuration ──\n\nexport interface LodConfig {\n  name: AutoDeckLod;\n  label: string;\n  wordCountMin: number;\n  wordCountMax: number;\n  midpoint: number;\n  detailLevel: DetailLevel;\n}\n\nexport const AUTO_DECK_LOD_LEVELS: Record<AutoDeckLod, LodConfig> = {\n  executive: {\n    name: 'executive',\n    label: 'Executive',\n    wordCountMin: 70,\n    wordCountMax: 100,\n    midpoint: 85,\n    detailLevel: 'Executive',\n  },\n  standard: {\n    name: 'standard',\n    label: 'Standard',\n    wordCountMin: 200,\n    wordCountMax: 250,\n    midpoint: 225,\n    detailLevel: 'Standard',\n  },\n  detailed: {\n    name: 'detailed',\n    label: 'Detailed',\n    wordCountMin: 450,\n    wordCountMax: 500,\n    midpoint: 475,\n    detailLevel: 'Detailed',\n  },\n};\n\n// ── Limits ──\n\nexport const AUTO_DECK_LIMITS = {\n  maxRevisions: 5,\n  maxCardsWarning: 40,\n  minCards: 3,\n} as const;\n\n// ── Briefing field limits ──\n\nexport const BRIEFING_LIMITS = {\n  audience: 100,\n  type: 80,\n  objective: 150,\n  tone: 80,\n  focus: 120,\n} as const;\n\n// ── Helpers ──\n\n/** Rough card count estimate from total word count and LOD. */\nexport function estimateCardCount(\n  totalWordCount: number,\n  lod: AutoDeckLod,\n): { estimate: number; min: number; max: number } {\n  const lodConfig = AUTO_DECK_LOD_LEVELS[lod];\n\n  // Simple division: total words / LOD midpoint\n  const rawEstimate = Math.round(totalWordCount / lodConfig.midpoint);\n\n  // Clamp to minimum\n  const clamped = Math.max(AUTO_DECK_LIMITS.minCards, rawEstimate);\n\n  return {\n    estimate: clamped,\n    min: Math.max(AUTO_DECK_LIMITS.minCards, Math.floor(clamped * 0.7)),\n    max: Math.ceil(clamped * 1.3),\n  };\n}\n\n/** Count words in a string (simple whitespace split) */\nexport function countWords(text: string): number {\n  return text.trim().split(/\\s+/).filter(Boolean).length;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\autoDeck\\parsers.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 23 to the 15 allowed.","line":35,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":35,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1345,1348],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1345,1348],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2927,2930],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2927,2930],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3147,3150],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3147,3150],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4686,4689],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4686,4689],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4891,4894],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4891,4894],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5619,5622],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5619,5622],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":175,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6941,6944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6941,6944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":183,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7186,7189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7186,7189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ParsedPlan, PlanQuestion, ConflictItem, AutoDeckLod } from '../../types';\n\n// ── JSON extraction helper ──\n\n/**\n * Extract a JSON object from a response string.\n * Handles: raw JSON, markdown code fences (```json ... ```), and leading/trailing text.\n */\nfunction extractJson(raw: string): string {\n  let text = raw.trim();\n\n  // Strip markdown code fences\n  const fenceMatch = text.match(/```(?:json)?\\s*\\n?([\\s\\S]*?)\\n?\\s*```/);\n  if (fenceMatch) {\n    text = fenceMatch[1].trim();\n  }\n\n  // Find the outermost JSON object\n  const firstBrace = text.indexOf('{');\n  const lastBrace = text.lastIndexOf('}');\n  if (firstBrace !== -1 && lastBrace > firstBrace) {\n    text = text.substring(firstBrace, lastBrace + 1);\n  }\n\n  return text;\n}\n\n// ── Planner response parser ──\n\ntype PlannerResult =\n  | { status: 'ok'; plan: ParsedPlan }\n  | { status: 'conflict'; conflicts: ConflictItem[] }\n  | { status: 'error'; error: string };\n\nexport function parsePlannerResponse(raw: string): PlannerResult {\n  try {\n    const json = JSON.parse(extractJson(raw));\n\n    if (json.status === 'conflict') {\n      if (!Array.isArray(json.conflicts) || json.conflicts.length === 0) {\n        return { status: 'error', error: 'Planner returned conflict status but no conflicts array.' };\n      }\n      const conflicts: ConflictItem[] = json.conflicts.map((c: any) => ({\n        description: String(c.description || ''),\n        sourceA: {\n          document: String(c.sourceA?.document || c.source_a?.document || ''),\n          section: String(c.sourceA?.section || c.source_a?.section || ''),\n        },\n        sourceB: {\n          document: String(c.sourceB?.document || c.source_b?.document || ''),\n          section: String(c.sourceB?.section || c.source_b?.section || ''),\n        },\n        severity: (['high', 'medium', 'low'].includes(c.severity) ? c.severity : 'medium') as ConflictItem['severity'],\n      }));\n      return { status: 'conflict', conflicts };\n    }\n\n    if (json.status === 'ok') {\n      const meta = json.metadata;\n      if (!meta || !Array.isArray(json.cards)) {\n        return { status: 'error', error: 'Planner response missing metadata or cards array.' };\n      }\n\n      const parsedPlan: ParsedPlan = {\n        metadata: {\n          category: String(meta.category || ''),\n          lod: String(meta.lod || '') as AutoDeckLod,\n          sourceWordCount: Number(meta.sourceWordCount || meta.source_word_count || 0),\n          cardCount: Number(meta.cardCount || meta.card_count || json.cards.length),\n          documentStrategy: (['dissolve', 'preserve', 'hybrid'].includes(meta.documentStrategy || meta.document_strategy)\n            ? (meta.documentStrategy || meta.document_strategy)\n            : 'dissolve') as ParsedPlan['metadata']['documentStrategy'],\n          documentRelationships: String(meta.documentRelationships || meta.document_relationships || ''),\n        },\n        cards: json.cards.map((c: any) => ({\n          number: Number(c.number || 0),\n          title: String(c.title || ''),\n          description: String(c.description || ''),\n          sources: Array.isArray(c.sources)\n            ? c.sources.map((s: any) => ({\n                document: String(s.document || ''),\n                // Support both new (heading/fallbackDescription) and legacy (section) formats\n                ...(s.section ? { section: String(s.section) } : {}),\n                ...(s.heading ? { heading: String(s.heading) } : {}),\n                ...(s.fallbackDescription ? { fallbackDescription: String(s.fallbackDescription) } : {}),\n              }))\n            : [],\n          // Support wordTarget (per-card word count)\n          ...(c.wordTarget != null ? { wordTarget: Number(c.wordTarget) } : {}),\n          // Support keyDataPoints (new format)\n          ...(Array.isArray(c.keyDataPoints) ? { keyDataPoints: c.keyDataPoints.map(String) } : {}),\n          // Support both structured guidance (new) and string guidance (legacy)\n          guidance: typeof c.guidance === 'object' && c.guidance !== null\n            ? {\n                emphasis: String(c.guidance.emphasis || ''),\n                tone: String(c.guidance.tone || ''),\n                exclude: String(c.guidance.exclude || ''),\n              }\n            : String(c.guidance || ''),\n          // Support crossReferences (new format)\n          ...(c.crossReferences != null ? { crossReferences: c.crossReferences === null ? null : String(c.crossReferences) } : {}),\n        })),\n        // Parse planner-generated decision questions (optional — backward compatible)\n        ...(Array.isArray(json.questions) && json.questions.length > 0\n          ? {\n              questions: json.questions.map((q: any): PlanQuestion => ({\n                id: String(q.id || ''),\n                question: String(q.question || ''),\n                options: Array.isArray(q.options)\n                  ? q.options.map((o: any) => ({\n                      key: String(o.key || ''),\n                      label: String(o.label || ''),\n                      producerInstruction: String(o.producerInstruction || ''),\n                    }))\n                  : [],\n                recommendedKey: String(q.recommendedKey || ''),\n                ...(q.context ? { context: String(q.context) } : {}),\n              })),\n            }\n          : {}),\n      };\n\n      if (parsedPlan.cards.length === 0) {\n        return { status: 'error', error: 'Planner returned ok status but no cards.' };\n      }\n\n      return { status: 'ok', plan: parsedPlan };\n    }\n\n    return { status: 'error', error: `Unexpected planner status: ${json.status}` };\n  } catch (err: any) {\n    return { status: 'error', error: `Failed to parse planner response: ${err.message}` };\n  }\n}\n\n// ── Finalizer response parser ──\n\n/**\n * Parse the finalizer response. The finalizer outputs the same plan format\n * as the planner, but should NOT contain questions. If any slip through,\n * we strip them so the producer receives a clean, self-contained plan.\n */\nexport function parseFinalizerResponse(raw: string): PlannerResult {\n  const result = parsePlannerResponse(raw);\n  if (result.status === 'ok' && result.plan.questions) {\n    result.plan.questions = undefined;\n  }\n  return result;\n}\n\n// ── Producer response parser ──\n\nexport interface ProducedCard {\n  number: number;\n  title: string;\n  content: string;\n  wordCount: number;\n}\n\ntype ProducerResult =\n  | { status: 'ok'; cards: ProducedCard[] }\n  | { status: 'error'; error: string };\n\nexport function parseProducerResponse(raw: string): ProducerResult {\n  try {\n    const json = JSON.parse(extractJson(raw));\n\n    // Handle both wrapped { status, cards } and bare array formats\n    const cardsArray = Array.isArray(json) ? json : json.cards;\n\n    if (!Array.isArray(cardsArray) || cardsArray.length === 0) {\n      return { status: 'error', error: 'Producer response missing cards array.' };\n    }\n\n    const cards: ProducedCard[] = cardsArray.map((c: any) => ({\n      number: Number(c.number || 0),\n      title: String(c.title || ''),\n      content: String(c.content || ''),\n      wordCount: Number(c.wordCount || c.word_count || 0),\n    }));\n\n    return { status: 'ok', cards };\n  } catch (err: any) {\n    return { status: 'error', error: `Failed to parse producer response: ${err.message}` };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\documentHash.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":13,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":13,"endColumn":43,"fix":{"range":[481,492],"text":"{return '0';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":22,"column":22,"nodeType":"Literal","messageId":"noMagic","endLine":22,"endColumn":23},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":24,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":24,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import type { UploadedFile } from '../types';\n\n/**\n * Compute a simple hash of the active document set.\n * Used to detect when documents have changed between API calls.\n * Not cryptographic — just a fast comparison hash.\n */\nexport function computeDocumentHash(documents: UploadedFile[]): string {\n  const activeDocs = documents\n    .filter(doc => (doc.content || doc.fileId) && doc.enabled !== false)\n    .sort((a, b) => a.id.localeCompare(b.id));\n\n  if (activeDocs.length === 0) return '0';\n\n  const payload = activeDocs\n    .map(doc => `${doc.id}:${doc.name}:${doc.content || doc.fileId || ''}`)\n    .join('|');\n\n  // djb2 hash — simple, fast, good distribution\n  let hash = 5381;\n  for (let i = 0; i < payload.length; i++) {\n    hash = ((hash << 5) + hash + payload.charCodeAt(i)) | 0;\n  }\n  return hash.toString(36);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\fileProcessing.ts","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":34,"column":32,"nodeType":"Literal","messageId":"noMagic","endLine":34,"endColumn":34},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":34,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":34,"endColumn":47},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":52,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":52,"endColumn":16,"suggestions":[{"fix":{"range":[1697,1799],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":58,"column":49,"nodeType":"Literal","messageId":"defineConstant","endLine":58,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2307,2310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2307,2310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2350,2353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2350,2353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":71,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":71,"endColumn":16,"suggestions":[{"fix":{"range":[2390,2474],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":102,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":102,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":102,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":102,"endColumn":53},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":128,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":128,"endColumn":16,"suggestions":[{"fix":{"range":[4035,4132],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":142,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":142,"endColumn":20,"suggestions":[{"fix":{"range":[4577,4684],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":145,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":145,"endColumn":20,"suggestions":[{"fix":{"range":[4757,4865],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":155,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":155,"endColumn":17,"suggestions":[{"fix":{"range":[5112,5208],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":162,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":162,"endColumn":40},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 9.","line":162,"column":52,"nodeType":"Literal","messageId":"noMagic","endLine":162,"endColumn":53},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":191,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":191,"endColumn":18,"suggestions":[{"fix":{"range":[6152,6243],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":206,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6781,6784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6781,6784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":207,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6826,6829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6826,6829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":210,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":210,"endColumn":18,"suggestions":[{"fix":{"range":[6870,6951],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":217,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":217,"endColumn":19,"suggestions":[{"fix":{"range":[7191,7296],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":217,"column":106,"nodeType":"Literal","messageId":"noMagic","endLine":217,"endColumn":109},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":225,"column":44,"nodeType":"Literal","messageId":"noMagic","endLine":225,"endColumn":46},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":225,"column":58,"nodeType":"Literal","messageId":"noMagic","endLine":225,"endColumn":59},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":230,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":230,"endColumn":18,"suggestions":[{"fix":{"range":[7660,7769],"text":""},"messageId":"removeConsole","data":{"propertyName":"debug"},"desc":"Remove the console.debug()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":233,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":233,"endColumn":17,"suggestions":[{"fix":{"range":[7813,7921],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport * as pdfjsLib from 'pdfjs-dist';\nimport { BookmarkSource, Heading, UploadedFile } from '../types';\nimport { getGeminiAI, withGeminiRetry } from './ai';\nimport { parseMarkdownStructure } from './markdown';\nimport { extractBookmarksFromPdf, flattenBookmarks, headingsToBookmarks } from './pdfBookmarks';\nimport { HEADING_EXTRACTION_PROMPT, PDF_CONVERSION_PROMPT } from './prompts/documentConversion';\n\n// Ensure pdf.js worker is configured (may already be set by PdfViewer, but safe to repeat)\nif (!pdfjsLib.GlobalWorkerOptions.workerSrc) {\n  pdfjsLib.GlobalWorkerOptions.workerSrc = new URL(\n    'pdfjs-dist/build/pdf.worker.min.mjs',\n    import.meta.url,\n  ).toString();\n}\n\n// ── Helpers ──\n\nfunction fileToBase64(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.readAsDataURL(file);\n    reader.onload = () => resolve((reader.result as string).split(',')[1]);\n    reader.onerror = reject;\n  });\n}\n\n/**\n * Create a placeholder UploadedFile immediately from a File object.\n * Shows in the UI right away while the actual conversion runs.\n */\nexport function createPlaceholderDocument(file: File): UploadedFile {\n  return {\n    id: Math.random().toString(36).substr(2, 9),\n    name: file.name,\n    size: file.size,\n    type: file.type,\n    lastModified: file.lastModified,\n    status: 'processing',\n    progress: 0,\n  };\n}\n\n// ── Gemini PDF Conversion ──\n\n/**\n * Convert a PDF to well-structured Markdown via Gemini Flash.\n * Handles text, tables, charts (→ markdown tables), diagrams (→ descriptions).\n */\nasync function convertPdfWithGemini(file: File): Promise<string> {\n  const base64 = await fileToBase64(file);\n  console.debug(`[FileProcessing] PDF base64 ready (${base64.length} chars), sending to Gemini Flash…`);\n\n  const response = await withGeminiRetry(async () => {\n    return await getGeminiAI().models.generateContent({\n      model: 'gemini-2.5-flash',\n      contents: [{ parts: [\n        { inlineData: { data: base64, mimeType: 'application/pdf' } },\n        { text: PDF_CONVERSION_PROMPT },\n      ]}],\n      config: { httpOptions: { timeout: 300000 } },\n    });\n  });\n\n  // Filter out thinking parts (Gemini 2.5 may include thought tokens)\n  const text = response.candidates?.[0]?.content?.parts\n    ?.filter((p: any) => p.text && !p.thought)\n    .map((p: any) => p.text)\n    .join('') || '';\n\n  console.debug(`[FileProcessing] Gemini conversion complete (${text.length} chars)`);\n  return text;\n}\n\n// ── Main Conversion Pipeline ──\n\n/**\n * Full conversion pipeline:\n * - MD: passthrough (read text directly, no API call)\n * - PDF: converted to Markdown via Gemini Flash\n */\nexport async function processFileToDocument(\n  file: File,\n  id?: string,\n): Promise<UploadedFile> {\n  const isMd = file.name.endsWith('.md') || file.type === 'text/markdown';\n  const isPdf = file.name.endsWith('.pdf') || file.type === 'application/pdf';\n\n  let markdown = '';\n\n  if (isMd) {\n    markdown = await file.text();\n  } else if (isPdf) {\n    markdown = await convertPdfWithGemini(file);\n  } else {\n    throw new Error(`Unsupported file type: ${file.name}`);\n  }\n\n  const structure = parseMarkdownStructure(markdown);\n\n  return {\n    id: id ?? Math.random().toString(36).substr(2, 9),\n    name: file.name,\n    size: file.size,\n    type: file.type,\n    lastModified: file.lastModified,\n    content: markdown,\n    structure,\n    status: 'ready',\n    progress: 100,\n    originalFormat: isMd ? 'md' : 'pdf',\n    createdAt: Date.now(),\n    originalName: file.name,\n    version: 1,\n    sourceOrigin: { type: 'uploaded' as const, timestamp: Date.now() },\n  };\n}\n\n// ── Native PDF path (no markdown conversion) ──\n\n/**\n * Process a PDF for native storage (no markdown conversion).\n * Bookmark-first extraction: tries pdf.js getOutline() first (free & instant),\n * falls back to Gemini heading extraction if no bookmarks found.\n */\nexport async function processNativePdf(file: File, id?: string): Promise<UploadedFile> {\n  const base64 = await fileToBase64(file);\n  console.debug(`[FileProcessing] Native PDF base64 ready: ${file.name} (${base64.length} chars)`);\n\n  // Attempt bookmark-first extraction via pdf.js\n  let bookmarkSource: BookmarkSource = 'manual';\n  let bookmarks: import('../types').BookmarkNode[] = [];\n\n  try {\n    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));\n    const pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;\n\n    bookmarks = await extractBookmarksFromPdf(pdfDoc);\n\n    if (bookmarks.length > 0) {\n      bookmarkSource = 'pdf_bookmarks';\n      console.debug(`[FileProcessing] Extracted ${bookmarks.length} bookmarks from PDF outline: \"${file.name}\"`);\n    } else {\n      // No embedded bookmarks — fall back to Gemini\n      console.debug(`[FileProcessing] No PDF bookmarks found, falling back to Gemini extraction: \"${file.name}\"`);\n      const headings = await extractHeadingsWithGemini(file);\n      if (headings.length > 0) {\n        bookmarks = headingsToBookmarks(headings);\n        bookmarkSource = 'ai_generated';\n      }\n    }\n\n    pdfDoc.destroy();\n  } catch (err) {\n    console.warn('[FileProcessing] Bookmark extraction failed, continuing without bookmarks:', err);\n  }\n\n  // Build flat structure for backward compat\n  const structure = flattenBookmarks(bookmarks);\n\n  return {\n    id: id ?? Math.random().toString(36).substr(2, 9),\n    name: file.name,\n    size: file.size,\n    type: file.type,\n    lastModified: file.lastModified,\n    sourceType: 'native-pdf',\n    pdfBase64: base64,\n    bookmarks,\n    bookmarkSource,\n    structure,\n    status: 'ready',\n    progress: 100,\n    createdAt: Date.now(),\n    originalName: file.name,\n    version: 1,\n    sourceOrigin: { type: 'uploaded' as const, timestamp: Date.now() },\n  };\n}\n\n// ── Gemini Heading Extraction (for native PDF path) ──\n\n/**\n * Extract heading/bookmark structure from a PDF via Gemini Flash.\n * Returns Heading[] with page numbers, or empty array on failure.\n * Used by the \"Keep as PDF\" upload path.\n */\nexport async function extractHeadingsWithGemini(file: File): Promise<Heading[]> {\n  try {\n    const base64 = await fileToBase64(file);\n    console.debug(`[FileProcessing] Extracting headings via Gemini Flash for \"${file.name}\"…`);\n\n    const response = await withGeminiRetry(async () => {\n      return await getGeminiAI().models.generateContent({\n        model: 'gemini-2.5-flash',\n        contents: [{ parts: [\n          { inlineData: { data: base64, mimeType: 'application/pdf' } },\n          { text: HEADING_EXTRACTION_PROMPT },\n        ]}],\n        config: { httpOptions: { timeout: 300000 } },\n      });\n    });\n\n    // Filter out thinking parts (Gemini 2.5 may include thought tokens)\n    const text = response.candidates?.[0]?.content?.parts\n      ?.filter((p: any) => p.text && !p.thought)\n      .map((p: any) => p.text)\n      .join('') || '';\n\n    console.debug(`[FileProcessing] Gemini heading response (${text.length} chars)`);\n\n    // Parse JSON response — Gemini may wrap it in markdown fences\n    const cleaned = text.replace(/```(?:json)?\\s*/g, '').replace(/```\\s*/g, '').trim();\n    const arrayMatch = cleaned.match(/\\[[\\s\\S]*\\]/);\n\n    if (!arrayMatch) {\n      console.warn('[FileProcessing] No heading array found in Gemini response. Raw:', text.substring(0, 500));\n      return [];\n    }\n\n    const parsed = JSON.parse(arrayMatch[0]) as Array<{ level: number; title: string; page?: number }>;\n    const headings: Heading[] = parsed.map((entry, i) => ({\n      level: entry.level,\n      text: entry.title,\n      id: `h-${i}-${Math.random().toString(36).substr(2, 4)}`,\n      selected: false,\n      page: entry.page,\n    }));\n\n    console.debug(`[FileProcessing] Gemini heading extraction: ${headings.length} headings from \"${file.name}\"`);\n    return headings;\n  } catch (err) {\n    console.warn('[FileProcessing] Gemini heading extraction failed, user can create bookmarks manually:', err);\n    return [];\n  }\n}\n\n// ── Utilities ──\n\n/**\n * Convert a base64 string to a Blob. Useful for re-uploading native PDFs.\n */\nexport function base64ToBlob(base64: string, mimeType: string = 'application/pdf'): Blob {\n  const byteChars = atob(base64);\n  const byteNumbers = new Array(byteChars.length);\n  for (let i = 0; i < byteChars.length; i++) {\n    byteNumbers[i] = byteChars.charCodeAt(i);\n  }\n  return new Blob([new Uint8Array(byteNumbers)], { type: mimeType });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\formatTime.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'formatTimestamp' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":25},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":5,"column":12,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":5,"endColumn":23,"fix":{"range":[138,149],"text":"{return '—';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60000.","line":9,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":9,"endColumn":45},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3600000.","line":10,"column":41,"nodeType":"Literal","messageId":"noMagic","endLine":10,"endColumn":48},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 86400000.","line":11,"column":40,"nodeType":"Literal","messageId":"noMagic","endLine":11,"endColumn":48},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":13,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":13,"endColumn":39,"fix":{"range":[422,440],"text":"{return 'Just now';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 60.","line":14,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":14,"endColumn":20},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":14,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":14,"endColumn":48,"fix":{"range":[462,488],"text":"{return `${diffMins}m ago`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 24.","line":15,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":15,"endColumn":21},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":15,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":15,"endColumn":50,"fix":{"range":[511,538],"text":"{return `${diffHours}h ago`;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 7.","line":16,"column":18,"nodeType":"Literal","messageId":"noMagic","endLine":16,"endColumn":19},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":16,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":16,"endColumn":47,"fix":{"range":[559,585],"text":"{return `${diffDays}d ago`;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":24,"column":12,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":24,"endColumn":23,"fix":{"range":[806,817],"text":"{return '—';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":31,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":31,"endColumn":27},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":32,"column":19,"nodeType":"Literal","messageId":"noMagic","endLine":32,"endColumn":21},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":32,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":32,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":6,"source":"/**\n * Relative timestamp for display (e.g. \"5m ago\", \"2d ago\", \"Jan 15\").\n */\nfunction formatTimestamp(ts?: number): string {\n  if (!ts) return '—';\n  const date = new Date(ts);\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 1) return 'Just now';\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  if (diffDays < 7) return `${diffDays}d ago`;\n  return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });\n}\n\n/**\n * Full timestamp in fixed format: \"03 Jan 2026 6:12 PM\".\n */\nexport function formatTimestampFull(ts?: number): string {\n  if (!ts) return '—';\n  const d = new Date(ts);\n  const day = String(d.getDate()).padStart(2, '0');\n  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];\n  const mon = months[d.getMonth()];\n  const year = d.getFullYear();\n  let hours = d.getHours();\n  const ampm = hours >= 12 ? 'PM' : 'AM';\n  hours = hours % 12 || 12;\n  const mins = String(d.getMinutes()).padStart(2, '0');\n  return `${day} ${mon} ${year} ${hours}:${mins} ${ampm}`;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\geometry.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":12,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":12,"endColumn":41,"fix":{"range":[488,502],"text":"{return points;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":80,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":80,"endColumn":32,"fix":{"range":[2475,2486],"text":"{minX = p.x;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":81,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":81,"endColumn":32,"fix":{"range":[2507,2518],"text":"{minY = p.y;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":82,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":82,"endColumn":32,"fix":{"range":[2539,2550],"text":"{maxX = p.x;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":83,"column":21,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":83,"endColumn":32,"fix":{"range":[2571,2582],"text":"{maxY = p.y;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":96,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":96,"endColumn":46,"fix":{"range":[2879,2895],"text":"{return Infinity;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":104,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":104,"endColumn":40,"fix":{"range":[3196,3211],"text":"{minDist = dist;}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":7,"source":"import { NormalizedPoint } from '../types';\n\n/**\n * Ramer-Douglas-Peucker algorithm for simplifying a polyline.\n * Reduces the number of points while preserving the overall shape.\n *\n * @param points - Array of normalized points (0.0-1.0)\n * @param epsilon - Tolerance for simplification (smaller = more detail kept)\n * @returns Simplified array of points\n */\nexport function simplifyPath(points: NormalizedPoint[], epsilon: number = 0.003): NormalizedPoint[] {\n  if (points.length <= 2) return points;\n\n  // Find the point with the maximum distance from the line between start and end\n  let maxDist = 0;\n  let maxIdx = 0;\n  const start = points[0];\n  const end = points[points.length - 1];\n\n  for (let i = 1; i < points.length - 1; i++) {\n    const dist = perpendicularDistance(points[i], start, end);\n    if (dist > maxDist) {\n      maxDist = dist;\n      maxIdx = i;\n    }\n  }\n\n  // If max distance exceeds epsilon, recursively simplify both halves\n  if (maxDist > epsilon) {\n    const left = simplifyPath(points.slice(0, maxIdx + 1), epsilon);\n    const right = simplifyPath(points.slice(maxIdx), epsilon);\n    // Concatenate, removing duplicate point at the junction\n    return [...left.slice(0, -1), ...right];\n  }\n\n  // Otherwise, only keep start and end\n  return [start, end];\n}\n\n/**\n * Calculate perpendicular distance from a point to a line segment.\n */\nfunction perpendicularDistance(\n  point: NormalizedPoint,\n  lineStart: NormalizedPoint,\n  lineEnd: NormalizedPoint\n): number {\n  const dx = lineEnd.x - lineStart.x;\n  const dy = lineEnd.y - lineStart.y;\n  const lenSq = dx * dx + dy * dy;\n\n  if (lenSq === 0) {\n    // Start and end are the same point\n    return Math.sqrt((point.x - lineStart.x) ** 2 + (point.y - lineStart.y) ** 2);\n  }\n\n  // Project point onto line, clamped to segment\n  const t = Math.max(0, Math.min(1, ((point.x - lineStart.x) * dx + (point.y - lineStart.y) * dy) / lenSq));\n  const projX = lineStart.x + t * dx;\n  const projY = lineStart.y + t * dy;\n\n  return Math.sqrt((point.x - projX) ** 2 + (point.y - projY) ** 2);\n}\n\n/**\n * Calculate the bounding box of a set of points.\n */\nexport function getBoundingBox(points: NormalizedPoint[]): {\n  topLeft: NormalizedPoint;\n  bottomRight: NormalizedPoint;\n} {\n  if (points.length === 0) {\n    return { topLeft: { x: 0, y: 0 }, bottomRight: { x: 0, y: 0 } };\n  }\n\n  let minX = Infinity, minY = Infinity;\n  let maxX = -Infinity, maxY = -Infinity;\n\n  for (const p of points) {\n    if (p.x < minX) minX = p.x;\n    if (p.y < minY) minY = p.y;\n    if (p.x > maxX) maxX = p.x;\n    if (p.y > maxY) maxY = p.y;\n  }\n\n  return {\n    topLeft: { x: minX, y: minY },\n    bottomRight: { x: maxX, y: maxY },\n  };\n}\n\n/**\n * Distance from a point to the nearest segment in a polyline.\n */\nexport function distanceToPolyline(point: NormalizedPoint, polyline: NormalizedPoint[]): number {\n  if (polyline.length === 0) return Infinity;\n  if (polyline.length === 1) {\n    return Math.sqrt((point.x - polyline[0].x) ** 2 + (point.y - polyline[0].y) ** 2);\n  }\n\n  let minDist = Infinity;\n  for (let i = 0; i < polyline.length - 1; i++) {\n    const dist = perpendicularDistance(point, polyline[i], polyline[i + 1]);\n    if (dist < minDist) minDist = dist;\n  }\n  return minDist;\n}\n\n/**\n * Distance from a point to a line segment (used for arrow hit testing).\n */\nexport function distanceToSegment(\n  point: NormalizedPoint,\n  segStart: NormalizedPoint,\n  segEnd: NormalizedPoint\n): number {\n  return perpendicularDistance(point, segStart, segEnd);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\markdown.ts","messages":[{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":8,"column":9,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":8,"endColumn":16,"fix":{"range":[245,612],"text":"for (const [index, line] of lines.entries()) {\n    const match = line.match(headingRegex);\n    if (match) {\n      headings.push({\n        level: match[1].length,\n        text: match[2].trim(),\n        id: `h-${index}-${Math.random().toString(36).substr(2, 4)}`,\n        selected: false,\n        startIndex: currentOffset,\n      });\n    }\n    currentOffset += line.length + 1;\n  }"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 36.","line":14,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":14,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":14,"column":64,"nodeType":"Literal","messageId":"noMagic","endLine":14,"endColumn":65},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 39 to the 15 allowed.","line":29,"column":44,"nodeType":null,"messageId":"refactorFunction","endLine":29,"endColumn":46},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":34,"column":46,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":34,"endColumn":53,"fix":{"range":[974,981],"text":"{return;}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":38,"column":56,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":38,"endColumn":63,"fix":{"range":[1082,1148],"text":"() => { for (const c of Array.from(node.childNodes)) walk(c, listDepth) }"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":42,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":42,"endColumn":50,"fix":{"range":[1280,1291],"text":"{md += '\\n';}"}},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":43,"column":15,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":43,"endColumn":49,"fix":{"range":[1306,1340],"text":"`${'#'.repeat(parseInt(tag[1]))  } `"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":48,"column":41,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":48,"endColumn":54,"fix":{"range":[1455,1468],"text":"{md += '\\n\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":67,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":67,"endColumn":50,"fix":{"range":[1962,1973],"text":"{md += '\\n';}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":68,"column":37,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":68,"endColumn":44,"fix":{"range":[1982,2047],"text":"for (const c of Array.from(node.childNodes)) walk(c, listDepth + 1);"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":69,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":69,"endColumn":44,"fix":{"range":[2080,2091],"text":"{md += '\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":79,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":79,"endColumn":44,"fix":{"range":[2468,2479],"text":"{md += '\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":83,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":83,"endColumn":50,"fix":{"range":[2566,2577],"text":"{md += '\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":86,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":86,"endColumn":44,"fix":{"range":[2650,2661],"text":"{md += '\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":89,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":89,"endColumn":50,"fix":{"range":[2735,2746],"text":"{md += '\\n';}"}},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":91,"column":15,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":91,"endColumn":82,"fix":{"range":[2808,2875],"text":"`\\`\\`\\`\\n${  code?.textContent || el.textContent || ''  }\\n\\`\\`\\`\\n\\n`"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":103,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":103,"endColumn":50,"fix":{"range":[3172,3183],"text":"{md += '\\n';}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":105,"column":14,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":105,"endColumn":21,"fix":{"range":[3240,3554],"text":"for (const [ri, tr] of rows.entries()) {\n          const cells = tr.querySelectorAll('td, th');\n          md += '| ' + Array.from(cells).map(c => c.textContent?.trim() || '').join(' | ') + ' |\\n';\n          if (ri === 0) {\n            md += '| ' + Array.from(cells).map(() => '---').join(' | ') + ' |\\n';\n          }\n        }"}},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":107,"column":17,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":107,"endColumn":100,"fix":{"range":[3338,3421],"text":"`| ${  Array.from(cells).map(c => c.textContent?.trim() || '').join(' | ')  } |\\n`"}},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":109,"column":19,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":109,"endColumn":81,"fix":{"range":[3467,3529],"text":"`| ${  Array.from(cells).map(() => '---').join(' | ')  } |\\n`"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":117,"column":49,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":117,"endColumn":55,"fix":{"range":[3726,3732],"text":"{break;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":118,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":118,"endColumn":50,"fix":{"range":[3771,3782],"text":"{md += '\\n';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":120,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":120,"endColumn":44,"fix":{"range":[3835,3846],"text":"{md += '\\n';}"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":128,"column":34,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":128,"endColumn":41,"fix":{"range":[3926,3982],"text":"for (const c of Array.from(tempDiv.childNodes)) walk(c, 0);"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":22,"source":"import { Heading } from '../types';\n\nexport const parseMarkdownStructure = (text: string): Heading[] => {\n  const lines = text.split('\\n');\n  const headings: Heading[] = [];\n  const headingRegex = /^(#{1,6})\\s+(.*)$/;\n  let currentOffset = 0;\n  lines.forEach((line, index) => {\n    const match = line.match(headingRegex);\n    if (match) {\n      headings.push({\n        level: match[1].length,\n        text: match[2].trim(),\n        id: `h-${index}-${Math.random().toString(36).substr(2, 4)}`,\n        selected: false,\n        startIndex: currentOffset,\n      });\n    }\n    currentOffset += line.length + 1;\n  });\n  return headings;\n};\n\nexport const htmlToMarkdown = (html: string): string => {\n  const tempDiv = document.createElement('div');\n  tempDiv.innerHTML = html;\n  let md = '';\n\n  const walk = (node: Node, listDepth = 0) => {\n    if (node.nodeType === Node.TEXT_NODE) {\n      md += node.textContent;\n      return;\n    }\n    if (node.nodeType !== Node.ELEMENT_NODE) return;\n\n    const el = node as HTMLElement;\n    const tag = el.tagName.toLowerCase();\n    const children = () => Array.from(node.childNodes).forEach(c => walk(c, listDepth));\n\n    switch (tag) {\n      case 'h1': case 'h2': case 'h3': case 'h4': case 'h5': case 'h6':\n        if (md && !md.endsWith('\\n')) md += '\\n';\n        md += '#'.repeat(parseInt(tag[1])) + ' ';\n        children();\n        md += '\\n\\n';\n        break;\n      case 'p':\n        if (md && !md.endsWith('\\n\\n')) md += '\\n\\n';\n        children();\n        md += '\\n\\n';\n        break;\n      case 'br':\n        md += '\\n';\n        break;\n      case 'strong': case 'b':\n        md += '**'; children(); md += '**';\n        break;\n      case 'em': case 'i':\n        md += '_'; children(); md += '_';\n        break;\n      case 'a': {\n        const href = el.getAttribute('href') || '';\n        md += '['; children(); md += `](${href})`;\n        break;\n      }\n      case 'ul': case 'ol':\n        if (md && !md.endsWith('\\n')) md += '\\n';\n        Array.from(node.childNodes).forEach(c => walk(c, listDepth + 1));\n        if (!md.endsWith('\\n')) md += '\\n';\n        break;\n      case 'li': {\n        const indent = '  '.repeat(Math.max(0, listDepth - 1));\n        const parent = el.parentElement?.tagName.toLowerCase();\n        const bullet = parent === 'ol'\n          ? `${Array.from(el.parentElement!.children).indexOf(el) + 1}. `\n          : '- ';\n        md += indent + bullet;\n        children();\n        if (!md.endsWith('\\n')) md += '\\n';\n        break;\n      }\n      case 'blockquote':\n        if (md && !md.endsWith('\\n')) md += '\\n';\n        md += '> ';\n        children();\n        if (!md.endsWith('\\n')) md += '\\n';\n        break;\n      case 'pre': {\n        if (md && !md.endsWith('\\n')) md += '\\n';\n        const code = el.querySelector('code');\n        md += '```\\n' + (code?.textContent || el.textContent || '') + '\\n```\\n\\n';\n        break;\n      }\n      case 'code':\n        if (el.parentElement?.tagName.toLowerCase() !== 'pre') {\n          md += '`'; children(); md += '`';\n        }\n        break;\n      case 'hr':\n        md += '\\n---\\n\\n';\n        break;\n      case 'table': {\n        if (md && !md.endsWith('\\n')) md += '\\n';\n        const rows = el.querySelectorAll('tr');\n        rows.forEach((tr, ri) => {\n          const cells = tr.querySelectorAll('td, th');\n          md += '| ' + Array.from(cells).map(c => c.textContent?.trim() || '').join(' | ') + ' |\\n';\n          if (ri === 0) {\n            md += '| ' + Array.from(cells).map(() => '---').join(' | ') + ' |\\n';\n          }\n        });\n        md += '\\n';\n        break;\n      }\n      case 'div':\n        // Skip root title div — not part of markdown content\n        if (el.hasAttribute('data-root-title')) break;\n        if (md && !md.endsWith('\\n')) md += '\\n';\n        children();\n        if (!md.endsWith('\\n')) md += '\\n';\n        break;\n      default:\n        children();\n        break;\n    }\n  };\n\n  Array.from(tempDiv.childNodes).forEach(c => walk(c, 0));\n  return md.trim().replace(/\\n{3,}/g, '\\n\\n');\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\modificationEngine.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":54,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":54,"endColumn":58,"fix":{"range":[2562,2600],"text":"{imageConfig.aspectRatio = aspectRatio;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":55,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":55,"endColumn":54,"fix":{"range":[2619,2654],"text":"{imageConfig.imageSize = resolution;}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2759,2762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2759,2762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":81,"column":14,"nodeType":"Literal","messageId":"defineConstant","endLine":81,"endColumn":42},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":149,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":149,"endColumn":58,"fix":{"range":[5627,5665],"text":"{imageConfig.aspectRatio = aspectRatio;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":150,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":150,"endColumn":54,"fix":{"range":[5684,5719],"text":"{imageConfig.imageSize = resolution;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":206,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":206,"endColumn":41,"fix":{"range":[7175,7190],"text":"{return dataUrl;}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":5,"source":"import { withGeminiRetry, PRO_IMAGE_CONFIG, getGeminiAI } from './ai';\nimport { buildModificationPrompt, buildContentModificationPrompt } from './prompts/imageGeneration';\n\ninterface ModificationRequest {\n  originalImageUrl: string;   // data URL of the original image\n  redlineDataUrl: string;     // data URL of the redline overlay (empty string if no spatial annotations)\n  instructions: string;       // synthesized numbered instruction list\n  cardText: string | null;    // card title context for the prompt\n  aspectRatio?: string;       // e.g. '16:9', '4:3', '1:1', '3:4'\n  resolution?: string;        // e.g. '1K', '2K', '4K'\n}\n\ninterface ModificationResult {\n  newImageUrl: string;  // data URL of the modified image\n}\n\n// TODO: Implement multi-turn chat for iterative image editing.\n// Gemini docs say multi-turn chat is \"the recommended way to iterate on images.\"\n// The @google/genai SDK's ai.chats.create() handles thought signature circulation\n// automatically. Implementation would require:\n// 1. Maintaining a chat session per card+level (store in Card type)\n// 2. Initial card generation becomes the first turn\n// 3. Each annotation modification becomes a follow-up turn (no need to re-send full image)\n// 4. Clear chat session when generating a new card from scratch\n// 5. Handle session expiration gracefully\n// This is a significant architectural change touching useSynthesis, modificationEngine,\n// types.ts, and the annotation workflow. Should be a separate epic.\n\n/**\n * Execute an image modification by sending a multimodal request to Gemini.\n *\n * The request includes:\n * 1. System instruction (style fidelity + literal interpretation) + aggregated instructions\n * 2. Original image (inlineData)\n * 3. Redline map (inlineData)\n *\n * Returns the modified image as a data URL.\n */\nexport async function executeModification(\n  request: ModificationRequest,\n  onUsage?: (entry: { provider: 'gemini'; model: string; inputTokens: number; outputTokens: number }) => void,\n): Promise<ModificationResult> {\n  const { originalImageUrl, redlineDataUrl, instructions, cardText, aspectRatio, resolution } = request;\n\n  // Extract base64 data from data URLs\n  const originalBase64 = extractBase64(originalImageUrl);\n  const originalMime = extractMime(originalImageUrl);\n  const hasRedline = !!redlineDataUrl;\n\n  const systemPrompt = buildModificationPrompt(instructions, cardText, hasRedline);\n\n  // Build imageConfig to preserve resolution & aspect ratio from original generation\n  const imageConfig: Record<string, string> = {};\n  if (aspectRatio) imageConfig.aspectRatio = aspectRatio;\n  if (resolution) imageConfig.imageSize = resolution;\n\n  // Build parts: always include prompt + original image, conditionally include redline\n  const parts: any[] = [\n    { text: systemPrompt },\n    {\n      inlineData: {\n        mimeType: originalMime,\n        data: originalBase64,\n      },\n    },\n  ];\n\n  if (hasRedline) {\n    const redlineBase64 = extractBase64(redlineDataUrl);\n    const redlineMime = extractMime(redlineDataUrl);\n    parts.push({\n      inlineData: {\n        mimeType: redlineMime,\n        data: redlineBase64,\n      },\n    });\n  }\n\n  const response = await withGeminiRetry(async () => {\n    return await getGeminiAI().models.generateContent({\n      model: 'gemini-3-pro-image-preview',\n      contents: [\n        {\n          parts,\n        },\n      ],\n      config: {\n        ...PRO_IMAGE_CONFIG,\n        ...(Object.keys(imageConfig).length > 0 && { imageConfig }),\n      },\n    });\n  });\n\n  // Record Gemini usage\n  if (response.usageMetadata) {\n    onUsage?.({\n      provider: 'gemini',\n      model: 'gemini-3-pro-image-preview',\n      inputTokens: response.usageMetadata.promptTokenCount ?? 0,\n      outputTokens: response.usageMetadata.candidatesTokenCount ?? 0,\n    });\n  }\n\n  // Extract the modified image from the response\n  let newImageUrl = '';\n  if (response.candidates && response.candidates[0]?.content?.parts) {\n    for (const part of response.candidates[0].content.parts) {\n      if (part.inlineData) {\n        newImageUrl = `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;\n        break;\n      }\n    }\n  }\n\n  if (!newImageUrl) {\n    throw new Error('AI did not return a modified image. The model may have returned text instead of an image. Please try again with clearer instructions.');\n  }\n\n  return { newImageUrl };\n}\n\n/**\n * Content-only regeneration: sends the original image as a style/layout reference\n * alongside updated text content. No redline map — the AI re-renders the infographic\n * with the new content while preserving the visual style of the reference image.\n */\ninterface ContentModificationRequest {\n  originalImageUrl: string;   // reference image for style continuity\n  content: string;            // the updated synthesis content\n  cardText: string | null;\n  style?: string;\n  palette?: { background: string; primary: string; secondary: string; accent: string; text: string };\n  aspectRatio?: string;\n  resolution?: string;\n}\n\nexport async function executeContentModification(\n  request: ContentModificationRequest,\n  onUsage?: (entry: { provider: 'gemini'; model: string; inputTokens: number; outputTokens: number }) => void,\n): Promise<ModificationResult> {\n  const { originalImageUrl, content, cardText, style, palette, aspectRatio, resolution } = request;\n\n  const originalBase64 = extractBase64(originalImageUrl);\n  const originalMime = extractMime(originalImageUrl);\n\n  const systemPrompt = buildContentModificationPrompt(content, cardText, style, palette);\n\n  const imageConfig: Record<string, string> = {};\n  if (aspectRatio) imageConfig.aspectRatio = aspectRatio;\n  if (resolution) imageConfig.imageSize = resolution;\n\n  const response = await withGeminiRetry(async () => {\n    return await getGeminiAI().models.generateContent({\n      model: 'gemini-3-pro-image-preview',\n      contents: [\n        {\n          parts: [\n            { text: systemPrompt },\n            {\n              inlineData: {\n                mimeType: originalMime,\n                data: originalBase64,\n              },\n            },\n          ],\n        },\n      ],\n      config: {\n        ...PRO_IMAGE_CONFIG,\n        ...(Object.keys(imageConfig).length > 0 && { imageConfig }),\n      },\n    });\n  });\n\n  // Record Gemini usage\n  if (response.usageMetadata) {\n    onUsage?.({\n      provider: 'gemini',\n      model: 'gemini-3-pro-image-preview',\n      inputTokens: response.usageMetadata.promptTokenCount ?? 0,\n      outputTokens: response.usageMetadata.candidatesTokenCount ?? 0,\n    });\n  }\n\n  let newImageUrl = '';\n  if (response.candidates && response.candidates[0]?.content?.parts) {\n    for (const part of response.candidates[0].content.parts) {\n      if (part.inlineData) {\n        newImageUrl = `data:${part.inlineData.mimeType || 'image/png'};base64,${part.inlineData.data}`;\n        break;\n      }\n    }\n  }\n\n  if (!newImageUrl) {\n    throw new Error('AI did not return a modified image. Please try again.');\n  }\n\n  return { newImageUrl };\n}\n\n// --- Helpers ---\n\nexport function extractBase64(dataUrl: string): string {\n  const commaIndex = dataUrl.indexOf(',');\n  if (commaIndex === -1) return dataUrl;\n  return dataUrl.substring(commaIndex + 1);\n}\n\nexport function extractMime(dataUrl: string): string {\n  const match = dataUrl.match(/^data:([^;]+);/);\n  return match ? match[1] : 'image/png';\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\naming.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":29,"column":48,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":29,"endColumn":64,"fix":{"range":[948,964],"text":"{return baseName;}"}},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-constant-condition').","line":32,"column":3,"severity":1,"nodeType":null,"fix":{"range":[987,1036],"text":" "}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":45,"column":51,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":45,"endColumn":68,"fix":{"range":[1455,1472],"text":"{return candidate;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":64,"column":71,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":64,"endColumn":84,"fix":{"range":[2009,2022],"text":"{return false;}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":4,"source":"/**\n * Name uniqueness utilities.\n *\n * Rules (like Windows file explorer):\n *  - No two projects can share a name\n *  - No two nuggets within the same project can share a name\n *  - No two cards (headings) within the same nugget can share a name\n *  - No two documents within the same nugget can share a name\n *\n * All comparisons are case-insensitive.\n */\n\n/**\n * Generate a unique name within a set of existing names.\n *\n * For regular names:  \"Foo\" → \"Foo (2)\" → \"Foo (3)\" …\n * For filenames:      \"report.pdf\" → \"report (2).pdf\" → \"report (3).pdf\" …\n *\n * @param baseName  The desired name\n * @param existingNames  Names that already exist in the scope\n * @param isFile  When true, insert the counter before the file extension\n */\nexport function getUniqueName(\n  baseName: string,\n  existingNames: string[],\n  isFile = false,\n): string {\n  const lower = existingNames.map(n => n.toLowerCase());\n  if (!lower.includes(baseName.toLowerCase())) return baseName;\n\n  let counter = 2;\n  // eslint-disable-next-line no-constant-condition\n  while (true) {\n    let candidate: string;\n    if (isFile) {\n      const dotIndex = baseName.lastIndexOf('.');\n      if (dotIndex > 0) {\n        candidate = `${baseName.slice(0, dotIndex)} (${counter})${baseName.slice(dotIndex)}`;\n      } else {\n        candidate = `${baseName} (${counter})`;\n      }\n    } else {\n      candidate = `${baseName} (${counter})`;\n    }\n    if (!lower.includes(candidate.toLowerCase())) return candidate;\n    counter++;\n  }\n}\n\n/**\n * Check whether a name already exists in a list (case-insensitive).\n *\n * @param name  The name to check\n * @param existingNames  Existing names in scope\n * @param excludeSelf  Optionally exclude one name from the check (the item's current name)\n */\nexport function isNameTaken(\n  name: string,\n  existingNames: string[],\n  excludeSelf?: string,\n): boolean {\n  const trimmed = name.trim().toLowerCase();\n  return existingNames.some(n => {\n    if (excludeSelf && n.toLowerCase() === excludeSelf.toLowerCase()) return false;\n    return n.toLowerCase() === trimmed;\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\pdfBookmarks.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PDFDict' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PDFDict"},"fix":{"range":[20,29],"text":""},"desc":"Remove unused variable \"PDFDict\"."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":14,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":14,"endColumn":53,"fix":{"range":[588,598],"text":"{return [];}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[643,646],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[643,646],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1253,1256],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1253,1256],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":54,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":54,"endColumn":17,"suggestions":[{"fix":{"range":[1815,1889],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":76,"column":37,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":76,"endColumn":57,"fix":{"range":[2473,2493],"text":"{walk(node.children);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":89,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":89,"endColumn":40,"fix":{"range":[2841,2851],"text":"{return [];}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":129,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":129,"endColumn":41,"fix":{"range":[3980,3990],"text":"{return '';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":139,"column":37,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":139,"endColumn":69,"fix":{"range":[4375,4407],"text":"{walk(node.children, indent + 1);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":185,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":185,"endColumn":48,"fix":{"range":[5611,5628],"text":"{return pdfBase64;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'for-of'.","line":223,"column":30,"nodeType":"ForOfStatement","messageId":"missingCurlyAfter","endLine":223,"endColumn":56,"fix":{"range":[6856,6882],"text":"{n += countAll(e.children);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":296,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":296,"endColumn":82,"fix":{"range":[9346,9399],"text":"{return { node: nodes[i], siblings: nodes, index: i };}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":298,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":298,"endColumn":29,"fix":{"range":[9466,9479],"text":"{return found;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":306,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":306,"endColumn":39,"fix":{"range":[9743,9757],"text":"{return parent;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":308,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":308,"endColumn":38,"fix":{"range":[9837,9850],"text":"{return found;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":319,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":319,"endColumn":42,"fix":{"range":[10101,10129],"text":"{found.node.title = newTitle;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":329,"column":14,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":329,"endColumn":52,"fix":{"range":[10389,10427],"text":"{found.siblings.splice(found.index, 1);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":374,"column":36,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":374,"endColumn":48,"fix":{"range":[11467,11479],"text":"{return tree;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":400,"column":16,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":400,"endColumn":28,"fix":{"range":[12365,12377],"text":"{return tree;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":403,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":403,"endColumn":27,"fix":{"range":[12453,12465],"text":"{return tree;}"}},{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 382.","line":417,"column":69,"nodeType":null,"messageId":"identicalFunctions","endLine":417,"endColumn":71},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":446,"column":15,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":446,"endColumn":27,"fix":{"range":[13716,13728],"text":"{return tree;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":450,"column":58,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":450,"endColumn":70,"fix":{"range":[13890,13902],"text":"{return tree;}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":22,"fixableErrorCount":0,"fixableWarningCount":18,"source":"import { PDFDocument, PDFDict, PDFName, PDFString, PDFArray, PDFRef, PDFNumber } from 'pdf-lib';\nimport type { PDFDocumentProxy } from 'pdfjs-dist';\nimport { BookmarkNode, Heading } from '../types';\n\n// ── Extraction from pdf.js ──\n\n/**\n * Extract bookmarks (outline) from a pdf.js PDFDocumentProxy.\n * Returns a nested BookmarkNode[] tree, or empty array if no outline exists.\n */\nexport async function extractBookmarksFromPdf(pdfDocument: PDFDocumentProxy): Promise<BookmarkNode[]> {\n  try {\n    const outline = await pdfDocument.getOutline();\n    if (!outline || outline.length === 0) return [];\n\n    const resolvePageNumber = async (item: any): Promise<number> => {\n      try {\n        if (item.dest) {\n          // dest can be a string (named destination) or an array [pageRef, ...]\n          const dest = typeof item.dest === 'string'\n            ? await pdfDocument.getDestination(item.dest)\n            : item.dest;\n          if (dest && dest[0]) {\n            const pageIndex = await pdfDocument.getPageIndex(dest[0]);\n            return pageIndex + 1; // 1-based page numbers\n          }\n        }\n      } catch {\n        // Fallback: page 1 if destination can't be resolved\n      }\n      return 1;\n    };\n\n    const buildTree = async (items: any[], level: number): Promise<BookmarkNode[]> => {\n      const nodes: BookmarkNode[] = [];\n      for (const item of items) {\n        const page = await resolvePageNumber(item);\n        const children = item.items && item.items.length > 0\n          ? await buildTree(item.items, level + 1)\n          : [];\n        nodes.push({\n          id: crypto.randomUUID(),\n          title: item.title || 'Untitled',\n          page,\n          level,\n          children,\n        });\n      }\n      return nodes;\n    };\n\n    return buildTree(outline, 1);\n  } catch (err) {\n    console.warn('[pdfBookmarks] Failed to extract bookmarks from PDF:', err);\n    return [];\n  }\n}\n\n// ── Conversion utilities ──\n\n/**\n * Flatten a nested BookmarkNode[] tree into a flat Heading[] array.\n * Preserves all existing consumers (TOC display, card generation section hints).\n */\nexport function flattenBookmarks(bookmarks: BookmarkNode[]): Heading[] {\n  const result: Heading[] = [];\n  const walk = (nodes: BookmarkNode[]) => {\n    for (const node of nodes) {\n      result.push({\n        level: node.level,\n        text: node.title,\n        id: node.id,\n        selected: false,\n        page: node.page,\n      });\n      if (node.children.length > 0) walk(node.children);\n    }\n  };\n  walk(bookmarks);\n  return result;\n}\n\n/**\n * Convert a flat Heading[] array into a nested BookmarkNode[] tree.\n * Used for migrating existing documents that only have flat headings.\n * Builds hierarchy based on heading levels.\n */\nexport function headingsToBookmarks(headings: Heading[]): BookmarkNode[] {\n  if (headings.length === 0) return [];\n\n  const root: BookmarkNode[] = [];\n  // Stack tracks the current nesting path: [level, children-array]\n  const stack: { level: number; children: BookmarkNode[] }[] = [{ level: 0, children: root }];\n\n  for (const h of headings) {\n    const node: BookmarkNode = {\n      id: h.id || crypto.randomUUID(),\n      title: h.text,\n      page: h.page ?? 1,\n      level: h.level,\n      children: [],\n    };\n\n    // Pop stack until we find a parent with a lower level\n    while (stack.length > 1 && stack[stack.length - 1].level >= h.level) {\n      stack.pop();\n    }\n\n    // Append to the current parent's children\n    stack[stack.length - 1].children.push(node);\n    // Push this node so deeper items can nest under it\n    stack.push({ level: h.level, children: node.children });\n  }\n\n  return root;\n}\n\n// ── AI system prompt builder ──\n\n/**\n * Build a TOC string for injection into Claude's system prompt.\n * Produces indented `- Title (page N)` with nesting reflecting hierarchy.\n */\nexport function buildTocSystemPrompt(\n  bookmarks: BookmarkNode[],\n  docName: string,\n  totalPages?: number,\n): string {\n  if (bookmarks.length === 0) return '';\n\n  const lines: string[] = [];\n  lines.push(`Table of Contents for \"${docName}\"${totalPages ? ` (${totalPages} pages)` : ''}:`);\n  lines.push('');\n\n  const walk = (nodes: BookmarkNode[], indent: number) => {\n    for (const node of nodes) {\n      const prefix = '  '.repeat(indent);\n      lines.push(`${prefix}- ${node.title} (page ${node.page})`);\n      if (node.children.length > 0) walk(node.children, indent + 1);\n    }\n  };\n  walk(bookmarks, 0);\n\n  return lines.join('\\n');\n}\n\n// ── Write bookmarks into PDF (vendored pdf-lib logic) ──\n\n/**\n * Encode a Uint8Array to base64 using chunked encoding.\n * Avoids stack overflow from btoa(String.fromCharCode(...spread)) on large PDFs.\n */\nfunction uint8ArrayToBase64(bytes: Uint8Array): string {\n  const CHUNK_SIZE = 8192;\n  let binary = '';\n  for (let i = 0; i < bytes.length; i += CHUNK_SIZE) {\n    const chunk = bytes.subarray(i, Math.min(i + CHUNK_SIZE, bytes.length));\n    for (let j = 0; j < chunk.length; j++) {\n      binary += String.fromCharCode(chunk[j]);\n    }\n  }\n  return btoa(binary);\n}\n\n/**\n * Decode a base64 string to Uint8Array.\n */\nfunction base64ToUint8Array(base64: string): Uint8Array {\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n\n/**\n * Write bookmarks (outlines) into a PDF and return the new PDF as base64.\n * Uses pdf-lib to create a proper PDF outline tree.\n */\nexport async function writeBookmarksToPdf(\n  pdfBase64: string,\n  bookmarks: BookmarkNode[],\n): Promise<string> {\n  if (bookmarks.length === 0) return pdfBase64;\n\n  const pdfBytes = base64ToUint8Array(pdfBase64);\n  const pdfDoc = await PDFDocument.load(pdfBytes, { ignoreEncryption: true });\n  const pages = pdfDoc.getPages();\n  const context = pdfDoc.context;\n\n  // Helper: get page ref for a 1-based page number\n  const getPageRef = (pageNum: number): PDFRef => {\n    const idx = Math.max(0, Math.min(pageNum - 1, pages.length - 1));\n    return pages[idx].ref;\n  };\n\n  // Flatten bookmarks into ordered list with refs for building linked list\n  interface OutlineEntry {\n    node: BookmarkNode;\n    ref: PDFRef;\n    parentRef: PDFRef | null;\n    children: OutlineEntry[];\n  }\n\n  const outlinesRef = context.nextRef();\n\n  // Build outline entries recursively\n  const buildEntries = (nodes: BookmarkNode[], parentRef: PDFRef): OutlineEntry[] => {\n    return nodes.map(node => {\n      const ref = context.nextRef();\n      const entry: OutlineEntry = { node, ref, parentRef, children: [] };\n      entry.children = buildEntries(node.children, ref);\n      return entry;\n    });\n  };\n\n  const topEntries = buildEntries(bookmarks, outlinesRef);\n\n  // Count all entries recursively\n  const countAll = (entries: OutlineEntry[]): number => {\n    let n = entries.length;\n    for (const e of entries) n += countAll(e.children);\n    return n;\n  };\n\n  // Create outline dict for each entry\n  const createOutlineItems = (entries: OutlineEntry[], parentRef: PDFRef) => {\n    for (let i = 0; i < entries.length; i++) {\n      const entry = entries[i];\n      const dict = context.obj({});\n\n      dict.set(PDFName.of('Title'), PDFString.of(entry.node.title));\n      dict.set(PDFName.of('Parent'), parentRef);\n\n      // Destination: [pageRef, /Fit]\n      const dest = PDFArray.withContext(context);\n      dest.push(getPageRef(entry.node.page));\n      dest.push(PDFName.of('Fit'));\n      dict.set(PDFName.of('Dest'), dest);\n\n      // Prev/Next siblings\n      if (i > 0) {\n        dict.set(PDFName.of('Prev'), entries[i - 1].ref);\n      }\n      if (i < entries.length - 1) {\n        dict.set(PDFName.of('Next'), entries[i + 1].ref);\n      }\n\n      // Children\n      if (entry.children.length > 0) {\n        dict.set(PDFName.of('First'), entry.children[0].ref);\n        dict.set(PDFName.of('Last'), entry.children[entry.children.length - 1].ref);\n        // Negative count = closed by default\n        dict.set(PDFName.of('Count'), PDFNumber.of(-entry.children.length));\n        createOutlineItems(entry.children, entry.ref);\n      }\n\n      context.assign(entry.ref, dict);\n    }\n  };\n\n  createOutlineItems(topEntries, outlinesRef);\n\n  // Create root Outlines dict\n  const outlinesDict = context.obj({});\n  outlinesDict.set(PDFName.of('Type'), PDFName.of('Outlines'));\n  if (topEntries.length > 0) {\n    outlinesDict.set(PDFName.of('First'), topEntries[0].ref);\n    outlinesDict.set(PDFName.of('Last'), topEntries[topEntries.length - 1].ref);\n  }\n  outlinesDict.set(PDFName.of('Count'), PDFNumber.of(countAll(topEntries)));\n  context.assign(outlinesRef, outlinesDict);\n\n  // Set outlines on the document catalog\n  const catalog = pdfDoc.catalog;\n  catalog.set(PDFName.of('Outlines'), outlinesRef);\n\n  const savedBytes = await pdfDoc.save();\n  return uint8ArrayToBase64(new Uint8Array(savedBytes));\n}\n\n// ── Tree manipulation (immutable) ──\n\n/** Deep-clone a bookmark tree. */\nfunction cloneTree(nodes: BookmarkNode[]): BookmarkNode[] {\n  return nodes.map(n => ({ ...n, children: cloneTree(n.children) }));\n}\n\n/** Find a node by id in a tree. Returns [node, parent-children-array, index] or null. */\nfunction findNode(\n  nodes: BookmarkNode[],\n  id: string,\n): { node: BookmarkNode; siblings: BookmarkNode[]; index: number } | null {\n  for (let i = 0; i < nodes.length; i++) {\n    if (nodes[i].id === id) return { node: nodes[i], siblings: nodes, index: i };\n    const found = findNode(nodes[i].children, id);\n    if (found) return found;\n  }\n  return null;\n}\n\n/** Find parent node of a given id. Returns null for top-level nodes. */\nfunction findParent(nodes: BookmarkNode[], id: string, parent: BookmarkNode | null = null): BookmarkNode | null {\n  for (const node of nodes) {\n    if (node.id === id) return parent;\n    const found = findParent(node.children, id, node);\n    if (found !== null) return found;\n  }\n  return null;\n}\n\n/**\n * Rename a bookmark by id.\n */\nexport function renameBookmark(bookmarks: BookmarkNode[], id: string, newTitle: string): BookmarkNode[] {\n  const tree = cloneTree(bookmarks);\n  const found = findNode(tree, id);\n  if (found) found.node.title = newTitle;\n  return tree;\n}\n\n/**\n * Delete a bookmark by id (children are removed with it).\n */\nexport function deleteBookmark(bookmarks: BookmarkNode[], id: string): BookmarkNode[] {\n  const tree = cloneTree(bookmarks);\n  const found = findNode(tree, id);\n  if (found) found.siblings.splice(found.index, 1);\n  return tree;\n}\n\n/**\n * Add a new bookmark. If parentId is null, appends to top level.\n * Otherwise appends as last child of the parent.\n */\nexport function addBookmark(\n  bookmarks: BookmarkNode[],\n  parentId: string | null,\n  title: string,\n  page: number,\n  level: number,\n): BookmarkNode[] {\n  const tree = cloneTree(bookmarks);\n  const newNode: BookmarkNode = {\n    id: crypto.randomUUID(),\n    title,\n    page,\n    level,\n    children: [],\n  };\n\n  if (parentId === null) {\n    tree.push(newNode);\n  } else {\n    const found = findNode(tree, parentId);\n    if (found) {\n      newNode.level = found.node.level + 1;\n      found.node.children.push(newNode);\n    } else {\n      tree.push(newNode);\n    }\n  }\n  return tree;\n}\n\n/**\n * Indent a bookmark (make it a child of the previous sibling).\n * No-op if the node is the first sibling.\n */\nexport function indentBookmark(bookmarks: BookmarkNode[], id: string): BookmarkNode[] {\n  const tree = cloneTree(bookmarks);\n  const found = findNode(tree, id);\n  if (!found || found.index === 0) return tree;\n\n  // Remove from current position\n  const [removed] = found.siblings.splice(found.index, 1);\n  // Make it the last child of the previous sibling\n  const prevSibling = found.siblings[found.index - 1];\n  removed.level = prevSibling.level + 1;\n  // Recursively update children levels\n  const updateLevels = (nodes: BookmarkNode[], parentLevel: number) => {\n    for (const n of nodes) {\n      n.level = parentLevel + 1;\n      updateLevels(n.children, n.level);\n    }\n  };\n  updateLevels(removed.children, removed.level);\n  prevSibling.children.push(removed);\n  return tree;\n}\n\n/**\n * Outdent a bookmark (move it to the parent's level, after the parent).\n * No-op if the node is already at the top level.\n */\nexport function outdentBookmark(bookmarks: BookmarkNode[], id: string): BookmarkNode[] {\n  const tree = cloneTree(bookmarks);\n  const parent = findParent(tree, id);\n  if (!parent) return tree; // Already at top level\n\n  const found = findNode(tree, id);\n  if (!found) return tree;\n\n  // Remove from parent's children\n  const [removed] = found.siblings.splice(found.index, 1);\n  removed.level = parent.level;\n\n  // Any siblings AFTER the removed node stay as children of parent (no change)\n  // But remaining siblings after removed should become children of removed\n  const trailingChildren = found.siblings.splice(found.index);\n  if (trailingChildren.length > 0) {\n    removed.children.push(...trailingChildren);\n  }\n\n  // Update levels recursively\n  const updateLevels = (nodes: BookmarkNode[], parentLevel: number) => {\n    for (const n of nodes) {\n      n.level = parentLevel + 1;\n      updateLevels(n.children, n.level);\n    }\n  };\n  updateLevels(removed.children, removed.level);\n\n  // Insert after parent in grandparent's children\n  const grandparentChildren = findNode(tree, parent.id);\n  if (grandparentChildren) {\n    grandparentChildren.siblings.splice(grandparentChildren.index + 1, 0, removed);\n  } else {\n    tree.push(removed);\n  }\n\n  return tree;\n}\n\n/**\n * Reorder a bookmark within its sibling list.\n */\nexport function reorderBookmark(\n  bookmarks: BookmarkNode[],\n  id: string,\n  direction: 'up' | 'down',\n): BookmarkNode[] {\n  const tree = cloneTree(bookmarks);\n  const found = findNode(tree, id);\n  if (!found) return tree;\n\n  const { siblings, index } = found;\n  const targetIndex = direction === 'up' ? index - 1 : index + 1;\n  if (targetIndex < 0 || targetIndex >= siblings.length) return tree;\n\n  // Swap\n  [siblings[index], siblings[targetIndex]] = [siblings[targetIndex], siblings[index]];\n  return tree;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\autoDeckPlanner.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":188,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":188,"endColumn":59,"fix":{"range":[10946,10983],"text":"{lines.push(`Tone: ${briefing.tone}`);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":189,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":189,"endColumn":62,"fix":{"range":[11006,11045],"text":"{lines.push(`Focus: ${briefing.focus}`);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":198,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":198,"endColumn":104,"fix":{"range":[11487,11561],"text":"{deckOptions.push('Include a cover card (title slide with deck overview)');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":199,"column":38,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":199,"endColumn":120,"fix":{"range":[11599,11681],"text":"{deckOptions.push('Include section title cards (divider cards for main sections)');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":200,"column":32,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":200,"endColumn":106,"fix":{"range":[11713,11787],"text":"{deckOptions.push('Include a closing card (takeaway or conclusion slide)');}"}},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":252,"column":24,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":255,"endColumn":21,"fix":{"range":[13468,13720],"text":"`Source documents are provided in <document> tags. Reference them by their id attribute.\\n\\n${ \n      inlineDocuments.map(d =>\n        `<document id=\"${d.id}\" name=\"${d.name}\" wordCount=\"${d.wordCount}\">\\n${d.content}\\n</document>`\n      ).join('\\n\\n')}`"}},{"ruleId":"unicorn/no-array-for-each","severity":1,"message":"Use `for…of` instead of `.forEach(…)`.","line":420,"column":13,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":420,"endColumn":20,"fix":{"range":[20282,20572],"text":"for (const q of questions) {\n    const selectedKey = questionAnswers[q.id];\n    if (selectedKey) {\n      const option = q.options.find(o => o.key === selectedKey);\n      if (option) {\n        resolvedLines.push(`  ${q.id}: ${selectedKey} → \"${option.producerInstruction}\"`);\n      }\n    }\n  }"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":7,"source":"import { AutoDeckBriefing, AutoDeckLod, ParsedPlan, PlanQuestion } from '../../types';\nimport { AUTO_DECK_LOD_LEVELS } from '../autoDeck/constants';\nimport { SystemBlock, ClaudeMessage } from '../ai';\nimport { buildExpertPriming } from './promptUtils';\n\n// ── Planner prompt builder ──\n\nconst PLANNER_ROLE = `You are a senior information architect specializing in document decomposition for visual communication. You analyze source documents and produce structured card plans.\n\nCRITICAL CONTEXT: Your plan will be consumed by a separate AI content writer. The writer:\n- Cannot see your reasoning, only your plan output\n- Must locate exact source sections from your references\n- Needs unambiguous guidance to produce correct content\n- Has strict word count limits per card\n\nYour plan must be precise enough that the writer can execute it without guessing.\n\nYour plan must reference ONLY content that exists in the provided source documents — do not invent topics, infer data, or suggest content the sources do not contain.\n\nYour output MUST be a single valid JSON object. Do not include any text before or after the JSON.`;\n\nconst PLANNER_INSTRUCTIONS = `Follow these steps in order:\n\n1. CONFLICT CHECK (always first):\n   Scan all documents for contradictory data, claims, or positions. A conflict is when two sources state incompatible facts about the same topic (e.g., different numbers for the same metric, opposing conclusions about the same subject). Differences in emphasis, perspective, or scope are NOT conflicts.\n   If conflicts are found, output ONLY a conflict report (see output format) and stop.\n\n2. DOCUMENT RELATIONSHIP ANALYSIS:\n   Identify how the documents relate and choose a document strategy:\n   - \"dissolve\": Sources cover the same broad topic — blend freely across cards.\n   - \"preserve\": Sources are distinct sub-topics — keep document boundaries.\n   - \"hybrid\": Some overlap, some distinct — merge overlapping, preserve distinct.\n\n3. CONTENT INVENTORY (do this mentally before deciding card count):\n   - List every major topic and section across all documents.\n   - For each topic, note which document(s) cover it.\n   - Flag topics covered by MULTIPLE documents — these are MERGE candidates. You must NOT plan separate cards for overlapping content. Consolidate into ONE card.\n   - Flag topics that are sub-points of a larger topic — NEST under the parent card.\n\n4. CARD COUNT DETERMINATION:\n   Determine the optimal number of cards based on the source content and the user's briefing. Consider:\n   - The volume and structure of content in the source documents\n   - How the material naturally divides into distinct topics\n   - The user's audience, objective, and presentation type\n   - The LOD word count range per card\n   - Logical breakpoints — never split a cohesive idea across cards\n   - Minimum 3 content cards, maximum 40 content cards. Cover, section title, and closing cards do not count toward this limit. If source material would require more than 40, consolidate smaller topics or increase per-card density.\n\n5. CARD PLANNING — for each card produce:\n   - title: 5 words max, specific to the card's content (avoid generic titles like \"Overview\", \"Background\", \"Introduction\")\n   - description: One sentence summarizing what this card covers\n   - wordTarget: A specific word count target within the LOD range, based on the density of source material for this card. Cards with dense data get a higher target; cards with a single focused point get a lower target.\n   - sources: Reference the specific location within the source document where the content lives. Use the EXACT heading text from the document's structure. If no clear heading exists, provide a fallbackDescription explaining where the content is located. (Note: source references point to document locations — they are separate from the deck's chapter/section structure defined by section title cards.)\n   - keyDataPoints: Extract 2-5 VERBATIM quotes, figures, or statistics from the source that MUST appear in the written card content. Copy these exactly — character for character — from the document text.\n   - guidance: Structured instruction for the content writer:\n     - emphasis: What aspect from the source to lead with\n     - tone: Specific tone for this card (e.g., \"analytical\", \"urgent\", \"explanatory\")\n     - exclude: What nearby content should NOT be in this card (because it belongs to another card)\n   - crossReferences: How this card relates to other cards in the plan (e.g., \"Builds on Card 2's definition of X\", \"Contrasts with Card 4\"). Set to null if standalone.\n\n   NOTE: Cards will be sent to the writing agent in batches of up to 12. Each batch receives the full plan for context but only writes its assigned cards. Write guidance that is self-contained — avoid instructions that depend on the writer seeing specific content from cards in a different batch.\n\n6. DEDUPLICATION CHECK (do this after planning all cards):\n   Review your complete plan. For every pair of cards, verify:\n   - No two cards cover the same topic, statistic, or argument\n   - If overlap exists, consolidate into one card or explicitly split with clear boundaries in the guidance.exclude fields\n   - Note any cross-references between cards that help the writer avoid repetition\n\n7. DECISION QUESTIONS (generate 3-8 questions):\n   Review your plan and identify critical decision points where the user's choice would meaningfully change the produced content. Generate questions that:\n   - Address ambiguities in the briefing (e.g., which framing to use, what to emphasize)\n   - Offer scope choices (e.g., include/exclude a borderline topic)\n   - Present tone or structure alternatives for key cards\n   - Resolve any tensions between briefing fields\n\n   Each question must have:\n   - 2-4 mutually exclusive options\n   - A recommended option (your best judgment based on the briefing)\n   - A producerInstruction for each option — a VERBATIM instruction that will be injected directly into the content writer's prompt. Write these as clear, specific directives (e.g., \"Lead Card 3 with the revenue figures from Q2, not the market share data\" NOT \"focus more on financials\").\n\n   Question categories to consider:\n   - Content emphasis: Which data or angle to prioritize for a specific card\n   - Scope: Whether to include borderline or tangential topics\n   - Structure: How to organize content (chronological vs. thematic, etc.)\n   - Tone: Which voice to use for specific sections (analytical vs. persuasive)\n\n   Do NOT generate questions about:\n   - Whether to include a card (the checkbox handles that)\n   - Basic formatting preferences (the LOD handles that)\n   - Topics not covered in the source documents`;\n\nconst REVISION_INSTRUCTIONS = `This is a REVISION request. You previously produced a plan and the user has provided feedback.\n\nRules for revision:\n- Honor all user feedback (general comment and question answers)\n- If question answers are provided, incorporate them into the revised plan's guidance fields where applicable. The answers represent resolved decisions — adjust card guidance to reflect these choices.\n- Preserve card numbering for unchanged cards\n- If cards were unchecked (excluded), do NOT reintroduce them unless the general comment specifically asks for it\n- New cards get new numbers appended at the end\n- Generate NEW questions only for decisions introduced by the revision (e.g., if new cards were added or structure changed). Do not re-ask questions that were already answered.\n- Include a \"revisionNotes\" field describing what changed and why`;\n\nfunction buildOutputSchema(isRevision: boolean): string {\n  const revisionField = isRevision ? `\n    \"revisionNotes\": \"string — describe what changed from the previous plan and why\"` : '';\n\n  return `Output format — respond with EXACTLY one of these JSON structures:\n\nCONFLICT RESPONSE (if conflicts found):\n{\n  \"status\": \"conflict\",\n  \"conflicts\": [\n    {\n      \"description\": \"string — what the contradiction is\",\n      \"sourceA\": { \"document\": \"string — doc id\", \"section\": \"string — section name or range\" },\n      \"sourceB\": { \"document\": \"string — doc id\", \"section\": \"string — section name or range\" },\n      \"severity\": \"high | medium | low\"\n    }\n  ]\n}\n\nSUCCESSFUL PLAN RESPONSE (if no conflicts):\n{\n  \"status\": \"ok\",\n  \"metadata\": {\n    \"category\": \"string — echo back the presentation type from the briefing\",\n    \"lod\": \"string\",\n    \"sourceWordCount\": number,\n    \"cardCount\": number,\n    \"documentStrategy\": \"dissolve | preserve | hybrid\",\n    \"documentRelationships\": \"string — brief description of how documents relate\"\n  },\n  \"cards\": [\n    {\n      \"number\": number,\n      \"title\": \"string — 5 words max, specific not generic\",\n      \"description\": \"string — one sentence\",\n      \"sources\": [\n        {\n          \"document\": \"string — doc id\",\n          \"heading\": \"string — EXACT heading text from the document\",\n          \"fallbackDescription\": \"string — only if no clear heading, describe the content location\"\n        }\n      ],\n      \"wordTarget\": \"number — target word count for this card (within the LOD range, based on content density)\",\n      \"keyDataPoints\": [\"string — verbatim quote or figure from source that MUST appear in card content\"],\n      \"guidance\": {\n        \"emphasis\": \"string — what aspect to lead with\",\n        \"tone\": \"string — specific tone for this card\",\n        \"exclude\": \"string — what nearby content should NOT be in this card\"\n      },\n      \"crossReferences\": \"string | null — references to other cards this one relates to\"\n    }\n  ],\n  \"questions\": [\n    {\n      \"id\": \"string — unique id like q1, q2\",\n      \"question\": \"string — clear, specific question about a critical decision point\",\n      \"options\": [\n        {\n          \"key\": \"string — a, b, c, or d\",\n          \"label\": \"string — concise option description\",\n          \"producerInstruction\": \"string — verbatim directive for the content writer if this option is chosen\"\n        }\n      ],\n      \"recommendedKey\": \"string — which option key you recommend\",\n      \"context\": \"string — optional one-sentence explanation of why this question matters\"\n    }\n  ]${revisionField}\n}\n\nRules:\n- Do NOT add extra fields. Do NOT omit required fields.\n- keyDataPoints must contain VERBATIM text copied from the source documents — do not paraphrase.\n- Every source must have either \"heading\" or \"fallbackDescription\", not both.\n- guidance must be the structured object format shown above, not a plain string.\n- questions array must contain 3-8 questions. Each question must have 2-4 options.\n- producerInstruction must be a clear, specific directive — not vague guidance.`;\n}\n\n/** Format the user's briefing fields into a prompt-ready block. */\nfunction buildBriefingContext(briefing: AutoDeckBriefing): string {\n  const lines = [\n    `Audience: ${briefing.audience}`,\n    `Presentation type: ${briefing.type}`,\n    `Objective: ${briefing.objective}`,\n  ];\n  if (briefing.tone) lines.push(`Tone: ${briefing.tone}`);\n  if (briefing.focus) lines.push(`Focus: ${briefing.focus}`);\n  if (briefing.minCards != null && briefing.maxCards != null) {\n    lines.push(`Card count: between ${briefing.minCards} and ${briefing.maxCards} cards`);\n  } else if (briefing.minCards != null) {\n    lines.push(`Card count: at least ${briefing.minCards} cards`);\n  } else if (briefing.maxCards != null) {\n    lines.push(`Card count: at most ${briefing.maxCards} cards`);\n  }\n  const deckOptions: string[] = [];\n  if (briefing.includeCover) deckOptions.push('Include a cover card (title slide with deck overview)');\n  if (briefing.includeSectionTitles) deckOptions.push('Include section title cards (divider cards for main sections)');\n  if (briefing.includeClosing) deckOptions.push('Include a closing card (takeaway or conclusion slide)');\n  if (deckOptions.length > 0) {\n    lines.push(`Deck structure:\\n${deckOptions.map(o => `- ${o}`).join('\\n')}`);\n  }\n  return lines.join('\\n');\n}\n\ninterface PlannerPromptParams {\n  briefing: AutoDeckBriefing;\n  lod: AutoDeckLod;\n  subject?: string;\n  documents: { id: string; name: string; wordCount: number; content: string }[];\n  totalWordCount: number;\n  revision?: {\n    previousPlan: ParsedPlan;\n    generalComment: string;\n    cardComments: Record<number, string>;\n    excludedCards: number[];\n    questionAnswers?: Record<string, string>;\n  };\n}\n\nexport function buildPlannerPrompt(params: PlannerPromptParams): {\n  systemBlocks: SystemBlock[];\n  messages: ClaudeMessage[];\n} {\n  const { briefing, lod, documents, totalWordCount, subject, revision } = params;\n  const lodConfig = AUTO_DECK_LOD_LEVELS[lod];\n  const isRevision = !!revision;\n  const expertPriming = buildExpertPriming(subject);\n\n  // ── System blocks ──\n  const systemBlocks: SystemBlock[] = [\n    {\n      text: [\n        expertPriming ? `${expertPriming}\\n\\n${PLANNER_ROLE}` : PLANNER_ROLE,\n        '',\n        PLANNER_INSTRUCTIONS,\n        '',\n        isRevision ? REVISION_INSTRUCTIONS : '',\n        '',\n        buildOutputSchema(isRevision),\n      ].filter(Boolean).join('\\n'),\n      cache: false,\n    },\n  ];\n\n  // Document context — cached (large). Only include docs with inline content;\n  // Files API documents (native PDFs) are injected as document blocks in the messages array by the hook.\n  // Uses XML-style wrapping per Anthropic best practices for clear document boundaries.\n  const inlineDocuments = documents.filter(d => d.content);\n  if (inlineDocuments.length > 0) {\n    const docContext = 'Source documents are provided in <document> tags. Reference them by their id attribute.\\n\\n' +\n      inlineDocuments.map(d =>\n        `<document id=\"${d.id}\" name=\"${d.name}\" wordCount=\"${d.wordCount}\">\\n${d.content}\\n</document>`\n      ).join('\\n\\n');\n    systemBlocks.push({ text: docContext, cache: true });\n  }\n\n  // ── User message ──\n  const briefingContext = buildBriefingContext(briefing);\n\n  let userMessage = `${briefingContext}\n\nLevel of Detail: ${lodConfig.label}\nWord count range per card: ${lodConfig.wordCountMin}–${lodConfig.wordCountMax} words\n\nSource metadata:\n- Total word count: ${totalWordCount}\n- Document count: ${documents.length}\n- Documents (listed in user-specified priority order — respect this sequence):\n${documents.map((d, i) => `  ${i + 1}. ${d.name} (${d.id}, ${d.wordCount} words)`).join('\\n')}\n\nABSOLUTE CONSTRAINT: All content must originate exclusively from the provided source documents. Do not infer, extrapolate, assume, or add any information, context, examples, definitions, or claims that are not explicitly present in the sources.\n\nProduce the card plan now.`;\n\n  // Add revision context\n  if (revision) {\n    const excludedLine = revision.excludedCards.length > 0\n      ? `\\nExcluded cards (do NOT reintroduce): ${revision.excludedCards.join(', ')}`\n      : '';\n\n    const questionAnswerLines = revision.questionAnswers\n      ? Object.entries(revision.questionAnswers)\n          .filter(([, key]) => key)\n          .map(([qId, optionKey]) => `  ${qId}: ${optionKey}`)\n          .join('\\n')\n      : '';\n\n    // Legacy per-card comments (kept for backward compat but not actively used)\n    const cardCommentLines = Object.entries(revision.cardComments)\n      .filter(([, comment]) => comment.trim())\n      .map(([num, comment]) => `  Card ${num}: ${comment}`)\n      .join('\\n');\n\n    userMessage = `This is a REVISION of the previous plan.\n\nPrevious plan:\n${JSON.stringify(revision.previousPlan, null, 2)}\n\nUser feedback:\nGeneral comment: ${revision.generalComment || '(none)'}\n${questionAnswerLines ? `Question answers (resolved decisions — incorporate into card guidance):\\n${questionAnswerLines}` : 'Question answers: (none)'}\n${cardCommentLines ? `Per-card comments:\\n${cardCommentLines}` : ''}${excludedLine}\n\n${briefingContext}\n\nLevel of Detail: ${lodConfig.label}\nWord count range per card: ${lodConfig.wordCountMin}–${lodConfig.wordCountMax} words\n\nRevise the plan based on the feedback above.`;\n  }\n\n  const messages: ClaudeMessage[] = [\n    { role: 'user', content: userMessage },\n  ];\n\n  return { systemBlocks, messages };\n}\n\n// ── Finalizer prompt builder ──\n\nconst FINALIZER_INSTRUCTIONS = `You are receiving a card plan that was reviewed by the user. The user has:\n1. Toggled cards on/off (excluded cards have been removed — do not reintroduce them)\n2. Answered multiple-choice decision questions\n3. Optionally provided general feedback\n\nYour job is to produce the FINALIZED version of this plan by:\n- Incorporating each resolved decision directive into the relevant card(s)' guidance fields. Merge the directive into emphasis, tone, or exclude as appropriate. If the directive affects card ordering, cross-references, or structure, adjust those fields too.\n- Incorporating general feedback if provided.\n- Re-running the deduplication check across the finalized plan.\n- Outputting the finalized plan with NO questions array.\n\nThe output plan must be self-contained — every card's guidance must include all resolved decisions that affect it. The content writer will NOT see the original questions or answers.\n\nIMPORTANT: You are NOT writing content — you are restructuring a plan. Do not invent new topics or cards. Only modify existing card guidance fields to incorporate the resolved decisions and feedback.\n\nYour output MUST be a single valid JSON object. Do not include any text before or after the JSON.`;\n\nfunction buildFinalizerSchema(): string {\n  return `Output format — respond with EXACTLY this JSON structure:\n\n{\n  \"status\": \"ok\",\n  \"metadata\": {\n    \"category\": \"string — echo back the presentation type from the briefing\",\n    \"lod\": \"string\",\n    \"sourceWordCount\": number,\n    \"cardCount\": number,\n    \"documentStrategy\": \"dissolve | preserve | hybrid\",\n    \"documentRelationships\": \"string — brief description of how documents relate\"\n  },\n  \"cards\": [\n    {\n      \"number\": number,\n      \"title\": \"string — 5 words max, specific not generic\",\n      \"description\": \"string — one sentence\",\n      \"sources\": [\n        {\n          \"document\": \"string — doc id\",\n          \"heading\": \"string — EXACT heading text from the document\",\n          \"fallbackDescription\": \"string — only if no clear heading, describe the content location\"\n        }\n      ],\n      \"wordTarget\": \"number — target word count for this card\",\n      \"keyDataPoints\": [\"string — verbatim quote or figure from source that MUST appear in card content\"],\n      \"guidance\": {\n        \"emphasis\": \"string — what aspect to lead with (incorporate resolved decisions here)\",\n        \"tone\": \"string — specific tone for this card\",\n        \"exclude\": \"string — what nearby content should NOT be in this card\"\n      },\n      \"crossReferences\": \"string | null — references to other cards this one relates to\"\n    }\n  ]\n}\n\nRules:\n- Do NOT include a questions array.\n- Do NOT add extra fields. Do NOT omit required fields.\n- keyDataPoints must contain VERBATIM text copied from the source documents — do not paraphrase.\n- Every source must have either \"heading\" or \"fallbackDescription\", not both.\n- guidance must be the structured object format shown above, not a plain string.\n- All resolved decisions must be incorporated into the relevant card(s)' guidance fields.`;\n}\n\ninterface FinalizerPromptParams {\n  briefing: AutoDeckBriefing;\n  lod: AutoDeckLod;\n  subject?: string;\n  plan: ParsedPlan;\n  questions: PlanQuestion[];\n  questionAnswers: Record<string, string>;\n  generalComment?: string;\n}\n\nexport function buildFinalizerPrompt(params: FinalizerPromptParams): {\n  systemBlocks: SystemBlock[];\n  messages: ClaudeMessage[];\n} {\n  const { briefing, lod, subject, plan, questions, questionAnswers, generalComment } = params;\n  const lodConfig = AUTO_DECK_LOD_LEVELS[lod];\n  const expertPriming = buildExpertPriming(subject);\n\n  // ── System blocks ──\n  // NOTE: The finalizer does NOT receive source documents — it only restructures\n  // the plan by merging decisions into guidance fields. This keeps the call fast & cheap.\n  const systemBlocks: SystemBlock[] = [\n    {\n      text: [\n        expertPriming ? `${expertPriming}\\n\\n${FINALIZER_INSTRUCTIONS}` : FINALIZER_INSTRUCTIONS,\n        '',\n        buildFinalizerSchema(),\n      ].join('\\n'),\n      cache: false,\n    },\n  ];\n\n  // ── Resolve question answers into readable directives ──\n  const resolvedLines: string[] = [];\n  questions.forEach(q => {\n    const selectedKey = questionAnswers[q.id];\n    if (selectedKey) {\n      const option = q.options.find(o => o.key === selectedKey);\n      if (option) {\n        resolvedLines.push(`  ${q.id}: ${selectedKey} → \"${option.producerInstruction}\"`);\n      }\n    }\n  });\n\n  // ── Briefing context ──\n  const briefingContext = buildBriefingContext(briefing);\n\n  // ── User message ──\n  const userMessage = `${briefingContext}\n\nLevel of Detail: ${lodConfig.label}\nWord count range per card: ${lodConfig.wordCountMin}–${lodConfig.wordCountMax} words\n\nDraft plan to finalize:\n${JSON.stringify(plan, null, 2)}\n\n${resolvedLines.length > 0 ? `Resolved decisions (incorporate each directive into the relevant card guidance):\\n${resolvedLines.join('\\n')}` : 'Resolved decisions: (none)'}\n\nGeneral feedback: ${generalComment?.trim() || '(none)'}\n\nFinalize this plan now. Output the same JSON plan structure but with all decisions incorporated into card guidance. Do NOT include a questions array.`;\n\n  const messages: ClaudeMessage[] = [\n    { role: 'user', content: userMessage },\n  ];\n\n  return { systemBlocks, messages };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\autoDeckProducer.ts","messages":[{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":190,"column":24,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":193,"endColumn":21,"fix":{"range":[9265,9490],"text":"`Source documents are provided in <document> tags. Reference them by their id attribute.\\n\\n${ \n      inlineDocuments.map(d =>\n        `<document id=\"${d.id}\" name=\"${d.name}\">\\n${d.content}\\n</document>`\n      ).join('\\n\\n')}`"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":203,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":203,"endColumn":67,"fix":{"range":[9752,9797],"text":"{briefingLines.push(`Tone: ${briefing.tone}`);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":204,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":204,"endColumn":70,"fix":{"range":[9820,9867],"text":"{briefingLines.push(`Focus: ${briefing.focus}`);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":3,"source":"import { AutoDeckBriefing, AutoDeckLod, PlannedCard } from '../../types';\nimport { AUTO_DECK_LOD_LEVELS } from '../autoDeck/constants';\nimport { SystemBlock, ClaudeMessage } from '../ai';\nimport { buildExpertPriming } from './promptUtils';\n\n// ── Producer prompt builder ──\n\nconst PRODUCER_ROLE = `You are a presentation content writer. You receive a card plan with source references and key data points, and you write content for each card.\n\nCRITICAL RULES:\n- You write ONLY what the plan specifies — do not reorganize, skip, or add cards.\n- Every sentence you write must be directly traceable to the source documents.\n- Do NOT infer, extrapolate, assume, or add ANY information beyond what the source documents contain. This includes: background context, industry norms, definitions, implications, predictions, comparisons to external data, or commentary of any kind.\n- If the source documents do not say something, you do not write it. Period.\n- If a keyDataPoints list is provided for a card, those exact figures/quotes MUST appear in your output.\n- If the plan's source reference doesn't match any content you can find, write \"[SOURCE NOT FOUND]\" for that reference and move on — do NOT fabricate or substitute content.\n- Do NOT use your general knowledge to fill gaps. If source material is insufficient for the planned word count, write what you can from the sources and note \"[INSUFFICIENT SOURCE MATERIAL]\".\n\nYour output MUST be a single valid JSON object. Do not include any text before or after the JSON.`;\n\nconst PRODUCER_INSTRUCTIONS_BEFORE_FORMAT = `Follow this process for each card in the plan, in order:\n\n1. LOCATE SOURCES:\n   Find the sections referenced in the card's sources by matching the heading text or fallback description.\n   If a source heading doesn't match exactly, look for the closest match.\n   If no match exists, note this in your output.\n\n2. EXTRACT KEY DATA:\n   Before writing, identify the relevant passages from the source documents.\n   Anchor your content to these passages. If keyDataPoints are listed in the plan, ensure every one appears verbatim in your output.\n\n3. WRITE CONTENT:\n   Using ONLY the located sources and the plan's guidance:\n   - Follow the emphasis specified — lead with what the guidance says to lead with\n   - Match the tone specified for this card\n   - Respect the exclusions — do NOT include content the plan says belongs in another card\n   - Stay within the word count range — count your words and self-check\n   - Make explicit any relationships that are implied in the original (cause-effect, sequence, hierarchy, comparison, part-to-whole)\n   - Use concise, direct phrasing — no filler, no repetition\n   - Every sentence must restate, paraphrase, or directly quote from source documents — never add external context, background knowledge, definitions not in the source, or your own analysis\n\n4. CROSS-CARD DEDUPLICATION:\n   Before finalizing each card, check:\n   - Does this card repeat any statistic, fact, or argument you already wrote in a previous card?\n   - If yes: remove the duplicate. Either replace with a brief reference (e.g., \"As noted above,...\") or find different supporting evidence from the same source documents. Do NOT invent alternative evidence.\n   - If the plan includes crossReferences, use them to guide how cards relate without repeating content.`;\n\nconst PRODUCER_INSTRUCTIONS_AFTER_FORMAT = `6. OUTPUT in the exact JSON format specified.`;\n\n/** Build LOD-specific formatting rules (aligned with contentGeneration.ts). */\nfunction buildFormattingRules(lod: AutoDeckLod): string {\n  const headingRules = `\n   Heading hierarchy (strict):\n   - Do NOT include a # Card Title heading — just write the body content\n   - Use ## for main sections within the content\n   - Use ### for subsections under those (if word count permits)\n   - Never skip heading levels (e.g., no jumping from ## to ####)\n   - Never use # (H1) — that level is reserved for the card title\n   - Only number headings when the content has inherent sequential order (steps, phases, stages, ranked items). For thematic, categorical, or parallel content use descriptive headings without numbers`;\n\n  if (lod === 'executive') {\n    return `5. FORMAT each card (strict rules for Executive level):\n   - Use bold for 1-2 key metrics or terms only\n   - Maximum one ## heading below the title\n   - No tables, no ###, no blockquotes\n   - Prefer a tight paragraph or 2-3 bullets — nothing more\n   - ABSOLUTE RULE: Do NOT invent, infer, extrapolate, or add ANY data, facts, context, or claims beyond what is explicitly stated in the source documents\n${headingRules}`;\n  }\n\n  if (lod === 'detailed') {\n    return `5. FORMAT each card (use full markdown range for Detailed level):\n   - Use bullet points for lists of features, attributes, or non-sequential items\n   - Use numbered lists for sequential steps, ranked items, or ordered processes\n   - Use tables when comparing items across multiple dimensions or presenting structured data\n   - Use bold for key terms, metrics, and important phrases\n   - Use blockquotes for notable quotes or callout statements\n   - Choose the format that best represents the data — do NOT flatten everything into plain paragraphs\n   - ABSOLUTE RULE: Do NOT invent, infer, extrapolate, or add ANY data, facts, context, or claims beyond what is explicitly stated in the source documents\n${headingRules}`;\n  }\n\n  // Standard (default)\n  return `5. FORMAT each card (use full markdown range for Standard level):\n   - Use bullet points for lists of features, attributes, or non-sequential items\n   - Use numbered lists for sequential steps, ranked items, or ordered processes\n   - Use tables only when comparing 3+ items across multiple dimensions\n   - Use bold for key terms, metrics, and important phrases\n   - Choose the format that best represents the data — do NOT flatten everything into plain paragraphs\n   - ABSOLUTE RULE: Do NOT invent, infer, extrapolate, or add ANY data, facts, context, or claims beyond what is explicitly stated in the source documents\n${headingRules}`;\n}\n\nfunction buildOutputSchema(): string {\n  return `Output format — respond with EXACTLY this JSON structure:\n\n{\n  \"status\": \"ok\",\n  \"cards\": [\n    {\n      \"number\": number,\n      \"title\": \"string — same title from the plan\",\n      \"content\": \"string — the written card content in markdown (without the # heading — just the body)\",\n      \"wordCount\": number\n    }\n  ]\n}\n\nDo NOT add extra fields. Do NOT omit cards. Do NOT change card titles.\nEvery card's wordCount MUST be within the specified range.`;\n}\n\n/** Format the plan as readable narrative instead of raw JSON for better comprehension. */\nfunction formatPlanForProducer(plan: PlannedCard[]): string {\n  return plan.map(card => {\n    const sources = card.sources.map(s => {\n      const ref = s.heading || s.fallbackDescription || s.section || 'unspecified section';\n      return `    - ${ref} (from document: ${s.document})`;\n    }).join('\\n');\n\n    const keyData = (card.keyDataPoints || []).map(d => `    - \"${d}\"`).join('\\n');\n\n    let guidanceText: string;\n    if (typeof card.guidance === 'object' && card.guidance !== null) {\n      guidanceText = `    Emphasis: ${card.guidance.emphasis}\\n    Tone: ${card.guidance.tone}\\n    Exclude: ${card.guidance.exclude}`;\n    } else {\n      guidanceText = `    ${card.guidance}`;\n    }\n\n    const wordTargetLine = card.wordTarget ? `\\n  Word target: ~${card.wordTarget} words` : '';\n\n    return `Card ${card.number}: ${card.title}\n  Description: ${card.description}${wordTargetLine}\n  Sources:\n${sources}\n  Key data points to include:\n${keyData || '    (none specified)'}\n  Guidance:\n${guidanceText}\n  Cross-references: ${card.crossReferences || 'none'}`;\n  }).join('\\n\\n');\n}\n\ninterface ProducerPromptParams {\n  briefing: AutoDeckBriefing;\n  lod: AutoDeckLod;\n  subject?: string;\n  plan: PlannedCard[];\n  documents: { id: string; name: string; content: string }[];\n  /** Optional context about other cards in the full deck (for batched calls). */\n  batchContext?: string;\n}\n\nexport function buildProducerPrompt(params: ProducerPromptParams): {\n  systemBlocks: SystemBlock[];\n  messages: ClaudeMessage[];\n} {\n  const { briefing, lod, subject, plan, documents, batchContext } = params;\n  const lodConfig = AUTO_DECK_LOD_LEVELS[lod];\n  const expertPriming = buildExpertPriming(subject);\n\n  // ── System blocks ──\n  // Compose instructions with LOD-specific formatting rules\n  const fullInstructions = [\n    PRODUCER_INSTRUCTIONS_BEFORE_FORMAT,\n    '',\n    buildFormattingRules(lod),\n    '',\n    PRODUCER_INSTRUCTIONS_AFTER_FORMAT,\n  ].join('\\n');\n\n  const systemBlocks: SystemBlock[] = [\n    {\n      text: [\n        expertPriming ? `${expertPriming}\\n\\n${PRODUCER_ROLE}` : PRODUCER_ROLE,\n        '',\n        fullInstructions,\n        '',\n        buildOutputSchema(),\n      ].join('\\n'),\n      cache: false,\n    },\n  ];\n\n  // Document context — cached (large). Only include docs with inline content;\n  // Files API documents (native PDFs) are injected as document blocks in the messages array by the hook.\n  // Uses XML-style wrapping per Anthropic best practices for clear document boundaries.\n  const inlineDocuments = documents.filter(d => d.content);\n  if (inlineDocuments.length > 0) {\n    const docContext = 'Source documents are provided in <document> tags. Reference them by their id attribute.\\n\\n' +\n      inlineDocuments.map(d =>\n        `<document id=\"${d.id}\" name=\"${d.name}\">\\n${d.content}\\n</document>`\n      ).join('\\n\\n');\n    systemBlocks.push({ text: docContext, cache: true });\n  }\n\n  // ── User message ──\n  const briefingLines = [\n    `Audience: ${briefing.audience}`,\n    `Presentation type: ${briefing.type}`,\n    `Objective: ${briefing.objective}`,\n  ];\n  if (briefing.tone) briefingLines.push(`Tone: ${briefing.tone}`);\n  if (briefing.focus) briefingLines.push(`Focus: ${briefing.focus}`);\n  const briefingContext = briefingLines.join('\\n');\n\n  const planText = formatPlanForProducer(plan);\n\n  const userMessage = `${briefingContext}\n\nLevel of Detail: ${lodConfig.label}\nWord count range per card: ${lodConfig.wordCountMin}–${lodConfig.wordCountMax} words (STRICT — every card must fall within this range)\n${batchContext ? `\\n${batchContext}\\n` : ''}\nCard plan to execute:\n\n${planText}\n\nABSOLUTE CONSTRAINT: All content must originate exclusively from the provided source documents. Do not infer, extrapolate, assume, or add any information, context, examples, definitions, or claims that are not explicitly present in the sources.\n\nWrite the content for each card now.`;\n\n  const messages: ClaudeMessage[] = [\n    { role: 'user', content: userMessage },\n  ];\n\n  return { systemBlocks, messages };\n}\n\n/**\n * Split a large card plan into batches for separate API calls.\n * Returns arrays of PlannedCard[], each batch up to `batchSize` cards.\n */\nexport function batchPlan(plan: PlannedCard[], batchSize: number = 12): PlannedCard[][] {\n  const batches: PlannedCard[][] = [];\n  for (let i = 0; i < plan.length; i += batchSize) {\n    batches.push(plan.slice(i, i + batchSize));\n  }\n  return batches;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\contentGeneration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Heading' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Heading"},"fix":{"range":[20,29],"text":""},"desc":"Remove unused variable \"Heading\"."}]},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":57,"column":43,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":57,"endColumn":65,"fix":{"range":[3066,3088],"text":"`${expertPriming  }\\n\\n`"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":114,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":114,"endColumn":81,"fix":{"range":[5903,5953],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":115,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":115,"endColumn":89,"fix":{"range":[5988,6042],"text":"{canvasDescription = 'square — equal width and height';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":116,"column":85,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":116,"endColumn":135,"fix":{"range":[6127,6177],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":117,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":117,"endColumn":104,"fix":{"range":[6237,6281],"text":"{canvasDescription = 'near-square landscape';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":126,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":126,"endColumn":28},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 24 to the 15 allowed.","line":201,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":201,"endColumn":42},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":206,"column":33,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":206,"endColumn":42,"fix":{"range":[11196,11205],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":208,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":208,"endColumn":37,"fix":{"range":[11308,11317],"text":"{continue;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":224,"column":58,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":224,"endColumn":64,"fix":{"range":[11886,11892],"text":"{break;}"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":8,"source":"import { DetailLevel, Heading, UploadedFile, isCoverLevel } from '../../types';\nimport { buildExpertPriming } from './promptUtils';\n\n// ─────────────────────────────────────────────────────────────────\n// Card Content Generation\n// ─────────────────────────────────────────────────────────────────\n// Consumed by Claude (text LLM). Output is standard markdown,\n// which the Prompt Assembler transforms to bracketed tags before\n// it reaches the image model.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildContentPrompt(\n  cardTitle: string,\n  level: DetailLevel,\n  fullDocument: string,\n  sectionText: string,\n  excludeDocument = false,\n  subject?: string,\n): string {\n  if (isCoverLevel(level)) {\n    throw new Error(`Use buildCoverContentPrompt for card cover levels (got '${level}')`);\n  }\n\n  let wordCountRange = '200-250';\n  let scopeGuidance = '';\n  let formattingGuidance = '';\n\n  if (level === 'Executive') {\n    wordCountRange = '70-100';\n    scopeGuidance = `**Scope:** This is an EXECUTIVE SUMMARY. Prioritize ruthlessly — include only the single most important insight, conclusion, or finding. Omit supporting details, examples, breakdowns, and secondary points. Think: what would a CEO need to see in a 10-second glance?`;\n    formattingGuidance = `**Formatting (strict for Executive):**\n- Use bold for 1-2 key metrics or terms only\n- Maximum one ## heading below the title\n- No tables, no ###, no blockquotes\n- Prefer a tight paragraph or 2-3 bullets — nothing more`;\n  } else if (level === 'Detailed') {\n    wordCountRange = '450-500';\n    scopeGuidance = `**Scope:** This is a DETAILED analysis. Include comprehensive data, supporting evidence, comparisons, and relationships. Cover all relevant dimensions of the topic.`;\n    formattingGuidance = `**Formatting (use full markdown range):**\n- Use bullet points for lists of features, attributes, or non-sequential items\n- Use numbered lists for sequential steps, ranked items, or ordered processes\n- Use tables when comparing items across multiple dimensions or presenting structured data\n- Use bold for key terms, metrics, and important phrases\n- Use blockquotes for notable quotes or callout statements\n- Choose the format that best represents the data — do NOT flatten everything into plain paragraphs`;\n  } else {\n    scopeGuidance = `**Scope:** This is a STANDARD summary. Cover the key points, important data, and primary relationships. Include enough detail to be informative but stay concise.`;\n    formattingGuidance = `**Formatting (use full markdown range):**\n- Use bullet points for lists of features, attributes, or non-sequential items\n- Use numbered lists for sequential steps, ranked items, or ordered processes\n- Use tables only when comparing 3+ items across multiple dimensions\n- Use bold for key terms, metrics, and important phrases\n- Choose the format that best represents the data — do NOT flatten everything into plain paragraphs`;\n  }\n\n  const expertPriming = buildExpertPriming(subject);\n  const instructions = `${expertPriming ? expertPriming + '\\n\\n' : ''}Content Generation — [${cardTitle}]\nRead the provided document in full for context. Then focus on [${cardTitle}] including all its sub-sections and nested content.\n\n**WORD COUNT: EXACTLY ${wordCountRange} words. This is a hard limit. Count your output words before responding. If over, cut. If under, you may add — but NEVER exceed the upper bound.**\n\n${scopeGuidance}\n\n**Task:**\nExtract and restructure the section's content into infographic-ready text within the word limit. The output should make the section's hierarchy, logic, and connections between its parts immediately clear without referring back to the source.\n\n**Requirements:**\n- Make explicit any relationships that are implied in the original (cause-effect, sequence, hierarchy, comparison, part-to-whole)\n- Use concise, direct phrasing — no filler, no repetition\n- Preserve key data points, statistics, and specific terms exactly as written\n- Do not invent information not present in the documents\n- Only number headings when the content has inherent sequential order (steps, phases, stages, ranked items). For thematic, categorical, or parallel content use descriptive headings without numbers\n\n${formattingGuidance}\n\n**Heading Hierarchy (strict):**\n- Do NOT include the section title as a heading — it will be added separately\n- Use ## for main sections within the content\n- Use ### for subsections under those (if word count permits)\n- Never skip heading levels (e.g., no jumping from ## to ####)\n- Never use # (H1) — that level is reserved for the section title\n\n**Output:** Return ONLY the card content. No preamble, no explanation. REMINDER: ${wordCountRange} words maximum.\n`.trim();\n\n  if (excludeDocument) {\n    return `${instructions}\\n\\nFOCUS SECTION DATA:\\n${sectionText}`;\n  }\n  return `${instructions}\\n\\nFULL DOCUMENT CONTEXT:\\n${fullDocument}\\n\\nFOCUS SECTION DATA:\\n${sectionText}`;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Planner (Creative Visual Brief)\n// ─────────────────────────────────────────────────────────────────\n// Phase 3 — consumed by Gemini Flash (text LLM).\n//\n// Produces a conceptual creative brief — NOT a rigid wireframe.\n// Focuses on data relationships, visual concept, groupings, and\n// focal hierarchy. Leaves spatial placement and style decisions\n// to the image model (renderer), which receives the style identity,\n// palette, and fonts separately.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildPlannerPrompt(\n  cardTitle: string,\n  synthesisContent: string,\n  aspectRatio: string = '16:9',\n  previousPlan?: string,\n  subject?: string,\n): string {\n  const wordCount = synthesisContent.split(/\\s+/).filter(w => w.length > 0).length;\n\n  let canvasDescription = 'landscape — wider than tall';\n  if (aspectRatio === '9:16') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '1:1') canvasDescription = 'square — equal width and height';\n  else if (aspectRatio === '4:5' || aspectRatio === '3:4' || aspectRatio === '2:3') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '5:4' || aspectRatio === '3:2') canvasDescription = 'near-square landscape';\n\n  // Build diversity clause when regenerating\n  let diversityClause = '';\n  if (previousPlan) {\n    diversityClause = `\n## PREVIOUS CONCEPT (DO NOT REPEAT):\nThe following visual concept was already used for this content. You MUST propose a fundamentally different visualization approach — different visual metaphor, different diagram type, different information structure. Do not reuse the same concept with minor variations.\n---\n${previousPlan.slice(0, 600)}\n---\n`;\n  }\n\n  const domainContext = subject\n    ? `\\n## DOMAIN CONTEXT:\\nThis content belongs to the domain of \"${subject}\". Use domain-appropriate visual metaphors, diagram types, and iconography conventions when proposing the visualization concept.\\n`\n    : '';\n\n  return `\n# CREATIVE VISUAL BRIEF — [${cardTitle}]\n\nYou are an expert information designer creating a creative brief for an infographic. Your job is to analyze the content and describe the BEST way to visualize its underlying relationships — not to produce a rigid wireframe. Let the content's own logic suggest the visual form.\n${domainContext}\n## CANVAS:\n- Aspect ratio: ${aspectRatio} (${canvasDescription})\n- Content density: ~${wordCount} words\n${diversityClause}\n## CONTENT:\n---\n${synthesisContent}\n---\n\n## VISUAL VOCABULARY:\nChoose freely from the full range of infographic elements — pick whichever best represents the content:\n\nCharts: column, bar, stacked bar, grouped bar, line, area, pie, donut, gauge, radar/spider, scatter plot, bubble, waterfall, funnel, treemap, heatmap, sparklines, pictorial/icon charts, waffle charts, bullet charts, slope charts\n\nDiagrams: hierarchy/org chart, tree, flowchart, process flow, cycle, Venn, Euler, swimlane, Sankey, mind map, network/node graph, decision tree, concept map, fishbone/Ishikawa, SWOT matrix, quadrant/2x2 matrix, pyramid, staircase/step, concentric rings, timeline, Gantt, roadmap, journey map, comparison table, scorecard/dashboard panel\n\nVisual elements: callout badges, stat counters, icon arrays, progress bars, checklists, annotated illustrations, pull quotes, KPI tiles, before/after splits, geographical maps, rating scales, milestone markers\n\n## YOUR TASK:\nAnalyze the content and write a short creative brief (roughly 150–250 words total) covering these four areas. Write in narrative prose, not bullet lists.\n\n**1. DATA RELATIONSHIPS**\nWhat is the underlying structure of this content? Identify the dominant pattern: Is it a hierarchy? A sequence? A comparison? A concept with supporting details? A chronology? Overlapping categories? A set of metrics? A definition with attributes? Name the pattern and explain why it fits.\n\n**2. VISUAL CONCEPT**\nPropose the best infographic visualization for this content by selecting from the visual vocabulary above. You may combine multiple element types (e.g. a process flow with embedded stat counters, or a hierarchy diagram with callout badges). Describe the concept in one or two sentences — focus on what makes the information intuitive.\n\n**3. CONTENT GROUPINGS**\nWhich pieces of content belong together logically? Describe natural clusters. Note which items are standalone key figures or callouts that should be visually prominent (e.g. statistics, monetary values, percentages).\n\n**4. FOCAL HIERARCHY**\nWhat should grab the viewer's attention first, second, and third? Describe this as a viewing sequence, not positions. Reference content by its existing headings or labels.\n\n## RULES:\n- Do NOT dictate exact positions (no \"top-left\", \"right column\", \"bottom strip\")\n- Do NOT prescribe container types (no \"a card containing...\", \"a sidebar with...\")\n- Do NOT mention colors, fonts, point sizes, or pixel values\n- Do NOT rewrite, paraphrase, or abbreviate any content text\n- Reference ALL content items — nothing may be dropped\n- Keep it concise — this is a brief, not a specification\n`.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Native PDF Section Hint\n// ─────────────────────────────────────────────────────────────────\n// When generating card content from a native (unconverted) PDF,\n// there is no markdown to regex-extract sections from. Instead,\n// we build a prompt hint that tells Claude the section name, its\n// page boundaries, and its sub-section structure so it can locate\n// and extract the right content from the full PDF.\n// ─────────────────────────────────────────────────────────────────\n\n/**\n * Build a prompt hint that tells Claude where to find a specific section\n * in a native PDF document, using heading names and page boundaries.\n *\n * @param cardTitle — The heading text the user right-clicked on\n * @param enabledDocs — All enabled documents in the nugget\n * @returns A prompt string to append, or '' if no match found\n */\nexport function buildNativePdfSectionHint(\n  cardTitle: string,\n  enabledDocs: UploadedFile[],\n): string {\n  for (const doc of enabledDocs) {\n    if (!doc.structure?.length) continue;\n    const headingIdx = doc.structure.findIndex(h => h.text === cardTitle);\n    if (headingIdx === -1) continue;\n\n    const targetHeading = doc.structure[headingIdx];\n\n    // Find the next sibling or higher-level heading (= section end boundary)\n    let nextSiblingIdx = -1;\n    for (let i = headingIdx + 1; i < doc.structure.length; i++) {\n      if (doc.structure[i].level <= targetHeading.level) {\n        nextSiblingIdx = i;\n        break;\n      }\n    }\n\n    // Collect descendant headings within this section\n    const sectionHeadings = [targetHeading];\n    for (let i = headingIdx + 1; i < doc.structure.length; i++) {\n      if (doc.structure[i].level <= targetHeading.level) break;\n      sectionHeadings.push(doc.structure[i]);\n    }\n\n    // Build page boundary info\n    const startPage = targetHeading.page;\n    const endPage = nextSiblingIdx !== -1\n      ? doc.structure[nextSiblingIdx].page\n      : undefined;\n\n    // Build the TOC lines with page numbers\n    const tocLines = sectionHeadings.map(h => {\n      const indent = '  '.repeat(h.level - 1);\n      const pageLabel = h.page != null ? ` (page ${h.page})` : '';\n      return `${indent}- ${h.text}${pageLabel}`;\n    }).join('\\n');\n\n    // Build page range instruction\n    let pageInstruction = '';\n    if (startPage != null && endPage != null) {\n      const lastContentPage = endPage > startPage ? endPage - 1 : endPage;\n      pageInstruction = `\\n\\nPAGE BOUNDARIES: This section starts on page ${startPage} and the next section \"${doc.structure[nextSiblingIdx].text}\" starts on page ${endPage}. Extract content ONLY from pages ${startPage}–${lastContentPage}.`;\n    } else if (startPage != null) {\n      pageInstruction = `\\n\\nPAGE BOUNDARY: This section starts on page ${startPage} and continues to the end of the document. Extract content from page ${startPage} onwards.`;\n    }\n\n    return `\\n\\nDOCUMENT SECTION STRUCTURE (from \"${doc.name}\"):\\nThe target section \"${cardTitle}\" contains these sub-sections:\\n${tocLines}${pageInstruction}\\n\\nExtract content from this entire section including all sub-sections listed above.`;\n  }\n  return '';\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\coverGeneration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hexToColorName' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"hexToColorName"},"fix":{"range":[141,159],"text":""},"desc":"Remove unused variable \"hexToColorName\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'fontToDescriptor' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"fontToDescriptor"},"fix":{"range":[159,179],"text":""},"desc":"Remove unused variable \"fontToDescriptor\"."}]},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":112,"column":39,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":112,"endColumn":61,"fix":{"range":[5041,5063],"text":"`${expertPriming  }\\n\\n`"}},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":135,"column":39,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":135,"endColumn":61,"fix":{"range":[6390,6412],"text":"`${expertPriming  }\\n\\n`"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":184,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":184,"endColumn":81,"fix":{"range":[8840,8890],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":185,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":185,"endColumn":89,"fix":{"range":[8925,8979],"text":"{canvasDescription = 'square — equal width and height';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":186,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":186,"endColumn":78,"fix":{"range":[9014,9057],"text":"{canvasDescription = 'near-square portrait';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":313,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":313,"endColumn":49,"fix":{"range":[15892,15919],"text":"{blocks.push(referenceNote);}"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'cardTitle' is defined but never used. Allowed unused args must match /^_/u.","line":327,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":327,"endColumn":12},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":350,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":350,"endColumn":29,"fix":{"range":[17292,17302],"text":"{return '';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":351,"column":119,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":351,"endColumn":134,"fix":{"range":[17421,17436],"text":"{return trimmed;}"}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":8,"source":"import { DetailLevel, StylingOptions } from '../../types';\nimport {\n  buildExpertPriming,\n  buildNarrativeStyleBlock,\n  sanitizePlannerOutput,\n  hexToColorName,\n  fontToDescriptor,\n} from './promptUtils';\n\n// ─────────────────────────────────────────────────────────────────\n// Cover Card Generation — Prompts\n// ─────────────────────────────────────────────────────────────────\n// Cover cards are visual-first slides with minimal text:\n//   - TitleCard:    Title + Subtitle + Tagline  (branding/opener)\n//   - TakeawayCard: Title + Key Takeaway Bullets  (impact summary)\n//\n// Each has its own content instruction, content prompt, planner\n// prompt, and visualizer prompt — all optimized for cover aesthetics\n// rather than data-dense infographics.\n// ─────────────────────────────────────────────────────────────────\n\n// ─────────────────────────────────────────────────────────────────\n// 1. Cover Content Instruction (Chat Panel — system block)\n// ─────────────────────────────────────────────────────────────────\n// Injected as the final system block when the user sends a chat\n// message with \"Generate Cover\" selected. Overrides normal card\n// content generation behavior.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildCoverContentInstruction(coverType: DetailLevel): string {\n  if (coverType === 'TitleCard') {\n    return `\nCOVER SLIDE GENERATION MODE — THIS OVERRIDES ALL OTHER INSTRUCTIONS.\n\nYou are generating content for a TITLE CARD SLIDE — a bold, visual-first opener, not a data infographic.\n\n**Output format (strict):**\n\\`\\`\\`\n# [Title — bold, concise, impactful, 2-8 words]\n## [Subtitle — one line that adds context or scope, 5-12 words]\n[Tagline — optional short phrase for branding, attribution, or date, 3-8 words]\n\\`\\`\\`\n\n**WORD COUNT:** 15-25 words total across all three lines. This is a hard limit.\n\n**Rules:**\n- The title is the hero — make it bold, memorable, and instantly clear\n- The subtitle provides scope, context, or framing (e.g., \"Annual Performance Review 2024\", \"A Deep Dive into Market Trends\")\n- The tagline is optional — use it for attribution, dates, division names, or a short brand phrase\n- Do NOT include body text, bullet points, data, statistics, tables, or sections\n- Do NOT include any markdown formatting beyond the # and ## heading markers\n- Re-read the source documents to extract the most fitting title and context\n- Base the title on the user's prompt and the document content\n\n**Output:** Return ONLY the cover content starting with #. No preamble, no explanation, no card-suggestions block. NOTHING outside the cover content.\n\nREMINDER: 15-25 words maximum. This is a cover slide, not a content card.`.trim();\n  }\n\n  // TakeawayCard\n  return `\nCOVER SLIDE GENERATION MODE — THIS OVERRIDES ALL OTHER INSTRUCTIONS.\n\nYou are generating content for a TAKEAWAY CARD SLIDE — a bold title paired with the key takeaways as bullet points.\n\n**Output format (strict):**\n\\`\\`\\`\n# [Title — bold, concise, impactful, 2-8 words]\n- [Takeaway bullet 1 — a key finding, insight, or conclusion]\n- [Takeaway bullet 2 — another key finding]\n- [Takeaway bullet 3 — another key finding (optional)]\n- [Takeaway bullet 4 — another key finding (optional)]\n\\`\\`\\`\n\n**WORD COUNT:** 40-60 words total (title + all bullets combined). This is a hard limit.\n\n**Rules:**\n- The title is the hero — make it bold, memorable, and instantly clear\n- Include 2-4 bullet points capturing the most important takeaways from the documents\n- Each bullet should be a concise, self-contained insight — specific and data-informed where possible\n- Include key metrics, statistics, or concrete findings in the bullets\n- Use markdown bullet points (- ) for each takeaway\n- Do NOT include body text, tables, numbered lists, multiple paragraphs, or sub-sections\n- Do NOT include any markdown formatting beyond the # heading marker and bullet dashes\n- Re-read the source documents to extract the most impactful findings relevant to the user's prompt\n\n**Output:** Return ONLY the cover content starting with #. No preamble, no explanation, no card-suggestions block. NOTHING outside the cover content.\n\nREMINDER: 40-60 words maximum. This is a cover slide, not a content card.`.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 2. Cover Content Prompt (SourcesPanel — synthesis flow)\n// ─────────────────────────────────────────────────────────────────\n// Used when generating a cover card from a document heading via\n// the SourcesPanel. The heading text becomes the title; Claude\n// derives subtitle/tagline/takeaway from the section content.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildCoverContentPrompt(\n  cardTitle: string,\n  coverType: DetailLevel,\n  fullDocument: string,\n  sectionText: string,\n  excludeDocument = false,\n  subject?: string,\n): string {\n  const expertPriming = buildExpertPriming(subject);\n  let instructions: string;\n\n  if (coverType === 'TitleCard') {\n    instructions = `${expertPriming ? expertPriming + '\\n\\n' : ''}Cover Slide Content — [${cardTitle}]\nRead the provided document for context. Then focus on [${cardTitle}] and its sub-sections.\n\n**Task:**\nGenerate content for a TITLE CARD SLIDE. The cover must use \"${cardTitle}\" as the title (or a refined, punchier version of it).\n\n**Output format (strict):**\n# [Title — use or refine \"${cardTitle}\", 2-8 words]\n## [Subtitle — one line that adds context, scope, or framing from the section content, 5-12 words]\n[Tagline — optional short phrase for branding, attribution, or date context, 3-8 words]\n\n**Rules:**\n- WORD COUNT: 15-25 words total across all lines. Hard limit. Count your output words before responding.\n- The title must be based on \"${cardTitle}\" — you may refine it to be more impactful but preserve its meaning\n- The subtitle should be derived from the section content — what is this section about at a high level?\n- The tagline is optional — include only if there is a natural date, source attribution, or contextual phrase\n- Do NOT include body text, bullet points, data tables, or multiple sections\n- Do NOT use any markdown formatting beyond # and ## heading markers\n\n**Output:** Return ONLY the cover content starting with #. No preamble, no explanation. REMINDER: 15-25 words maximum.\n`.trim();\n  } else {\n    // TakeawayCard\n    instructions = `${expertPriming ? expertPriming + '\\n\\n' : ''}Cover Slide Content — [${cardTitle}]\nRead the provided document for context. Then focus on [${cardTitle}] and its sub-sections.\n\n**Task:**\nGenerate content for a TAKEAWAY CARD SLIDE. The cover must use \"${cardTitle}\" as the title (or a refined, punchier version of it), paired with the key takeaways from the section as bullet points.\n\n**Output format (strict):**\n# [Title — use or refine \"${cardTitle}\", 2-8 words]\n- [Takeaway bullet 1 — a key finding, insight, or conclusion from this section]\n- [Takeaway bullet 2 — another key finding]\n- [Takeaway bullet 3 — another key finding (optional)]\n- [Takeaway bullet 4 — another key finding (optional)]\n\n**Rules:**\n- WORD COUNT: 40-60 words total (title + all bullets combined). Hard limit. Count your output words before responding.\n- The title must be based on \"${cardTitle}\" — you may refine it to be more impactful but preserve its meaning\n- Include 2-4 bullet points with the most important insights, findings, or conclusions from this section\n- Each bullet should be concise, self-contained, and data-informed where possible — include key metrics or statistics\n- Use markdown bullet points (- ) for each takeaway\n- Do NOT include body text, tables, numbered lists, or multiple paragraphs\n- Do NOT use any markdown formatting beyond the # heading marker and bullet dashes\n\n**Output:** Return ONLY the cover content starting with #. No preamble, no explanation. REMINDER: 40-60 words maximum.\n`.trim();\n  }\n\n  if (excludeDocument) {\n    return `${instructions}\\n\\nFOCUS SECTION DATA:\\n${sectionText}`;\n  }\n  return `${instructions}\\n\\nFULL DOCUMENT CONTEXT:\\n${fullDocument}\\n\\nFOCUS SECTION DATA:\\n${sectionText}`;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 3. Cover Planner Prompt (Layout Planning)\n// ─────────────────────────────────────────────────────────────────\n// Consumed by Gemini Flash (text LLM). Produces a spatial layout\n// blueprint for a cover slide — fundamentally different from\n// content card planning. Emphasis on visual impact, whitespace,\n// and title prominence over data arrangement.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildCoverPlannerPrompt(\n  cardTitle: string,\n  coverContent: string,\n  style: string,\n  aspectRatio: string = '16:9',\n  coverType: DetailLevel\n): string {\n  let canvasDescription = 'landscape — wider than tall';\n  if (aspectRatio === '9:16') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '1:1') canvasDescription = 'square — equal width and height';\n  else if (aspectRatio === '4:5') canvasDescription = 'near-square portrait';\n\n  const coverKind = coverType === 'TitleCard' ? 'Title Card' : 'Takeaway Card';\n\n  const takeawayGuidance = coverType === 'TakeawayCard'\n    ? `The takeaway bullet points should appear below the title as a clean, vertically stacked list — visually distinct from the title, using a slightly smaller but still bold treatment. Each bullet should be clearly separated. Consider subtle bullet markers, icons, or decorative dashes. The bullets should be immediately scannable.`\n    : `The subtitle sits directly below the title — smaller but clearly legible. The optional tagline is the smallest text element, positioned at the bottom or near the subtitle.`;\n\n  return `\nCOVER SLIDE LAYOUT PLANNING — [${cardTitle}]\n\nYou are an expert cover slide designer. Your job is to plan the visual layout of a ${coverKind} — a bold, visual-first slide that functions as an opener or title card. This is NOT a data infographic. There should be NO data grids, NO bullet lists, NO tables, and NO multi-section layouts.\n\nCANVAS CONSTRAINTS:\n- Aspect ratio: ${aspectRatio} (${canvasDescription})\n- Content density: MINIMAL — this is a cover slide with a title and a small number of supporting text elements\n\nCONTENT TO VISUALIZE:\n---\n${coverContent}\n---\n\nYOUR TASK:\nPlan a visually striking cover slide layout. The title is the absolute hero element — it should dominate the composition. The canvas should feel cohesive and intentional, with strong visual presence.\n\nCRITICAL RULES:\n- This is a COVER SLIDE, not a content infographic\n- The title MUST be the largest, most prominent element — dominating the canvas\n- NO data visualization elements (charts, graphs, tables, grids)\n- NO bullet lists or multi-section arrangements\n- Fill the canvas with a cohesive visual composition — abstract shapes, patterns, gradients, or style-driven decorative elements\n- Whitespace should be intentional and dramatic, not empty\n\nOUTPUT FORMAT:\n\nWrite all descriptions as narrative sentences, not key-value lists.\n\n1. COMPOSITION: Describe the overall slide composition in narrative form:\n   - Where the title sits (centered, top-third, bottom-third, overlaid on visual)\n   - What fills the rest of the canvas (abstract graphic, pattern, illustration, gradient, decorative shapes)\n   - ${takeawayGuidance}\n\n2. VISUAL FOCAL POINT: Describe the dominant visual element that makes this cover striking:\n   - An abstract shape, pattern, or decorative composition that reinforces the topic\n   - How it interacts with the title (behind, around, framing, integrated)\n   - It should occupy at least 40-60% of the canvas area\n\n3. STYLE APPLICATION: Describe how the [${style}] aesthetic drives the cover design:\n   - Shape character (rounded, sharp, organic, geometric)\n   - Background treatment (solid, gradient, textured, patterned)\n   - Decorative elements specific to the ${style} aesthetic\n   - Write in narrative sentences. The renderer handles all color decisions — do not mention any colors.\n\n4. TEXT HIERARCHY: Describe the text treatment:\n   - Title: TIER-1 — the hero element, bold and commanding\n   - ${coverType === 'TitleCard' ? 'Subtitle: TIER-2 — secondary, clearly subordinate to title' : 'Takeaway bullets: TIER-2 — clean stacked list, visually distinct from title, each bullet clearly separated'}\n   - ${coverType === 'TitleCard' ? 'Tagline: TIER-4 — smallest, subtle, positioned at edge or bottom' : ''}\n   - Write in narrative sentences, not lists\n\nRULES:\n- Write all descriptions as narrative sentences, not key-value lists\n- Be EXPLICIT about spatial positions\n- Do NOT rewrite or paraphrase the content text\n- FORBIDDEN in your output: font names, point sizes, hex colors, pixel values, key-value pairs\n`.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 4. Cover Visualizer Prompt (Image Generation)\n// ─────────────────────────────────────────────────────────────────\n// Consumed by gemini-3-pro-image-preview (image model).\n// All narrative prose — no markdown, no XML, no key-value pairs.\n// Optimized for visual-first cover slides.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildCoverVisualizerPrompt(\n  cardTitle: string,\n  coverContent: string,\n  settings: StylingOptions,\n  visualPlan?: string,\n  useReference?: boolean,\n  coverType?: DetailLevel\n): string {\n  // 1. Role — cover slide designer\n  const role =\n    'You are an expert cover slide designer. Create a visually striking cover slide — ' +\n    'a bold, brand-forward title card that functions as an opener or presentation cover. ' +\n    'This is NOT a data infographic. Do not include charts, data grids, bullet lists, or multi-section layouts. ' +\n    'The title must be the absolute hero element — the largest, most dominant text on the canvas. ' +\n    'Fill the entire canvas with a cohesive visual composition — no empty white areas.';\n\n  // 2. Style & Palette (reuse narrative style block from settings)\n  const styleBlock = buildNarrativeStyleBlock(settings);\n\n  // 3. Reference note (if applicable)\n  const referenceNote = useReference\n    ? 'A reference cover slide is provided. Replicate its visual identity exactly: title ' +\n      'decoration and weight, background treatment, color usage, and overall composition style. ' +\n      'The new cover must look like a sibling of the reference.'\n    : undefined;\n\n  // 4. Layout\n  let layoutBlock: string;\n  if (visualPlan) {\n    const cleanPlan = sanitizePlannerOutput(visualPlan);\n    layoutBlock =\n      `${cleanPlan}\\n\\n` +\n      `Render the title as the hero element — bold, dominant, and immediately readable. ` +\n      `All text must be legible with high contrast against the background.`;\n  } else {\n    const defaultGuidance = coverType === 'TakeawayCard'\n      ? 'Place the title prominently in the upper portion of the canvas. Below it, render ' +\n        'the takeaway bullet points as a clean, vertically stacked list — visually distinct from the title, ' +\n        'each bullet clearly separated with consistent spacing. Use subtle bullet markers or decorative dashes. ' +\n        'Fill the remaining canvas with style-driven decorative elements.'\n      : 'Center the title as the dominant element. Place the subtitle directly below it, ' +\n        'clearly subordinate but legible. If there is a tagline, position it at the bottom edge. ' +\n        'Fill the canvas with style-driven decorative elements — abstract shapes, patterns, or gradients.';\n    layoutBlock =\n      `${defaultGuidance} All text must be legible with high contrast against the background.`;\n  }\n\n  // 5. Content — minimal, just title + supporting text in bracketed tags\n  const contentBlock = transformCoverContentToTags(coverContent, cardTitle);\n\n  // Assemble: role → style → [reference] → layout → content\n  const blocks = [role, styleBlock];\n  if (referenceNote) blocks.push(referenceNote);\n  blocks.push(layoutBlock, contentBlock);\n  return blocks.join('\\n\\n');\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Helper: Transform cover content to bracketed tags\n// ─────────────────────────────────────────────────────────────────\n// Similar to transformContentToTags but optimized for minimal\n// cover slide content (title + subtitle/takeaway).\n// ─────────────────────────────────────────────────────────────────\n\nfunction transformCoverContentToTags(\n  coverContent: string,\n  cardTitle: string\n): string {\n  let content = coverContent;\n\n  // Convert # Title → [TITLE] Title\n  content = content.replace(/^#\\s+(.+)$/gm, '[TITLE] $1');\n  // Convert ## Subtitle → [SUBTITLE] Subtitle\n  content = content.replace(/^##\\s+(.+)$/gm, '[SUBTITLE] $1');\n\n  // Strip any remaining markdown formatting\n  content = content.replace(/\\*\\*(.+?)\\*\\*/g, '$1');\n  content = content.replace(/\\*(.+?)\\*/g, '$1');\n\n  // Collapse blank lines\n  content = content.replace(/\\n{3,}/g, '\\n\\n');\n  content = content.trim();\n\n  // Convert markdown bullet points to [TAKEAWAY-BULLET] tags\n  content = content.replace(/^[-*]\\s+(.+)$/gm, '[TAKEAWAY-BULLET] $1');\n\n  // Any remaining non-tagged lines become [TAGLINE] (for TitleCard) or [TAKEAWAY] (for TakeawayCard)\n  const lines = content.split('\\n').map(line => {\n    const trimmed = line.trim();\n    if (!trimmed) return '';\n    if (trimmed.startsWith('[TITLE]') || trimmed.startsWith('[SUBTITLE]') || trimmed.startsWith('[TAKEAWAY-BULLET]')) return trimmed;\n    // Non-tagged non-empty line — treat as tagline or takeaway\n    if (content.includes('[SUBTITLE]')) {\n      return `[TAGLINE] ${trimmed}`;\n    }\n    return `[TAKEAWAY] ${trimmed}`;\n  });\n\n  const taggedContent = lines.filter(l => l).join('\\n');\n\n  return `[BEGIN COVER CONTENT]\\n${taggedContent}\\n[END COVER CONTENT]`;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\documentConversion.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\imageGeneration.ts","messages":[{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":173,"column":24,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":173,"endColumn":89,"fix":{"range":[8963,9028],"text":"`\\n\\n${  transformContentToTags(content, cardTitle || 'Untitled')}`"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { StylingOptions } from '../../types';\nimport {\n  assembleRendererPrompt,\n  transformContentToTags,\n  hexToColorName,\n} from './promptUtils';\n\n// ─────────────────────────────────────────────────────────────────\n// Visualizer (Card Image Generation)\n// ─────────────────────────────────────────────────────────────────\n// Phase 4 — consumed by gemini-3-pro-image-preview (image model).\n//\n// CRITICAL: All prompts in this file use narrative prose only.\n// No markdown (##, **, ---), no XML tags, no key-value pairs,\n// no font names, no point sizes. These are all leakage vectors\n// that the image model may render as visible text.\n//\n// Aspect ratio and resolution are set via imageConfig in the API\n// call (S6) — they do not appear in the prompt text.\n//\n// Changes from original (per S1, S2, S5, S6, S7):\n//   - All instructions rewritten as narrative prose\n//   - Content block transformed to bracketed tags via assembler\n//   - Palette described as semantic color-to-object bindings\n//   - Typography described as visual relationships, not specs\n//   - Style–palette conflict detection with override language\n//   - Prompt order: role → style/palette → layout → content\n//   - Aspect ratio / resolution removed from prompt text\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildVisualizerPrompt(\n  cardTitle: string,\n  contentToMap: string,\n  settings: StylingOptions,\n  visualPlan?: string,\n  useReference?: boolean,\n  subject?: string,\n): string {\n  // The assembler handles all transformations:\n  // - Builds narrative style/palette/typography block from settings\n  // - Sanitizes planner output (if provided)\n  // - Transforms content markdown to bracketed tags\n  // - Assembles in optimal order (role → style → [reference] → layout → content)\n  const referenceNote = useReference\n    ? 'A reference infographic is provided. Replicate its visual identity exactly: title ' +\n      'decoration and weight, header styling, text hierarchy, color usage, background ' +\n      'treatment, container shapes, icon style, and spacing. The new card must look like ' +\n      'a sibling of the reference. Derive layout from the content below, not the reference.'\n    : undefined;\n  return assembleRendererPrompt(cardTitle, contentToMap, settings, visualPlan, referenceNote, subject);\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Annotation-Based Modification\n// ─────────────────────────────────────────────────────────────────\n// Phase 5a — consumed by gemini-3-pro-image-preview (image model).\n//\n// This prompt relies primarily on the reference image for style.\n// Changes from original (per S8):\n//   - Removed ## markdown headers\n//   - Rewritten CRITICAL RULES as narrative sentences\n//   - Front-loaded style preservation as the opening instruction\n//   - Flattened process steps to plain text\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildModificationPrompt(\n  instructions: string,\n  cardTitle: string | null,\n  hasRedline: boolean = true\n): string {\n  const titleSuffix = cardTitle ? ` for \"${cardTitle}\"` : '';\n\n  if (!hasRedline) {\n    // Global instruction only — no redline map provided\n    return `\nYou are a precise image editor. You will receive an original infographic image. Apply the modifications described below to the original image, producing a new version that incorporates all requested changes.\n\nMaintain the exact same visual style, color palette, typography, and design language as the original image throughout all modifications. Execute each instruction precisely as written without adding creative interpretations unless specifically asked. The output must match the original image quality and resolution.\n\nModifications to apply${titleSuffix}:\n${instructions}\n\nProcess: Study the original image carefully, noting its style, colors, fonts, and layout. Apply each modification while maintaining visual consistency. Output the complete modified image.\n`.trim();\n  }\n\n  return `\nYou are a precise image editor. You will receive an original infographic image and a redline overlay map showing annotations on a black background. Apply the modifications described below to the original image, producing a new version that incorporates all requested changes.\n\nMaintain the exact same visual style, color palette, typography, and design language as the original image throughout all modifications. Only modify the specific areas indicated by the annotations — leave all other parts of the image exactly as they are. Execute each instruction precisely as written without adding creative interpretations unless specifically asked. Use the redline map coordinates to locate exactly where changes should be applied. The output must match the original image quality and resolution.\n\nModifications to apply${titleSuffix}:\n${instructions}\n\nProcess: Study the original image carefully, noting its style, colors, fonts, and layout. Cross-reference the redline map to locate each annotation spatially. Apply each modification in order while maintaining visual consistency. Output the complete modified image.\n`.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Content-Only Modification (re-render with updated text)\n// ─────────────────────────────────────────────────────────────────\n// Phase 5b — consumed by gemini-3-pro-image-preview (image model).\n//\n// Changes from original (per S8):\n//   - Full narrative rewrite — no markdown, no key-value pairs\n//   - Palette as narrative semantic color-to-object bindings\n//   - Typography as descriptive visual hierarchy\n//   - Content block uses bracketed tags\n//   - Style–palette override language when applicable\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildContentModificationPrompt(\n  content: string,\n  cardTitle: string | null,\n  style?: string,\n  palette?: { background: string; primary: string; secondary: string; accent: string; text: string }\n): string {\n  const titleSuffix = cardTitle ? ` titled \"${cardTitle}\"` : '';\n\n  // Opening: role + reference instruction\n  const opening =\n    `You are an expert Information Designer. You will receive a reference infographic ` +\n    `image — study its visual style, layout approach, color palette, typography, and ` +\n    `design language carefully.\\n\\n` +\n    `Generate a new infographic${titleSuffix} that renders the updated content below while matching ` +\n    `the reference image's visual family exactly — same style, same color palette, same ` +\n    `typography approach, same design language. The layout should adapt to the updated ` +\n    `content's structure while preserving the reference's aesthetic.`;\n\n  // Palette: narrative semantic assignments (if provided)\n  let paletteBlock = '';\n  if (palette) {\n    const bgName = hexToColorName(palette.background);\n    const primaryName = hexToColorName(palette.primary);\n    const secondaryName = hexToColorName(palette.secondary);\n    const accentName = hexToColorName(palette.accent);\n    const textName = hexToColorName(palette.text);\n\n    const overrideClause = style\n      ? ` Strictly adhere to this palette — override any default color associations from the ${style} style.`\n      : '';\n\n    paletteBlock =\n      `\\n\\nApply the color palette from the reference: ${bgName} (${palette.background}) ` +\n      `for the background, ${primaryName} (${palette.primary}) for headers and primary elements, ` +\n      `${secondaryName} (${palette.secondary}) for secondary accents, ${accentName} ` +\n      `(${palette.accent}) for highlighted numbers and key statistics, and ${textName} ` +\n      `(${palette.text}) for body text. Limit the image exclusively to these five colors.${overrideClause}`;\n  }\n\n  // Style: narrative aesthetic instruction (if provided, no palette)\n  let styleBlock = '';\n  if (style && !palette) {\n    styleBlock = `\\n\\nFollow the ${style} aesthetic throughout the infographic.`;\n  }\n\n  // Typography: descriptive hierarchy (no font names, no sizes)\n  const typographyBlock =\n    `\\n\\nRender text with a clear visual hierarchy matching the reference image. ` +\n    `The main title must be the largest and boldest element at the top. Section headers ` +\n    `must be bold and clearly visible above their content groups. Body text should be ` +\n    `legible and noticeably smaller. Key statistics should be emphasized and prominent.`;\n\n  // Render instruction\n  const renderInstruction =\n    `\\n\\nEvery single piece of text content provided below must appear in the final image — ` +\n    `no heading, bullet point, statistic, or detail may be omitted. If the layout ` +\n    `cannot fit all the content, adapt it rather than dropping text. Reduce whitespace, ` +\n    `add rows, extend sections, or use a denser arrangement — but never cut content. ` +\n    `All text must be legible with high contrast.`;\n\n  // Content: transform to bracketed tags\n  const contentBlock = '\\n\\n' + transformContentToTags(content, cardTitle || 'Untitled');\n\n  return (opening + paletteBlock + styleBlock + typographyBlock + renderInstruction + contentBlock).trim();\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\insightsLab.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'INSIGHTS_SYSTEM_PROMPT' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":12,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DetailLevel, isCoverLevel } from '../../types';\nimport { buildExpertPriming } from './promptUtils';\n\n// ─────────────────────────────────────────────────────────────────\n// Insights Lab — System Prompt & Card Content Instructions\n// ─────────────────────────────────────────────────────────────────\n// Used by the Insights workflow for conversational document analysis\n// and structured card content generation via Claude.\n// ─────────────────────────────────────────────────────────────────\n\n/** @deprecated Use buildInsightsSystemPrompt(subject?) instead */\nconst INSIGHTS_SYSTEM_PROMPT = buildInsightsSystemPrompt();\n\nexport function buildInsightsSystemPrompt(subject?: string): string {\n  const expertPriming = buildExpertPriming(subject);\n  const roleStatement = expertPriming\n    ? `${expertPriming} You also serve as an expert document analyst and content strategist.`\n    : 'You are an expert document analyst and content strategist.';\n\n  return `${roleStatement} The user has uploaded one or more documents for you to analyze. You have access to the full content of these documents.\n\n**Your role:**\n- Answer questions about the documents accurately and thoroughly\n- Identify patterns, themes, connections, and insights across documents\n- Help the user explore and understand their source material\n- When asked to generate card content, produce structured, infographic-ready text\n\n**Conversation style:**\n- Be direct and substantive — avoid filler\n- Reference specific content from the documents when answering\n- Use the full range of markdown formatting: bullet points, numbered lists, tables, bold, blockquotes — choose the format that best represents the data, do not flatten everything into plain paragraphs\n- Keep it tight: short paragraphs, minimal spacing\n- When comparing across documents, clearly attribute information to its source\n- Never use emojis or emoticons\n- Keep heading usage minimal in regular responses — prefer bold text for emphasis over headings\n\n**Document context:**\n- The documents provided in the system context are always the current, authoritative set\n- If the conversation history references documents that are not in the current system context, those documents have been removed or deactivated — do not reference them\n- If you see a [Document Update] system message, it means the document set changed at that point in the conversation — adjust your understanding accordingly\n- When documents change, base all subsequent answers solely on the current document set\n\n**Important:**\n- Never fabricate information not present in the documents\n- If something isn't covered in the documents, say so clearly\n- Preserve all data points, statistics, and specific terms exactly as they appear in the source material\n\n**Card Suggestions:**\nAt the end of every regular response (NOT card content generation responses), include 2-4 suggested prompts that the user could use to generate infographic cards from the discussion so far. Format them in a special block like this:\n\n\\`\\`\\`card-suggestions\nGenerate a card summarizing the key findings\nCreate a comparison card of the main themes across documents\nMake a card highlighting the statistics and data points\n\\`\\`\\`\n\nEach suggestion should be a concise, actionable prompt (under 15 words) that would produce good card content. Tailor suggestions to the specific conversation context — reference actual topics, themes, or data from the documents being discussed. Do NOT include this block in card content generation responses.`;\n}\n\nexport function buildCardContentInstruction(detailLevel: DetailLevel): string {\n  if (isCoverLevel(detailLevel)) {\n    throw new Error(`Use buildCoverContentInstruction for card cover levels (got '${detailLevel}')`);\n  }\n\n  let wordCountRange = '200-250';\n  let scopeGuidance = '';\n  let formattingGuidance = '';\n\n  if (detailLevel === 'Executive') {\n    wordCountRange = '70-100';\n    scopeGuidance = `This is an EXECUTIVE SUMMARY. Prioritize ruthlessly — include only the single most important insight, conclusion, or finding. Omit supporting details, examples, breakdowns, and secondary points. No tables. No sub-sections. Use at most 2-3 bullet points or a single short paragraph under one ## heading. Think: what would a CEO need to see in a 10-second glance?`;\n    formattingGuidance = `- Use bold for 1-2 key metrics or terms only\n- Maximum one ## heading below the title\n- No tables, no ###, no blockquotes\n- Prefer a tight paragraph or 2-3 bullets — nothing more`;\n  } else if (detailLevel === 'Detailed') {\n    wordCountRange = '450-500';\n    scopeGuidance = `This is a DETAILED analysis. Include comprehensive data, supporting evidence, comparisons, and relationships. Use the full markdown range including tables where data warrants it. Cover all relevant dimensions of the topic.`;\n    formattingGuidance = `- Use bullet points for lists of features, attributes, or non-sequential items\n- Use numbered lists for sequential steps, ranked items, or ordered processes\n- Use tables when comparing items across multiple dimensions or presenting structured data\n- Use bold for key terms, metrics, and important phrases\n- Use blockquotes for notable quotes or callout statements\n- Choose the format that best represents the data`;\n  } else {\n    scopeGuidance = `This is a STANDARD summary. Cover the key points, important data, and primary relationships. Include enough detail to be informative but stay concise.`;\n    formattingGuidance = `- Use bullet points for lists of features, attributes, or non-sequential items\n- Use numbered lists for sequential steps, ranked items, or ordered processes\n- Use tables only when comparing 3+ items across multiple dimensions\n- Use bold for key terms, metrics, and important phrases\n- Choose the format that best represents the data`;\n  }\n\n  return `\nCARD CONTENT GENERATION MODE — THIS OVERRIDES ALL OTHER INSTRUCTIONS.\n\nCRITICAL: Your response MUST begin with a single # heading as the card title. This is mandatory — every card needs a title. The heading should be concise and descriptive (2-8 words). Never omit the # title heading.\n\nWORD COUNT: EXACTLY ${wordCountRange} words. This is a hard limit. Count your output words before responding. If over, cut. If under, you may add — but NEVER exceed the upper bound. The # title heading does NOT count toward the word limit.\n\n**Scope:** ${scopeGuidance}\n\n**Analysis task:**\n1. Re-read the source documents in full — do not rely on conversation memory\n2. Identify content relevant to the user's request\n3. Extract and restructure into infographic-ready text within the word limit\n\n**Content rules:**\n- Make the topic's hierarchy and connections immediately clear without referring back to the source\n- Make implicit relationships explicit (cause-effect, sequence, hierarchy, comparison)\n- Concise, direct phrasing — no filler, no repetition\n- Preserve data points and statistics exactly as written in the documents\n- Do not invent information not present in the documents\n\n**Heading hierarchy:**\n- Start with a single # heading as the card title (concise, descriptive)\n- Use ## for sections, ### for subsections (if word count permits)\n- Never skip heading levels\n\n**Formatting:**\n${formattingGuidance}\n\n**Output:**\nReturn ONLY the card content starting with #. No preamble, no explanation, no card-suggestions block. NOTHING outside the card content. The FIRST line MUST be a # heading.\n\nREMINDER: Always start with # [Title]. ${wordCountRange} words maximum. Count before responding.`.trim();\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\promptUtils.ts","messages":[{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":17,"column":17,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":17,"endColumn":27,"fix":{"range":[748,758],"text":"{return '';}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 21 to the 15 allowed.","line":180,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":180,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":340,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":340,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":341,"column":46,"nodeType":"Literal","messageId":"noMagic","endLine":341,"endColumn":47},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":341,"column":49,"nodeType":"Literal","messageId":"noMagic","endLine":341,"endColumn":50},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":342,"column":36,"nodeType":"Literal","messageId":"noMagic","endLine":342,"endColumn":37},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":346,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":346,"endColumn":61,"fix":{"range":[12106,12144],"text":"{hue = b > 150 ? 'pink' : 'red-orange';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 150.","line":346,"column":33,"nodeType":"Literal","messageId":"noMagic","endLine":346,"endColumn":36},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":347,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":347,"endColumn":42,"fix":{"range":[12172,12186],"text":"{hue = 'green';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":348,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":348,"endColumn":62,"fix":{"range":[12214,12248],"text":"{hue = r > 150 ? 'purple' : 'blue';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 150.","line":348,"column":38,"nodeType":"Literal","messageId":"noMagic","endLine":348,"endColumn":41},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":349,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":349,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":349,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":349,"endColumn":30},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":349,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":349,"endColumn":58,"fix":{"range":[12291,12306],"text":"{hue = 'yellow';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":350,"column":16,"nodeType":"Literal","messageId":"noMagic","endLine":350,"endColumn":19},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 120.","line":350,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":350,"endColumn":30},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":350,"column":43,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":350,"endColumn":58,"fix":{"range":[12349,12364],"text":"{hue = 'orange';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":351,"column":30,"nodeType":"Literal","messageId":"noMagic","endLine":351,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 30.","line":351,"column":54,"nodeType":"Literal","messageId":"noMagic","endLine":351,"endColumn":56},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":351,"column":58,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":351,"endColumn":71,"fix":{"range":[12422,12435],"text":"{hue = 'gray';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 200.","line":355,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":355,"endColumn":23},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":355,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":355,"endColumn":46,"fix":{"range":[12508,12529],"text":"{lightness = 'light ';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 140.","line":356,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":356,"endColumn":28},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":356,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":356,"endColumn":45,"fix":{"range":[12559,12574],"text":"{lightness = '';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 80.","line":357,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":357,"endColumn":27},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":357,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":357,"endColumn":51,"fix":{"range":[12603,12625],"text":"{lightness = 'medium ';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'else'.","line":358,"column":8,"nodeType":"IfStatement","messageId":"missingCurlyAfter","endLine":358,"endColumn":28,"fix":{"range":[12633,12653],"text":"{lightness = 'dark ';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":634,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":634,"endColumn":49,"fix":{"range":[24774,24801],"text":"{blocks.push(referenceNote);}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":28,"fixableErrorCount":0,"fixableWarningCount":12,"source":"import { StylingOptions } from '../../types';\nimport { STYLE_IDENTITIES } from '../ai';\n\n// ─────────────────────────────────────────────────────────────────\n// Expert Priming — Subject-Based Domain Expert Injection\n// ─────────────────────────────────────────────────────────────────\n// Builds a priming sentence that makes Claude adopt the role of a\n// top-tier domain expert based on the nugget's subject. Injected\n// into system prompts across all content-generating pipelines.\n// ─────────────────────────────────────────────────────────────────\n\n/**\n * Build expert priming text from a nugget's subject string.\n * Returns an empty string if subject is falsy.\n */\nexport function buildExpertPriming(subject?: string): string {\n  if (!subject) return '';\n  return `You are a domain expert on the following subject: ${subject}. Use accurate terminology and professional judgment to organize and present the source material. Do NOT add facts, claims, data, or context from your own knowledge — work exclusively with what the source documents provide.`;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Prompt Utilities for gemini-3-pro-image-preview\n// ─────────────────────────────────────────────────────────────────\n// All functions in this file produce narrative prose optimized for\n// the image generation model. No markdown, no XML, no key-value\n// pairs — these are leakage vectors in image-model prompts.\n// ─────────────────────────────────────────────────────────────────\n\n// ─────────────────────────────────────────────────────────────────\n// S2 / B1: Content Markdown → Bracketed Tags\n// ─────────────────────────────────────────────────────────────────\n// Transforms synthesis output (standard markdown) into bracketed\n// structural tags safe for the image model. The synthesis phase\n// continues to output markdown for other consumers; this transform\n// is applied only when assembling the image-model prompt.\n// ─────────────────────────────────────────────────────────────────\n\nexport function transformContentToTags(\n  synthesisContent: string,\n  cardTitle: string\n): string {\n  let content = synthesisContent;\n\n  // Strip horizontal rules\n  content = content.replace(/^---+$/gm, '');\n\n  // Convert heading levels to bracketed tags (most specific first)\n  // #### Sub-subsection → [DETAIL] Sub-subsection\n  content = content.replace(/^####\\s+(.+)$/gm, '[DETAIL] $1');\n  // ### Subheading → [SUBSECTION] Subheading\n  content = content.replace(/^###\\s+(.+)$/gm, '[SUBSECTION] $1');\n  // ## Heading → [SECTION] Heading\n  content = content.replace(/^##\\s+(.+)$/gm, '[SECTION] $1');\n  // # Title → strip entirely (the wrapper adds [TITLE] from cardTitle, so inline H1s are duplicates)\n  content = content.replace(/^#\\s+.+$/gm, '');\n\n  // Strip bold markers\n  content = content.replace(/\\*\\*(.+?)\\*\\*/g, '$1');\n\n  // Strip italic markers\n  content = content.replace(/\\*(.+?)\\*/g, '$1');\n\n  // Strip bullet dashes (leading - or * list items) — keep the text\n  content = content.replace(/^[\\s]*[-*]\\s+/gm, '');\n\n  // Collapse excessive blank lines to single blank line\n  content = content.replace(/\\n{3,}/g, '\\n\\n');\n\n  // Trim\n  content = content.trim();\n\n  // Wrap with title and delimiters\n  return `[BEGIN TEXT CONTENT]\\n[TITLE] ${cardTitle}\\n\\n${content}\\n[END TEXT CONTENT]`;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// B2: Sanitize Planner Output\n// ─────────────────────────────────────────────────────────────────\n// Safety net that strips any residual toxic patterns from the\n// planner's output before it reaches the image model. Catches\n// font names, point sizes, hex colors, and key-value patterns\n// that the planner was told not to produce but might anyway.\n// ─────────────────────────────────────────────────────────────────\n\n// Known font families that should never appear in planner output\nconst FONT_NAMES = [\n  'Montserrat', 'Inter', 'Roboto', 'Open Sans', 'Lato', 'Poppins',\n  'Raleway', 'Nunito', 'Source Sans', 'Work Sans', 'DM Sans',\n  'Playfair Display', 'Merriweather', 'Lora', 'Georgia', 'Garamond',\n  'PT Serif', 'Libre Baskerville', 'Source Serif', 'Crimson Text',\n  'Source Code Pro', 'Fira Code', 'JetBrains Mono', 'IBM Plex Mono', 'IBM Plex Sans',\n  'Helvetica', 'Arial', 'Verdana', 'Tahoma', 'Trebuchet',\n  // Additional fonts from STYLE_FONTS\n  'Bebas Neue', 'Orbitron', 'Rajdhani', 'Oswald', 'Impact',\n  'Arial Black', 'DIN Condensed', 'Pacifico', 'Comic Sans MS',\n  'Rubik', 'Quicksand', 'Futura', 'Courier New',\n];\n\nexport function sanitizePlannerOutput(plannerText: string): string {\n  let text = plannerText;\n\n  // ── Strip markdown formatting (leakage vectors for image model) ──\n\n  // Remove heading markers\n  text = text.replace(/^#{1,6}\\s+/gm, '');\n\n  // Remove bold markers\n  text = text.replace(/\\*\\*(.+?)\\*\\*/g, '$1');\n\n  // Remove italic markers\n  text = text.replace(/\\*(.+?)\\*/g, '$1');\n\n  // Remove horizontal rules\n  text = text.replace(/^---+$/gm, '');\n\n  // Remove numbered list prefixes but keep the text\n  text = text.replace(/^\\d+\\.\\s+/gm, '');\n\n  // Remove bullet dashes but keep the text\n  text = text.replace(/^[\\s]*[-*]\\s+/gm, '');\n\n  // ── Strip toxic payload patterns ──\n\n  // Remove lines that are purely font specifications\n  // Pattern: \"Title: FontName Bold, 42pt, ...\"\n  text = text.replace(\n    /^.*?:\\s*(?:(?:Montserrat|Inter|Roboto|Open Sans|Lato|Poppins|Raleway|Nunito|Helvetica|Arial|Bebas Neue|Orbitron|Rajdhani|Oswald|Impact|DIN Condensed|Pacifico|Comic Sans MS|Rubik|Quicksand|Futura|Courier New|IBM Plex Sans|IBM Plex Mono)\\s+(?:Bold|SemiBold|Regular|Medium|Light|Thin|ExtraBold|Black)\\s*,?\\s*\\d+(?:-\\d+)?pt).*$/gim,\n    ''\n  );\n\n  // Remove standalone point size specs (e.g., \"36pt\", \"22-28pt\", \"36-48pt\")\n  text = text.replace(/\\b\\d{1,3}(?:-\\d{1,3})?pt\\b/gi, '');\n\n  // Remove hex color codes (#RRGGBB or #RGB)\n  text = text.replace(/#[0-9A-Fa-f]{3,8}\\b/g, '');\n\n  // Remove known font names when they appear as nouns (not inside content)\n  for (const font of FONT_NAMES) {\n    // Replace font name when it appears in a typography/font context\n    // Use word boundary to avoid partial matches\n    const escaped = font.replace(/\\s+/g, '\\\\s+');\n    text = text.replace(\n      new RegExp(`\\\\b${escaped}\\\\b\\\\s*(?:Bold|SemiBold|Regular|Medium|Light|Thin|ExtraBold|Black)?`, 'gi'),\n      ''\n    );\n  }\n\n  // Remove font weight + size combos that slipped through (e.g., \"Bold, 42pt\")\n  text = text.replace(/\\b(?:Bold|SemiBold|Regular|Medium|Light)\\s*,?\\s*\\d+(?:-\\d+)?pt/gi, '');\n\n  // Remove pixel values (e.g., \"24px\", \"1920x1080\")\n  text = text.replace(/\\b\\d{2,4}x\\d{2,4}\\b/g, '');\n  text = text.replace(/\\b\\d+px\\b/gi, '');\n\n  // Clean up orphaned commas, colons, and dashes from removed content\n  text = text.replace(/,\\s*,/g, ',');\n  text = text.replace(/:\\s*$/gm, '');\n  text = text.replace(/:\\s*,/g, ':');\n\n  // Collapse excessive whitespace\n  text = text.replace(/[ \\t]{2,}/g, ' ');\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n\n  return text.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// B4 / S1 / S3: Narrative Style Block Builder\n// ─────────────────────────────────────────────────────────────────\n// Composes palette, typography, and style as narrative prose.\n// Dynamically built from user settings. Includes style–palette\n// conflict detection and override language.\n// ─────────────────────────────────────────────────────────────────\n\n/**\n * Maps a hex color code to a human-readable descriptive name.\n * Used to create narrative color descriptions that bind colors\n * to objects semantically (e.g., \"deep navy for headers\").\n */\nexport function hexToColorName(hex: string): string {\n  const normalizedHex = hex.toUpperCase().replace('#', '');\n\n  // Direct lookup for common palette colors\n  const knownColors: Record<string, string> = {\n    // ── Whites, Creams & Off-Whites ──\n    'FFFFFF': 'white',\n    'FAFAFA': 'off-white',\n    'F5F7FA': 'light grey',\n    'F5F5F5': 'soft light gray',\n    'F4ECD8': 'warm cream',\n    'FAF3E8': 'warm ivory',\n    'FFF8F0': 'warm white',\n    'FAF0E6': 'linen cream',\n    'F0F0F0': 'pale gray',\n    'F4F7F9': 'cool white',\n    'F0F0F5': 'pale lavender',\n\n    // ── Grays ──\n    'E0E0E0': 'light gray',\n    'EEEEEE': 'light gray',\n    'D0D0D0': 'silver gray',\n    'CCCCCC': 'medium gray',\n    'C0C0C0': 'silver',\n    'A0A0A0': 'warm gray',\n    '999999': 'neutral gray',\n    '888888': 'mid grey',\n    '808080': 'mid gray',\n    '6B7B8D': 'slate grey',\n    '666666': 'dark gray',\n    '555555': 'mid grey',\n    '4A4A4A': 'medium grey',\n    '333333': 'dark charcoal',\n    '2D3436': 'dark grey',\n    '2D2D2D': 'near-black',\n    '222222': 'dark grey',\n    '1A1A1A': 'near black',\n    '1A1A2E': 'dark navy',\n    '111111': 'near-black',\n    '0D0D0D': 'near black',\n    '000000': 'black',\n\n    // ── Blues ──\n    '1877F2': 'facebook blue',\n    '1A365D': 'deep navy',\n    '1D3557': 'navy blue',\n    '1E3A5F': 'deep navy',\n    '14213D': 'dark navy',\n    '2C3E50': 'dark slate',\n    '2C5282': 'slate blue',\n    '2B6CB0': 'medium blue',\n    '2D5BFF': 'bright blue',\n    '2D8CFF': 'bright blue',\n    '3182CE': 'ocean blue',\n    '3D405B': 'muted navy',\n    '4299E1': 'sky blue',\n    '4A90D9': 'medium blue',\n    '63B3ED': 'light blue',\n    '7FB3D8': 'soft blue',\n    '87CEEB': 'sky blue',\n    '0B3D91': 'deep blue',\n    '0066CC': 'royal blue',\n    '003366': 'dark navy',\n    '0047AB': 'cobalt blue',\n    '0077B6': 'cerulean blue',\n    '0066FF': 'bold blue',\n    '00B4D8': 'cyan blue',\n\n    // ── Data-Centric Minimalist palette ──\n    '28435A': 'deep teal',\n    '5F9EA0': 'muted teal',\n    '9BC4CB': 'soft cyan',\n    '212529': 'charcoal',\n\n    // ── Reds ──\n    'FF0040': 'hot pink',\n    'E63946': 'crimson red',\n    'E53E3E': 'bright red',\n    'C53030': 'deep red',\n    'FC8181': 'salmon',\n    'FF0000': 'red',\n    'FF6F61': 'coral',\n    'CC0000': 'crimson',\n    'B91C1C': 'dark red',\n    'DC2626': 'bold red',\n    'EF4444': 'bright red',\n\n    // ── Greens ──\n    '38A169': 'emerald green',\n    '39FF14': 'green neon',\n    '2F855A': 'forest green',\n    '48BB78': 'fresh green',\n    '50C878': 'emerald green',\n    '5B8C5A': 'olive green',\n    '68D391': 'light green',\n    '81B29A': 'sage green',\n    'A8D5A2': 'soft green',\n    '276749': 'deep green',\n    '059669': 'teal green',\n    '10B981': 'bright emerald',\n    '22C55E': 'vivid green',\n\n    // ── Oranges & Yellows ──\n    'D04A02': 'burnt orange',\n    'EB8C00': 'tangerine',\n    'C75B12': 'rustic orange',\n    'D4A03C': 'mustard gold',\n    'DD6B20': 'warm orange',\n    'E07A5F': 'terra cotta',\n    'ED8936': 'bright orange',\n    'F2CC8F': 'sandy peach',\n    'F4845F': 'peach orange',\n    'F6AD55': 'golden orange',\n    'FF6B35': 'vivid orange',\n    'FFDE00': 'bright yellow',\n    'FFD700': 'gold',\n    'FFC947': 'warm yellow',\n    'ECC94B': 'golden yellow',\n    'F59E0B': 'amber',\n    'F97316': 'vivid orange',\n    'FBBF24': 'bright gold',\n    '3B2F2F': 'dark brown',\n\n    // ── Purples ──\n    '6C5CE7': 'purple',\n    '805AD5': 'vibrant purple',\n    '6B46C1': 'deep purple',\n    '9F7AEA': 'lavender purple',\n    'B794F4': 'light purple',\n    'BF00FF': 'purple neon',\n    '553C9A': 'dark violet',\n    '7C3AED': 'electric violet',\n    '8B5CF6': 'bright purple',\n\n    // ── Teals & Cyans ──\n    '00CEC9': 'turquoise',\n    '00F0FF': 'cyan neon',\n    '319795': 'teal',\n    '2C7A7B': 'deep teal',\n    '38B2AC': 'bright teal',\n    '4FD1C5': 'light teal',\n    '0D9488': 'rich teal',\n    '14B8A6': 'vivid teal',\n\n    // ── Pinks ──\n    'D4A0C0': 'dusty rose',\n    'D53F8C': 'magenta pink',\n    'ED64A6': 'bright pink',\n    'F687B3': 'soft pink',\n    'FBB6CE': 'light pink',\n    'FD79A8': 'soft pink',\n    'EC4899': 'hot pink',\n  };\n\n  if (knownColors[normalizedHex]) {\n    return knownColors[normalizedHex];\n  }\n\n  // Fallback: parse RGB and generate a basic descriptor\n  const r = parseInt(normalizedHex.substring(0, 2), 16);\n  const g = parseInt(normalizedHex.substring(2, 4), 16);\n  const b = parseInt(normalizedHex.substring(4, 6), 16);\n  const brightness = (r + g + b) / 3;\n\n  // Determine base hue\n  let hue = 'neutral';\n  if (r > g && r > b) hue = b > 150 ? 'pink' : 'red-orange';\n  else if (g > r && g > b) hue = 'green';\n  else if (b > r && b > g) hue = r > 150 ? 'purple' : 'blue';\n  else if (r > 200 && g > 200 && b < 100) hue = 'yellow';\n  else if (r > 200 && g > 120 && b < 100) hue = 'orange';\n  else if (Math.abs(r - g) < 30 && Math.abs(g - b) < 30) hue = 'gray';\n\n  // Determine lightness\n  let lightness = '';\n  if (brightness > 200) lightness = 'light ';\n  else if (brightness > 140) lightness = '';\n  else if (brightness > 80) lightness = 'medium ';\n  else lightness = 'dark ';\n\n  return `${lightness}${hue}`.trim();\n}\n\n/**\n * Maps a font family name to a descriptive visual characteristic.\n * The image model cannot load fonts by name — it only understands\n * visual descriptions like \"geometric sans-serif\" or \"elegant serif\".\n */\nexport function fontToDescriptor(fontName: string): string {\n  const name = fontName.toLowerCase().trim();\n\n  // Known font → descriptor mappings\n  const fontDescriptors: Record<string, string> = {\n    // Geometric sans-serifs\n    'montserrat': 'clean, geometric sans-serif',\n    'poppins': 'rounded, geometric sans-serif',\n    'futura': 'sharp, geometric sans-serif',\n    'raleway': 'thin, elegant sans-serif',\n    'dm sans': 'compact, geometric sans-serif',\n    'nunito': 'rounded, friendly sans-serif',\n    'quicksand': 'rounded, modern sans-serif',\n\n    // Condensed / display sans-serifs\n    'bebas neue': 'tall, condensed, all-caps sans-serif',\n    'oswald': 'condensed, strong, industrial sans-serif',\n    'impact': 'heavy, ultra-condensed, bold sans-serif',\n    'arial black': 'heavy, wide, bold sans-serif',\n    'din condensed': 'technical, narrow, industrial sans-serif',\n\n    // Futuristic / technical sans-serifs\n    'orbitron': 'futuristic, geometric, squared sans-serif',\n    'rajdhani': 'angular, condensed, technical sans-serif',\n\n    // Humanist / grotesque sans-serifs\n    'inter': 'modern, neutral sans-serif',\n    'roboto': 'contemporary, versatile sans-serif',\n    'open sans': 'friendly, neutral sans-serif',\n    'lato': 'warm, humanist sans-serif',\n    'source sans': 'technical, clean sans-serif',\n    'source sans pro': 'technical, clean sans-serif',\n    'work sans': 'minimal, clean sans-serif',\n    'rubik': 'rounded, geometric, friendly sans-serif',\n    'noto sans': 'versatile, neutral sans-serif',\n    'helvetica': 'classic, neutral sans-serif',\n    'arial': 'neutral, clean sans-serif',\n    'verdana': 'wide, readable sans-serif',\n\n    // Script / handwritten\n    'pacifico': 'flowing, casual, handwritten script',\n    'comic sans ms': 'casual, rounded, handwritten sans-serif',\n\n    // Serifs\n    'playfair display': 'elegant, high-contrast serif',\n    'merriweather': 'sturdy, readable serif',\n    'lora': 'calligraphic, balanced serif',\n    'georgia': 'classic, rounded serif',\n    'garamond': 'refined, old-style serif',\n    'pt serif': 'traditional, professional serif',\n    'libre baskerville': 'classic, transitional serif',\n    'source serif': 'sturdy, slab-influenced serif',\n    'source serif pro': 'sturdy, slab-influenced serif',\n    'crimson text': 'elegant, bookish serif',\n    'noto serif': 'versatile, neutral serif',\n    'times new roman': 'traditional, formal serif',\n\n    // Monospace\n    'source code pro': 'clean, technical monospace',\n    'fira code': 'modern, ligature-rich monospace',\n    'jetbrains mono': 'sharp, developer monospace',\n    'ibm plex mono': 'structured, technical monospace',\n    'ibm plex sans': 'engineered, technical sans-serif',\n    'courier': 'classic typewriter monospace',\n    'courier new': 'classic typewriter monospace',\n  };\n\n  // Try exact match\n  if (fontDescriptors[name]) {\n    return fontDescriptors[name];\n  }\n\n  // Try partial match (e.g., \"Source Sans 3\" → \"source sans\")\n  for (const [key, descriptor] of Object.entries(fontDescriptors)) {\n    if (name.includes(key) || key.includes(name)) {\n      return descriptor;\n    }\n  }\n\n  // Fallback: infer from common naming patterns\n  if (name.includes('serif') && !name.includes('sans')) {\n    return 'professional serif';\n  }\n  if (name.includes('sans')) {\n    return 'clean sans-serif';\n  }\n  if (name.includes('mono') || name.includes('code')) {\n    return 'clean monospace';\n  }\n  if (name.includes('slab')) {\n    return 'bold, slab-serif';\n  }\n  if (name.includes('display') || name.includes('headline')) {\n    return 'expressive display typeface';\n  }\n\n  // Last resort\n  return 'clean, professional typeface';\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Style–Palette Conflict Detection (S3)\n// ─────────────────────────────────────────────────────────────────\n// Style names carry trained color associations. When the user's\n// palette conflicts, we add explicit override language.\n// Maps the actual 13 styles from VISUAL_STYLES in ai.ts.\n// ─────────────────────────────────────────────────────────────────\n\n/**\n * Known color families associated with the app's visual styles.\n * Used to detect palette–style conflicts. Keys must match\n * the lowercased style names from VISUAL_STYLES in ai.ts.\n */\nconst STYLE_COLOR_FAMILIES: Record<string, string[]> = {\n  'flat design':           ['blue', 'gray', 'slate', 'orange'],\n  'data-centric minimalist': ['navy', 'teal', 'blue', 'gray'],\n  'isometric':             ['blue', 'green', 'coral', 'red'],\n  'line art':              ['black', 'gray', 'red'],\n  'retro / mid-century':   ['orange', 'green', 'gold', 'cream', 'brown'],\n  'risograph / duotone':   ['red', 'navy', 'cream'],\n  'neon / dark mode':      ['cyan', 'purple', 'green', 'neon', 'black'],\n  'paper cutout':          ['orange', 'green', 'sand', 'cream', 'terracotta'],\n  'pop art':               ['red', 'blue', 'yellow', 'black'],\n  'watercolour':           ['blue', 'pink', 'green', 'rose'],\n  'blueprint':             ['blue', 'navy', 'gold'],\n  'doodle art':            ['black', 'gray', 'orange'],\n  'geometric gradient':    ['purple', 'teal', 'pink'],\n  'corporate memphis':     ['blue', 'orange', 'coral', 'yellow', 'navy'],\n  'pwc corporate':         ['orange', 'black', 'charcoal', 'tangerine'],\n};\n\nfunction detectPaletteStyleConflict(style: string, palette: StylingOptions['palette']): boolean {\n  const normalizedStyle = style.toLowerCase().trim();\n  const expectedFamily = STYLE_COLOR_FAMILIES[normalizedStyle];\n\n  if (!expectedFamily) {\n    // Unknown style — can't detect conflict, assume potential mismatch\n    return true;\n  }\n\n  // Check if the primary and secondary palette colors align with the style's family\n  const paletteColorNames = [\n    hexToColorName(palette.primary),\n    hexToColorName(palette.secondary),\n    hexToColorName(palette.accent),\n  ].map(name => name.toLowerCase());\n\n  // If at least one palette color matches the style's expected family, no conflict\n  for (const colorName of paletteColorNames) {\n    for (const familyKeyword of expectedFamily) {\n      if (colorName.includes(familyKeyword)) {\n        return false;\n      }\n    }\n  }\n\n  // No palette color matched any expected family keyword — conflict detected\n  return true;\n}\n\n/**\n * Builds the complete narrative style block from user settings.\n * Produces two paragraphs: color palette and typography.\n * All in narrative prose — no key-value pairs, no lists, no markdown.\n */\nexport function buildNarrativeStyleBlock(settings: StylingOptions): string {\n  // ── Style Identity (creative driver) ──\n  const identity = STYLE_IDENTITIES[settings.style] || '';\n  const styleParagraph = identity\n    ? `Design this infographic in a ${settings.style} aesthetic. ${identity} ` +\n      `Let this style drive every visual decision — shapes, decorations, title treatments, ` +\n      `section dividers, background textures, and iconography.`\n    : `Design this infographic in a bold ${settings.style} aesthetic. Let the ${settings.style} style ` +\n      `drive every visual decision — shapes, decorations, title treatments, section dividers, ` +\n      `background textures, and iconography should all feel authentically ${settings.style}.`;\n\n  // ── Color Palette ──\n  const bgName = hexToColorName(settings.palette.background);\n  const primaryName = hexToColorName(settings.palette.primary);\n  const secondaryName = hexToColorName(settings.palette.secondary);\n  const accentName = hexToColorName(settings.palette.accent);\n  const textName = hexToColorName(settings.palette.text);\n\n  const hasConflict = detectPaletteStyleConflict(settings.style, settings.palette);\n  const overrideClause = hasConflict\n    ? ` Use this custom palette instead of the typical ${settings.style} colors.`\n    : '';\n\n  const paletteParagraph =\n    `Color palette: ${bgName} (${settings.palette.background}) background, ` +\n    `${primaryName} (${settings.palette.primary}) for headers and primary elements, ` +\n    `${secondaryName} (${settings.palette.secondary}) for secondary accents, ` +\n    `${accentName} (${settings.palette.accent}) for callout numbers and highlights, ` +\n    `${textName} (${settings.palette.text}) for body text. ` +\n    `Stay within these five colors but allow natural tonal variation for depth and dimension.${overrideClause}`;\n\n  // ── Typography ──\n  const primaryFontDesc = fontToDescriptor(settings.fonts.primary);\n  const secondaryFontDesc = fontToDescriptor(settings.fonts.secondary);\n\n  const sameFamily = primaryFontDesc === secondaryFontDesc;\n  const typographyParagraph = sameFamily\n    ? `Use a ${primaryFontDesc} typeface throughout. Maintain a clear size hierarchy ` +\n      `from title to headers to body text. All text must be legible.`\n    : `Use a ${primaryFontDesc} typeface for titles and headers, and a ${secondaryFontDesc} ` +\n      `typeface for body text. Maintain a clear size hierarchy. All text must be legible.`;\n\n  return `${styleParagraph}\\n\\n${paletteParagraph}\\n\\n${typographyParagraph}`;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// S7 / B3: Prompt Assembler\n// ─────────────────────────────────────────────────────────────────\n// Composes the complete image-model prompt in optimal order:\n// 1. Role & output type\n// 2. Visual style & palette (narrative)\n// 3. Layout structure (from planner or auto-inferred)\n// 4. Content to render (bracketed tags)\n// ─────────────────────────────────────────────────────────────────\n\nexport function assembleRendererPrompt(\n  cardTitle: string,\n  synthesisContent: string,\n  settings: StylingOptions,\n  plannerOutput?: string,\n  referenceNote?: string,\n  subject?: string,\n): string {\n  // 1. Role — open-ended, lets style drive the aesthetic\n  const domainClause = subject\n    ? ` The content belongs to the domain of \"${subject}\" — use domain-appropriate visual metaphors, iconography, and diagram conventions.`\n    : '';\n  const role = `You are an expert Information Designer. Create a visually striking infographic.${domainClause}`;\n\n  // 2. Style & Palette (narrative prose from settings — style leads)\n  const styleBlock = buildNarrativeStyleBlock(settings);\n\n  // 3. Layout — planner output sandwiched with style enforcement\n  let layoutBlock: string;\n  if (plannerOutput) {\n    const cleanPlan = sanitizePlannerOutput(plannerOutput);\n    layoutBlock =\n      `Use the following creative brief to guide the information architecture and visual concept. ` +\n      `Interpret it strictly within the ${settings.style} style described above — the style identity ` +\n      `is non-negotiable and takes precedence over any visual interpretation of the brief.\\n\\n` +\n      `${cleanPlan}\\n\\n` +\n      `Every single piece of text content provided below must appear in the final image — ` +\n      `no heading, bullet point, statistic, or detail may be omitted. If the layout concept ` +\n      `cannot fit all the content, adapt the layout rather than dropping text. Reduce whitespace, ` +\n      `add rows, extend sections, or use a denser arrangement — but never cut content. ` +\n      `All text must be legible with high contrast.`;\n  } else {\n    layoutBlock =\n      `Choose the spatial arrangement that best fits the content hierarchy — ` +\n      `grids, flowing sections, or radial layouts as appropriate. ` +\n      `Every single piece of text content provided below must appear in the final image — ` +\n      `no heading, bullet point, statistic, or detail may be omitted. If the layout ` +\n      `cannot fit all the content, adapt it rather than dropping text. ` +\n      `All text must be legible with high contrast.`;\n  }\n\n  // 4. Content (transformed from markdown to bracketed tags)\n  const contentBlock = transformContentToTags(synthesisContent, cardTitle);\n\n  // Assemble: role → style → [reference] → layout → content\n  const blocks = [role, styleBlock];\n  if (referenceNote) blocks.push(referenceNote);\n  blocks.push(layoutBlock, contentBlock);\n  return blocks.join('\\n\\n');\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\prompts\\pwcGeneration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'sanitizePlannerOutput' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"sanitizePlannerOutput"},"fix":{"range":[114,139],"text":""},"desc":"Remove unused variable \"sanitizePlannerOutput\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'cardTitle' is defined but never used. Allowed unused args must match /^_/u.","line":43,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":12},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":57,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":57,"endColumn":29,"fix":{"range":[2471,2481],"text":"{return '';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":58,"column":119,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":58,"endColumn":134,"fix":{"range":[2600,2615],"text":"{return trimmed;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":134,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":134,"endColumn":81,"fix":{"range":[6928,6978],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":134,"column":51,"nodeType":"Literal","messageId":"defineConstant","endLine":134,"endColumn":80},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":135,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":135,"endColumn":89,"fix":{"range":[7013,7067],"text":"{canvasDescription = 'square — equal width and height';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":136,"column":85,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":136,"endColumn":135,"fix":{"range":[7152,7202],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":137,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":137,"endColumn":104,"fix":{"range":[7262,7306],"text":"{canvasDescription = 'near-square landscape';}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 600.","line":145,"column":25,"nodeType":"Literal","messageId":"noMagic","endLine":145,"endColumn":28},{"ruleId":"prefer-template","severity":1,"message":"Unexpected string concatenation.","line":154,"column":19,"nodeType":"BinaryExpression","messageId":"unexpectedStringConcatenation","endLine":154,"endColumn":41,"fix":{"range":[7791,7813],"text":"`${expertPriming  }\\n\\n`"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":255,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":255,"endColumn":49,"fix":{"range":[12841,12868],"text":"{blocks.push(referenceNote);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":281,"column":31,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":281,"endColumn":81,"fix":{"range":[13750,13800],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":282,"column":35,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":282,"endColumn":89,"fix":{"range":[13835,13889],"text":"{canvasDescription = 'square — equal width and height';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":283,"column":85,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":283,"endColumn":135,"fix":{"range":[13974,14024],"text":"{canvasDescription = 'portrait — taller than wide';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":284,"column":60,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":284,"endColumn":104,"fix":{"range":[14084,14128],"text":"{canvasDescription = 'near-square landscape';}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":413,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":413,"endColumn":49,"fix":{"range":[20020,20047],"text":"{blocks.push(referenceNote);}"}}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":13,"source":"import { DetailLevel, StylingOptions } from '../../types';\nimport {\n  buildExpertPriming,\n  transformContentToTags,\n  sanitizePlannerOutput,\n  hexToColorName,\n  fontToDescriptor,\n} from './promptUtils';\n\n// ─────────────────────────────────────────────────────────────────\n// PwC Corporate — Dedicated Prompt Pipeline (Hybrid JSON Trial)\n// ─────────────────────────────────────────────────────────────────\n// This file contains PwC-specific versions of the planner and\n// renderer prompts. When the user selects \"PwC Corporate\" style,\n// useCardGeneration.ts branches here instead of the standard\n// prompt functions. All other styles continue through the generic\n// pipeline untouched.\n//\n// TRIAL: The PwC planner outputs structured JSON instead of\n// narrative prose. The PwC renderer receives a hybrid prompt —\n// a short narrative role sentence, then a JSON design spec block,\n// then the text content in bracketed tags. This tests whether\n// structured specs produce more faithful PwC styling than prose.\n//\n// PwC design signatures encoded:\n//   - Burnt orange as singular hero accent (callout borders, focal stats)\n//   - Grey data visualizations with only focal metric in orange\n//   - Orange left-border callout boxes for key figures\n//   - Three-part structure: headline → evidence → bumper\n//   - Modular card-based layout with generous whitespace\n//   - Georgia serif headings / Arial sans-serif body contrast\n//   - Flat charts: minimal gridlines, direct value labeling\n//   - Discipline over decoration — every element serves the argument\n// ─────────────────────────────────────────────────────────────────\n\n// ─────────────────────────────────────────────────────────────────\n// Private helper: Cover content → bracketed tags\n// Mirrors coverGeneration.ts:transformCoverContentToTags\n// ─────────────────────────────────────────────────────────────────\n\nfunction transformCoverContentToTags(\n  coverContent: string,\n  cardTitle: string\n): string {\n  let content = coverContent;\n\n  content = content.replace(/^#\\s+(.+)$/gm, '[TITLE] $1');\n  content = content.replace(/^##\\s+(.+)$/gm, '[SUBTITLE] $1');\n  content = content.replace(/\\*\\*(.+?)\\*\\*/g, '$1');\n  content = content.replace(/\\*(.+?)\\*/g, '$1');\n  content = content.replace(/\\n{3,}/g, '\\n\\n');\n  content = content.trim();\n  content = content.replace(/^[-*]\\s+(.+)$/gm, '[TAKEAWAY-BULLET] $1');\n\n  const lines = content.split('\\n').map(line => {\n    const trimmed = line.trim();\n    if (!trimmed) return '';\n    if (trimmed.startsWith('[TITLE]') || trimmed.startsWith('[SUBTITLE]') || trimmed.startsWith('[TAKEAWAY-BULLET]')) return trimmed;\n    if (content.includes('[SUBTITLE]')) {\n      return `[TAGLINE] ${trimmed}`;\n    }\n    return `[TAKEAWAY] ${trimmed}`;\n  });\n\n  const taggedContent = lines.filter(l => l).join('\\n');\n  return `[BEGIN COVER CONTENT]\\n${taggedContent}\\n[END COVER CONTENT]`;\n}\n\n// ─────────────────────────────────────────────────────────────────\n// Private helper: Build PwC design specification as JSON string\n// ─────────────────────────────────────────────────────────────────\n\nfunction buildPwcDesignSpec(settings: StylingOptions): string {\n  const bgName = hexToColorName(settings.palette.background);\n  const primaryName = hexToColorName(settings.palette.primary);\n  const secondaryName = hexToColorName(settings.palette.secondary);\n  const accentName = hexToColorName(settings.palette.accent);\n  const textName = hexToColorName(settings.palette.text);\n  const primaryFontDesc = fontToDescriptor(settings.fonts.primary);\n  const secondaryFontDesc = fontToDescriptor(settings.fonts.secondary);\n\n  const spec = {\n    style: \"PwC corporate consulting\",\n    aesthetic: \"Clean, authoritative, disciplined. Professional authority and analytical rigor. Every element serves the argument — no decorative flourishes.\",\n    palette: {\n      background: `${bgName} (${settings.palette.background})`,\n      primary_accent: `${primaryName} (${settings.palette.primary}) — used ONLY for callout borders, key statistics, and focal chart highlights`,\n      secondary: `${secondaryName} (${settings.palette.secondary}) — headers and section labels`,\n      warm_accent: `${accentName} (${settings.palette.accent}) — secondary supporting highlights`,\n      text: `${textName} (${settings.palette.text}) — body text`,\n      data_elements: \"grey tones for ALL data visualizations — only the single focal metric uses orange\",\n    },\n    typography: {\n      headings: `${primaryFontDesc} — authoritative, weighty, clearly serif`,\n      body: `${secondaryFontDesc} — clean, subordinate, clearly sans-serif`,\n      signature: \"The contrast between serif headings and sans-serif body is a core visual signature\",\n      hierarchy: \"Title → section headers → body text, with clear size steps between each level\",\n    },\n    rendering_rules: [\n      \"Key statistics appear inside orange left-border callout boxes: a thick burnt orange vertical line on the left edge with content indented to its right\",\n      \"Hero statistics are oversized burnt orange numerals that serve as the primary visual anchors\",\n      \"Three-zone vertical structure: headline conclusion at top, evidence and data in the middle, bumper takeaway or source attribution at the bottom\",\n      \"Flat charts with minimal gridlines and direct value labeling — no 3D effects, no drop shadows, no rounded bar edges\",\n      \"All chart bars and columns render in grey except the single focal metric which renders in burnt orange\",\n      \"Section dividers are thin horizontal rules — not heavy borders, not decorative elements\",\n      \"Layout uses modular card-based blocks with generous whitespace between them\",\n      \"No gradients, no textures, no background images, no decorative patterns — flat clean surfaces only\",\n    ],\n    content_completeness: \"CRITICAL: Every heading, bullet, statistic, and detail from the text content must appear in the final image. If the layout cannot fit everything, adapt the layout — add rows, reduce spacing, use smaller modules — but NEVER drop content.\",\n  };\n\n  return JSON.stringify(spec, null, 2);\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 1. PwC Planner — Standard Cards (JSON output)\n// ─────────────────────────────────────────────────────────────────\n// Same signature as buildPlannerPrompt in contentGeneration.ts.\n// Instructs Gemini Flash to output structured JSON instead of\n// narrative prose. The JSON is then embedded into the renderer's\n// design spec as the \"visual_brief\" field.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildPwcPlannerPrompt(\n  cardTitle: string,\n  synthesisContent: string,\n  aspectRatio: string = '16:9',\n  previousPlan?: string,\n  subject?: string,\n): string {\n  const wordCount = synthesisContent.split(/\\s+/).filter(w => w.length > 0).length;\n\n  let canvasDescription = 'landscape — wider than tall';\n  if (aspectRatio === '9:16') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '1:1') canvasDescription = 'square — equal width and height';\n  else if (aspectRatio === '4:5' || aspectRatio === '3:4' || aspectRatio === '2:3') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '5:4' || aspectRatio === '3:2') canvasDescription = 'near-square landscape';\n\n  let diversityClause = '';\n  if (previousPlan) {\n    diversityClause = `\n## PREVIOUS CONCEPT (DO NOT REPEAT):\nThe following visual concept was already used. You MUST propose a fundamentally different approach — different diagram type, different information structure. Do not reuse the same concept with minor variations.\n---\n${previousPlan.slice(0, 600)}\n---\n`;\n  }\n\n  const expertPriming = buildExpertPriming(subject);\n  return `\n# VISUAL BRIEF — [${cardTitle}]\n\n${expertPriming ? expertPriming + '\\n\\n' : ''}You are an expert information designer creating a visual brief for a PwC corporate consulting infographic.\n\n## CANVAS:\n- Aspect ratio: ${aspectRatio} (${canvasDescription})\n- Content density: ~${wordCount} words\n${diversityClause}\n## CONTENT:\n---\n${synthesisContent}\n---\n\n## PwC INFORMATION ARCHITECTURE:\nYour visual concept must follow PwC corporate consulting principles:\n\nPreferred structures: modular card-based blocks, comparison grids, scorecards, KPI tiles with hero statistics, column charts, bar charts, stacked bar charts, grouped bar charts, waterfall charts, bullet charts, donut charts, timeline bars, before-and-after panels, data tables with highlighted rows.\n\nLayout pattern: Three-part vertical flow — headline conclusion at top, evidence and data in the middle as modular blocks, bumper takeaway at the bottom. Each section separated by thin dividers.\n\nHero statistics: Identify key numbers, percentages, monetary values. These become oversized focal numbers with left-border accent treatment.\n\nAvoid: flowcharts, mind maps, Venn diagrams, fishbone diagrams, radial/circular layouts, hub-spoke, concentric rings, network graphs, organic shapes, decorative illustrations.\n\n## OUTPUT FORMAT:\nRespond with a JSON object only — no markdown, no explanation, no wrapping. Use this exact structure:\n\n{\n  \"data_pattern\": \"one sentence naming the dominant data structure (hierarchy, comparison, sequence, metrics set, etc.) and why it fits\",\n  \"visual_concept\": \"one or two sentences describing the best infographic visualization — which chart/diagram types to combine and why they make the content intuitive\",\n  \"content_groups\": [\n    { \"label\": \"group name\", \"items\": [\"content item 1\", \"content item 2\"], \"is_hero_stat\": false },\n    { \"label\": \"key metric\", \"items\": [\"42%\"], \"is_hero_stat\": true }\n  ],\n  \"hero_callouts\": [\"list of specific numbers, percentages, or metrics to render as oversized burnt orange focal numbers\"],\n  \"focal_hierarchy\": [\"what grabs attention first\", \"what grabs attention second\", \"what grabs attention third\"]\n}\n\n## RULES:\n- Output valid JSON only — no prose, no markdown code fences, no explanation\n- Every content item must appear in at least one content_group — nothing may be dropped\n- Set is_hero_stat: true for groups containing standalone key metrics\n- hero_callouts should list the actual values (e.g. \"42%\", \"$3.2M\", \"15% growth\")\n- Do NOT rewrite or paraphrase content text — reference it by its existing headings or labels\n- Do NOT mention colors, fonts, or pixel values\n`.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 2. PwC Visualizer — Standard Cards (Hybrid JSON)\n// ─────────────────────────────────────────────────────────────────\n// Same signature as buildVisualizerPrompt in imageGeneration.ts.\n// Composes: narrative role → JSON design spec → content tags.\n// The planner's JSON output is embedded as visual_brief inside\n// the design spec.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildPwcVisualizerPrompt(\n  cardTitle: string,\n  contentToMap: string,\n  settings: StylingOptions,\n  visualPlan?: string,\n  useReference?: boolean\n): string {\n  // 1. Role — short narrative sentence\n  const role =\n    'You are an expert Information Designer. Create a clean, authoritative PwC corporate consulting infographic.';\n\n  // 2. Reference note\n  const referenceNote = useReference\n    ? 'A reference infographic is provided. Replicate its visual identity exactly: the burnt orange ' +\n      'accent treatment, grey data styling, serif heading weight, callout box treatment, section ' +\n      'divider style, and overall modular composition. The new infographic must look like a sibling ' +\n      'of the reference — same visual system, different content.'\n    : undefined;\n\n  // 3. Design specification as JSON\n  const designSpec = buildPwcDesignSpec(settings);\n\n  // 4. Visual brief — embed planner JSON output or provide default\n  let visualBriefBlock: string;\n  if (visualPlan) {\n    // The planner output is already JSON — embed it directly\n    // Apply sanitization to strip any residual markdown wrapping\n    let cleanPlan = visualPlan.trim();\n    // Strip markdown code fences if the planner wrapped its JSON in them\n    cleanPlan = cleanPlan.replace(/^```(?:json)?\\s*/i, '').replace(/\\s*```$/i, '');\n    visualBriefBlock = cleanPlan;\n  } else {\n    visualBriefBlock = JSON.stringify({\n      data_pattern: \"Content hierarchy with supporting details\",\n      visual_concept: \"Modular card-based scorecard with stat counters and comparison blocks\",\n      content_groups: [],\n      hero_callouts: [],\n      focal_hierarchy: [\"title\", \"hero statistics\", \"section headings\", \"body content\"],\n    }, null, 2);\n  }\n\n  // 5. Content (transformed from markdown to bracketed tags)\n  const contentBlock = transformContentToTags(contentToMap, cardTitle);\n\n  // Assemble: role → [reference] → design spec with embedded brief → content\n  const blocks: string[] = [role];\n  if (referenceNote) blocks.push(referenceNote);\n\n  blocks.push(\n    `Follow this design specification precisely:\\n${designSpec}`,\n    `Visual brief from the layout planner — use this to guide information architecture:\\n${visualBriefBlock}`,\n    contentBlock,\n  );\n\n  return blocks.join('\\n\\n');\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 3. PwC Cover Planner (JSON output)\n// ─────────────────────────────────────────────────────────────────\n// Same signature as buildCoverPlannerPrompt in coverGeneration.ts.\n// Outputs structured JSON for PwC cover slide layout.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildPwcCoverPlannerPrompt(\n  cardTitle: string,\n  coverContent: string,\n  style: string,\n  aspectRatio: string = '16:9',\n  coverType: DetailLevel\n): string {\n  let canvasDescription = 'landscape — wider than tall';\n  if (aspectRatio === '9:16') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '1:1') canvasDescription = 'square — equal width and height';\n  else if (aspectRatio === '4:5' || aspectRatio === '3:4' || aspectRatio === '2:3') canvasDescription = 'portrait — taller than wide';\n  else if (aspectRatio === '5:4' || aspectRatio === '3:2') canvasDescription = 'near-square landscape';\n\n  const coverKind = coverType === 'TitleCard' ? 'Title Card' : 'Takeaway Card';\n\n  const textElements = coverType === 'TitleCard'\n    ? `Title (hero), subtitle (secondary), optional tagline (smallest)`\n    : `Title (hero), takeaway bullet points (secondary list with orange markers)`;\n\n  return `\nCOVER SLIDE LAYOUT — [${cardTitle}]\n\nYou are an expert cover slide designer for PwC corporate presentations. Plan the layout of a ${coverKind}.\n\nCANVAS: ${aspectRatio} (${canvasDescription})\nCONTENT DENSITY: MINIMAL — this is a cover slide, not a data infographic.\nTEXT ELEMENTS: ${textElements}\n\nCONTENT:\n---\n${coverContent}\n---\n\nPwC COVER PRINCIPLES:\n- Title: left-aligned or center-left, large, bold, serif. Never centered-and-small.\n- ONE geometric burnt orange accent element: a bold left stripe, underline, or angular block. Only one.\n- Whitespace-driven canvas. Whitespace signals confidence and authority.\n- No gradients, no textures, no background images, no illustrations, no decorative patterns.\n\nOUTPUT FORMAT:\nRespond with a JSON object only — no markdown, no explanation:\n\n{\n  \"title_position\": \"where the title sits and how it dominates (e.g. 'left-aligned in the upper third, spanning 60% of canvas width')\",\n  \"orange_accent\": {\n    \"shape\": \"stripe, underline, angular block, or square\",\n    \"position\": \"where relative to the title\",\n    \"scale\": \"thin accent line or bold stripe\"\n  },\n  \"supporting_text\": \"where subtitle/tagline/bullets appear relative to the title\",\n  \"whitespace\": \"how whitespace is distributed across the canvas\"\n}\n\nRULES:\n- Output valid JSON only — no prose, no code fences\n- Do NOT rewrite the content text\n- Do NOT mention font names, point sizes, hex colors, or pixel values\n`.trim();\n}\n\n// ─────────────────────────────────────────────────────────────────\n// 4. PwC Cover Visualizer (Hybrid JSON)\n// ─────────────────────────────────────────────────────────────────\n// Same signature as buildCoverVisualizerPrompt in coverGeneration.ts.\n// Hybrid: narrative role → JSON cover spec → content tags.\n// ─────────────────────────────────────────────────────────────────\n\nexport function buildPwcCoverVisualizerPrompt(\n  cardTitle: string,\n  coverContent: string,\n  settings: StylingOptions,\n  visualPlan?: string,\n  useReference?: boolean,\n  coverType?: DetailLevel\n): string {\n  const bgName = hexToColorName(settings.palette.background);\n  const primaryName = hexToColorName(settings.palette.primary);\n  const secondaryName = hexToColorName(settings.palette.secondary);\n  const textName = hexToColorName(settings.palette.text);\n  const primaryFontDesc = fontToDescriptor(settings.fonts.primary);\n  const secondaryFontDesc = fontToDescriptor(settings.fonts.secondary);\n\n  // 1. Role\n  const role =\n    'You are an expert cover slide designer. Create a clean, authoritative PwC corporate cover slide — ' +\n    'not a data infographic. No charts, no data grids, no multi-section layouts. ' +\n    'The title is the absolute hero element.';\n\n  // 2. Reference note\n  const referenceNote = useReference\n    ? 'A reference cover is provided. Replicate its visual identity exactly: serif title weight, ' +\n      'orange accent treatment, whitespace distribution. The new cover must look like a sibling of the reference.'\n    : undefined;\n\n  // 3. Cover design spec as JSON\n  const bulletGuidance = coverType === 'TakeawayCard'\n    ? 'Clean vertically stacked list below title, sans-serif, each bullet with small orange square marker'\n    : null;\n\n  const coverSpec = {\n    style: \"PwC corporate cover slide\",\n    palette: {\n      background: `${bgName} (${settings.palette.background}) — clean, uncluttered`,\n      accent: `${primaryName} (${settings.palette.primary}) — single geometric accent element only (stripe, underline, or angular block)`,\n      title_text: `${secondaryName} (${settings.palette.secondary}) — large, bold, commanding`,\n      supporting_text: `${textName} (${settings.palette.text}) — subtitle, tagline, or bullets`,\n    },\n    typography: {\n      title: `${primaryFontDesc} — authoritative, weighty, clearly serif`,\n      supporting: `${secondaryFontDesc} — clean, subordinate, clearly sans-serif`,\n      signature: \"Serif-sans contrast is a core PwC visual signature\",\n    },\n    rendering_rules: [\n      \"Title is the largest, most dominant text — left-aligned or center-left\",\n      \"ONE burnt orange geometric accent near the title (stripe, underline, or block)\",\n      \"Visual impact from three things only: large serif title, orange accent, generous whitespace\",\n      \"No gradients, no textures, no background images, no illustrations, no decorative patterns\",\n      \"Canvas should feel restrained and premium\",\n      ...(bulletGuidance ? [bulletGuidance] : []),\n    ],\n  };\n\n  // 4. Visual brief from planner\n  let layoutBlock: string;\n  if (visualPlan) {\n    let cleanPlan = visualPlan.trim();\n    cleanPlan = cleanPlan.replace(/^```(?:json)?\\s*/i, '').replace(/\\s*```$/i, '');\n    layoutBlock = `Cover layout from the planner:\\n${cleanPlan}`;\n  } else {\n    const defaultLayout = coverType === 'TakeawayCard'\n      ? { title_position: \"upper portion, large, bold, serif\", orange_accent: { shape: \"underline\", position: \"below title\", scale: \"bold stripe\" }, supporting_text: \"takeaway bullets below title as stacked list with orange markers\", whitespace: \"generous surrounding all elements\" }\n      : { title_position: \"left-aligned or center-left, dominant\", orange_accent: { shape: \"left stripe\", position: \"beside title\", scale: \"bold vertical stripe\" }, supporting_text: \"subtitle below title, tagline at bottom edge\", whitespace: \"confident whitespace fills canvas\" };\n    layoutBlock = `Cover layout:\\n${JSON.stringify(defaultLayout, null, 2)}`;\n  }\n\n  // 5. Content\n  const contentBlock = transformCoverContentToTags(coverContent, cardTitle);\n\n  // Assemble\n  const blocks: string[] = [role];\n  if (referenceNote) blocks.push(referenceNote);\n  blocks.push(\n    `Follow this cover design specification precisely:\\n${JSON.stringify(coverSpec, null, 2)}`,\n    layoutBlock,\n    `All text must be legible with high contrast against the background.`,\n    contentBlock,\n  );\n\n  return blocks.join('\\n\\n');\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\redline.ts","messages":[{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 16.","line":66,"column":27,"nodeType":"Literal","messageId":"noMagic","endLine":66,"endColumn":29},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.02.","line":66,"column":48,"nodeType":"Literal","messageId":"noMagic","endLine":66,"endColumn":52},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 14.","line":79,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":79,"endColumn":33},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":100,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":100,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":100,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":100,"endColumn":25},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 18.","line":130,"column":29,"nodeType":"Literal","messageId":"noMagic","endLine":130,"endColumn":31},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 0.025.","line":130,"column":50,"nodeType":"Literal","messageId":"noMagic","endLine":130,"endColumn":55},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":131,"column":31,"nodeType":"Literal","messageId":"noMagic","endLine":131,"endColumn":32},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":156,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":156,"endColumn":33,"fix":{"range":[4273,4280],"text":"{return;}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 12.","line":173,"column":20,"nodeType":"Literal","messageId":"noMagic","endLine":173,"endColumn":22},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 6.","line":173,"column":24,"nodeType":"Literal","messageId":"noMagic","endLine":173,"endColumn":25},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 30 to the 15 allowed.","line":190,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":190,"endColumn":32},{"ruleId":"default-case","severity":1,"message":"Expected a default case.","line":195,"column":5,"nodeType":"SwitchStatement","messageId":"missingDefaultCase","endLine":235,"endColumn":6},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 4 times.","line":197,"column":46,"nodeType":"Literal","messageId":"defineConstant","endLine":197,"endColumn":73},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":223,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":223,"endColumn":40,"fix":{"range":[6323,6334],"text":"{minX = p.x;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":224,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":224,"endColumn":40,"fix":{"range":[6363,6374],"text":"{maxX = p.x;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":225,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":225,"endColumn":40,"fix":{"range":[6403,6414],"text":"{minY = p.y;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":226,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":226,"endColumn":40,"fix":{"range":[6443,6454],"text":"{maxY = p.y;}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":5,"source":"import { Annotation, NormalizedPoint } from '../types';\n\n/**\n * Generate a high-contrast redline map from annotations.\n * The redline is rendered on a black background at the image's natural resolution\n * with ALL annotations in bright red for maximum AI readability.\n *\n * Returns: { redlineDataUrl: string, instructions: string }\n */\nexport function generateRedlineMap(\n  annotations: Annotation[],\n  naturalW: number,\n  naturalH: number\n): { redlineDataUrl: string; instructions: string } {\n  // Create offscreen canvas at natural resolution\n  const canvas = document.createElement('canvas');\n  canvas.width = naturalW;\n  canvas.height = naturalH;\n  const ctx = canvas.getContext('2d')!;\n\n  // Black background\n  ctx.fillStyle = '#000000';\n  ctx.fillRect(0, 0, naturalW, naturalH);\n\n  const RED = '#FF0000';\n  const WHITE = '#FFFFFF';\n  const STROKE_WIDTH = 4;\n\n  // Track pin numbering\n  let pinIndex = 1;\n\n  // Render each annotation in high-contrast red\n  for (const a of annotations) {\n    if (a.type === 'pin') {\n      renderRedlinePin(ctx, a.position, naturalW, naturalH, pinIndex, RED, WHITE);\n      pinIndex++;\n    } else if (a.type === 'rectangle') {\n      renderRedlineRectangle(ctx, a.topLeft, a.bottomRight, naturalW, naturalH, RED, WHITE, STROKE_WIDTH);\n    } else if (a.type === 'arrow') {\n      renderRedlineArrow(ctx, a.start, a.end, naturalW, naturalH, RED, STROKE_WIDTH);\n    } else if (a.type === 'sketch') {\n      renderRedlineSketch(ctx, a.points, a.strokeWidth, naturalW, naturalH, RED, STROKE_WIDTH);\n    }\n  }\n\n  const redlineDataUrl = canvas.toDataURL('image/png');\n  const instructions = synthesizeInstructions(annotations);\n\n  return { redlineDataUrl, instructions };\n}\n\n// --- Redline renderers (AI-facing, high-contrast) ---\n\nfunction toCanvas(p: NormalizedPoint, w: number, h: number): { x: number; y: number } {\n  return { x: p.x * w, y: p.y * h };\n}\n\nfunction renderRedlinePin(\n  ctx: CanvasRenderingContext2D,\n  position: NormalizedPoint,\n  w: number, h: number,\n  index: number,\n  red: string, white: string\n) {\n  const { x, y } = toCanvas(position, w, h);\n  const radius = Math.max(16, Math.min(w, h) * 0.02);\n\n  // Outer circle\n  ctx.beginPath();\n  ctx.arc(x, y, radius, 0, Math.PI * 2);\n  ctx.fillStyle = red;\n  ctx.fill();\n  ctx.strokeStyle = white;\n  ctx.lineWidth = 3;\n  ctx.stroke();\n\n  // Number\n  ctx.fillStyle = white;\n  ctx.font = `bold ${Math.max(14, radius)}px Arial, sans-serif`;\n  ctx.textAlign = 'center';\n  ctx.textBaseline = 'middle';\n  ctx.fillText(String(index), x, y);\n}\n\nfunction renderRedlineRectangle(\n  ctx: CanvasRenderingContext2D,\n  topLeft: NormalizedPoint, bottomRight: NormalizedPoint,\n  w: number, h: number,\n  red: string, white: string,\n  strokeWidth: number\n) {\n  const tl = toCanvas(topLeft, w, h);\n  const br = toCanvas(bottomRight, w, h);\n  const rw = br.x - tl.x;\n  const rh = br.y - tl.y;\n\n  // Dashed red border\n  ctx.strokeStyle = red;\n  ctx.lineWidth = strokeWidth;\n  ctx.setLineDash([12, 6]);\n  ctx.strokeRect(tl.x, tl.y, rw, rh);\n  ctx.setLineDash([]);\n\n  // 10% white fill for visibility\n  ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';\n  ctx.fillRect(tl.x, tl.y, rw, rh);\n}\n\nfunction renderRedlineArrow(\n  ctx: CanvasRenderingContext2D,\n  start: NormalizedPoint, end: NormalizedPoint,\n  w: number, h: number,\n  red: string,\n  strokeWidth: number\n) {\n  const s = toCanvas(start, w, h);\n  const e = toCanvas(end, w, h);\n\n  // Line\n  ctx.strokeStyle = red;\n  ctx.lineWidth = strokeWidth;\n  ctx.lineCap = 'round';\n  ctx.beginPath();\n  ctx.moveTo(s.x, s.y);\n  ctx.lineTo(e.x, e.y);\n  ctx.stroke();\n\n  // Arrowhead\n  const angle = Math.atan2(e.y - s.y, e.x - s.x);\n  const headSize = Math.max(18, Math.min(w, h) * 0.025);\n  const halfAngle = Math.PI / 6;\n\n  ctx.fillStyle = red;\n  ctx.beginPath();\n  ctx.moveTo(e.x, e.y);\n  ctx.lineTo(\n    e.x - headSize * Math.cos(angle - halfAngle),\n    e.y - headSize * Math.sin(angle - halfAngle)\n  );\n  ctx.lineTo(\n    e.x - headSize * Math.cos(angle + halfAngle),\n    e.y - headSize * Math.sin(angle + halfAngle)\n  );\n  ctx.closePath();\n  ctx.fill();\n}\n\nfunction renderRedlineSketch(\n  ctx: CanvasRenderingContext2D,\n  points: NormalizedPoint[],\n  strokeWidth: number,\n  w: number, h: number,\n  red: string,\n  _lineWidth: number\n) {\n  if (points.length < 2) return;\n\n  // Closed region matching rectangle redline style\n  ctx.save();\n\n  ctx.beginPath();\n  const first = toCanvas(points[0], w, h);\n  ctx.moveTo(first.x, first.y);\n  for (let i = 1; i < points.length; i++) {\n    const p = toCanvas(points[i], w, h);\n    ctx.lineTo(p.x, p.y);\n  }\n  ctx.closePath();\n\n  // Dashed red border\n  ctx.strokeStyle = red;\n  ctx.lineWidth = 4;\n  ctx.setLineDash([12, 6]);\n  ctx.stroke();\n  ctx.setLineDash([]);\n\n  // 10% white fill for visibility\n  ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';\n  ctx.fill();\n\n  ctx.restore();\n}\n\n// --- Instruction synthesis ---\n\n/**\n * Generate a numbered instruction list referencing spatial positions.\n * This is the text sent alongside the redline map to guide the AI.\n */\nfunction synthesizeInstructions(annotations: Annotation[]): string {\n  const lines: string[] = [];\n  let pinIndex = 1;\n\n  for (const a of annotations) {\n    switch (a.type) {\n      case 'pin': {\n        const instruction = a.instruction || '(no instruction provided)';\n        lines.push(\n          `${lines.length + 1}. [PIN #${pinIndex} at (${fmt(a.position.x)}, ${fmt(a.position.y)})]: \"${instruction}\"`\n        );\n        pinIndex++;\n        break;\n      }\n      case 'rectangle': {\n        const instruction = a.instruction || '(no instruction provided)';\n        lines.push(\n          `${lines.length + 1}. [RECTANGLE covering (${fmt(a.topLeft.x)}, ${fmt(a.topLeft.y)}) to (${fmt(a.bottomRight.x)}, ${fmt(a.bottomRight.y)})]: \"${instruction}\"`\n        );\n        break;\n      }\n      case 'arrow': {\n        const instruction = a.instruction || '(no instruction provided)';\n        lines.push(\n          `${lines.length + 1}. [ARROW from (${fmt(a.start.x)}, ${fmt(a.start.y)}) to (${fmt(a.end.x)}, ${fmt(a.end.y)})]: \"${instruction}\"`\n        );\n        break;\n      }\n      case 'sketch': {\n        if (a.points.length > 0) {\n          // Compute bounding box for spatial description\n          let minX = 1, maxX = 0, minY = 1, maxY = 0;\n          for (const p of a.points) {\n            if (p.x < minX) minX = p.x;\n            if (p.x > maxX) maxX = p.x;\n            if (p.y < minY) minY = p.y;\n            if (p.y > maxY) maxY = p.y;\n          }\n          const instruction = a.instruction || '(no instruction provided)';\n          lines.push(\n            `${lines.length + 1}. [HIGHLIGHTED AREA covering (${fmt(minX)}, ${fmt(minY)}) to (${fmt(maxX)}, ${fmt(maxY)})]: \"${instruction}\"`\n          );\n        }\n        break;\n      }\n    }\n  }\n\n  return lines.join('\\n');\n}\n\nfunction fmt(n: number): string {\n  return n.toFixed(2);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\storage\\IndexedDBBackend.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":147,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4722,4725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4722,4725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5033,5036],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5033,5036],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":209,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":209,"endColumn":53,"fix":{"range":[6642,6666],"text":"{this.createStoresV1(db);}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":210,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":210,"endColumn":53,"fix":{"range":[6695,6719],"text":"{this.createStoresV2(db);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 3.","line":211,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":211,"endColumn":27},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":211,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":211,"endColumn":53,"fix":{"range":[6748,6772],"text":"{this.createStoresV3(db);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 4.","line":212,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":212,"endColumn":27},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":212,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":212,"endColumn":53,"fix":{"range":[6801,6825],"text":"{this.createStoresV4(db);}"}},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 5.","line":213,"column":26,"nodeType":"Literal","messageId":"noMagic","endLine":213,"endColumn":27},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":213,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":213,"endColumn":48,"fix":{"range":[6854,6873],"text":"{this.migrateV5(tx);}"}},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":223,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":223,"endColumn":22,"suggestions":[{"fix":{"range":[7048,7103],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":309,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":309,"endColumn":84,"fix":{"range":[10566,10631],"text":"{throw new Error('IndexedDB not initialized. Call init() first.');}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":557,"column":57,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":557,"endColumn":67,"fix":{"range":[19033,19043],"text":"{return [];}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":644,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":644,"endColumn":37,"fix":{"range":[22010,22017],"text":"{return;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":745,"column":39,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":745,"endColumn":46,"fix":{"range":[25862,25869],"text":"{return;}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":9,"source":"\nimport { InsightsDocument } from '../../types';\nimport {\n  StorageBackend,\n  AppSessionState,\n  StoredFile,\n  StoredHeading,\n  StoredImage,\n  StoredInsightsSession,\n  StoredNugget,\n  StoredNuggetDocument,\n  StoredProject,\n} from './StorageBackend';\n\nconst DB_NAME = 'infonugget-db';\nconst DB_VERSION = 5;\n\n// Store names — v1\nconst STORE_APP_STATE = 'appState';\nconst STORE_FILES = 'files';\nconst STORE_HEADINGS = 'headings';\nconst STORE_IMAGES = 'images';\nconst STORE_INSIGHTS_SESSION = 'insightsSession';\nconst STORE_INSIGHTS_DOCS = 'insightsDocs';\nconst STORE_INSIGHTS_HEADINGS = 'insightsHeadings';\nconst STORE_INSIGHTS_IMAGES = 'insightsImages';\n\n// Store names — v2 (nuggets)\nconst STORE_DOCUMENTS = 'documents'; // v2 legacy — kept for migration reads\nconst STORE_NUGGETS = 'nuggets';\nconst STORE_NUGGET_HEADINGS = 'nuggetHeadings';\nconst STORE_NUGGET_IMAGES = 'nuggetImages';\n\n// Store names — v3 (per-nugget owned documents)\nconst STORE_NUGGET_DOCUMENTS = 'nuggetDocuments';\n\n// Store names — v4 (projects)\nconst STORE_PROJECTS = 'projects';\n\nconst ALL_STORES = [\n  STORE_APP_STATE, STORE_FILES, STORE_HEADINGS, STORE_IMAGES,\n  STORE_INSIGHTS_SESSION, STORE_INSIGHTS_DOCS, STORE_INSIGHTS_HEADINGS, STORE_INSIGHTS_IMAGES,\n  STORE_DOCUMENTS, STORE_NUGGETS, STORE_NUGGET_HEADINGS, STORE_NUGGET_IMAGES,\n  STORE_NUGGET_DOCUMENTS, STORE_PROJECTS,\n];\n\n// ── Helpers ──\n\nfunction promisifyRequest<T>(request: IDBRequest<T>): Promise<T> {\n  return new Promise((resolve, reject) => {\n    request.onsuccess = () => resolve(request.result);\n    request.onerror = () => reject(request.error);\n  });\n}\n\nfunction promisifyTransaction(tx: IDBTransaction): Promise<void> {\n  return new Promise((resolve, reject) => {\n    tx.oncomplete = () => resolve();\n    tx.onerror = () => reject(tx.error);\n    tx.onabort = () => reject(tx.error || new Error('Transaction aborted'));\n  });\n}\n\n// ── Image storage: Blob conversion ──\n//\n// Images are stored as native Blobs in IndexedDB for ~33% savings over base64.\n// At the read/write boundary we convert between the runtime format (data URL\n// strings on StoredImage) and the storage format (Blob objects).\n// The load path is backward-compatible — if a stored value is already a string\n// (legacy base64 data URL), it passes through unchanged. This enables lazy\n// migration: old records convert to Blob format on their next save.\n\n/** Convert a data URL string to a Blob for storage. */\nfunction dataUrlToBlob(dataUrl: string): Blob {\n  if (!dataUrl.startsWith('data:')) {\n    // Not a data URL — wrap as-is (shouldn't happen in practice)\n    return new Blob([dataUrl], { type: 'application/octet-stream' });\n  }\n  const commaIdx = dataUrl.indexOf(',');\n  const header = dataUrl.substring(0, commaIdx);\n  const base64 = dataUrl.substring(commaIdx + 1);\n  const mime = header.match(/:(.*?);/)?.[1] || 'image/png';\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return new Blob([bytes], { type: mime });\n}\n\n/** Convert a Blob back to a data URL string for runtime use. */\nfunction blobToDataUrl(blob: Blob): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onloadend = () => resolve(reader.result as string);\n    reader.onerror = () => reject(reader.error);\n    reader.readAsDataURL(blob);\n  });\n}\n\n/** Convert a runtime URL (blob: object URL or data: URL) to a Blob for storage. */\nasync function urlToBlob(url: string): Promise<Blob> {\n  if (url.startsWith('blob:')) {\n    const response = await fetch(url);\n    return response.blob();\n  }\n  return dataUrlToBlob(url);\n}\n\n/** Internal storage representation — uses Blobs instead of data URL strings. */\ninterface StoredImageBlob {\n  fileId: string;\n  headingId: string;\n  level: string;\n  cardUrl: Blob;\n  imageHistory: {\n    imageUrl: Blob;\n    timestamp: number;\n    label: string;\n  }[];\n}\n\n/** Convert StoredImage (runtime, string URLs) → StoredImageBlob (storage, Blobs). */\nasync function imageToBlobStorage(image: StoredImage): Promise<StoredImageBlob> {\n  const cardUrl = await urlToBlob(image.cardUrl);\n  const imageHistory = await Promise.all(\n    image.imageHistory.map(async (v) => ({\n      imageUrl: await urlToBlob(v.imageUrl),\n      timestamp: v.timestamp,\n      label: v.label,\n    }))\n  );\n  return {\n    fileId: image.fileId,\n    headingId: image.headingId,\n    level: image.level,\n    cardUrl,\n    imageHistory,\n  };\n}\n\n/**\n * Convert storage record → StoredImage (runtime, string URLs).\n * Backward-compatible: handles both legacy format (string data URLs)\n * and new format (Blob objects).\n */\nasync function blobStorageToImage(stored: any): Promise<StoredImage> {\n  let cardUrl: string;\n  if (stored.cardUrl instanceof Blob) {\n    cardUrl = await blobToDataUrl(stored.cardUrl);\n  } else {\n    cardUrl = stored.cardUrl; // Already a string (legacy data)\n  }\n\n  const imageHistory = await Promise.all(\n    (stored.imageHistory || []).map(async (v: any) => {\n      let imageUrl: string;\n      if (v.imageUrl instanceof Blob) {\n        imageUrl = await blobToDataUrl(v.imageUrl);\n      } else {\n        imageUrl = v.imageUrl; // Legacy string\n      }\n      return { imageUrl, timestamp: v.timestamp, label: v.label };\n    })\n  );\n\n  return {\n    fileId: stored.fileId,\n    headingId: stored.headingId,\n    level: stored.level,\n    cardUrl,\n    imageHistory,\n  };\n}\n\n/**\n * Legacy helper — converts blob: URLs to data: URLs (no Blob storage).\n * Used by insights image methods which still use the old string-based format.\n */\nasync function convertImageBlobUrls(image: StoredImage): Promise<StoredImage> {\n  const cardUrl = image.cardUrl.startsWith('blob:')\n    ? await blobToDataUrl(await urlToBlob(image.cardUrl))\n    : image.cardUrl;\n  const imageHistory = await Promise.all(\n    image.imageHistory.map(async (v) => ({\n      ...v,\n      imageUrl: v.imageUrl.startsWith('blob:')\n        ? await blobToDataUrl(await urlToBlob(v.imageUrl))\n        : v.imageUrl,\n    }))\n  );\n  return { ...image, cardUrl, imageHistory };\n}\n\n// ── Implementation ──\n\nexport class IndexedDBBackend implements StorageBackend {\n  private db: IDBDatabase | null = null;\n  private ready = false;\n\n  async init(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n      request.onupgradeneeded = (event) => {\n        const db = (event.target as IDBOpenDBRequest).result;\n        const tx = (event.target as IDBOpenDBRequest).transaction!;\n        const oldVersion = event.oldVersion;\n        if (oldVersion < 1) this.createStoresV1(db);\n        if (oldVersion < 2) this.createStoresV2(db);\n        if (oldVersion < 3) this.createStoresV3(db);\n        if (oldVersion < 4) this.createStoresV4(db);\n        if (oldVersion < 5) this.migrateV5(tx);\n      };\n\n      request.onsuccess = () => {\n        this.db = request.result;\n        this.ready = true;\n        resolve();\n      };\n\n      request.onerror = () => {\n        console.error('IndexedDB init failed:', request.error);\n        reject(request.error);\n      };\n    });\n  }\n\n  private createStoresV1(db: IDBDatabase): void {\n    if (!db.objectStoreNames.contains(STORE_APP_STATE)) {\n      db.createObjectStore(STORE_APP_STATE);\n    }\n    if (!db.objectStoreNames.contains(STORE_FILES)) {\n      db.createObjectStore(STORE_FILES, { keyPath: 'id' });\n    }\n    if (!db.objectStoreNames.contains(STORE_HEADINGS)) {\n      const store = db.createObjectStore(STORE_HEADINGS, { keyPath: ['fileId', 'headingId'] });\n      store.createIndex('byFile', 'fileId', { unique: false });\n    }\n    if (!db.objectStoreNames.contains(STORE_IMAGES)) {\n      const store = db.createObjectStore(STORE_IMAGES, { keyPath: ['fileId', 'headingId', 'level'] });\n      store.createIndex('byFile', 'fileId', { unique: false });\n    }\n    if (!db.objectStoreNames.contains(STORE_INSIGHTS_SESSION)) {\n      db.createObjectStore(STORE_INSIGHTS_SESSION);\n    }\n    if (!db.objectStoreNames.contains(STORE_INSIGHTS_DOCS)) {\n      db.createObjectStore(STORE_INSIGHTS_DOCS, { keyPath: 'id' });\n    }\n    if (!db.objectStoreNames.contains(STORE_INSIGHTS_HEADINGS)) {\n      db.createObjectStore(STORE_INSIGHTS_HEADINGS, { keyPath: 'headingId' });\n    }\n    if (!db.objectStoreNames.contains(STORE_INSIGHTS_IMAGES)) {\n      db.createObjectStore(STORE_INSIGHTS_IMAGES, { keyPath: ['headingId', 'level'] });\n    }\n  }\n\n  private createStoresV2(db: IDBDatabase): void {\n    if (!db.objectStoreNames.contains(STORE_DOCUMENTS)) {\n      db.createObjectStore(STORE_DOCUMENTS, { keyPath: 'id' });\n    }\n    if (!db.objectStoreNames.contains(STORE_NUGGETS)) {\n      db.createObjectStore(STORE_NUGGETS, { keyPath: 'id' });\n    }\n    if (!db.objectStoreNames.contains(STORE_NUGGET_HEADINGS)) {\n      const store = db.createObjectStore(STORE_NUGGET_HEADINGS, { keyPath: ['fileId', 'headingId'] });\n      store.createIndex('byNugget', 'fileId', { unique: false });\n    }\n    if (!db.objectStoreNames.contains(STORE_NUGGET_IMAGES)) {\n      const store = db.createObjectStore(STORE_NUGGET_IMAGES, { keyPath: ['fileId', 'headingId', 'level'] });\n      store.createIndex('byNugget', 'fileId', { unique: false });\n    }\n  }\n\n  private createStoresV3(db: IDBDatabase): void {\n    if (!db.objectStoreNames.contains(STORE_NUGGET_DOCUMENTS)) {\n      const store = db.createObjectStore(STORE_NUGGET_DOCUMENTS, { keyPath: ['nuggetId', 'docId'] });\n      store.createIndex('byNugget', 'nuggetId', { unique: false });\n    }\n  }\n\n  private createStoresV4(db: IDBDatabase): void {\n    if (!db.objectStoreNames.contains(STORE_PROJECTS)) {\n      db.createObjectStore(STORE_PROJECTS, { keyPath: 'id' });\n    }\n  }\n\n  private migrateV5(tx: IDBTransaction): void {\n    // Clear 4 pure-legacy stores that only contain pre-migration data.\n    // These stores were written during the v1/v2 era and are read-only after\n    // migration to nugget-based storage. Any data in them has already been\n    // migrated to nuggets/nuggetDocuments/nuggetHeadings/nuggetImages.\n    //\n    // DO NOT touch: insightsSession, insightsDocs, insightsHeadings, insightsImages\n    // — those are still actively written by the persistence layer.\n    const legacyStores = [STORE_FILES, STORE_HEADINGS, STORE_IMAGES, STORE_DOCUMENTS];\n    for (const name of legacyStores) {\n      if (tx.objectStoreNames.contains(name)) {\n        tx.objectStore(name).clear();\n      }\n    }\n  }\n\n  isReady(): boolean {\n    return this.ready;\n  }\n\n  private getDB(): IDBDatabase {\n    if (!this.db) throw new Error('IndexedDB not initialized. Call init() first.');\n    return this.db;\n  }\n\n  // ── App state ──\n\n  async saveAppState(state: AppSessionState): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_APP_STATE, 'readwrite');\n    tx.objectStore(STORE_APP_STATE).put(state, 'current');\n    await promisifyTransaction(tx);\n  }\n\n  async loadAppState(): Promise<AppSessionState | null> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_APP_STATE, 'readonly');\n    const result = await promisifyRequest(tx.objectStore(STORE_APP_STATE).get('current'));\n    return result ?? null;\n  }\n\n  // ── Files ──\n\n  async saveFile(file: StoredFile): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_FILES, 'readwrite');\n    tx.objectStore(STORE_FILES).put(file);\n    await promisifyTransaction(tx);\n  }\n\n  async loadFiles(): Promise<StoredFile[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_FILES, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_FILES).getAll());\n  }\n\n  async deleteFile(fileId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_FILES, 'readwrite');\n    tx.objectStore(STORE_FILES).delete(fileId);\n    await promisifyTransaction(tx);\n  }\n\n  // ── Headings ──\n\n  async saveHeadings(fileId: string, headings: StoredHeading[]): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_HEADINGS, 'readwrite');\n    const store = tx.objectStore(STORE_HEADINGS);\n    const index = store.index('byFile');\n\n    // Delete existing headings for this file\n    const existingKeys = await promisifyRequest(index.getAllKeys(fileId));\n    for (const key of existingKeys) {\n      store.delete(key);\n    }\n\n    // Write new headings\n    for (const h of headings) {\n      store.put(h);\n    }\n\n    await promisifyTransaction(tx);\n  }\n\n  async loadHeadings(fileId: string): Promise<StoredHeading[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_HEADINGS, 'readonly');\n    const index = tx.objectStore(STORE_HEADINGS).index('byFile');\n    return await promisifyRequest(index.getAll(fileId));\n  }\n\n  async deleteHeadings(fileId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_HEADINGS, 'readwrite');\n    const store = tx.objectStore(STORE_HEADINGS);\n    const index = store.index('byFile');\n    const keys = await promisifyRequest(index.getAllKeys(fileId));\n    for (const key of keys) {\n      store.delete(key);\n    }\n    await promisifyTransaction(tx);\n  }\n\n  // ── Images ──\n\n  async saveImage(image: StoredImage): Promise<void> {\n    const converted = await convertImageBlobUrls(image);\n    const db = this.getDB();\n    const tx = db.transaction(STORE_IMAGES, 'readwrite');\n    tx.objectStore(STORE_IMAGES).put(converted);\n    await promisifyTransaction(tx);\n  }\n\n  async loadImages(fileId: string): Promise<StoredImage[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_IMAGES, 'readonly');\n    const index = tx.objectStore(STORE_IMAGES).index('byFile');\n    return await promisifyRequest(index.getAll(fileId));\n  }\n\n  async deleteImages(fileId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_IMAGES, 'readwrite');\n    const store = tx.objectStore(STORE_IMAGES);\n    const index = store.index('byFile');\n    const keys = await promisifyRequest(index.getAllKeys(fileId));\n    for (const key of keys) {\n      store.delete(key);\n    }\n    await promisifyTransaction(tx);\n  }\n\n  // ── Insights session ──\n\n  async saveInsightsSession(session: StoredInsightsSession): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_SESSION, 'readwrite');\n    tx.objectStore(STORE_INSIGHTS_SESSION).put(session, 'current');\n    await promisifyTransaction(tx);\n  }\n\n  async loadInsightsSession(): Promise<StoredInsightsSession | null> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_SESSION, 'readonly');\n    const result = await promisifyRequest(tx.objectStore(STORE_INSIGHTS_SESSION).get('current'));\n    return result ?? null;\n  }\n\n  async deleteInsightsSession(): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_SESSION, 'readwrite');\n    tx.objectStore(STORE_INSIGHTS_SESSION).delete('current');\n    await promisifyTransaction(tx);\n  }\n\n  // ── Insights documents ──\n\n  async saveInsightsDoc(doc: InsightsDocument): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_DOCS, 'readwrite');\n    tx.objectStore(STORE_INSIGHTS_DOCS).put(doc);\n    await promisifyTransaction(tx);\n  }\n\n  async loadInsightsDocs(): Promise<InsightsDocument[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_DOCS, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_INSIGHTS_DOCS).getAll());\n  }\n\n  async deleteInsightsDoc(docId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_DOCS, 'readwrite');\n    tx.objectStore(STORE_INSIGHTS_DOCS).delete(docId);\n    await promisifyTransaction(tx);\n  }\n\n  // ── Insights headings ──\n\n  async saveInsightsHeadings(headings: StoredHeading[]): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_HEADINGS, 'readwrite');\n    const store = tx.objectStore(STORE_INSIGHTS_HEADINGS);\n\n    // Clear all existing\n    await promisifyRequest(store.clear());\n\n    // Write new\n    for (const h of headings) {\n      store.put(h);\n    }\n\n    await promisifyTransaction(tx);\n  }\n\n  async loadInsightsHeadings(): Promise<StoredHeading[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_HEADINGS, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_INSIGHTS_HEADINGS).getAll());\n  }\n\n  async deleteInsightsHeadings(): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_HEADINGS, 'readwrite');\n    await promisifyRequest(tx.objectStore(STORE_INSIGHTS_HEADINGS).clear());\n  }\n\n  // ── Insights images ──\n\n  async saveInsightsImage(image: StoredImage): Promise<void> {\n    const converted = await convertImageBlobUrls(image);\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_IMAGES, 'readwrite');\n    tx.objectStore(STORE_INSIGHTS_IMAGES).put(converted);\n    await promisifyTransaction(tx);\n  }\n\n  async loadInsightsImages(): Promise<StoredImage[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_IMAGES, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_INSIGHTS_IMAGES).getAll());\n  }\n\n  async deleteInsightsImages(): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_INSIGHTS_IMAGES, 'readwrite');\n    await promisifyRequest(tx.objectStore(STORE_INSIGHTS_IMAGES).clear());\n  }\n\n  // ── Nugget documents (per-nugget owned) ──\n\n  async saveNuggetDocument(doc: StoredNuggetDocument): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_DOCUMENTS, 'readwrite');\n    tx.objectStore(STORE_NUGGET_DOCUMENTS).put(doc);\n    await promisifyTransaction(tx);\n  }\n\n  async loadNuggetDocuments(nuggetId: string): Promise<StoredNuggetDocument[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_DOCUMENTS, 'readonly');\n    const index = tx.objectStore(STORE_NUGGET_DOCUMENTS).index('byNugget');\n    return await promisifyRequest(index.getAll(nuggetId));\n  }\n\n  async deleteNuggetDocument(nuggetId: string, docId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_DOCUMENTS, 'readwrite');\n    tx.objectStore(STORE_NUGGET_DOCUMENTS).delete([nuggetId, docId]);\n    await promisifyTransaction(tx);\n  }\n\n  async deleteNuggetDocuments(nuggetId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_DOCUMENTS, 'readwrite');\n    const store = tx.objectStore(STORE_NUGGET_DOCUMENTS);\n    const index = store.index('byNugget');\n    const keys = await promisifyRequest(index.getAllKeys(nuggetId));\n    for (const key of keys) {\n      store.delete(key);\n    }\n    await promisifyTransaction(tx);\n  }\n\n  // ── Documents (v2 legacy — migration reads only) ──\n\n  async loadDocuments(): Promise<StoredFile[]> {\n    const db = this.getDB();\n    if (!db.objectStoreNames.contains(STORE_DOCUMENTS)) return [];\n    const tx = db.transaction(STORE_DOCUMENTS, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_DOCUMENTS).getAll());\n  }\n\n  // ── Nuggets ──\n\n  async saveNugget(nugget: StoredNugget): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGETS, 'readwrite');\n    tx.objectStore(STORE_NUGGETS).put(nugget);\n    await promisifyTransaction(tx);\n  }\n\n  async loadNuggets(): Promise<StoredNugget[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGETS, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_NUGGETS).getAll());\n  }\n\n  async deleteNugget(nuggetId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGETS, 'readwrite');\n    tx.objectStore(STORE_NUGGETS).delete(nuggetId);\n    await promisifyTransaction(tx);\n  }\n\n  // ── Nugget headings ──\n\n  async saveNuggetHeadings(nuggetId: string, headings: StoredHeading[]): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_HEADINGS, 'readwrite');\n    const store = tx.objectStore(STORE_NUGGET_HEADINGS);\n    const index = store.index('byNugget');\n\n    // Delete existing headings for this nugget\n    const existingKeys = await promisifyRequest(index.getAllKeys(nuggetId));\n    for (const key of existingKeys) {\n      store.delete(key);\n    }\n\n    // Write new headings\n    for (const h of headings) {\n      store.put(h);\n    }\n\n    await promisifyTransaction(tx);\n  }\n\n  async saveNuggetHeading(heading: StoredHeading): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_HEADINGS, 'readwrite');\n    tx.objectStore(STORE_NUGGET_HEADINGS).put(heading);\n    await promisifyTransaction(tx);\n  }\n\n  async loadNuggetHeadings(nuggetId: string): Promise<StoredHeading[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_HEADINGS, 'readonly');\n    const index = tx.objectStore(STORE_NUGGET_HEADINGS).index('byNugget');\n    return await promisifyRequest(index.getAll(nuggetId));\n  }\n\n  async deleteNuggetHeadings(nuggetId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_HEADINGS, 'readwrite');\n    const store = tx.objectStore(STORE_NUGGET_HEADINGS);\n    const index = store.index('byNugget');\n    const keys = await promisifyRequest(index.getAllKeys(nuggetId));\n    for (const key of keys) {\n      store.delete(key);\n    }\n    await promisifyTransaction(tx);\n  }\n\n  // ── Nugget images ──\n\n  async saveNuggetImage(image: StoredImage): Promise<void> {\n    // Convert to Blob format BEFORE opening the transaction\n    const blobbed = await imageToBlobStorage(image);\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_IMAGES, 'readwrite');\n    tx.objectStore(STORE_NUGGET_IMAGES).put(blobbed);\n    await promisifyTransaction(tx);\n  }\n\n  async saveNuggetImages(images: StoredImage[]): Promise<void> {\n    if (images.length === 0) return;\n    // Convert all images to Blob format BEFORE opening the transaction\n    // (IndexedDB transactions auto-close if the event loop goes idle during async work)\n    const blobbed = await Promise.all(images.map(imageToBlobStorage));\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_IMAGES, 'readwrite');\n    const store = tx.objectStore(STORE_NUGGET_IMAGES);\n    for (const img of blobbed) {\n      store.put(img);\n    }\n    await promisifyTransaction(tx);\n  }\n\n  async loadNuggetImages(nuggetId: string): Promise<StoredImage[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_IMAGES, 'readonly');\n    const index = tx.objectStore(STORE_NUGGET_IMAGES).index('byNugget');\n    const raw = await promisifyRequest(index.getAll(nuggetId));\n    // Convert Blobs back to data URLs (backward-compatible with legacy string format)\n    return Promise.all(raw.map(blobStorageToImage));\n  }\n\n  async deleteNuggetImages(nuggetId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_IMAGES, 'readwrite');\n    const store = tx.objectStore(STORE_NUGGET_IMAGES);\n    const index = store.index('byNugget');\n    const keys = await promisifyRequest(index.getAllKeys(nuggetId));\n    for (const key of keys) {\n      store.delete(key);\n    }\n    await promisifyTransaction(tx);\n  }\n\n  async deleteNuggetImage(fileId: string, headingId: string, level: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGET_IMAGES, 'readwrite');\n    tx.objectStore(STORE_NUGGET_IMAGES).delete([fileId, headingId, level]);\n    await promisifyTransaction(tx);\n  }\n\n  // ── Atomic nugget save (headings + images + documents in one transaction) ──\n\n  async saveNuggetDataAtomic(\n    nuggetId: string,\n    nugget: StoredNugget,\n    headings: StoredHeading[],\n    images: StoredImage[],\n    documents: StoredNuggetDocument[],\n  ): Promise<void> {\n    // All async work (Blob conversion) MUST complete BEFORE opening the transaction.\n    // IndexedDB transactions auto-commit if the event loop goes idle during async work.\n    const convertedImages = await Promise.all(images.map(imageToBlobStorage));\n\n    const db = this.getDB();\n    const stores = [STORE_NUGGETS, STORE_NUGGET_HEADINGS, STORE_NUGGET_IMAGES, STORE_NUGGET_DOCUMENTS];\n    const tx = db.transaction(stores, 'readwrite');\n\n    // 1. Nugget metadata\n    tx.objectStore(STORE_NUGGETS).put(nugget);\n\n    // 2. Headings — delete old + write new (same pattern as batch method)\n    const hStore = tx.objectStore(STORE_NUGGET_HEADINGS);\n    const existingHeadingKeys = await promisifyRequest(hStore.index('byNugget').getAllKeys(nuggetId));\n    for (const key of existingHeadingKeys) {\n      hStore.delete(key);\n    }\n    for (const h of headings) {\n      hStore.put(h);\n    }\n\n    // 3. Images — upsert all (put overwrites existing records with same key)\n    const iStore = tx.objectStore(STORE_NUGGET_IMAGES);\n    for (const img of convertedImages) {\n      iStore.put(img);\n    }\n\n    // 4. Documents — upsert all\n    const dStore = tx.objectStore(STORE_NUGGET_DOCUMENTS);\n    for (const doc of documents) {\n      dStore.put(doc);\n    }\n\n    await promisifyTransaction(tx);\n  }\n\n  // ── Lightweight nugget ID enumeration ──\n\n  async loadAllNuggetIds(): Promise<string[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_NUGGETS, 'readonly');\n    const keys = await promisifyRequest(tx.objectStore(STORE_NUGGETS).getAllKeys());\n    return keys as string[];\n  }\n\n  // ── Legacy store cleanup ──\n\n  async clearLegacyStores(): Promise<void> {\n    const db = this.getDB();\n    const legacyStores = [STORE_FILES, STORE_HEADINGS, STORE_IMAGES, STORE_DOCUMENTS];\n    const availableStores = legacyStores.filter(s => db.objectStoreNames.contains(s));\n    if (availableStores.length === 0) return;\n    const tx = db.transaction(availableStores, 'readwrite');\n    for (const name of availableStores) {\n      tx.objectStore(name).clear();\n    }\n    await promisifyTransaction(tx);\n  }\n\n  // ── Projects ──\n\n  async saveProject(project: StoredProject): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_PROJECTS, 'readwrite');\n    tx.objectStore(STORE_PROJECTS).put(project);\n    await promisifyTransaction(tx);\n  }\n\n  async loadProjects(): Promise<StoredProject[]> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_PROJECTS, 'readonly');\n    return await promisifyRequest(tx.objectStore(STORE_PROJECTS).getAll());\n  }\n\n  async deleteProject(projectId: string): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_PROJECTS, 'readwrite');\n    tx.objectStore(STORE_PROJECTS).delete(projectId);\n    await promisifyTransaction(tx);\n  }\n\n  // ── Token usage ──\n\n  async saveTokenUsage(totals: Record<string, unknown>): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_APP_STATE, 'readwrite');\n    tx.objectStore(STORE_APP_STATE).put(totals, 'tokenUsage');\n    await promisifyTransaction(tx);\n  }\n\n  async loadTokenUsage(): Promise<Record<string, unknown> | null> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_APP_STATE, 'readonly');\n    const result = await promisifyRequest(tx.objectStore(STORE_APP_STATE).get('tokenUsage'));\n    return result ?? null;\n  }\n\n  // ── Custom styles ──\n\n  async saveCustomStyles(styles: unknown[]): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_APP_STATE, 'readwrite');\n    tx.objectStore(STORE_APP_STATE).put(styles, 'customStyles');\n    await promisifyTransaction(tx);\n  }\n\n  async loadCustomStyles(): Promise<unknown[] | null> {\n    const db = this.getDB();\n    const tx = db.transaction(STORE_APP_STATE, 'readonly');\n    const result = await promisifyRequest(tx.objectStore(STORE_APP_STATE).get('customStyles'));\n    return result ?? null;\n  }\n\n  // ── Clear all ──\n\n  async clearAll(): Promise<void> {\n    const db = this.getDB();\n    const tx = db.transaction(ALL_STORES, 'readwrite');\n    for (const storeName of ALL_STORES) {\n      tx.objectStore(storeName).clear();\n    }\n    await promisifyTransaction(tx);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\storage\\StorageBackend.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ImageVersion' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":94,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ImageVersion"},"fix":{"range":[80,94],"text":""},"desc":"Remove unused variable \"ImageVersion\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'UploadedFile' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":96,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":108,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"UploadedFile"},"fix":{"range":[94,108],"text":""},"desc":"Remove unused variable \"UploadedFile\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3818,3821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3818,3821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { DetailLevel, StylingOptions, NuggetType, ChatMessage, InsightsDocument, ImageVersion, UploadedFile, DocChangeEvent, SourceOrigin } from '../../types';\n\n// ── Stored types (what lives in the database) ──\n\nexport interface AppSessionState {\n  selectedNuggetId: string | null;\n  selectedDocumentId?: string | null;\n  selectedProjectId?: string | null;\n  activeCardId: string | null;\n  // Legacy fields — kept for backward compat reads, ignored on write\n  selectedFileId?: string | null;\n  workflowMode?: string;\n}\n\nexport interface StoredFile {\n  id: string;\n  name: string;\n  size: number;\n  type: string;\n  lastModified: number;\n  content?: string;\n  status: 'ready' | 'error';\n  progress: number;\n}\n\nexport interface StoredHeading {\n  fileId: string;\n  headingId: string;\n  level: number;\n  text: string;\n  selected?: boolean;\n  detailLevel?: DetailLevel;\n  settings?: StylingOptions;\n  synthesisMap?: Partial<Record<DetailLevel, string>>;\n  visualPlanMap?: Partial<Record<DetailLevel, string>>;\n  lastGeneratedContentMap?: Partial<Record<DetailLevel, string>>;\n  lastPromptMap?: Partial<Record<DetailLevel, string>>;\n  createdAt?: number;\n  lastEditedAt?: number;\n  sourceDocuments?: string[];\n}\n\nexport interface StoredImageVersion {\n  imageUrl: string;   // guaranteed data URL (blob URLs converted before storage)\n  timestamp: number;\n  label: string;\n}\n\nexport interface StoredImage {\n  fileId: string;\n  headingId: string;\n  level: DetailLevel;\n  cardUrl: string;\n  imageHistory: StoredImageVersion[];\n}\n\nexport interface StoredInsightsSession {\n  id: string;\n  messages: ChatMessage[];\n}\n\nexport interface StoredNugget {\n  id: string;\n  name: string;\n  type: NuggetType;\n  messages?: ChatMessage[];\n  docChangeLog?: DocChangeEvent[];\n  lastDocChangeSyncIndex?: number;\n  subject?: string;\n  stylingOptions?: StylingOptions;\n  createdAt: number;\n  lastModifiedAt: number;\n}\n\nexport interface StoredNuggetDocument {\n  nuggetId: string;\n  docId: string;\n  name: string;\n  size: number;\n  type: string;\n  lastModified: number;\n  content?: string;\n  status: 'ready' | 'error';\n  progress: number;\n  /** Distinguishes how this document is stored and rendered. undefined = 'markdown' (backward compat). */\n  sourceType?: 'markdown' | 'native-pdf';\n  /** Raw PDF as base64 for iframe viewer (only for native-pdf documents). */\n  pdfBase64?: string;\n  /** Anthropic Files API file ID — used to reference the document in chat without re-uploading content. */\n  fileId?: string;\n  /** Document heading structure (TOC). For native PDFs, extracted via Claude; for markdown, derived from content. */\n  structure?: Array<{ level: number; text: string; id: string; startIndex?: number; page?: number }>;\n  /** How the TOC was extracted: from an explicit TOC page or by visual scanning. */\n  tocSource?: 'toc_page' | 'visual_scan';\n  /** Original file format before conversion to markdown. */\n  originalFormat?: 'md' | 'pdf';\n  /** Timestamp when this document was added to the nugget (epoch ms). */\n  createdAt?: number;\n  /** Timestamp when this document's content was last saved in the editor (epoch ms). */\n  lastEditedAt?: number;\n  /** Timestamp when this document was last renamed (epoch ms). */\n  lastRenamedAt?: number;\n  /** Original file name at upload time. */\n  originalName?: string;\n  /** How this document arrived in the nugget. */\n  sourceOrigin?: SourceOrigin;\n  /** Version counter — increments on rename or content edit. */\n  version?: number;\n  /** Timestamp when chat was last enabled (epoch ms). */\n  lastEnabledAt?: number;\n  /** Timestamp when chat was last disabled (epoch ms). */\n  lastDisabledAt?: number;\n  /** Nested bookmark tree (native-pdf only). Single source of truth for document structure. */\n  bookmarks?: Array<{ id: string; title: string; page: number; level: number; children: any[] }>;\n  /** How the bookmark tree was obtained (native-pdf only). */\n  bookmarkSource?: 'pdf_bookmarks' | 'ai_generated' | 'manual';\n}\n\nexport interface StoredProject {\n  id: string;\n  name: string;\n  nuggetIds: string[];\n  isCollapsed?: boolean;\n  createdAt: number;\n  lastModifiedAt: number;\n}\n\n// ── Storage interface (swappable backend) ──\n\nexport interface StorageBackend {\n  init(): Promise<void>;\n  isReady(): boolean;\n\n  // App session state\n  saveAppState(state: AppSessionState): Promise<void>;\n  loadAppState(): Promise<AppSessionState | null>;\n\n  // Files (metadata + content, no structure)\n  saveFile(file: StoredFile): Promise<void>;\n  loadFiles(): Promise<StoredFile[]>;\n  deleteFile(fileId: string): Promise<void>;\n\n  // Headings (per file, text data only)\n  saveHeadings(fileId: string, headings: StoredHeading[]): Promise<void>;\n  loadHeadings(fileId: string): Promise<StoredHeading[]>;\n  deleteHeadings(fileId: string): Promise<void>;\n\n  // Images (per heading+level, separated for performance)\n  saveImage(image: StoredImage): Promise<void>;\n  loadImages(fileId: string): Promise<StoredImage[]>;\n  deleteImages(fileId: string): Promise<void>;\n\n  // Insights session (chat messages)\n  saveInsightsSession(session: StoredInsightsSession): Promise<void>;\n  loadInsightsSession(): Promise<StoredInsightsSession | null>;\n  deleteInsightsSession(): Promise<void>;\n\n  // Insights documents\n  saveInsightsDoc(doc: InsightsDocument): Promise<void>;\n  loadInsightsDocs(): Promise<InsightsDocument[]>;\n  deleteInsightsDoc(docId: string): Promise<void>;\n\n  // Insights headings\n  saveInsightsHeadings(headings: StoredHeading[]): Promise<void>;\n  loadInsightsHeadings(): Promise<StoredHeading[]>;\n  deleteInsightsHeadings(): Promise<void>;\n\n  // Insights images\n  saveInsightsImage(image: StoredImage): Promise<void>;\n  loadInsightsImages(): Promise<StoredImage[]>;\n  deleteInsightsImages(): Promise<void>;\n\n  // Nugget documents (per-nugget owned)\n  saveNuggetDocument(doc: StoredNuggetDocument): Promise<void>;\n  loadNuggetDocuments(nuggetId: string): Promise<StoredNuggetDocument[]>;\n  deleteNuggetDocument(nuggetId: string, docId: string): Promise<void>;\n  deleteNuggetDocuments(nuggetId: string): Promise<void>;\n\n  // Documents (v2 legacy — kept for migration reads only)\n  loadDocuments(): Promise<StoredFile[]>;\n\n  // Nuggets\n  saveNugget(nugget: StoredNugget): Promise<void>;\n  loadNuggets(): Promise<StoredNugget[]>;\n  deleteNugget(nuggetId: string): Promise<void>;\n\n  // Nugget headings (keyed by nuggetId)\n  saveNuggetHeadings(nuggetId: string, headings: StoredHeading[]): Promise<void>;\n  saveNuggetHeading(heading: StoredHeading): Promise<void>;\n  loadNuggetHeadings(nuggetId: string): Promise<StoredHeading[]>;\n  deleteNuggetHeadings(nuggetId: string): Promise<void>;\n\n  // Nugget images (keyed by nuggetId)\n  saveNuggetImage(image: StoredImage): Promise<void>;\n  saveNuggetImages(images: StoredImage[]): Promise<void>;\n  loadNuggetImages(nuggetId: string): Promise<StoredImage[]>;\n  deleteNuggetImages(nuggetId: string): Promise<void>;\n  deleteNuggetImage(fileId: string, headingId: string, level: string): Promise<void>;\n\n  // Atomic nugget save (headings + images + documents in one transaction)\n  saveNuggetDataAtomic(\n    nuggetId: string,\n    nugget: StoredNugget,\n    headings: StoredHeading[],\n    images: StoredImage[],\n    documents: StoredNuggetDocument[],\n  ): Promise<void>;\n\n  // Lightweight nugget ID enumeration (no full deserialization)\n  loadAllNuggetIds(): Promise<string[]>;\n\n  // Legacy store cleanup (clear migration-only stores)\n  clearLegacyStores(): Promise<void>;\n\n  // Projects\n  saveProject(project: StoredProject): Promise<void>;\n  loadProjects(): Promise<StoredProject[]>;\n  deleteProject(projectId: string): Promise<void>;\n\n  // Token usage\n  saveTokenUsage(totals: Record<string, unknown>): Promise<void>;\n  loadTokenUsage(): Promise<Record<string, unknown> | null>;\n\n  // Custom styles\n  saveCustomStyles(styles: unknown[]): Promise<void>;\n  loadCustomStyles(): Promise<unknown[] | null>;\n\n  // Clear everything\n  clearAll(): Promise<void>;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\storage\\serialize.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'StoredImageVersion' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":68,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"StoredImageVersion"},"fix":{"range":[182,202],"text":""},"desc":"Remove unused variable \"StoredImageVersion\"."}]},{"ruleId":"import/order","severity":1,"message":"`../pdfBookmarks` import should occur before import of `./StorageBackend`","line":4,"column":1,"nodeType":"ImportDeclaration","endLine":4,"endColumn":55,"fix":{"range":[135,359],"text":"import { headingsToBookmarks } from '../pdfBookmarks';\nimport { StoredFile, StoredHeading, StoredImage, StoredImageVersion, StoredInsightsSession, StoredNugget, StoredNuggetDocument, StoredProject } from './StorageBackend';\n"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'serializeFile' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":23},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":88,"column":13,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":88,"endColumn":31,"fix":{"range":[2762,2780],"text":"{return map as any;}"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2776,2779],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2776,2779],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":208,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":208,"endColumn":40},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":222,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":222,"endColumn":58,"fix":{"range":[6882,6917],"text":"{stored.sourceType = doc.sourceType;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":223,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":223,"endColumn":55,"fix":{"range":[6939,6972],"text":"{stored.pdfBase64 = doc.pdfBase64;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":224,"column":19,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":224,"endColumn":46,"fix":{"range":[6991,7018],"text":"{stored.fileId = doc.fileId;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":225,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":225,"endColumn":55,"fix":{"range":[7040,7073],"text":"{stored.structure = doc.structure;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":226,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":226,"endColumn":55,"fix":{"range":[7095,7128],"text":"{stored.tocSource = doc.tocSource;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":227,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":227,"endColumn":70,"fix":{"range":[7155,7198],"text":"{stored.originalFormat = doc.originalFormat;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":228,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":228,"endColumn":55,"fix":{"range":[7220,7253],"text":"{stored.createdAt = doc.createdAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":229,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":229,"endColumn":64,"fix":{"range":[7278,7317],"text":"{stored.lastEditedAt = doc.lastEditedAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":230,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":230,"endColumn":67,"fix":{"range":[7343,7384],"text":"{stored.lastRenamedAt = doc.lastRenamedAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":231,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":231,"endColumn":64,"fix":{"range":[7409,7448],"text":"{stored.originalName = doc.originalName;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":232,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":232,"endColumn":64,"fix":{"range":[7473,7512],"text":"{stored.sourceOrigin = doc.sourceOrigin;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":233,"column":20,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":233,"endColumn":49,"fix":{"range":[7532,7561],"text":"{stored.version = doc.version;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":234,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":234,"endColumn":67,"fix":{"range":[7587,7628],"text":"{stored.lastEnabledAt = doc.lastEnabledAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":235,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":235,"endColumn":70,"fix":{"range":[7655,7698],"text":"{stored.lastDisabledAt = doc.lastDisabledAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":236,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":236,"endColumn":55,"fix":{"range":[7720,7753],"text":"{stored.bookmarks = doc.bookmarks;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":237,"column":27,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":237,"endColumn":70,"fix":{"range":[7780,7823],"text":"{stored.bookmarkSource = doc.bookmarkSource;}"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 17 to the 15 allowed.","line":242,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":242,"endColumn":42},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":255,"column":26,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":255,"endColumn":61,"fix":{"range":[8242,8277],"text":"{doc.sourceType = stored.sourceType;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":256,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":256,"endColumn":58,"fix":{"range":[8302,8335],"text":"{doc.pdfBase64 = stored.pdfBase64;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":257,"column":22,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":257,"endColumn":49,"fix":{"range":[8357,8384],"text":"{doc.fileId = stored.fileId;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":258,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":258,"endColumn":58,"fix":{"range":[8409,8442],"text":"{doc.structure = stored.structure;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":259,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":259,"endColumn":58,"fix":{"range":[8467,8500],"text":"{doc.tocSource = stored.tocSource;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":260,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":260,"endColumn":73,"fix":{"range":[8530,8573],"text":"{doc.originalFormat = stored.originalFormat;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":261,"column":25,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":261,"endColumn":58,"fix":{"range":[8598,8631],"text":"{doc.createdAt = stored.createdAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":262,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":262,"endColumn":67,"fix":{"range":[8659,8698],"text":"{doc.lastEditedAt = stored.lastEditedAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":263,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":263,"endColumn":70,"fix":{"range":[8727,8768],"text":"{doc.lastRenamedAt = stored.lastRenamedAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":264,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":264,"endColumn":67,"fix":{"range":[8796,8835],"text":"{doc.originalName = stored.originalName;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":265,"column":28,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":265,"endColumn":67,"fix":{"range":[8863,8902],"text":"{doc.sourceOrigin = stored.sourceOrigin;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":266,"column":23,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":266,"endColumn":52,"fix":{"range":[8925,8954],"text":"{doc.version = stored.version;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":267,"column":29,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":267,"endColumn":70,"fix":{"range":[8983,9024],"text":"{doc.lastEnabledAt = stored.lastEnabledAt;}"}},{"ruleId":"curly","severity":1,"message":"Expected { after 'if' condition.","line":268,"column":30,"nodeType":"IfStatement","messageId":"missingCurlyAfterCondition","endLine":268,"endColumn":73,"fix":{"range":[9054,9097],"text":"{doc.lastDisabledAt = stored.lastDisabledAt;}"}}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":35,"fixableErrorCount":0,"fixableWarningCount":32,"source":"\nimport { UploadedFile, Heading, Card, DetailLevel, InsightsSession, Nugget, Project, ImageVersion, BookmarkNode } from '../../types';\nimport { StoredFile, StoredHeading, StoredImage, StoredImageVersion, StoredInsightsSession, StoredNugget, StoredNuggetDocument, StoredProject } from './StorageBackend';\nimport { headingsToBookmarks } from '../pdfBookmarks';\n\nconst DETAIL_LEVELS: DetailLevel[] = ['Executive', 'Standard', 'Detailed', 'TitleCard', 'TakeawayCard', 'DirectContent'];\n\n/** Map legacy stored level names to current ones (backward compat for IndexedDB data). */\nconst LEGACY_LEVEL_MAP: Record<string, DetailLevel> = {\n  TitleCover: 'TitleCard',\n  TakeawayCover: 'TakeawayCard',\n};\n\n// ── File serialization ──\n\nfunction serializeFile(f: UploadedFile): StoredFile {\n  return {\n    id: f.id,\n    name: f.name,\n    size: f.size,\n    type: f.type,\n    lastModified: f.lastModified,\n    content: f.content,\n    status: f.status === 'ready' ? 'ready' : 'error',\n    progress: f.status === 'ready' ? 100 : 0,\n  };\n}\n\nexport function deserializeFile(sf: StoredFile, structure?: Heading[]): UploadedFile {\n  return {\n    id: sf.id,\n    name: sf.name,\n    size: sf.size,\n    type: sf.type,\n    lastModified: sf.lastModified,\n    content: sf.content,\n    status: sf.status,\n    progress: sf.progress,\n    structure,\n  };\n}\n\n// ── Card serialization (runtime Card ↔ StoredHeading) ──\n\nexport function serializeCard(card: Card, fileId: string): StoredHeading {\n  return {\n    fileId,\n    headingId: card.id,\n    level: card.level,\n    text: card.text,\n    selected: card.selected,\n    detailLevel: card.detailLevel,\n    settings: card.settings,\n    synthesisMap: card.synthesisMap,\n    visualPlanMap: card.visualPlanMap,\n    lastGeneratedContentMap: card.lastGeneratedContentMap,\n    lastPromptMap: card.lastPromptMap,\n    createdAt: card.createdAt,\n    lastEditedAt: card.lastEditedAt,\n    sourceDocuments: card.sourceDocuments,\n    // Excluded: isSynthesizingMap, isGeneratingMap, startIndex, cardUrlMap, imageHistoryMap\n  };\n}\n\nexport function extractImages(card: Card, fileId: string): StoredImage[] {\n  const images: StoredImage[] = [];\n  for (const level of DETAIL_LEVELS) {\n    const cardUrl = card.cardUrlMap?.[level];\n    if (cardUrl) {\n      images.push({\n        fileId,\n        headingId: card.id,\n        level,\n        cardUrl,\n        imageHistory: (card.imageHistoryMap?.[level] || []).map(v => ({\n          imageUrl: v.imageUrl,\n          timestamp: v.timestamp,\n          label: v.label,\n        })),\n      });\n    }\n  }\n  return images;\n}\n\n/** Migrate any legacy level keys inside a Partial<Record<DetailLevel, T>> map. */\nfunction migrateLevelMap<T>(map?: Partial<Record<string, T>>): Partial<Record<DetailLevel, T>> | undefined {\n  if (!map) return map as any;\n  const out: Partial<Record<string, T>> = {};\n  for (const [key, val] of Object.entries(map)) {\n    out[LEGACY_LEVEL_MAP[key] || key] = val;\n  }\n  return out as Partial<Record<DetailLevel, T>>;\n}\n\nexport function deserializeCard(stored: StoredHeading, images: StoredImage[]): Card {\n  // Migrate legacy levelOfDetail in settings\n  const settings = stored.settings ? { ...stored.settings } : stored.settings;\n  if (settings?.levelOfDetail && LEGACY_LEVEL_MAP[settings.levelOfDetail as string]) {\n    settings.levelOfDetail = LEGACY_LEVEL_MAP[settings.levelOfDetail as string];\n  }\n\n  // Migrate detailLevel: prefer explicitly stored field, fall back to settings.levelOfDetail\n  const detailLevel = stored.detailLevel\n    || (settings?.levelOfDetail ? settings.levelOfDetail : undefined);\n\n  const card: Card = {\n    id: stored.headingId,\n    level: stored.level,\n    text: stored.text,\n    selected: stored.selected,\n    detailLevel,\n    settings,\n    synthesisMap: migrateLevelMap(stored.synthesisMap),\n    visualPlanMap: migrateLevelMap(stored.visualPlanMap),\n    lastGeneratedContentMap: migrateLevelMap(stored.lastGeneratedContentMap),\n    lastPromptMap: migrateLevelMap(stored.lastPromptMap),\n    isSynthesizingMap: {},\n    isGeneratingMap: {},\n    createdAt: stored.createdAt,\n    lastEditedAt: stored.lastEditedAt,\n    sourceDocuments: stored.sourceDocuments,\n  };\n\n  // Merge image data back into card\n  const matchingImages = images.filter(img => img.headingId === stored.headingId);\n  if (matchingImages.length > 0) {\n    const cardUrlMap: Partial<Record<DetailLevel, string>> = {};\n    const imageHistoryMap: Partial<Record<DetailLevel, ImageVersion[]>> = {};\n\n    for (const img of matchingImages) {\n      const lvl = (LEGACY_LEVEL_MAP[img.level as string] || img.level) as DetailLevel;\n      cardUrlMap[lvl] = img.cardUrl;\n      if (img.imageHistory?.length > 0) {\n        imageHistoryMap[lvl] = img.imageHistory;\n      }\n    }\n\n    card.cardUrlMap = cardUrlMap;\n    if (Object.keys(imageHistoryMap).length > 0) {\n      card.imageHistoryMap = imageHistoryMap;\n    }\n  }\n\n  return card;\n}\n\n// ── Insights serialization ──\n\nexport function serializeInsightsSession(session: InsightsSession): {\n  session: StoredInsightsSession;\n  headings: StoredHeading[];\n  images: StoredImage[];\n} {\n  const storedSession: StoredInsightsSession = {\n    id: session.id,\n    messages: session.messages,\n  };\n\n  const headings: StoredHeading[] = [];\n  const images: StoredImage[] = [];\n  const insightsFileId = '__insights__';\n\n  for (const card of session.cards) {\n    headings.push(serializeCard(card, insightsFileId));\n    images.push(...extractImages(card, insightsFileId));\n  }\n\n  return { session: storedSession, headings, images };\n}\n\n// ── Nugget serialization ──\n\nexport function serializeNugget(n: Nugget): StoredNugget {\n  return {\n    id: n.id,\n    name: n.name,\n    type: n.type,\n    messages: n.messages,\n    docChangeLog: n.docChangeLog,\n    lastDocChangeSyncIndex: n.lastDocChangeSyncIndex,\n    subject: n.subject,\n    stylingOptions: n.stylingOptions,\n    createdAt: n.createdAt,\n    lastModifiedAt: n.lastModifiedAt,\n  };\n}\n\nexport function deserializeNugget(sn: StoredNugget, cards: Card[], documents: UploadedFile[]): Nugget {\n  return {\n    id: sn.id,\n    name: sn.name,\n    type: sn.type as 'insights',\n    documents,\n    cards,\n    messages: sn.messages,\n    docChangeLog: sn.docChangeLog,\n    lastDocChangeSyncIndex: sn.lastDocChangeSyncIndex,\n    subject: sn.subject,\n    stylingOptions: sn.stylingOptions,\n    createdAt: sn.createdAt,\n    lastModifiedAt: sn.lastModifiedAt,\n  };\n}\n\n// ── Nugget document serialization ──\n\nexport function serializeNuggetDocument(nuggetId: string, doc: UploadedFile): StoredNuggetDocument {\n  const stored: StoredNuggetDocument = {\n    nuggetId,\n    docId: doc.id,\n    name: doc.name,\n    size: doc.size,\n    type: doc.type,\n    lastModified: doc.lastModified,\n    content: doc.content,\n    status: doc.status === 'ready' ? 'ready' : 'error',\n    progress: doc.status === 'ready' ? 100 : 0,\n  };\n\n  // Persist native PDF fields\n  if (doc.sourceType) stored.sourceType = doc.sourceType;\n  if (doc.pdfBase64) stored.pdfBase64 = doc.pdfBase64;\n  if (doc.fileId) stored.fileId = doc.fileId;\n  if (doc.structure) stored.structure = doc.structure;\n  if (doc.tocSource) stored.tocSource = doc.tocSource;\n  if (doc.originalFormat) stored.originalFormat = doc.originalFormat;\n  if (doc.createdAt) stored.createdAt = doc.createdAt;\n  if (doc.lastEditedAt) stored.lastEditedAt = doc.lastEditedAt;\n  if (doc.lastRenamedAt) stored.lastRenamedAt = doc.lastRenamedAt;\n  if (doc.originalName) stored.originalName = doc.originalName;\n  if (doc.sourceOrigin) stored.sourceOrigin = doc.sourceOrigin;\n  if (doc.version) stored.version = doc.version;\n  if (doc.lastEnabledAt) stored.lastEnabledAt = doc.lastEnabledAt;\n  if (doc.lastDisabledAt) stored.lastDisabledAt = doc.lastDisabledAt;\n  if (doc.bookmarks) stored.bookmarks = doc.bookmarks;\n  if (doc.bookmarkSource) stored.bookmarkSource = doc.bookmarkSource;\n\n  return stored;\n}\n\nexport function deserializeNuggetDocument(stored: StoredNuggetDocument): UploadedFile {\n  const doc: UploadedFile = {\n    id: stored.docId,\n    name: stored.name,\n    size: stored.size,\n    type: stored.type,\n    lastModified: stored.lastModified,\n    content: stored.content,\n    status: stored.status,\n    progress: stored.progress,\n  };\n\n  // Restore native PDF fields\n  if (stored.sourceType) doc.sourceType = stored.sourceType;\n  if (stored.pdfBase64) doc.pdfBase64 = stored.pdfBase64;\n  if (stored.fileId) doc.fileId = stored.fileId;\n  if (stored.structure) doc.structure = stored.structure;\n  if (stored.tocSource) doc.tocSource = stored.tocSource;\n  if (stored.originalFormat) doc.originalFormat = stored.originalFormat;\n  if (stored.createdAt) doc.createdAt = stored.createdAt;\n  if (stored.lastEditedAt) doc.lastEditedAt = stored.lastEditedAt;\n  if (stored.lastRenamedAt) doc.lastRenamedAt = stored.lastRenamedAt;\n  if (stored.originalName) doc.originalName = stored.originalName;\n  if (stored.sourceOrigin) doc.sourceOrigin = stored.sourceOrigin;\n  if (stored.version) doc.version = stored.version;\n  if (stored.lastEnabledAt) doc.lastEnabledAt = stored.lastEnabledAt;\n  if (stored.lastDisabledAt) doc.lastDisabledAt = stored.lastDisabledAt;\n\n  // Restore bookmarks, or migrate from flat structure if absent\n  if (stored.bookmarks) {\n    doc.bookmarks = stored.bookmarks as BookmarkNode[];\n    doc.bookmarkSource = stored.bookmarkSource;\n  } else if (stored.sourceType === 'native-pdf' && stored.structure?.length) {\n    // Auto-migrate: convert existing flat headings to nested bookmarks\n    const migratedHeadings: Heading[] = stored.structure.map(h => ({\n      level: h.level,\n      text: h.text,\n      id: h.id,\n      page: h.page,\n    }));\n    doc.bookmarks = headingsToBookmarks(migratedHeadings);\n    doc.bookmarkSource = 'manual';\n  }\n\n  return doc;\n}\n\n// ── Project serialization ──\n\nexport function serializeProject(p: Project): StoredProject {\n  return {\n    id: p.id,\n    name: p.name,\n    nuggetIds: p.nuggetIds,\n    isCollapsed: p.isCollapsed,\n    createdAt: p.createdAt,\n    lastModifiedAt: p.lastModifiedAt,\n  };\n}\n\nexport function deserializeProject(sp: StoredProject): Project {\n  return {\n    id: sp.id,\n    name: sp.name,\n    nuggetIds: sp.nuggetIds,\n    isCollapsed: sp.isCollapsed,\n    createdAt: sp.createdAt,\n    lastModifiedAt: sp.lastModifiedAt,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\subjectGeneration.ts","messages":[{"ruleId":"import/order","severity":1,"message":"`../hooks/useTokenUsage` import should occur before import of `./ai`","line":3,"column":1,"nodeType":"ImportDeclaration","endLine":3,"endColumn":56,"fix":{"range":[50,141],"text":"import { RecordUsageFn } from '../hooks/useTokenUsage';\nimport { callClaude } from './ai';\n"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 29 to the 15 allowed.","line":13,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":13,"endColumn":32},{"ruleId":"no-magic-numbers","severity":1,"message":"No magic number: 500.","line":53,"column":43,"nodeType":"Literal","messageId":"noMagic","endLine":53,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { UploadedFile, Heading } from '../types';\nimport { callClaude } from './ai';\nimport { RecordUsageFn } from '../hooks/useTokenUsage';\n\n// ── Subject Generation ──\n// Extracts TOC + opening content from documents and calls Claude\n// to generate a concise subject sentence for expert priming.\n\n/**\n * Extract a compact summary from a single document: TOC headings + first paragraph\n * under each main heading. For native PDFs, only the heading structure is used.\n */\nfunction extractDocumentSummary(doc: UploadedFile): string {\n  const lines: string[] = [`Document: \"${doc.name}\"`];\n  const headings: Heading[] = doc.structure ?? [];\n\n  if (doc.sourceType === 'native-pdf' || !doc.content) {\n    // Native PDF: TOC only (no inline content available)\n    if (headings.length > 0) {\n      lines.push('Table of Contents:');\n      for (const h of headings) {\n        const indent = '  '.repeat(Math.max(0, h.level - 1));\n        const pageLabel = h.page != null ? ` (p.${h.page})` : '';\n        lines.push(`${indent}- ${h.text}${pageLabel}`);\n      }\n    } else {\n      lines.push('(No table of contents available)');\n    }\n  } else {\n    // Markdown/text doc: TOC + first paragraph under each H1/H2\n    const mainHeadings = headings.filter(h => h.level <= 2);\n\n    if (mainHeadings.length > 0) {\n      lines.push('Structure and key content:');\n\n      for (let i = 0; i < mainHeadings.length; i++) {\n        const h = mainHeadings[i];\n        const indent = '  '.repeat(Math.max(0, h.level - 1));\n        lines.push(`${indent}## ${h.text}`);\n\n        // Extract first paragraph after this heading\n        if (h.startIndex != null && doc.content) {\n          const afterHeading = doc.content.substring(h.startIndex);\n          // Skip past the heading line itself, then grab the first non-empty paragraph\n          const match = afterHeading.match(/^[^\\n]*\\n+([^\\n#][^\\n]{0,300})/);\n          if (match) {\n            lines.push(`${indent}  ${match[1].trim()}`);\n          }\n        }\n      }\n    } else {\n      // No headings — take first 500 chars\n      lines.push(doc.content.substring(0, 500));\n    }\n  }\n\n  return lines.join('\\n');\n}\n\n/**\n * Build the Claude prompt for subject generation.\n */\nfunction buildSubjectPrompt(docSummaries: string): { system: string; prompt: string } {\n  const system = 'You are a document analyst. Your task is to identify the core subject and domain of the provided documents.';\n\n  const prompt = `Analyze the following document summaries and produce a single sentence (15–30 words) that describes the overall subject and domain of expertise these documents cover.\n\nRequirements:\n- Be specific to the actual content — not generic (e.g., \"Enterprise zero-trust cybersecurity architecture with focus on cloud-native identity management\" not \"Technology and security\")\n- The sentence should be suitable for priming a domain expert to work with this material\n- Do not include any preamble, explanation, or quotation marks — output ONLY the sentence\n\n${docSummaries}`;\n\n  return { system, prompt };\n}\n\n/**\n * Generate a subject sentence from a set of documents.\n * Uses TOC + opening paragraphs to keep the API call lightweight.\n */\nexport async function generateSubject(\n  docs: UploadedFile[],\n  recordUsage?: RecordUsageFn,\n): Promise<string> {\n  const summaries = docs.map(extractDocumentSummary).join('\\n\\n---\\n\\n');\n  const { system, prompt } = buildSubjectPrompt(summaries);\n\n  const { text, usage } = await callClaude(prompt, {\n    system,\n    maxTokens: 150,\n  });\n\n  recordUsage?.({\n    provider: 'claude',\n    model: 'claude-sonnet-4-6',\n    inputTokens: usage.input_tokens,\n    outputTokens: usage.output_tokens,\n    cacheReadTokens: usage.cache_read_input_tokens,\n    cacheWriteTokens: usage.cache_creation_input_tokens,\n  });\n\n  // Clean up: remove surrounding quotes if present, trim whitespace\n  return text.trim().replace(/^[\"']|[\"']$/g, '');\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\archd\\Downloads\\infonugget-v6.0\\utils\\tokenEstimation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]